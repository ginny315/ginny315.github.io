<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>作品集合</title>
    <link href="/2026/01/01/%E4%BD%9C%E5%93%81%E9%9B%86%E5%90%88/"/>
    <url>/2026/01/01/%E4%BD%9C%E5%93%81%E9%9B%86%E5%90%88/</url>
    
    <content type="html"><![CDATA[<blockquote><p>奇奇怪怪的东西有空整理在这里。<br>基本按照时间顺序，可见项目越来越复杂。</p></blockquote><span id="more"></span> <ol><li>朴素的工作</li></ol><p>1.1 opsdev前端搭建、迭代<br><img src="/../img/0-3.png" alt="opsdev"></p><p>1.2 N卡运行信息展示<br><img src="/../img/0-4.png" alt="nvidia"></p><p>1.3 维护卡卡运行信息展示<br><img src="/../img/0-6.png" alt="nvidia"></p><p>1.4 model garden<br><img src="/../img/0-5.png" alt="garden"> </p><p>1.5 AI管理台<br><img src="/../img/0-7.png" alt="AI管理台"> </p><p>1.6 数字化平台<br><img src="/../img/0-8.png" alt="数字化平台"> </p><p>1.7 用户权限管理平台<br><img src="/../img/0-9.png" alt="用户权限管理平台"> </p><p>1.8 产品追溯平台<br><img src="/../img/0-10.png" alt="产品追溯平台"> </p><p>1.9 产品生命周期管理系统<br><img src="/../img/0-11.png" alt="产品生命周期管理系统"><br><img src="/../img/0-13.png" alt="全局消息通知"></p><p>1.10 报价管理系统<br><img src="/../img/0-12.png" alt="报价管理系统"> </p><p>1.11 蛋白质结构预测<br><img src="/../img/0-13.jpg" alt="蛋白质结构预测"><br><img src="/../img/0-14.jpg" alt="蛋白质结构预测"> </p><p>1.12 智企助手<br><img src="/../img/0-15.jpg" alt="智企助手"> </p><!-- ![智企助手](../img/0-16.jpg)  --><p>1.13 AI应用平台<br><img src="/../img/0-17.jpg" alt="AI应用平台"><br><img src="/../img/0-18.jpg" alt="AI应用平台"> </p><ol start="2"><li><p>前端技术栈<br><img src="/../img/0-01.png" alt="技术栈"><br><img src="/../img/0-02.png" alt="技术栈"><br><img src="/../img/0-03.png" alt="技术栈"> </p></li><li><p>读书脑洞</p></li></ol><p>2.1 基于Spark的分布式人脸识别系统-前世你可能是只猫<br><img src="/../img/0-1.png" alt="前世你可能是一只猫"></p><p>2.2 基于WebGL的森林渲染，使用WebGL进行森林渲染，并力图实现渲染最优。<br><img src="/../img/0-2.png" alt="基于WebGL的森林渲染"><br><a href="https://guoningyan.com/dissertation/">毕设进展</a></p><p>2.3 <a href="https://guoningyan.com/visual/">可视化课程网站</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>keycloak登录-前端适配-vue &amp; react</title>
    <link href="/2025/08/07/keycloak%E7%99%BB%E5%BD%95-%E5%89%8D%E7%AB%AF%E9%80%82%E9%85%8D/"/>
    <url>/2025/08/07/keycloak%E7%99%BB%E5%BD%95-%E5%89%8D%E7%AB%AF%E9%80%82%E9%85%8D/</url>
    
    <content type="html"><![CDATA[<blockquote><p>近期的项目用 keycloak 做统一登录的入口，前端登录页直接跳转 keycloak 登录，本篇基于 keycloak 26.3.2 版本，基于 vue &amp; react 做适配。<br>后续：后端表示坑多，放弃这个选型。</p></blockquote><span id="more"></span><h4 id="登录-vue"><a href="#登录-vue" class="headerlink" title="登录-vue"></a>登录-vue</h4><p>window.APP_CONFIG.keyCloak &#x3D; <a href="https://ip:port/realms/swsz/protocol/openid-connect/auth">https://ip:port/realms/swsz/protocol/openid-connect/auth</a><br>window.APP_CONFIG.keyCloakToken &#x3D; <a href="https://ip:port/">https://ip:port/</a></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Keycloak</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;keycloak-js&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useUserStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store/modules/user&#x27;</span><br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/router&#x27;</span><br><br><span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">goToKeycloak</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">// 跳转到Keycloak登录页面</span><br>  <span class="hljs-comment">// 这里需要根据你的Keycloak配置修改URL</span><br>  <span class="hljs-keyword">const</span> keycloakUrl = <span class="hljs-variable language_">window</span>.<span class="hljs-property">APP_CONFIG</span>.<span class="hljs-property">keyCloak</span><br>  <span class="hljs-keyword">const</span> clientId = <span class="hljs-string">&#x27;swbind&#x27;</span> <span class="hljs-comment">// 你需要在Keycloak中创建这个客户端</span><br>  <span class="hljs-keyword">const</span> redirectUri = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> + <span class="hljs-string">&#x27;/login&#x27;</span>)<br>  <span class="hljs-keyword">const</span> responseType = <span class="hljs-string">&#x27;code&#x27;</span><br>  <span class="hljs-keyword">const</span> authUrl = <span class="hljs-string">`<span class="hljs-subst">$&#123;keycloakUrl&#125;</span>?client_id=<span class="hljs-subst">$&#123;clientId&#125;</span>&amp;redirect_uri=<span class="hljs-subst">$&#123;redirectUri&#125;</span>&amp;response_type=<span class="hljs-subst">$&#123;responseType&#125;</span>&amp;scope=openid`</span><br><br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = authUrl<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">initKeycloak</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> keycloak = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Keycloak</span>(&#123;<br>    <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">APP_CONFIG</span>.<span class="hljs-property">keyCloakToken</span>,<br>    <span class="hljs-attr">realm</span>: <span class="hljs-string">&#x27;swsz&#x27;</span>,<br>    <span class="hljs-attr">clientId</span>: <span class="hljs-string">&#x27;swbind&#x27;</span><br>  &#125;)<br><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> authenticated = <span class="hljs-keyword">await</span> keycloak.<span class="hljs-title function_">init</span>(&#123;<br>      <span class="hljs-comment">// checkLoginIframe: false,</span><br>      <span class="hljs-attr">onLoad</span>: <span class="hljs-string">&#x27;login-required&#x27;</span><br>    &#125;)<br>    <span class="hljs-keyword">if</span> (authenticated) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;User is authenticated&#x27;</span>, authenticated)<br>      <span class="hljs-keyword">if</span> (keycloak.<span class="hljs-property">token</span>) &#123;<br>        userStore.<span class="hljs-title function_">setToken</span>(keycloak.<span class="hljs-property">token</span>)<br>        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/&#x27;</span>)<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;User is not authenticated&#x27;</span>)<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Failed to initialize adapter:&#x27;</span>, error)<br>  &#125;<br>&#125;<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;code&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">const</span> code = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;code=&#x27;</span>)[<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;#&#x27;</span>)[<span class="hljs-number">0</span>]<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;code=&#x27;</span>, code)<br>    <span class="hljs-title function_">initKeycloak</span>()<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_">goToKeycloak</span>()<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><h4 id="登录-react"><a href="#登录-react" class="headerlink" title="登录-react"></a>登录-react</h4><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Keycloak</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;keycloak-js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">Login</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">goToKeycloak</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> keycloakUrl = <span class="hljs-variable language_">window</span>.<span class="hljs-property">APP_CONFIG</span>.<span class="hljs-property">keyCloak</span>;<br>    <span class="hljs-keyword">const</span> clientId = <span class="hljs-string">&#x27;swai&#x27;</span>;<br>    <span class="hljs-keyword">const</span> redirectUri = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> + <span class="hljs-string">&#x27;/login&#x27;</span>);<br>    <span class="hljs-keyword">const</span> responseType = <span class="hljs-string">&#x27;code&#x27;</span>;<br>    <span class="hljs-keyword">const</span> authUrl = <span class="hljs-string">`<span class="hljs-subst">$&#123;keycloakUrl&#125;</span>?client_id=<span class="hljs-subst">$&#123;clientId&#125;</span>&amp;redirect_uri=<span class="hljs-subst">$&#123;redirectUri&#125;</span>&amp;response_type=<span class="hljs-subst">$&#123;responseType&#125;</span>&amp;scope=openid`</span>;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = authUrl;<br>  &#125;;<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initKeycloak</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> keycloak = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Keycloak</span>(&#123;<br>      <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">APP_CONFIG</span>.<span class="hljs-property">keyCloak</span>,<br>      <span class="hljs-attr">realm</span>: <span class="hljs-string">&#x27;swsz&#x27;</span>,<br>      <span class="hljs-attr">clientId</span>: <span class="hljs-string">&#x27;swai&#x27;</span>,<br>    &#125;);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> authenticated = <span class="hljs-keyword">await</span> keycloak.<span class="hljs-title function_">init</span>(&#123;<br>            <span class="hljs-attr">onLoad</span>: <span class="hljs-string">&#x27;login-required&#x27;</span><br>        &#125;)<br>        <span class="hljs-keyword">if</span> (authenticated) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;User is authenticated&#x27;</span>, authenticated)<br>        <span class="hljs-keyword">if</span> (keycloak.<span class="hljs-property">token</span>) &#123;<br>            authorizationUtil.<span class="hljs-title function_">setItems</span>(&#123;<br>                <span class="hljs-title class_">Token</span>: keycloak.<span class="hljs-property">token</span><br>            &#125;);<br>            <span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Failed to initialize adapter:&#x27;</span>, error);<br>    &#125;<br>  &#125;;<br><br>  <span class="hljs-comment">// 页面初始化时执行</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;code&#x27;</span>)) &#123;<br>      <span class="hljs-keyword">const</span> code = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;code=&#x27;</span>)[<span class="hljs-number">1</span>];<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;code=&#x27;</span>, code);<br>      <span class="hljs-title function_">initKeycloak</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;goToKeycloak&#x27;</span>);<br>      <span class="hljs-title function_">goToKeycloak</span>();<br>    &#125;<br>  &#125;, []);<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Login</span>;<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://www.keycloak.org/securing-apps/javascript-adapter">官方文档</a><br><a href="https://www.fenxianglu.cn/article/493">前端接入keycloak的几种方式</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>前端使用分子相关库</title>
    <link href="/2025/08/04/%E5%89%8D%E7%AB%AF%E4%BD%BF%E7%94%A8%E5%88%86%E5%AD%90%E7%9B%B8%E5%85%B3%E5%BA%93/"/>
    <url>/2025/08/04/%E5%89%8D%E7%AB%AF%E4%BD%BF%E7%94%A8%E5%88%86%E5%AD%90%E7%9B%B8%E5%85%B3%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<blockquote><p>之前是针对 AF3 做了生物大分子预测，使用了rcsb-molstar；近期遇到新需求，要做分子性质和器件性质预测，使用了 3Dmol.js。<br>本文对使用的库进行总结。</p></blockquote><span id="more"></span><h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><table><thead><tr><th>维度</th><th>rcsb-molstar (Mol*)</th><th>RDKit-js</th><th>3Dmol.js</th></tr></thead><tbody><tr><td><strong>主要对象</strong></td><td>蛋白质、核酸、复合物、冷冻电镜密度</td><td>小分子、药物化学</td><td>通用小分子&#x2F;蛋白，体积数据</td></tr><tr><td><strong>输入格式</strong></td><td>PDB&#x2F;mmCIF, BinaryCIF, SDF, MOL2, DCD 轨迹</td><td>SMILES→2D&#x2F;3D</td><td>SMILES, SDF, PDB, MOL2, 体积</td></tr><tr><td><strong>功能亮点</strong></td><td>结构对齐、轨迹播放、密度图、对称性、实体注释</td><td>高质量 2D 绘制、化学感知</td><td>轻量、快速嵌入、支持体积</td></tr><tr><td><strong>包体大小</strong></td><td>较大（功能全，按需分包）</td><td>~3 MB</td><td>~1 MB</td></tr><tr><td><strong>典型 URL</strong></td><td><a href="https://www.rcsb.org/3d-view/1RB8">https://www.rcsb.org/3d-view/1RB8</a></td><td>无官方托管</td><td>无官方托管</td></tr><tr><td><strong>是否 standalone</strong></td><td>提供 standalone viewer 可以本地部署</td><td>可以 standalone HTML</td><td>可以 standalone HTML</td></tr></tbody></table><ol><li>AF3：rcsb-molstar 是 RCSB PDB 官方基于 Mol*(MolStar) 核心做的一层“定制外壳”，专门用来在 rcsb.org 上展示蛋白质、核酸等大分子结构，在需要展示的页面动态引入。ketcher 使用standalone模式引入，用于分子结构绘制。</li><li>器件性质：RDKit，3Dmol</li></ol><h3 id="如何选择"><a href="#如何选择" class="headerlink" title="如何选择"></a>如何选择</h3><ul><li>只看小分子 2D&#x2F;快速 3D → RDKit-js（2D 极清）或 3Dmol.js（3D 轻量）。</li><li>需要 PDB 大分子 + 对齐 + 轨迹 + 密度 → rcsb-molstar（Mol*）。</li><li>想离线&#x2F;内网部署 → 三者都可下载对应 .js + .wasm 本地引用，实现“完全 standalone”；rcsb-molstar 也提供 npm run build 后的 dist 目录一键起静态服务。</li></ul><h3 id="React-umi-框架下使用-3Dmol-js-实践"><a href="#React-umi-框架下使用-3Dmol-js-实践" class="headerlink" title="React + umi 框架下使用 3Dmol.js  实践"></a>React + umi 框架下使用 3Dmol.js  实践</h3><ol><li>在 <code>public/3Dmol</code> 文件下加入 <code>3Dmol-min.js</code> 和 <code>3Dmol.ui-min.js</code> 两个文件（离线使用速度快）；</li><li>在 <code>.umirc.ts</code> 中加入<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-attr">headScripts</span>: [<br>  &#123; <span class="hljs-attr">src</span>: <span class="hljs-string">&#x27;/3Dmol/3Dmol-min.js&#x27;</span>&#125;,<br>  &#123; <span class="hljs-attr">src</span>: <span class="hljs-string">&#x27;/3Dmol/3Dmol.ui-min.js&#x27;</span>&#125;<br>]<br></code></pre></div></td></tr></table></figure></li><li>使用<br>官方 demo，实测生产环境有环境，暂时无法渲染。<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span><br><span class="hljs-tag">  <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">height:</span> &#x27;<span class="hljs-attr">400px</span>&#x27;, <span class="hljs-attr">width:</span> &#x27;<span class="hljs-attr">400px</span>&#x27;, <span class="hljs-attr">position:</span> &#x27;<span class="hljs-attr">relative</span>&#x27; &#125;&#125;</span><br><span class="hljs-tag">  <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;viewer_3Dmoljs&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">data-pdb</span>=<span class="hljs-string">&quot;2POR&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">data-backgroundcolor</span>=<span class="hljs-string">&quot;0xffffff&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">data-style</span>=<span class="hljs-string">&quot;stick&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">data-ui</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure>官方下载后渲染，实测出了速度慢，渲染没问题。<figure class="highlight tsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Device</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> containerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> $3Dmol = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$3Dmol</span>;<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> element = containerRef.<span class="hljs-property">current</span>;<br>    <span class="hljs-keyword">if</span> (element &amp;&amp; $3Dmol) &#123;<br>      <span class="hljs-keyword">let</span> viewer = $3Dmol.<span class="hljs-title function_">createViewer</span>(element, &#123;<br>        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">&#x27;white&#x27;</span>,<br>      &#125;);<br><br>      $3Dmol.<span class="hljs-title function_">download</span>(<br>        <span class="hljs-string">&#x27;pdb:1MO8&#x27;</span>,<br>        viewer,<br>        &#123; <span class="hljs-attr">multimodel</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">frames</span>: <span class="hljs-literal">true</span> &#125;,<br>        <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>          viewer.<span class="hljs-title function_">setStyle</span>(&#123;&#125;, &#123; <span class="hljs-attr">cartoon</span>: &#123; <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;spectrum&#x27;</span> &#125; &#125;);<br>          viewer.<span class="hljs-title function_">render</span>();<br>        &#125;,<br>      );<br>    &#125;<br>  &#125;, [$3Dmol]);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Flex</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;styles.mainContainer&#125;</span> <span class="hljs-attr">vertical</span> <span class="hljs-attr">flex</span>=<span class="hljs-string">&#123;1&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;containerRef&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">height:</span> &#x27;<span class="hljs-attr">400px</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">width:</span> &#x27;<span class="hljs-attr">400px</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">position:</span> &#x27;<span class="hljs-attr">relative</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">border:</span> &#x27;<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">        &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Flex</span>&gt;</span></span><br>  );<br>&#125;;<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="standalone"><a href="#standalone" class="headerlink" title="standalone"></a>standalone</h3><p>“standalone” 这个词在网页&#x2F;前端语境里通常表示「一个文件就能跑」，不需要额外后端服务，也不需要把库拆成很多 chunk。</p><ol><li>把 HTML 保存后直接双击即可在浏览器打开，所有依赖（rdkit.js、3Dmol.js、wasm、css）都是从 CDN 一次性拉取，本地不需要任何服务器或打包工具。</li><li>如果你想“更 standalone”——离线也能跑，只要把 CDN 资源下载到本地即可：</li></ol><ul><li>把<script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>换成下载下来的本地文件，如<script src="./lib/RDKit_minimal.js"></script></li><li>同理，把 3Dmol 的 CDN 链接换成本地 3Dmol-min.js。<br>最终目录结构可能只有：<figure class="highlight glsl"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs glsl"><span class="hljs-keyword">index</span>.html<br>lib/<br>  RDKit_minimal.js<br>  RDKit_minimal.wasm   <span class="hljs-meta"># 如果 RDKit 需要</span><br>  <span class="hljs-number">3</span>Dmol-<span class="hljs-built_in">min</span>.js<br></code></pre></div></td></tr></table></figure>这样即使断网，浏览器也能正常渲染 2D&#x2F;3D 结构——这就是“完全 standalone”。</li></ul><p><code>附录</code>：</p><ol><li><a href="https://3dmol.org/doc/tutorial-embeddable.html">3Dmol</a></li><li><a href="https://shubihu.github.io/2023/11/03/3dmol-js%E5%9C%A8React%E4%B8%AD%E4%BD%BF%E7%94%A8demo">3dmol.js在React中直接使用</a></li><li><a href="https://react.rdkitjs.com/#/">rdkit.js for react 官方</a></li><li><a href="https://github.com/rdkit/rdkit-js/tree/master/examples/react">rdkit.js for react 源代码</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>3Dmol</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>keycloak登录-修改页面</title>
    <link href="/2025/07/30/keycloak%E7%99%BB%E5%BD%95-%E4%BF%AE%E6%94%B9%E9%A1%B5%E9%9D%A2/"/>
    <url>/2025/07/30/keycloak%E7%99%BB%E5%BD%95-%E4%BF%AE%E6%94%B9%E9%A1%B5%E9%9D%A2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>近期的项目用 keycloak 做统一登录的入口，前端登录页直接跳转 keycloak 登录，所以需要对登录页面的样式稍做修改，本篇基于 keycloak 26.3.2 版本。<br>后续：后端表示坑多，放弃这个选型。</p></blockquote><span id="more"></span><h4 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h4><figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">├── js/                                  <span class="hljs-comment"># 和前端相关的文件，实测无法直接修改</span><br>├── themes/                              <span class="hljs-comment"># 配置主题相关</span><br>│   ├── src<span class="hljs-regexp">/main/</span>resources               <span class="hljs-comment"># 主题资源文件</span><br>│   │   ├── META-INF                     <span class="hljs-comment"># 选项配置</span><br>│   │   │   ├── keycloak-themes.json     <br>│   │   ├── theme                        <span class="hljs-comment"># 主题å配置      </span><br>│   │   │   ├── base                     <span class="hljs-comment"># 基础，无样式版本      </span><br>│   │   │   ├── keycloak                 <span class="hljs-comment"># 自带版本      </span><br>│   │   │   ├── keycloak.v2              <span class="hljs-comment"># 自带版本      </span><br>│   │   │   ├── swai                     <span class="hljs-comment"># 自定义版本  </span><br></code></pre></div></td></tr></table></figure><h4 id="修改步骤"><a href="#修改步骤" class="headerlink" title="修改步骤"></a>修改步骤</h4><ol><li><p>在 <code>keycloak-themes.json</code> 中添加新的选项</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;themes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        ...<br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;swai&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;types&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;login&quot;</span><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure></li><li><p>这次仅修改一个登录页面，所以复制了 keycloak.v2&#x2F;login 文件夹，重命名为 swai，修改其中的 css，如果有图片资源，放入文件夹下面的 resources 文件夹中。</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-pseudo">:root</span> &#123;<br>    <span class="hljs-attr">--keycloak-bg-logo-url</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&quot;../img/login-big.png&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p><img src="/img/keycloak-1.png" alt="样式修改"></p></li><li><p>部署的服务需要先清除缓存，后重启。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">./mvnw clean install -DskipTests -DsocksProxyHost=127.0.0.1 -DsocksProxyPort=7891<br>java -jar quarkus/server/target/lib/quarkus-run.jar start-dev --http-port=10000<br></code></pre></div></td></tr></table></figure></li><li><p>在网页中选择 Realm setting&#x2F;Themes，切换成配置好的选项。<br><img src="/img/keycloak-2.png" alt="网页配置"></p></li><li><p>刷新浏览器，背景图片替换成功。<br><img src="/img/keycloak-3.png" alt="登录页面"></p></li></ol><p><code>附录</code><br><a href="https://www.keycloak.org/guides#ui-customization">参考</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react16笔记（1）</title>
    <link href="/2025/07/05/react16%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89/"/>
    <url>/2025/07/05/react16%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>继续记录一下看文档的学习笔记。</p></blockquote><span id="more"></span><h3 id="必须用到-Hook-的典型场景"><a href="#必须用到-Hook-的典型场景" class="headerlink" title="必须用到 Hook 的典型场景"></a>必须用到 Hook 的典型场景</h3><table><thead><tr><th>需求</th><th>用哪个 Hook</th><th>举例</th></tr></thead><tbody><tr><td>组件需要内部状态</td><td><code>useState</code></td><td>计数器、开关、输入框受控</td></tr><tr><td>组件需要在挂载&#x2F;更新&#x2F;卸载时执行副作用</td><td><code>useEffect</code></td><td>发请求、订阅事件、操作 DOM</td></tr><tr><td>组件需要缓存昂贵计算结果</td><td><code>useMemo</code></td><td>大列表过滤、复杂计算</td></tr><tr><td>组件需要缓存回调函数引用</td><td><code>useCallback</code></td><td>把回调传给子组件避免重复渲染</td></tr><tr><td>组件需要读取或写入 Context</td><td><code>useContext</code></td><td>主题、语言、当前用户</td></tr><tr><td>组件需要保存可变值但不想触发重渲染</td><td><code>useRef</code></td><td>存定时器 id、保存上一次值</td></tr><tr><td>组件需要自定义逻辑复用</td><td>自定义 Hook</td><td><code>useToggle</code>, <code>useFetch</code>, <code>useDebounce</code></td></tr></tbody></table><p>数据会变 → useState<br>有副作用 → useEffect<br>要缓存 → useMemo &#x2F; useCallback<br>要全局透传 → useContext<br>要保存值但不想重渲染 → useRef<br>想复用逻辑 → 写自定义 Hook</p><h3 id="不需要-Hook-的场景"><a href="#不需要-Hook-的场景" class="headerlink" title="不需要 Hook 的场景"></a>不需要 Hook 的场景</h3><p>纯展示组件（props 进来直接渲染）：写成普通函数，无需任何 Hook。<br>逻辑已经在父组件里处理：子组件只负责渲染，不需要自己的 state 或 effect。<br>类组件：如果项目仍用 class，生命周期里写逻辑即可；但官方推荐函数组件 + Hook。</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react16笔记（1）</title>
    <link href="/2025/06/05/react16%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/"/>
    <url>/2025/06/05/react16%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>2025年，二开项目基础版本 react v16+，当前文档 v19，差别应该不大，记录一下看文档的学习笔记。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>以 use 开头的函数被称为 Hook，只能在函数组件主体（或其他 Hook）顶层调用。<br>如果想在一个条件或循环中使用 useState，需要提取一个新的组件并在组件内部使用它。</li><li>组件和 Hook 中的纯净性是 React 的一个关键规则：<br>组件必须是幂等的：对一样的输入props、state 和 context，返回相同的输出。<br>副作用必须在渲染之外运行（React 可能会多次渲染组件以创建最佳的用户体验）。<br>属性和状态是不可变的（一个组件的属性和状态是针对单次渲染不可变）。永远不要直接修改。<br>Hook 的返回值和参数是不可变的，一旦值被传递给 Hook，不应该修改。<br>值在被传递给 JSX 后是不可变的，如需修改，在创建之前进行修改。</li><li>React 负责在必要时渲染组件和 Hook ，它是<code>声明式</code>的：只要在组件逻辑中告诉 React 需要渲染什么。永远不要直接调用组件函数。永远不要将 Hook 作为常规值传递。</li><li>只在顶层调用 Hook。只在 React 函数中调用 Hook。</li><li>一个常见的具有副作用的例子是突变（mutation），在 JavaScript 中指的是改变一个非原始值的值。尽量进行局部 mutation。</li><li></li></ol><h3 id="114-101-x61-99-116-64-49-x39-x2e-x31"><a href="#114-101-x61-99-116-64-49-x39-x2e-x31" class="headerlink" title="&#114;&#101;&#x61;&#99;&#116;&#64;&#49;&#x39;&#x2e;&#x31;"></a><a href="mailto:&#114;&#101;&#x61;&#99;&#116;&#64;&#49;&#x39;&#x2e;&#x31;">&#114;&#101;&#x61;&#99;&#116;&#64;&#49;&#x39;&#x2e;&#x31;</a></h3><ol><li><p>Hook</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 状态帮助组件</span><br><span class="hljs-keyword">const</span> [index, setIndex] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// 上下文帮助组件(从祖先组件接收信息，而无需将其作为 props 传递)</span><br><span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br><br><span class="hljs-comment">// ref 允许组件保存一些不用于渲染的信息，比如 DOM 节点或 timeout ID。</span><br><span class="hljs-comment">// 与状态不同，更新 ref 不会重新渲染组件。用于非 React 系统如浏览器内置 API 一同工作时。</span><br><span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)<br><br><span class="hljs-comment">// Effect 允许组件连接到外部系统并与之同步，eg:处理网络、浏览器、DOM、动画、使用不同 UI 库编写的小部件以及其他非 React 代码。</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(roomId);<br>    connection.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();<br>  &#125;, [roomId]);<br><span class="hljs-comment">// useLayoutEffect 在浏览器重新绘制屏幕前执行，可以在此处测量布局。</span><br><span class="hljs-comment">// useInsertionEffect 在 React 对 DOM 进行更改之前触发，可以在此处插入动态 CSS。</span><br><br><span class="hljs-comment">// 优化重新渲染性能：告诉 React 重用缓存的计算结果，或者如果数据自上次渲染以来没有更改，则跳过重新渲染。</span><br><span class="hljs-comment">// 使用 useMemo 缓存计算代价昂贵的计算结果。</span><br><span class="hljs-keyword">const</span> visibleTodos = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">filterTodos</span>(todos, tab), [todos, tab]);<br><span class="hljs-comment">// 使用 useCallback 将函数传递给优化组件之前缓存函数定义。</span><br><span class="hljs-keyword">const</span> cachedFn = <span class="hljs-title function_">useCallback</span>(fn, dependencies)<br><span class="hljs-comment">// useTransition 允许将状态转换标记为非阻塞，并允许其他更新中断它。</span><br><span class="hljs-comment">// useDeferredValue 允许延迟更新 UI 的非关键部分，以让其他部分先更新。</span><br></code></pre></div></td></tr></table></figure></li><li><p>组件（这里的 react 内置组件感觉不常用）<br><Fragment> 通常使用 &lt;&gt;…&lt;&#x2F;&gt; 代替，它们都允许你在不添加额外节点的情况下将子元素组合。</p></li></ol><p>【生产环境禁用】使用 <Profiler> 包裹组件树，以测量其渲染性能。onRender：onRender 回调函数，当包裹的组件树更新时，React 都会调用它。它接收有关渲染内容和所花费时间的信息。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">Profiler</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;App&quot;</span> <span class="hljs-attr">onRender</span>=<span class="hljs-string">&#123;onRender&#125;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Profiler</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>【开发环境】使用 StrictMode 来启用组件树内部的额外开发行为和警告<br><Suspense> 允许在子组件完成加载前展示后备方案。</p><ol start="3"><li>API<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// act 是个测试辅助工具，用于在断言前应用待处理的 React 更新。</span><br><span class="hljs-keyword">await</span> <span class="hljs-title function_">act</span>(<span class="hljs-keyword">async</span> actFn)<br><br><span class="hljs-comment">// cache 允许缓存数据获取或计算的结果。仅供与 React 服务器组件 一起使用。</span><br><span class="hljs-keyword">const</span> cachedFn = <span class="hljs-title function_">cache</span>(fn);<br><br><span class="hljs-comment">// 【开发环境】captureOwnerStack 读取当前宿主环境的堆栈</span><br><span class="hljs-keyword">const</span> stack = <span class="hljs-title function_">captureOwnerStack</span>();<br><br><span class="hljs-comment">// 使用 createContext 创建组件能够提供与读取的 上下文</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">SomeContext</span> = <span class="hljs-title function_">createContext</span>(defaultValue)<br><br><span class="hljs-comment">// lazy 能够让你在组件第一次被渲染之前延迟加载组件的代码。</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">SomeComponent</span> = <span class="hljs-title function_">lazy</span>(load)<br><br><span class="hljs-comment">// memo 允许你的组件在 props 没有改变的情况下跳过重新渲染。</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoizedComponent</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-title class_">SomeComponent</span>, arePropsEqual?)<br><br><span class="hljs-comment">// startTransition 可以让你在后台渲染 UI 的一部分。</span><br><span class="hljs-title function_">startTransition</span>(action)<br><br><span class="hljs-comment">// use 是一个 React API，读取类似于 Promise 或 context 的资源的值。</span><br><span class="hljs-comment">// 与 React Hook 不同的是，可以在循环和条件语句（如 if）中调用 use。但需要注意的是，调用 use 的函数仍然必须是一个组件或 Hook。</span><br><span class="hljs-keyword">const</span> value = <span class="hljs-title function_">use</span>(resource);<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="x72-x65-x61-x63-116-x2d-x64-x6f-x6d-116-x40-x31-x39-46-49"><a href="#x72-x65-x61-x63-116-x2d-x64-x6f-x6d-116-x40-x31-x39-46-49" class="headerlink" title="&#x72;&#x65;&#x61;&#x63;&#116;&#x2d;&#x64;&#x6f;&#x6d;&#116;&#x40;&#x31;&#x39;&#46;&#49;"></a><a href="mailto:&#x72;&#x65;&#x61;&#x63;&#116;&#x2d;&#x64;&#x6f;&#x6d;&#116;&#x40;&#x31;&#x39;&#46;&#49;">&#x72;&#x65;&#x61;&#x63;&#116;&#x2d;&#x64;&#x6f;&#x6d;&#116;&#x40;&#x31;&#x39;&#46;&#49;</a></h3><ol><li><p>Hook</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// useFormStatus 是一个提供上次表单提交状态信息的 Hook。 </span><br><span class="hljs-comment">// useFormStatus 不会返回在同一组件中渲染的 &lt;form&gt; 的状态信息。</span><br><span class="hljs-comment">// 必须从在 &lt;form&gt; 内渲染的组件中调用。</span><br><span class="hljs-keyword">const</span> &#123; pending, data, method, action &#125; = <span class="hljs-title function_">useFormStatus</span>();<br></code></pre></div></td></tr></table></figure></li><li><p>组件</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&#123;search&#125;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;query&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;postContent&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;someOption&quot;</span>&gt;</span>Some option<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;otherOption&quot;</span>&gt;</span>Other option<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">progress</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;0.5&#125;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>Search<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li></ol><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;icon&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;favicon.ico&quot;</span> /</span><br><span class="hljs-tag">&lt;<span class="hljs-attr">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;keywords&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;React, JavaScript, semantic markup, html&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"> <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;hi!&quot;</span>) </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css">&#123;` <span class="hljs-selector-tag">p</span> &#123; <span class="hljs-attribute">color</span>: red; &#125; `&#125;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我的博客<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br></code></pre></div></td></tr></table></figure><ol start="3"><li><p>API<br>createPortal 允许你将 JSX 作为 children 渲染至 DOM 的不同部分。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"> <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">SomeComponent</span> /&gt;</span><br>  &#123;createPortal(children, domNode, key?)&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>flushSync 允许你强制 React 在提供的回调函数内同步刷新任何更新，这将确保 DOM 立即更新。<br>preconnect 可以帮助提前连接到一个期望从中加载资源的服务器。<br>prefetchDNS 允许提前查找期望从中加载资源的服务器的 IP。<br>preinit 可以预获取和评估样式表或外部脚本。<br>preinitModule 可以预获取和评估 ESM 模块。<br>preload 可以预获取期望使用的资源，比如样式表、字体或外部脚本。<br>preloadModule 可以急切地预获取期望使用的 ESM 模块。</p></li><li><p>客户端API<br>react-dom&#x2F;client API 允许你在客户端（浏览器）渲染 React 组件。这些 API 通常在应用程序顶层调用，以初始化 React 树。<code>大多数组件不需要导入或使用这些 API。</code><br>createRoot 允许在浏览器的 DOM 节点中创建根节点以显示 React 组件。<br>hydrateRoot 函数允许你在先前由 react-dom&#x2F;server 生成的浏览器 HTML DOM 节点中展示 React 组件。</p></li><li><p>服务端API<br>react-dom&#x2F;server API 允许你通过服务端渲染将 React 组件渲染为 HTML。这些 API 仅在服务器应用程序顶层调用，以生成初始 HTML。<code>大多数组件不需要导入或使用这些 API。</code><br>renderToPipeableStream 将一个 React 组件树渲染为管道化（pipeable）的 Node.js 流。<br>renderToReadableStream 将 React 树渲染后发送至 Web 可读流。<br>renderToStaticMarkup 会将非交互的 React 组件树渲染成 HTML 字符串。<br>renderToString 将 React 树渲染为一个 HTML 字符串。</p></li><li><p>static APIs<br>react-dom&#x2F;static API 允许你为 React 组件生成静态 HTML。<code>大多数组件不需要导入或使用这些 API。</code><br>prerender 使用 Web Stream 将 React 树渲染为静态 HTML 字符串。<br>prerenderToNodeStream renders a React tree to a static HTML string using a Node.js Stream..</p></li></ol><p><code>javascript</code><br>以下这些特殊的 React 属性适用于所有内置组件：<br>（1）children：React 节点（可以是元素、字符串、数字、portal，如 null，undefined 这样的空节点和布尔值，或其他 React 节点数组）。children 属性指定了组件内部的内容。当使用 JSX 时，通常会通过嵌套标签 <div><span /></div> 隐式地指定 children 属性。<br>（2）dangerouslySetInnerHTML：其中包含原始的 HTML 字符串。<br>（3）ref：使用 useRef 或者 createRef 的 ref 对象，或者一个 ref 回调函数，再或者一个用于 传统 ref 的字符串。ref 将被填充为此节点的 DOM 元素。<br>（4）suppressContentEditableWarning：布尔值。如果为 true 将会抑制 React 对同时具有 child 和 contentEditable&#x3D;{true} 属性的元素发出的警告。<br>（5）suppressHydrationWarning：布尔值。如果你使用 服务器渲染，通常会在服务器和客户端渲染不同内容时发出警告。<br>（6）style：CSS 样式对象，使用像 camelCase 这样的驼峰命名法。</p><p>所有内置组件也支持这些标准的 DOM 属性：<br>accessKey：为该元素指定一个键盘快捷键。<code>通常不建议使用</code>。<br>aria-*：指定辅助功能树信息。<br>autoCapitalize：指定用户输入的大小写形式。<br>className：指定元素的 CSS 类名。阅读更多关于应用 CSS 样式的内容。<br>contentEditable：一个布尔值。如果为 true，浏览器允许用户直接编辑渲染的元素。<br>data-*：数据属性允许你将一些字符串数据附加到元素上，例如 data-fruit&#x3D;”banana”。由于通常会从 props 与 state 中读取数据，<code>因此在 React 中不常用此属性</code>。<br>dir：值为 ltr 与 rtl 之一，指定元素的文本方向。<br>draggable：布尔值，指定元素是否可拖动。<br>enterKeyHint：字符串，指定虚拟键盘上的回车键应该呈现哪种操作。<br>htmlFor：字符串，用于 <label> 和 <output>，以 标签与某些控件关联起来。类似在 HTML for 属性 React 使用标准的 DOM 属性名称（htmlFor），而不是 HTML 属性名称。<br>hidden：布尔值或者字符串，指定元素是否应该被隐藏。<br>id：字符串，指定该元素的唯一标识符，可用于以后查找或将其与其他元素连接。使用 useId 生成它，以避免同一组件的多个实例之间发生冲突。<br>is：字符串。如果指定，该组件将表现得像一个自定义元素。<br>inputMode：字符串，指定要显示的键盘类型（例如，文本、数字或电话）。<br>itemProp：字符串，指定元素代表的属性，供结构化数据爬取程序使用。<br>lang：字符串，指定元素的语言。</p><p>onAnimationEnd(onAnimationEndCapture)：在 CSS 动画完成时触发。<br>onAnimationIteration(onAnimationIterationCapture)：当 CSS 动画的一次迭代结束并开始另一个迭代时触发。<br>onAnimationStart(onAnimationStartCapture)：当 CSS 动画开始时触发。<br>onAuxClick(onAuxClickCapture)：当非主要指针按钮被点击时触发。<br>onBeforeInput(onBeforeInputCapture)：在可编辑元素的值被修改之前触发。<code>React 尚未使用原生的 beforeinput 事件</code>。<br>onBlur(onBlurCapture)：当元素失去焦点时触发。与内置的浏览器 blur 不同，<code>在 React 中，onBlur 事件会冒泡</code>。<br>onClick(onClickCapture)：当指针设备上的主按钮被点击时触发。<br>onCompositionStart(onCompositionStartCapture)：当输入法编辑器开始新的组合会话时触发。<br>onCompositionEnd(onCompositionEndCapture)：在输入法编辑器完成或者取消组合会话时触发。<br>onCompositionUpdate(onCompositionUpdateCapture)：在输入法输入法编辑器收到一个新的字符时触发。<br>onContextMenuCaptureonContextMenu()：当用户尝试打开上下文菜单时触发。<br>onCopy(onCopyCapture)：当用户尝试将某些内容复制到剪贴板时触发。<br>onCut(onCutCapture)：当用户尝试将某些内容剪切到剪贴板时触发。<br>onDoubleClick(onDoubleClickCapture)：在用户双击时触发。对应于浏览器 dblclick 事件。<br>onDrag(onDragCapture)：当用户拖拽某些元素时触发。<br>onDragEnd(onDragEndCapture)：当用户停止拖拽元素时触发。<br>onDragEnter(onDragEnterCapture)：当拖动的元素进入有效的放置目标时触发。<br>onDragOver(onDragOverCapture)：当拖动的元素进入有效的放置目标完成时触发。你需要声明 e.preventDefault() 去允许拖拽。<br>onDragStart(onDragStartCapture)：当用户开始拖拽元素时触发。<br>onDrop(onDropCapture)：当元素被拖放到有效的目标区域时触发。<br>onFocus(onFocusCapture)：当元素失去焦点时触发。与内置的浏览器 focus 时间不同，<code>在 React 中，onFocus 事件会冒泡</code>。<br>onGotPointerCapture(onGotPointerCaptureCapture)：当元素以编程方式捕获指针时触发。<br>onKeyDown(onKeyDownCapture)：当按键被按下时触发。<br>onKeyPress：<code>此属性已废弃，请使用 onKeyDown 或 onBeforeInput 替代</code>。<br>onKeyUp(onKeyUpCapture)：当按键被释放时触发。<br>onLostPointerCapture(onLostPointerCaptureCapture)：当元素停止捕获指针时触发。<br>onMouseDown(onMouseDownCapture)：当指针按下时触发。<br>onMouseEnter：当指针在元素内移动时触发。没有捕获阶段。<br>onMouseLeave：当指针移动到元素外部时触发。没有捕获阶段。<br>onMouseMove(onMouseMoveCapture)：当指针改变坐标时触发。<br>onMouseOut(onMouseOutCapture)：当指针移动到元素外部或移动到子元素时触发。<br>onMouseUp(onMouseUpCapture)：当指针释放时触发。<br>onPointerCancel(onPointerCancelCapture)：当浏览器取消指针交互时触发。<br>onPointerDown(onPointerDownCapture)：当指针变为活动状态时触发。<br>onPointerEnter：当指针在元素内移动时触发。没有捕获阶段。<br>onPointerLeave：当指针移动到元素外部时触发。没有捕获阶段。<br>onPointerMove(onPointerMoveCapture)：当指针改变坐标时触发。<br>onPointerOut(onPointerOutCapture)：当指针移动到元素外部时触发，如果指针交互被取消以及 其他一些原因。<br>onPointerUp(onPointerUpCapture)：当指针不再活动时触发。<br>onPaste(onPasteCapture)：当用户尝试从剪贴板粘贴内容时触发。<br>onScroll(onScrollCapture)：当元素被滚动时触发。此事件不会冒泡。<br>onSelect(onSelectCapture)：在可编辑元素内部的选择更改后触发，例如输入框。React 扩展了 onSelect 事件以适用于 contentEditable&#x3D;{true} 元素。此外，React 还将其扩展为在空选择和编辑时触发（可能会影响选择）。<br>onTouchCancelCaptureonTouchCancel()：当浏览器取消触摸交互时触发。<br>onTouchEnd(onTouchEndCapture)：当一个或多个触摸点被移除时触发。<br>onTouchMove(onTouchMoveCapture)：当一个或多个触点移动时，会触发火灾。<br>onTouchStart(onTouchStartCapture)：当一个或多个触摸点被放置时触发。<br>onTransitionEnd(onTransitionEndCapture)：当 CSS 过渡完成时触发。<br>onWheel(onWheelCapture)：当用户旋转滚轮按钮时触发。<br>role：一个字符串。为辅助技术明确指定元素角色<br>slot：一个字符串。当使用 shadow DOM 时，指定插槽名称。在 React 中，通常通过将 JSX 作为 props 传递来实现等效模式。例如 &lt;Layout left&#x3D;{<Sidebar />} right&#x3D;{<Content />} &#x2F;&gt;。<br>spellCheck：布尔值或空值。如果明确设置为 true 或 false，则启用或禁用拼写检查。<br>tabIndex：一个数字。覆盖默认的 Tab 按钮行为。避免使用除了 -1 和 0 以外的值。<br>title：一个字符串。指定元素的工具提示文本。<br>translate：’yes’ 或者 ‘no’。选择 ‘no’ 将排除元素内容的翻译。<br>你还可以将自定义属性作为 props 传递。例如 mycustomprop&#x3D;”someValue”。当与第三方库集成时，这可能很有用。但是自定义属性名称必须为小写，并且不能以 on 开头。该值将被转换为一个字符串。如果你传递 null 或 undefined，则自定义属性将被删除。</p><p>这些事件仅适用于 <form> 元素：<br>onReset(onResetCapture)：当表单被重置时触发。<br>onSubmit(onSubmitCapture)：当表单提交时触发。</p><p>这些事件仅适用于 <dialog> 元素，与浏览器事件不同，React 中的事件会冒泡：<br>onCancel(onCancelCapture)：当用户尝试关闭对话框时触发。<br>onClose(onCloseCapture)：当对话框已关闭时触发。</p><p>这些事件仅适用于 <details> 元素，与浏览器事件不同，React 中的事件会冒泡：<br>onToggle(onToggleCapture)：当用户切换详细信息时触发。</p><p>这些事件会触发在 <img>、<iframe>、<object>、<embed>、<link> 和 SVG <image> 元素。与浏览器事件不同，React 中的事件会冒泡：<br>onLoad(onLoadCapture)：当资源加载时触发。<br>onError(onErrorCapture)：当资源无法加载时触发。</p><p>这些事件会触发在 <audio> 和 <video>。与浏览器事件不同，React 中的事件会冒泡：<br>onAbort(onAbortCapture)：当资源尚未完全加载但没有错误时触发。<br>onCanPlay(onCanPlayCapture)：当有足够的数据开始播放，但是没有足够的数据可以无缓冲地播放到结束时触发。<br>onCanPlayThrough(onCanPlayThroughCapture)：当有足够的数据可以开始播放而不需要缓冲到结束时触发。<br>onDurationChange(onDurationChangeCapture)：当媒体持续时间更新时触发。<br>onEmptied(onEmptiedCapture)：当媒体变为空时触发。<br>onEncrypted(onEncryptedCapture)：当浏览器遇到加密媒体时触发。<br>onEnded(onEncryptedCapture)：当播放停止因为没有剩余的内容可供播放时触发。<br>onError(onErrorCapture)：当资源无法加载时触发。<br>onLoadedData(onLoadedDataCapture)：在当前播放帧已加载时触发。<br>onLoadedMetadata(onLoadedMetadataCapture)：元数据加载完成时触发。<br>onLoadStart(onLoadStartCapture)：当浏览器开始加载资源时触发。<br>onPause(onPauseCapture)：当媒体暂停时触发。<br>onPlay(onPlayCapture)：当媒体不再暂停时触发。<br>onPlaying(onPlayingCapture)：当媒体开始或重新开始播放时触发。<br>onProgress(onProgressCapture)：在资源加载时定期触发。<br>onRateChange(onRateChangeCapture)：当播放速率改变时触发。<br>onResize(onResizeCapture)：当视频大小改变时触发。<br>onSeeked(onSeekedCapture)：当搜索操作完成时触发。<br>onSeeking(onSeekingCapture)：当搜索操作开始时触发。<br>onStalled(onStalledCapture)：当浏览器等待数据但仍未加载时触发。<br>onSuspend(onSuspendCapture)：当资源加载被暂停时触发。<br>onTimeUpdate(onTimeUpdateCapture)：当前播放时间更新时触发。<br>onVolumeChange(onVolumeChangeCapture)：当音量发生变化时触发。<br>onWaiting(onWaitingCapture)：由于临时缺少数据而导致播放停止时触发。</p><p>与 useRef 返回的 ref 对象不同，可以将函数传递给 ref 属性。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;(node)</span> =&gt;</span> &#123;<br>  console.log(&#x27;Attached&#x27;, node);<br><br>  return () =&gt; &#123;<br>    console.log(&#x27;Clean up&#x27;, node)<br>  &#125;<br>&#125;&#125;&gt;<br></code></pre></div></td></tr></table></figure><p><code>javascript</code></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RAG笔记（2）ragflow-web二开</title>
    <link href="/2025/05/16/RAG%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89ragflow-web%E4%BA%8C%E5%BC%80/"/>
    <url>/2025/05/16/RAG%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89ragflow-web%E4%BA%8C%E5%BC%80/</url>
    
    <content type="html"><![CDATA[<blockquote><p>记录一下 ragflow-web 二开的过程。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>Umi 以路由为基础，同时支持配置式路由和约定式路由，保证路由的功能完备，并以此进行功能扩展。然后配以生命周期完善的插件体系，覆盖从源码到构建产物的每个生命周期，支持各种功能扩展和业务需求。</li><li>总结一下 Outlet 的主要特点：<br>  路由嵌套：</li></ol><ul><li>允许在父路由组件中渲染子路由组件</li><li>实现路由的层级结构<br>  布局复用：</li><li>可以在多个页面之间共享相同的布局</li><li>只需要改变 Outlet 位置的内容<br>  权限控制：</li><li>可以在渲染子路由之前进行权限验证</li><li>根据条件决定是否渲染子路由内容<br>  组件复用：</li><li>避免重复编写相同的布局代码</li><li>提高代码的可维护性<br>  这是 UmiJS 框架提供的一个非常实用的功能，特别适合构建具有复杂路由结构的应用程序。</li></ul><h3 id="前端架构"><a href="#前端架构" class="headerlink" title="前端架构"></a>前端架构</h3><ol><li>前端使用 react + umi 框架，经多次实验，已定版本 umi4.4.4；</li><li>TypeScript 作为开发语言，Tailwind CSS 作为样式解决方案；</li><li>组件使用 Ant Design，可作定制化修改；</li><li>ESLint 和 Prettier 用于代码规范，Jest 用于单元测试；<figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">├── docs/                                <span class="hljs-comment"># 文档，上级目录中 copy 过来，保证项目正常运行</span><br>├── dist/                                <span class="hljs-comment"># npm run build 之后打包的文件</span><br>├── public/                              <span class="hljs-comment"># 静态资源目录</span><br>├── package.json                         <span class="hljs-comment"># 项目依赖和脚本配置</span><br>├── tsconfig.json                        <span class="hljs-comment"># typeScript 配置文件</span><br>├── tailwind.config.js 和 tailwind.css   <span class="hljs-comment"># Tailwind CSS 配置和样式文件</span><br>├── <span class="hljs-string">.umirc.ts</span>                            <span class="hljs-comment"># UmiJS 框架的配置文件</span><br>├── <span class="hljs-string">.env</span>                                 <span class="hljs-comment"># 运行时环境配置</span><br>├── typings.d.ts                         <span class="hljs-comment"># 全局变量/模块声明</span><br>├── docs/                                <span class="hljs-comment"># 文档</span><br>├── src/ <br>│   ├── <span class="hljs-string">.umi/</span>                            <span class="hljs-comment"># dev 时的临时文件目录，比如入口文件、路由等，都会被临时生成到这里 </span><br>│   ├── <span class="hljs-string">.umi-production/</span>                 <span class="hljs-comment"># build 时的临时文件目录，比如入口文件、路由等，都会被临时生成到这里                           </span><br>│   ├── pages/                           <span class="hljs-comment"># 页面组件目录</span><br>│   │   ├── agent/                       <span class="hljs-comment"># Agent 流程图 UI（Canvas + DSL 构建）</span><br>│   │   ├── chat/                        <span class="hljs-comment"># 聊天界面：配置、消息流、Prompt 管理</span><br>│   │   ├── dataset/                     <span class="hljs-comment"># 数据集：文档上传、解析、标签设置</span><br>│   │   ├── add-knowledge/               <span class="hljs-comment"># 添加知识：文档→结构化→知识图谱</span><br>│   │   ├── flow/                        <span class="hljs-comment"># Flow 模式 UI，与 Agent 机制相似</span><br>│   └── layouts/                          <span class="hljs-comment"># 布局组件目录</span><br>│   │   ├── index.tsx                    <span class="hljs-comment"># umi会根据路由进行匹配，匹配到的组件都会放到Outlet中渲染                      </span><br>│   ├── components/                      <span class="hljs-comment"># 通用组件库：表单、Modal、预览器等</span><br>│   ├── hooks/                           <span class="hljs-comment"># 与后端服务配合的数据处理逻辑封装</span><br>│   └── utils/                           <span class="hljs-comment"># 工具函数</span><br>│   └── assets/                          <span class="hljs-comment"># 静态资源文件，img</span><br>│   └── locales/                         <span class="hljs-comment"># 国际化文件，当前只保留中文</span><br>│   └── theme/                           <span class="hljs-comment"># 主题相关文件</span><br>│   └── wrapper/                         <span class="hljs-comment"># 权限包裹组件（临时注释可避开验证）</span><br>│   └── less/                            <span class="hljs-comment"># 全局样式文件</span><br>│   └── app.tsx                          <span class="hljs-comment"># 应用入口文件</span><br>│   └── routes.ts                        <span class="hljs-comment"># 路由配置文件</span><br></code></pre></div></td></tr></table></figure></li></ol><h3 id="前端代码修改思路"><a href="#前端代码修改思路" class="headerlink" title="前端代码修改思路"></a>前端代码修改思路</h3><h4 id="框架修改"><a href="#框架修改" class="headerlink" title="框架修改"></a>框架修改</h4><ol><li><code>.umirc.ts</code>作为基础框架，可设置系统配置、全局路由、接口代理、插件。</li><li>最终路由导入到 umi 配置文件中。若需要修改，在<code>routers.ts</code> 定义路由，<code>pages</code> 文件夹下新建页面组件；（umi支持约定式路由和配置式路由，这里选择配置式）</li><li>若需要修改后端接口代理，添加 <code>proxy</code>；</li><li>若需要在入口文件<code>index.html</code> （运行时umi自动生成）中添加静态文件，可在 <code>public</code> 中引入，然后在 <code>headScripts</code> 中添加文件名；</li><li>配置修改：</li><li>Logo: 直接修改 <code>public/logo.svg</code></li><li>标题：<code>conf.json</code> 中修改<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">TerserPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;terser-webpack-plugin&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;umi&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; appName &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./src/conf.json&#x27;</span>;<br><span class="hljs-keyword">import</span> routes <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./src/routes&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">title</span>: appName,<br>  <span class="hljs-attr">outputPath</span>: <span class="hljs-string">&#x27;dist&#x27;</span>,<br>  <span class="hljs-attr">alias</span>: &#123; <span class="hljs-string">&#x27;@parent&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;./&#x27;</span>) &#125;,<br>  <span class="hljs-attr">npmClient</span>: <span class="hljs-string">&#x27;npm&#x27;</span>,<br>  <span class="hljs-attr">base</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>  routes,<br>  <span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>  <span class="hljs-attr">esbuildMinifyIIFE</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">icons</span>: &#123;&#125;,<br>  <span class="hljs-attr">hash</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">favicons</span>: [<span class="hljs-string">&#x27;/logo.svg&#x27;</span>],<br>  <span class="hljs-attr">clickToComponent</span>: &#123;&#125;,<br>  <span class="hljs-attr">history</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;browser&#x27;</span>,<br>  &#125;,<br>  <span class="hljs-attr">headScripts</span>: [<br>    &#123; <span class="hljs-attr">src</span>: <span class="hljs-string">&#x27;/config.js&#x27;</span> &#125;<br>  ],<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-string">&#x27;@react-dev-inspector/umi4-plugin&#x27;</span>,<br>    <span class="hljs-string">&#x27;@umijs/plugins/dist/tailwindcss&#x27;</span>,<br>  ],<br>  <span class="hljs-attr">jsMinifier</span>: <span class="hljs-string">&#x27;none&#x27;</span>, <br>  <span class="hljs-attr">lessLoader</span>: &#123;<br>    <span class="hljs-attr">modifyVars</span>: &#123;<br>      <span class="hljs-attr">hack</span>: <span class="hljs-string">`true; @import &quot;~@/less/index.less&quot;;`</span>,<br>    &#125;,<br>  &#125;,<br>  <span class="hljs-attr">devtool</span>: <span class="hljs-string">&#x27;source-map&#x27;</span>,<br>  <span class="hljs-attr">copy</span>: [<br>    &#123; <span class="hljs-attr">from</span>: <span class="hljs-string">&#x27;src/conf.json&#x27;</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">&#x27;dist/conf.json&#x27;</span> &#125;,<br>    &#123; <span class="hljs-attr">from</span>: <span class="hljs-string">&#x27;node_modules/monaco-editor/min/vs/&#x27;</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">&#x27;dist/vs/&#x27;</span> &#125;,<br>  ],<br>  <span class="hljs-attr">proxy</span>: [<br>    &#123;<br>      <span class="hljs-attr">context</span>: [<span class="hljs-string">&#x27;/api&#x27;</span>, <span class="hljs-string">&#x27;/v1&#x27;</span>],<br>      <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://127.0.0.1:9380/&#x27;</span>,<br>      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">ws</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">logger</span>: <span class="hljs-variable language_">console</span>,<br>      <span class="hljs-comment">// pathRewrite: &#123; &#x27;^/v1&#x27;: &#x27;/v1&#x27; &#125;,</span><br>    &#125;,<br>  ],<br><br>  <span class="hljs-title function_">chainWebpack</span>(<span class="hljs-params">memo, args</span>) &#123;<br>    memo.<span class="hljs-property">module</span>.<span class="hljs-title function_">rule</span>(<span class="hljs-string">&#x27;markdown&#x27;</span>).<span class="hljs-title function_">test</span>(<span class="hljs-regexp">/\.md$/</span>).<span class="hljs-title function_">type</span>(<span class="hljs-string">&#x27;asset/source&#x27;</span>);<br>    memo.<span class="hljs-property">optimization</span>.<span class="hljs-title function_">minimizer</span>(<span class="hljs-string">&#x27;terser&#x27;</span>).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">TerserPlugin</span>); <span class="hljs-comment">// Fixed the issue that the page displayed an error after packaging lexical with terser</span><br>    <span class="hljs-keyword">return</span> memo;<br>  &#125;,<br>  <span class="hljs-attr">tailwindcss</span>: &#123;&#125;,<br>&#125;);<br></code></pre></div></td></tr></table></figure></li></ol><h4 id="样式修改"><a href="#样式修改" class="headerlink" title="样式修改"></a>样式修改</h4><ol><li>若需要改变前端布局，修改 <code>layouts</code> 文件夹下的内容；<code>header</code>为头部导航，<code>right-toolbar</code> 暂时不用；</li><li><code>app.tsx</code> 中可修改 ant-design 主题相关或 token 级别组件相关。字体使用 inter，在<code>assets/inter</code> 中可见倒入的字体。<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span></span><br><span class="hljs-tag">    <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;&#123;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">token:</span> &#123;</span><br><span class="hljs-tag">        <span class="hljs-attr">fontFamily:</span> &#x27;<span class="hljs-attr">Inter</span>&#x27;,</span><br><span class="hljs-tag">        <span class="hljs-attr">colorPrimary:</span> &#x27;#<span class="hljs-attr">165DFF</span>&#x27;,</span><br><span class="hljs-tag">      &#125;,</span><br><span class="hljs-tag">    &#125;&#125;</span><br><span class="hljs-tag">    <span class="hljs-attr">locale</span>=<span class="hljs-string">&#123;locale&#125;</span></span><br><span class="hljs-tag">    &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">SidebarProvider</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li><li><code>src/theme</code> 中进行系统相关的样式变量配置。</li></ol><h4 id="接口修改"><a href="#接口修改" class="headerlink" title="接口修改"></a>接口修改</h4><ol><li>本系统所有接口都在<code>utils/api.ts</code>中集合，<code>interface/request</code> 中定义接口参数的类型，<code>services</code> 中进行 url、method 封装（blob 相关也在这里配置），最后在 <code>hooks</code> 中作为方法调用。</li><li>若使用之前定义的格式，则需要避开装好的接口调用方式，因为原来的接口设计的不太好，请求顺利但是业务逻辑错误会返回400，在这个系统就获取不到返回的数据，所以只能自己hack。这里测试下来可以直接在 <code>hooks</code> 中使用 fetch 来获取完整的接口输出。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLogin</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; t &#125; = <span class="hljs-title function_">useTranslation</span>();<br><br>  <span class="hljs-keyword">const</span> &#123;<br>    data,<br>    <span class="hljs-attr">isPending</span>: loading,<br>    mutateAsync,<br>  &#125; = <span class="hljs-title function_">useMutation</span>(&#123;<br>    <span class="hljs-attr">mutationKey</span>: [<span class="hljs-string">&#x27;login&#x27;</span>],<br>    <span class="hljs-attr">mutationFn</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">params</span>: &#123;<br>      <span class="hljs-attr">account</span>: string;<br>      <span class="hljs-attr">hashed_password</span>: string;<br>    &#125;) =&gt; &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<br>        <span class="hljs-string">&#x27;accountApi/v1/ai-platform-control-center/sign-in-password&#x27;</span>,<br>        &#123;<br>          <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>          <span class="hljs-attr">headers</span>: &#123;<br>            <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,<br>          &#125;,<br>          <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params),<br>        &#125;,<br>      );<br><br>      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();<br><br>      <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">jw_token</span>) &#123;<br>        authorizationUtil.<span class="hljs-title function_">setItems</span>(&#123;<br>          <span class="hljs-title class_">Token</span>: res?.<span class="hljs-property">jw_token</span>,<br>          <span class="hljs-title class_">Authorization</span>: res?.<span class="hljs-property">jw_token</span>,<br>        &#125;);<br>        <span class="hljs-keyword">return</span> res;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">trial_times</span>) &#123;<br>        <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">trial_times</span> !== <span class="hljs-number">0</span>) &#123;<br>          message.<span class="hljs-title function_">error</span>(<br>            <span class="hljs-string">&#x27;密码错误，您还有&#x27;</span> + res?.<span class="hljs-property">trial_times</span> + <span class="hljs-string">&#x27;次尝试的机会。&#x27;</span>,<br>          );<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;,<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> &#123; data, loading, <span class="hljs-attr">login</span>: mutateAsync &#125;;<br>&#125;;<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><h4 id="系统设置"><a href="#系统设置" class="headerlink" title="系统设置"></a>系统设置</h4><ol><li>在左侧菜单渲染层面，通过用户名&#x3D;admin进行比对，只有admin时才可以渲染出系统设置菜单。</li><li>可能需要 access 来设定直接输入 URL 层面的跳转，目前查阅资源结论是升级到 @umi&#x2F;max 比较好，但是考虑到后期还需要移植新 feature，直接改框架成本较高，暂时搁置。</li></ol><h4 id="模型设置跳转"><a href="#模型设置跳转" class="headerlink" title="模型设置跳转"></a>模型设置跳转</h4><ol><li>Ragflow 原有逻辑：</li><li>个人账号未设置模型时，创建知识库、点击知识库之后会跳转；</li><li>个人账号未设置模型时，创建 Agent、点击 Agent之后会跳转；</li><li>用了navigate(&#x2F;***)。猜测是到了路由为 &#x2F;knowledge&#x2F;dataset 页面之后进行的判断，该页面 pages&#x2F;add-knowledge&#x2F;knowledge-dataset 由 knowledge-file 和 knowledge-chunk 两个组件组成。</li><li>具体是在弹窗的ok之后跳转的，跳转逻辑在 hooks&#x2F;user-setting-hooks 的 useFetchTenantInfo 方法中，useFetchTenantInfo(true) 会跳转 &#x2F;user-setting&#x2F;model，当前采用将跳转直接注释，若后续有问题需要整体查看一下。</li></ol><h3 id="web-端交互"><a href="#web-端交互" class="headerlink" title="web 端交互"></a>web 端交互</h3><h4 id="搜索模块"><a href="#搜索模块" class="headerlink" title="搜索模块"></a>搜索模块</h4><ol><li><code>hooks/logic-hooks.ts</code>中，send 方法请求 &#x2F;v1&#x2F;conversation&#x2F;ask，目前 response 中的 data 为具体内容，若引入深度思考，需要后端对回答进行参数明晰。（大概在215行）。大模型回答可搜索 answer 关键字。</li><li>response 中参数如下：</li><li>doc_aggs 为当前切片数组，用分页实现，第一次会返回12条数据，不明原因（看页面展示就用到了10条数据）。但是同时也调用了  &#x2F;v1&#x2F;chunk&#x2F;retrieval_test 返回10条数据，应该用的是这里的数据。</li><li>后面点击分页之后，请求 &#x2F;v1&#x2F;chunk&#x2F;retrieval_test 都是返回当前页数的10条数据。  <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-attr">answer</span>: <span class="hljs-string">&#x27;sse不断新增的完整回答&#x27;</span>,<br>  <span class="hljs-attr">reference</span>: &#123;<br>      <span class="hljs-attr">chunks</span>: [], <span class="hljs-comment">// 切片</span><br>      <span class="hljs-attr">doc_aggs</span>: [<br>          &#123;<br>              <span class="hljs-attr">doc_name</span>: <span class="hljs-string">&#x27;文件名&#x27;</span>,<br>              <span class="hljs-attr">doc_id</span>: <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-comment">// 根据id获取文件图片-一连串查询接口</span><br>          &#125;<br>      ],<br>      <span class="hljs-attr">total</span>: <span class="hljs-number">29</span><br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="问答助手模块"><a href="#问答助手模块" class="headerlink" title="问答助手模块"></a>问答助手模块</h4></li><li><code>pages/chat/chat-container/index.tsx</code> 为聊天内容代码，<code>pages/chat/markdown-content/index.tsx</code> 为回答展示。<br>  &#x2F;v1&#x2F;conversation&#x2F;completion 为大模型回答，answer 参数为回答的具体内容，其中<think></think>包裹的内容为深度思考，在 markdown 里面是按照html直接渲染的，样式已做了修改。</li><li><code>components/message-item/index.tsx</code> 为单条信息的代码，可设置 showLoudspeaker 为 false 关闭语音播放按钮。具体按钮组代码在 <code>components/message-item/group-button</code> 中。<br>[图片]</li><li><code>components/message-item/index.tsx</code> 中用户回答可携带上传成功的文件；助理回答可携带知识库参考来源；MarkdownContent 为回答内容；</li><li><code>components/message-input/index.tsx</code> 为输入框代码；用户对输入框的操作在 <code>pages/chat/hooks.ts</code> 中；发送代码在 <code>src/hooks/logic-hooks.ts</code> 的 useSendMessageWithSse</li></ol><h3 id="前后端可能遇到的问题"><a href="#前后端可能遇到的问题" class="headerlink" title="前后端可能遇到的问题"></a>前后端可能遇到的问题</h3><ol><li>登录时原始返回 authorization、userInfo 和 token，authorization 应该是网关相关，后面的接口都会用到，若用户无法认证，系统会自动跳转登录页面；和统一登录有所差别，开发时需特殊处理；</li></ol><p><code>附录</code><br><a href="https://github.com/infiniflow/ragflow">ragflow</a><br><a href="https://github.com/zstar1003/ragflow-plus">ragflow-plus</a><br><a href="https://umijs.org/docs/introduce/introduce">umi</a><br><a href="https://blog.csdn.net/qq_53123067/article/details/140505959">深入理解 UMI 框架</a><br><a href="https://blog.csdn.net/zh0623/article/details/130615234">qiankun+umi+antd</a><br><a href="https://segmentfault.com/a/1190000041352691">自定义umi微前端</a><br><a href="https://transform.tools/html-to-jsx">HTML to JSX</a><br><a href="https://ant-design.antgroup.com/docs/react/customize-theme-cn">定制主题</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker使用记录</title>
    <link href="/2025/04/23/Docker%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
    <url>/2025/04/23/Docker%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇是记录配置服务器的Docker、Docker Compose 的使用方法和常用问题记录。</p></blockquote><span id="more"></span><h3 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h3><h4 id="1-如何查看Docker版本？"><a href="#1-如何查看Docker版本？" class="headerlink" title="1. 如何查看Docker版本？"></a>1. 如何查看Docker版本？</h4><figure class="highlight applescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs applescript">docker <span class="hljs-built_in">version</span><br></code></pre></div></td></tr></table></figure><h4 id="2-如何查看Docker-Compose版本？"><a href="#2-如何查看Docker-Compose版本？" class="headerlink" title="2. 如何查看Docker Compose版本？"></a>2. 如何查看Docker Compose版本？</h4><figure class="highlight applescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs applescript">docker-compose <span class="hljs-built_in">version</span><br></code></pre></div></td></tr></table></figure><h4 id="3-如何查看Docker镜像？"><a href="#3-如何查看Docker镜像？" class="headerlink" title="3. 如何查看Docker镜像？"></a>3. 如何查看Docker镜像？</h4><figure class="highlight ebnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ebnf"><span class="hljs-attribute">docker images</span><br></code></pre></div></td></tr></table></figure><h4 id="4-如何查看Docker容器？"><a href="#4-如何查看Docker容器？" class="headerlink" title="4. 如何查看Docker容器？"></a>4. 如何查看Docker容器？</h4><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">docker ps -<span class="hljs-selector-tag">a</span><br></code></pre></div></td></tr></table></figure><h4 id="5-如何删除Docker镜像？"><a href="#5-如何删除Docker镜像？" class="headerlink" title="5. 如何删除Docker镜像？"></a>5. 如何删除Docker镜像？</h4><figure class="highlight ebnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ebnf"><span class="hljs-attribute">docker rmi image_name</span><br></code></pre></div></td></tr></table></figure><h4 id="6-如何删除Docker容器？"><a href="#6-如何删除Docker容器？" class="headerlink" title="6. 如何删除Docker容器？"></a>6. 如何删除Docker容器？</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker <span class="hljs-built_in">rm</span> container_name<br></code></pre></div></td></tr></table></figure><h4 id="7-如何停止Docker容器？"><a href="#7-如何停止Docker容器？" class="headerlink" title="7. 如何停止Docker容器？"></a>7. 如何停止Docker容器？</h4><figure class="highlight arduino"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arduino">docker stop container_name<br></code></pre></div></td></tr></table></figure><h4 id="8-如何启动Docker容器？"><a href="#8-如何启动Docker容器？" class="headerlink" title="8. 如何启动Docker容器？"></a>8. 如何启动Docker容器？</h4><figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">docker <span class="hljs-literal">start</span> container_name<br></code></pre></div></td></tr></table></figure><h4 id="9-如何查看Docker容器日志？"><a href="#9-如何查看Docker容器日志？" class="headerlink" title="9. 如何查看Docker容器日志？"></a>9. 如何查看Docker容器日志？</h4><figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-attribute">docker</span> logs container_name<br>docker logs -f container_name <span class="hljs-comment"># 实时查看日志</span><br></code></pre></div></td></tr></table></figure><h4 id="10-如何查看Docker容器内部的进程？"><a href="#10-如何查看Docker容器内部的进程？" class="headerlink" title="10. 如何查看Docker容器内部的进程？"></a>10. 如何查看Docker容器内部的进程？</h4><figure class="highlight coq"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs coq">docker <span class="hljs-built_in">top</span> container_name<br></code></pre></div></td></tr></table></figure><h4 id="11-如何进入Docker容器？"><a href="#11-如何进入Docker容器？" class="headerlink" title="11. 如何进入Docker容器？"></a>11. 如何进入Docker容器？</h4><figure class="highlight applescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs applescript">docker exec -<span class="hljs-keyword">it</span> container_name /bin/bash<br> docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> container_name bash<br></code></pre></div></td></tr></table></figure><h4 id="12-如何将本地文件拷贝到Docker容器？"><a href="#12-如何将本地文件拷贝到Docker容器？" class="headerlink" title="12. 如何将本地文件拷贝到Docker容器？"></a>12. 如何将本地文件拷贝到Docker容器？</h4><figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-symbol">docker</span> <span class="hljs-meta">cp</span> local_file_path container_name:container_file_path<br></code></pre></div></td></tr></table></figure><h4 id="13-如何将Docker容器内的文件拷贝到本地？"><a href="#13-如何将Docker容器内的文件拷贝到本地？" class="headerlink" title="13. 如何将Docker容器内的文件拷贝到本地？"></a>13. 如何将Docker容器内的文件拷贝到本地？</h4><figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-symbol">docker</span> <span class="hljs-meta">cp</span> container_name:container_file_path local_file_path<br></code></pre></div></td></tr></table></figure><h4 id="14-如何在Docker容器中执行命令？"><a href="#14-如何在Docker容器中执行命令？" class="headerlink" title="14. 如何在Docker容器中执行命令？"></a>14. 如何在Docker容器中执行命令？</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> container_name <span class="hljs-built_in">command</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>部署</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nextjs（1）</title>
    <link href="/2025/04/10/nextjs%EF%BC%881%EF%BC%89/"/>
    <url>/2025/04/10/nextjs%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>公司有个 dify 的项目，想法是前端能不能做一个 UI 修改，后期可能还有业务逻辑修改。下载源码后发现技术栈为 nextjs，是基于 react 的，所以就先学习一下。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>react 存在的问题：js 环境、首屏加载慢、安全问题、SEO，nextjs 解决了这些问题，具体方式是渲染后移，SSR 服务端渲染和 SSG 服务端生成，将原来在浏览器中渲染（将数据渲染成 DOM，并不是 DOM 渲染成图像）的动作后移到服务器上去。<br>getServerSideProps 用来做服务端渲染（每个请求的时候运行）<br>getStaticProps&#x2F;getStaticPaths 用来做服务端生成（build 生成静态页面的时候运行）</li><li>默认为服务端组件，使用”use client”转换成客户端组件。</li><li>React的useEffect ：<br>是React Hooks API中的一个重要Hook，用于在函数组件中处理副作用。副作用是指那些不直接与组件的渲染逻辑相关，但需要在组件的生命周期中执行的操作，例如数据获取、订阅事件、手动操作DOM等。<br>它可以替代类组件中的 componentDidMount、componentDidUpdate 和 componentWillUnmount 生命周期方法。useEffect 可以根据传入的依赖数组来决定何时执行副作用函数。如果依赖数组为空（[]），则副作用函数只会在组件挂载后执行一次，并在组件卸载时执行清理函数（如果有）；如果依赖数组中有值，则副作用函数会在组件挂载后以及依赖项变化时执行。</li></ol><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npx create-next-app@latest<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://www.nextjs.cn/docs/getting-started">nextjs中文网</a><br><a href="https://www.creative-tim.com/">tw组件参考</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RAG笔记</title>
    <link href="/2025/04/09/RAG%E7%AC%94%E8%AE%B0/"/>
    <url>/2025/04/09/RAG%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>记录一下 RAG 项目用到的专有名词和技术。</p></blockquote><span id="more"></span><h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><p>跟 LLM 相关的参数：</p><ol><li><p>温度&#x2F;Temperature<br>用来控制文本生成的随机性或创造性，根据不同的任务场景，您可以参考以下设置：代码生成&#x2F;数学解题：0.0；数据抽取&#x2F;分析：1.0；通用对话：1.3；翻译：1.3；创意类写作&#x2F;诗歌创作：1.5<br>当前 deepseek 取值范围 [0,2]，默认0.6。</p></li><li><p>topP<br>保证文本质量和连贯性的前提下增加生成内容的多样性，值越大多样性越高。<br>当前 deepseek 取值范围 [0,1]，默认1。</p></li><li><p>频率惩罚&#x2F;Frequency Penalty<br>用于控制生成文本多样性，减少重复文本出现的可能。<br>当前 deepseek 取值范围 [-2,2]，默认0。</p></li></ol><p>跟向量数据库相关的参数：</p><ol><li><p>相似度阈值&#x2F;scoreThreshold</p></li><li><p>向量相似度权重&#x2F;vectorWeight</p></li><li><p>召回数&#x2F;topK</p></li></ol><h3 id="其他技术"><a href="#其他技术" class="headerlink" title="其他技术"></a>其他技术</h3><p>LLM 应用开发平台：AI 工作流、RAG 管道、Agent、模型管理、可观测性功能。</p><ol><li>工作流：在画布上构建和测试功能强大的 AI 工作流程</li><li>RAG Pipeline：广泛的 RAG 功能，涵盖从文档摄入到检索的所有内容，支持从 PDF、PPT 和其他常见文档格式中提取文本的开箱即用的支持。</li><li>Agent 智能体：基于 LLM 函数调用或 ReAct 定义 Agent，并为 Agent 添加预构建或自定义工具。内置工具，如谷歌搜索、DALL·E、Stable Diffusion 和 WolframAlpha 等。</li><li>LLMOps：随时间监视和分析应用程序日志和性能。根据生产数据和标注持续改进提示、数据集和模型。</li></ol><h3 id="开源项目记录"><a href="#开源项目记录" class="headerlink" title="开源项目记录"></a>开源项目记录</h3><p>Dify：<br><a href="https://github.com/langgenius/dify">https://github.com/langgenius/dify</a><br>优点：功能齐全，star96k<br>缺点：有限开源，不可改图标，不可saas</p><p>ragflow：<br><a href="https://github.com/infiniflow/ragflow">https://github.com/infiniflow/ragflow</a><br>优点：功能基本满足，star51k，更新较快<br>缺点：bug较多，无RBAC</p><p>一个前后端分离的：<br><a href="https://github.com/IA-PieroCV/chatresume-backend">https://github.com/IA-PieroCV/chatresume-backend</a><br><a href="https://github.com/IA-PieroCV/chatresume-frontend">https://github.com/IA-PieroCV/chatresume-frontend</a><br>优点：前端使用Vue3，可直接上手。<br>缺点：更新于2年前，star太少</p><p><a href="https://github.com/1517005260/graph-rag-agent">https://github.com/1517005260/graph-rag-agent</a><br>优点：更新状态、star100+<br>纯python</p><p>阿里牵头做的：<a href="https://github.com/OpenSPG/KAG/tree/master">https://github.com/OpenSPG/KAG/tree/master</a><br>优点：更新状态、维护者较多、star6.7k<br>纯python</p><p><a href="https://github.com/HKUDS/LightRAG/tree/main">https://github.com/HKUDS/LightRAG/tree/main</a><br>优点：更新状态、维护者较多、star15.7k</p>]]></content>
    
    
    
    <tags>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react-native（2）</title>
    <link href="/2025/03/28/react-native%EF%BC%882%EF%BC%89/"/>
    <url>/2025/03/28/react-native%EF%BC%882%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录一下基本语法</p></blockquote><span id="more"></span><h3 id="stylesheet"><a href="#stylesheet" class="headerlink" title="stylesheet"></a>stylesheet</h3><ol><li>没有继承性（RN 中的继承只发生在 Text 组件上-相当于 web 中的 p 标签）</li><li>样式名采用小驼峰命名法</li><li>所有尺寸都没有单位</li><li>有些特殊的样式名（marginHorizontal-水平外边距、marginVertical-垂直外边距）</li></ol><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx">&lt;组件 style=&#123;&#123;样式&#125;&#125;&gt; <span class="hljs-comment">// 属性值为对象</span><br>&lt;组件 style=&#123;[&#123;样式&#125;, &#123;样式&#125;]&#125;&gt; <span class="hljs-comment">// 属性值为数组</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">View</span>, <span class="hljs-title class_">StyleSheet</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-native&#x27;</span><br><span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>(&#123; <span class="hljs-attr">foo</span>: &#123;样式<span class="hljs-number">1</span>&#125;, <span class="hljs-attr">bar</span>: &#123;样式<span class="hljs-number">2</span>&#125; &#125;)<br><br>&lt;<span class="hljs-title class_">View</span> style=&#123;[styles.<span class="hljs-property">foo</span>]&#125;&gt;使用样式&lt;/<span class="hljs-title class_">View</span>&gt;<br></code></pre></div></td></tr></table></figure><h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><p><img src="/../img/rn-1.jpg" alt="组件"><br><code>javascript</code><br><code>javascript</code></p><p><code>附录</code><br><a href="https://reactnative.cn/">react-native中文网</a> </p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>插件-vscode AI编程（2）cline-sw</title>
    <link href="/2025/03/28/%E6%8F%92%E4%BB%B6-vscode%20AI%E7%BC%96%E7%A8%8B%EF%BC%882%EF%BC%89cline-sw/"/>
    <url>/2025/03/28/%E6%8F%92%E4%BB%B6-vscode%20AI%E7%BC%96%E7%A8%8B%EF%BC%882%EF%BC%89cline-sw/</url>
    
    <content type="html"><![CDATA[<blockquote><p>给 cline 加了一个自己的选项。<br>但是好像改不了参数。暂时不知道怎么和计费关联，猜测这里的统计是一个虚假的数字，真正还是要通过API官网。</p></blockquote><span id="more"></span><h3 id="实验记录"><a href="#实验记录" class="headerlink" title="实验记录"></a>实验记录</h3><ol><li><code>webview-ui/src/components/setting/ApiOptions.tsx</code>中添加页面入口选项<figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123;<br>  swaiDefaultModelId,<br>swaiModels<br>&#125;<br><span class="hljs-keyword">return</span> (<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">display:</span> &quot;<span class="hljs-attr">flex</span>&quot;, <span class="hljs-attr">flexDirection:</span> &quot;<span class="hljs-attr">column</span>&quot;, <span class="hljs-attr">gap:</span> <span class="hljs-attr">5</span>, <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">isPopup</span> ? <span class="hljs-attr">-10</span> <span class="hljs-attr">:</span> <span class="hljs-attr">0</span> &#125;&#125;&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">DropdownContainer</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;dropdown-container&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;api-provider&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">fontWeight:</span> <span class="hljs-attr">500</span> &#125;&#125;&gt;</span>API Provider<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">VSCodeDropdown</span></span></span><br><span class="hljs-tag"><span class="language-xml"><span class="hljs-attr">id</span>=<span class="hljs-string">&quot;api-provider&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml"><span class="hljs-attr">value</span>=<span class="hljs-string">&#123;selectedProvider&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml"><span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleInputChange(</span>&quot;<span class="hljs-attr">apiProvider</span>&quot;)&#125;</span></span><br><span class="hljs-tag"><span class="language-xml"><span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml"><span class="hljs-attr">minWidth:</span> <span class="hljs-attr">130</span>,</span></span><br><span class="hljs-tag"><span class="language-xml"><span class="hljs-attr">position:</span> &quot;<span class="hljs-attr">relative</span>&quot;,</span></span><br><span class="hljs-tag"><span class="language-xml">&#125;&#125;&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">VSCodeOption</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;swai&quot;</span>&gt;</span>SWAI<span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeOption</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeDropdown</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">DropdownContainer</span>&gt;</span></span><br><span class="language-xml">      &#123;selectedProvider === &quot;swai&quot; &amp;&amp; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeTextField</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;apiConfiguration?.swaiApiKey</span> || &quot;&quot;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">width:</span> &quot;<span class="hljs-attr">100</span>%&quot; &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">onInput</span>=<span class="hljs-string">&#123;handleInputChange(</span>&quot;<span class="hljs-attr">swaiApiKey</span>&quot;)&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Enter API Key...&quot;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">fontWeight:</span> <span class="hljs-attr">500</span> &#125;&#125;&gt;</span>SWAI API Key<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeTextField</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">p</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">fontSize:</span> &quot;<span class="hljs-attr">12px</span>&quot;,</span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">3</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">color:</span> &quot;<span class="hljs-attr">var</span>(<span class="hljs-attr">--vscode-descriptionForeground</span>)&quot;,</span></span><br><span class="hljs-tag"><span class="language-xml">            &#125;&#125;&gt;</span></span><br><span class="language-xml">            This key is stored locally and only used to make API requests from this extension.</span><br><span class="language-xml">            &#123;!apiConfiguration?.deepSeekApiKey &amp;&amp; (</span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeLink</span></span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://ai.thuwaytec.com/&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">                <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">                  <span class="hljs-attr">display:</span> &quot;<span class="hljs-attr">inline</span>&quot;,</span></span><br><span class="hljs-tag"><span class="language-xml">                  <span class="hljs-attr">fontSize:</span> &quot;<span class="hljs-attr">inherit</span>&quot;,</span></span><br><span class="hljs-tag"><span class="language-xml">                &#125;&#125;&gt;</span></span><br><span class="language-xml">                You can get a SWAI API key by signing up here.</span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeLink</span>&gt;</span></span><br><span class="language-xml">            )&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">&#125;</span><br></code></pre></div></td></tr></table></figure></li></ol><p><code>webview-ui/src/components/chat/ChatView.tsx</code>中修改聊天界面。</p><ol start="2"><li>业务逻辑<br><code>src/core/webview/ClineProvider.ts</code>中加入 swaiApiKey<br><code>src/shared/api.ts</code>中加入 API，这里可以配置多个参数。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> type <span class="hljs-title class_">SWAIModelId</span> = keyof <span class="hljs-keyword">typeof</span> swaiModels<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">swaiDefaultModelId</span>: <span class="hljs-title class_">SWAIModelId</span> = <span class="hljs-string">&quot;deepseek-ai/DeepSeek-R1&quot;</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> swaiModels = &#123;<br><span class="hljs-string">&quot;deepseek-ai/DeepSeek-R1&quot;</span>: &#123;<br><span class="hljs-attr">maxTokens</span>: <span class="hljs-number">8_192</span>,<br><span class="hljs-attr">contextWindow</span>: <span class="hljs-number">131_072</span>,<br><span class="hljs-attr">supportsImages</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-attr">supportsPromptCache</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-attr">inputPrice</span>: <span class="hljs-number">0.002</span>,<br><span class="hljs-attr">outputPrice</span>: <span class="hljs-number">0.006</span>,<br><span class="hljs-attr">cacheWritesPrice</span>: <span class="hljs-number">0.002</span>,<br><span class="hljs-attr">cacheReadsPrice</span>: <span class="hljs-number">0.006</span>,<br>&#125;,<br>&#125; <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span> satisfies <span class="hljs-title class_">Record</span>&lt;string, <span class="hljs-title class_">ModelInfo</span>&gt;<br></code></pre></div></td></tr></table></figure><code>src/api/providers/swai.ts</code>中为重要处理逻辑，这里是根据openAI compatible改的（URL为***&#x2F;chat&#x2F;completion，参数一致都能访问）。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Anthropic</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@anthropic-ai/sdk&quot;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;openai&quot;</span><br><span class="hljs-keyword">import</span> &#123; withRetry &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../retry&quot;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ApiHandlerOptions</span>, <span class="hljs-title class_">SWAIModelId</span>, <span class="hljs-title class_">ModelInfo</span>, swaiDefaultModelId, swaiModels &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../shared/api&quot;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ApiHandler</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../index&quot;</span><br><span class="hljs-keyword">import</span> &#123; calculateApiCostOpenAI &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../utils/cost&quot;</span><br><span class="hljs-keyword">import</span> &#123; convertToOpenAiMessages &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../transform/openai-format&quot;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ApiStream</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../transform/stream&quot;</span><br><span class="hljs-keyword">import</span> &#123; convertToR1Format &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../transform/r1-format&quot;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ChatCompletionReasoningEffort</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;openai/resources/chat/completions.mjs&quot;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SWAIHandler</span> implements <span class="hljs-title class_">ApiHandler</span> &#123;<br>private <span class="hljs-attr">options</span>: <span class="hljs-title class_">ApiHandlerOptions</span><br>private <span class="hljs-attr">client</span>: <span class="hljs-title class_">OpenAI</span><br><br><span class="hljs-title function_">constructor</span>(<span class="hljs-params">options: ApiHandlerOptions</span>) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>(&#123;<br><span class="hljs-attr">baseURL</span>: <span class="hljs-string">&quot;http://***/r1/v1/&quot;</span>,<br><span class="hljs-comment">// baseURL: &quot;http://api.thuwaytec.com/v1/&quot;,</span><br><span class="hljs-attr">apiKey</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">swaiApiKey</span>,<br>&#125;)<br>&#125;<br><br>@<span class="hljs-title function_">withRetry</span>()<br><span class="hljs-keyword">async</span> *<span class="hljs-title function_">createMessage</span>(<span class="hljs-attr">systemPrompt</span>: string, <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Anthropic</span>.<span class="hljs-property">Messages</span>.<span class="hljs-property">MessageParam</span>[]): <span class="hljs-title class_">ApiStream</span> &#123;<br><span class="hljs-keyword">const</span> model = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getModel</span>()<br><br><span class="hljs-keyword">const</span> isDeepseekReasoner = model.<span class="hljs-property">id</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;deepseek-ai/DeepSeek-R1&quot;</span>)<br><br><span class="hljs-keyword">let</span> <span class="hljs-attr">openAiMessages</span>: <span class="hljs-title class_">OpenAI</span>.<span class="hljs-property">Chat</span>.<span class="hljs-property">ChatCompletionMessageParam</span>[] = [<br>&#123; <span class="hljs-attr">role</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-attr">content</span>: systemPrompt &#125;,<br>...<span class="hljs-title function_">convertToOpenAiMessages</span>(messages),<br>]<br><span class="hljs-keyword">let</span> <span class="hljs-attr">temperature</span>: number | <span class="hljs-literal">undefined</span> = <span class="hljs-number">0</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">reasoningEffort</span>: <span class="hljs-title class_">ChatCompletionReasoningEffort</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span><br><br><span class="hljs-keyword">if</span> (isDeepseekReasoner) &#123;<br>openAiMessages = <span class="hljs-title function_">convertToR1Format</span>([&#123; <span class="hljs-attr">role</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-attr">content</span>: systemPrompt &#125;, ...messages])<br>&#125;<br><br><span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>(&#123;<br><span class="hljs-attr">model</span>: model.<span class="hljs-property">id</span>,<br><span class="hljs-comment">// max_completion_tokens: model.info.maxTokens,</span><br><span class="hljs-attr">messages</span>: openAiMessages,<br><span class="hljs-attr">temperature</span>: <span class="hljs-number">1</span>,<br><span class="hljs-attr">reasoning_effort</span>: <span class="hljs-string">&quot;medium&quot;</span>,<br><span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-attr">stream_options</span>: &#123; <span class="hljs-attr">include_usage</span>: <span class="hljs-literal">true</span> &#125;,<br><span class="hljs-comment">// Only set temperature for non-reasoner models</span><br><span class="hljs-comment">// ...(model.id === &quot;deepseek-ai/DeepSeek-R1&quot; ? &#123;&#125; : &#123; temperature: 0 &#125;),</span><br>&#125;)<br><br><span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) &#123;<br><span class="hljs-keyword">const</span> delta = chunk.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span><br><span class="hljs-keyword">if</span> (delta?.<span class="hljs-property">content</span>) &#123;<br><span class="hljs-keyword">yield</span> &#123;<br><span class="hljs-attr">type</span>: <span class="hljs-string">&quot;text&quot;</span>,<br><span class="hljs-attr">text</span>: delta.<span class="hljs-property">content</span>,<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (delta &amp;&amp; <span class="hljs-string">&quot;reasoning_content&quot;</span> <span class="hljs-keyword">in</span> delta &amp;&amp; delta.<span class="hljs-property">reasoning_content</span>) &#123;<br><span class="hljs-keyword">yield</span> &#123;<br><span class="hljs-attr">type</span>: <span class="hljs-string">&quot;reasoning&quot;</span>,<br><span class="hljs-attr">reasoning</span>: (delta.<span class="hljs-property">reasoning_content</span> <span class="hljs-keyword">as</span> string | <span class="hljs-literal">undefined</span>) || <span class="hljs-string">&quot;&quot;</span>,<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (chunk.<span class="hljs-property">usage</span>) &#123;<br><span class="hljs-keyword">yield</span> &#123;<br><span class="hljs-attr">type</span>: <span class="hljs-string">&quot;usage&quot;</span>,<br><span class="hljs-attr">inputTokens</span>: chunk.<span class="hljs-property">usage</span>.<span class="hljs-property">prompt_tokens</span> || <span class="hljs-number">0</span>,<br><span class="hljs-attr">outputTokens</span>: chunk.<span class="hljs-property">usage</span>.<span class="hljs-property">completion_tokens</span> || <span class="hljs-number">0</span>,<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-title function_">getModel</span>(): &#123; <span class="hljs-attr">id</span>: <span class="hljs-title class_">SWAIModelId</span>; <span class="hljs-attr">info</span>: <span class="hljs-title class_">ModelInfo</span> &#125; &#123;<br><span class="hljs-keyword">const</span> modelId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">apiModelId</span><br><span class="hljs-keyword">if</span> (modelId &amp;&amp; modelId <span class="hljs-keyword">in</span> swaiModels) &#123;<br><span class="hljs-keyword">const</span> id = modelId <span class="hljs-keyword">as</span> <span class="hljs-title class_">SWAIModelId</span><br><span class="hljs-keyword">return</span> &#123; id, <span class="hljs-attr">info</span>: swaiModels[id] &#125;<br>&#125;<br><span class="hljs-keyword">return</span> &#123;<br><span class="hljs-attr">id</span>: swaiDefaultModelId,<br><span class="hljs-attr">info</span>: swaiModels[swaiDefaultModelId],<br>&#125;<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ol><p><code>src/api/index.ts</code>中引入上面的逻辑处理</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">SWAIHandler</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./providers/swai&quot;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildApiHandler</span>(<span class="hljs-params">configuration: ApiConfiguration</span>): <span class="hljs-title class_">ApiHandler</span> &#123;<br><span class="hljs-keyword">const</span> &#123; apiProvider, ...options &#125; = configuration<br><span class="hljs-keyword">switch</span> (apiProvider) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;swai&quot;</span>:<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SWAIHandler</span>(options)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://code.visualstudio.com/api/get-started/your-first-extension">官方插件指南</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react-native（1）</title>
    <link href="/2025/03/27/react-native%EF%BC%881%EF%BC%89/"/>
    <url>/2025/03/27/react-native%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>倒也不是专门想学，而是最近给我派了个活儿，让我看看一个开源的应用能不能改一下直接用。</p></blockquote><span id="more"></span><h3 id="Android-环境"><a href="#Android-环境" class="headerlink" title="Android 环境"></a>Android 环境</h3><ol><li>JDK（1.8）</li><li>Android Studio</li><li>Android SDK（编译 RN 用 Android 10 版本）</li><li>配置环境变量</li></ol><h3 id="iOS-环境"><a href="#iOS-环境" class="headerlink" title="iOS 环境"></a>iOS 环境</h3><ol><li>brew install watchman（监控文件变化）</li><li>xcode（10 或者更高版本）</li><li>brew install cocoapods（类似 npm）</li></ol><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>现在不用react-native-cli了，卸载掉它以避免一些冲突</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm uninstall -g react-native-cli @react-native-community/cli（全局安装）<br>npx @react-native-community/cli init mypro<br>cd mypro<br>yarn android # Android <br>cd ios &amp;&amp; pod install &amp;&amp; cd ../  # iOS<br>yarn ios # 或者 yarn react-native run-ios<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">可以使用--template来使用一些社区提供的模板，注意版本号必须精确到两个小数点</span><br>npx @react-native-community/cli init AwesomeProject --version X.XX.X<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://reactnative.cn/">react-native中文网</a> </p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>插件-zotero</title>
    <link href="/2025/03/04/%E6%8F%92%E4%BB%B6-zotero/"/>
    <url>/2025/03/04/%E6%8F%92%E4%BB%B6-zotero/</url>
    
    <content type="html"><![CDATA[<blockquote><p>老板自用软件，想要一个插件，害。。。</p></blockquote><span id="more"></span><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ol><li>安装开发版 zotero</li><li>下载官方 demo，用最新版本的 Nodejs 安装依赖</li><li>官方 demo 跑通，特别需要注意修改本机安装路径，mac 版本安装路径如下：<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ZOTERO_PLUGIN_ZOTERO_BIN_PATH = /Applications/Zotero.app/Contents/MacOS/zotero<br>ZOTERO_PLUGIN_PROFILE_PATH = /Users/***/Library/Application Support/Zotero/Profiles/***.default<br></code></pre></div></td></tr></table></figure></li></ol><h4 id="修改文件"><a href="#修改文件" class="headerlink" title="修改文件"></a>修改文件</h4><ol><li><code>src/hook.ts</code> 初始化</li><li><code>addon/content/perferences.xhtml</code> 配置栏</li><li><code>addon/perfs.js</code> 定义API地址 </li><li><code>addon/locale</code> 模板，自动生成文本输出</li></ol><p><code>附录</code><br><a href="https://www.zotero.org/support/beta_builds">开发版zotero下载地址</a><br><a href="https://zotero-chinese.com/plugin-dev-guide/quick-start/">开发指南</a><br><a href="https://github.com/windingwind/zotero-plugin-template">社区框架</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>插件-vscode AI编程</title>
    <link href="/2025/02/28/%E6%8F%92%E4%BB%B6-vscode%20AI%E7%BC%96%E7%A8%8B/"/>
    <url>/2025/02/28/%E6%8F%92%E4%BB%B6-vscode%20AI%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<blockquote><p>需求越来越逆天了，老板说：“为了丰富我们的产品形态，你去写一个vscode 插件” </p></blockquote><span id="more"></span><h3 id="产品调研"><a href="#产品调研" class="headerlink" title="产品调研"></a>产品调研</h3><p>我在很早之前就使用了 Fitten Code，良心产品，没收费，个人感觉在代码补全、函数自动生成上还是非常好用的。<br>老板说 Mars Code 也不错，豆包的插件，昨天试了一下，也不错。但是对整个文件进行分析，还是有点担心安全问题。<br>但是好像不能同时触发两个 AI 代码生成工具，会有冲突。这样老板的需求也就合理了，用自家的 API 调用接口分析、生成代码，防止被别人盗库。<br>想先找一个开源项目看下，问了一下大模型，有以下建议：</p><ol><li>Cline<br>Cline 是一款开源的 VSCode AI 编程助手，支持多种 AI 模型（如 DeepSeek、OpenAI、Google Gemini 等），能够实现代码生成、终端命令执行、Web 开发辅助等功能。它通过上下文管理和无头浏览器技术，帮助开发者快速生成代码、调试项目，并且所有操作需要用户二次确认，确保安全。Cline 的 GitHub 地址为：<a href="https://github.com/cline/cline%E3%80%82">https://github.com/cline/cline。</a></li><li>Roo Code<br>Roo Code 是基于 Cline 进行二次开发的开源 AI 编程助手，功能更为强大和灵活。它支持多种 AI 模型（如 DeepSeek-V3、Google Gemini 等），并兼容自定义 API 和本地部署模型（如 Ollama）。Roo Code 通过优化 MCP（Model Context Protocol）进一步节省 token。GitHub 地址：<a href="https://github.com/RooVetGit/Roo-Cline%E3%80%82">https://github.com/RooVetGit/Roo-Cline。</a></li><li>Continue<br>Continue 是一款开源的 AI 编程助手插件，支持多种大语言模型（如 OpenAI、DeepSeek 等），能够实现代码补全、生成、优化和错误修复等功能。它提供了一个聊天界面，开发者可以通过自然语言与 AI 交互，帮助理解代码逻辑、解决问题。Continue 的 GitHub 地址为：<a href="https://github.com/continuedev/continue%E3%80%82">https://github.com/continuedev/continue。</a></li></ol><h3 id="如何做插件"><a href="#如何做插件" class="headerlink" title="如何做插件"></a>如何做插件</h3><ol><li>登录<a href="https://account.microsoft.com/">Microsoft</a>账号</li><li>创建<a href="https://aex.dev.azure.com/">Azure DevOps</a>，发布插件的必要</li><li>在 Azure DevOps 中，点击右上角的 User settings，然后点击 Personal access tokens。创建一个新的Personal Access Token，确保选择Full access，以避免后续发布插件时出现权限错误。</li><li>按照附录的官方插件指南，可以创建一个新项目，在 VSC 软件中打开项目，F5跳出调试窗口，Ctrl+Command+P打开命令面板，输入Hello World，会在右下角显示。<br><img src="/../img/vsc-1.jpg" alt="hello world"></li></ol><h3 id="文件目录结构"><a href="#文件目录结构" class="headerlink" title="文件目录结构"></a>文件目录结构</h3><p>|– vsc-demo<br>    |– .vscode<br>    |– src<br>        |– extension.ts &#x2F;&#x2F; 项目启动文件<br>    |– node_modules<br>    |– out<br>    |– transition.scss<br>    |– package.json<br>    |– tsconfig.json<br>    |– eslint.config.mjs</p><h3 id="插件打包"><a href="#插件打包" class="headerlink" title="插件打包"></a>插件打包</h3><p>因为是基于应用市场开源插件改的，我们不打算发布，仅作为部门内部使用。<br>先修改<code>package.json</code>中的一些信息，修改图标，如果不修改，会默认之前的，fake…<br>打包需要安装和运行vsce</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install -g @vscode/vsce<br>vsce package<br></code></pre></div></td></tr></table></figure><h3 id="插件使用"><a href="#插件使用" class="headerlink" title="插件使用"></a>插件使用</h3><p>将生成的 .vsix 文件安装到 VSCode 中：</p><ol><li>按 Ctrl+Shift+P（或 Cmd+Shift+P）打开命令面板。</li><li>输入 Extensions: Install from VSIX… 并选择该命令。</li><li>选择打包生成的 .vsix 文件。<br>就可以看到侧栏多了一个图标，点击之后就能使用了。</li></ol><p><code>附录</code><br><a href="https://code.visualstudio.com/api/get-started/your-first-extension">官方插件指南</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（42-2）deepseek-模型输出总结</title>
    <link href="/2025/02/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8842-2%EF%BC%89deepseek-%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%87%BA%E6%80%BB%E7%BB%93/"/>
    <url>/2025/02/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8842-2%EF%BC%89deepseek-%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%87%BA%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<blockquote><p>大模型输出流式数据，前后端约定 SSE 形式通信。<br>【3.3 更新】新需求，增加文件输入。<br>【3.10 更新】新需求，大模型的回答要支持语音播放。</p></blockquote><span id="more"></span><h3 id="流式数据处理"><a href="#流式数据处理" class="headerlink" title="流式数据处理"></a>流式数据处理</h3><p>和后端沟通后使用 SSE 模式。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">interface <span class="hljs-title class_">ChatProps</span> &#123;<br>  <span class="hljs-attr">role</span>: string<br>  message?: string <span class="hljs-comment">// 原始信息</span><br>  message1?: string<br>  message2?: string<br>  loading?: boolean<br>  preview?: any<br>  thinkText?: string<br>  showThink?: boolean<br>  searchResult?: any[]<br>&#125;<br><br><span class="hljs-keyword">const</span> userInput = <span class="hljs-title function_">ref</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-comment">// 发送用户消息</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChat</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">text: string, fileIds?: <span class="hljs-built_in">Array</span>&lt;any&gt;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> params = &#123;<br>    <span class="hljs-attr">user_id</span>: userStore.<span class="hljs-property">userInfo</span>?.<span class="hljs-property">project_id</span>,<br>    <span class="hljs-attr">conversation_id</span>: currentId.<span class="hljs-property">value</span>,<br>    <span class="hljs-attr">message</span>: text,<br>    <span class="hljs-attr">model_id</span>: props.<span class="hljs-property">modelDetail</span>.<span class="hljs-property">model_id</span>,<br>    <span class="hljs-attr">send_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>(),<br>    <span class="hljs-attr">is_deep_think</span>: chooseThink.<span class="hljs-property">value</span>,<br>    <span class="hljs-attr">is_internet_search</span>: chooseOnline.<span class="hljs-property">value</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> assistantInput = &#123;<br>    <span class="hljs-attr">role</span>: <span class="hljs-string">&#x27;assistant&#x27;</span>,<br>    <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">message1</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">message2</span>: <span class="hljs-string">&#x27;&#x27;</span><br>  &#125;<br>  chatList.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(assistantInput)<br>  <span class="hljs-title function_">scrollToBottom</span>()<br>  botChating.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/chatApi/v1/****&#x27;</span>, &#123;<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>    <span class="hljs-attr">headers</span>: &#123;<br>      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params)<br>  &#125;)<br>  chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span><br>  <span class="hljs-title function_">waitReceive</span>(res)<br>&#125;<br><br><span class="hljs-comment">// 返回流式数据处理</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">waitReceive</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">response</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> prefix = <span class="hljs-string">&#x27;data:&#x27;</span> <span class="hljs-comment">// 前缀</span><br>  <span class="hljs-keyword">const</span> suffix = <span class="hljs-string">&#x27;\n\n&#x27;</span> <span class="hljs-comment">// 后缀</span><br>  <span class="hljs-keyword">const</span> stream = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">pipeThrough</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoderStream</span>())<br>  <span class="hljs-keyword">const</span> reader = stream.<span class="hljs-title function_">getReader</span>()<br>  <span class="hljs-keyword">let</span> done<br>  <span class="hljs-keyword">let</span> linestext = <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-comment">// const MAX_TIME = 60 * 1000 // 最大等待时间-6秒</span><br>  <span class="hljs-comment">// const startTime = Date.now()</span><br>  <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-comment">// 检查是否被中止</span><br>    <span class="hljs-keyword">if</span> (abortController.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;数据读取被用户手动中断&#x27;</span>)<br>      <span class="hljs-keyword">break</span><br>    &#125;<br>    <span class="hljs-comment">// if (Date.now() - startTime &gt; MAX_TIME) &#123;</span><br>    <span class="hljs-comment">//   console.log(&#x27;数据读取超时&#x27;)</span><br>    <span class="hljs-comment">//   break</span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>()<br>    done = result.<span class="hljs-property">done</span><br>    <span class="hljs-keyword">const</span> chunk = result.<span class="hljs-property">value</span><br>    <span class="hljs-keyword">if</span> (chunk) &#123;<br>      linestext += chunk<br>      <span class="hljs-keyword">if</span> (chunk.<span class="hljs-title function_">endsWith</span>(suffix)) &#123;<br>        <span class="hljs-keyword">const</span> lines = linestext.<span class="hljs-title function_">split</span>(suffix)<br>        linestext = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) &#123;<br>          <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(prefix)) &#123;<br>            <span class="hljs-keyword">const</span> event = line.<span class="hljs-title function_">slice</span>(prefix.<span class="hljs-property">length</span>)<br>            <span class="hljs-keyword">try</span> &#123;<br>              <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event)<br>              <span class="hljs-comment">// 联网搜索结果</span><br>              <span class="hljs-keyword">if</span> (data.<span class="hljs-property">search_results</span>) &#123;<br>                chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">searchResult</span> = data.<span class="hljs-property">search_results</span><br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 深度思考-thinkText展示</span><br>                <span class="hljs-keyword">if</span> (data.<span class="hljs-property">is_deep_think</span>) &#123;<br>                  chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">message1</span> += data.<span class="hljs-property">message</span> || <span class="hljs-string">&#x27;&#x27;</span><br>                  chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">thinkText</span> = <span class="hljs-title function_">toHtml</span>(<br>                    chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">message1</span><br>                  )<br>                  chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">showThink</span> = <span class="hljs-literal">true</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                  <span class="hljs-comment">// 回答-preview展示</span><br>                  chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">message2</span> += data.<span class="hljs-property">message</span> || <span class="hljs-string">&#x27;&#x27;</span><br>                  chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">preview</span> = <span class="hljs-title function_">toHtml</span>(<br>                    chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">message2</span><br>                  )<br>                &#125;<br>              &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>              <span class="hljs-keyword">if</span> (abortController.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;数据解析被用户手动中断&#x27;</span>)<br>                <span class="hljs-comment">// 如果是因为手动中止导致的错误，这里可以不做额外处理</span><br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event)<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error)<br>                <span class="hljs-keyword">break</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;no chunk&#x27;</span>)<br>    &#125;<br>  &#125; <span class="hljs-keyword">while</span> (!done)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;数据读取完毕&#x27;</span>)<br>  <span class="hljs-comment">// 释放读取器</span><br>  reader.<span class="hljs-title function_">releaseLock</span>()<br>  botChating.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// 用户手动终止-原始loading去除</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">abortDataReading</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;abortDataReading&#x27;</span>)<br>  abortController.<span class="hljs-title function_">abort</span>()<br>  botChating.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>  chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="文件输入"><a href="#文件输入" class="headerlink" title="文件输入"></a>文件输入</h3><p>deepseek逻辑：<br>选择文件后通过 formdata 上传，返回 id 和状态；<br>状态为 SUCCESS 则不再请求；<br>状态为 PENDING 则通过 file_ids（可有多个）不断 fetch_files 获取当前状态（返回各个文件对应状态），直到状态为 SUCCESS&#x2F;FAILED。上传中、解析中、上传成功都可以删除（白色删除按钮），上传失败必须删除（红色删除按钮）。<br>若点击发送，则带上 file_id 和用户说的话（可以为空）</p><p>上传组件负责选择文件，作为组件注入到输入框中。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span> <span class="hljs-attr">popper-class</span>=<span class="hljs-string">&quot;tooltip-width&quot;</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">&quot;top&quot;</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">&quot;dark&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">content</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">&quot;uploadTip&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-upload</span></span><br><span class="hljs-tag">      <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;uploadFileRef&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-model:file-list</span>=<span class="hljs-string">&quot;fileList&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">multiple</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:limit</span>=<span class="hljs-string">&quot;maxNum&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:on-exceed</span>=<span class="hljs-string">&quot;handleExceed&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:accept</span>=<span class="hljs-string">&quot;acceptList&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:auto-upload</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:on-change</span>=<span class="hljs-string">&quot;handleFileChange&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">CustomIcon</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;icon-upload&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;24&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-upload</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 在输入框里的上传组件，fileList是上传文件列表，clearUploadFiles是清空上传文件列表的方法</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">UploadFilled</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@element-plus/icons-vue&#x27;</span><br><span class="hljs-keyword">import</span> &#123; acceptList, suffixList, getFileType &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/file&#x27;</span><br><br><span class="hljs-keyword">const</span> maxNum = <span class="hljs-number">5</span> <span class="hljs-comment">// 最大上传文件数量</span><br><span class="hljs-keyword">const</span> uploadTip =<br>  <span class="hljs-string">&#x27;1. 请上传 100MB 以下文件，最多支持上传 &#x27;</span> +<br>  maxNum +<br>  <span class="hljs-string">&#x27; 个文件。&lt;/br&gt; 2. 支持文件格式：pdf, txt, csv, docx, doc, jpg, jpeg, png, xlsx, xls, ppt, pptx, epub, py, java, js, ts, md, json, sh等。&lt;/br&gt; 3. 仅在非联网搜索状态下使用。&lt;/br&gt; 4. 仅可识别文字。&#x27;</span><br><span class="hljs-keyword">const</span> fileList = <span class="hljs-title function_">ref</span>([])<br><span class="hljs-keyword">const</span> uploadFileRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)<br><span class="hljs-keyword">const</span> myEmit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">&#x27;handleFileShow&#x27;</span>])<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExceed</span> = (<span class="hljs-params">files, fileList</span>) =&gt; &#123;<br>  <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">`单次最多只能上传 <span class="hljs-subst">$&#123;maxNum&#125;</span> 个文件`</span>)<br>&#125;<br><br><span class="hljs-comment">// 文件改变时触发-判断文件大小、数量超出限制上传按钮隐藏</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileChange</span> = (<span class="hljs-params">file, fileList</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> fileType = <span class="hljs-title function_">getFileType</span>(file.<span class="hljs-property">name</span>)<br>  <span class="hljs-keyword">if</span> (suffixList.<span class="hljs-title function_">indexOf</span>(fileType) &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;文件格式不符合要求&#x27;</span>)<br>    <span class="hljs-keyword">const</span> currIdx = fileList.<span class="hljs-title function_">indexOf</span>(file)<br>    fileList.<span class="hljs-title function_">splice</span>(currIdx, <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> isLt100M = file.<span class="hljs-property">size</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> &lt;= <span class="hljs-number">100</span><br>  <span class="hljs-keyword">if</span> (!isLt100M) &#123;<br>    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;文件大小不能超过100M&#x27;</span>)<br>    <span class="hljs-keyword">const</span> currIdx = fileList.<span class="hljs-title function_">indexOf</span>(file)<br>    fileList.<span class="hljs-title function_">splice</span>(currIdx, <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-title function_">myEmit</span>(<span class="hljs-string">&#x27;handleFileShow&#x27;</span>, fileList, file)<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">clearUploadFiles</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  uploadFileRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">clearFiles</span>()<br>&#125;<br><br><span class="hljs-comment">// 已选择文件删除</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">removeFileOrigin</span> = (<span class="hljs-params">index: number</span>) =&gt; &#123;<br>  fileList.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;removeOrigin   &#x27;</span>, fileList.<span class="hljs-property">value</span>)<br>&#125;<br><br><span class="hljs-title function_">defineExpose</span>(&#123; fileList, clearUploadFiles, removeFileOrigin &#125;)<br></code></pre></div></td></tr></table></figure><p>在输入框下方处理文件上传的状态刷新</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;fileListShow &amp;&amp; fileListShow.length &gt; 0&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;file-list&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(file, index) in fileListShow&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;file-item&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;close-icon&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleRemoveFile(index)&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">CustomIcon</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;file?.analyseStatus === &#x27;FAILED&#x27;&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;icon-del&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;18&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">CustomIcon</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;icon-del2&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;18&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;file-item-icon&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span><br><span class="hljs-tag">        <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;file?.analyseStatus === &#x27;PENDING&#x27; || file?.analyseStatus === &#x27;PARSING&#x27;&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;loader&quot;</span></span><br><span class="hljs-tag">      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">fileIcon</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">&quot;file?.fileName&quot;</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">&quot;40&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;file-item-info&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;file-item-name&quot;</span>&gt;</span>&#123;&#123; file?.fileName &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;file-item-size&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!file?.analyseStatus?.includes(&#x27;FAILED&#x27;)&quot;</span>&gt;</span>&#123;&#123;<br>          formatSize1000(file?.fileSize)<br>        &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">&quot;file?.analyseStatus == &#x27;FAILED&#x27;&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-red-500&quot;</span></span><br><span class="hljs-tag">          &gt;</span>解析失败，请删除&lt;/span<br>        &gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-red-500&quot;</span>&gt;</span>上传失败，请删除<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 定义文件状态类型</span><br>type <span class="hljs-title class_">FileStatus</span> = <span class="hljs-string">&#x27;PENDING&#x27;</span> | <span class="hljs-string">&#x27;PARSING&#x27;</span> | <span class="hljs-string">&#x27;SUCCESS&#x27;</span> | <span class="hljs-string">&#x27;FAILED&#x27;</span> | <span class="hljs-string">&#x27;CONTENT_EMPTY&#x27;</span> | <span class="hljs-string">&#x27;UPLOAD_FAILED&#x27;</span><br><br><span class="hljs-comment">// 轮询定时器</span><br><span class="hljs-keyword">const</span> pollTimer = ref&lt;number | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)<br><span class="hljs-comment">// 轮询文件状态的函数</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">startPolling</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">poll</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> pendingFiles = fileListShow.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<br>      <span class="hljs-function">(<span class="hljs-params">fileItem</span>) =&gt;</span> fileItem.<span class="hljs-property">analyseStatus</span> === <span class="hljs-string">&#x27;PENDING&#x27;</span> || fileItem.<span class="hljs-property">analyseStatus</span> === <span class="hljs-string">&#x27;PARSING&#x27;</span><br>    )<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;pendingFiles&#x27;</span>, pendingFiles)<br>    <span class="hljs-keyword">if</span> (pendingFiles.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// 没有待处理的文件，停止轮询</span><br>      <span class="hljs-built_in">clearTimeout</span>(pollTimer.<span class="hljs-property">value</span>)<br>      pollTimer.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;所有文件状态不为PENDING/PARSING，轮询结束&#x27;</span>)<br>      <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">const</span> fileIds = pendingFiles<br>      .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">fileItem</span>) =&gt;</span> fileItem?.<span class="hljs-property">fileId</span> !== <span class="hljs-string">&#x27;&#x27;</span>)<br>      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">fileItem</span>) =&gt;</span> fileItem?.<span class="hljs-property">fileId</span>)<br>    <span class="hljs-keyword">if</span> (fileIds.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getFileStatus</span>(&#123; <span class="hljs-attr">file_ids</span>: fileIds &#125;)<br>      <span class="hljs-comment">// 后端返回文件状态，前端更新显示</span><br>      <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">files</span> &amp;&amp; res?.<span class="hljs-property">files</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-title function_">updateStatus</span>(fileListShow.<span class="hljs-property">value</span>, res?.<span class="hljs-property">files</span>)<br>        fileListShow.<span class="hljs-property">value</span> = [...fileListShow.<span class="hljs-property">value</span>] <span class="hljs-comment">// 为了确保响应式更新，创建一个新数组</span><br>        pollTimer.<span class="hljs-property">value</span> = <span class="hljs-built_in">setTimeout</span>(poll, <span class="hljs-number">2000</span>)<br>      &#125;<br>    &#125;<br>  &#125;<br>  pollTimer.<span class="hljs-property">value</span> = <span class="hljs-built_in">setTimeout</span>(poll, <span class="hljs-number">2000</span>)<br>&#125;<br><br><span class="hljs-comment">// 状态更新 map</span><br><span class="hljs-keyword">const</span> updateStatus = (<span class="hljs-attr">arrA</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">FileInfo</span>&gt;, <span class="hljs-attr">arrB</span>: <span class="hljs-title class_">Array</span>&lt;any&gt;): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">FileInfo</span>&gt; =&gt; &#123;<br>  <span class="hljs-keyword">const</span> statusMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;string, string&gt;()<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arrB) &#123;<br>    statusMap.<span class="hljs-title function_">set</span>(item.<span class="hljs-property">file_id</span>, item.<span class="hljs-property">status</span>)<br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arrA) &#123;<br>    <span class="hljs-keyword">if</span> (statusMap.<span class="hljs-title function_">has</span>(item?.<span class="hljs-property">fileId</span>)) &#123;<br>      item.<span class="hljs-property">analyseStatus</span> = statusMap.<span class="hljs-title function_">get</span>(item?.<span class="hljs-property">fileId</span>)!<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> arrA<br>&#125;<br><br><span class="hljs-comment">// 选择文件后，出现在对话框下面</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileShow</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">fileList: File[], file: File</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> uid = file?.<span class="hljs-property">uid</span><br>  fileListShow.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(&#123;<br>    <span class="hljs-attr">uid</span>: uid,<br>    <span class="hljs-attr">fileName</span>: file?.<span class="hljs-property">name</span>,<br>    <span class="hljs-attr">fileId</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">fileSize</span>: file?.<span class="hljs-property">size</span>,<br>    <span class="hljs-attr">analyseStatus</span>: <span class="hljs-string">&#x27;PENDING&#x27;</span><br>  &#125; <span class="hljs-keyword">as</span> <span class="hljs-title class_">FileInfo</span>)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;handleFileShow&#x27;</span>, fileList, fileListShow.<span class="hljs-property">value</span>)<br>  analyseFile.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 开始分析文件</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()<br>    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;file&#x27;</span>, file?.<span class="hljs-property">raw</span>)<br>    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;file_name&#x27;</span>, file?.<span class="hljs-property">name</span>)<br>    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;conversation_id&#x27;</span>, currentId.<span class="hljs-property">value</span>)<br>    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadFile</span>(formData)<br>    fileListShow.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fileItem</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (fileItem.<span class="hljs-property">uid</span> === uid) &#123;<br>        fileItem.<span class="hljs-property">fileId</span> = res?.<span class="hljs-property">file_id</span><br>      &#125;<br>    &#125;)<br><br>    <span class="hljs-comment">// 开始轮询</span><br>    <span class="hljs-keyword">if</span> (!pollTimer.<span class="hljs-property">value</span>) &#123;<br>      <span class="hljs-title function_">startPolling</span>()<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;文件上传过程中出错&#x27;</span>, error)<br>    fileListShow.<span class="hljs-property">value</span> = fileListShow.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">uid</span> === uid) &#123;<br>        <span class="hljs-keyword">return</span> &#123; ...item, <span class="hljs-attr">analyseStatus</span>: <span class="hljs-string">&#x27;UPLOAD_FAILED&#x27;</span> &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> item<br>    &#125;)<br>  &#125;<br>&#125;<br><span class="hljs-comment">// 删除文件，仅在解析失败时展示</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRemoveFile</span> = (<span class="hljs-params">id: number</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;handleRemoveFile&#x27;</span>, id)<br>  fileListShow.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(id, <span class="hljs-number">1</span>)<br>  uploadRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeFileOrigin</span>(id)<br>  fileListShow.<span class="hljs-property">value</span> = [...fileListShow.<span class="hljs-property">value</span>]<br>&#125;<br></code></pre></div></td></tr></table></figure><p>还需要对文件列表状态进行监听，只有所有文件解析完成才可以发送消息</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">watch</span>(<br>  <span class="hljs-function">() =&gt;</span> fileListShow.<span class="hljs-property">value</span>,<br>  <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> ok = fileListShow.<span class="hljs-property">value</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">file: any</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> file.<span class="hljs-property">analyseStatus</span> === <span class="hljs-string">&#x27;SUCCESS&#x27;</span><br>    &#125;)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;watch&#x27;</span>, val, ok)<br>    <span class="hljs-keyword">if</span> (ok) &#123;<br>      analyseFile.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 解析完成，可以发送消息</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      analyseFile.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 解析中，不能发送消息</span><br>    &#125;<br>  &#125;,<br>  &#123; <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> &#125;<br>)<br></code></pre></div></td></tr></table></figure><h3 id="语音播放"><a href="#语音播放" class="headerlink" title="语音播放"></a>语音播放</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;togglePlay&quot;</span>&gt;</span>&#123;&#123; isPlaying ? &#x27;暂停&#x27; : &#x27;播放&#x27; &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">audio</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;audioRef&quot;</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: none;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 播放状态</span><br><span class="hljs-keyword">const</span> isPlaying = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-keyword">const</span> audioRef = ref&lt;<span class="hljs-title class_">HTMLAudioElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)<br><br><span class="hljs-comment">// 切换播放状态</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">togglePlay</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (isPlaying.<span class="hljs-property">value</span>) &#123;  <span class="hljs-comment">// 暂停播放</span><br>    <span class="hljs-keyword">if</span> (audioRef.<span class="hljs-property">value</span>) &#123;<br>      audioRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">pause</span>()<br>    &#125;<br>    isPlaying.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>  &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 开始/继续播放</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://****&#x27;</span>, &#123;<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-attr">headers</span>: &#123;<br>          <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,<br>          <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;Bearer YOUR_API_KEY&#x27;</span> <span class="hljs-comment">// 替换为真实的 API 密钥</span><br>        &#125;,<br>        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;&#125;)<br>      &#125;)<br>      <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;语音合成请求失败&#x27;</span>)<br>      &#125;<br>      <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>?.<span class="hljs-title function_">getReader</span>()<br>      <span class="hljs-keyword">if</span> (!reader) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;无法获取响应流&#x27;</span>)<br>      &#125;<br>      <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadableStream</span>(&#123;<br>        <span class="hljs-title function_">start</span>(<span class="hljs-params">controller</span>) &#123;<br>          <span class="hljs-keyword">function</span> <span class="hljs-title function_">push</span>(<span class="hljs-params"></span>) &#123;<br>            reader.<span class="hljs-title function_">read</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">&#123; done, value &#125;</span>) =&gt;</span> &#123;<br>              <span class="hljs-keyword">if</span> (done) &#123;<br>                controller.<span class="hljs-title function_">close</span>()<br>                <span class="hljs-keyword">return</span>;<br>              &#125;<br>              controller.<span class="hljs-title function_">enqueue</span>(value)<br>              <span class="hljs-title function_">push</span>()<br>            &#125;)<br>          &#125;<br>          <span class="hljs-title function_">push</span>()<br>        &#125;<br>      &#125;)<br>      <span class="hljs-keyword">const</span> audioStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(stream)<br>      <span class="hljs-keyword">const</span> audioBlob = <span class="hljs-keyword">await</span> audioStream.<span class="hljs-title function_">blob</span>();<br>      <span class="hljs-keyword">if</span> (audioRef.<span class="hljs-property">value</span>) &#123;<br>        audioRef.<span class="hljs-property">value</span>.<span class="hljs-property">src</span> = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(audioBlob)<br>        audioRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">play</span>()<br>      &#125;<br>      isPlaying.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;语音合成出错：&#x27;</span> + (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">message</span>)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error:&#x27;</span>, error)<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（42-3）deepseek-已发送消息处理</title>
    <link href="/2025/02/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8842-3%EF%BC%89deepseek-%E5%B7%B2%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86/"/>
    <url>/2025/02/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8842-3%EF%BC%89deepseek-%E5%B7%B2%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>用户可能发送了错误信息，需要对发送的信息做一个修改，这里我们可以用编辑模式来实现。 </p></blockquote><span id="more"></span><h3 id="用户信息修改"><a href="#用户信息修改" class="headerlink" title="用户信息修改"></a>用户信息修改</h3><p>用户信息修改的方式分了好几种，有些网站是直接撤回原来的回答，用新的代替有些网站是直接编辑原来的回答，保留修改的版本，通过左右切换的方式可以查看各个版本的问答情况，我们选了后面一种实现方式。<br>在研究 deepseek 网站的前端时，发现问答是以树状的方式进行的，每次修改问题相当于在当前节点新建一个分支，往后所有的回答都是以此分支的子节点。因此切换分支时，需要加载基于此分支的所有子节点。</p><p>编辑模式如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 用户信息编辑模式 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.isEditing&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;w-[calc(100%-88px)] mr-10px&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;modifiedMessage&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;textarea&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">resize</span>=<span class="hljs-string">&quot;none&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">compositionstart</span>=<span class="hljs-string">&quot;onCompositionStart&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">compositionend</span>=<span class="hljs-string">&quot;onCompositionEnd&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">keydown.enter</span>=<span class="hljs-string">&quot;handleEnter($event, index, &#x27;update&#x27;)&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">keyup.esc</span>=<span class="hljs-string">&quot;cancelEdit(index)&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flex justify-end items-center&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;cancelEdit(index)&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ml-12px&quot;</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;saveEdit($event, index)&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ml-12px&quot;</span></span><br><span class="hljs-tag">      &gt;</span>发送&lt;/Button<br>    &gt;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>用户对话中，鼠标经过展示编辑按钮，大模型正在输出，或者文件正在解析时不可编辑，如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 用户信息展示 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;w-full&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span><br><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flex justify-end w-full&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.message&quot;</span></span><br><span class="hljs-tag">      @<span class="hljs-attr">mouseenter</span>=<span class="hljs-string">&quot;item.showTools = true&quot;</span></span><br><span class="hljs-tag">      @<span class="hljs-attr">mouseleave</span>=<span class="hljs-string">&quot;item.showTools = false&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flex items-center mr-8px&quot;</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.showTools&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">CustomIcon</span></span><br><span class="hljs-tag">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;icon-edit&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;16&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;startEdit(index)&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">:class</span>=<span class="hljs-string">&quot;botChating || analyseFile ? &#x27;btn-disabled&#x27; : &#x27;cursor-pointer&#x27;&quot;</span></span><br><span class="hljs-tag">        /&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span><br><span class="hljs-tag">        <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.message&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;break-words whitespace-pre-wrap&quot;</span></span><br><span class="hljs-tag">        &gt;</span>&#123;&#123; item.message &#125;&#125;&lt;/div<br>      &gt;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.count &amp;&amp; item.count &gt; 1&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flex justify-end&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span></span><br><span class="hljs-tag">        @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleVersion(&#x27;prev&#x27;, item, index)&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:class</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">          item.version === 1 || botChating ? &#x27;btn-disabled&#x27; : &#x27;cursor-pointer&#x27;</span></span><br><span class="hljs-string"><span class="hljs-tag">        &quot;</span></span><br><span class="hljs-tag">        &gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">ArrowLeft</span></span><br><span class="hljs-tag">      /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;&#123; item.version &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;pl-[4px] pr-[4px]&quot;</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;&#123; item.count &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span></span><br><span class="hljs-tag">        @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleVersion(&#x27;next&#x27;, item, index)&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:class</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">          item.version === item.count || botChating</span></span><br><span class="hljs-string"><span class="hljs-tag">            ? &#x27;btn-disabled&#x27;</span></span><br><span class="hljs-string"><span class="hljs-tag">            : &#x27;cursor-pointer&#x27;</span></span><br><span class="hljs-string"><span class="hljs-tag">        &quot;</span></span><br><span class="hljs-tag">        &gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">ArrowRight</span></span><br><span class="hljs-tag">      /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>点击切换按钮时，记录鼠标当前位置，通过 messageId 和 newVersion 请求当前分支的消息，更新数据，并滑动到原来的位置。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleVersion</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">mode: string, item: ChatProps, index: number</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> newVersion = mode === <span class="hljs-string">&#x27;prev&#x27;</span> ? item.<span class="hljs-property">version</span> - <span class="hljs-number">1</span> : item.<span class="hljs-property">version</span> + <span class="hljs-number">1</span><br>  <span class="hljs-keyword">if</span> (scrollbarRef.<span class="hljs-property">value</span>) &#123;<br>    <span class="hljs-keyword">const</span> scrollTop = scrollbarRef.<span class="hljs-property">value</span>.<span class="hljs-property">$el</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.el-scrollbar__wrap&#x27;</span>)?.<span class="hljs-property">scrollTop</span><br>    cacheScrollTop.<span class="hljs-property">value</span> = scrollTop<br>  &#125;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; messages &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">handoffMessage</span>(&#123;<br>      <span class="hljs-attr">message_id</span>: item.<span class="hljs-property">messageId</span>,<br>      <span class="hljs-attr">version</span>: newVersion<br>    &#125;)<br>    chatList.<span class="hljs-property">value</span> = []<br>    <span class="hljs-keyword">if</span> (messages &amp;&amp; messages.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>      chatList.<span class="hljs-property">value</span> = messages.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> (&#123;<br>        <span class="hljs-attr">role</span>: item.<span class="hljs-property">role</span>,<br>        <span class="hljs-attr">message</span>: item.<span class="hljs-property">message</span> ? item.<span class="hljs-property">message</span> : <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-attr">messageId</span>: item.<span class="hljs-property">message_id</span>,<br>        <span class="hljs-attr">fatherId</span>: item.<span class="hljs-property">father_id</span>,<br>        <span class="hljs-attr">version</span>: item.<span class="hljs-property">version</span>,<br>        <span class="hljs-attr">count</span>: item.<span class="hljs-property">count</span><br>      &#125;))<br>      sendId.<span class="hljs-property">value</span> = chatList.<span class="hljs-property">value</span>[chatList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">messageId</span><br>      <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-comment">// 更新数据后滑动到原来的位置</span><br>        scrollbarRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">setScrollTop</span>(cacheScrollTop.<span class="hljs-property">value</span>)<br>      &#125;)<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;切换版本失败&#x27;</span>, error)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>javascript</code><br><code>javascript</code><br><code>javascript</code></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（42-1）deepseek-用户输入总结</title>
    <link href="/2025/02/18/vue3%E7%AC%94%E8%AE%B0%EF%BC%8842-1%EF%BC%89deepseek-%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E6%80%BB%E7%BB%93/"/>
    <url>/2025/02/18/vue3%E7%AC%94%E8%AE%B0%EF%BC%8842-1%EF%BC%89deepseek-%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<blockquote><p>收到了用户反馈，需要加上键盘快捷键，不能点 enter 就发送。<br>和大模型通信的后续版本，有语音输入的需求，问了下某代码生成很厉害的模型，这里做一个记录。</p></blockquote><span id="more"></span><h3 id="键盘快捷键"><a href="#键盘快捷键" class="headerlink" title="键盘快捷键"></a>键盘快捷键</h3><p>原来使用<code>@keyup.enter=&quot;handleSubmit&quot;</code>，这样用户只要输入 enter 就发送请求，很有可能只输入了半句话，或者需要换行，导致用户体验不好。</p><p>新增了一个函数<code>handleMultiLineNewline</code>作为换行处理。测试了<code>@keydown.meta.enter</code>，可以在 mac 系统下使用 cmd + enter&#x2F;windows 系统下使用 win + enter 触发换行。<code>@keydown.ctrl.enter</code>和<code>@keydown.shift.enter</code>可以触发换行。<br>但是以上连用不知道为啥消息又自动发出去了。。。<br>索性自己写了一个函数<code>handleEnter</code>来处理换行。</p><p>另一个需求是中文输入法下，未输入完时，使用 enter 键，默认不发送消息，整体如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span></span><br><span class="hljs-tag">  <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userInput&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;userInput&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入您的问题&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">compositionstart</span>=<span class="hljs-string">&quot;onCompositionStart&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">compositionend</span>=<span class="hljs-string">&quot;onCompositionEnd&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">keydown.enter</span>=<span class="hljs-string">&quot;handleEnter&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;textarea&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">rows</span>=<span class="hljs-string">&quot;5&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">maxlength</span>=<span class="hljs-string">&quot;2048&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">resize</span>=<span class="hljs-string">&quot;none&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEnter</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">event: KeyboardEvent</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<br>    (event.<span class="hljs-property">shiftKey</span> &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">&#x27;Enter&#x27;</span>) ||<br>    (event.<span class="hljs-property">ctrlKey</span> &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">&#x27;Enter&#x27;</span>) ||<br>    (event.<span class="hljs-property">metaKey</span> &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">&#x27;Enter&#x27;</span>)<br>  ) &#123;<br>    <span class="hljs-keyword">const</span> start = (event.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLTextAreaElement</span>).<span class="hljs-property">selectionStart</span><br>    <span class="hljs-keyword">const</span> end = (event.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLTextAreaElement</span>).<span class="hljs-property">selectionEnd</span><br>    <span class="hljs-keyword">const</span> value = userInput.<span class="hljs-property">value</span><br>    userInput.<span class="hljs-property">value</span> = value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, start) + <span class="hljs-string">&#x27;\n&#x27;</span> + value.<span class="hljs-title function_">slice</span>(end)<br>    ;(event.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLTextAreaElement</span>).<span class="hljs-property">selectionStart</span> = (<br>      event.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLTextAreaElement</span><br>    ).<span class="hljs-property">selectionEnd</span> = start + <span class="hljs-number">1</span><br>    event.<span class="hljs-title function_">preventDefault</span>() <span class="hljs-comment">// 阻止默认行为</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isComposing.<span class="hljs-property">value</span> &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">&#x27;Enter&#x27;</span>) &#123;<br>    <span class="hljs-comment">// 发送消息</span><br>    <span class="hljs-title function_">handleSubmit</span>(event)<br>    event.<span class="hljs-title function_">preventDefault</span>()<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 标记输入法是否处于输入候选状态</span><br><span class="hljs-keyword">const</span> isComposing = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>) <br><span class="hljs-keyword">const</span> <span class="hljs-title function_">onCompositionStart</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  isComposing.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">onCompositionEnd</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  isComposing.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>当用户输入为空时，不做处理；当大模型在输出时，禁止用户再次提交信息。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">event: any</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;handleSubmit&#x27;</span>, event)<br>  <span class="hljs-keyword">if</span> (!userInput.<span class="hljs-property">value</span> || userInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (loadingSend.<span class="hljs-property">value</span> == <span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-comment">// 防止在大模型输出时提交</span><br>    event.<span class="hljs-title function_">preventDefault</span>()<br>    <span class="hljs-keyword">return</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (abortController.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) &#123;<br>      abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()<br>    &#125;<br>    loadingSend.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">let</span> text = userInput.<span class="hljs-property">value</span><br>    <span class="hljs-keyword">if</span> (text.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;\n&#x27;</span>)) &#123;<br>      <span class="hljs-comment">// 去掉末尾的换行符</span><br>      text = text.<span class="hljs-title function_">trimEnd</span>()<br>    &#125;<br>    chatList.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">role</span>: <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-attr">message</span>: text &#125;)<br>    userInput.<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-title function_">scrollToBottom</span>()<br>    <span class="hljs-title function_">handleChat</span>(text)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>结果某用户提了个 bug，说按了 Enter 键，消息还是发出去了，最终排查出来是 Safari 浏览器的问题，需要前端做一个兼容。<br>尝试了推荐的以下事件垫片代码，实测无效。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useEventListener &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@vueuse/core&#x27;</span><br><span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)<br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// 使用useEventListener来添加事件监听器，处理兼容性</span><br>  <span class="hljs-title function_">useEventListener</span>(inputRef.<span class="hljs-property">value</span>, <span class="hljs-string">&#x27;compositionstart&#x27;</span>, onCompositionStart)<br>  <span class="hljs-title function_">useEventListener</span>(inputRef.<span class="hljs-property">value</span>, <span class="hljs-string">&#x27;compositionend&#x27;</span>, onCompositionEnd)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>最后改了好几版，测试下来以下代码可以兼容 Safari 浏览器：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> isComposing = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 标记输入法是否处于输入候选状态</span><br><span class="hljs-keyword">const</span> ignoreEnter = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 标记是否忽略 enter 事件</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">onCompositionStart</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  isComposing.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">onCompositionEnd</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  isComposing.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>  ignoreEnter.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 组合输入结束后，设置忽略 enter 事件</span><br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    ignoreEnter.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 一段时间后恢复对 enter 事件的响应</span><br>  &#125;, <span class="hljs-number">200</span>) <span class="hljs-comment">// 可以根据实际情况调整这个时间</span><br>&#125;<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> inputElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;userInput&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (inputElement) &#123;<br>    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">&#x27;oncompositionstart&#x27;</span> <span class="hljs-keyword">in</span> inputElement)) &#123;<br>      <span class="hljs-comment">// 不支持 compositionstart 事件，进行模拟</span><br>      <span class="hljs-keyword">let</span> isComposing = <span class="hljs-literal">false</span><br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">keydownHandler</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">keyCode</span> === <span class="hljs-number">229</span>) &#123;<br>          <span class="hljs-comment">// 229 是输入法开始输入时的键码</span><br>          isComposing = <span class="hljs-literal">true</span><br>          <span class="hljs-title function_">onCompositionStart</span>()<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">keyupHandler</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>        <span class="hljs-keyword">if</span> (isComposing) &#123;<br>          isComposing = <span class="hljs-literal">false</span><br>          <span class="hljs-title function_">onCompositionEnd</span>()<br>        &#125;<br>      &#125;<br>      inputElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, keydownHandler)<br>      inputElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;keyup&#x27;</span>, keyupHandler)<br><br>      <span class="hljs-comment">// 在组件卸载时移除事件监听器</span><br>      <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        inputElement.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, keydownHandler)<br>        inputElement.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;keyup&#x27;</span>, keyupHandler)<br>      &#125;)<br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="语音输入"><a href="#语音输入" class="headerlink" title="语音输入"></a>语音输入</h3><p>在 vue3 项目中，使用<code>useSpeechRecognition</code>这个库，实现语音输入转文字功能。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">CustomIcon</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!isRecording&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;icon-voice&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;24&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;isRecording = true&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cursor-pointer&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">CustomIcon</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-else</span></span><br><span class="hljs-tag">    <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;icon-voice-active&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;24&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;isRecording = false&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;cursor-pointer&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useSpeechRecognition &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@vueuse/core&#x27;</span><br><br><span class="hljs-comment">// 语音输入</span><br><span class="hljs-keyword">const</span> isRecording = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><span class="hljs-keyword">const</span> &#123; isListening, result, start, stop, isSupported &#125; = <span class="hljs-title function_">useSpeechRecognition</span>(&#123;<br>  <span class="hljs-attr">lang</span>: <span class="hljs-string">&#x27;zh-CN&#x27;</span>,<br>  <span class="hljs-attr">continuous</span>: <span class="hljs-literal">true</span><br>&#125;)<br><span class="hljs-keyword">if</span> (isSupported.<span class="hljs-property">value</span>) &#123;<br>  <span class="hljs-title function_">watch</span>(result, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isRecording.<span class="hljs-property">value</span>) &#123;<br>      userInput.<span class="hljs-property">value</span> = value<br>    &#125;<br>  &#125;)<br>&#125;<br><br><span class="hljs-title function_">watch</span>(isListening, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (!value &amp;&amp; isRecording.<span class="hljs-property">value</span>) &#123;<br>    <span class="hljs-title function_">start</span>()<br>  &#125;<br>&#125;)<br><br><span class="hljs-title function_">watch</span>(isRecording, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (value) &#123;<br>    <span class="hljs-title function_">start</span>()<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_">stop</span>()<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ngixn笔记（3）问题记录</title>
    <link href="/2025/02/15/ngixn%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    <url>/2025/02/15/ngixn%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>记录一下出现的问题及解决方式。修改后记得重启 nginx 服务。<br>注意：如果运行在容器中，修改了 doeker 中 nginx 配置，通过 IP 访问正常，域名配置使用了 root 目录下的 nginx，需要再配置一次。</p></blockquote><span id="more"></span><h3 id="413-Request-Entity-Too-Large"><a href="#413-Request-Entity-Too-Large" class="headerlink" title="413 Request Entity Too Large"></a>413 Request Entity Too Large</h3><p>错误的原因是 Nginx 默认限制了客户端请求体的大小（默认为 1MB），而上传请求超过了这个限制，可以在 http、server、location 任意一个中添加以下字段：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs conf">http &#123;<br>  client_max_body_size 100M;  # 允许的最大请求体大小<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="流式数据输出卡顿"><a href="#流式数据输出卡顿" class="headerlink" title="流式数据输出卡顿"></a>流式数据输出卡顿</h3><p>在 location 中添加一个参数配置</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs conf">http &#123;<br>  location /chatApi/ &#123;<br>      proxy_pass http://***/;<br>      proxy_buffering off;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="Request-failed-with-status-code-504"><a href="#Request-failed-with-status-code-504" class="headerlink" title="Request failed with status code 504"></a>Request failed with status code 504</h3><p>通常是由于 Nginx 作为反向代理时，等待后端服务器响应的时间超过了配置的超时时间。</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs conf">http &#123;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ngixn笔记（2）域名&amp;SSL配置</title>
    <link href="/2025/01/15/ngixn%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89%E5%9F%9F%E5%90%8D-SSL%E9%85%8D%E7%BD%AE%20copy/"/>
    <url>/2025/01/15/ngixn%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89%E5%9F%9F%E5%90%8D-SSL%E9%85%8D%E7%BD%AE%20copy/</url>
    
    <content type="html"><![CDATA[<blockquote><p>记录一下阿里云服务器域名和 SSL 配置的过程。修改后记得重启 nginx 服务。</p></blockquote><span id="more"></span><h3 id="文件修改"><a href="#文件修改" class="headerlink" title="文件修改"></a>文件修改</h3><p>根目录下 <code>nginx.conf</code> 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs conf">user www-data;<br>worker_processes auto;<br>pid /run/nginx.pid;<br>error_log /var/log/nginx/error.log;<br>include /etc/nginx/modules-enabled/*.conf;<br><br>events &#123;<br>worker_connections 768;<br>&#125;<br><br>http &#123;<br>sendfile on;<br>tcp_nopush on;<br>types_hash_max_size 2048;<br><br>include /etc/nginx/mime.types;<br>default_type application/octet-stream;<br><br>##<br># SSL Settings<br>##<br>ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE<br>ssl_prefer_server_ciphers on;<br><br>  ##<br># Logging Settings<br>##<br>access_log /var/log/nginx/access.log;<br><br>  ##<br># Gzip Settings<br>##<br>gzip on;<br>gzip_vary on;<br>gzip_proxied any;<br>gzip_comp_level 6;<br>gzip_buffers 16 8k;<br>  gzip_min_length 1024;<br># gzip_http_version 1.1;<br>gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss image/svg+xml image/jpeg image/gif image/png text/javascript;<br><br>  ##<br># Virtual Host Configs<br>##<br>include /etc/nginx/conf.d/*.conf;<br>include /etc/nginx/sites-enabled/*;<br><br>  server &#123;<br>    listen          80;<br>    server_name     111.com;<br>    #default_type   text/html;<br><br>    location / &#123;<br>      proxy_pass http://116.62.154.188:21011;<br>      proxy_set_header Host $proxy_host;<br>      proxy_set_header X-Real-IP $remote_addr;<br>      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>      proxy_http_version 1.1;<br>      proxy_set_header Upgrade $http_upgrade;<br>      proxy_set_header Connection &quot;upgrade&quot;;<br><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>修改如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs conf">server &#123;<br>    listen 80;<br>    server_name 111.com www.111.com;<br><br>    # 将 HTTP 流量重定向到 HTTPS<br>    return 301 https://$host$request_uri;<br>&#125;<br><br>server &#123;<br>    listen 443 ssl;<br>    server_name swbind.com www.swbind.com;<br><br>    # 配置 SSL 证书和私钥<br>    ssl_certificate /etc/nginx/ssl/swbind.com.crt;  # SSL 证书路径<br>    ssl_certificate_key /etc/nginx/ssl/swbind.com.key;  # SSL 私钥路径<br><br>    # 配置强加密协议和密码套件<br>    ssl_protocols TLSv1.2 TLSv1.3;<br>    ssl_ciphers &#x27;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:...&#x27;;  # 添加更多安全的密码套件<br>    ssl_prefer_server_ciphers on;<br><br>    location / &#123;<br>      proxy_pass http://172.24.33.79:21009;<br>      proxy_set_header Host $proxy_host;<br>      proxy_set_header X-Real-IP $remote_addr;<br>      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>      proxy_http_version 1.1;<br>      proxy_set_header Upgrade $http_upgrade;<br>      proxy_set_header Connection &quot;upgrade&quot;;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AlphaFold3</title>
    <link href="/2024/10/23/AlphaFold3/"/>
    <url>/2024/10/23/AlphaFold3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>接手了 AF3 的项目，涉及到一些蛋白质的技术，需要学习一下。</p></blockquote><span id="more"></span><h3 id="技术基础"><a href="#技术基础" class="headerlink" title="技术基础"></a>技术基础</h3><ol><li><p>AlphaFold 3 已具备药物设计的能力，能够精确预测药物中常见分子（如配体和抗体）的结构。这些分子可以与蛋白质结合，从而调控蛋白质在人体健康与疾病中的相互作用。在预测药物与蛋白质的相互作用（如配体与蛋白质、抗体与靶蛋白的结合）方面，AlphaFold 3 实现了前所未有的准确度。</p></li><li><p>PDB（Protein Data Bank）蛋白质数据库文件是生物大分子结构研究中的核心工具之一。PDB 文件格式广泛用于存储蛋白质、核酸及其相关配体的三维结构信息。研究人员可以通过这些文件，获取详细的原子坐标、化学组成以及生物大分子与配体之间的相互作用信息。<br>还有其他文件格式（如 CIF、SDF、SMILES）同样在生物大分子和小分子化合物的研究中扮演着重要角色。<br>【提示】附录中有 PDB 文件的预览地址，可用于生成、网络传输后的对比。</p></li></ol><h3 id="前端展示-pdb-文件"><a href="#前端展示-pdb-文件" class="headerlink" title="前端展示 pdb 文件"></a>前端展示 pdb 文件</h3><p>使用 rcsb-molstar 这个库。<br>文件存放于 <code>public/rcsb</code> 目录下，通过以下代码引入：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;script&#x27;</span>)<br>script.<span class="hljs-property">src</span> = <span class="hljs-string">&#x27;/rcsb/rcsb-molstar.js&#x27;</span><br>script.<span class="hljs-property">type</span> = <span class="hljs-string">&#x27;text/javascript&#x27;</span><br>script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// 脚本加载完毕后的回调</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;script rcsb-molstar loaded successfully.&#x27;</span>)<br>&#125;<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script)<br></code></pre></div></td></tr></table></figure><p>初始化时创建实例</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-attr">viewer</span>: any<br><span class="hljs-keyword">let</span> <span class="hljs-attr">intervalRcsb</span>: any<br><span class="hljs-keyword">const</span> rcsbLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">initRcsb</span> = (<span class="hljs-params">url?: any</span>) =&gt; &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    viewer = <span class="hljs-keyword">new</span> rcsbMolstar.<span class="hljs-title class_">Viewer</span>(<span class="hljs-string">&#x27;molViewer&#x27;</span>, &#123;<br>      <span class="hljs-attr">showImportControls</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">showSessionControls</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">layoutShowLog</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">layoutShowControls</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">showMembraneOrientationPreset</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">showNakbColorTheme</span>: <span class="hljs-literal">true</span><br>    &#125;)<br>  &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;rcsb plugin is loading...&#x27;</span>, e)<br>  &#125;<br>  <span class="hljs-keyword">if</span> (viewer) &#123;<br>    rcsbLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>    <span class="hljs-built_in">clearInterval</span>(intervalRcsb)<br>    viewer.<span class="hljs-title function_">loadStructureFromUrl</span>(url, <span class="hljs-string">&#x27;pdb&#x27;</span>, <span class="hljs-literal">false</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>点击按钮触发展示。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">showGraph</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">row: any</span>) =&gt; &#123;<br>  <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    intervalRcsb = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">initRcsb</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">APP_CONFIG</span>.<span class="hljs-property">fileApi</span>)<br>    &#125;, <span class="hljs-number">100</span>)<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="前端绘制结构图"><a href="#前端绘制结构图" class="headerlink" title="前端绘制结构图"></a>前端绘制结构图</h3><p>文件存放于 <code>public/standalone</code> 目录下，通过以下代码引入：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;canDraw&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;860px&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">max-height</span>=<span class="hljs-string">&quot;auto&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:fullscreen</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:title</span>=<span class="hljs-string">&quot;t(&#x27;bioinformatics.draw&#x27;)&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">&quot;ketcherLoading&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span></span><br><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;frame&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;idKetcher&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/standalone/index.html&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;800&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;600&quot;</span></span><br><span class="hljs-tag">    &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">BaseButton</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;w-80px mb-20px&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;getSmiles&quot;</span>&gt;</span><br>      &#123;&#123; t(&#x27;bioinformatics.save&#x27;) &#125;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">BaseButton</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Dialog</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>初始化</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> canDraw = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><span class="hljs-keyword">const</span> ketcherLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><span class="hljs-keyword">let</span> <span class="hljs-attr">ketcherObject</span>: any = <span class="hljs-literal">null</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">initKetcher</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">ketcherFrame</span>: any = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;idKetcher&#x27;</span>)<br>  <span class="hljs-keyword">let</span> ketcher = <span class="hljs-literal">null</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;contentDocument&#x27;</span> <span class="hljs-keyword">in</span> ketcherFrame) &#123;<br>    ketcher = ketcherFrame.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">ketcher</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ketcher = <span class="hljs-variable language_">document</span>[<span class="hljs-string">&#x27;frames&#x27;</span>][<span class="hljs-string">&#x27;idKetcher&#x27;</span>].<span class="hljs-property">window</span>.<span class="hljs-property">ketcher</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (ketcher) &#123;<br>    <span class="hljs-built_in">clearInterval</span>(intervalKetcher)<br>    ketcherLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>    ketcherObject = ketcher<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ketcher plugin is loading...&#x27;</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-title function_">watch</span>(canDraw, <span class="hljs-function">(<span class="hljs-params">show: boolean</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (!show) <span class="hljs-built_in">clearInterval</span>(intervalKetcher)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>点击按钮触发绘图功能。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">openDraw</span> = (<span class="hljs-params">index: number</span>) =&gt; &#123;<br>  canDraw.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>  ketcherLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>  <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    intervalKetcher = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">initKetcher</span>()<br>    &#125;, <span class="hljs-number">500</span>)<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="离子展示"><a href="#离子展示" class="headerlink" title="离子展示"></a>离子展示</h3><p>第一次在网页中输出离子，例如：CU2+ 在数据传输中这样表示，但是在网页现实中需要将2+作为上标</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>CU<span class="hljs-tag">&lt;<span class="hljs-name">sup</span>&gt;</span>2+<span class="hljs-tag">&lt;/<span class="hljs-name">sup</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://github.com/molstar/rcsb-molstar/blob/master/src/viewer/index.html">rcsb-molstar官方例子</a><br><a href="https://www.rcsb.org/3d-view">pdb文件生成图预览</a><br><a href="https://www.jianshu.com/p/53927176c618">一文看懂AlphaFold2&amp;3输出结果的json文件内容</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（41-4）AIGC-富文本编辑器-Tinymce</title>
    <link href="/2024/10/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-4%EF%BC%89AIGC-%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8-Tinymce/"/>
    <url>/2024/10/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-4%EF%BC%89AIGC-%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8-Tinymce/</url>
    
    <content type="html"><![CDATA[<blockquote><p>TinyMCE 高阶使用插件要付费，本来看到付费就想舍弃，但是有看到说免费部分可以满足基本需求，界面也挺不错，就决定试试。</p></blockquote><span id="more"></span><h3 id="Demo-过程"><a href="#Demo-过程" class="headerlink" title="Demo 过程"></a>Demo 过程</h3><p>这里使用了 wangEditor 5 作为富文本编辑器。</p><ol><li><p>安装</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">npm i tinymce<br>npm i @tinymce/tinymce-vue<br></code></pre></div></td></tr></table></figure></li><li><p>在 node_modules 文件夹中找到 tinymce 复制到项目public文件夹中.</p></li><li><p>在 <a href="https://www.tiny.cloud/get-tiny/language-packages/?login=from_csdn">tinymce官网</a> 中下载中文包，并放在刚刚创建的tinymce文件夹中.</p></li></ol><p><code>附录</code><br><a href="http://tinymce.ax-z.cn/search/">中文文档-不在维护</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（41-3）AIGC-富文本编辑器-WangEditor</title>
    <link href="/2024/10/17/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-3%EF%BC%89AIGC-%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8-WangEditor/"/>
    <url>/2024/10/17/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-3%EF%BC%89AIGC-%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8-WangEditor/</url>
    
    <content type="html"><![CDATA[<blockquote><p>背景：大模型生成文章内容，需要使用富文本编辑器进行内容的编辑。其中敏感词汇需要标注，最后可以生成word、pdf等格式的文档。</p></blockquote><span id="more"></span><h3 id="调研"><a href="#调研" class="headerlink" title="调研"></a>调研</h3><p>目前市面上有好多富文本编辑器，我们的需求是开源免费、不要二次开发（人力&amp;时间有限）。本篇记录wangEditor实验。</p><h3 id="Demo-过程"><a href="#Demo-过程" class="headerlink" title="Demo 过程"></a>Demo 过程</h3><p>这里使用了 wangEditor 5 作为富文本编辑器。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">npm install @wangeditor/editor-<span class="hljs-keyword">for</span>-vue@next --save<br></code></pre></div></td></tr></table></figure><p>使用包中自带的组件，渲染如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border: 1px solid #ccc; width: 100%; margin: 0 auto&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span></span><br><span class="hljs-tag">      <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border-bottom: 1px solid #ccc&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:editor</span>=<span class="hljs-string">&quot;editorRef&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:defaultConfig</span>=<span class="hljs-string">&quot;toolbarConfig&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">mode</span>=<span class="hljs-string">&quot;default&quot;</span></span><br><span class="hljs-tag">    /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Editor</span></span><br><span class="hljs-tag">      <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 500px; overflow-y: hidden&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;valueHtml&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:defaultConfig</span>=<span class="hljs-string">&quot;editorConfig&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">mode</span>=<span class="hljs-string">&quot;default&quot;</span></span><br><span class="hljs-tag">      @<span class="hljs-attr">onCreated</span>=<span class="hljs-string">&quot;handleCreated&quot;</span></span><br><span class="hljs-tag">      @<span class="hljs-attr">customPaste</span>=<span class="hljs-string">&quot;customPaste&quot;</span></span><br><span class="hljs-tag">    /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;margin: 0 auto&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;getEditorHTML&quot;</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;@wangeditor/editor/dist/css/style.css&#x27;</span><br><span class="hljs-keyword">import</span> &#123; onBeforeUnmount, ref, shallowRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-comment">// 导入富文本编辑器的组件</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Editor</span>, <span class="hljs-title class_">Toolbar</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@wangeditor/editor-for-vue&#x27;</span><br><br><span class="hljs-comment">// 编辑器实例，必须用 shallowRef</span><br><span class="hljs-keyword">const</span> editorRef = <span class="hljs-title function_">shallowRef</span>()<br><br><span class="hljs-comment">// 内容 HTML</span><br><span class="hljs-keyword">const</span> valueHtml = <span class="hljs-title function_">ref</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-keyword">const</span> toolbarConfig = &#123;&#125;<br><span class="hljs-keyword">const</span> editorConfig = <span class="hljs-title function_">ref</span>(&#123; <span class="hljs-attr">placeholder</span>: <span class="hljs-string">&#x27;请输入内容...&#x27;</span>, <span class="hljs-attr">MENU_CONF</span>: &#123;&#125; &#125;)<br><br><span class="hljs-comment">// 自定义图片上传</span><br>editorConfig.<span class="hljs-property">value</span>.<span class="hljs-property">MENU_CONF</span>[<span class="hljs-string">&#x27;uploadImage&#x27;</span>] = &#123;<br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">customUpload</span>(<span class="hljs-params">file, insertFn</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;上传图片&#x27;</span>, file)<br>    <span class="hljs-comment">// 将上传的file图片转换为base64</span><br>    <span class="hljs-keyword">const</span> base64 = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(file)<br>    <span class="hljs-comment">// 这里的file为上传的图片对象,insertFn传入</span><br>    <span class="hljs-title function_">insertFn</span>(base64, <span class="hljs-string">&#x27;img&#x27;</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 自定义视频上传</span><br>editorConfig.<span class="hljs-property">value</span>.<span class="hljs-property">MENU_CONF</span>[<span class="hljs-string">&#x27;uploadVideo&#x27;</span>] = &#123;<br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">customUpload</span>(<span class="hljs-params">file, insertFn</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;上传视频&#x27;</span>, file)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 富文本编辑器生成后触发</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCreated</span> = (<span class="hljs-params">editor</span>) =&gt; &#123;<br>  editorRef.<span class="hljs-property">value</span> = editor <span class="hljs-comment">// 记录 editor 实例，重要！</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(editorConfig.<span class="hljs-property">value</span>.<span class="hljs-property">MENU_CONF</span>, <span class="hljs-string">&#x27;editorConfig.value&#x27;</span>)<br>&#125;<br><br><span class="hljs-comment">// 监听富文本编辑器粘贴行为</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">customPaste</span> = (<span class="hljs-params">editor, event, callback</span>) =&gt; &#123;<br>  <span class="hljs-comment">// 获取粘贴的纯文本</span><br>  <span class="hljs-keyword">const</span> text = event.<span class="hljs-property">clipboardData</span>.<span class="hljs-title function_">getData</span>(<span class="hljs-string">&#x27;text/plain&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (text) &#123;<br>    editor.<span class="hljs-title function_">insertText</span>(text)<br>    event.<span class="hljs-title function_">preventDefault</span>()<br>    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">false</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 获取富文本html内容</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getEditorHTML</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(editorRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">getHtml</span>())<br>&#125;<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    valueHtml.<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;&lt;p&gt;模拟 Ajax 异步设置内容 HTML&lt;/p&gt;&#x27;</span><br>    &#125;, <span class="hljs-number">1500</span>)<br>&#125;)<br><br><span class="hljs-comment">// 组件销毁时，也及时销毁编辑器</span><br><span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> editor = editorRef.<span class="hljs-property">value</span><br>  <span class="hljs-keyword">if</span> (editor == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span><br>  editor.<span class="hljs-title function_">destroy</span>()<br>&#125;)<br></code></pre></div></td></tr></table></figure><h4 id="隐藏菜单栏"><a href="#隐藏菜单栏" class="headerlink" title="隐藏菜单栏"></a>隐藏菜单栏</h4><p>官方有<code>toolbar.getConfig().toolbarKeys</code>这个方法，但是在 vue3 中没有成功，不确定应该在什么时候调用。<br>实验发现，在菜单栏中通过网页元素查看<code>data-menu-key</code>确定菜单栏的名字，然后在<code>toolbarConfig</code>中设置<code>excludeKeys</code>属性，将不需要的菜单栏隐藏。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> toolbarConfig = &#123;<br>  <span class="hljs-attr">excludeKeys</span>: [<span class="hljs-string">&#x27;emotion&#x27;</span>]<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="自动保存"><a href="#自动保存" class="headerlink" title="自动保存"></a>自动保存</h3><h4 id="监听-Ctr-S"><a href="#监听-Ctr-S" class="headerlink" title="监听 Ctr + S"></a>监听 Ctr + S</h4><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"> <span class="hljs-keyword">const</span> <span class="hljs-title function_">keyDown</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> currentKey = event.<span class="hljs-property">keyCode</span> || event.<span class="hljs-property">which</span><br>  <span class="hljs-keyword">if</span> (currentKey === <span class="hljs-number">83</span> &amp;&amp; (event.<span class="hljs-property">ctrlKey</span> || event.<span class="hljs-property">metaKey</span>)) &#123;<br>    event.<span class="hljs-title function_">preventDefault</span>()<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ctrl S&#x27;</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>   <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, keyDown)<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="生成文档并下载"><a href="#生成文档并下载" class="headerlink" title="生成文档并下载"></a>生成文档并下载</h3><h4 id="word-文档"><a href="#word-文档" class="headerlink" title="word 文档"></a>word 文档</h4><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">npm install html-docx-js-typescript --save<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; asBlob &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;html-docx-js-typescript&#x27;</span>;<span class="hljs-comment">//将html转为word</span><br><br><span class="hljs-keyword">const</span>  <span class="hljs-title function_">exportDoc</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>   <span class="hljs-keyword">const</span> editor = editorRef.<span class="hljs-property">value</span><br>   <span class="hljs-comment">// 将富文本内容拼接为一个完整的html</span><br>   <span class="hljs-keyword">const</span> html = editor.<span class="hljs-title function_">getHtml</span>()<br>   <span class="hljs-keyword">const</span> value =  <span class="hljs-string">`&lt;!DOCTYPE html&gt;</span><br><span class="hljs-string">   &lt;html lang=&quot;en&quot;&gt;</span><br><span class="hljs-string">      &lt;head&gt;</span><br><span class="hljs-string">        &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="hljs-string">        &lt;title&gt;Document&lt;/title&gt;</span><br><span class="hljs-string">      &lt;/head&gt;</span><br><span class="hljs-string">      &lt;body&gt;</span><br><span class="hljs-string">         <span class="hljs-subst">$&#123;html&#125;</span></span><br><span class="hljs-string">      &lt;/body&gt;</span><br><span class="hljs-string">    &lt;/html&gt;`</span><br>   <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asBlob</span>(value, &#123; <span class="hljs-attr">orientation</span>: <span class="hljs-string">&#x27;portrait&#x27;</span> &#125;) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Blob</span><br>   <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;a&#x27;</span>)<br>   a.<span class="hljs-property">href</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">createObjectURL</span>(data)<br>   a.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;download&#x27;</span>, <span class="hljs-string">&#x27;document.docx&#x27;</span>)<br>   a.<span class="hljs-title function_">click</span>()<br>   a.<span class="hljs-title function_">remove</span>()<br>&#125;<br></code></pre></div></td></tr></table></figure><p>结果如下：<br><img src="/../img/editor1.jpg" alt="word文档效果"></p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>可实现全屏编辑；<br>可实现鼠标键盘复制粘贴功能；<br>可实现选中文字调出工具栏；<br>可实现代码高亮（可选语言，但是浮动框被工具栏遮挡住部分）；<br>可实现本地上传图片，目前为 base64 保存和传输；<br>可实现初始化内容；<br>可实现隐藏菜单栏；<br>可实现键盘事件 ctrl S 触发自动报错；<br>可实现保存为 word 并下载，会保留基本格式（字体可能不行，需要安装字体？），会自动分页；<br>尝试生成pdf，失败（要么打开不了，要么就是纯html，没有变成有格式的文字）；</p><p><code>附录</code><br><a href="https://www.wangeditor.com/">wangEditor 5</a><br><a href="https://blog.csdn.net/lixilai_rjkf/article/details/115002885">自动保存</a><br><a href="https://blog.csdn.net/weixin_43797577/article/details/138854324">Vue3+TS实现将html或富文本编辑器转为Word并下载</a><br><a href="https://zhuanlan.zhihu.com/p/296543833">14款web前端常用的富文本编辑器插件</a><br>UEditor 是百度的项目，已于2023年6月暂停维护；</p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（30-2）对接飞书登录</title>
    <link href="/2024/10/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%8830-2%EF%BC%89%E5%AF%B9%E6%8E%A5%E9%A3%9E%E4%B9%A6%E7%99%BB%E5%BD%95/"/>
    <url>/2024/10/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%8830-2%EF%BC%89%E5%AF%B9%E6%8E%A5%E9%A3%9E%E4%B9%A6%E7%99%BB%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录前端 vue3 对接飞书实践。 </p></blockquote><span id="more"></span><h3 id="业务需求"><a href="#业务需求" class="headerlink" title="业务需求"></a>业务需求</h3><p><code>附录</code><br><a href="https://blog.csdn.net/qq_37656005/article/details/133647799">vue3飞书扫码登录网页</a><br><a href="https://open.feishu.cn/document/common-capabilities/sso/web-application-sso/qr-sdk-documentation">飞书官方文档</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（39-1）docker部署</title>
    <link href="/2024/10/09/vue3%E7%AC%94%E8%AE%B0%EF%BC%8839-1%EF%BC%89docker%E9%83%A8%E7%BD%B2/"/>
    <url>/2024/10/09/vue3%E7%AC%94%E8%AE%B0%EF%BC%8839-1%EF%BC%89docker%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>近期需要实现项目的 docker 部署，服务器中已实现 docker 环境，本文记录如何在服务器上用容器部署 vue3 项目。</p></blockquote><h3 id="docker-环境准备"><a href="#docker-环境准备" class="headerlink" title="docker 环境准备"></a>docker 环境准备</h3><p>给了一台全新阿里云机器，里面没有docker环境，需要安装。机器环境如下：<br><img src="/../img/docker1.jpg" alt="无docker环境"><br>同事建议安装 docker-ce，安装命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">apt-get install docker-ce<br>apt install docker-ce<br></code></pre></div></td></tr></table></figure><p>但是发现有这样的报错：<br><img src="/../img/docker2.jpg" alt="报错"><br>原因是源里面没有docker-ce的包，需要添加源：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo add-apt-repository &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;<br></code></pre></div></td></tr></table></figure><p>这时又出现了这个报错：<br><img src="/../img/docker3.jpg" alt="报错2"><br>原因是没有证书，需要导入证书：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg<br></code></pre></div></td></tr></table></figure><p>结果又报错<code>gpg: no valid OpenPGP data found.</code>，整个大无语了。。。</p><h3 id="docker-环境安装全指令"><a href="#docker-环境安装全指令" class="headerlink" title="docker 环境安装全指令"></a>docker 环境安装全指令</h3><p>重启机器，再次从头安装，命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">sudo apt-get update<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装让 APT 可以通过 HTTPS 使用存储库(repository)的包</span><br>sudo apt-get install \<br>    apt-transport-https \<br>    ca-certificates \<br>    curl \<br>    gnupg \<br>    lsb-release<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加Docker的官方GPG密钥：</span><br>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">使用下面的命令设置稳定的仓库：</span><br>echo \<br>  &quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \<br><span class="hljs-meta prompt_">  $</span><span class="language-bash">(lsb_release -cs) stable<span class="hljs-string">&quot; | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">再次更新包索引：</span></span><br>sudo apt-get update<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">安装Docker CE：</span></span><br>sudo apt-get install docker-ce docker-ce-cli containerd.io<br></code></pre></div></td></tr></table></figure><h3 id="部署指令"><a href="#部署指令" class="headerlink" title="部署指令"></a>部署指令</h3><ol><li>个人根目录下应有三个文件，项目打包文件<code>dist</code>、<code>nginx.conf</code>、<code>Dockerfile</code>。</li></ol><p>1.1 创建 <code>nginx.conf</code> 文件，主要用于配置端口号和请求转发地址，<code>若以微前端方式部署，需要添加允许跨域配置</code>，内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs conf">user  nginx;<br>worker_processes  auto;<br><br>error_log  /var/log/nginx/error.log warn;<br>pid        /var/run/nginx.pid;<br><br>events &#123;<br>    worker_connections  1024;<br>&#125;<br><br>http &#123;<br>    include       /etc/nginx/mime.types;<br>    default_type  application/octet-stream;<br><br>    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;<br>                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;<br>                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;<br><br>    access_log  /var/log/nginx/access.log  main;<br>    sendfile        on;<br>    #tcp_nopush     on;<br>    keepalive_timeout  65;<br>    #gzip  on;<br>    include /etc/nginx/conf.d/*.conf;<br><br>    server &#123;<br>        listen       51999;<br>        listen  [::]:51999;<br>        server_name  localhost;<br><br>        location / &#123;<br>            add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;<br>        add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;<br>        add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Origin, Authorization, Content-Type, Accept, X-Requested-With&#x27;;<br><br>        if ($request_method = &#x27;OPTIONS&#x27;) &#123;<br>            add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;;<br>            add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;<br>            add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Origin, Authorization, Content-Type, Accept, X-Requested-With&#x27;;<br>            return 204;<br>        &#125;<br>    root   /usr/share/nginx/html;<br>            index  index.html;<br>            try_files $uri $uri /index.html;<br>        &#125;<br><br>        error_page   500 502 503 504  /50x.html;<br>        location = /50x.html &#123;<br>            root   /usr/share/nginx/html;<br>        &#125;<br><br>        location /v1/ &#123;<br>           proxy_pass   http://***:31333/v1/;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>1.2  项目根目录下创建 <code>Dockerfile</code> 文件，内容如下：</p><figure class="highlight dockerfile"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> nginx:<span class="hljs-number">1.25</span>.<span class="hljs-number">5</span>-alpine<br><span class="hljs-keyword">COPY</span><span class="language-bash"> dist /usr/share/nginx/html  </span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> nginx.conf /etc/nginx/nginx.conf</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">51888</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]</span><br></code></pre></div></td></tr></table></figure><p>注意 EXPOSE 端口号和 nginx listen 端口号一致。<br>若有多个项目，可以创建多个 Dockerfile 文件，在项目根目录下启动就行。<br>本机已配置好 nginx:1.25.5-alpine 镜像，可以直接使用。若查找不到本地镜像，docker 会从官方拉取镜像，这里就涉及到是否能访问到外网，以及能否设置代理获取到国内镜像，设置起来有点麻烦。</p><ol start="2"><li>个人根目录下</li></ol><p>2.1 创建镜像</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">项目名:tag</span><br>docker build --no-cache -f dockerfile -t ai-sys:20241017-1 .<br>docker build --no-cache -f dockerfile -t ai-controller:20241017-1 .<br></code></pre></div></td></tr></table></figure><p>2.2 运行容器</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看镜像</span><br>docker images<br><span class="hljs-meta prompt_"># </span><span class="language-bash">-d: 后台运行容器并返回容器 ID</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">-p: 端口映射 外部访问端口:内部容器端口</span><br>docker run -d -p 51888:51888 imageID/imageName<br>docker run -d -p 51999:51999 imageID/imageName<br></code></pre></div></td></tr></table></figure><ol start="3"><li><p>访问项目<br>浏览器访问 <code>http://ip:51888/</code></p></li><li><p>修改文件后重启<br>删除容器时，容器必须是停止状态，否则删除失败。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看正在运行的容器</span><br>docker ps <br>docker kill containerID<br>docker rm containerID <br>docker rmi imageID<br></code></pre></div></td></tr></table></figure></li></ol><p><code>附录</code><br><a href="https://cloud.tencent.com/developer/article/2377835">深入理解Docker：docker、podman-docker、docker.io和docker-ce的区别</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（41-1）chatbot</title>
    <link href="/2024/09/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-1%EF%BC%89AIGC-chatbot/"/>
    <url>/2024/09/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-1%EF%BC%89AIGC-chatbot/</url>
    
    <content type="html"><![CDATA[<blockquote><p>需求：实现 AI Agent 聊天机器人，通过 websocket 与后端通信。<br>本篇记录一下调研过程。</p></blockquote><span id="more"></span><h3 id="调研"><a href="#调研" class="headerlink" title="调研"></a>调研</h3><p>一般采用流式数据，也有部分采用一次性返回数据。</p><ol><li>如下图所示，kimi使用一次性返回数据，使用打字机效果展示。<br><img src="/../img/vue41-1.jpg" alt="交互"></li><li>Teco AI 使用流式数据，通过 websocket 与后端通信。</li><li>ChatGpt 使用流式数据。</li></ol><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol><li>实现打字机效果。</li></ol><p><code>附录</code><br><a href="https://juejin.cn/post/7237426124669157433">从零开始：实现ChatGpt 打字机聊天效果</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（41-2）websocket</title>
    <link href="/2024/09/27/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-2%EF%BC%89AIGC-websocket/"/>
    <url>/2024/09/27/vue3%E7%AC%94%E8%AE%B0%EF%BC%8841-2%EF%BC%89AIGC-websocket/</url>
    
    <content type="html"><![CDATA[<blockquote><p>需求：实现 AI Agent 聊天机器人，通过 websocket 与后端通信。<br>本篇记录 websocket 的使用方法。</p></blockquote><span id="more"></span><p><code>socket.ts</code> 文件：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> interface <span class="hljs-title class_">TCWSRequestData</span> &#123;<br>  <span class="hljs-attr">content</span>: string <span class="hljs-comment">// 输入内容, 必填，非空</span><br>  output_len?: number <span class="hljs-comment">// 输出长度，可选，默认128</span><br>  repetition_penalty?: number <span class="hljs-comment">// 重复惩罚，可选，默认1.0</span><br>&#125;<br><span class="hljs-keyword">export</span> interface <span class="hljs-title class_">TCWSResponseData</span> &#123;<br>  <span class="hljs-attr">code</span>: string<br>  <span class="hljs-attr">type</span>: string<br>  <span class="hljs-attr">message</span>: string<br>  <span class="hljs-attr">data</span>: string <span class="hljs-comment">// 推理文本结果</span><br>  <span class="hljs-attr">ftl</span>: number <span class="hljs-comment">// 首字延迟(ms)</span><br>  <span class="hljs-attr">latency</span>: number <span class="hljs-comment">// 总延迟(ms)</span><br>  end?: boolean<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> initSocket = (url, onMessage, <span class="hljs-attr">options</span>: any = &#123;&#125;): <span class="hljs-function"><span class="hljs-params">any</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMessage</span> = (<span class="hljs-params">messagePayload: any</span>) =&gt; &#123;<br>    <span class="hljs-keyword">return</span> messagePayload<br>  &#125;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendRequestRaw</span> = (<span class="hljs-params">json: string</span>) =&gt; &#123;<br>    _socket.<span class="hljs-title function_">send</span>(json)<br>  &#125;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendRequest</span> = (<span class="hljs-params"></span><br><span class="hljs-params">    content: string,</span><br><span class="hljs-params">    output_len: number = <span class="hljs-number">128</span>,</span><br><span class="hljs-params">    repetition_penalty: number = <span class="hljs-number">1.0</span></span><br><span class="hljs-params">  </span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> msg = &#123;&#125; <span class="hljs-keyword">as</span> <span class="hljs-title class_">TCWSRequestData</span><br>    msg.<span class="hljs-property">content</span> = content<br>    msg.<span class="hljs-property">output_len</span> = output_len<br>    msg.<span class="hljs-property">repetition_penalty</span> = repetition_penalty<br>    _socket.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(msg))<br>  &#125;<br><br>  <span class="hljs-keyword">let</span> _socket = <span class="hljs-literal">null</span><br>  <span class="hljs-keyword">let</span> _doRetry = <span class="hljs-literal">false</span><br>  <span class="hljs-keyword">let</span> _retryCount = -<span class="hljs-number">1</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">closeSocket</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;socket 手动关闭&#x27;</span>)<br>    _doRetry = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">if</span> (_socket) &#123;<br>      _socket.<span class="hljs-title function_">close</span>()<br>      _socket = <span class="hljs-literal">null</span><br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">doRetry</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;socket 重试&#x27;</span>)<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">&#x27;Websocket 重连中...&#x27;</span>)<br>      _socket = <span class="hljs-title function_">getSocket</span>()<br>    &#125;, <span class="hljs-number">3000</span>)<br>  &#125;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getSocket</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url)<br>    socket.<span class="hljs-property">binaryType</span> = <span class="hljs-string">&#x27;arraybuffer&#x27;</span><br>    socket.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;socket 连接成功&#x27;</span>)<br>      options.<span class="hljs-property">onopen</span> &amp;&amp; options.<span class="hljs-title function_">onopen</span>()<br>    &#125;<br>    socket.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">data: any</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">onMessage</span>(<span class="hljs-title function_">handleMessage</span>(data))<br>    &#125;<br>    socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;socket 关闭，retry：&#x27;</span>, _doRetry, _retryCount)<br>      <span class="hljs-keyword">if</span> (_doRetry) &#123;<br>        <span class="hljs-keyword">if</span> (_retryCount !== <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-title function_">doRetry</span>()<br>          <span class="hljs-keyword">if</span> (_retryCount &gt; <span class="hljs-number">0</span>) _retryCount--<br>        &#125;<br>      &#125;<br>    &#125;<br>    socket.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;socket 出错，retry：&#x27;</span>, _doRetry, _retryCount)<br>    &#125;<br>    <span class="hljs-keyword">return</span> socket<br>  &#125;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getState</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">return</span> (_socket &amp;&amp; _socket.<span class="hljs-property">readyState</span>) || <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSED</span><br>  &#125;<br>  _retryCount = options.<span class="hljs-property">retryCount</span> || _retryCount<br>  _doRetry = options.<span class="hljs-property">retry</span> || _doRetry<br>  _socket = <span class="hljs-title function_">getSocket</span>()<br>  <span class="hljs-keyword">return</span> &#123; sendRequestRaw, sendRequest, closeSocket, getState &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; initSocket, <span class="hljs-title class_">TCWSResponseData</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./socket&#x27;</span><br><span class="hljs-keyword">let</span> socket = <span class="hljs-literal">null</span><br><br><span class="hljs-keyword">let</span> wsTimer = <span class="hljs-literal">null</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">onMessage</span> = (<span class="hljs-params">res</span>) =&gt; &#123;<br>  <span class="hljs-built_in">clearTimeout</span>(wsTimer)<br><br>  chatObj.<span class="hljs-property">responseData</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(res.<span class="hljs-property">data</span>)<br>  <span class="hljs-keyword">if</span> (chatObj.<span class="hljs-property">responseData</span>?.<span class="hljs-property">end</span>) &#123; <span class="hljs-comment">// 结束会话</span><br>    wsTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">closeWs</span>()<br>    &#125;, <span class="hljs-number">5000</span>)<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  resType.<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;text&#x27;</span><br>  resData.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span><br>  textData.<span class="hljs-property">value</span> =<br>    chatObj.<span class="hljs-property">responseData</span>.<span class="hljs-property">code</span> == <span class="hljs-string">&#x27;1&#x27;</span> ? chatObj.<span class="hljs-property">responseData</span>.<span class="hljs-property">data</span> : chatObj.<span class="hljs-property">responseData</span>.<span class="hljs-property">message</span><br><br>  wsTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">closeWs</span>()<br>  &#125;, <span class="hljs-number">5000</span>)<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">openWs</span> = (<span class="hljs-params">callback</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (!chatObj.<span class="hljs-property">socket</span> || chatObj.<span class="hljs-property">socket</span>.<span class="hljs-title function_">getState</span>() == <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">CLOSED</span>)<br>    chatObj.<span class="hljs-property">socket</span> = <span class="hljs-title function_">initSocket</span>(baseUrl.<span class="hljs-property">value</span> + urlPath.<span class="hljs-property">value</span>, onMessage, &#123; <span class="hljs-attr">onopen</span>: callback &#125;)<br>  <span class="hljs-keyword">else</span> <span class="hljs-title function_">callback</span>()<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">closeWs</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  chatObj.<span class="hljs-property">socket</span> &amp;&amp; chatObj.<span class="hljs-property">socket</span>.<span class="hljs-title function_">closeSocket</span>()<br>&#125;<br><br><span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">closeWs</span>()<br>&#125;)<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">submitData</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">// json格式</span><br>  <span class="hljs-title function_">openWs</span>(<span class="hljs-function">() =&gt;</span> &#123; <br>    socket.<span class="hljs-title function_">sendRequestRaw</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(rowData.<span class="hljs-property">value</span>))<br>  &#125;)<br>  <span class="hljs-comment">// 非json格式</span><br>  <span class="hljs-title function_">openWs</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    socket.<span class="hljs-title function_">sendRequest</span>(rowData.<span class="hljs-property">value</span>)<br>  &#125;) <br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>javascript</code></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（40-1）新模版框架使用</title>
    <link href="/2024/08/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%8840-1%EF%BC%89%E6%96%B0%E6%A8%A1%E7%89%88%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/"/>
    <url>/2024/08/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%8840-1%EF%BC%89%E6%96%B0%E6%A8%A1%E7%89%88%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>近期换了个模版框架，这里记录下使用过程中的一些新知识。</p></blockquote><span id="more"></span><h3 id="unocss"><a href="#unocss" class="headerlink" title="unocss"></a>unocss</h3><p>UnoCSS 是即时原子 CSS 引擎，所有 CSS 工具都是通过预设提供的.<br>在<code>vite.config.ts</code>中配置<code>unocss</code>插件：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">UnoCSS</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unocss/vite&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (&#123; command, mode &#125;: <span class="hljs-title class_">ConfigEnv</span>): <span class="hljs-function"><span class="hljs-params">UserConfig</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">plugins</span>: [<span class="hljs-title class_">UnoCSS</span>()]<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>导入全局样式</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;virtual:uno.css&#x27;</span><br></code></pre></div></td></tr></table></figure><p>创建<code>uno.config.js</code>文件</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123;<br>  defineConfig,<br>  toEscapedSelector <span class="hljs-keyword">as</span> e,<br>  presetUno,<br>  presetIcons,<br>  presetAttributify,<br>  presetTypography<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unocss&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-comment">// 使用预设</span><br>  <span class="hljs-attr">presets</span>: [<br>    <span class="hljs-title function_">presetUno</span>(&#123; <span class="hljs-attr">dark</span>: <span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-attr">attributify</span>: <span class="hljs-literal">false</span> &#125;),<br>    ...<span class="hljs-title function_">createPresetIcons</span>(),<br>    <span class="hljs-title function_">presetAttributify</span>(), <span class="hljs-comment">// 属性化预设</span><br>    <span class="hljs-title function_">presetTypography</span>() <span class="hljs-comment">// 版式预设</span><br>  ],<br>  <span class="hljs-comment">// 自定义规则</span><br>  <span class="hljs-attr">rules</span>: [<br>    [<span class="hljs-string">&#x27;m-1&#x27;</span>, &#123; <span class="hljs-attr">margin</span>: <span class="hljs-string">&#x27;1px&#x27;</span> &#125;],<br>    [<span class="hljs-regexp">/^m-([\.\d]+)$/</span>, <span class="hljs-function">(<span class="hljs-params">[_, num]</span>) =&gt;</span> (&#123; <span class="hljs-attr">margin</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;num&#125;</span>px`</span> &#125;)],<br>    [<br>      <span class="hljs-regexp">/^text-color-primary$/</span>,<br>      <span class="hljs-function">(<span class="hljs-params">[], &#123; rawSelector &#125;</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> selector = <span class="hljs-title function_">e</span>(rawSelector)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">`</span><br><span class="hljs-string">          <span class="hljs-subst">$&#123;selector&#125;</span> &#123;</span><br><span class="hljs-string">            color: rgb(22, 93, 255);</span><br><span class="hljs-string">          &#125;`</span><br>      &#125;<br>    ],<br>  ],<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>UnoCSS 默认字体大小为 4px，如果需要自定义，特别是针对移动端做一个适配，可以通过设计稿宽度计算出基准字体大小，然后通过<code>postprocess</code>函数对所有样式进行处理：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-attr">postprocess</span>: [<br>  <span class="hljs-function">(<span class="hljs-params">util</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> remRE = <span class="hljs-regexp">/(-?[\.\d]+)rem/g</span>;<br>    <span class="hljs-keyword">const</span> designWidth = <span class="hljs-number">422</span>; <span class="hljs-comment">// 设计稿宽度</span><br>    <span class="hljs-keyword">const</span> defaultWidth = <span class="hljs-number">384</span>; <span class="hljs-comment">// 默认浏览器窗口宽度</span><br>    <span class="hljs-keyword">const</span> rootFontSize = <span class="hljs-number">42.2</span>; <span class="hljs-comment">// 基准字体大小</span><br>    <span class="hljs-keyword">const</span> unoDefaultFontSize = <span class="hljs-number">4</span>; <span class="hljs-comment">// UnoCSS 默认字体大小</span><br>    <span class="hljs-keyword">const</span> scale = defaultWidth / designWidth;<br><br>    util.<span class="hljs-property">entries</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> value = entry[<span class="hljs-number">1</span>];<br>      <span class="hljs-keyword">if</span> (value &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&#x27;string&#x27;</span> &amp;&amp; remRE.<span class="hljs-title function_">test</span>(value))<br>        entry[<span class="hljs-number">1</span>] = value.<span class="hljs-title function_">replace</span>(remRE, <span class="hljs-function">(<span class="hljs-params">_, p1</span>) =&gt;</span> &#123;<br>          <span class="hljs-keyword">const</span> computeRem = (rootFontSize / unoDefaultFontSize) * scale;<br>          <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;(p1 / computeRem) * scale&#125;</span>rem`</span>;<br>        &#125;);<br>    &#125;);<br>  &#125;,<br>]<br></code></pre></div></td></tr></table></figure><p>但是这样做有一定风险，如果用的是PC端框架，很多组件已经有自己的样式了，突然改变 root font-size 会导致样式失效。所以，还是建议使用 UnoCSS 预设的默认字体大小。</p><h3 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h3><p>发现项目里有个插件 <code>pinia-plugin-persistedstate</code>, 在 Pinia 中使用这个插件进行状态持久化。在<code>store/index.ts</code>中具体使用方式如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createPinia &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span><br><span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia-plugin-persistedstate&#x27;</span><br><br><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>()<br><br>store.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setupStore</span> = (<span class="hljs-params">app: App&lt;Element&gt;</span>) =&gt; &#123;<br>  app.<span class="hljs-title function_">use</span>(store)<br>&#125;<br><br><span class="hljs-keyword">export</span> &#123; store &#125;<br></code></pre></div></td></tr></table></figure><p>在<code>store/user.ts</code>中定义状态, 并设置<code>persist</code>为<code>true</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;user&#x27;</span>, &#123;<br>  <span class="hljs-attr">state</span>: (): <span class="hljs-function"><span class="hljs-params">UserState</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">account</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>      <span class="hljs-attr">token</span>: <span class="hljs-string">&#x27;&#x27;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">getters</span>: &#123;&#125;,<br>  <span class="hljs-attr">actions</span>: &#123;&#125;,<br>  <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span><br>&#125;)<br></code></pre></div></td></tr></table></figure><p>对于更细粒度的控制，可以向 persist 属性传递配置对象，列举两个常用的配置：</p><ol><li>storage: 指定用于保存数据的机制，默认为localStorage。</li><li>paths: 数组形式，指定要持久化的状态字段路径。</li></ol><p>但是在项目实际需求中，需要实现 token 24小时过期，虽然可以通过后端请求实现，但是我还是希望前端能在 24h 之后自动清除 token，查阅资料，这样的写法似乎没有可以直接配置时间的地方。如果需要传递参数时自动携带 cookie，还是需要通过 cookie 做一个中转，即在设置 cookie 时，带入时间，或者附录中还有一篇文章参考。</p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ol><li><p>新建空白 vue 页面</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vue">&lt;script setup lang=&quot;tsx&quot;&gt;<br>import &#123; useI18n &#125; from &#x27;@/hooks/web/useI18n&#x27;<br>const &#123; t &#125; = useI18n()<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>&lt;div class=&quot;flex h-full&quot;&gt;&lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;&lt;/style&gt;<br></code></pre></div></td></tr></table></figure></li><li><p>Table</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">Table</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model:pageSize</span>=<span class="hljs-string">&quot;pageSize&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model:currentPage</span>=<span class="hljs-string">&quot;currentPage&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:columns</span>=<span class="hljs-string">&quot;columns&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;dataList&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:loading</span>=<span class="hljs-string">&quot;loading&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">register</span>=<span class="hljs-string">&quot;tableRegister&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">selection-change</span>=<span class="hljs-string">&quot;handleSelectionChange&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:reserveSelection</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:row-key</span>=<span class="hljs-string">&quot;getRowKey&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:pagination</span>=<span class="hljs-string">&quot;&#123;</span></span><br><span class="hljs-string"><span class="hljs-tag">    total,</span></span><br><span class="hljs-string"><span class="hljs-tag">    layout: &#x27;total, prev, pager, next&#x27;</span></span><br><span class="hljs-string"><span class="hljs-tag">  &#125;&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useTable &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/web/useTable&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">TableColumn</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/Table&#x27;</span><br><br><span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><span class="hljs-keyword">const</span> batchArr = <span class="hljs-title function_">ref</span>([])<br><span class="hljs-keyword">const</span> &#123; dataList, loading, total, currentPage, pageSize &#125; = tableState<br><span class="hljs-keyword">const</span> &#123; getList &#125; = tableMethods<br><span class="hljs-keyword">const</span> &#123; tableRegister, tableState, tableMethods &#125; = <span class="hljs-title function_">useTable</span>(&#123;<br>  <span class="hljs-attr">fetchDataApi</span>: <span class="hljs-keyword">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; currentPage, pageSize &#125; = tableState<br>    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getList</span>(<br>      &#123;<br>        <span class="hljs-attr">page_number</span>: <span class="hljs-title function_">unref</span>(currentPage),<br>        <span class="hljs-attr">page_limit</span>: <span class="hljs-title function_">unref</span>(pageSize),<br>        ...<span class="hljs-title function_">unref</span>(searchParams)<br>      &#125;<br>    )<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">list</span>: res?.<span class="hljs-property">list</span> || [],<br>      <span class="hljs-attr">total</span>: res?.<span class="hljs-property">count</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">request</span>: &#123;<br>    <span class="hljs-attr">pageSize</span>: <span class="hljs-string">&#x27;page_limit&#x27;</span>,<br>    <span class="hljs-attr">pageIndex</span>: <span class="hljs-string">&#x27;page_number&#x27;</span><br>  &#125;<br>&#125;)<br><br><span class="hljs-keyword">const</span> columns = reactive&lt;<span class="hljs-title class_">TableColumn</span>[]&gt;([<br>  &#123;<br>    <span class="hljs-attr">field</span>: <span class="hljs-string">&#x27;selection&#x27;</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;selection&#x27;</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">field</span>: <span class="hljs-string">&#x27;ame&#x27;</span>,<br>    <span class="hljs-attr">label</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">&#x27;common.name&#x27;</span>),<br>    <span class="hljs-attr">slots</span>: &#123;<br>      <span class="hljs-attr">default</span>: <span class="hljs-function">(<span class="hljs-params">&#123; row &#125;</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">return</span> (<br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">span</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> handleShowName(row)&#125;</span><br><span class="language-xml">            &gt;</span><br><span class="language-xml">              &#123;row.name&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>        )<br>      &#125;<br>    &#125;<br>  &#125;<br>])<br><br><span class="hljs-comment">// 批量选择</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params">val</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> batchArr = <span class="hljs-title function_">ref</span>([])<br>  batchArr.<span class="hljs-property">value</span> = val<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getRowKey</span> = (<span class="hljs-params">row: any</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> row.<span class="hljs-property">task_id</span><br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>Search</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">SearchBar</span> <span class="hljs-attr">:schema</span>=<span class="hljs-string">&quot;searchSchema&quot;</span> @<span class="hljs-attr">search</span>=<span class="hljs-string">&quot;setSearchParams&quot;</span> @<span class="hljs-attr">reset</span>=<span class="hljs-string">&quot;setSearchParams&quot;</span> /&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> searchSchema = reactive&lt;<span class="hljs-title class_">FormSchema</span>[]&gt;([<br>  &#123;<br>    <span class="hljs-attr">field</span>: <span class="hljs-string">&#x27;name&#x27;</span>,<br>    <span class="hljs-attr">label</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">&#x27;common.name&#x27;</span>),<br>    <span class="hljs-attr">component</span>: <span class="hljs-string">&#x27;Input&#x27;</span>,<br>    <span class="hljs-attr">componentProps</span>: &#123;<br>      <span class="hljs-attr">placeholder</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">&#x27;common.namePlaceHolder&#x27;</span>)<br>    &#125;<br>  &#125;<br>])<br><span class="hljs-comment">// 查询参数初始值设置</span><br><span class="hljs-keyword">const</span> searchParams = <span class="hljs-title function_">ref</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;&#x27;</span><br>&#125;)<br><span class="hljs-comment">// 更新查询参数</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">setSearchParams</span> = (<span class="hljs-params">params: any</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params) == <span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>) &#123;<br>    searchParams.<span class="hljs-property">value</span> = &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;&#x27;</span><br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    searchParams.<span class="hljs-property">value</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123; <span class="hljs-attr">sort_order</span>: <span class="hljs-string">&#x27;asc&#x27;</span> &#125;, searchParams.<span class="hljs-property">value</span>, params)<br>  &#125;<br>  tableState.<span class="hljs-property">currentPage</span>.<span class="hljs-property">value</span> = <span class="hljs-number">1</span><br>  <span class="hljs-title function_">getList</span>()<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ol><p><code>附录</code><br><a href="http://element-plus-admin-doc.cn/">框架参考</a><br><a href="https://unocss.nodejs.cn/">UnoCSS中文网</a><br><a href="https://www.rainc.io/post/unocss">unocss实现多端的rem适配</a><br><a href="https://prazdevs.github.io/pinia-plugin-persistedstate/zh/guide/config.html">pinia-plugin-persistedstate官方文档</a><br><a href="https://healwrap.cn/post/20">创建一个自定义过期时间的持久化Pinia</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（39-2）docker-compose部署</title>
    <link href="/2024/08/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8839-2%EF%BC%89docker-compose%E9%83%A8%E7%BD%B2/"/>
    <url>/2024/08/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8839-2%EF%BC%89docker-compose%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>近期需要实现项目的 docker 部署，调研 docker-compose 对 vue3 项目的部署如何使用。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><p>一个开放源代码的容器化平台，允许开发者将应用及其依赖打包进轻量级、可移植的容器中。提供一个标准化的方式打包和运行应用，确保应用在不同环境中的一致性和可移植性。<br>功能：</p><ol><li>容器化：将应用和其运行环境封装在一个容器中</li><li>镜像管理：创建、存储和分发容器镜像</li><li>容器运行：可以运行在任何支持Docker的环境中</li></ol><h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><p>Compose 是一个用于定义和运行多容器 Docker 应用程序的工具。可简化多容器应用的配置和管理，适用于开发、测试和生产环境中的复杂应用。<br>功能：</p><ol><li>多容器管理：允许用户在一个YAML文件中定义和管理多个容器</li><li>服务编排：配置容器间的网络和依赖关系</li><li>一键部署：使用docker-compose up命令启动、停止和重建服务<br>Compose的使用三步：</li><li>使用 Dockerfile 自定义应用程序的环境，便于在任何地方复制它；</li><li>使用 docker-compose.yml 定义构成的应用程序的服务，便于隔离环境中一起运行；</li><li>运行 docker-compose up 命令启动并运行整个应用程序。</li></ol><h4 id="两者关系"><a href="#两者关系" class="headerlink" title="两者关系"></a>两者关系</h4><p>Docker 是 Docker Compose 的前提，Docker Compose 是为了简化使用 Docker 时多容器应用的管理和部署而设计的。<br>两者之间相辅相成，Docker 提供容器化的核心功能，Docker Compose 则管理这些容器的组合和交互。<br>两者面向不同用户，Docker 面向任何需要容器化应用的用户，Docker Compose 则面向需要同时管理多个容器的开发者和运维团队。</p><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><ol><li><p>查看服务器中 docker 版本</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker --version<br></code></pre></div></td></tr></table></figure><p>Docker version 24.0.7, build afdd53b</p></li><li><p>在服务器中安装 docker-compose</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">wget https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-linux-x86_64<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">或将本地下载好的 docker-compose 放入服务器</span><br>scp docker-compose-linux-x86_64 root@***:/root<br>mv docker-compose-linux-x86_64 /usr/local/bin/docker-compose<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">赋予执行权限</span><br>chmod +x /usr/local/bin/docker-compose<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">测试安装是否成功</span><br>docker-compose --version<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h3><ol><li><p>将项目进行打包，生成 dist 文件夹。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm run build<br></code></pre></div></td></tr></table></figure></li><li><p>nginx 配置文件<br>查看 nginx 配置文件路径</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">nginx -t <br></code></pre></div></td></tr></table></figure><p>nginx: the configuration file &#x2F;usr&#x2F;local&#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok</p></li></ol><p>其中<code>default.conf</code>用于 nginx 的配置，默认配置如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs conf">server &#123;<br>    listen       80;<br>    server_name  localhost;<br>    #charset koi8-r;<br>    #access_log  logs/host.access.log  main;<br>    location / &#123;<br>        root   /usr/share/nginx/html;<br>        index  index.html index.htm;<br>    &#125;<br>    location /pdbApi &#123;<br>        proxy_pass http://****/:8989;<br>        add_header Access-Control-Allow-Origin *;<br>        add_header Access-Control-Allow-Methods *;<br>     &#125;<br>     location /bioApi &#123;<br>        proxy_pass http://****:8999;<br>        add_header Access-Control-Allow-Origin *;<br>        add_header Access-Control-Allow-Methods *;<br>     &#125;<br>     location /loginApi &#123;<br>        proxy_pass http://****:8009;<br>        add_header Access-Control-Allow-Origin *;<br>        add_header Access-Control-Allow-Methods *;<br>     &#125;<br>    #error_page  404              /404.html;<br>    # redirect server error pages to the static page /50x.html<br>    #<br>    error_page   500 502 503 504  /50x.html;<br>    location = /50x.html &#123;<br>        root   /usr/share/nginx/html;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>本机已安装过，可以直接使用；后测试发现若没有安装，可以直接手写一个配置文件<code>default.conf</code>，只用于映射到 docker 容器中。</p><ol start="3"><li><p>新建 <code>docker-compose.yaml</code> 文件，将 dist 文件夹和<code>default.conf</code> 进行文件映射。</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.4&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">vue_test:</span> <span class="hljs-comment"># serviceName</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">vue_test</span> <span class="hljs-comment"># 唯一标识</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.9.0</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8066:80&quot;</span><br>    <span class="hljs-attr">volumes:</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/data/user01/feenv/dist/:/usr/share/nginx/html/</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/data/user01/feenv/default.conf:/etc/nginx/conf.d/default.conf</span><br></code></pre></div></td></tr></table></figure><p>报错<code>(root) Additional property     restart is not allowed</code>可能是格式不对</p></li><li><p>执行 docker-compose</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">docker-compose up -d<br></code></pre></div></td></tr></table></figure></li><li><p>访问 IP:port 即可访问部署好的项目。</p></li></ol><h4 id="其他指令"><a href="#其他指令" class="headerlink" title="其他指令"></a>其他指令</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">启动</span><br>docker-compose up -d<br><span class="hljs-meta prompt_"># </span><span class="language-bash">停止</span>  <br>docker-compose stop<br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启</span><br>docker-compose restart<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看运行的服务</span><br>docker-compose config --services<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看日志</span><br>docker-compose logs serviceName<br><span class="hljs-meta prompt_"># </span><span class="language-bash">进入容器</span><br>docker-compose exec serviceName bash<br></code></pre></div></td></tr></table></figure><h4 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h4><p>docker 拉取镜像报错：<br><img src="/../img/docker4.jpg" alt="报错"><br>解决方式一：修改 docker 镜像源【暂时验证不成功】</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi /etc/docker/daemon.json<br></code></pre></div></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;registry-mirrors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;https://6kx4zyno.mirror.aliyuncs.com&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><p>修改完毕后，重启 docker 服务：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl restart docker<br></code></pre></div></td></tr></table></figure><p> 问题出现了，这个修改没有起作用，依旧是原来的报错。。。有待keep looking。。。</p><p><code>附录</code><br><a href="https://blog.csdn.net/Que_art/article/details/135192479">Docker Compose - 安装和基本使用</a><br><a href="https://www.modb.pro/db/173705?_refluxos=a10">docker-compose部署Vue项目</a><br><a href="https://www.json.cn/yaml-editor/">YAML、YML在线编辑(校验)器</a></p><h4 id="记录AF3部署"><a href="#记录AF3部署" class="headerlink" title="记录AF3部署"></a>记录AF3部署</h4><p>|– nginx.conf<br>|– docker-compose.yml<br>|– default-shenwei.conf<br>|– default-metastone.conf<br>|– dist-dev<br>|   |– index.html<br>|– dist-metastone<br>|   |– index.html<br><code>docker-compose.yml</code>中添加两个服务：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">version: &quot;3.8&quot;<br>services:<br>  bio_dev:<br>    container_name: bio_v1<br>    image: nginx:1.9.0<br>    environment:<br>      - TZ=Asia/Shanghai<br>    ports:<br>      - &quot;8067:80&quot;<br>    volumes: <br>      - /data/user01/BioEnv/dist-dev:/usr/share/nginx/html/dist-dev<br>      - /data/user01/BioEnv/default-shenwei.conf:/etc/nginx/conf.d/default.conf<br>      - /data/user01/BioEnv/nginx.conf:/etc/nginx/nginx.conf<br>    restart: always<br>  bio_metastone:<br>    container_name: bio_stone_v1<br>    image: nginx:1.9.0<br>    environment:<br>      - TZ=Asia/Shanghai<br>    ports:<br>      - &quot;8077:80&quot;<br>    volumes:<br>      - /data/user01/BioEnv/dist-metastone:/usr/share/nginx/html/dist-metastone<br>      - /data/user01/BioEnv/default-metastone.conf:/etc/nginx/conf.d/default.conf<br>      - /data/user01/BioEnv/nginx.conf:/etc/nginx/nginx.conf<br>    restart: always<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（38-2）vue3项目国际化</title>
    <link href="/2024/08/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8838-2%EF%BC%89vue3%E9%A1%B9%E7%9B%AE%E5%9B%BD%E9%99%85%E5%8C%96/"/>
    <url>/2024/08/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8838-2%EF%BC%89vue3%E9%A1%B9%E7%9B%AE%E5%9B%BD%E9%99%85%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<blockquote><p>新需求，项目需要换肤和多语言支持。本篇介绍如何在vue3项目中实现国际化功能。</p></blockquote><span id="more"></span><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>国际化是指项目能够根据不同国家的语言进行转换，便于不同国家的用户使用。Vue I18 是 Vue.js 的国际化插件，它可以轻松地将一些本地化功能集成到应用程序中。</p><p><code>附录</code><br><a href="https://developer.aliyun.com/article/1266640">JavaScript 中的 i18n 基本概念</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（38-1）vue3项目换肤</title>
    <link href="/2024/05/27/vue3%E7%AC%94%E8%AE%B0%EF%BC%8838-1%EF%BC%89vue3%E9%A1%B9%E7%9B%AE%E6%8D%A2%E8%82%A4/"/>
    <url>/2024/05/27/vue3%E7%AC%94%E8%AE%B0%EF%BC%8838-1%EF%BC%89vue3%E9%A1%B9%E7%9B%AE%E6%8D%A2%E8%82%A4/</url>
    
    <content type="html"><![CDATA[<blockquote><p>新需求，项目需要换肤和多语言支持。本篇介绍如何在vue3项目中实现换肤功能。</p></blockquote><span id="more"></span><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>通常，前端一键换肤功能需要通过使用 CSS 样式表来定义不同的主题样式，然后通过 JavaScript 来控制切换不同的样式表，以达到换肤的效果。用户在点击换肤按钮或者选择不同的主题选项后，页面会立即应用新的样式，从而改变界面的外观。这种功能在很多网站、应用中都有广泛的应用，特别是一些内容丰富、用户群体广泛的平台，以满足不同用户对于外观风格的偏好。</p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>切换主题和皮肤，主要是背景色、字体颜色的替换。分别设置黑暗和明亮两个主题文件夹，当触发主题变化时，调用不同的样式文件。<br>当前项目中，文件结构如下：<br>|– assets&#x2F;scss<br>    |– dark<br>        |– index.scss<br>        |– element-variables.scss<br>    |– light<br>        |– index.scss<br>        |– element-variables.scss<br>    |– common.scss<br>    |– common-ev.scss<br>    |– transition.scss</p><p>其中，<code>common.scss</code> 用于全局样式，<code>common-ev.scss</code>用于全局 element 组件样式修改配置，<code>transition.scss</code> 用于动画效果。dark 和 light 目录下分别存放了黑暗和明亮主题样式和变量文件。<code>index.scss</code> 用于主题样式，<code>element-variables.scss</code>  用于对应主题 element 组件特殊配置。</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol><li><p>分别按照设计图设置黑暗和明亮主题的颜色，在 dark 文件下的所有样式都用 <code>.dark</code> 作为最外层包裹。</p><figure class="highlight scss"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scss"><span class="hljs-selector-class">.dark</span> &#123;<br>  <span class="hljs-selector-pseudo">:root</span> &#123;<br>    <span class="hljs-attr">--el-text-color-primary</span>: <span class="hljs-number">#ffffff</span>;<br>    <span class="hljs-attr">--el-text-color-regular</span>: <span class="hljs-number">#ffffff</span>;<br>    <span class="hljs-attr">--el-table-text-color</span>: <span class="hljs-number">#ffffff</span>;<br>  &#125;<br>  <span class="hljs-selector-class">.el-table</span> &#123;<br>    <span class="hljs-attr">--el-table-header-text-color</span>: rgba(<span class="hljs-number">173</span>, <span class="hljs-number">202</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.8</span>) <span class="hljs-meta">!important</span>;<br>    <span class="hljs-attr">--el-table-header-bg-color</span>: <span class="hljs-number">#2a3144</span> <span class="hljs-meta">!important</span>;<br>    <span class="hljs-attr">--el-table-row-hover-bg-color</span>: <span class="hljs-number">#1f202f</span> <span class="hljs-meta">!important</span>;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>分别在<code>index.scss</code>中引入对应的主题变量</p><figure class="highlight scss"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scss"><span class="hljs-keyword">@use</span> <span class="hljs-string">&#x27;./element-variables.scss&#x27;</span> as *;<br></code></pre></div></td></tr></table></figure><p><code>common.scss</code>中引入其他全局样式文件</p><figure class="highlight scss"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scss"><span class="hljs-keyword">@use</span> <span class="hljs-string">&#x27;./common-ev.scss&#x27;</span> as *;<br><span class="hljs-keyword">@use</span> <span class="hljs-string">&#x27;./transition.scss&#x27;</span> as *;<br></code></pre></div></td></tr></table></figure><p>在<code>main.ts</code>中引入通用样式文件和两个主题样式文件。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;@/assets/scss/common.scss&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;@/assets/scss/dark/index.scss&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;@/assets/scss/light/index.scss&#x27;</span><br></code></pre></div></td></tr></table></figure></li><li><p><code>App.vue</code>中初始化主题，本项目初始化为明亮。主题色会影响到全局样式（侧栏导航）和element组件样式（el-tabs、el-tabs、el-pagination）。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; handleBackgroundStyle, handleThemeStyle &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils/theme&#x27;</span><br><br><span class="hljs-title function_">handleBackgroundStyle</span>([<span class="hljs-string">&#x27;#EEEEEE&#x27;</span>, <span class="hljs-string">&#x27;#cccccc&#x27;</span>, <span class="hljs-string">&#x27;#bbbbbb&#x27;</span>])<br><span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-string">&#x27;#2196f3&#x27;</span>)<br><br></code></pre></div></td></tr></table></figure><p><code>/utils/theme.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 处理背景色</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleBackgroundStyle</span>(<span class="hljs-params">background: any</span>) &#123;<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">&#x27;--el-bg-color&#x27;</span>, background[<span class="hljs-number">0</span>])<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">&#x27;--el-bg-color-1&#x27;</span>, background[<span class="hljs-number">1</span>])<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">&#x27;--el-bg-color-2&#x27;</span>, background[<span class="hljs-number">2</span>])<br>&#125;<br><br><span class="hljs-comment">// 处理主题样式</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-params">theme: any</span>) &#123;<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">&#x27;--el-color-primary&#x27;</span>, theme)<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>document.documentElement</code>代表的是文档对象模型（DOM）中的根元素，即 HTML 文档中的元素。<code>style.setProperty</code>用于在 JavaScript 中设置元素样式。 具体来说，<code>document.documentElement.style.setProperty</code> 方法可以用于动态地设置根元素的 CSS 样式属性。它接受两个参数：<br>属性名： 第一个参数是要设置的 CSS 属性名称，例如 “color”, “font-size”, “background-color” 等等。<br>属性值： 第二个参数是要为属性设置的值，可以是字符串或者变量，表示对应样式属性的值。<br>这种方法可以用于动态改变页面的整体样式，在实现一键换肤功能时非常有用。通过 JavaScript 动态地调用<code>setProperty</code>方法，可以实现在用户操作后改变整个页面的外观，从而实现换肤的效果。</p></li><li><p>设置一个按钮，点击切换主题。通过在body标签上添加class&#x3D;“dark”或“”来切换主题。<br><code>layout/components/navbar/ThemeSwitch.vue</code></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">button</span></span><br><span class="hljs-tag">    <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;switch&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">aria-label</span>=<span class="hljs-string">&quot;切换深色模式&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">aria-checked</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;toggleDarkMode&quot;</span></span><br><span class="hljs-tag">  &gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; handleBackgroundStyle, handleThemeStyle &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/theme&#x27;</span></span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleDarkMode</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> body = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> classValue = body.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>)</span><br><span class="language-javascript">  <span class="hljs-keyword">if</span> (classValue === <span class="hljs-string">&#x27;dark&#x27;</span>) &#123;</span><br><span class="language-javascript">    body.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-title function_">handleBackgroundStyle</span>([<span class="hljs-string">&#x27;#EEEEEE&#x27;</span>, <span class="hljs-string">&#x27;#cccccc&#x27;</span>, <span class="hljs-string">&#x27;#000000&#x27;</span>])</span><br><span class="language-javascript">    <span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-string">&#x27;#000000&#x27;</span>)</span><br><span class="language-javascript">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="language-javascript">    body.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;dark&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-title function_">handleBackgroundStyle</span>([<span class="hljs-string">&#x27;#151723&#x27;</span>, <span class="hljs-string">&#x27;#2a3144&#x27;</span>, <span class="hljs-string">&#x27;#313955&#x27;</span>])</span><br><span class="language-javascript">    <span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-string">&#x27;#ff7f02&#x27;</span>)</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li><li><p>其他替换项目<br>（1）所有的按钮图标需要替换，深色模式为白色，明亮模式为黑色。<br>（2）tooltip、dialog、message等组件的样式需要替换。.el-button–primary<br>（3）图表颜色替换。components&#x2F;echart&#x2F;src&#x2F;template&#x2F;index.ts 中，修改getEchartsColor判断</p></li></ol><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>每次点击时切换主题，同时要在页面刷新时保持原有主题，所以我们做一个简单的缓存优化。<br><code>utils/cookie.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> themeKey = <span class="hljs-string">`<span class="hljs-subst">$&#123;casdoor.appName&#125;</span>-theme`</span><br><span class="hljs-comment">// 设置主题</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setTheme</span> = (<span class="hljs-params">theme: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> expires = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() + <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)<br>  <span class="hljs-keyword">if</span> (theme) <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(themeKey, theme, &#123; <span class="hljs-attr">expires</span>: expires &#125;)<br>&#125;<br><span class="hljs-comment">// 获取主题</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getTheme</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">get</span>(themeKey)<br></code></pre></div></td></tr></table></figure><p><code>src/store/modules/app.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useAppStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;app&#x27;</span>, &#123;<br>  <span class="hljs-attr">state</span>: (): <span class="hljs-function"><span class="hljs-params">IAppState</span> =&gt;</span> (&#123;<br>    <span class="hljs-attr">theme</span>: <span class="hljs-title function_">getTheme</span>() || <span class="hljs-string">&#x27;&#x27;</span><br>  &#125;),<br>  <span class="hljs-attr">getters</span>: &#123;<br>    <span class="hljs-title function_">getTheme</span>(): string &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">actions</span>: &#123;<br>    <span class="hljs-title function_">toggleTheme</span>(<span class="hljs-params">theme: string</span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span> = theme<br>      <span class="hljs-title function_">setTheme</span>(theme)<br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><code>layout/components/navbar/ThemeSwitch.vue</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useAppStoreWithOut &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store/modules/app&#x27;</span><br><br><span class="hljs-keyword">const</span> appStore = <span class="hljs-title function_">useAppStoreWithOut</span>()<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleDarkMode</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> body = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span><br>  <span class="hljs-keyword">const</span> classValue = body.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (classValue === <span class="hljs-string">&#x27;dark&#x27;</span>) &#123;<br>    appStore.<span class="hljs-title function_">toggleTheme</span>(<span class="hljs-string">&#x27;light&#x27;</span>)<br>    body.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-title function_">handleBackgroundStyle</span>([<span class="hljs-string">&#x27;#EEEEEE&#x27;</span>, <span class="hljs-string">&#x27;#cccccc&#x27;</span>, <span class="hljs-string">&#x27;#bbbbbb&#x27;</span>])<br>    <span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-string">&#x27;#2196f3&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    appStore.<span class="hljs-title function_">toggleTheme</span>(<span class="hljs-string">&#x27;dark&#x27;</span>)<br>    body.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;dark&#x27;</span>)<br>    <span class="hljs-title function_">handleBackgroundStyle</span>([<span class="hljs-string">&#x27;#151723&#x27;</span>, <span class="hljs-string">&#x27;#2a3144&#x27;</span>, <span class="hljs-string">&#x27;#313955&#x27;</span>])<br>    <span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-string">&#x27;#ff7f02&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>App.vue</code>中从缓存中获取初始化主题。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; handleBackgroundStyle, handleThemeStyle &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils/theme&#x27;</span><br><br><span class="hljs-keyword">const</span> appStore = <span class="hljs-title function_">useAppStoreWithOut</span>()<br><span class="hljs-keyword">const</span> currentTheme = appStore.<span class="hljs-property">theme</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;currentTheme=&#x27;</span>, currentTheme)<br><span class="hljs-keyword">const</span> body = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span><br><span class="hljs-keyword">if</span> (currentTheme === <span class="hljs-string">&#x27;dark&#x27;</span>) &#123;<br>  body.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;dark&#x27;</span>)<br>  <span class="hljs-title function_">handleBackgroundStyle</span>([<span class="hljs-string">&#x27;#151723&#x27;</span>, <span class="hljs-string">&#x27;#2a3144&#x27;</span>, <span class="hljs-string">&#x27;#313955&#x27;</span>])<br>  <span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-string">&#x27;#ff7f02&#x27;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  body.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>  <span class="hljs-title function_">handleBackgroundStyle</span>([<span class="hljs-string">&#x27;#EEEEEE&#x27;</span>, <span class="hljs-string">&#x27;#cccccc&#x27;</span>, <span class="hljs-string">&#x27;#bbbbbb&#x27;</span>])<br>  <span class="hljs-title function_">handleThemeStyle</span>(<span class="hljs-string">&#x27;#2196f3&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ol><li><p>echarts 图表在切换主题时需要重绘，这里尝试了<code>components/echart/src/echart.vue</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">watch</span>(<br>  <span class="hljs-function">() =&gt;</span> appStore.<span class="hljs-property">theme</span>,<br>  <span class="hljs-function">(<span class="hljs-params">theme</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">initChart</span>(theme) <br>  &#125;<br>)<br></code></pre></div></td></tr></table></figure><p>没有成功，感觉这个theme和颜色不是同一个。</p></li><li><p>在<code>components/echart/src/template/index.ts</code>中，观察 theme 变化，修改<code>getEchartsColor</code>判断，切换主题时，图表颜色也会变化。但是仔细一看，变化只是跟着背景变了，实际的颜色配置还是没获取成功。。。原因是图表色卡或者失败。。。<br>若将 lineOptions: any &#x3D; ref({})，colors.value 改变时，背景颜色无法跟着变。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> colors = ref&lt;<span class="hljs-title class_">EchartsTheme</span>&gt;()<br><span class="hljs-title function_">watch</span>(<br>  <span class="hljs-function">() =&gt;</span> appStore.<span class="hljs-property">theme</span>,<br>  <span class="hljs-function">(<span class="hljs-params">theme</span>) =&gt;</span> &#123;<br>    colors.<span class="hljs-property">value</span> = <span class="hljs-title function_">getEchartsColor</span>(theme === <span class="hljs-string">&#x27;dark&#x27;</span>)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>      colors.<span class="hljs-property">value</span>.<span class="hljs-property">bgColor</span>,<br>      lineOptions.<span class="hljs-property">value</span>.<span class="hljs-property">backgroundColor</span><br>    ) <span class="hljs-comment">// 颜色变化，但是背景颜色没有变化</span><br>  &#125;<br>)<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="按需加载"><a href="#按需加载" class="headerlink" title="按需加载"></a>按需加载</h3><p>对于需要按需加载的项目，尝试直接将<code>dark</code>和<code>light</code>文件夹引入，原<code>vite.config.ts</code>配置如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-attr">css</span>: &#123;<br>      <span class="hljs-attr">preprocessorOptions</span>: &#123;<br>        <span class="hljs-attr">scss</span>: &#123;<br>          <span class="hljs-attr">additionalData</span>: <span class="hljs-string">`@import &quot;@/assets/scss/index.scss&quot;;`</span><br>        &#125;<br>      &#125;<br>    &#125;<br></code></pre></div></td></tr></table></figure><p>执行后，有如下报错<code>[sass] This module was already loaded, so it can&#39;t be configured using &quot;with&quot;.</code><br>当只引入一个文件夹内容时，报错消失，初步判断是有重复调用。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li>为了避免后期改动麻烦，建议在项目初始阶段（或任一新模块开发初期）就按照配色规范来编写 css 代码。</li><li>避免在 html 中直接编写 style&#x3D;”” 此类代码，以防止后期修改样式时出现问题。</li><li>模块中尽量不写和颜色相关的 !important，以防止样式修改时造成意想不到的问题。</li></ol><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><br>:root &#123;<br>  --el-color-<span class="hljs-attr">primary</span>: #ff7f02;<br>&#125;<br><br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://juejin.cn/post/7155439519204900900#">vue3如何实现换肤效果（精简版）</a><br><a href="https://cloud.tencent.com/developer/article/2401315#">两种最简单的方式教会你如何实现前端一键换肤！</a><br><a href="https://juejin.cn/post/6844903672162304013">CSS — BEM 命名规范</a><br><a href="https://element-plus.org/zh-CN/guide/theming.html">element-plus 主题色配置</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JS回顾笔记（1）内置对象</title>
    <link href="/2024/03/27/JS%E5%9B%9E%E9%A1%BE%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1/"/>
    <url>/2024/03/27/JS%E5%9B%9E%E9%A1%BE%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>接收代码时发现了一些以前没用过的写法，查阅后发现是一些内置对象，这篇记录一下 JS 内置对象。</p></blockquote><span id="more"></span><h3 id="函数属性"><a href="#函数属性" class="headerlink" title="函数属性"></a>函数属性</h3><p>全局函数可以直接调用，不需要在调用时指定所属对象，执行结束后会将结果直接返回给调用者。<br>isFinite()<br>isNaN()<br>parseFloat() 解析一个参数（必要时先转换为字符串）并返回一个浮点数。<br>parseInt(string, radix) 解析一个字符串并返回指定基数的十进制整数，radix 是 2-36 之间的整数，表示被解析字符串的基数。<br>encodeURIComponent() 函数通过将特定字符的每个实例替换成代表字符的 UTF-8 编码的一个、两个、三个或四个转义序列来编码 URI（只有由两个“代理”字符组成的字符会被编码为四个转义序列）。与 encodeURI() 相比，此函数会编码更多的字符，包括 URI 语法的一部分。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> uri = <span class="hljs-string">&#x27;https://mozilla.org/?x=шеллы&#x27;</span>;<br><span class="hljs-keyword">const</span> encoded = <span class="hljs-built_in">encodeURI</span>(uri) <span class="hljs-comment">// 对?后进行编码</span><br><span class="hljs-keyword">const</span> a = <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-string">&#x27;test&#x27;</span>)<br><span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">// 对编码后的字符串进行解码</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">decodeURI</span>(encoded)) <br>&#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="基本对象"><a href="#基本对象" class="headerlink" title="基本对象"></a>基本对象</h3><p>基本对象是定义或使用其他对象的基础，包括：Object、Function、Boolean、Symbol</p><h3 id="错误对象"><a href="#错误对象" class="headerlink" title="错误对象"></a>错误对象</h3><p>错误对象是一种特殊的基本对象。它们拥有基本的 Error 类型，同时也有多种具体的错误类型，包括：Error、AggregateError、EvalError、RangeError、ReferenceError、SyntaxError、TypeError、URIError</p><h3 id="数字和日期对象"><a href="#数字和日期对象" class="headerlink" title="数字和日期对象"></a>数字和日期对象</h3><p>用来表示数字、日期和执行数学计算的对象。包括：Number、BigInt、Math、Date。<br>BigInt 可以表示任意大的整数。用 Number 表示的最大数字 2^53 - 1，大于这个数值可以用 BigInt 表示。</p><h3 id="字符串对象"><a href="#字符串对象" class="headerlink" title="字符串对象"></a>字符串对象</h3><p>用来表示和操作文本的对象。包括：String、RegExp。</p><h3 id="可索引的集合对象"><a href="#可索引的集合对象" class="headerlink" title="可索引的集合对象"></a>可索引的集合对象</h3><p>这些对象表示按照索引值来排序的数据集合，包括数组和类型数组，以及类数组结构的对象。包括：Array、Int8Array、Uint8Array、Uint8ClampedArray、Int16Array、Uint16Array、Int32Array、Uint32Array、Float32Array、Float64Array、BigInt64Array、BigUint64Array</p><h3 id="使用键的集合对象"><a href="#使用键的集合对象" class="headerlink" title="使用键的集合对象"></a>使用键的集合对象</h3><p>这些集合对象在存储数据时会使用到键，包括可迭代的 Map 和 Set，支持<code>按照插入顺序</code>来迭代元素。另有 WeakMap、WeakSet 两个特殊的集合对象。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()<br>map1.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">1</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map1.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;a&#x27;</span>), map1.<span class="hljs-property">size</span>, map1.<span class="hljs-title function_">has</span>(<span class="hljs-string">&#x27;a&#x27;</span>)) <span class="hljs-comment">// 1, 1, true</span><br>map1.<span class="hljs-title function_">delete</span>(<span class="hljs-string">&#x27;a&#x27;</span>)<br></code></pre></div></td></tr></table></figure><h3 id="结构化数据对象"><a href="#结构化数据对象" class="headerlink" title="结构化数据对象"></a>结构化数据对象</h3><p>这些对象用来表示和操作结构化的缓冲区数据，或使用 JSON（JavaScript Object Notation）编码的数据。包括：<br>ArrayBuffer：用来表示通用的原始二进制数据缓冲区，不能直接操作，需要通过类型化数组对象或 DataView 对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。<br>SharedArrayBuffer：用来表示通用的原始二进制数据缓冲区，不是可转移对象。<br>Atomics：命名空间对象包含对 SharedArrayBuffer 和 ArrayBuffer 对象执行原子操作的静态方法。<br>DataView：是一个可以从二进制 ArrayBuffer 对象中读写多种数值类型的底层接口，使用它时，不用考虑不同平台的字节序（endianness）问题。<br>JSON：将值转换为 JSON 字符串的静态方法。不是一个构造函数。不能将它与 new 运算符 一起使用。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> littleEndian = (<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer).<span class="hljs-title function_">setInt16</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int16Array</span>(buffer)[<span class="hljs-number">0</span>] === <span class="hljs-number">256</span>;<br>&#125;)();<br></code></pre></div></td></tr></table></figure><h3 id="内存管理对象"><a href="#内存管理对象" class="headerlink" title="内存管理对象"></a>内存管理对象</h3><p>这些对象会与垃圾回收机制产生交互。包括：WeakRef、FinalizationRegistr</p><h3 id="控制抽象对象"><a href="#控制抽象对象" class="headerlink" title="控制抽象对象"></a>控制抽象对象</h3><p>控件抽象对象可以帮助构造代码，尤其是异步代码（例如不使用深度嵌套的回调）。例如：Iterator、AsyncIterator、Promise、GeneratorFunction、AsyncGeneratorFunction、Generator、AsyncGenerator、AsyncFunction。</p><h3 id="反射对象"><a href="#反射对象" class="headerlink" title="反射对象"></a>反射对象</h3><p>包括：Reflect、Proxy。</p><h3 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h3><p>ECMAScript 核心的附加功能，用于支持多语言处理。例如：Intl<br>Intl 对象是 ECMAScript 国际化 API 的一个命名空间，它提供了精确的字符串对比、数字格式化，和日期时间格式化。Collator，NumberFormat 和 DateTimeFormat 对象的构造函数是 Intl 对象的属性。本页文档内容包括了这些属性，以及国际化使用的构造器和其他语言的方法等常见的功能。</p><h3 id="原始值"><a href="#原始值" class="headerlink" title="原始值"></a>原始值</h3><p>原始值（原始数据类型）是一种<code>既非对象也无方法或属性</code>的数据。有 7 种原始数据类型：string、number、bigint、boolean、undefined、symbol、null。<br>当在原始值上访问属性时，JavaScript 自动将值装入包装对象中，并访问该对象上的属性。</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（9）编程模式</title>
    <link href="/2024/03/01/Go%E7%AC%94%E8%AE%B0%EF%BC%889%EF%BC%89%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F/"/>
    <url>/2024/03/01/Go%E7%AC%94%E8%AE%B0%EF%BC%889%EF%BC%89%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录编程模式。包含反射编程、不安全编程。</p></blockquote><span id="more"></span><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>• reflect.TypeOf 返回类型 (reflect.Type)<br>• reflect.ValueOf 返回值 (reflect.Value)<br>• 可以从 reflect.Value 获得类型<br>• 通过 Kind 的来判断类型</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CheckType</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>t := reflect.TypeOf(v)<br><span class="hljs-keyword">switch</span> t.Kind() &#123; <span class="hljs-comment">// Kind返回类型的枚举</span><br><span class="hljs-keyword">case</span> reflect.Float32, reflect.Float64:<br>fmt.Println(<span class="hljs-string">&quot;Float&quot;</span>)<br><span class="hljs-keyword">case</span> reflect.Int, reflect.Int32, reflect.Int64:<br>fmt.Println(<span class="hljs-string">&quot;Integer&quot;</span>)<br><span class="hljs-keyword">default</span>:<br>fmt.Println(<span class="hljs-string">&quot;Unknown&quot;</span>, t)<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>• reflect.ValueOf(*e).FieldByName(“Name”) 按名字访问结构的成员<br>• reflect.ValueOf(e).MethodByName(“UpdateAge”).Call([]reflect.Value{reflect.ValueOf(1)}) 按名字访问结构的⽅法</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Employee <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`format:&quot;normal&quot;`</span> <span class="hljs-comment">// tag</span><br>&#125;<br>reflect.ValueOf(*e).FieldByName(<span class="hljs-string">&quot;Name&quot;</span>)<br><span class="hljs-comment">// TypeOf第一个返回值为field，第二个返回值为field是否存在</span><br><span class="hljs-keyword">if</span> nameField, ok := reflect.TypeOf(*e).FieldByName(<span class="hljs-string">&quot;Name&quot;</span>); !ok &#123;<br>    t.Error(<span class="hljs-string">&quot;Failed to get &#x27;Name&#x27; field.&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    t.Log(<span class="hljs-string">&quot;Tag:format&quot;</span>, nameField.Tag.Get(<span class="hljs-string">&quot;format&quot;</span>))<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="不安全编程"><a href="#不安全编程" class="headerlink" title="不安全编程"></a>不安全编程</h3><p>不能使用 unsafe 进行强制类型转换，合理的类型转换如下：</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyInt <span class="hljs-type">int</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestConvert</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>a := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;<br>b := *(*[]MyInt)(unsafe.Pointer(&amp;a))<br>t.Log(b)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>原子类型操作：适用于并发读写操作，为了线程安全，可以先写在另一块区域，完全写完之后利用原子操作，将 buffer 指向写完的内容。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAtomic</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">var</span> shareBufPtr unsafe.Pointer<br>writeDataFn := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>data := []<span class="hljs-type">int</span>&#123;&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>data = <span class="hljs-built_in">append</span>(data, i)<br>&#125;<br>atomic.StorePointer(&amp;shareBufPtr, unsafe.Pointer(&amp;data))<br>&#125;<br>readDataFn := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>data := atomic.LoadPointer(&amp;shareBufPtr)<br>fmt.Println(data, *(*[]<span class="hljs-type">int</span>)(data))<br>&#125;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>writeDataFn()<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>writeDataFn()<br>time.Sleep(time.Microsecond * <span class="hljs-number">100</span>)<br>&#125;<br>wg.Done()<br>&#125;()<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>readDataFn()<br>time.Sleep(time.Microsecond * <span class="hljs-number">100</span>)<br>&#125;<br>wg.Done()<br>&#125;()<br>&#125;<br>wg.Wait()<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（7）性能优化</title>
    <link href="/2024/02/29/Go%E7%AC%94%E8%AE%B0%EF%BC%887%EF%BC%89%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <url>/2024/02/29/Go%E7%AC%94%E8%AE%B0%EF%BC%887%EF%BC%89%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录 go 中的并发编程中的性能优化。buffered channel 对象池、sync.Pool。<br>安装使用性能分析工具。</p></blockquote><span id="more"></span><h3 id="对象池"><a href="#对象池" class="headerlink" title="对象池"></a>对象池</h3><p>对于创建时代价比较高的对象（如：网络连接），通常将对象进行池化以避免重复创建。<br>可以使用 buffered channel 实现对象池。采用 lock 机制，需要考虑同步机制对性能的影响，可用 benchmark 进行评估是否真的性能得到优化。<br>一般使用不同的池缓存不同类型的对象。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ReusableObj <span class="hljs-keyword">struct</span> &#123;&#125; <span class="hljs-comment">// 为了实例使用了空结构</span><br><br><span class="hljs-keyword">type</span> ObjPool <span class="hljs-keyword">struct</span> &#123;<br>bufChan <span class="hljs-keyword">chan</span> *ReusableObj <span class="hljs-comment">// 用于缓冲可重用对象</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewObjPool</span><span class="hljs-params">(numOfObj <span class="hljs-type">int</span>)</span></span> *ObjPool &#123;<br>objPool := ObjPool&#123;&#125;<br>objPool.bufChan = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *ReusableObj, numOfObj) <span class="hljs-comment">// 创建对象池</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numOfObj; i++ &#123;<br>objPool.bufChan &lt;- &amp;ReusableObj&#123;&#125; <span class="hljs-comment">// 在对象池中加入结构（比如：连接，一些难以创建的对象）</span><br>&#125;<br><span class="hljs-keyword">return</span> &amp;objPool<br>&#125;<br><span class="hljs-comment">// 定义在对象池的指针上（创建时非必须，get时必须）</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *ObjPool)</span></span> GetObj(timeout time.Duration) (*ReusableObj, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> ret := &lt;-p.bufChan:<br><span class="hljs-keyword">return</span> ret, <span class="hljs-literal">nil</span><br><span class="hljs-keyword">case</span> &lt;-time.After(timeout): <span class="hljs-comment">// 超时控制</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;time out&quot;</span>)<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *ObjPool)</span></span> ReleaseObj(obj *ReusableObj) <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> p.bufChan &lt;- obj:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><span class="hljs-keyword">default</span>: <span class="hljs-comment">// 无法放入对象池（如：超出size），产生阻塞</span><br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;overflow&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestObjPool</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>pool := NewObjPool(<span class="hljs-number">10</span>)<br><span class="hljs-comment">// if err := pool.ReleaseObj(&amp;ReusableObj&#123;&#125;); err != nil &#123; //尝试放置超出池大小的对象</span><br><span class="hljs-comment">// t.Error(err)</span><br><span class="hljs-comment">// &#125;</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">11</span>; i++ &#123;<br><span class="hljs-keyword">if</span> v, err := pool.GetObj(time.Second * <span class="hljs-number">1</span>); err != <span class="hljs-literal">nil</span> &#123;<br>t.Error(err)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%T\n&quot;</span>, v)<br><span class="hljs-keyword">if</span> err := pool.ReleaseObj(v); err != <span class="hljs-literal">nil</span> &#123;<br>t.Error(err)<br>&#125;<br>&#125;<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;Done&quot;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="sync-Pool"><a href="#sync-Pool" class="headerlink" title="sync.Pool"></a>sync.Pool</h3><p>进程中包含私有对象（协程安全）和共享池（协程不安全）。sync.Pool 对象获取顺序：</p><ol><li>尝试从私有对象获取</li><li>私有对象不存在，则从当前Processor 的共享池获取（需要 lock）</li><li>如果当前 Processor 共享池也是空的，那么就尝试去其他<br>Processor 的共享池获取</li><li>如果所有池都是空的，最后就用用户指定的 New 函数产生一个新的对象返回</li></ol><p>sync.Pool 对象的放回顺序：</p><ol><li>如果私有对象不存在则保存为私有对象</li><li>如果私有对象存在，放入当前 Processor 子池的共享池中</li></ol><p>sync.Pool 对象的生命周期<br>• GC 会清除 sync.pool 缓存的对象<br>• 对象的缓存有效期为下一次 GC 之前</p><p>sync.Pool 适合于通过复用，降低复杂对象的创建和 GC 代价；协程安全，会有锁的开销；生命周期受GC 影响，不适合于做连接池等，需自己管理生命周期的资源的池化。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSyncPool</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>pool := &amp;sync.Pool&#123;<br>New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">interface</span>&#123;&#125; &#123; <span class="hljs-comment">// 所有池都是空的，产生一个新的对象返回</span><br>fmt.Println(<span class="hljs-string">&quot;Create a new object.&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">100</span><br>&#125;,<br>&#125;<br>v := pool.Get().(<span class="hljs-type">int</span>)<br>fmt.Println(v)<br>pool.Put(<span class="hljs-number">3</span>)<br>runtime.GC() <span class="hljs-comment">//GC 会清除sync.pool中缓存的对象</span><br>v1, _ := pool.Get().(<span class="hljs-type">int</span>)<br>fmt.Println(v1)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="性能分析工具"><a href="#性能分析工具" class="headerlink" title="性能分析工具"></a>性能分析工具</h3><h4 id="文件输出"><a href="#文件输出" class="headerlink" title="文件输出"></a>文件输出</h4><p>适用于短时间批量运行、细粒度的程序。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 安装 graphviz </span><br>brew install graphviz<br><span class="hljs-comment"># 将 $GOPATH/bin 加⼊ $PATH (Mac: 在 .bash_profile 中修改路径)</span><br><span class="hljs-comment"># 安装 go-torch，1.11已内置 </span><br>go get github.com/uber/go-torch <br><span class="hljs-comment"># 下载并复制 flamegraph.pl （https://github.com/brendangregg/FlameGraph）⾄ $GOPATH/bin 路径下</span><br><span class="hljs-comment"># 将 $GOPATH/bin 加⼊ $PATH</span><br></code></pre></div></td></tr></table></figure><p>使用 pprof 进行交互式查看，cpu</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># go tool pprof 二进行文件名 生成的prof</span><br>go tool pprof prof cpu.prof<br>top<br>list ***<br>svg <span class="hljs-comment"># 生成一张图</span><br></code></pre></div></td></tr></table></figure><h4 id="通过-HTTP-方式输出-Profile"><a href="#通过-HTTP-方式输出-Profile" class="headerlink" title="通过 HTTP 方式输出 Profile"></a>通过 HTTP 方式输出 Profile</h4><p>适合于持续性运行的应用。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (_ <span class="hljs-string">&quot;net/http/pprof&quot;</span>)<br></code></pre></div></td></tr></table></figure><p>访问：http:&#x2F;&#x2F;<host>:<port>&#x2F;debug&#x2F;pprof&#x2F;</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">go tool pprof http://&lt;host&gt;:&lt;port&gt;/debug/pprof/profile?seconds=10 <span class="hljs-comment">#默认值为30秒</span><br>go-torch -seconds 10 http://&lt;host&gt;:&lt;port&gt;/debug/pprof/profile<br></code></pre></div></td></tr></table></figure><h3 id="性能调优过程"><a href="#性能调优过程" class="headerlink" title="性能调优过程"></a>性能调优过程</h3><p>设定优化目标-〉分析系统瓶颈点-〉优化瓶颈点</p><h4 id="常见分析指标"><a href="#常见分析指标" class="headerlink" title="常见分析指标"></a>常见分析指标</h4><p>• Wall Time：挂钟时间（函数运行的绝对时间，包括外部阻塞）<br>• CPU Time<br>• Block Time<br>• Memory allocation：内存分配<br>• GC times&#x2F;time spent：GC次数、GC耗时<br>可以通过笔记（1）中测试相关分析瓶颈。</p><h4 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h4><ol><li>减少 lock 使用，写多读少-ConcurrentMap，读多写少-sync.Map</li><li>复杂对象尽量传递引用（避免内存分配和复制）</li><li>切片初始化至合适大小</li></ol><p><code>附录</code><br><a href="https://golang.org/src/runtime/pprof/pprof.go">Go 支持的多种 Profile</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（8）服务</title>
    <link href="/2024/02/28/Go%E7%AC%94%E8%AE%B0%EF%BC%888%EF%BC%89%E6%9C%8D%E5%8A%A1/"/>
    <url>/2024/02/28/Go%E7%AC%94%E8%AE%B0%EF%BC%888%EF%BC%89%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录 go 中的服务。JSON的解析</p></blockquote><span id="more"></span><h3 id="JSON的解析"><a href="#JSON的解析" class="headerlink" title="JSON的解析"></a>JSON的解析</h3><h4 id="内置"><a href="#内置" class="headerlink" title="内置"></a>内置</h4><p>反射：适用于配置文件的解析，定义一个结构：<br><code>struct_def.go</code></p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> BasicInfo <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>Age  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>&#125;<br><span class="hljs-keyword">type</span> JobInfo <span class="hljs-keyword">struct</span> &#123;<br>Skills []<span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;skills&quot;`</span><br>&#125;<br><span class="hljs-keyword">type</span> Employee <span class="hljs-keyword">struct</span> &#123;<br>BasicInfo BasicInfo <span class="hljs-string">`json:&quot;basic_info&quot;`</span><br>JobInfo   JobInfo   <span class="hljs-string">`json:&quot;job_info&quot;`</span><br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">var</span> jsonStr = <span class="hljs-string">`&#123;</span><br><span class="hljs-string">&quot;basic_info&quot;:&#123;</span><br><span class="hljs-string">  &quot;name&quot;:&quot;Mike&quot;,</span><br><span class="hljs-string">&quot;age&quot;:30</span><br><span class="hljs-string">&#125;,</span><br><span class="hljs-string">&quot;job_info&quot;:&#123;</span><br><span class="hljs-string">&quot;skills&quot;:[&quot;Java&quot;,&quot;Go&quot;,&quot;C&quot;]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#125;`</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestEmbeddedJson</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>e := <span class="hljs-built_in">new</span>(Employee)<br>err := json.Unmarshal([]<span class="hljs-type">byte</span>(jsonStr), e)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>t.Error(err)<br>&#125;<br>fmt.Println(*e)<br><span class="hljs-keyword">if</span> v, err := json.Marshal(e); err == <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-type">string</span>(v))<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>t.Error(err)<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="easyJSON"><a href="#easyJSON" class="headerlink" title="easyJSON"></a>easyJSON</h4><p>最高效的JSON解析方式，提升性能</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">go get -u github.com/mailru/easyjson/...<br>~/go/bin/easyjson -all struct_def.go<br><span class="hljs-comment"># 执行完之后在package中根据结构自动生成代码</span><br></code></pre></div></td></tr></table></figure><h3 id="http-服务"><a href="#http-服务" class="headerlink" title="http 服务"></a>http 服务</h3><ol><li>路由规则：<br>• URL 分为两种，末尾是 &#x2F;：表示⼀个⼦树，后⾯可以跟其他⼦路径；末尾不是 &#x2F;，表示⼀个叶⼦，固定的路径<br>• 以 &#x2F; 结尾的 URL 可以匹配它的任何⼦路径，⽐如 &#x2F;images 会匹配 &#x2F;images&#x2F;***.jpg<br>• 它采⽤最⻓匹配原则，如果有多个匹配，⼀定采⽤匹配路径最⻓的那个进⾏处理<br>• 如果没有找到任何匹配项，会返回 404 错误<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>http.HandleFunc(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>fmt.Fprintf(w, <span class="hljs-string">&quot;Hello World!&quot;</span>)<br>&#125;)<br>http.HandleFunc(<span class="hljs-string">&quot;/time/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>t := time.Now()<br>timeStr := fmt.Sprintf(<span class="hljs-string">&quot;&#123;\&quot;time\&quot;: \&quot;%s\&quot;&#125;&quot;</span>, t)<br>w.Write([]<span class="hljs-type">byte</span>(timeStr))<br>&#125;)<br>http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, <span class="hljs-literal">nil</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="Restful-服务"><a href="#Restful-服务" class="headerlink" title="Restful 服务"></a>Restful 服务</h3><p>安装 httprouter 包</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">go get https://github.com/julienschmidt/httprouter<br></code></pre></div></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Index</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request, _ httprouter.Params)</span></span> &#123;<br>fmt.Fprint(w, <span class="hljs-string">&quot;Welcome!\n&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Hello</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request, ps httprouter.Params)</span></span> &#123;<br>fmt.Fprintf(w, <span class="hljs-string">&quot;hello, %s!\n&quot;</span>, ps.ByName(<span class="hljs-string">&quot;name&quot;</span>))<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>router := httprouter.New()<br>router.GET(<span class="hljs-string">&quot;/&quot;</span>, Index)<br>router.GET(<span class="hljs-string">&quot;/hello/:name&quot;</span>, Hello)<br>log.Fatal(http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, router))<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（6）并发编程</title>
    <link href="/2024/02/27/Go%E7%AC%94%E8%AE%B0%EF%BC%886%EF%BC%89%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    <url>/2024/02/27/Go%E7%AC%94%E8%AE%B0%EF%BC%886%EF%BC%89%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录 go 中的并发编程：协程机制、共享内存并发机制（lock、wait）、CSP、多路选择、超时机制、任务取消、并发任务执行once。</p></blockquote><span id="more"></span><h3 id="协程机制"><a href="#协程机制" class="headerlink" title="协程机制"></a>协程机制</h3><ol><li>协程（Groutine，默认stack 2K）是更轻量级的线程（Thread，默认stack 1M）</li><li>和 KSE（Kernel Space Entity，系统线程）的对应关系：<br> Thread 是 1:1；线程切换会涉及内核对象切换，消耗大<br> Groutine 是 M:N；利用系统线程高效完成并发任务</li><li>Go 中 channel 是有容量限制并且独立于处理 Groutine</li><li>向关闭的 channel 发送数据，会导致 panic（panic:send on closed channel）<br>V, ok &lt;-ch; ok 为 bool 值，true&#x2F;表示正常接受，false 表示通道关闭</li><li>所有的 channel 接收者都会在 channel 关闭时，立刻从阻塞等待中返回且（ok&#x3D;false）。这个广播机制常被利用，进行向多个订阅者同时发送信号。（如：退出信号。）</li><li>Context<br>• 根 Context：通过 context.Background()创建<br>• 子 Context:context.WithCancel(parentContext)创建<br> ctx, cancel :&#x3D; context.WithCancel(context.Background())<br>• 当前 context 被取消时，基于他的子 context 都会被取消<br>• 接收取消通知 ＜-ctx.Done</li><li>buffered channel 防止协程泄漏，适用于任何任务完成；</li></ol><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><p>func 前面加上 go，表示启用协程机制。<br>协程调用的顺序并不是方法的顺序（和协程调用机制有关）。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGroutine</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>fmt.Println(i) <span class="hljs-comment">// 每次调用输出值不一样</span><br>&#125;(i) <span class="hljs-comment">// 方法调用为值传递，传递i的同时，值被复制了一份，每个协程拥有的i的地址是不一样的</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">        不能采用以下写法，会输出相同的值。因为内存共享</span><br><span class="hljs-comment">        go func() &#123;</span><br><span class="hljs-comment">fmt.Println(i)</span><br><span class="hljs-comment">&#125;(i)</span><br><span class="hljs-comment">        */</span><br>&#125;<br>time.Sleep(time.Millisecond * <span class="hljs-number">50</span>) <span class="hljs-comment">// 等待</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>共享内存保护</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCounterThreadSafe</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">var</span> mut sync.Mutex<br>counter := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++ &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>mut.Unlock() <span class="hljs-comment">// 锁释放</span><br>&#125;()<br>mut.Lock()<br>counter++<br>&#125;()<br>&#125;<br>time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// (优化1)防止结果错误：外面协程执行的速度超过了所有协程执行完的速度</span><br>t.Logf(<span class="hljs-string">&quot;counter = %d&quot;</span>, counter)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>等待机制<br>只有 wait 的所有内容都完成之后（每个协程的都执行完），才能继续往下执行。优化1的更好写法。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCounterWaitGroup</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">var</span> mut sync.Mutex<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>counter := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>) <span class="hljs-comment">// 新增一个等待</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>mut.Unlock()<br>&#125;()<br>mut.Lock()<br>counter++<br>wg.Done() <span class="hljs-comment">// 等待完成了</span><br>&#125;()<br>&#125;<br>wg.Wait()<br>t.Logf(<span class="hljs-string">&quot;counter = %d&quot;</span>, counter)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h3><p>CSP（Communicating Sequential Process）利用一个通道进行两个通信实体之间的协调。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">service</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br>time.Sleep(time.Millisecond * <span class="hljs-number">50</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Done&quot;</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">otherTask</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;working on something else&quot;</span>)<br>time.Sleep(time.Millisecond * <span class="hljs-number">100</span>)<br>fmt.Println(<span class="hljs-string">&quot;Task is done.&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AsyncService</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span> &#123; <span class="hljs-comment">// buffer channel不会阻塞</span><br><span class="hljs-comment">// make(chan string, 1)声明buffer channel；make(chan string, 1)声明channel</span><br>retCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// make声明方式同slice,map</span><br><span class="hljs-comment">//retCh := make(chan string, 1)</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ret := service()<br>fmt.Println(<span class="hljs-string">&quot;returned result.&quot;</span>)<br>retCh &lt;- ret <span class="hljs-comment">// 往channel里面放数据</span><br>fmt.Println(<span class="hljs-string">&quot;service exited.&quot;</span>)<br>&#125;()<br><span class="hljs-keyword">return</span> retCh<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAsynService</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>retCh := AsyncService()<br>otherTask()<br>fmt.Println(&lt;-retCh) <span class="hljs-comment">// 从channel里面取数据</span><br>time.Sleep(time.Second * <span class="hljs-number">1</span>)<br>&#125; <br><span class="hljs-comment">/** </span><br><span class="hljs-comment">执行结果如下：</span><br><span class="hljs-comment">working on something else</span><br><span class="hljs-comment">returned result.</span><br><span class="hljs-comment">service exited.</span><br><span class="hljs-comment">Task is done.</span><br><span class="hljs-comment">Done</span><br><span class="hljs-comment">*/</span><br></code></pre></div></td></tr></table></figure><p>猜想使用场景：如果不确定程序的执行时间，但是需要使用其返回值，可以通过channel作为中转，存放在channel中，需要时取出。</p><h3 id="多路选择-amp-超时机制"><a href="#多路选择-amp-超时机制" class="headerlink" title="多路选择 &amp; 超时机制"></a>多路选择 &amp; 超时机制</h3><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAsynService</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> retCh := AsyncService():<br>t.Log(retCh)<br><span class="hljs-keyword">case</span> &lt;= time.After(time.Millisecond * <span class="hljs-number">100</span>)<br>t.Error(<span class="hljs-string">&quot;time out&quot;</span>)<br>&#125;<br>&#125; <br></code></pre></div></td></tr></table></figure><h3 id="chanel-取消"><a href="#chanel-取消" class="headerlink" title="chanel 取消"></a>chanel 取消</h3><h4 id="close机制"><a href="#close机制" class="headerlink" title="close机制"></a>close机制</h4><p>close 是广播机制的，所有 chanel 都会被取消。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isCancelled</span><span class="hljs-params">(cancelChan <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;- cancelChan: <span class="hljs-comment">// 从cancelChan收到消息，说明应该被取消</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br><span class="hljs-keyword">default</span>: <span class="hljs-comment">// 被阻塞，没有被取消</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><span class="hljs-comment">// 仅代表随意传入一个值，此时仅有一个channel被取消</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">cancel_1</span><span class="hljs-params">(cancelChan <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br>cancelChan &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>&#125;<br><span class="hljs-comment">// 使用close机制</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">cancel_2</span><span class="hljs-params">(cancelChan <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-built_in">close</span>(cancelChan)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCancel</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>cancelChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123; <span class="hljs-comment">// 起5个channel</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>, cancelCh <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">if</span> isCancelled(cancelCh) &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>time.Sleep(time.Millisecond * <span class="hljs-number">5</span>)<br>&#125;<br>fmt.Println(i, <span class="hljs-string">&quot;Cancelled&quot;</span>)<br>&#125;(i, cancelChan)<br>&#125;<br>cancel_2(cancelChan)<br>time.Sleep(time.Second * <span class="hljs-number">1</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="关联任务的取消-context"><a href="#关联任务的取消-context" class="headerlink" title="关联任务的取消-context"></a>关联任务的取消-context</h4><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isCancelled</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCancel</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>ctx, cancel := context.WithCancel(context.Background())<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>, ctx context.Context)</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">if</span> isCancelled(ctx) &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>time.Sleep(time.Millisecond * <span class="hljs-number">5</span>)<br>&#125;<br>fmt.Println(i, <span class="hljs-string">&quot;Cancelled&quot;</span>)<br>&#125;(i, ctx)<br>&#125;<br>cancel()<br>time.Sleep(time.Second * <span class="hljs-number">1</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="once"><a href="#once" class="headerlink" title="once"></a>once</h3><p>单例模式</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Singleton <span class="hljs-keyword">struct</span> &#123;<br>data <span class="hljs-type">string</span><br>&#125;<br><span class="hljs-keyword">var</span> singleInstance *Singleton<br><span class="hljs-keyword">var</span> once sync.Once<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetSingletonObj</span><span class="hljs-params">()</span></span> *Singleton &#123;<br>once.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;Create Obj&quot;</span>)<br>singleInstance = <span class="hljs-built_in">new</span>(Singleton)<br>&#125;)<br><span class="hljs-keyword">return</span> singleInstance<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGetSingletonObj</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>obj := GetSingletonObj()<br>fmt.Printf(<span class="hljs-string">&quot;%X\n&quot;</span>, unsafe.Pointer(obj)) <span class="hljs-comment">// 输出的内存地址一样</span><br>wg.Done()<br>&#125;()<br>&#125;<br>wg.Wait()<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（5）可复用模块</title>
    <link href="/2024/02/26/Go%E7%AC%94%E8%AE%B0%EF%BC%885%EF%BC%89%E5%8F%AF%E5%A4%8D%E7%94%A8%E6%A8%A1%E5%9D%97/"/>
    <url>/2024/02/26/Go%E7%AC%94%E8%AE%B0%EF%BC%885%EF%BC%89%E5%8F%AF%E5%A4%8D%E7%94%A8%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录 go 中的可复用模块。<br>笔记（1）中有在初始阶段安装遇到问题的实验过程，本篇对模块详细解说。</p></blockquote><span id="more"></span><h3 id="package"><a href="#package" class="headerlink" title="package"></a>package</h3><ol><li>基本复⽤模块单元：以⾸字⺟⼤写来表明可被包外代码访问</li><li>在 main 被执⾏前，所有依赖的 package 的 init ⽅法都会被执⾏；不同包的 init 函数按照包导⼊的依赖关系决定执⾏顺序；每个包可以有多个 init 函数；包的每个源⽂件也可以有多个 init 函数</li><li>Go 未解决的依赖问题：同⼀环境下，不同项⽬使⽤同⼀包的不同版本；⽆法管理对包的特定版本的依赖</li><li>Go 1.5之后，vendor ⽬录被添加到除了 GOPATH 和 GOROOT 之外的依赖⽬录查找的解决⽅案。<br>查找依赖包路径的解决⽅案如下：<br>（1）当前包下的 vendor ⽬录<br>（2）向上级⽬录查找，直到找到 src 下的 vendor ⽬录<br>（3）在 GOPATH 下⾯查找依赖包<br>（4）在 GOROOT ⽬录下查找</li></ol><h3 id="本地依赖"><a href="#本地依赖" class="headerlink" title="本地依赖"></a>本地依赖</h3><p>本地依赖性需要操作环境变量，修改路径后需要重启IDE</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">vi ~/.bash_profile <br><span class="hljs-comment"># 修改path目录如下</span><br><span class="hljs-built_in">export</span> GOPATH=<span class="hljs-string">&quot;/Users/.../go:另一个地址&quot;</span><br></code></pre></div></td></tr></table></figure><p>Q: 出现问题，atom中GO111MODULE&#x3D;’off’，path也没有加上我在.bash_profile中添加的另一个路径。当我修改 GO111MODULE 时出现报错“go env -w GO111MODULE&#x3D;… does not override conflicting OS environment variable”，修改不成功。  </p><ol><li>GO111MODULE&#x3D;off，无模块支持，go命令行将不会支持module功能，寻找依赖包的方式将会沿用旧版本那种通过vendor目录或者GOPATH模式来查找。</li><li>GO111MODULE&#x3D;on，模块支持，go命令行会使用modules，而一点也不会去GOPATH目录下查找。</li><li>GO111MODULE&#x3D;auto，默认值，go命令行将会根据当前目录来决定是否启用module功能。这种情况下可以分为两种情形：<br> 当前目录在GOPATH&#x2F;src之外且该目录包含go.mod文件，开启模块支持。<br> 当前文件在包含go.mod文件的目录下面。<br>注：<br>在使用go modules时，GOPATH是无意义的，不过它还是会把下载的依赖存储在 $GOPATH&#x2F;pkg&#x2F;mod 中<br>也会把go install 的结果放在 $GOPATH&#x2F;bin 中。<br>当modules 功能启用时，依赖包的存放位置变更为$GOPATH&#x2F;pkg<br>允许同一个package多个版本并存，且多个项目可以共享缓存的module。</li></ol><h3 id="远程依赖"><a href="#远程依赖" class="headerlink" title="远程依赖"></a>远程依赖</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 获取远程依赖</span><br>go get<br><span class="hljs-comment"># 强制从⽹络更新远程依赖</span><br>go get -u <br></code></pre></div></td></tr></table></figure><h3 id="常⽤的依赖管理⼯具"><a href="#常⽤的依赖管理⼯具" class="headerlink" title="常⽤的依赖管理⼯具"></a>常⽤的依赖管理⼯具</h3><p>godep <a href="https://github.com/tools/godep">https://github.com/tools/godep</a><br>glide <a href="https://github.com/Masterminds/glide">https://github.com/Masterminds/glide</a><br>dep <a href="https://github.com/golang/dep">https://github.com/golang/dep</a></p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">brew install glide<br><span class="hljs-comment"># 初始化，生成 glide.yaml 文件，指定 package 版本</span><br>glide init <br><span class="hljs-comment"># 安装，生成 vendor 文件夹</span><br>glide install<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（4）错误处理</title>
    <link href="/2024/02/23/Go%E7%AC%94%E8%AE%B0%EF%BC%884%EF%BC%89%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/"/>
    <url>/2024/02/23/Go%E7%AC%94%E8%AE%B0%EF%BC%884%EF%BC%89%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录 go 中的错误处理：错误检测示例、panic &amp; recover。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>没有异常机制；error 类型实现了 error 接⼝；可以通过 errors.New 来快速创建错误实例。</li><li>提倡快速失败，错误检测放在前面。</li><li>panic ⽤于不可以恢复的错误，后面的代码不会执行，退出前会执⾏ defer 指定的内容（延迟函数，相当于finally）；os.Exit 退出时不会调⽤ defer 指定的函数，不输出当前调⽤栈信息。</li><li>recover 并不检测发生了什么错误，只是记录&#x2F;忽略，如果系统中某些核心资源消耗完了，强制恢复后系统依然无法正常工作，导致 health check 失效。</li></ol><h3 id="简单语法示例"><a href="#简单语法示例" class="headerlink" title="简单语法示例"></a>简单语法示例</h3><h4 id="error类"><a href="#error类" class="headerlink" title="error类"></a>error类</h4><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">var</span> LessThanTwoError = errors.New(<span class="hljs-string">&quot;n should be not less than 2&quot;</span>)<br><span class="hljs-keyword">var</span> LargerThenHundredError = errors.New(<span class="hljs-string">&quot;n should be not larger than 100&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetFibonacci</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> ([]<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, LessThanTwoError<br>&#125;<br><span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">100</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, LargerThenHundredError<br>&#125;<br>fibList := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">1</span>&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">2</span>; <span class="hljs-comment">/*短变量声明 := */</span> i &lt; n; i++ &#123;<br>fibList = <span class="hljs-built_in">append</span>(fibList, fibList[i<span class="hljs-number">-2</span>]+fibList[i<span class="hljs-number">-1</span>])<br>&#125;<br><span class="hljs-keyword">return</span> fibList, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGetFibonacci</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">if</span> v, err := GetFibonacci(<span class="hljs-number">1</span>); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> err == LessThanTwoError &#123;<br>fmt.Println(<span class="hljs-string">&quot;It is less.&quot;</span>)<br>&#125;<br>t.Error(err)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>t.Log(v)<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="panic-amp-recover"><a href="#panic-amp-recover" class="headerlink" title="panic &amp; recover"></a>panic &amp; recover</h4><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPanicVxExit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; <span class="hljs-comment">// 延迟函数，相当于finally，一定会执行。</span><br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;recovered from &quot;</span>, err)<br>&#125;<br>&#125;()<br><span class="hljs-built_in">panic</span>(errors.New(<span class="hljs-string">&quot;Something wrong!&quot;</span>)) <span class="hljs-comment">// panic程序异常中断，不可修复的错误。后面的代码不会执行。</span><br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（3）面向对象编程</title>
    <link href="/2024/02/23/Go%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/"/>
    <url>/2024/02/23/Go%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录面向对象编程的写法，类、接口、多态、不支持继承。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>接口定义对象之间的交互协议，go 接口为非入侵性，实现不依赖于接口定义；接口的定义可以包含在接口使用者包内。</li><li>面向对象的扩展一般通过复合或继承来实现，go 本身不支持继承。</li><li>空接⼝可以表示任何类型；通过断⾔来将空接⼝转换为制定类型。i, ok :&#x3D; p.(int) &#x2F;&#x2F; ok&#x3D;true时转换成功</li><li>Go 接⼝最佳实践：倾向于使⽤⼩的接⼝定义，很多接⼝只包含⼀个⽅法；较⼤的接⼝定义，可以由多个⼩接⼝定义组合⽽成；只依赖于必要功能的最⼩接⼝。</li></ol><h3 id="简单语法示例"><a href="#简单语法示例" class="headerlink" title="简单语法示例"></a>简单语法示例</h3><h4 id="类"><a href="#类" class="headerlink" title="类"></a>类</h4><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Employee <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// struct定义一个实例</span><br>Id   <span class="hljs-type">string</span><br>Name <span class="hljs-type">string</span><br>Age  <span class="hljs-type">int</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCreateEmployeeObj</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>e := Employee&#123;<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-number">20</span>&#125;<br>e1 := Employee&#123;Name: <span class="hljs-string">&quot;Mike&quot;</span>, Age: <span class="hljs-number">30</span>&#125;<br>e2 := <span class="hljs-built_in">new</span>(Employee) <span class="hljs-comment">// 返回指针</span><br>e2.Name = <span class="hljs-string">&quot;Rose&quot;</span><br>t.Logf(<span class="hljs-string">&quot;e is %T&quot;</span>, e) <span class="hljs-comment">// %T表示返回类型，encap.Employee,&amp;e-》*encap.Employee</span><br>t.Logf(<span class="hljs-string">&quot;e2 is %T&quot;</span>, e2) <span class="hljs-comment">// *encap.Employee</span><br>&#125;<br><span class="hljs-comment">// 若写为 func (e Employee) 在实例对应方法被调用时，实例的成员会进行值复制</span><br><span class="hljs-comment">// 为了避免内存拷贝一般采用以下方式</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Employee)</span></span> String() <span class="hljs-type">string</span> &#123; <br>fmt.Printf(<span class="hljs-string">&quot;Address is %x&quot;</span>, unsafe.Pointer(&amp;e.Name))<br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;ID:%s/Name:%s/Age:%d&quot;</span>, e.Id, e.Name, e.Age) <span class="hljs-comment">// 把方法绑定在实例上后，可以使用实例来访问封装的数据</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="接口-amp-多态"><a href="#接口-amp-多态" class="headerlink" title="接口 &amp; 多态"></a>接口 &amp; 多态</h4><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Code <span class="hljs-type">string</span> <span class="hljs-comment">// 类型定义别名</span><br><span class="hljs-keyword">type</span> Programmer <span class="hljs-keyword">interface</span> &#123; <span class="hljs-comment">// 类型接口</span><br>WriteHelloWorld() Code<br>&#125;<br><span class="hljs-comment">// struct代表实例，实现了Programmer</span><br><span class="hljs-comment">// 没有使用implements这种对实现的接口进行绑定</span><br><span class="hljs-keyword">type</span> GoProgrammer <span class="hljs-keyword">struct</span> &#123;&#125; <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *GoProgrammer)</span></span> WriteHelloWorld() Code &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fmt.Println(\&quot;Hello World\&quot;)&quot;</span><br>&#125;<br><span class="hljs-keyword">type</span> JavaProgrammer <span class="hljs-keyword">struct</span> &#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *JavaProgrammer)</span></span> WriteHelloWorld() Code &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;System.out.Println(\&quot;Hello World!\&quot;)&quot;</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writeFirstProgrammer</span><span class="hljs-params">(p Programmer)</span></span> &#123;<br>    fmt.Printf(<span class="hljs-string">&quot;%T %v\n&quot;</span>, p, p.WriteHelloWorld) <span class="hljs-comment">// %T输出实例的类型</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestClient</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>goProg := &amp;GoProgrammer&#123;&#125; <span class="hljs-comment">// 对应指针类型的实例</span><br>javaProg := <span class="hljs-built_in">new</span>(JavaProgrammer)<br>writeFirstProgram(goProg)<br>writeFirstProgram(javaProg)<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="继承的实现（本身不支持）"><a href="#继承的实现（本身不支持）" class="headerlink" title="继承的实现（本身不支持）"></a>继承的实现（本身不支持）</h4><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Pet <span class="hljs-keyword">struct</span> &#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Pet)</span></span> Speak() &#123;<br>fmt.Print(<span class="hljs-string">&quot;...&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Pet)</span></span> SpeakTo(host <span class="hljs-type">string</span>) &#123;<br>p.Speak()<br>fmt.Println(<span class="hljs-string">&quot; &quot;</span>, host)<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    扩展功能，可调用内部方法</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> &#123; p *Pet &#125; <span class="hljs-comment">// 扩展功能</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Dog)</span></span> Speak() &#123;<br>d.p.Speak() <span class="hljs-comment">// 调用内部方法</span><br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    匿名嵌套类型，不能当成继承来用，不支持访问子类的方法、数据，即不支持重载</span><br><span class="hljs-comment">    不支持LSP（子类交换原则，所有父类支持的场合可以把子类放进去）</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> &#123; Pet &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Dog)</span></span> Speak() &#123; <span class="hljs-comment">// 方法重载</span><br>fmt.Print(<span class="hljs-string">&quot;Wang!&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestDog</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>dog := <span class="hljs-built_in">new</span>(Dog) <span class="hljs-comment">// var dog Pet = new(Dog) 错误，go不支持显式类型转换</span><br>dog.SpeakTo(<span class="hljs-string">&quot;Chao&quot;</span>) <span class="hljs-comment">// 调用的Speak是父类的，不是子类重载的</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="空接口"><a href="#空接口" class="headerlink" title="空接口"></a>空接口</h4><p>空接口可以表示任意类型</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DoSomething</span><span class="hljs-params">(p <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-comment">// if i, ok := p.(int); ok &#123; // 传入的参数被断言为int类型</span><br><span class="hljs-comment">// fmt.Println(&quot;Integer&quot;, i)</span><br><span class="hljs-comment">// return</span><br><span class="hljs-comment">// &#125;</span><br><span class="hljs-keyword">switch</span> v := p.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-type">int</span>:<br>fmt.Println(<span class="hljs-string">&quot;Integer&quot;</span>, v)<br><span class="hljs-keyword">case</span> <span class="hljs-type">string</span>:<br>fmt.Println(<span class="hljs-string">&quot;String&quot;</span>, v)<br><span class="hljs-keyword">default</span>:<br>fmt.Println(<span class="hljs-string">&quot;Unknow Type&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestEmptyInterfaceAssertion</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>DoSomething(<span class="hljs-number">10</span>)<br>DoSomething(<span class="hljs-string">&quot;10&quot;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（2）数据类型</title>
    <link href="/2024/02/20/Go%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
    <url>/2024/02/20/Go%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录语法。包含数据类型，数组、切片、string、map、map实现set功能、函数。</p></blockquote><span id="more"></span><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><p><img src="/img/go-1.jpg" alt="基本数据类型"></p><ol><li>Go 语⾔不允许隐式类型转换，别名和原有类型也不能进⾏隐式类型转换。</li><li>类型的预定义值: math.MaxInt64, math.MaxFloat64, math.MaxUint32</li><li>不⽀持指针运算。</li><li>string 是值类型，其默认的初始化值为空字符串。string 是只读的 byte 切片，len(str)&#x3D;所包含的 byte 数。string 的 byte 数组可以存放任何数据。</li><li>函数可以有多个返回值，所有参数都是值传递（slice&#x2F;map&#x2F;channel会有传引用的错觉）</li><li>【解释5】切片本身是一个数据结构，背后对应一个数组，数据结构包含指向数组的指针，在传值的情况下，结构被复制到函数里，通过指针操作具体的值，操作的是同一块空间。</li><li>slice 只能和[], nil 比较；map 只能和 nil 比较。可以使用 relect.DeepEqual。</li></ol><h3 id="简单语法示例"><a href="#简单语法示例" class="headerlink" title="简单语法示例"></a>简单语法示例</h3><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go">a := [...]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125; <span class="hljs-comment">// 数组初始化</span><br>b := [<span class="hljs-number">2</span>][<span class="hljs-number">2</span>]<span class="hljs-type">int</span>&#123;&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>&#125;, &#123;<span class="hljs-number">3</span>,<span class="hljs-number">4</span>&#125;&#125; <span class="hljs-comment">//多维数组</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestArrayTravel</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>arr := [...]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125; <span class="hljs-comment">// [len]使用...自动识别数组长度</span><br><span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> arr3 &#123; <span class="hljs-comment">// _/idx 表示索引值，_表示并不关心这个值的结果，返回值占位</span><br>t.Log(e)<br>&#125;<br>    <span class="hljs-comment">// 相同维度的数组可以比较</span><br>    t.Log(arr[<span class="hljs-number">1</span>:<span class="hljs-built_in">len</span>(arr)]==arr[<span class="hljs-number">1</span>:]) <span class="hljs-comment">// true, 返回值均为[3,4,5]</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSlice</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>s := []<span class="hljs-type">int</span>&#123;&#125; <span class="hljs-comment">// 切片，容量可伸缩，只能和[], nil比较</span><br>    s2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">//len=3，默认初始化为0</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>s = <span class="hljs-built_in">append</span>(s, i) <span class="hljs-comment">// 用*2的方式创建新的连续存储空间，把值copy过去</span><br>t.Log(<span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s))<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMap</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>m := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>&#123;&#125;<br>t.Log(m[<span class="hljs-number">1</span>]) <span class="hljs-comment">// 0，默认初始化为0</span><br>m[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span><br>t.Log(m[<span class="hljs-number">2</span>]) <span class="hljs-comment">// 0</span><br>m[<span class="hljs-number">3</span>] = <span class="hljs-number">0</span> <span class="hljs-comment">// 判断 map 中 key不存在/值为0必须使用 if 语句</span><br><span class="hljs-keyword">if</span> v, ok := m[<span class="hljs-number">3</span>]; ok &#123;<br>t.Logf(<span class="hljs-string">&quot;Key 3&#x27;s value is %d&quot;</span>, v)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>t.Log(<span class="hljs-string">&quot;key 3 is not existing.&quot;</span>)<br>&#125;<br>m2 := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(op <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span>&#123;&#125; <span class="hljs-comment">// map的值可以是方法</span><br>m2[<span class="hljs-number">1</span>] = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(op <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123; <span class="hljs-keyword">return</span> op &#125;<br>m2[<span class="hljs-number">2</span>] = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(op <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123; <span class="hljs-keyword">return</span> op*op&#125;<br>t.Log(m2[<span class="hljs-number">1</span>](<span class="hljs-number">2</span>), m2[<span class="hljs-number">2</span>](<span class="hljs-number">2</span>))<br>&#125;<br><br><span class="hljs-comment">// go语言没有set（元素唯一性），用map来实现相同的特性。添加元素、判断元素是否存在、删除元素、元素个数</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMapForSet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>mySet := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br>mySet[<span class="hljs-number">1</span>] = <span class="hljs-literal">true</span><br>n := <span class="hljs-number">3</span><br><span class="hljs-keyword">if</span> mySet[n] &#123;<br>t.Logf(<span class="hljs-string">&quot;%d is existing&quot;</span>, n)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>t.Logf(<span class="hljs-string">&quot;%d is not existing&quot;</span>, n)<br>&#125;<br>mySet[<span class="hljs-number">3</span>] = <span class="hljs-literal">true</span><br>t.Log(<span class="hljs-built_in">len</span>(mySet))<br><span class="hljs-built_in">delete</span>(mySet, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 删除</span><br>n = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> mySet[n] &#123;<br>t.Logf(<span class="hljs-string">&quot;%d is existing&quot;</span>, n)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>t.Logf(<span class="hljs-string">&quot;%d is not existing&quot;</span>, n)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestString</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">var</span> s <span class="hljs-type">string</span><br>t.Log(s) <span class="hljs-comment">//初始化为默认零值“”</span><br>s = <span class="hljs-string">&quot;hello&quot;</span><br>t.Log(<span class="hljs-built_in">len</span>(s)) <span class="hljs-comment">// 5</span><br><span class="hljs-comment">//s[1] = &#x27;3&#x27; // string是不可变的byte slice</span><br>s = <span class="hljs-string">&quot;\xE4\xB8\xA5&quot;</span> <span class="hljs-comment">// 可以存储任何二进制数据</span><br>t.Log(<span class="hljs-built_in">len</span>(s)) <span class="hljs-comment">// 3</span><br>s = <span class="hljs-string">&quot;中&quot;</span> <span class="hljs-comment">// len(s)=3 [0xE4, 0xB8, 0xAD]</span><br>c := []<span class="hljs-type">rune</span>(s) <span class="hljs-comment">// 取出unicode，len(c)=1</span><br>t.Logf(<span class="hljs-string">&quot;中 unicode %x&quot;</span>, c[<span class="hljs-number">0</span>]) <span class="hljs-comment">// 中 unicode 4e2d</span><br>t.Logf(<span class="hljs-string">&quot;中 UTF8 %x&quot;</span>, s) <span class="hljs-comment">// 中 UTF8 e4b8ad（物理存储）</span><br><br>s := <span class="hljs-string">&quot;A,B,C&quot;</span><br>parts := strings.Split(s, <span class="hljs-string">&quot;,&quot;</span>) <span class="hljs-comment">// 字符串分割</span><br><span class="hljs-keyword">for</span> _, part := <span class="hljs-keyword">range</span> parts &#123;<br>t.Log(part)<br>&#125;<br>t.Log(strings.Join(parts, <span class="hljs-string">&quot;-&quot;</span>)) <br><br>s := strconv.Itoa(<span class="hljs-number">10</span>)<br>t.Log(<span class="hljs-string">&quot;str&quot;</span> + s) <span class="hljs-comment">// 整数转字符串</span><br><span class="hljs-keyword">if</span> i, err := strconv.Atoi(<span class="hljs-string">&quot;10&quot;</span>); err == <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// 字符串转整数需要用特殊写法</span><br>t.Log(<span class="hljs-number">10</span> + i)<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="字符串连接-高效"><a href="#字符串连接-高效" class="headerlink" title="字符串连接-高效"></a>字符串连接-高效</h4><p>尽量不使用 StringAdd，String 是个不可变对象，每次 add 之后需要生成一个新对象、开辟新的存储空间。<br>1.10 之前使用bytes.Buffer；1.10 以后可以使用 strings.Builder。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkStringBuilder</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br><span class="hljs-keyword">var</span> builder strings.Builder<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numbers; i++ &#123;<br>builder.WriteString(strconv.Itoa(i))<br><br>&#125;<br>_ = builder.String()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkBytesBuf</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br><span class="hljs-keyword">var</span> buf bytes.Buffer<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numbers; i++ &#123;<br>buf.WriteString(strconv.Itoa(i))<br>&#125;<br>_ = buf.String()<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>条件判断</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// if-else</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMultiSec</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> v, err:=someFunc() ; err==<span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// someFunc本来的返回值v，返回的错误err</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;&#125;<br>&#125;<br><span class="hljs-comment">// switch</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSwitch</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br><span class="hljs-keyword">switch</span> &#123; <br><span class="hljs-keyword">case</span> i%<span class="hljs-number">2</span> == <span class="hljs-number">0</span>: <span class="hljs-comment">// 可以直接使用i的表达式</span><br>t.Log(<span class="hljs-string">&quot;Even&quot;</span>) <span class="hljs-comment">// 不用加break</span><br><span class="hljs-keyword">case</span> i%<span class="hljs-number">2</span> == <span class="hljs-number">1</span>:<br>t.Log(<span class="hljs-string">&quot;Odd&quot;</span>)<br><span class="hljs-keyword">default</span>:<br>t.Log(<span class="hljs-string">&quot;unknow&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>函数可变参数</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sum</span><span class="hljs-params">(ops ...<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123; <br>ret := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> _, op := <span class="hljs-keyword">range</span> ops &#123;<br>ret += op<br>&#125;<br><span class="hljs-keyword">return</span> ret<br>&#125;<br></code></pre></div></td></tr></table></figure><p>函数式编程，传入一个函数，输出一个函数。<br>类似于装饰模式，给一个函数套一层，返回依旧是这个函数，作为功能的扩展。</p><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">timeSpent</span><span class="hljs-params">(inner <span class="hljs-keyword">func</span>(op <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span>) <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(op <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>start := time.Now()<br>ret := inner(n)<br>fmt.PrintIn(<span class="hljs-string">&quot;time spent:&quot;</span>, time.Since(start).Seconds())<br><span class="hljs-keyword">return</span> ret<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">slowFun</span><span class="hljs-params">(op <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123; time.Sleep(time.Second * <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> op&#125; <span class="hljs-comment">// 表示一个函数的运行</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestFn</span><span class="hljs-params">(t *testing.T)</span></span> &#123; tsSF := timeSpent(slowFun) t.Log(tsSF(<span class="hljs-number">10</span>))&#125; <span class="hljs-comment">// 调用装饰函数</span><br></code></pre></div></td></tr></table></figure><h3 id="package"><a href="#package" class="headerlink" title="package"></a>package</h3><ol><li>strconv 包提供了字符串与简单数据类型之间的类型转换功能。可以将简单类型转换为字符串，也可以将字符串转换为其它简单类型。<br>字符串转int：Atoi()<br>int转字符串：Itoa()<br>ParseTP类函数将string转换为TP类型：ParseBool()、ParseFloat()、ParseInt()、ParseUint()。因为string转其它类型可能会失败，所以这些函数都有第二个返回值表示是否转换成功<br>FormatTP类函数将其它类型转string：FormatBool()、FormatFloat()、FormatInt()、FormatUint()<br>AppendTP类函数用于将TP转换成字符串后 append 到一个 slice 中：AppendBool()、AppendFloat()、AppendInt()、AppendUint()</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go笔记（1）基础</title>
    <link href="/2024/02/20/Go%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E5%9F%BA%E7%A1%80/"/>
    <url>/2024/02/20/Go%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<blockquote><p>组织架构调整之后，公司的后端由 python 变成了 go，作为一个全栈工程师，自然是需要了解一下这个语言，Go笔记是初级学习的第一阶段。<br>本篇包含基础、运行指令、编写测试程序、benchmark。IDE 插件相关。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>Go 语言主要为了解决：多核硬件架构、超大规模分布式计算集群<br>（上万+）、Web 模式导致的前所未有的开发规模和更新速度。</li><li>并发支持、垃圾回收机制。编译的静态类型语言，尽管有 GC，依然可以通过指针去访问内存。</li></ol><h3 id="学习路径"><a href="#学习路径" class="headerlink" title="学习路径"></a>学习路径</h3><p>语法 –&gt; 并发任务的实现 –&gt; 常见架构模式（pipe-filter, micro-kernel）–&gt; 性能优化 –&gt; 高可用服务</p><h3 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">运行</span><br>go run ***.go<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编译-独立的二进制文件（命令行./***即可运行），可通过容器部署</span><br>go build ***.go  <br></code></pre></div></td></tr></table></figure><h3 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h3><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> ( <span class="hljs-comment">// 快速设置连续值</span><br> Open = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-literal">iota</span><br> Close<br> Pending<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123; <span class="hljs-comment">// main中无法传入参数</span><br>    fmt.Println(<span class="hljs-string">&quot;Hello World&quot;</span>)<br>    os.Exit(<span class="hljs-number">0</span>) <span class="hljs-comment">// 返回</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><ol><li>源码⽂件以 _test 结尾：xxx_test.go</li><li>测试⽅法名以 Test 开头：func TestXXX(t *testing.T) {…}</li><li>内置单元测试框架：Fail, Error：该测试失败，该测试继续，其他测试继续执行；FailNow, Fatal：该测试失败，该测试中止，其他测试继续执行<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># -v 打印 t.Log 内容</span><br>go <span class="hljs-built_in">test</span> -v -cover<br></code></pre></div></td></tr></table></figure></li></ol><h4 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark"></a>benchmark</h4><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkConcatStringByAdd</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br><span class="hljs-comment">//与性能测试⽆关的代码</span><br>b.ResetTimer()<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br><span class="hljs-comment">//测试代码</span><br>&#125;<br>b.StopTimer()<br><span class="hljs-comment">//与性能测试⽆关的代码</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>运行benchmark，-bench&#x3D;&lt;相关benchmark测试&gt;</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">go <span class="hljs-built_in">test</span> -bench=.<br><span class="hljs-comment"># 输出更多信息，分析性能原因</span><br>go <span class="hljs-built_in">test</span> -bench=. -benchmem <br><span class="hljs-comment"># cpu 调优示例</span><br>go <span class="hljs-built_in">test</span> -bench=. -cpuprofile=cpu.prof<br>go tool pprof cpu.prof<br></code></pre></div></td></tr></table></figure><h3 id="Atom-离线安装-go-plus-插件（适用于mac）"><a href="#Atom-离线安装-go-plus-插件（适用于mac）" class="headerlink" title="Atom 离线安装 go-plus 插件（适用于mac）"></a>Atom 离线安装 go-plus 插件（适用于mac）</h3><p>Atom 自带的 install packages 安装失败，查阅资料发现有离线安装教程。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/.atom/packages<br>git <span class="hljs-built_in">clone</span> https://github.com/joefitzgerald/go-plus.git<br><span class="hljs-built_in">cd</span> go-plus<br>npm install<br></code></pre></div></td></tr></table></figure><p>Q1：atom 保存时出现“go: cannot find main module, but found .git&#x2F;config in &#x2F;Users&#x2F;<em><strong>&#x2F;go_learning<br>    to create a module there, run:<br>    cd ..&#x2F;..&#x2F;.. &amp;&amp; go mod init”<br>实验：执行该语句没用，报错“go: cannot determine module path for source directory &#x2F;Users&#x2F;</strong></em>&#x2F;go_learning (outside GOPATH, module path must be specified)”<br>A1：出错原因：出错原因是开启了 go mod，但是没有初使化生成 go.mod 文件。GO111MODULE 是 Go 1.11 引入的新版模块管理方式，快速解决方式是将其设置为 auto（具体实现见笔记5）。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">go <span class="hljs-built_in">env</span> -w GO111MODULE=auto<br></code></pre></div></td></tr></table></figure><p>Atom 中可以看到 GO111MODULE 已经变化，这种解决方式可能会影响其他。</p><p>Q2：go mod init 报错 go: cannot determine module path for source directory<br>A2：在GOPATH之外，必须指定模块路径</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">go mod init 文件夹名<br></code></pre></div></td></tr></table></figure><p>Q3：t.Log打印不出内容了，只会显示运行时间？<br>A3：Atom中需要安装Go plus插件，然后在Preferences..-&gt;Packages. 找到对应的Installed Packages “go-plus”。Settings 把 Run Tests With Verbose Flag Set 勾选上</p><p><code>附录</code><br><a href="https://www.jb51.net/article/262013.htm">VS Code安装go插件失败原因分析以及解决方案</a><br><a href="https://www.cnblogs.com/cqx6388/p/17719864.html">VSCode安装go插件失败的解决方案</a><br><a href="https://github.com/stretchr/testify">断⾔</a><br><a href="https://blog.csdn.net/a384843262/article/details/125032482">Atom Vscode Go test测试无法显示t.Log的打印日志内容</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>前端自动化测试（2）cypress</title>
    <link href="/2024/01/24/%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%EF%BC%882%EF%BC%89cypress/"/>
    <url>/2024/01/24/%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%EF%BC%882%EF%BC%89cypress/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录一下 cypress 的学习。</p></blockquote><span id="more"></span><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><p>Cypress 基于 JavaScript，不依赖外部依赖项，直接运行在浏览器中，并利用浏览器提供的原生 API 来模拟用户操作，提供了一套完整的端到端测试体验，可以对浏览器中运行的任何内容进行快速，简单和可靠的测试。<br>允许用户快速的创建、编写、运行、测试用例，并且针对每一步操作均支持回看。<br><img src="/../img/test-2.png" alt="cypress"><br>下面一张图可以看出，cypress 相当于过去一些工具的整合。<br><img src="/../img/test-3.png" alt="cypress"></p><h3 id="Cypress-元素定位"><a href="#Cypress-元素定位" class="headerlink" title="Cypress 元素定位"></a>Cypress 元素定位</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// id选择器</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;#account&#x27;</span>).<span class="hljs-title function_">click</span>()<br><span class="hljs-title class_">Cypress</span>.$(<span class="hljs-string">&#x27;#account&#x27;</span>)  <span class="hljs-comment">// Cypress.$定位器</span><br><span class="hljs-comment">// class类选择器</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;.form-control&#x27;</span>).<span class="hljs-title function_">click</span>()<br><span class="hljs-comment">// attributes属性选择器</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;[input[id = &quot;account&quot;]]&#x27;</span>).<span class="hljs-title function_">click</span>()<br><span class="hljs-comment">// :nth-child(n)选择器</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;tbody &gt; tr:nth-child(1) &gt; th&#x27;</span>)<br></code></pre></div></td></tr></table></figure><h3 id="Cypress-页面元素基本操作方式"><a href="#Cypress-页面元素基本操作方式" class="headerlink" title="Cypress 页面元素基本操作方式"></a>Cypress 页面元素基本操作方式</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 搜索定位元素</span><br>.<span class="hljs-title function_">get</span>(selector) <br>.<span class="hljs-title function_">contains</span>(selector) <br>.<span class="hljs-title function_">find</span>(selector) <br><br><span class="hljs-comment">// 获取DON元素的子元素</span><br>.<span class="hljs-title function_">children</span>() <br><span class="hljs-comment">// 获取DOM元素的所有父元素</span><br>.<span class="hljs-title function_">parents</span>() <br><span class="hljs-comment">// 获取DOM元素第一层元素</span><br>.<span class="hljs-title function_">parent</span>() <br><span class="hljs-comment">// 获取DOM元素的所有同级元素</span><br>.<span class="hljs-title function_">siblings</span>() <br><br><span class="hljs-comment">// 获取指定DOM对象的第一个元素</span><br>.<span class="hljs-title function_">first</span>() <br><span class="hljs-comment">// 获取指定DOM对象的最后一个元素</span><br>.<span class="hljs-title function_">last</span>() <br><span class="hljs-comment">// 用来匹配DOM对象紧跟着的下一个同级元素</span><br>.<span class="hljs-title function_">next</span>() <br><span class="hljs-comment">// 用来匹配给定的DOM对象的所有同级元素</span><br>.<span class="hljs-title function_">nextAll</span>() <br><span class="hljs-comment">// 用来匹配给定DOM对象之后的所有同级元素直到遇到Until里定义的元素为止</span><br>.<span class="hljs-title function_">nextUntil</span>() <br><span class="hljs-comment">// 用来匹配给定DOM对象紧跟着的上一个同级元素</span><br>.<span class="hljs-title function_">prev</span>() <br><span class="hljs-comment">// 用来匹配给定的DOM对象之前的所有同级元素</span><br>.<span class="hljs-title function_">prevAll</span>() <br><span class="hljs-comment">// 用来匹配给定DOM对象之后的所有同级元素直到遇到Until里定义的元素为止</span><br>.<span class="hljs-title function_">prevUntil</span>() <br><br><span class="hljs-comment">// 用来遍历数组及其类似结果</span><br>.<span class="hljs-title function_">each</span>() <br><span class="hljs-comment">// 用来在元素或者数组中的特定索引处获取DOM元素。类似于Jquery中nth:child()</span><br>.<span class="hljs-title function_">eq</span>() <br></code></pre></div></td></tr></table></figure><h3 id="Cypress-常见操作"><a href="#Cypress-常见操作" class="headerlink" title="Cypress 常见操作"></a>Cypress 常见操作</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 访问某个 link</span><br>cy.<span class="hljs-title function_">visit</span>(<span class="hljs-string">&#x27;httpf://www.baidu.com&#x27;</span>)<br><span class="hljs-comment">// 获取当前页面 URL</span><br>cy.<span class="hljs-title function_">url</span>()<br>cy.<span class="hljs-title function_">url</span>().<span class="hljs-title function_">should</span>(<span class="hljs-string">&quot;contain&quot;</span>, <span class="hljs-string">&quot;baidu&quot;</span>)<br><br><span class="hljs-comment">// 刷新页面</span><br>cy.<span class="hljs-title function_">reaload</span>() <span class="hljs-comment">// 等同于 F5</span><br>cy.<span class="hljs-title function_">radload</span>(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 等同于 ctrl+F5 强制刷新</span><br><br><span class="hljs-comment">// 设置窗口</span><br>&#123; <span class="hljs-comment">//在 cypress.json 中添加</span><br><span class="hljs-string">&#x27;viewportWidth&#x27;</span>:<span class="hljs-string">&#x27;1000&#x27;</span>,<br><span class="hljs-string">&#x27;viewportHeight&#x27;</span>:<span class="hljs-string">&#x27;600&#x27;</span><br>&#125;<br>cy.<span class="hljs-title function_">viewpoint</span>(<span class="hljs-number">1024</span>,<span class="hljs-number">768</span>) <span class="hljs-comment">//运行中设置</span><br><br><span class="hljs-comment">// 前进后退</span><br>cy.<span class="hljs-title function_">go</span>(<span class="hljs-string">&#x27;back&#x27;</span>)<br>cy.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>)<br>cy.<span class="hljs-title function_">go</span>(<span class="hljs-string">&#x27;forward&#x27;</span>)<br>cy.<span class="hljs-title function_">go</span>(<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">// 判断元素是否存在</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;.check-box&#x27;</span>).<span class="hljs-title function_">should</span>(<span class="hljs-string">&#x27;be.visible&#x27;</span>) <span class="hljs-comment">// 是否可见</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;.check-box&#x27;</span>).<span class="hljs-title function_">should</span>(<span class="hljs-string">&#x27;exist&#x27;</span>)<br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;.check-box&#x27;</span>).<span class="hljs-title function_">should</span>(<span class="hljs-string">&#x27;no exist&#x27;</span>)<br><br><span class="hljs-comment">// 条件判断</span><br><span class="hljs-keyword">const</span> btn = <span class="hljs-string">&#x27;#btn&#x27;</span><br><span class="hljs-title class_">Cypress</span>.$(btn).<span class="hljs-property">length</span>&gt;<span class="hljs-number">0</span>&#123;<br>  cy.<span class="hljs-title function_">get</span>(btn).<span class="hljs-title function_">click</span>()<br>&#125;<br><br><span class="hljs-comment">// 获取元素属性值</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;#btn&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> btnTxt = $btn.<span class="hljs-title function_">text</span>()<br>  cy.<span class="hljs-title function_">log</span>(btnTxt)<br>&#125;)<br><br><span class="hljs-comment">// 清除文本</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;div&gt;a&quot;</span>).<span class="hljs-title function_">clear</span>();<br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;div&gt;a&quot;</span>).<span class="hljs-title function_">clear</span>().<span class="hljs-title function_">type</span>();<br><br><span class="hljs-comment">// 操作单选/多选按钮</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;radio&quot;</span>).<span class="hljs-title function_">check</span>(<span class="hljs-string">&quot;us&quot;</span>) <span class="hljs-comment">// 选中</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;radio&quot;</span>).<span class="hljs-title function_">uncheck</span>(<span class="hljs-string">&quot;us&quot;</span>) <span class="hljs-comment">// 取消选中</span><br><br><span class="hljs-comment">// 操作下拉菜单</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;select&quot;</span>).<span class="hljs-title function_">select</span>(<span class="hljs-string">&quot;下拉选项的值&quot;</span>)<br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;li&quot;</span>).<span class="hljs-title function_">eq</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">click</span>()<br><br><span class="hljs-comment">// 操作弹出框</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;iframe&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">$iframe</span>) &#123;<br>  <span class="hljs-keyword">const</span> $body = $iframe.<span class="hljs-title function_">contents</span>().<span class="hljs-title function_">find</span>(<span class="hljs-string">&quot;body&quot;</span>)<br>  cy.<span class="hljs-title function_">wrap</span>($body).<span class="hljs-title function_">find</span>(<span class="hljs-string">&quot;#bin&quot;</span>).<span class="hljs-title function_">click</span>();<br>&#125;)<br><br><span class="hljs-comment">// 操作被覆盖的元素</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;#btn&quot;</span>).<span class="hljs-title function_">click</span>(&#123; <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> &#125;)<br><br><span class="hljs-comment">// 模拟键盘操作</span><br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;input&quot;</span>).<span class="hljs-title function_">type</span>(<span class="hljs-string">&quot;111&quot;</span>)<br>cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;input&quot;</span>).<span class="hljs-title function_">type</span>(<span class="hljs-string">&quot;&#123;enter&#125;&quot;</span>)<br></code></pre></div></td></tr></table></figure><h2 id="初步方案"><a href="#初步方案" class="headerlink" title="初步方案"></a>初步方案</h2><ol><li>在现有项目上安装 cypress 环境</li><li>手动编写模拟操作，完成运行测试</li><li>尝试使用 AI 编写模拟操作，节约时间（当前使用 Fitten Code）</li></ol><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><ol><li>安装 cypress 环境<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install cypress --save-dev<br></code></pre></div></td></tr></table></figure></li><li>创建测试文件（从项目根目录打开）<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npx cypress open<br></code></pre></div></td></tr></table></figure></li><li>编写测试用例<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;My First Test&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;passes&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    cy.<span class="hljs-title function_">visit</span>(<span class="hljs-string">&#x27;https://***&#x27;</span>)<br>    cy.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&#x27;type&#x27;</span>).<span class="hljs-title function_">click</span>()<br>    cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;#email&#x27;</span>).<span class="hljs-title function_">type</span>(<span class="hljs-string">&#x27;&lt;EMAIL&gt;&#x27;</span>)<br>    cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;#password&#x27;</span>).<span class="hljs-title function_">type</span>(<span class="hljs-string">&#x27;password&#x27;</span>)<br>    cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;#login&#x27;</span>).<span class="hljs-title function_">click</span>()<br>    cy.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&#x27;Welcome to Cypress!&#x27;</span>)<br>  &#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure></li><li>运行测试用例<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npx cypress run<br></code></pre></div></td></tr></table></figure><img src="/../img/cypress-1.jpg" alt="cypress测试结果"><br>也可以修改后直接在 cypress 控制的浏览器中运行，实时查看结果</li><li>编写测试用例<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 通过添加 data-cy 属性来定位元素，能防止 tag/class/id 被他人修改 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">data-cy</span>=<span class="hljs-string">&quot;counter&quot;</span>&gt;</span>&#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br></code></pre></div></td></tr></table></figure>it 代表一个独立的测试用例，第一个参数是一个简要描述，第二个包含测试代码<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;Test&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;stepper should default to 0&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;[data-cy=counter]&#x27;</span>).<span class="hljs-title function_">should</span>(<span class="hljs-string">&#x27;have.text&#x27;</span>, <span class="hljs-string">&#x27;0&#x27;</span>)<br>  &#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure></li></ol><h4 id="cypress-目录结构"><a href="#cypress-目录结构" class="headerlink" title="cypress 目录结构"></a>cypress 目录结构</h4><p>安装之后，会在项目根目录下生成 cypress 文件夹，包含以下文件：<br>|– cypress<br>    |– e2e                # 测试代码<br>    |– fixtures           # 测试数据、账号<br>    |– integration        # 集成测试（所有自动化测试用例-cypress代码）<br>    |– plugins            # 模块、依赖、插件<br>    |– support            # 自定义命令</p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>“Cypress is currently automating this browser.” Cypress 自动控制了当前浏览器，建议新开一个浏览器窗口运行项目。实验时发现 cookie 不能共享给 Cypress 控制的页面（自动使用无痕模式登录），必须写一段登录的代码。</li><li>直接运行不走 vue 的接口代理，会请求失败</li></ol><p><code>附录</code>：<br><a href="https://www.cypress.io/">官网</a><br><a href="https://juejin.cn/post/7051405917832609828">前端自动化测试框架cypress</a><br><a href="https://www.jianshu.com/p/459612488233">Vue项目采用Cypress做e2e自动化测试</a></p><h4 id="后续思考"><a href="#后续思考" class="headerlink" title="后续思考"></a>后续思考</h4><ol><li>Q：是否可以用来自动化做一些事情，例如：资料整理<br>A：暂时有问题，聊天机器人都是使用一些长连接？URL 较长且中带有一些特殊信息，不太方便用来模拟打开网站。</li><li>Q：有 apisix 验证的接口，怎么绕过登录？<br>A：自己写 cookie（过期需要手动改）</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>测试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>前端自动化测试（1）框架对比</title>
    <link href="/2024/01/15/%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%EF%BC%881%EF%BC%89%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94/"/>
    <url>/2024/01/15/%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%EF%BC%881%EF%BC%89%E6%A1%86%E6%9E%B6%E5%AF%B9%E6%AF%94/</url>
    
    <content type="html"><![CDATA[<blockquote><p>年前进行了 UI 自动化测试，主要测试业务逻辑是否准确，感觉比较费时费力，希望能解放一部分生产力。<br>近期工期排的比较宽松，总觉得产出不太够，尝试引入自动化测试框架，看看能不能有所突破。</p></blockquote><span id="more"></span><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><p>前端自动化测试是指使用代码或工具来模拟用户在浏览器上的操作，以检验网页或应用程序的功能和性能是否符合预期。前端自动化测试可以提高开发效率，减少人工错误，保证软件质量和用户体验。<br>现有的很多成熟的自动化测试框架完全可以模拟我们的手工操作，使用脚本自动运行测试用例，通常只需要几秒就能给出准确的反馈，同时还能侦听代码变化，自动执行项目中发生了变化的代码对应的测试用例，能够极大提高我们的开发效率。<br>在公司业务和人员变动都比较快的当下，编写自动化测试脚本的收益越来越高。开发者再也不用害怕引入回归 BUG，也再也不用害怕把代码交给他人维护。有了测试脚本的约束，迭代&#x2F;重构都能更加从容。</p><ol><li>单元测试：即模块测试，主要针对最小可测试单元（类、方法），适合在在公共函数&#x2F;组件中添加</li><li>集成测试：适合在耦合度较高的函数&#x2F;组件、经过二次封装的函数&#x2F;组件、多个函数&#x2F;组件组合而成的函数&#x2F;组件中添加</li><li>UI 测试：以自动化的方式代替人工执行测试，当前自动化程度还不高</li></ol><h3 id="主流测试工具比较"><a href="#主流测试工具比较" class="headerlink" title="主流测试工具比较"></a>主流测试工具比较</h3><p>单元测试（Unit Test）有 Mocha, Ava, Karma, Jest, Jasmine 等。<br>集成测试（Integration Test）和 UI 测试（UI Test）有 ReactTestUtils, Test Render, Enzyme, React-Testing-Library, Vue-Test-Utils 等。</p><table><thead><tr><th>框架</th><th>断言</th><th>仿真</th><th>快照</th><th>异步测试</th><th>优点&#x2F;缺点</th></tr></thead><tbody><tr><td>Mocha</td><td>默认不支持，可配置</td><td>默认不支持，可配置</td><td>默认不支持，可配置照</td><td>友好</td><td>需要较多的配置来实现它的高扩展性</td></tr><tr><td>Ava</td><td>默认支持</td><td>不支持，需要第三方配置</td><td>默认支持</td><td>友好</td><td>并发运行文件多的时候会撑爆 CPU</td></tr><tr><td>Jasmine</td><td>默认支持</td><td>默认支持</td><td>默认支持</td><td>不友好</td><td>异步测试支持较弱</td></tr><tr><td>Jest</td><td>默认支持</td><td>默认支持</td><td>默认支持</td><td>友好</td><td>基于 Jasmine，异步测试支持良好</td></tr><tr><td>Karma</td><td>不支持，需要第三方配置</td><td>不支持，需要第三方配置</td><td>不支持，需要第三方配置</td><td>不支持，需要第三方配置</td><td>能在真实的浏览器中测试，强大适配器，可配置其他单测框架，一般会配合 Mocha 或 Jasmine 等一起使用</td></tr></tbody></table><h3 id="框架对比"><a href="#框架对比" class="headerlink" title="框架对比"></a>框架对比</h3><p>前端自动化的流派主要分为3类：</p><ol><li><p>基于录制回放技术的自动化测试框架（UI recoder，Selenium ide）<br> 通过记录测试人员的操作行为以及记录被操作的屏幕坐标来开发用例。<br> 优点：操作简单，学习成本低。<br> 缺点：当应用有一点小修改（例如：元素布局改变），录制好的脚本无法使用。</p></li><li><p>基于对文档对象模型（DOM）对象进行解析的自动化测试框架（基于Selenium自编程序）<br> 缺点：同1</p></li><li><p>基于图像识别的自动化测试框架（Aritest，sikuli）<br> 通过类似图像识别的原理进行自动化操作的，测试不易识别或无法定位的对象，比如map 、Flash和图表等。<br> 缺点：受图片清晰度、屏幕分辨率影响，要求图片匹配区域大小和样式不能有变化。<br> 优点：不受目标前端代码修改的影响</p></li></ol><table><thead><tr><th>框架</th><th>QPT</th><th>UIRecoder</th><th>Selenium ide</th><th>Selenium + webdriver</th><th>Robotframework</th><th>Aritest</th><th>Sikuli</th></tr></thead><tbody><tr><td>元素获取方式</td><td>1,2,3</td><td>1</td><td>1</td><td>自写代码实现</td><td>自写代码实现</td><td>3</td><td>3</td></tr><tr><td>支持的浏览器</td><td>只支持IE&#x2F;Firefox</td><td>支持IE&#x2F;Firefox&#x2F;Chrome等多种主流浏览器</td><td>只支持IE&#x2F;Chrome</td><td>支持IE&#x2F;Firefox&#x2F;Chrome等多种主流浏览器</td><td>支持IE&#x2F;Firefox&#x2F;Chrome等多种主流浏览器</td><td>支持IE&#x2F;Firefox&#x2F;Chrome等多种主流浏览器</td><td>支持IE&#x2F;Firefox&#x2F;Chrome等多种主流浏览器</td></tr><tr><td>是否开源</td><td>否</td><td>开源</td><td>开源</td><td>开源</td><td>开源</td><td>否</td><td>开源</td></tr><tr><td>元素定位准确性</td><td>中</td><td>中</td><td>中</td><td>高</td><td>高</td><td>取决于图片清晰度、分辨率等信息</td><td>取决于图片清晰度、分辨率等信息</td></tr></tbody></table><h4 id="selenium"><a href="#selenium" class="headerlink" title="selenium"></a>selenium</h4><p>selenium 提供了一系列的工具和库来支持浏览器自动化测试。selenium 的核心组件是 webdriver，它是一个接口，定义了在不同浏览器上执行自动化测试脚本所需的方法和属性。通过JSON Wire Protocal，可以实现和 Browser Drivers 通信。<br><img src="/../img/test-1.png" alt="selenium + webdriver"></p><h3 id="前期考虑"><a href="#前期考虑" class="headerlink" title="前期考虑"></a>前期考虑</h3><p>基于公司当前项目考虑，首先要求要能兼容 Chrome 浏览器，其次项目必须开源且生态好。<br>基于老代码做维护和新 feature 开发，如果之前已经编写了单元测试和集成测试的代码，在 README 里要求维护的同事要在添加&#x2F;修改了代码之后跑一遍测试用例。</p><p><code>附录</code>：<br><a href="https://juejin.cn/post/6844904194600599560">试试前端自动化测试！（基础篇）</a><br><a href="https://juejin.cn/post/6973227219074154503">一文搞定前端自动化测试（Vue 实战）</a><br><a href="https://juejin.cn/post/7213598216884125756">前端自动化测试框架：如何选择最适合你的方案</a><br>对目前几种主流的前端自动化测试框架的介绍和比较，有selenium、cypress、taiko、testcafe特点对比</p>]]></content>
    
    
    
    <tags>
      
      <tag>测试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>工作（5）PLCS 前端负责人</title>
    <link href="/2023/12/11/%E5%B7%A5%E4%BD%9C%EF%BC%885%EF%BC%89PLCS%E5%89%8D%E7%AB%AF%E8%B4%9F%E8%B4%A3%E4%BA%BA/"/>
    <url>/2023/12/11/%E5%B7%A5%E4%BD%9C%EF%BC%885%EF%BC%89PLCS%E5%89%8D%E7%AB%AF%E8%B4%9F%E8%B4%A3%E4%BA%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>在某国企背景的创业公司里，在团队里只有一个初级工程师和一个外包工程师的情况下，我从一个前端杂役承担起了前端负责人的职责，从零到一搭建了产品生命周期管理系统（PLCS）一整个系列。 </p></blockquote><span id="more"></span><h3 id="工作内容简介"><a href="#工作内容简介" class="headerlink" title="工作内容简介"></a>工作内容简介</h3><p>具体技术细节已经在前面的文章里分析过了，这个前端项目系列基于 Vue.js 搭建，使用 Element Plus 组件库，并在 UI 团队的支持下，对部分组件进行了二次封装。</p><p><img src="/../img/0-11.png" alt="产品生命周期管理系统"></p><p>这篇文章主要讲一下业务细节。</p><ol><li><p>UMS （用户管理系统）<br>UMS 作为 PLCS 整个的支撑，我负责了用户管理、系统管理、菜单管理、角色管理、通知管理等所有模块的开发工作。通过 UMS 的配置，可实现不同用户对系统整体的访问控制和整体消息分发。</p></li><li><p>PTS（产品追溯系统）<br>跟踪和记录产品生命周期信息，对公司产品（芯片、加速卡、一体机及软件产品）全生命周期的管理和追溯闭环。我负责了产品追溯台账、硬件产品信息、软件产品信息、供应商、客户等所有模块的开发工作。</p></li><li><p>OMS（订单管理系统）<br>用于销售订单的管理，我负责了订单管理模块的开发工作。</p></li><li><p>维护卡（元维监测系统）<br>与硬件部合作，进行 web 端维护卡硬件数据展示。我负责了数据监测可视化展示及版本固件升级修复功能开发。</p></li><li><p>CPQ（报价管理系统）<br>用来配置报价的子系统，帮助公司销售人员对复杂和可配置产品（当前主要为一体机）进行报价。我负责了客户模块、产品货架、价格及可售管理、报价测算等所有模块的开发工作。</p></li></ol><h3 id="工作价值总结"><a href="#工作价值总结" class="headerlink" title="工作价值总结"></a>工作价值总结</h3><ol><li><p>保持稳定的产出<br>我在短时间内快速完成开发任务，任务紧急的情况下加班加点，最终保证任务圆满完成。在各种情况下勇于担当，尽全力减轻项目风险。</p></li><li><p>串联团队的协作<br>在前端开发工作中，我快速理解产品经理提出的需求，和后端工程师讨论交流数据传输设计，和UI设计师评估交互优化的实现，作为一个粘合剂，我和团队的每一部分都紧密协作，共同完成目标。</p></li><li><p>交付可靠的系统<br>我能保证代码质量，交付运行稳定、准确性高的系统及操作文档。</p></li></ol><h3 id="工作感悟"><a href="#工作感悟" class="headerlink" title="工作感悟"></a>工作感悟</h3><p>上面的都是 PPT 总结，聊两句自己的感受。<br>从零到一搭建一个系统确实不是一件容易的事儿，特别是需求不断变化，作为一个服务型的内部产品，我们团队尽可能满足来自各个部门的用户需求。产品姐姐也是疲于应对各方（站在个人角度提出）的奇怪需求，她周末都在加班，就是为了整理出一条明确的思路，虽然文档一直在修改，为了 ddl 我和后端同学也只能边开发边跟着 PRD 变，有些时候刚开发完需求又变了，我又要重构一部分，重复的工作让我心力交瘁，但是看到最后的成果时，又觉得这些努力都是值得的。<br>在 Q3 老板又要求对整体交互做一个大的提升，对系统的修改量还是很大的。带的两个小朋友又需要在我的指导下进行系统的修改，我觉得自己扛了个大山，先要自己试错，然后带着大家往前。好在我电商出身，像素级还原交互稿的基础还在，时间紧迫脑子转的也挺快，修改逻辑性的代码速度还是 ok 的，最终还是顺利完成了。<br>我觉得设计系统需要一个好的底子（经验的积累），加上一点想象力（部分需求的实现需要自己脑子里想象出一个可能的解决方案再做尝试），还需要一点运气（有时候预留的空间正好和下一个需求匹配了），天时地利人和，才能在预期完成任务。</p>]]></content>
    
    
    
    <tags>
      
      <tag>工作实习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（37）页面转 pdf 导出</title>
    <link href="/2023/12/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8837%EF%BC%89%E9%A1%B5%E9%9D%A2%E8%BD%ACpdf%E5%AF%BC%E5%87%BA/"/>
    <url>/2023/12/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8837%EF%BC%89%E9%A1%B5%E9%9D%A2%E8%BD%ACpdf%E5%AF%BC%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>新需求，报价管理中每个报价单的明细需要转换成 pdf 导出，调研后完美实现。</p></blockquote><span id="more"></span><h3 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm i html2canvas<br>npm i jspdf<br></code></pre></div></td></tr></table></figure><h3 id="html-转-pdf"><a href="#html-转-pdf" class="headerlink" title="html 转 pdf"></a>html 转 pdf</h3><p>在<code>utils</code>文件夹下新建<code>html2pdf.ts</code>文件</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> html2canvas <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;html2canvas&#x27;</span>;<br><span class="hljs-keyword">import</span> jsPDF <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;jspdf&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">htmlToPDF</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">htmlId: string, title: string = <span class="hljs-string">&quot;报表&quot;</span>, bgColor = <span class="hljs-string">&quot;#fff&quot;</span></span>) =&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-attr">pdfDom</span>: <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(htmlId) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span><br>    pdfDom.<span class="hljs-property">style</span>.<span class="hljs-property">padding</span> = <span class="hljs-string">&#x27;0 10px !important&#x27;</span><br>    <span class="hljs-keyword">const</span> A4Width = <span class="hljs-number">595.28</span>;<br>    <span class="hljs-keyword">const</span> A4Height = <span class="hljs-number">841.89</span>;<br>    <span class="hljs-keyword">let</span> canvas = <span class="hljs-keyword">await</span> <span class="hljs-title function_">html2canvas</span>(pdfDom, &#123;<br>        <span class="hljs-attr">scale</span>: <span class="hljs-number">2</span>,<br>        <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">backgroundColor</span>: bgColor,<br>    &#125;);<br>    <span class="hljs-keyword">let</span> pageHeight = (canvas.<span class="hljs-property">width</span> / A4Width) * A4Height;<br>    <span class="hljs-keyword">let</span> leftHeight = canvas.<span class="hljs-property">height</span>;<br>    <span class="hljs-keyword">let</span> position = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> imgWidth = A4Width;<br>    <span class="hljs-keyword">let</span> imgHeight = (A4Width / canvas.<span class="hljs-property">width</span>) * canvas.<span class="hljs-property">height</span>;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     自定义水印代码</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">const</span> <span class="hljs-attr">ctx</span>: any = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>);<br>    ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">&#x27;center&#x27;</span>;<br>    ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">&#x27;middle&#x27;</span>;<br>    ctx.<span class="hljs-title function_">rotate</span>((<span class="hljs-number">20</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">180</span>);<br>    ctx.<span class="hljs-property">font</span> = <span class="hljs-string">&#x27;20px Microsoft Yahei&#x27;</span>;<br>    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&#x27;rgba(184, 184, 184, 0.8)&#x27;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = canvas.<span class="hljs-property">width</span> * -<span class="hljs-number">1</span>; i &lt; canvas.<span class="hljs-property">width</span>; i += <span class="hljs-number">240</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = canvas.<span class="hljs-property">height</span> * -<span class="hljs-number">1</span>; j &lt; canvas.<span class="hljs-property">height</span>; j += <span class="hljs-number">200</span>) &#123;<br>            <span class="hljs-comment">// 填充文字，x 间距, y 间距</span><br>            ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">&#x27;水印名&#x27;</span>, i, j);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     自定义水印代码</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">let</span> pageData = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">&quot;image/jpeg&quot;</span>, <span class="hljs-number">1.0</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable constant_">PDF</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">jsPDF</span>(<span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-string">&#x27;pt&#x27;</span>, <span class="hljs-string">&#x27;a4&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (leftHeight &lt; pageHeight) &#123;<br>        <span class="hljs-variable constant_">PDF</span>.<span class="hljs-title function_">addImage</span>(pageData, <span class="hljs-string">&quot;JPEG&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgWidth, imgHeight);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">while</span> (leftHeight &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-variable constant_">PDF</span>.<span class="hljs-title function_">addImage</span>(pageData, <span class="hljs-string">&quot;JPEG&quot;</span>, <span class="hljs-number">0</span>, position, imgWidth, imgHeight);<br>            leftHeight -= pageHeight;<br>            position -= A4Height;<br>            <span class="hljs-keyword">if</span> (leftHeight &gt; <span class="hljs-number">0</span>) <span class="hljs-variable constant_">PDF</span>.<span class="hljs-title function_">addPage</span>();<br>        &#125;<br>    &#125;<br>    <span class="hljs-variable constant_">PDF</span>.<span class="hljs-title function_">save</span>(title + <span class="hljs-string">&quot;.pdf&quot;</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="项目中使用"><a href="#项目中使用" class="headerlink" title="项目中使用"></a>项目中使用</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;quote&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;test-id&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 这里是导出内容 --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleExport&quot;</span>&gt;</span>导出<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; htmlToPDF &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/html2pdf&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExport</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-title function_">htmlToPDF</span>(<span class="hljs-string">&#x27;test-id&#x27;</span>, state.<span class="hljs-property">quote</span>.<span class="hljs-property">quotation_number</span>)</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>点击按钮触发导出功能，最终效果如下：<br><img src="/../img/vue37-1.png" alt="预览效果"></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（36）页面切换提示</title>
    <link href="/2023/12/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8836%EF%BC%89%E9%A1%B5%E9%9D%A2%E5%88%87%E6%8D%A2%E6%8F%90%E7%A4%BA/"/>
    <url>/2023/12/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8836%EF%BC%89%E9%A1%B5%E9%9D%A2%E5%88%87%E6%8D%A2%E6%8F%90%E7%A4%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>对于长表单，用户填写了部分内容，突然由于某些原因要切换页面时，可能未留意到当前已填写内容不会自动保存（当前系统不支持定时草稿），需要给出一个用户提示。</p></blockquote><span id="more"></span><h3 id="页面跳转提示"><a href="#页面跳转提示" class="headerlink" title="页面跳转提示"></a>页面跳转提示</h3><p>通过对页面的编辑态进行记录，页面切换时判断提示。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">isEditing</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否是编辑状态</span><br>  <span class="hljs-attr">isDataChangeCount</span>: <span class="hljs-number">0</span><br>&#125;)<br><br><span class="hljs-comment">// 所有请求回调中处理，跳转页面不出现提示</span><br><span class="hljs-keyword">if</span> (status == <span class="hljs-number">200</span>) &#123;<br>  state.<span class="hljs-property">isEditing</span> = <span class="hljs-literal">false</span><br>  router.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/***&#x27;</span> &#125;)<br>&#125;<br><br><span class="hljs-comment">// 通过观察form的修改情况，若有修改，则新增记录</span><br><span class="hljs-title function_">watch</span>(<br>  state.<span class="hljs-property">testForm</span>,<br>  <span class="hljs-function">(<span class="hljs-params">n, o</span>) =&gt;</span> &#123;<br>    state.<span class="hljs-property">isDataChangeCount</span>++<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span><br>  &#125;<br>)<br><span class="hljs-title function_">onBeforeRouteLeave</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (to.<span class="hljs-property">path</span> != <span class="hljs-keyword">from</span>.<span class="hljs-property">path</span> &amp;&amp; state.<span class="hljs-property">isDataChangeCount</span> &gt; <span class="hljs-number">1</span> &amp;&amp; state.<span class="hljs-property">isEditing</span> == <span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<br>      <span class="hljs-string">&#x27;当前填写的内容尚未提交，离开页面时将丢失填写内容。&#x27;</span>,<br>      <span class="hljs-string">&#x27;确认要离开该页面吗？&#x27;</span>,<br>      &#123;<br>        <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">&#x27;取消&#x27;</span>,<br>        <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">&#x27;确定&#x27;</span><br>      &#125;<br>    )<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">clearAll</span>()<br>        <span class="hljs-title function_">next</span>()<br>      &#125;)<br>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_">next</span>()<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue36-1.png" alt="提示效果"></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（35）el-form表单校验综合</title>
    <link href="/2023/11/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8835%EF%BC%89el-form%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C%E7%BB%BC%E5%90%88/"/>
    <url>/2023/11/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8835%EF%BC%89el-form%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C%E7%BB%BC%E5%90%88/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇包含一般表单校验、自定义表单校验、多个表单校验</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>el-form 支持嵌套</li><li>可以单独给 form 绑定 rules，也可以给 form-item 绑定 rules</li></ol><h3 id="一般表单校验"><a href="#一般表单校验" class="headerlink" title="一般表单校验"></a>一般表单校验</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form</span></span><br><span class="hljs-tag">  <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;serviceFormRef&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:model</span>=<span class="hljs-string">&quot;serviceForm&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;serviceRules&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">label-width</span>=<span class="hljs-string">&quot;120px&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">label-position</span>=<span class="hljs-string">&quot;top&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-input service-form&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;名称：&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;name&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;serviceForm.ame&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入名称&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 设置约束条件</span><br><span class="hljs-keyword">const</span> serviceRules = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">name</span>: [<br>    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入服务名称&#x27;</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">&#x27;blur&#x27;</span> &#125;,<br>    &#123; <span class="hljs-attr">validator</span>: validateText50RequiredWithSapce, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>  ]<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="自定义表单校验"><a href="#自定义表单校验" class="headerlink" title="自定义表单校验"></a>自定义表单校验</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;error-info&quot;</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;showError&quot;</span>&gt;</span>尚有内容未完成，请修改后提交<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">try</span> &#123;<br>  state.<span class="hljs-property">otherForm</span>.<span class="hljs-property">hdConfigList</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">hd</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!hd.<span class="hljs-property">accessory_id</span> || !hd.<span class="hljs-property">value</span> || hd.<span class="hljs-property">value</span> == <span class="hljs-string">&#x27;&#x27;</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>()<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      arr.<span class="hljs-title function_">push</span>(hd)<br>    &#125;<br>  &#125;)<br>&#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>  state.<span class="hljs-property">showError</span> = <span class="hljs-literal">true</span><br>  <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="多个表单校验"><a href="#多个表单校验" class="headerlink" title="多个表单校验"></a>多个表单校验</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkForm</span> = (<span class="hljs-params">formName</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> formEl = <span class="hljs-title function_">unref</span>(formName)<br>    formEl.<span class="hljs-title function_">validate</span>(<span class="hljs-function">(<span class="hljs-params">valid</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (valid) &#123;<br>        <span class="hljs-title function_">resolve</span>()<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-title function_">reject</span>()<br>    &#125;)<br>  &#125;)<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> list = []<br>  list.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">checkForm</span>(configFormRef), <span class="hljs-title function_">checkForm</span>(hdConfigListRef))<br>  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(list)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;   <br>      <span class="hljs-comment">// 提交 API</span><br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;未通过&#x27;</span>, error)<br>    &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（34）refresh token</title>
    <link href="/2023/10/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%8834%EF%BC%89refresh-token/"/>
    <url>/2023/10/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%8834%EF%BC%89refresh-token/</url>
    
    <content type="html"><![CDATA[<blockquote><p>为了保证系统安全性，用户一段时间不操作应该自动退出。在开发实现上，使用 token 过期来描述，请求到达网关时，若 token 已过期，则后端返回 401，前端自动清除 token。<br>之前版本为登录后2小时 token 自动过期，略有不妥，现在修改为用户2小时未操作 token 过期，若期间用户有操作，token 自动刷新。</p></blockquote><span id="more"></span><h3 id="之前实现"><a href="#之前实现" class="headerlink" title="之前实现"></a>之前实现</h3><p><code>config/axios/service.ts</code>中通过后端返回参数判断，若收到401则自动清除 token，reload 本页面，这时触发<code>permission.ts</code>中的路由守卫，判断无 token 状态后跳转 UMS 进行系统登录。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// response 拦截器</span><br>service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<br>  <span class="hljs-function">(<span class="hljs-params">response: AxiosResponse&lt;any&gt;</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; config, status, data &#125; = response<br>    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">responseType</span> === <span class="hljs-string">&#x27;blob&#x27;</span>) &#123;<br>      <span class="hljs-comment">// 如果是文件流，直接过</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;this is blob&#x27;</span>)<br>      <span class="hljs-keyword">return</span> response<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status === result_code) &#123;<br>      <span class="hljs-keyword">return</span> data<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(data.<span class="hljs-property">message</span>)<br>    &#125;<br>  &#125;,<br>  <span class="hljs-function">(<span class="hljs-params">error: AxiosError</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;error=&#x27;</span>, error)<br>    <span class="hljs-keyword">if</span> (error &amp;&amp; <span class="hljs-title class_">String</span>(error).<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;401&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// Unauthorized</span><br>      <span class="hljs-title function_">removeToken</span>()<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error &amp;&amp; <span class="hljs-title class_">String</span>(error).<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;403&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;当前没有操作权限，请联系管理员。&#x27;</span>)<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error &amp;&amp; <span class="hljs-title class_">String</span>(error).<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;405&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// 权限过期</span><br>      <span class="hljs-title function_">removeToken</span>()<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>)<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)<br>    &#125;<br>  &#125;<br>)<br></code></pre></div></td></tr></table></figure><h3 id="方法一：使用刷新-refresh-token"><a href="#方法一：使用刷新-refresh-token" class="headerlink" title="方法一：使用刷新 refresh token"></a>方法一：使用刷新 refresh token</h3><p>登录成功后，后端会返回两个 token，一个是 access_token，一个是 refresh_token，分别保存在 cookie 中，后者的过期时间更长。若请求中 access_token 过期，则前端进行 refresh token 操作。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">refreshToken</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> refreshToken = userStore.<span class="hljs-title function_">getToken</span>(<span class="hljs-string">&#x27;refresh_token&#x27;</span>)<br>  <span class="hljs-title function_">refreshToken</span>(&#123;<br>    <span class="hljs-attr">params</span>: refreshToken<br>  &#125;)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;ok&#x27;</span>) &#123;<br>      <span class="hljs-keyword">const</span> accessToken = res.<span class="hljs-property">data</span>.<span class="hljs-property">accessToken</span><br>      <span class="hljs-keyword">const</span> refreshToken = res.<span class="hljs-property">data</span>.<span class="hljs-property">refreshToken</span><br>      <span class="hljs-keyword">await</span> userStore.<span class="hljs-title function_">updateToken</span>(accessToken)<br>      <span class="hljs-keyword">await</span> userStore.<span class="hljs-title function_">updateRefreshToken</span>(refreshToken)<br>    &#125;<br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;刷新token失败：&#x27;</span>, error);<br>  &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>缺点：refresh token操作是在用户请求之后进行的，可能会阻断用户请求，用户需要再次发起请求，没有实现无感刷新。</p><h3 id="方法二：前端自动续期"><a href="#方法二：前端自动续期" class="headerlink" title="方法二：前端自动续期"></a>方法二：前端自动续期</h3><p> 使用 renewToken 函数定期检查 access_token 的过期时间</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">renewToken</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> accessToken = userStore.<span class="hljs-title function_">getToken</span>(<span class="hljs-string">&#x27;accessToken&#x27;</span>);<br>  <span class="hljs-keyword">const</span> expireTime = userStore.<span class="hljs-title function_">getTime</span>(<span class="hljs-string">&#x27;expireTime&#x27;</span>);<br>  <span class="hljs-comment">// 计算AccessToken的剩余有效时间</span><br>  <span class="hljs-keyword">const</span> remainTime = expireTime - <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>  <span class="hljs-comment">// 如果AccessToken的剩余有效时间小于5分钟，则发送续期请求</span><br>  <span class="hljs-keyword">if</span> (remainTime &lt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) &#123;<br>    <span class="hljs-title function_">renewToken</span>(&#123;<br>      <span class="hljs-attr">params</span>: accessToken<br>    &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> accessToken = res.<span class="hljs-property">data</span>.<span class="hljs-property">accessToken</span><br>      userStore.<span class="hljs-title function_">renewToken</span>(<span class="hljs-string">&#x27;expireTime&#x27;</span>, data.<span class="hljs-property">expireTime</span>);<br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;续期Token失败：&#x27;</span>, error);<br>    &#125;);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 定时检查</span><br><span class="hljs-built_in">setInterval</span>(renewToken, <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);<br></code></pre></div></td></tr></table></figure><p>【注意】</p><ol><li>需要同时延长 userInfo 和 AccessSyss 的过期时间，因为用户可能 focus 在子系统操作。<br><code>cookie.ts</code> 中更新<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Cookies</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;js-cookie&quot;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateToken</span> = (<span class="hljs-params">expireTime: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> accessToken = <span class="hljs-title class_">Cookie</span>.<span class="hljs-title function_">get</span>(tokenKey)<br>  <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">remove</span>(tokenKey)<br>  <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(tokenKey, token, &#123; <span class="hljs-attr">expires</span>: expireTime &#125;)<br>  <span class="hljs-comment">// 更新用户信息</span><br>  <span class="hljs-keyword">const</span> userInfo = <span class="hljs-title class_">Cookie</span>.<span class="hljs-title function_">get</span>(userKey)<br>  <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">remove</span>(userKey)<br>  <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(userKey, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(userInfo), &#123; <span class="hljs-attr">expires</span>: expireTime &#125;)<br>  <span class="hljs-keyword">const</span> sysList = <span class="hljs-title class_">Cookie</span>.<span class="hljs-title function_">get</span>(sysKey)<br>  <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(sysKey, sysList, &#123; <span class="hljs-attr">expires</span>: expireTime &#125;)<br>  <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">remove</span>(sysKey)<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ol><p><code>javascript</code></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微前端（5）ice</title>
    <link href="/2023/09/26/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%885%EF%BC%89ice/"/>
    <url>/2023/09/26/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%885%EF%BC%89ice/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录飞冰相关实验。</p></blockquote><span id="more"></span><h3 id="主应用搭建"><a href="#主应用搭建" class="headerlink" title="主应用搭建"></a>主应用搭建</h3><p>安装依赖</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@ice/stark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^2.7.5&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;@ice/stark-app&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^1.5.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;@ice/stark-data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^0.1.3&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><p>App.vue 中初始化</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">&quot;loading&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;controllerApp&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!microAppsActive&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; registerMicroApps &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ice/stark/lib/apps&#x27;</span><br><span class="hljs-keyword">import</span> start <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ice/stark/lib/start&#x27;</span><br><span class="hljs-keyword">import</span> &#123; store &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ice/stark-data&#x27;</span><br><br><span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()<br><span class="hljs-keyword">const</span> config = <span class="hljs-variable language_">window</span>.<span class="hljs-property">APP_CONFIG</span>[<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_USER_NODE_ENV</span>]<br><span class="hljs-keyword">let</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><span class="hljs-keyword">let</span> microAppsActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;controllerApp&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span><br>  <span class="hljs-title function_">registerMicroApps</span>([<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;pts&#x27;</span>, <span class="hljs-comment">// 微应用唯一标识</span><br>      <span class="hljs-attr">activePath</span>: <span class="hljs-string">&#x27;/pts&#x27;</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;产品追溯系统&#x27;</span>,<br>      <span class="hljs-attr">loadScriptMode</span>: <span class="hljs-string">&#x27;import&#x27;</span>,<br>      <span class="hljs-attr">scriptAttributes</span>: [<span class="hljs-string">&#x27;crossorigin=anonymous&#x27;</span>],<br>      <span class="hljs-attr">entry</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;config?.controlCenterUrl&#125;</span>/index.html`</span>,<br>      container<br>    &#125;<br>  ])<br><br>  <span class="hljs-title function_">start</span>(&#123;<br>    <span class="hljs-comment">// 微应用加载前的回调,在微应用加载过程中渲染加载动画</span><br>    <span class="hljs-attr">onLoadingApp</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>    &#125;,<br>    <span class="hljs-comment">// 微应用加载并执行后的回调, 在微应用加载过程中结束渲染加载动画、结合 onLoadingApp 记录微应用加载执行的时长</span><br>    <span class="hljs-attr">onFinishLoading</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>    &#125;,<br>    <span class="hljs-comment">// 处理微应用间跳转无法触发 Vue Router 响应</span><br>    <span class="hljs-attr">onRouteChange</span>: <span class="hljs-function">(<span class="hljs-params">_, pathname</span>) =&gt;</span> &#123;<br>      router<br>        .<span class="hljs-title function_">push</span>(pathname)<br>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;)<br>    &#125;,<br>    <span class="hljs-comment">// 微应用开始被激活的回调, 记录当前 url 匹配的微应用</span><br>    <span class="hljs-attr">onActiveApps</span>: <span class="hljs-function">(<span class="hljs-params">activeApps</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;activeApps: &#x27;</span>, activeApps)<br>      microAppsActive.<span class="hljs-property">value</span> = !!(activeApps || []).<span class="hljs-property">length</span><br>      <span class="hljs-keyword">if</span> (microAppsActive.<span class="hljs-property">value</span>) &#123;<br>        store.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;controlData&#x27;</span>, &#123; <span class="hljs-attr">token</span>: <span class="hljs-title function_">getToken</span>(), <span class="hljs-attr">userInfo</span>: userStore.<span class="hljs-property">getUserInfo</span> &#125;)<br>      &#125;<br>    &#125;,<br>    <span class="hljs-comment">// 微应用开始渲染前的回调, 结合 onLoadingApp 记录微应用从加载到渲染的时长，结合 onFinishLoading 记录微应用渲染耗时</span><br>    <span class="hljs-attr">onAppEnter</span>: <span class="hljs-function">() =&gt;</span> &#123;&#125;,<br>    <span class="hljs-comment">// 微应用卸载前的回调, 记录用户的停留时长</span><br>    <span class="hljs-attr">onAppLeave</span>: <span class="hljs-function">() =&gt;</span> &#123;&#125;,<br>    <span class="hljs-comment">// 微应用在 icestark 在加载或执行错的回调, 记录微应用运行的错误信息</span><br>    <span class="hljs-attr">onError</span>: <span class="hljs-function">() =&gt;</span> &#123;&#125;,<br>  &#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="微应用搭建"><a href="#微应用搭建" class="headerlink" title="微应用搭建"></a>微应用搭建</h3><p>main.ts</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createApp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./App.vue&#x27;</span><br><span class="hljs-keyword">import</span> &#123; createWebHistory, createRouter &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span>;<br><span class="hljs-keyword">import</span> getBasename <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ice/stark-app/lib/getBasename&#x27;</span>;<br><span class="hljs-keyword">import</span> isInIcestark <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ice/stark-app/lib/isInIcestark&#x27;</span>;<br><span class="hljs-keyword">import</span> setLibraryName <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ice/stark-app/lib/setLibraryName&#x27;</span>;<br><br><span class="hljs-keyword">let</span> <span class="hljs-attr">vue</span>: <span class="hljs-title class_">Root</span>&lt;<span class="hljs-title class_">Element</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-comment">// setLibraryName(&#x27;microApp&#x27;)</span><br><br><span class="hljs-comment">// export function mount(&#123; container &#125;: &#123; container: Element&#125;) &#123;</span><br><span class="hljs-comment">//   vue = createApp(App);</span><br><span class="hljs-comment">//   vue.mount(container);</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">runApp</span> = (<span class="hljs-params">container: Element | string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> history = <span class="hljs-title function_">createWebHistory</span>(<span class="hljs-title function_">isInIcestark</span>() ? <span class="hljs-title function_">getBasename</span>() : <span class="hljs-string">&#x27;/&#x27;</span>);<br>  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>    history,<br>    routes,<br>  &#125;);<br>  vue = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);<br>  vue.<span class="hljs-title function_">use</span>(router);<br>  vue.<span class="hljs-title function_">mount</span>(container);<br>&#125;;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isInIcestark</span>()) &#123;<br>  <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">&#123; container &#125;: &#123; container: Element&#125;</span>) &#123;<br>  <span class="hljs-title function_">runApp</span>(container);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params"></span>) &#123;<br>  vue.<span class="hljs-title function_">unmount</span>();<br>&#125;<br></code></pre></div></td></tr></table></figure><p>App.vue 可以跳回主应用</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> appHistory <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@ice/stark-app/lib/appHistory&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">jumpToLayout</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  appHistory.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>&#125;;<br></code></pre></div></td></tr></table></figure><p><code>html</code></p><h3 id="加载模式"><a href="#加载模式" class="headerlink" title="加载模式"></a>加载模式</h3><p>icestark 目前支持三种加载模式，分别是 script、fetch 和 import，由 <code>loadScriptMode</code> 字段指定。</p><ol><li>script—默认加载方式。该模式下，icestark 会通过 HTML <code>script</code> 标签加载微应用脚本资源，再次加载时充分利用浏览器缓存进行加载。</li><li>fetch—当指定 loadScriptMode 为 fetch，或配置微应用沙箱模式时，会通过 window.fetch 或用户自定义的 fetch 能力加载并缓存脚本资源。再次加载时，会充分利用本地内部缓存进行加载。</li><li>import—加载 ES modules 类型微应用的主要方式，该模式会通过 Dynamic Import 动态加载脚本资源。</li></ol><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><ol><li><p>直接启动 UMS，首页能渲染，浏览器地址栏输入 &#x2F;pts，显示的是浏览器404，不是自己的404页面。<br>【错误❌】猜测是否是因为 pts 首页进行了一个跳转？尝试将地址更改为 &#x2F;pts&#x2F;traceChip。<br>直接启动 pts，发现是因为 router 没有成功，恢复到之前的写法，此时 UMS 中输入 &#x2F;pts 跳转到自己的404页面。（路由请求已经成功，只是页面没找到）<br>经过检查，发现 activeApps 开始是有的，不知道为什么数据加载了又没了。<br>【原因】router.ts 中修改 createRouter，不能直接用原来的 history。<br><img src="/img/mfe5-1.png" alt="activeApps"></p></li><li><p>首页都能渲染并且点击侧栏都能跳转，但是点击操作列跳转显示 Not Found，浏览器返回按钮点击无效。<br><img src="/img/mfe5-2.png" alt="Not Found"><br>【原因】终端开启的服务自己在重新加载，加载完成后未出现该问题。<br>芯片台账-查看 访问成功</p></li><li><p>静态资源访问失效<br>主应用和子应用本地开发启动端口不一样，导致资源加载以<code>主应用IP+绝对路径</code>访问，线上环境应该不会出现这个问题。</p></li></ol><p><code>附录</code><br><a href="https://micro-frontends.ice.work/docs/guide">飞冰</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>微前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（33）搜索缓存</title>
    <link href="/2023/09/25/vue3%E7%AC%94%E8%AE%B0%EF%BC%8833%EF%BC%89%E6%90%9C%E7%B4%A2%E7%BC%93%E5%AD%98/"/>
    <url>/2023/09/25/vue3%E7%AC%94%E8%AE%B0%EF%BC%8833%EF%BC%89%E6%90%9C%E7%B4%A2%E7%BC%93%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<blockquote><p>当列表项较多时，用户输入一些搜索条件、改变页数、改变页码获取到需要的搜索条目A，当对该搜索条目A进行操作（例如：编辑、查看等需要打开新页面），点击面包屑或者返回时，需要对之前的搜索项做一个缓存，以保证用户返回时能快速定位到之前的搜索条目A。<br>搜索缓存也遇到一些坑，本篇做一个记录。<br>2024.5.16更新：可以直接使用 keepAlive 组件缓存。</p></blockquote><span id="more"></span><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>列表页注入缓存，在所有涉及页面做判断是否需要去除缓存<br><code>detail.vue</code> 页面</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">watch</span>(route, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> path = route.<span class="hljs-property">path</span><br>  <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;traceChip&#x27;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">&#x27;traceChip&#x27;</span>)<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>不足：每个页面都要判断，很麻烦。若是有新需求要增加新页面，必须要再次加上。</p><h3 id="在列表页面做缓存"><a href="#在列表页面做缓存" class="headerlink" title="在列表页面做缓存"></a>在列表页面做缓存</h3><p>搜索后打开其他页面时，做缓存</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">openLook</span> = (<span class="hljs-params">index: any, row: any</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<br>    <span class="hljs-string">&#x27;traceChip&#x27;</span>,<br>    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;<br>      <span class="hljs-attr">query</span>: <span class="hljs-title function_">toRaw</span>(dataList.<span class="hljs-property">query</span>),<br>      <span class="hljs-attr">queryShow</span>: <span class="hljs-title function_">toRaw</span>(dataList.<span class="hljs-property">queryShow</span>)<br>    &#125;)<br>  )<br>  router.<span class="hljs-title function_">push</span>(&#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/traceDetailChip&#x27;</span>,<br>    <span class="hljs-attr">query</span>: &#123; <span class="hljs-attr">detail</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title function_">toRaw</span>(row.<span class="hljs-property">id</span>)), <span class="hljs-attr">backUrl</span>: <span class="hljs-string">&#x27;trace&#x27;</span> + state.<span class="hljs-property">productInfoType</span> &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>页面初始化时获取缓存，赋予 query，去除缓存，这样在第一次搜索时可以调用 query。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> traceChip = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;traceChip&#x27;</span>))<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;localStorage=&#x27;</span>, traceChip)<br>    <span class="hljs-keyword">if</span> (traceChip) &#123;<br>      dataList.<span class="hljs-property">query</span> = traceChip.<span class="hljs-property">query</span><br>      dataList.<span class="hljs-property">queryShow</span> = traceChip.<span class="hljs-property">queryShow</span><br>      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">&#x27;traceChip&#x27;</span>)<br>    &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="KeepAlive"><a href="#KeepAlive" class="headerlink" title="KeepAlive"></a>KeepAlive</h3><p>默认情况下，一个组件实例在被替换掉后会被销毁。这会导致它丢失其中所有已变化的状态——当这个组件再一次被显示时，会创建一个只带有初始状态的新实例。<br><KeepAlive> 是一个内置组件，它的功能是在多个组件间动态切换时缓存被移除的组件实例。</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vue">&lt;!-- 基础组件 --&gt;<br>&lt;component :is=&quot;activeComponent&quot; /&gt;<br>&lt;!-- 非活跃的组件将会被缓存！ --&gt;<br>&lt;KeepAlive&gt;<br>  &lt;component :is=&quot;activeComponent&quot; /&gt;<br>&lt;/KeepAlive&gt;<br></code></pre></div></td></tr></table></figure><p>【注意】不能在自定义组件中插入 KeepAlive，已测试无效。</p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（27-4）el-table自适应</title>
    <link href="/2023/09/23/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-4%EF%BC%89el-table%E8%87%AA%E9%80%82%E5%BA%94/"/>
    <url>/2023/09/23/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-4%EF%BC%89el-table%E8%87%AA%E9%80%82%E5%BA%94/</url>
    
    <content type="html"><![CDATA[<blockquote><p>el-table 表格长度自适应是交互优化中很重要的一环，本次做了很多尝试，记录一下写法和出现的问题。</p></blockquote><span id="more"></span><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>当前给表格固定了列宽，前后分别设定了部分固定栏（例如：左侧的序号列，右侧的操作列），container 不设置 width，只有一个 min-width，保证页面缩小时内容依然保持一定样式不重叠，页面拉长时表格可以跟随拉长，直至平铺。<br>这对于长表格（列数多）来说没有问题，但对于短表格（列数少），会出现右侧空白，影响整体美观。<br><img src="/../img/vue33-1.png" alt="右侧空白"></p><h3 id="修改方案：按照-width-系数-计算实时列宽"><a href="#修改方案：按照-width-系数-计算实时列宽" class="headerlink" title="修改方案：按照 width * 系数 计算实时列宽"></a>修改方案：按照 width * 系数 计算实时列宽</h3><p>计划采用百分比布局，使其自适应，尝试后发现 el-table-column 并不能识别。所以尝试手动修改比例系数。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span></span><br><span class="hljs-tag">  <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;create_by_name&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;创建人&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:width</span>=<span class="hljs-string">&quot;100 * scaleRate&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">show-overflow-tooltip</span></span><br><span class="hljs-tag">&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>页面初始化时做一次计算，挂载定时器，页面销毁时，卸载定时器。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">calcRate</span>()<br>  <span class="hljs-title function_">windowDraw</span>()<br>&#125;)<br><span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  loadingTable.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>  <span class="hljs-title function_">unWindowDraw</span>()<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>计算系数如下，其中 totalWidth 为列宽的长度总和，64px 为侧栏收起时</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> totalWidth = <span class="hljs-number">1000</span><br><span class="hljs-comment">// 改变窗口大小重新绘制</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">windowDraw</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, resize)<br>&#125;<br><br><span class="hljs-comment">// 改变窗口大小重新绘制</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">unWindowDraw</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, resize)<br>&#125;<br><span class="hljs-comment">// * 定时函数</span><br><span class="hljs-keyword">const</span> timer = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">resize</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-built_in">clearTimeout</span>(timer.<span class="hljs-property">value</span>)<br>  timer.<span class="hljs-property">value</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">calcRate</span>()<br>  &#125;, <span class="hljs-number">200</span>)<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">calcRate</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> innerWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> <span class="hljs-comment">//视口的宽</span><br>  <span class="hljs-keyword">const</span> sidebar = appStore.<span class="hljs-property">getSidebar</span><br>  <span class="hljs-keyword">const</span> isCollapse = !sidebar.<span class="hljs-property">opened</span><br>  <span class="hljs-keyword">let</span> currentWidth<br>  <span class="hljs-keyword">if</span> (isCollapse) &#123;<br>    currentWidth = innerWidth - <span class="hljs-number">64</span> - <span class="hljs-number">96</span> <br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    currentWidth = innerWidth - <span class="hljs-number">208</span> - <span class="hljs-number">96</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (currentWidth &gt;= totalWidth) &#123;<br>    <span class="hljs-keyword">const</span> rate = currentWidth / totalWidth + <span class="hljs-string">&#x27;&#x27;</span><br>    state.<span class="hljs-property">scaleRate</span> = <span class="hljs-title class_">Number</span>(rate.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, rate.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;.&#x27;</span>) + <span class="hljs-number">3</span>))<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>最终效果如下：<br><img src="/../img/vue33-2.png" alt="页面拉长后"><br>基本满足需求，但是因为 js 计算不是很精确，部分表格右侧出现一点空隙，container 的两侧 padding 肉眼可见不一样。</p><h3 id="修改方案：设置-min-width"><a href="#修改方案：设置-min-width" class="headerlink" title="修改方案：设置 min-width"></a>修改方案：设置 min-width</h3><p>思路是放开所有列宽，使其天然自适应，但是发现部分列的比例分配不对，文字容易折行，最好是还是能按照现有比例进行分配。<br>查阅资料后发现有 min-width 这个属性，并且需要所有列宽都设置 min-width，能实现表格拉长时自适应。</p><h3 id="列宽规则总结"><a href="#列宽规则总结" class="headerlink" title="列宽规则总结"></a>列宽规则总结</h3><ol><li>el-table-column 不设置 width 与 minwidth,每一列自适应，宽度一致</li><li>el-table-column 设置 width&#x3D;30%，无效。会被当成 width&#x3D;30px</li><li>每一列都设置 min-width 才能实现每一列的百分比配置</li><li>.el-table-column 同时设置 min-width 和 width 后，该列表格就会按照 width 来设置，相当于 width 就是一个最大宽度</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微前端（4）wujie</title>
    <link href="/2023/08/28/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%884%EF%BC%89wujie/"/>
    <url>/2023/08/28/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%884%EF%BC%89wujie/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录 wujie 相关实验。</p></blockquote><span id="more"></span><h3 id="wujie"><a href="#wujie" class="headerlink" title="wujie"></a>wujie</h3><p>wujie 基于 webcomponent 容器 + iframe 沙箱，能够完善的解决适配成本、样式隔离、运行性能、页面白屏、子应用通信、子应用保活、多应用激活、vite 框架支持、应用共享等用户的核心诉求。</p><h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><ol><li>主应用是 vue 框架，可直接使用 wujie-vue（官方提供基于 vue 封装）</li><li>子应用的资源和接口的请求都在主域名发起，所以会有跨域问题，子应用必须做 cors 设置</li></ol><h3 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h3><p><code>main-app/src/main.ts</code> 主应用中使用 wujie-vue3，这是基于 vue3 已经封装好的语法糖。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;wujie-vue3&#x27;</span><br><span class="hljs-keyword">const</span> &#123; bus, setupApp, preloadApp, destroyApp &#125; = <span class="hljs-title class_">WujieVue</span><br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">WujieVue</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p><code>main-app/src/views/layout/components/app-main.vue</code> 中使用，可通过 props 传参。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">WujieVue</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;vue3&quot;</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&quot; http://127.0.0.1:8081/&quot;</span> <span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;&#123; name: &#x27;ginny&#x27; &#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">WujieVue</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 完整参数如下： --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">WujieVue</span></span><br><span class="hljs-tag">  <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;100%&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;100%&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;xxx&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;xxx&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:sync</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:fiber</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:degrade</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:fetch</span>=<span class="hljs-string">&quot;fetch&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;props&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:plugins</span>=<span class="hljs-string">&quot;plugins&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:beforeLoad</span>=<span class="hljs-string">&quot;beforeLoad&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:beforeMount</span>=<span class="hljs-string">&quot;beforeMount&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:afterMount</span>=<span class="hljs-string">&quot;afterMount&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:beforeUnmount</span>=<span class="hljs-string">&quot;beforeUnmount&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:afterUnmount</span>=<span class="hljs-string">&quot;afterUnmount&quot;</span></span><br><span class="hljs-tag">&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">WujieVue</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><code>child-app/src/XXX.vue</code> 子系统获取传值如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;子应用中通过 props 获取的值&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>.<span class="hljs-property">props</span>.<span class="hljs-property">name</span>)<br></code></pre></div></td></tr></table></figure><h3 id="通过-bus-通信"><a href="#通过-bus-通信" class="headerlink" title="通过 bus 通信"></a>通过 bus 通信</h3><p>wujie 通信方式有通过 window.parent 直接通信，通过 Props 数据注入（见上文）和去中心化 EventBus 通信方式。<br><code>main-app/src/main.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> &#123; bus &#125; = <span class="hljs-title class_">WujieVue</span><br><br><span class="hljs-comment">// 主应用监听事件</span><br>bus.$on(<span class="hljs-string">&quot;事件名字&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">arg1, arg2, ...</span>) &#123;&#125;);<br><span class="hljs-comment">// 主应用发送事件</span><br>bus.$emit(<span class="hljs-string">&quot;事件名字&quot;</span>, arg1, arg2, ...);<br><span class="hljs-comment">// 主应用取消事件监听</span><br>bus.$off(<span class="hljs-string">&quot;事件名字&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">arg1, arg2, ...</span>) &#123;&#125;);<br></code></pre></div></td></tr></table></figure><p><code>child-app/src/main.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">declare <span class="hljs-variable language_">global</span> &#123;<br>  interface <span class="hljs-title class_">Window</span> &#123;<br>    <span class="hljs-attr">$wujie</span>: &#123;<br>      <span class="hljs-attr">props</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt;<br>      <span class="hljs-attr">bus</span>: &#123;<br>        <span class="hljs-attr">$emit</span>: any<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>child-app/src/XXX.vue</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 子应用监听事件</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$on(<span class="hljs-string">&quot;事件名字&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">arg1, arg2, ...</span>) &#123;&#125;);<br><span class="hljs-comment">// 子应用发送事件</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">&quot;事件名字&quot;</span>, arg1, arg2, ...);<br><span class="hljs-comment">// 子应用取消事件监听</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$off(<span class="hljs-string">&quot;事件名字&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">arg1, arg2, ...</span>) &#123;&#125;);<br></code></pre></div></td></tr></table></figure><h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>beforeLoad：子应用开始加载静态资源前触发<br>beforeMount：子应用渲染前触发（生命周期改造专用）<br>afterMount：子应用渲染后触发（生命周期改造专用）<br>beforeUnmount：子应用卸载前触发（生命周期改造专用）<br>afterUnmount：子应用卸载后触发（生命周期改造专用）<br>activated：子应用进入后触发（保活模式专用）<br>deactivated：子应用离开后触发（保活模式专用）</p><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><ol><li><WujieVue> 挂载到哪里最合适？</li><li>应用切换时 URL 不会发生改变，如果使用动态路由，怎么获取对应的后缀？通过 props 传值？</li><li>“无界微前端不仅能够做到静态资源的预加载，还可以做到子应用的预执行”，怎么操作？</li></ol><h3 id="使用感受"><a href="#使用感受" class="headerlink" title="使用感受"></a>使用感受</h3><ol><li>改造成本不高，主要是主应用需要改造，子应用的适配只需要开启跨域支持即可（不涉及通信的情况下）</li></ol><p>默认运行的方式是重建模式。当子应用设置为保活模式，切换子应用后仍然可以保持子应用的状态和路由不会丢失。<br><img src="/../img/microfe-2.png" alt="子应用适配生命周期适配进入不同的运行模式"></p><h3 id="公司应用配置"><a href="#公司应用配置" class="headerlink" title="公司应用配置"></a>公司应用配置</h3><p>版本：”wujie-vue3”: “^1.0.22”</p><h4 id="主应用"><a href="#主应用" class="headerlink" title="主应用"></a>主应用</h4><p><code>public/config.js</code>中配置子应用信息</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">THIRD_APPS</span> = [<br>    &#123;<br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;controller-app&#x27;</span>,<br>        <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;http://***&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">        name: &#x27;</span>af3-app<span class="hljs-string">&#x27;,</span><br><span class="hljs-string">        url: &#x27;</span><span class="hljs-attr">http</span>:<span class="hljs-comment">//***&#x27;</span><br>    &#125;<br>]<br></code></pre></div></td></tr></table></figure><p><code>main.ts</code>中引入：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;wujie-vue3&#x27;</span><br><span class="hljs-comment">// 创建实例</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">setupAll</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)<br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">WujieVue</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br>&#125;<br><br><span class="hljs-title function_">setupAll</span>()<br></code></pre></div></td></tr></table></figure><p>应用中心，设置微前端入口</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">gotoController</span> = (<span class="hljs-params">pane: any, ev: any</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;pane: &#x27;</span>, pane)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ev: &#x27;</span>, ev)<br>  <span class="hljs-keyword">if</span> (pane?.<span class="hljs-property">props</span>?.<span class="hljs-property">name</span> == <span class="hljs-string">&#x27;controller&#x27;</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; href &#125; = router.<span class="hljs-title function_">resolve</span>(&#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/controller&#x27;</span><br>    &#125;)<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = href<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pane?.<span class="hljs-property">props</span>?.<span class="hljs-property">name</span> == <span class="hljs-string">&#x27;app&#x27;</span>) &#123;<br>    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/app/center&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>/views/ThirdApp/page.vue</code> 中，点击应用卡片，跳转到子应用，名字对应之前配置的地址。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">toTry</span> = (<span class="hljs-params">name: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (name === <span class="hljs-string">&#x27;AF3&#x27;</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; href &#125; = router.<span class="hljs-title function_">resolve</span>(&#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/thirdApp&#x27;</span>,<br>      <span class="hljs-attr">query</span>: &#123;<br>        <span class="hljs-attr">app</span>: <span class="hljs-string">&#x27;af3-app&#x27;</span><br>      &#125;<br>    &#125;)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;href: &#x27;</span>, href)<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(href, <span class="hljs-string">&#x27;_blank&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>router/index.ts</code> 中配置了子应用渲染的路由</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/thirdApp&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/ThirdApp/index.vue&#x27;</span>),<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ThirdApp&#x27;</span>,<br>    <span class="hljs-attr">meta</span>: &#123;<br>      <span class="hljs-attr">hidden</span>: <span class="hljs-literal">true</span><br>    &#125;<br>  &#125;<br></code></pre></div></td></tr></table></figure><p><code>ThirdApp/index.vue</code>中，主应用向子应用传参数。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--单例模式，name相同则复用一个无界实例，改变url则子应用重新渲染实例到对应路由 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">WujieVue</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;100%&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;100%&quot;</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">:url</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;&#123; userId: &#x27;12345678&#x27; &#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useUserStoreWithOut &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store/modules/user&#x27;</span><br><br><span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStoreWithOut</span>()<br><span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()<br><span class="hljs-keyword">const</span> name = route?.<span class="hljs-property">query</span>?.<span class="hljs-property">app</span><br><span class="hljs-keyword">const</span> url = <span class="hljs-variable language_">window</span>?.<span class="hljs-property">THIRD_APPS</span>?.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item: any</span>) =&gt;</span> item.<span class="hljs-property">name</span> == name)?.<span class="hljs-property">url</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;name: &#x27;</span>, name)<br></code></pre></div></td></tr></table></figure><h4 id="子应用"><a href="#子应用" class="headerlink" title="子应用"></a>子应用</h4><p>子应用中<code>main.ts</code>中引入，可直接获取主应用的传值：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;wujie-vue3&#x27;</span><br><span class="hljs-keyword">import</span> &#123; setToken, setUserInfo &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils/cookies&#x27;</span><br><br><span class="hljs-comment">// 创建实例</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">setupAll</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)<br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">WujieVue</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;__POWERED_BY_WUJIE__: &#x27;</span>, <span class="hljs-variable language_">window</span>?.<span class="hljs-property">__POWERED_BY_WUJIE__</span>)<br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>?.<span class="hljs-property">__POWERED_BY_WUJIE__</span>) &#123;<br>  <span class="hljs-title function_">setToken</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>.<span class="hljs-property">props</span>.<span class="hljs-property">token</span>) <br>  <span class="hljs-title function_">setUserInfo</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>.<span class="hljs-property">props</span>.<span class="hljs-property">userInfo</span>)<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>?.<span class="hljs-property">__POWERED_BY_WUJIE__</span>) &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__WUJIE_MOUNT</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setupAll</span>()<br>  &#125;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__WUJIE_UNMOUNT</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>    app.<span class="hljs-title function_">unmount</span>()<br>  &#125;<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">    由于vite是异步加载，而无界可能采用fiber执行机制</span><br><span class="hljs-comment">    所以mount的调用时机无法确认，框架调用时可能vite</span><br><span class="hljs-comment">    还没有加载回来，这里采用主动调用防止用没有mount</span><br><span class="hljs-comment">    无界mount函数内置标记，不用担心重复mount</span><br><span class="hljs-comment">  */</span><br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__WUJIE</span>.<span class="hljs-title function_">mount</span>()<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-title function_">setupAll</span>()<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>types/global.d.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">interface <span class="hljs-title class_">Window</span> &#123;<br>  readonly <span class="hljs-attr">APP_CONFIG</span>: any<br>  readonly <span class="hljs-attr">BASIC_CONFIG</span>: any<br>  readonly <span class="hljs-attr">THIRD_APPS</span>: any<br>  <span class="hljs-attr">$wujie</span>: any<br>  <span class="hljs-comment">// 是否存在无界</span><br>  __POWERED_BY_WUJIE__?: boolean<br>  <span class="hljs-comment">// 子应用mount函数</span><br>  <span class="hljs-attr">__WUJIE_MOUNT</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span><br>  <span class="hljs-comment">// 子应用unmount函数</span><br>  <span class="hljs-attr">__WUJIE_UNMOUNT</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span><br>  <span class="hljs-comment">// 子应用无界实例</span><br>  <span class="hljs-attr">__WUJIE</span>: &#123; <span class="hljs-attr">mount</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span> &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://wujie-micro.github.io/doc/">无界（基于iframe）</a><br><a href="https://juejin.cn/post/7226166316670730296?from=search-suggest">微前端实际应用案例剖析（wujie）</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>微前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微前端（3）qiankun</title>
    <link href="/2023/08/24/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%883%EF%BC%89qiankun/"/>
    <url>/2023/08/24/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%883%EF%BC%89qiankun/</url>
    
    <content type="html"><![CDATA[<blockquote><p>在各种评价对比，以及咨询大佬之后，决定先试一下乾坤。</p></blockquote><span id="more"></span><h3 id="qiankun"><a href="#qiankun" class="headerlink" title="qiankun"></a>qiankun</h3><ol><li>single-spa + sandbox + import-html-entry</li><li>实现了 js 沙箱以及微应用和主应用的样式隔离，样式的隔离还可以选择严格模式即 shadow DOM；html entry 的方式引入子应用，相比 js entry 极大的降低了应用改造的成本；有静态资源预加载能力；</li><li>提供了通信方案：onGlobalStateChange 实现主应用与微应用、微应用之间的通信。主应用初始化全局状态同时监听 statechange ；微应用同样也可以监听 statechange 和设置 state ，但必须在 mount 中设置；</li><li>使用 qiankun 的时候需要注意必须创建一个 public-path.js 文件，否则所有的静态资源都不能正常获取到；</li></ol><h3 id="项目目录"><a href="#项目目录" class="headerlink" title="项目目录"></a>项目目录</h3><p>|——common&#x2F;                # 存放共用的工具库<br>|——components&#x2F;            # 存放公共的组件库<br>|——main-app&#x2F;              # 存放主应用 main-app 的文件夹<br>|——child-app&#x2F;             # 存放微应用 children-app 的文件夹<br>|——…..                   #<br>|——qiankun.conf            # 配置文件<br>|——build.sh                # 打包脚本</p><h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><ol><li>基于现有框架，简化一个 base 版本做测试 demo，main-app 代表 UMS，child-app 代表 PLCS 系列中的一个子应用。</li><li>通过 main-app 访问 child-app。</li></ol><h3 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h3><p>主应用中设置挂载 DOM <code>main-app/src/App.vue</code></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;subApp&quot;</span>&gt;</span>这里是child app<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>主应用中进行注册 <code>main-app/src/main.ts</code>，当 URL 切换到子应用时，加载子应用并渲染到对应 DOM 节点上。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; registerMicroApps, start &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;qiankun&#x27;</span><br><br><span class="hljs-title function_">registerMicroApps</span>(<br>  [<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;app-demo&#x27;</span>,<br>      <span class="hljs-attr">entry</span>: <span class="hljs-string">&#x27;http://127.0.0.1:8083&#x27;</span>,<br>      <span class="hljs-attr">container</span>: <span class="hljs-string">&#x27;#subApp&#x27;</span>,<br>      <span class="hljs-attr">activeRule</span>: <span class="hljs-string">&#x27;/app-demo&#x27;</span><br>    &#125;<br>  ],<br>  &#123;<br>    <span class="hljs-attr">beforeLoad</span>: <span class="hljs-keyword">async</span> (app) =&gt; &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;before load&#x27;</span>, app)<br>      <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">&#x27;child app&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">beforeMount</span>: [<br>      <span class="hljs-keyword">async</span> (app) =&gt; &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;before mount&#x27;</span>, app.<span class="hljs-property">name</span>)<br>      &#125;<br>    ]<br>  &#125;<br>)<br><br><span class="hljs-title function_">start</span>()<br></code></pre></div></td></tr></table></figure><p>子应用（基于vite）使用<code>vite-plugin-qiankun</code>这个插件。修改<code>child-app/vite.config.ts</code>，需要关闭热更新，开启跨域共享。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> qiankun <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite-plugin-qiankun&#x27;</span><br><br><span class="hljs-keyword">const</span> useDevMode = <span class="hljs-literal">true</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">base</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>  <span class="hljs-attr">server</span>: &#123;<br>    <span class="hljs-attr">port</span>: <span class="hljs-number">8083</span>,<br>    <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-attr">headers</span>: &#123;<br>      <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="hljs-string">&#x27;*&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">hmr</span>: !useDevMode,<br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-title function_">qiankun</span>(<span class="hljs-string">&#x27;app-demo&#x27;</span>, &#123;<br>      useDevMode<br>    &#125;)<br>  ]<br>&#125;)<br></code></pre></div></td></tr></table></figure><p> <code>main-child/src/main.ts</code> 中判断是否是 qiankun 环境，非环境和之前一样渲染，或是在环境中，使用库自带的渲染。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; renderWithQiankun, qiankunWindow &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite-plugin-qiankun/dist/helper&#x27;</span><br><br><span class="hljs-keyword">let</span> <span class="hljs-attr">app</span>: <span class="hljs-title class_">VueApp</span>&lt;<span class="hljs-title class_">Element</span>&gt;<br><br><span class="hljs-keyword">if</span> (!qiankunWindow.<span class="hljs-property">__POWERED_BY_QIANKUN__</span>) &#123;<br>  app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)<br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementUI</span>, &#123;<br>    <span class="hljs-attr">locale</span>: zh<br>  &#125;)<br>  <span class="hljs-title function_">setupStore</span>(app)<br>  app.<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-title function_">renderWithQiankun</span>(&#123;<br>    <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;--mount&#x27;</span>)<br><br>      app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)<br>      app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementUI</span>, &#123;<br>        <span class="hljs-attr">locale</span>: zh<br>      &#125;)<br>      <span class="hljs-title function_">setupStore</span>(app)<br>      app<br>        .<span class="hljs-title function_">use</span>(router)<br>        .<span class="hljs-title function_">mount</span>(<br>          (props.<span class="hljs-property">container</span><br>            ? props.<span class="hljs-property">container</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br>            : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;app&#x27;</span>)) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Element</span><br>        )<br>    &#125;,<br>    <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;--bootstrap&#x27;</span>)<br>    &#125;,<br>    <span class="hljs-title function_">update</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;--update&#x27;</span>)<br>    &#125;,<br>    <span class="hljs-title function_">unmount</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;--unmount&#x27;</span>)<br>      app?.<span class="hljs-title function_">unmount</span>()<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><ol><li>按照教程主应用中输入给定的 url，出现 404<br><img src="/../img/microfe-1.png" alt="404"></li><li>#subApp 只能放在 App.vue 中，放在 Layout 里面找不到</li><li>先找到 #subApp，然后把 DOM 元素替换，但是并没有渲染出来子系统</li><li>看官方 demo，猜测需要 build 之后，用服务启动</li><li>build 之后，#app 中没有渲染。子应用访问地址和 httpserver 启动的地址有冲突，会自动加上一段（<a href="http://127.0.0.1:8082/localhost:8082%EF%BC%89%EF%BC%8C%E9%99%A4%E9%9D%9E%E6%8D%A2%E4%B8%AA%E7%AB%AF%E5%8F%A3%E5%90%AF%E5%8A%A8%EF%BC%8C%E4%B8%8D%E7%90%86%E8%A7%A3">http://127.0.0.1:8082/localhost:8082），除非换个端口启动，不理解</a> vite.config.ts 中配置应该怎么写？没有渲染是不是因为配置问题。</li></ol><h3 id="使用感受"><a href="#使用感受" class="headerlink" title="使用感受"></a>使用感受</h3><ol><li>上手有一定学习成本；（适配成本比较高，工程化、生命周期、静态资源路径、路由等都要做一系列的适配工作）</li><li>当前项目框架需要使用第三方库，如果 qiankun 升级，第三方库必须跟着升级；若出现问题，不方便定位是库的问题还是当前项目使用的问题。使用第三方库增加了一层成本；</li></ol><p><code>附录</code><br><a href="https://qiankun.umijs.org/zh/guide">乾坤</a><br><a href="https://juejin.cn/post/7116002929168875533">Vue3 + Vite + qiankun微前端实践</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>微前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（32）交互优化写法综合</title>
    <link href="/2023/08/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8832%EF%BC%89%E4%BA%A4%E4%BA%92%E4%BC%98%E5%8C%96%E5%86%99%E6%B3%95%E7%BB%BC%E5%90%88/"/>
    <url>/2023/08/22/vue3%E7%AC%94%E8%AE%B0%EF%BC%8832%EF%BC%89%E4%BA%A4%E4%BA%92%E4%BC%98%E5%8C%96%E5%86%99%E6%B3%95%E7%BB%BC%E5%90%88/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录涉及到的交互优化，包括：页面停留时间超过一小时跳转登录页、“请求过于频繁，建议5分钟后再试”、按钮防抖。</p></blockquote><span id="more"></span><h3 id="页面停留时间超过一小时跳转登录页"><a href="#页面停留时间超过一小时跳转登录页" class="headerlink" title="页面停留时间超过一小时跳转登录页"></a>页面停留时间超过一小时跳转登录页</h3><p>设计思路：页面打开时设置定时器，每 3分钟 轮询一次，获取当前时间和初始时间的时间差，若轮询多次后时间差超过1小时，则跳转登录页面。<br>时间差计算函数如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 返回true-停留时间已满1小时</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">timeDiffStay</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> timeOut = <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 设置超时时间</span><br>  <span class="hljs-keyword">const</span> lastTime = <span class="hljs-title class_">Number</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;comeTime&#x27;</span>))<br>  <span class="hljs-keyword">const</span> currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()<br>  <span class="hljs-keyword">let</span> diff = currentTime - lastTime<br>  <span class="hljs-keyword">if</span> (diff &gt; timeOut) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>页面初始化存入初始时间，开启定时器；卸载时清除定时器；</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;comeTime&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>().<span class="hljs-title function_">toString</span>())<br>  state.<span class="hljs-property">pageInterval</span> = <span class="hljs-built_in">setInterval</span>(checkTimeout, <span class="hljs-number">3</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)<br>&#125;)<br><span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">&#x27;comeTime&#x27;</span>)<br>  state.<span class="hljs-property">pageInterval</span> &amp;&amp; <span class="hljs-built_in">clearInterval</span>(state.<span class="hljs-property">pageInterval</span>)<br>&#125;)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkTimeout</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">timeDiffStay</span>()) &#123;<br>    <span class="hljs-built_in">clearInterval</span>(state.<span class="hljs-property">pageInterval</span>)<br>    <span class="hljs-title function_">toLogin</span>()<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="请求过于频繁，建议5分钟后再试"><a href="#请求过于频繁，建议5分钟后再试" class="headerlink" title="请求过于频繁，建议5分钟后再试"></a>请求过于频繁，建议5分钟后再试</h3><p>设置5分钟内点击4次为频繁操作</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSendCode</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  state.<span class="hljs-property">disCode</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 防止点击两次</span><br>  state.<span class="hljs-property">sendCount</span> = state.<span class="hljs-property">sendCount</span> + <span class="hljs-number">1</span><br>  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">sendCount</span> == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">&#x27;lastClickTime&#x27;</span>)<br>        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;lastClickTime&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>().<span class="hljs-title function_">toString</span>())<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state.<span class="hljs-property">sendCount</span> == <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-keyword">const</span> diffMin = <span class="hljs-title function_">timeDifference</span>()<br>        <span class="hljs-keyword">if</span> (diffMin &lt;= <span class="hljs-number">5</span>) &#123;<br>          <span class="hljs-title class_">ElMessage</span>(<span class="hljs-string">&#x27;请求过于频繁，建议5分钟后再试&#x27;</span>)<br>          state.<span class="hljs-property">sendCount</span> = <span class="hljs-number">0</span><br>          state.<span class="hljs-property">disCode5Min</span> = <span class="hljs-literal">true</span><br>          <span class="hljs-keyword">const</span> times = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;禁止时间到了&#x27;</span>)<br>            <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>              state.<span class="hljs-property">disCode5Min</span> = <span class="hljs-literal">false</span><br>              state.<span class="hljs-property">disCode</span> = <span class="hljs-literal">false</span><br>            &#125;)<br>            <span class="hljs-built_in">clearInterval</span>(times)<br>          &#125;, <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>)<br>          <span class="hljs-keyword">return</span><br>        &#125;<br>      &#125;<br>      <span class="hljs-comment">// 触发倒计时</span><br>      state.<span class="hljs-property">notSend</span> = <span class="hljs-literal">false</span><br>      <span class="hljs-title function_">handleCountDownTimeSendCode</span>()<br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;邮箱：&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;email&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;emailForm.email&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入绑定的邮箱&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;emailInputRef&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">suffix</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span><br><span class="hljs-tag">          <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;notSend&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">:disabled</span>=<span class="hljs-string">&quot;disCode || disCode5Min&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click.stop</span>=<span class="hljs-string">&quot;handleSendCode&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn-sendcode&quot;</span></span><br><span class="hljs-tag">          &gt;</span>获取验证码&lt;/el-button<br>        &gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn-sendcode&quot;</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">&quot;disCode&quot;</span>&gt;</span><br>          &#123;&#123; countDownTimeSendCode &#125;&#125;s后再获取<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue32-1.png" alt="获取验证码-原始"><br><img src="/../img/vue32-2.png" alt="获取验证码-发送"></p><h3 id="按钮防抖"><a href="#按钮防抖" class="headerlink" title="按钮防抖"></a>按钮防抖</h3><p>项目中使用_lodash，设计一秒钟只能点击一次</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; debounce &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash-es&#x27;</span><br><span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> &#123;&#125;, <span class="hljs-number">1000</span>)<br></code></pre></div></td></tr></table></figure><p><code>javascript</code></p><h3 id="交互优化目标"><a href="#交互优化目标" class="headerlink" title="交互优化目标"></a>交互优化目标</h3><ol><li>产品目标：优先完成功能开发，设计优先配合功能开发</li><li>体验目标：各个角色的使用故事线完整、且清晰顺畅</li></ol><h3 id="交互优化点-管理系统相关"><a href="#交互优化点-管理系统相关" class="headerlink" title="交互优化点-管理系统相关"></a>交互优化点-管理系统相关</h3><ol><li><p>信息归类、主次分级</p></li><li><p>按钮主次，高频使用按钮直接显示，低频使用按钮以 … （鼠标悬浮展示隐藏的下拉列表）。好处：多留内容给主体部分。</p></li><li><p>增加页面主体内容比重（例如：使用多栏展示）。好处：用户在有限视线范围内获取更多信息。</p></li><li><p>区分高&#x2F;低频操作，降低操作链路</p></li><li><p>搜索内容主次，高频使用（一般为 name ）直接展示，低频使用以 filter 按钮隐藏，点击后展示。</p></li><li><p>降低操作难度、防止误操作</p></li><li><p>搜索项 tag 展示，点击可删除，也可一键清空。好处：用户可以选择性搜索。</p></li><li><p>按钮满足条件触发，初始化 disabled，使用 tooltip 包裹，提示用户操作。满足条件时按钮真实可用。好处：防止用户误操作，减少交互成本。</p></li><li><p>用户操作（例如：选择）后对内容进行有选择性提示（例如：总数）。好处：帮助用户更容易进行下一步操作。</p></li><li><p>布局规范统一</p></li><li><p>按钮位置，基本在页面右侧。好处：强化用户习惯。</p></li><li><p>多内容区域卡片分级展示。</p></li><li><p>调整色彩识别性、增强区分度</p></li><li><p>不同状态使用不同颜色 tag 表示，各个页面保持一致</p></li><li><p>业务流程图&#x2F;功能全景图可视化</p></li><li><p>使用图表代替文字</p></li><li><p>页面跳转增加互相联系。</p></li><li><p>提示优化 </p></li><li><p>提示语尽量不使用感叹号 </p></li><li><p>页面主体部分尽量不使用警告色（例如：删除按钮不用红色）</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微前端（2）基于实际业务的思考-previous</title>
    <link href="/2023/08/18/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%882%EF%BC%89%E5%9F%BA%E4%BA%8E%E5%AE%9E%E9%99%85%E4%B8%9A%E5%8A%A1%E7%9A%84%E6%80%9D%E8%80%83previous/"/>
    <url>/2023/08/18/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%882%EF%BC%89%E5%9F%BA%E4%BA%8E%E5%AE%9E%E9%99%85%E4%B8%9A%E5%8A%A1%E7%9A%84%E6%80%9D%E8%80%83previous/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇是实际业务的思考，previous 代表选型前期，基于目前的框架使用和业务发展的预测，可能后期会推翻，暂时先做一个记录。</p></blockquote><span id="more"></span><h3 id="当前业务"><a href="#当前业务" class="headerlink" title="当前业务"></a>当前业务</h3><p>用户管理系统（UMS）：用户管理、系统管理、菜单管理、权限管理、监控日志<br>产品追溯系统（PTS）：产品生命周期追溯、客户管理、产品管理<br>订单管理系统（OMS）：订单管理、对接出入库明细<br>出入库管理系统（WMS）：仓库管理、产品入库管理<br>质量管理系统（QDS）：竞品管理、产品对比、属性管理、运行环境管理、产品数据管理、标准体系、问题清单</p><h3 id="当前框架"><a href="#当前框架" class="headerlink" title="当前框架"></a>当前框架</h3><p>基于 Vue3 + Vite (库使用 Element Plus + Pinia) ，除 UMS 外基本样式统一（Navbar、Sidebar），组件基本保持一致。</p><h3 id="主要痛点"><a href="#主要痛点" class="headerlink" title="主要痛点"></a>主要痛点</h3><ol><li>目前不同项目采用手动替换文件，需要统一样式、共享组件、共享通用方法；</li><li>运行时构建时间过长；(初步估计为编译&#x2F;转化文件过多导致)</li><li>基于 chrome ，暂时未使用 polyfill 之类的通用浏览器支持；</li><li>PLCS 用户登录后，直接输入其他子系统 URL ，无法触发首次登录修改密码。（操作概率非常非常小）</li><li>子系统之间不方便横跳，因为子系统通过动态菜单获取本系统权限，无法得知其他系统权限，UMS 首页也仅可获知是否有子系统进入权限，无法细节到具体菜单权限。(来自用户需求，可通过教育用户解决)</li></ol><h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>若使用微前端，需要对以下部分做一个抽离：</p><ol><li>src&#x2F;assets 中公用images（logo, 404, icon）、公用css（ common, element-variables, transition, index部分）</li><li>src&#x2F;components 中 公用组件（Breadcrumb, Hamburger, File…）这部分内容应该是各个系统沉淀的，在业务发展过程中根据设计要求改写的组件，复用到其他系统</li><li>config&#x2F;axios 这部分待考量，因为涉及到实际业务改写。</li><li>hooks&#x2F; 这部分还没有完善</li><li>store&#x2F; 虽然代码差不多，感觉还是各个系统独立维护</li><li>types&#x2F; 这里是自动导入的，不确定</li><li>utils&#x2F; 部分公用工具逻辑需要</li><li>views&#x2F;layout 公用样式需要</li></ol><p>公用部分应该在一个服务器的存储空间里，前端保持维护，运维定期备份。</p><h3 id="需要实现（基于现有基础）"><a href="#需要实现（基于现有基础）" class="headerlink" title="需要实现（基于现有基础）"></a>需要实现（基于现有基础）</h3><ol><li>UMS 负责整体布局、Navbar（导航可以在 Navbar 最左侧），登录页面等通用页面</li><li>UMS 负责子应用的注册引入和管理</li><li>使用 common 公用方法库</li><li>使用 components 共用组件库</li></ol><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ol><li>分开打包时关于组件、样式的引用怎么写？项目中没找到报错？</li><li>先设计子系统和 UMS 通信，再考虑子系统之间通信？</li><li>“UMS 作为基座，负责加载公用逻辑，其他子系统共享。”这样不就是 monorepo 形式？不方便让其他系统单独开发了。</li></ol><h3 id="10-8更新"><a href="#10-8更新" class="headerlink" title="10.8更新"></a>10.8更新</h3><p>若只把 UMS 作为一个框架，不考虑组件复用、样式复用问题，应该也可行。<br>UMS 顶部导航作为消息共享区域，用户信息、子系统访问权限、消息推送（若有）、文档等其他功能。<br>子系统只需要专注于主体部分，可能涉及子系统之间跳转（例如：根据订单号跳转到订单管理系统，前提是有权限）。</p><h3 id="10-23更新"><a href="#10-23更新" class="headerlink" title="10.23更新"></a>10.23更新</h3><p>当前测试 ice 框架可实现最基本需求，若进一步修改，涉及以下部分：<br>UMS：</p><ol><li>Navbar 中根据 URL 替换标题、图标（子系统的 Navbar 都需要在 UMS 中写一份）</li><li>判断是 UMS 本系统，渲染其他功能入口（首页、控制台、消息管理、操作日志、个人中心、修改密码）</li><li>设置共享状态（token、userInfo、sysAccess）<br>子系统：</li><li>判断在当前系统中，渲染 Navbar（SimpleLayout&#x2F;OtherLayout）</li><li>获取共享状态<br>优化项：预加载<br>需要保证：</li><li>单独系统按照之前模式可以正常运行</li><li>改造后不会引入新 bug</li><li>就只有最初简单的改造成本，后续开发成本不会增加</li><li>系统运行效率有一定提升（加分项）</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>微前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（31）图形验证码</title>
    <link href="/2023/08/14/vue3%E7%AC%94%E8%AE%B0%EF%BC%8831%EF%BC%89%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81/"/>
    <url>/2023/08/14/vue3%E7%AC%94%E8%AE%B0%EF%BC%8831%EF%BC%89%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<blockquote><p>重写登录模块，里面有个忘记密码功能，需要发邮件找回，为了增加安全性，也需要增加一个输入验证码功能。本篇做一个记录。 </p></blockquote><span id="more"></span><h3 id="前期调研"><a href="#前期调研" class="headerlink" title="前期调研"></a>前期调研</h3><p>网上查阅资料，关于图形验证码的生成，第一种是前端直接生成，第二种是后端生成一个二进制图片流，前端加载图片。<br>操作步骤：页面初始化时加载验证码，用户在输入框中输入图片中的数字&#x2F;文字&#x2F;答案，将输入传递给后端验证。有“刷新验证码”功能，点击后实现图片替换。</p><h3 id="后端生成-图片流加载"><a href="#后端生成-图片流加载" class="headerlink" title="后端生成-图片流加载"></a>后端生成-图片流加载</h3><p>将后端返回的二进制图片流转换成base64的图片，塞给image标签。这种方式，http的请求头responseType必须是arrayBuffer。<br>btoa() 方法可以将一个二进制字符串（例如，将字符串中的每一个字节都视为一个二进制数据字节）编码为 Base64 编码的 ASCII 字符串。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data);<br><span class="hljs-keyword">let</span> storeData = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">let</span> len = bytes.<span class="hljs-property">byteLength</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>    storeData += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(bytes[i]);<br>&#125;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">imgUrl</span> = <span class="hljs-string">&quot;data:image/png;base64,&quot;</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">btoa</span>(storeData);<br></code></pre></div></td></tr></table></figure><h3 id="前端生成-canvas"><a href="#前端生成-canvas" class="headerlink" title="前端生成-canvas"></a>前端生成-canvas</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">GVerify</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/piccode&#x27;</span><br><span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>(&#123;<br>  <span class="hljs-attr">width</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,<br>    <span class="hljs-attr">default</span>: <span class="hljs-number">200</span><br>  &#125;,<br>  <span class="hljs-attr">height</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,<br>    <span class="hljs-attr">default</span>: <span class="hljs-number">60</span><br>  &#125;<br>&#125;)<br><br><span class="hljs-keyword">let</span> verifyCode = <span class="hljs-literal">null</span><br><span class="hljs-keyword">const</span> picyzm = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)<br><br><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;&#x27;</span><br>&#125;)<br><span class="hljs-keyword">const</span> &#123; code &#125; = <span class="hljs-title function_">toRefs</span>(state)<br><span class="hljs-keyword">const</span> code_content = <span class="hljs-title function_">ref</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-comment">//刷新验证码</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">OnRefresh</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  verifyCode.<span class="hljs-title function_">refresh</span>()<br>  <span class="hljs-keyword">const</span> code = verifyCode.<span class="hljs-title class_">GetCode</span>()<br>  code_content.<span class="hljs-property">value</span> = code<br>&#125;<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  picyzm.<span class="hljs-property">value</span> &amp;&amp; picyzm.<span class="hljs-property">value</span>.<span class="hljs-title function_">focus</span>()<br>  <span class="hljs-comment">//初始化验证码</span><br>  verifyCode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GVerify</span>(&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;blend&#x27;</span>,<br>    <span class="hljs-attr">height</span>: props.<span class="hljs-property">height</span>,<br>    <span class="hljs-attr">con</span>: picyzm.<span class="hljs-property">value</span><br>  &#125;)<br><br>  <span class="hljs-comment">//获取验证码内容</span><br>  <span class="hljs-keyword">const</span> code = verifyCode.<span class="hljs-title class_">GetCode</span>()<br>  code_content.<span class="hljs-property">value</span> = code<br>&#125;)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (code_content.<span class="hljs-property">value</span>.<span class="hljs-title function_">toLowerCase</span>() !== state.<span class="hljs-property">code</span>.<span class="hljs-title function_">toLowerCase</span>()) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;验证码输入不正确&#x27;</span>):<br>    verifyCode.<span class="hljs-title function_">refresh</span>()<br>    <span class="hljs-keyword">const</span> code = verifyCode.<span class="hljs-title class_">GetCode</span>()<br>    code_content.<span class="hljs-property">value</span> = code<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">PassWordRandom</span> = (<span class="hljs-params">count</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> str = <span class="hljs-string">&#x27;a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,0,1,2,3,4,5,6,7,8,9&#x27;</span><br>  <span class="hljs-keyword">const</span> arr = str.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>)<br>  <span class="hljs-keyword">let</span> rand = <span class="hljs-string">&#x27;&#x27;</span><br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>    rand += arr[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">36</span>)]<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> rand<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>utils/piccode</code> 代码如下：（基于开源版本修改）</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/** 生成字母数组* */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAllLetter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> letterStr =<br>    <span class="hljs-string">&#x27;a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z&#x27;</span><br><br>  <span class="hljs-keyword">return</span> letterStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>)<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">randomNum</span>(<span class="hljs-params">min, max</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (max - min) + min)<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">randomColor</span>(<span class="hljs-params">min, max</span>) &#123;<br>  <span class="hljs-keyword">const</span> r = <span class="hljs-title function_">randomNum</span>(min, max)<br>  <span class="hljs-keyword">const</span> g = <span class="hljs-title function_">randomNum</span>(min, max)<br>  <span class="hljs-keyword">const</span> b = <span class="hljs-title function_">randomNum</span>(min, max)<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;rgb(&#x27;</span> + r + <span class="hljs-string">&#x27;,&#x27;</span> + g + <span class="hljs-string">&#x27;,&#x27;</span> + b + <span class="hljs-string">&#x27;)&#x27;</span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GVerify</span>(<span class="hljs-params">options</span>) &#123;<br>  <span class="hljs-comment">// 创建一个图形验证码对象，接收options对象为参数</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = &#123;<br>    <span class="hljs-comment">// 默认options参数值</span><br>    <span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// 容器Id</span><br>    <span class="hljs-attr">canvasId</span>: <span class="hljs-string">&#x27;verifyCanvas&#x27;</span>, <span class="hljs-comment">// canvas的ID</span><br>    <span class="hljs-attr">width</span>: <span class="hljs-string">&#x27;174&#x27;</span>, <span class="hljs-comment">// 默认canvas宽度</span><br>    <span class="hljs-attr">height</span>: <span class="hljs-string">&#x27;68&#x27;</span>, <span class="hljs-comment">// 默认canvas高度</span><br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;blend&#x27;</span>, <span class="hljs-comment">// 图形验证码默认类型blend:数字字母混合类型、number:纯数字、letter:纯字母</span><br>    <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">con</span>: <span class="hljs-literal">null</span><br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(options) == <span class="hljs-string">&#x27;[object Object]&#x27;</span>) &#123;<br>    <span class="hljs-comment">// 判断传入参数类型</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">in</span> options) &#123;<br>      <span class="hljs-comment">// 根据传入的参数，修改默认参数值</span><br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>[i] = options[i]<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">id</span> = options<br>  &#125;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">numArr</span> =<br>    <span class="hljs-string">&#x27;0,1,2,3,4,5,6,7,8,9,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z&#x27;</span>.<span class="hljs-title function_">split</span>(<br>      <span class="hljs-string">&#x27;,&#x27;</span><br>    )<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">letterArr</span> = <span class="hljs-title function_">getAllLetter</span>()<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_init</span>()<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refresh</span>()<br>&#125;<br><br><span class="hljs-title class_">GVerify</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = &#123;<br>  <span class="hljs-comment">/** 版本号* */</span><br>  <span class="hljs-attr">version</span>: <span class="hljs-string">&#x27;1.0.0&#x27;</span>,<br><br>  <span class="hljs-comment">/** 初始化方法* */</span><br>  <span class="hljs-attr">_init</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// var con = document.getElementById(this.options.id);</span><br>    <span class="hljs-keyword">const</span> con = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">con</span><br>    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;canvas&#x27;</span>)<br><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span> = con.<span class="hljs-property">offsetWidth</span> &gt; <span class="hljs-number">0</span> ? con.<span class="hljs-property">offsetWidth</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span> = con.<span class="hljs-property">offsetHeight</span> &gt; <span class="hljs-number">0</span> ? con.<span class="hljs-property">offsetHeight</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span><br>    canvas.<span class="hljs-property">id</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">canvasId</span><br>    canvas.<span class="hljs-property">width</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span><br>    canvas.<span class="hljs-property">height</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span><br>    canvas.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">&#x27;pointer&#x27;</span><br>    canvas.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&#x27;您的浏览器版本不支持canvas&#x27;</span><br>    con.<span class="hljs-title function_">appendChild</span>(canvas)<br>  &#125;,<br><br>  <span class="hljs-comment">/** 生成验证码* */</span><br>  <span class="hljs-attr">refresh</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">code</span> = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">canvasId</span>)<br>    <span class="hljs-keyword">let</span> ctx<br>    <span class="hljs-keyword">if</span> (canvas.<span class="hljs-property">getContext</span>) &#123;<br>      ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span><br>    &#125;<br><br>    ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">&#x27;middle&#x27;</span><br><br>    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-title function_">randomColor</span>(<span class="hljs-number">180</span>, <span class="hljs-number">240</span>)<br>    ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span>)<br><br>    <span class="hljs-keyword">let</span> txtArr<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">type</span> == <span class="hljs-string">&#x27;blend&#x27;</span>) &#123;<br>      <span class="hljs-comment">// 判断验证码类型</span><br>      txtArr = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">numArr</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">letterArr</span>)<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">type</span> == <span class="hljs-string">&#x27;number&#x27;</span>) &#123;<br>      txtArr = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">numArr</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      txtArr = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">letterArr</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">4</span>; i++) &#123;<br>      <span class="hljs-keyword">const</span> txt = txtArr[<span class="hljs-title function_">randomNum</span>(<span class="hljs-number">0</span>, txtArr.<span class="hljs-property">length</span>)]<br><br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">code</span> += txt<br>      ctx.<span class="hljs-property">font</span> = <span class="hljs-title function_">randomNum</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span>) + <span class="hljs-string">&#x27;px SimHei&#x27;</span> <span class="hljs-comment">// 随机生成字体大小</span><br>      ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-title function_">randomColor</span>(<span class="hljs-number">50</span>, <span class="hljs-number">160</span>) <span class="hljs-comment">// 随机生成字体颜色</span><br>      ctx.<span class="hljs-property">shadowOffsetX</span> = <span class="hljs-title function_">randomNum</span>(-<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)<br>      ctx.<span class="hljs-property">shadowOffsetY</span> = <span class="hljs-title function_">randomNum</span>(-<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)<br>      ctx.<span class="hljs-property">shadowBlur</span> = <span class="hljs-title function_">randomNum</span>(-<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)<br>      ctx.<span class="hljs-property">shadowColor</span> = <span class="hljs-string">&#x27;rgba(0, 0, 0, 0.3)&#x27;</span><br><br>      <span class="hljs-keyword">const</span> x = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span> / <span class="hljs-number">5</span>) * i<br>      <span class="hljs-keyword">const</span> y = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span> / <span class="hljs-number">2</span><br>      <span class="hljs-keyword">const</span> deg = <span class="hljs-title function_">randomNum</span>(-<span class="hljs-number">30</span>, <span class="hljs-number">30</span>)<br><br>      <span class="hljs-comment">/** 设置旋转角度和坐标原点* */</span><br>      ctx.<span class="hljs-title function_">translate</span>(x, y)<br>      ctx.<span class="hljs-title function_">rotate</span>((deg * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">180</span>)<br>      ctx.<span class="hljs-title function_">fillText</span>(txt, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>      <span class="hljs-comment">/** 恢复旋转角度和坐标原点* */</span><br>      ctx.<span class="hljs-title function_">rotate</span>((-deg * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">180</span>)<br>      ctx.<span class="hljs-title function_">translate</span>(-x, -y)<br>    &#125;<br><br>    <span class="hljs-comment">/** 绘制干扰线* */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>      ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-title function_">randomColor</span>(<span class="hljs-number">40</span>, <span class="hljs-number">180</span>)<br>      ctx.<span class="hljs-title function_">beginPath</span>()<br>      ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-title function_">randomNum</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span>), <span class="hljs-title function_">randomNum</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span>))<br>      ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-title function_">randomNum</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span>), <span class="hljs-title function_">randomNum</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span>))<br>      ctx.<span class="hljs-title function_">stroke</span>()<br>    &#125;<br><br>    <span class="hljs-comment">/** 绘制干扰点* */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span> / <span class="hljs-number">4</span>; i++) &#123;<br>      ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-title function_">randomColor</span>(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>)<br>      ctx.<span class="hljs-title function_">beginPath</span>()<br>      ctx.<span class="hljs-title function_">arc</span>(<br>        <span class="hljs-title function_">randomNum</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">width</span>),<br>        <span class="hljs-title function_">randomNum</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">height</span>),<br>        <span class="hljs-number">1</span>,<br>        <span class="hljs-number">0</span>,<br>        <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span><br>      )<br>      ctx.<span class="hljs-title function_">fill</span>()<br>    &#125;<br>  &#125;,<br><br>  <span class="hljs-comment">/** 获取验证码* */</span><br>  <span class="hljs-title class_">GetCode</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">code</span><br>  &#125;,<br>  <span class="hljs-comment">/** 验证验证码* */</span><br>  <span class="hljs-attr">validate</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">code</span>) &#123;<br>    <span class="hljs-keyword">const</span> code1 = code.<span class="hljs-title function_">toLowerCase</span>()<br>    <span class="hljs-keyword">const</span> v_code = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">code</span>.<span class="hljs-title function_">toLowerCase</span>()<br><br>    <span class="hljs-keyword">if</span> (code1 == v_code) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>组件使用：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">captcha-fe</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">captcha-fe</span>&gt;</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（27-3）el-table各种数据展示形式</title>
    <link href="/2023/08/11/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-3%EF%BC%89el-table%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA%E5%BD%A2%E5%BC%8F/"/>
    <url>/2023/08/11/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-3%EF%BC%89el-table%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA%E5%BD%A2%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录项目中使用过的el-table各种数据展示形式，如不同形式的合并单元格展示的hack写法（自己发明、测试），后期有更好的实现方式也会更新。<br>更新：el-table 在页面初始化时先出现了暂无数据图片，然后才有 loading，完成后加载数据，针对这一点做了用户体验优化。</p></blockquote><span id="more"></span><h3 id="合并单元格展示一"><a href="#合并单元格展示一" class="headerlink" title="合并单元格展示一"></a>合并单元格展示一</h3><p><img src="/../img/vue27-3.png" alt="列表展示"><br>el-table-column 进行嵌套可实现合并单元格表头，嵌套部分需要加上 <code>rowspan=&quot;2&quot;</code>。<br>内容显示需要使用 p 标签进行文本换行，避免文字会自动拼接，使用户迷惑。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"> <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;订单明细&quot;</span> <span class="hljs-attr">show-overflow-tooltip</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;360&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;产品类型&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span> 产品类型 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; row &#125;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in row.order_detail&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.product_type&quot;</span>&gt;</span>&#123;&#123; item.product_type &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span>&gt;</span>--<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;产品名称&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span> 产品名称 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; row &#125;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in row.order_detail&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.product_name&quot;</span>&gt;</span>&#123;&#123; item.product_name &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span>&gt;</span>--<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;数量&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span> 数量 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; row &#125;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in row.order_detail&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.transaction_number&quot;</span>&gt;</span>&#123;&#123; item.transaction_number &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span>&gt;</span>--<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>再给每行文字添加底部边框之后，因为 cell 自带 padding，需要对 css 进行修改，使得边框两端连续，模拟了表格分割线。</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.el-table</span> <span class="hljs-selector-class">.cell</span><span class="hljs-selector-class">.el-tooltip</span> &#123;<br>  <span class="hljs-attribute">white-space</span>: pre-wrap;<br>&#125;<br><span class="hljs-selector-class">.cell</span> &#123;<br>  <span class="hljs-selector-tag">p</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-pseudo">:last-child</span>) &#123;<br>    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ebeef5</span>;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100%</span> + <span class="hljs-number">24px</span>);<br>    <span class="hljs-attribute">margin-left</span>: -<span class="hljs-number">12px</span>;<br>    <span class="hljs-selector-tag">span</span> &#123;<br>      <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">12px</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="合并单元格展示二"><a href="#合并单元格展示二" class="headerlink" title="合并单元格展示二"></a>合并单元格展示二</h3><p><img src="/../img/vue27-5.png" alt="列表展示"><br>这里左侧文字可以单独使用一列展示文字，右侧数据展示使用单元格套单元格形式，写法如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;card&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;card-title&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>CGx_FAULT_STAT_EN<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>核组总错状态报错使能寄存器<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;card-content&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;dataList.tableData_cgxen&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">v-loading</span>=<span class="hljs-string">&quot;loadingTable&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:header-cell-style</span>=<span class="hljs-string">&quot;&#123; background: &#x27;#F4F4F4&#x27; &#125;&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">border</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:span-method</span>=<span class="hljs-string">&quot;handleSpanMethod&quot;</span></span><br><span class="hljs-tag">      &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;200&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>CGx_FAULT_STAT_EN<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;column in [0, 1]&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;column&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;`$&#123;column&#125;号`&quot;</span> <span class="hljs-attr">:width</span>=<span class="hljs-string">&quot;300&quot;</span> <span class="hljs-attr">:prop</span>=<span class="hljs-string">&quot;column.toString()&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;0核组&quot;</span> <span class="hljs-attr">:prop</span>=<span class="hljs-string">&quot;`$&#123;column&#125;.CG0`&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;1核组&quot;</span> <span class="hljs-attr">:prop</span>=<span class="hljs-string">&quot;`$&#123;column&#125;.CG1`&quot;</span> /&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="合并单元格展示三"><a href="#合并单元格展示三" class="headerlink" title="合并单元格展示三"></a>合并单元格展示三</h3><p><img src="/../img/vue27-6.png" alt="需求文档-列表展示"><br>数据格式如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> opList = [<br>  &#123;<br>    <span class="hljs-attr">system</span>: <span class="hljs-string">&#x27;PTS&#x27;</span>,<br>    <span class="hljs-attr">list</span>: [<br>      &#123;<br>        <span class="hljs-attr">module</span>: <span class="hljs-string">&#x27;产品追溯台账&#x27;</span>,<br>        <span class="hljs-attr">permission</span>: [<span class="hljs-string">&#x27;全部权限&#x27;</span>]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">module</span>: <span class="hljs-string">&#x27;产品信息配置&#x27;</span>,<br>        <span class="hljs-attr">permission</span>: [<span class="hljs-string">&#x27;查看&#x27;</span>, <span class="hljs-string">&#x27;编辑&#x27;</span>]<br>      &#125;<br>    ]<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">system</span>: <span class="hljs-string">&#x27;UMS&#x27;</span>,<br>    <span class="hljs-attr">list</span>: [<br>      &#123;<br>        <span class="hljs-attr">module</span>: <span class="hljs-string">&#x27;管理员&#x27;</span>,<br>        <span class="hljs-attr">permission</span>: [<span class="hljs-string">&#x27;全部数据权限&#x27;</span>]<br>      &#125;<br>    ]<br>  &#125;<br>]<br></code></pre></div></td></tr></table></figure><p>这是一个类似树状的展开，我的第一个想法是类似一中展示的那样，使用 p 标签做分隔，写法如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;opList&quot;</span> <span class="hljs-attr">:header-cell-style</span>=<span class="hljs-string">&quot;&#123; background: &#x27;#F5F7FA&#x27; &#125;&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span></span><br><span class="hljs-tag">    <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;system&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;子系统名称&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">show-overflow-tooltip</span></span><br><span class="hljs-tag">  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">show-overflow-tooltip</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;250&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;功能&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span> 功能 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; row &#125;&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in row.list&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; item.module &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;操作权限&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span> 操作权限 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; row &#125;&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in row.list&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(p, idx) in item.permission&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;idx&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; p &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>结果发现 功能 和 操作权限 那两列文字是自动居中对齐的，没有显示出分类的效果。<br><img src="/../img/vue27-7.png" alt="自动换行效果"><br>优化思路：</p><ol><li>功能 那一栏按照 操作权限 数组去循环，只有第一个元素显示，其余元素做一个占位，同时不用 border-bottom 做分隔，以呈现合并 功能 列单元格的效果。</li><li>table 头部用 css 做一个隐藏效果，去掉一栏分两栏的视觉感受。</li><li>实验发现，这里并不需要单元格套单元格的效果，思路2属于浪费精力，舍弃。直接修改单元格。</li></ol><p>最终完美实现，效果如下：<br><img src="/../img/vue27-8.png" alt=" 最终效果"></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;opList&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table-special&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:header-cell-style</span>=<span class="hljs-string">&quot;&#123; background: &#x27;#F5F7FA&#x27; &#125;&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">border</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span></span><br><span class="hljs-tag">    <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;system&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;子系统名称&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">show-overflow-tooltip</span></span><br><span class="hljs-tag">  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;功能&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span> 功能 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; row &#125;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in row.list&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.permission.length == 1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sp-block&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; item.module &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(p, idx) in item.permission&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;idx&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sp-block&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;idx == 0&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;no-border&quot;</span>&gt;</span>&#123;&#123; item.module &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-else</span>&gt;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;操作权限&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span> 操作权限 <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; row &#125;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in row.list&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(p, idx) in item.permission&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;idx&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sp-block&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; p &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.el-table</span> <span class="hljs-selector-class">.cell</span><span class="hljs-selector-class">.el-tooltip</span> &#123;<br>  <span class="hljs-attribute">white-space</span>: pre-wrap;<br>&#125;<br><span class="hljs-selector-class">.sp-block</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-pseudo">:last-child</span>) &#123;<br>  <span class="hljs-attribute">margin-left</span>: -<span class="hljs-number">12px</span>;<br>  <span class="hljs-selector-tag">p</span> &#123;<br>    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ebeef5</span>;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100%</span> + <span class="hljs-number">24px</span>);<br>    <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">12px</span>;<br>  &#125;<br>&#125;<br><span class="hljs-selector-class">.no-border</span> &#123;<br>  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid transparent <span class="hljs-meta">!important</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="页面初始化优化"><a href="#页面初始化优化" class="headerlink" title="页面初始化优化"></a>页面初始化优化</h3><p>现状：el-table 在页面初始化时先出现了暂无数据图片，然后才有 loading，完成后加载数据，页面切换时有跳动感，不流畅。需要把“暂无数据”的闪现去掉。<br>表格为空原版代码如下:</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">empty</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table-emypt&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;@/assets/img/emypt.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>暂无数据<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>初始化渲染时默认显示无数据，所以才会出现 slot 中的内容，只需要将内容初始化为空，在获取数据后判断 total &#x3D; 0时展示即可。 </p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">empty</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table-emypt&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">&quot;getImageURL(emyptImg)&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; emyptText &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; getImageURL &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/importImages&#x27;</span><br><span class="hljs-keyword">const</span> dataList = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">emyptText</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-attr">emyptImg</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>&#125;)<br><br><span class="hljs-keyword">if</span> (data.<span class="hljs-property">total</span> == <span class="hljs-number">0</span>) &#123;<br>  dataList.<span class="hljs-property">emyptText</span> = <span class="hljs-string">&#x27;暂无数据&#x27;</span><br>  dataList.<span class="hljs-property">emyptImg</span> = <span class="hljs-string">&#x27;emypt.png&#x27;</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  dataList.<span class="hljs-property">tableData</span> = data.<span class="hljs-property">data</span><br>  dataList.<span class="hljs-property">pageTotal</span> = data.<span class="hljs-property">total</span><br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（27-2）el-table中使用批量操作</title>
    <link href="/2023/08/11/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-2%EF%BC%89el-table%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C/"/>
    <url>/2023/08/11/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-2%EF%BC%89el-table%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录项目中使用过的“el-table 中使用批量操作”，批量操作可以分页选择。<br>加载更多种，批量操作一些写法容易出现 bug ，本篇也做一个记录。</p></blockquote><span id="more"></span><h3 id="表头显示类型，某列显示属性名"><a href="#表头显示类型，某列显示属性名" class="headerlink" title="表头显示类型，某列显示属性名"></a>表头显示类型，某列显示属性名</h3><p>表格最左侧一栏添加 <code>selection</code> 表示勾选框, 指定 <code>row-key</code> 并设置<code>reserve-selection</code>为 true 表示可以分页多选， 表格绑定方法 <code>selection-change</code> 在选项变化时添加进存储数组中。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;tableData&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:row-key</span>=<span class="hljs-string">&quot;getRowKeys&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">selection-change</span>=<span class="hljs-string">&quot;handleSelectionChange&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;productTableRef&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;selection&quot;</span> <span class="hljs-attr">:reserve-selection</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 批量选择</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params">val</span>) =&gt; &#123;<br>  state.<span class="hljs-property">batchArr</span> = val<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getRowKeys</span> = (<span class="hljs-params">row</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> row.<span class="hljs-property">id</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue27-4.png" alt="批量选择"></p><p>有一个按钮，点击之后可以取消全选，对应逻辑如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 取消选择</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">cancleCheck</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  productTableRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">clearSelection</span>()<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="bug-记录"><a href="#bug-记录" class="headerlink" title="bug 记录"></a>bug 记录</h3><p>在操作记录模块中，没有使用分页组件，分页是通过“加载更多”追加数据的，批量选择出现了奇异的问题。<br>操作步骤复现：</p><ol><li>初始化10条数据，选择序号1，2</li><li>点击“加载更多”，追加10条数据</li><li>变成了第1、20条数据被选择</li></ol><p>打印日志发现，选中的内容确实是原来的，定位问题在于编号乱了。   </p><p>思路一：之前设置了分页多选，“加载更多”没有分页，所以先去掉<code>reserve-selection</code><br>实验结果：直接取消了选择</p><p>思路二：<code>row-key</code> 有问题，因为后端数据是从别处拉取的，原始数据结构没有 id，我思考后觉得时间戳可以作为唯一性标志，就将每行数据的时间戳设置为 <code>row-key</code><br>实验结果：没有问题</p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（30-1）对接钉钉登录</title>
    <link href="/2023/08/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8830-1%EF%BC%89%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89%E7%99%BB%E5%BD%95/"/>
    <url>/2023/08/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8830-1%EF%BC%89%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89%E7%99%BB%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本系统的初始登录对接了casdoor，内置可配置的第三方登录。后期开发中，经过成本效益分析，去掉casdoor，自己进行功能开发更合适，所以需要前后端自己对接钉钉。<br>本篇记录前端 vue3 对接钉钉实践。 </p></blockquote><span id="more"></span><h3 id="业务需求"><a href="#业务需求" class="headerlink" title="业务需求"></a>业务需求</h3><p>系统通过OAuth授权机制可实现钉钉单点登录（SSO登录）。</p><h3 id="前期调研"><a href="#前期调研" class="headerlink" title="前期调研"></a>前期调研</h3><ol><li>casdoor 原生配置的钉钉登录采用跳转第三方网页形式（<a href="https://login.dingtalk.com/oauth2/challenge.htm?client_id=***&amp;redirect_uri=https://door.casdoor.com/callback&amp;scope=openid&amp;response_type=code&amp;prompt=consent&amp;state=***=%EF%BC%89%EF%BC%8C%E6%89%AB%E7%A0%81%E5%90%8E%E5%87%BA%E7%8E%B0%E5%85%81%E8%AE%B8%E7%99%BB%E5%BD%95%E6%8F%90%E7%A4%BA%E3%80%82">https://login.dingtalk.com/oauth2/challenge.htm?client_id=***&amp;redirect_uri=https://door.casdoor.com/callback&amp;scope=openid&amp;response_type=code&amp;prompt=consent&amp;state=***=），扫码后出现允许登录提示。</a></li><li>通过 casdoor 自带的钉钉登录可以获取到用户的邮箱，通过邮箱地址在公司全量钉钉数据中找到对应用户（姓名、手机号、部门），映射到系统中，与系统用户进行关联；若用户不存在，则引导用户联系系统管理员手动添加进系统。</li><li>使用钉钉登录可以跳钉钉的登录页面，也可以自己生成二维码。</li></ol><h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><ol><li>引入 ddLogin.js 依赖包</li><li>接口拿到配置的 appId 实例化钉钉对象并挂载到 window 上</li><li>通过监听回调方法先拿到 authcode，通过 authcode 拿到可以跟后端通信的 code</li><li>调用后端接口通过 code 拿到前端需要的用户信息&#x2F;token</li></ol><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><ol><li>在 index.html 页面中引入钉钉扫码登录JSSDK<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://g.alicdn.com/dingding/h5-dingtalk-login/0.21.0/ddlogin.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li><li>调用钉钉 SDK，这里需要注意获取到DOM id需要在DOM渲染之后，不要使用 <code>v-if</code>，不然会报错找不到id<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;showDD&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">ddConfig</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-title class_">DTFrameLogin</span>(<br>    <span class="hljs-comment">// DOM包裹容器相关参数</span><br>    &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;showDD&#x27;</span>,<br>      <span class="hljs-attr">width</span>: <span class="hljs-number">300</span>,<br>      <span class="hljs-attr">height</span>: <span class="hljs-number">300</span><br>    &#125;,<br>    <span class="hljs-comment">// 统一登录参数</span><br>    &#123;<br>      <span class="hljs-attr">redirect_uri</span>: <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-string">&#x27;http://***/callback&#x27;</span>),<br>      <span class="hljs-attr">client_id</span>: <span class="hljs-string">&#x27;dingxxxxxxxxxxxx&#x27;</span>,<br>      <span class="hljs-attr">scope</span>: <span class="hljs-string">&#x27;openid&#x27;</span>,<br>      <span class="hljs-attr">response_type</span>: <span class="hljs-string">&#x27;code&#x27;</span>,<br>      <span class="hljs-attr">state</span>: <span class="hljs-string">&#x27;xxxxxxxxx&#x27;</span>,<br>      <span class="hljs-attr">prompt</span>: <span class="hljs-string">&#x27;consent&#x27;</span><br>    &#125;,<br>    <span class="hljs-function">(<span class="hljs-params">loginResult</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 登录成功后的回调函数</span><br>      <span class="hljs-keyword">const</span> &#123; redirectUrl, authCode, state &#125; = loginResult<br>      <span class="hljs-comment">// 这里可以直接进行重定向</span><br>      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = redirectUrl<br>      <span class="hljs-comment">// 也可以在不跳转页面的情况下，使用code进行授权</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(authCode)<br>    &#125;,<br>    <span class="hljs-function">(<span class="hljs-params">errorMsg</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 登录失败后的回调函数</span><br>      <span class="hljs-comment">// 这里一般需要展示登录失败的具体原因</span><br>      <span class="hljs-title function_">alert</span>(<span class="hljs-string">`Login Error: <span class="hljs-subst">$&#123;errorMsg&#125;</span>`</span>)<br>    &#125;<br>  )<br>&#125;<br></code></pre></div></td></tr></table></figure>通过扫码登录后，会自动跳转到 <code>redirect_uri</code> 页面，并携带<code>code</code>和<code>authcode</code>参数，此时可以拿到 参数进行后续操作。<br>在 <code>callback</code> 页面中处理回调逻辑<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> code = route.<span class="hljs-property">query</span>.<span class="hljs-property">code</span><br><span class="hljs-keyword">const</span> authCode = route.<span class="hljs-property">query</span>.<span class="hljs-property">authCode</span><br></code></pre></div></td></tr></table></figure></li></ol><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>和方法一类似，只是跳转到钉钉官方认证页面，若客户端钉钉已处于登录状态，则可以点击头像直接登录。若未登录，则需用户手动扫码。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">&#x27;https://login.dingtalk.com/oauth2/auth?client_id=dingxxxxxxxxxxxx&amp;redirect_uri=http://localhost:4010/callback&amp;response_type=code&amp;scope=openid&#x27;</span><br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><p>钉钉内部实现免登</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install dingtalk-jsapi<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dd <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;dingtalk-jsapi&#x27;</span><br>dd.<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  dd.<span class="hljs-property">runtime</span>.<span class="hljs-property">permission</span>.<span class="hljs-title function_">requestAuthCode</span>(&#123;<br>    <span class="hljs-attr">corpId</span>: <span class="hljs-string">&#x27;ding*******&#x27;</span>, <span class="hljs-comment">// 企业id</span><br>    <span class="hljs-attr">onSuccess</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">info: any</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(info)<br>    &#125;<br>  &#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><code>javascript</code></p><p><code>附录</code><br><a href="https://juejin.cn/post/7070409140916453389">Vue3接入钉钉扫码登录</a><br><a href="https://open.dingtalk.com/document/orgapp/tutorial-obtaining-user-personal-information?spm=ding_open_doc.document.0.0.4d964791LaSnju">实现登录第三方网站</a><br><a href="https://docs.authing.cn/v2/reference/sdk-for-sso-spa.html">钉钉实现单点登录</a><br><a href="https://blog.csdn.net/kirinlau/article/details/140513032">Vue项目实现单点登录(SSO)的逻辑和基本流程</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（29）el-cascader 联级选择使用</title>
    <link href="/2023/08/03/vue3%E7%AC%94%E8%AE%B0%EF%BC%8829%EF%BC%89el-cascader%E8%81%94%E7%BA%A7%E9%80%89%E6%8B%A9%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/08/03/vue3%E7%AC%94%E8%AE%B0%EF%BC%8829%EF%BC%89el-cascader%E8%81%94%E7%BA%A7%E9%80%89%E6%8B%A9%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>el-cascader 这个组件使用起来坑好多啊！本篇记录项目中 el-cascader 使用。</p></blockquote><span id="more"></span><h3 id="联级多选"><a href="#联级多选" class="headerlink" title="联级多选"></a>联级多选</h3><p>设置 <code>props</code> 可是实现联级多选，鼠标悬浮展开后一项用户体验更好，具体配置如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> props = &#123; <span class="hljs-attr">multiple</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">expandTrigger</span>: <span class="hljs-string">&#x27;hover&#x27;</span>, <span class="hljs-attr">checkStrictly</span>: <span class="hljs-literal">true</span> &#125;<br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue29-1.png" alt="联级多选"></p><h3 id="自定义选项展示"><a href="#自定义选项展示" class="headerlink" title="自定义选项展示"></a>自定义选项展示</h3><p>原始需求：选项为一行，后面加入一些关于选项的详情，但是详情内容可能过多，所以最好能换行展示，猜想是否能通过自定义展示来实现。<br>使用 <code>#default</code> 插入自定义选项展示。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;功能模块：&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;module&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-cascader</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;CascaderRef&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;moduleChosen&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:options</span>=<span class="hljs-string">&quot;moduleOptions&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;props&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:show-all-levels</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请选择功能模块&quot;</span></span><br><span class="hljs-tag">    @<span class="hljs-attr">change</span>=<span class="hljs-string">&quot;handleModuleChoose&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; node, data &#125;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; data.label &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;node.isLeaf&quot;</span>&gt;</span> &#123;&#123; data.value &#125;&#125; <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>实验发现，原始选项高度是不变的，使用 <code>p</code> 标签不会撑开容器，会使内容重叠，强制改 css 比较麻烦且不好看，故放弃。使用选中选项后，在输入框下面一块区域显示详情的方式。</p><h3 id="只能选中最后一级（单选）"><a href="#只能选中最后一级（单选）" class="headerlink" title="只能选中最后一级（单选）"></a>只能选中最后一级（单选）</h3><p>在本项目中，一级、二级可能存在没有子集的情况，这时候其自身为叶子结点，在组件中是可以作为叶子结点被选择的，所以需要禁用。通过添加属性 <code>disabled</code> 可实现。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">moduleOptions.<span class="hljs-property">value</span> = <span class="hljs-title function_">formatModule</span>(data)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">formatModule</span> = (<span class="hljs-params">arr: <span class="hljs-built_in">Array</span></span>) =&gt; &#123;<br>  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span>) &#123;<br>      item.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (!child.<span class="hljs-property">children</span>) &#123;<br>          child.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span><br>        &#125;<br>      &#125;)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      arr.<span class="hljs-property">children</span> = []<br>      item.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span><br>    &#125;<br>  &#125;)<br>  <span class="hljs-keyword">return</span> arr<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="只能选中最后一级（多选）"><a href="#只能选中最后一级（多选）" class="headerlink" title="只能选中最后一级（多选）"></a>只能选中最后一级（多选）</h3><p>需要设置 <code>props</code> 如下，若第一级&#x2F;第二级不可选，同时使用上述 formatModule 方法，添加disabled。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> props = &#123; <span class="hljs-attr">expandTrigger</span>: <span class="hljs-string">&#x27;hover&#x27;</span>, <span class="hljs-attr">multiple</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">checkStrictly</span>: <span class="hljs-literal">true</span> &#125;<br></code></pre></div></td></tr></table></figure><h3 id="默认选中"><a href="#默认选中" class="headerlink" title="默认选中"></a>默认选中</h3><p>当给 <code>v-model</code> 直接赋值为每级组合的数组时，可以实现默认选中，例如默认选中第一级，v-model&#x3D;”[1]”(1为OMS的value值)<br><img src="/../img/vue29-2.png" alt="第一级默认选中"></p><p>默认选中第三级，v-model&#x3D;”[1, 2, 3]”<br><img src="/../img/vue29-3.png" alt="第三级默认选中"></p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol><li><code>:show-all-levels=&quot;false&quot;</code> 可以保持显示选中的那一项（不然会显示从头到尾一串儿），选中后输入框里使用 el-tag 展示选中项，注意样式可能会污染，需要覆盖 tag 的width，这种有污染的最好不要使用 collapse-tags 和 collapse-tags-tooltip，否则又要多写一层覆盖样式污染</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（28）滚动加载更多</title>
    <link href="/2023/07/28/vue3%E7%AC%94%E8%AE%B0%EF%BC%8828%EF%BC%89%E6%BB%9A%E5%8A%A8%E5%8A%A0%E8%BD%BD%E6%9B%B4%E5%A4%9A/"/>
    <url>/2023/07/28/vue3%E7%AC%94%E8%AE%B0%EF%BC%8828%EF%BC%89%E6%BB%9A%E5%8A%A8%E5%8A%A0%E8%BD%BD%E6%9B%B4%E5%A4%9A/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录项目中使用的“加载更多”的实现方式。</p></blockquote><span id="more"></span><p><img src="/../img/vue28-1.png" alt="页面加载更多"><br><img src="/../img/vue28-2.png" alt="页面加载完成"></p><h3 id="手动触发页面加载更多"><a href="#手动触发页面加载更多" class="headerlink" title="手动触发页面加载更多"></a>手动触发页面加载更多</h3><p>点击“加载更多”，显示“加载中…”，加载完成，显示“已全部加载 X 条历史记录”</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;logList.length &lt; pageTotal&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;load-more&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!loading&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;add&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleLoadMore&quot;</span>&gt;</span>加载更多<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;load-finish&quot;</span>&gt;</span><br>   — 已全部加载 &#123;&#123; pageTotal &#125;&#125; 条历史记录 — <br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>初始化加载10条数据赋值给数组，当“加载更多”获取更多数据后，加入数组中。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 加载更多</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLoadMore</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  dataList.<span class="hljs-property">query</span>.<span class="hljs-property">page</span>++<br>  <span class="hljs-title function_">getData</span>()<br>&#125;<br><br><span class="hljs-comment">// 获取数据</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = (<span class="hljs-params">first?: <span class="hljs-literal">true</span></span>) =&gt; &#123;<br>  state.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span><br>  <span class="hljs-title function_">getStatusHistory</span>(params)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; data &#125; = res<br>    <span class="hljs-keyword">if</span> (first) &#123;<br>      state.<span class="hljs-property">logList</span> = data.<span class="hljs-property">data</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      state.<span class="hljs-property">logList</span> = state.<span class="hljs-property">logList</span>.<span class="hljs-title function_">concat</span>(data.<span class="hljs-property">data</span>)<br>    &#125;<br>    dataList.<span class="hljs-property">pageTotal</span> = data.<span class="hljs-property">total</span><br>    state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span><br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)<br>    state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span><br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="滚动条触发页面加载更多"><a href="#滚动条触发页面加载更多" class="headerlink" title="滚动条触发页面加载更多"></a>滚动条触发页面加载更多</h3><p>实现原理：初始化加载10条数据，当滚动条滚动到页面底部时，若页面显示的数据条目小于总数据量时，发出一个分页请求。<br>在 PC 端 SPA 项目中，切换路由实际切换的是页面中间部分显示的内容，这里容易混淆一点，就是滚动条的位置。最外层容器的滚动条在内部组件中是获取不到的，需要将外部容器高度设置为 100%，同时在组件中设置内层容器（观测内容显示区域，内容自己撑开高度）的高度为视图高度，超出部分使用滚动条。<br>页面节点挂载后加入监听器</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;logpage&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">120px</span>;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">48px</span>);<br>  <span class="hljs-attribute">overflow-y</span>: scroll;<br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> logpage = <span class="hljs-title function_">ref</span>()<br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">getData</span>(<span class="hljs-literal">true</span>)<br>  logpage.<span class="hljs-property">value</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, doScroll)<br>&#125;)<br><br><span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  logpage.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, doScroll)<br>&#125;)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">doScroll</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> scrollHeight = event.<span class="hljs-property">target</span>.<span class="hljs-property">scrollHeight</span><br>  <span class="hljs-keyword">const</span> scrollTop = event.<span class="hljs-property">target</span>.<span class="hljs-property">scrollTop</span><br>  <span class="hljs-keyword">const</span> clientHeight = event.<span class="hljs-property">target</span>.<span class="hljs-property">clientHeight</span><br><br>  <span class="hljs-keyword">if</span> (scrollTop + clientHeight &gt;= scrollHeight) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;到底了!&#x27;</span>)<br>    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">logList</span>.<span class="hljs-property">length</span> &lt; dataList.<span class="hljs-property">pageTotal</span>) &#123;<br>      <span class="hljs-title function_">handleLoadMore</span>()<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（27-1）el-table中使用el-input</title>
    <link href="/2023/07/28/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-1%EF%BC%89el-table%E4%B8%AD%E4%BD%BF%E7%94%A8el-input/"/>
    <url>/2023/07/28/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-1%EF%BC%89el-table%E4%B8%AD%E4%BD%BF%E7%94%A8el-input/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录项目中使用过的“el-table中组合使用el-input”的两种写法。</p></blockquote><span id="more"></span><h3 id="表头显示类型，某列显示属性名"><a href="#表头显示类型，某列显示属性名" class="headerlink" title="表头显示类型，某列显示属性名"></a>表头显示类型，某列显示属性名</h3><p><img src="/../img/vue27-1.png" alt="top-left文字"><br>实现思路：form 放在最外层包裹，el-table 绑定表格数据，其中某列数据（此处为属性名attr）使用文字插入，prop 和 input 输入框里的值的索引都为 name，将校验规则绑定在 el-form-item 中，可实现提交时表单校验。<br><code>#default=&quot;scope&quot;</code>用于在表格中插入输入框。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form</span></span><br><span class="hljs-tag">  <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;productAttrFormRef&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:model</span>=<span class="hljs-string">&quot;productAttrForm&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;productAttrFormRules&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;attrTableData&quot;</span> <span class="hljs-attr">border</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;attr&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;产品属性&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;160&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;value&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;新值（变更后）&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;640&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span></span><br><span class="hljs-tag">          <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">:prop</span>=<span class="hljs-string">&quot;scope.row.name&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;productAttrFormRules[scope.row.name]&quot;</span></span><br><span class="hljs-tag">        &gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span></span><br><span class="hljs-tag">            <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;productAttrForm[scope.row.name]&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入新值&quot;</span></span><br><span class="hljs-tag">          &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> attrTableData = <span class="hljs-title function_">reactive</span>([<br>  &#123;<br>    <span class="hljs-attr">attr</span>: <span class="hljs-string">&#x27;版本&#x27;</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;version&#x27;</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">attr</span>: <span class="hljs-string">&#x27;频率&#x27;</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;frequence&#x27;</span><br>  &#125;<br>])<br><span class="hljs-keyword">const</span> productAttrFormRules = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">version</span>: [<br>    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>  ],<br>  <span class="hljs-attr">frequence</span>: [<br>    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;,<br>    &#123; <span class="hljs-attr">validator</span>: validateText50, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>  ]<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="整行可编辑"><a href="#整行可编辑" class="headerlink" title="整行可编辑"></a>整行可编辑</h3><p><img src="/../img/vue27-2.png" alt="整行可编辑"><br>实现思路：form 放在最外层包裹，el-table 绑定表格数据。<br><code>#header</code>用于自定义表头，实现必填项红色标记，<code>#default=&quot;scope&quot;</code>用于在表格中插入输入框。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;detailFormRef&quot;</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">&quot;detailForm&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;detailForm.tableData&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;product_classification&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;产品类型&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>=<span class="hljs-string">&quot;&#123; column &#125;&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: red&quot;</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        &#123;&#123; column.label &#125;&#125;<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span></span><br><span class="hljs-tag">          <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;scope.row.edit&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">:prop</span>=<span class="hljs-string">&quot;&#x27;tableData.&#x27; + scope.$index + &#x27;.product_classification&#x27;&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;detailRules.product_classification&quot;</span></span><br><span class="hljs-tag">        &gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span></span><br><span class="hljs-tag">            <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;scope.row.product_classification&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请选择产品类型&quot;</span></span><br><span class="hljs-tag">          &gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span></span><br><span class="hljs-tag">              <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in productTypeOptions&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;item.id&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;item.value&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">:value</span>=<span class="hljs-string">&quot;item&quot;</span></span><br><span class="hljs-tag">            /&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span>&gt;</span>&#123;&#123; scope.row.product_classification.value &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;操作&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;234&quot;</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;left&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span><br><span class="hljs-tag">          <span class="hljs-attr">link</span></span><br><span class="hljs-tag">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;saveDetail(scope.$index, scope.row)&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;scope.row.edit&quot;</span></span><br><span class="hljs-tag">          &gt;</span>保存&lt;/el-button<br>        &gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span><br><span class="hljs-tag">          <span class="hljs-attr">link</span></span><br><span class="hljs-tag">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;editDetail(scope.$index, scope.row)&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!scope.row.edit&quot;</span></span><br><span class="hljs-tag">          &gt;</span>编辑&lt;/el-button<br>        &gt;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span><br><span class="hljs-tag">          <span class="hljs-attr">link</span></span><br><span class="hljs-tag">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;deleteDetail(scope.$index, scope.row)&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">:disabled</span>=<span class="hljs-string">&quot;detailForm.tableData.length == 1&quot;</span></span><br><span class="hljs-tag">          &gt;</span>删除&lt;/el-button<br>        &gt;<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;add-row&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;info&quot;</span> <span class="hljs-attr">link</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;addDetailRow&quot;</span>&gt;</span><br>    + 添加一行<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>最外层的 form 中使用 tableData 绑定数据，初始化时，若处于新增状态，则默认添加一行，若处于编辑状态，则表格中直接展示获取到的数据。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> detailFormRef = ref&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">FormInstance</span>&gt;()<br><br><span class="hljs-comment">// 获取参数 API 后</span><br><span class="hljs-keyword">if</span> (data.<span class="hljs-property">order_detail</span> &amp;&amp; data.<span class="hljs-property">order_detail</span>.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-title function_">addDetailRow</span>()<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  detailForm.<span class="hljs-property">tableData</span> = detailList<br>&#125;<br></code></pre></div></td></tr></table></figure><p>点击“编辑”可将表格数据变成编辑态（input），点击“保存”可将编辑态数据变成表格文字。处于编辑态时，不能再次新增，原因是每行绑定所有校验规则（单列单条），若多条数据同处于编辑状态，可能触发同样的校验，引起矛盾。<br>点击“删除”可以删除整行数据，但表格中只有一行时，不可删除。<br>代码中表格每一行使用 <code>edit</code> 属性标记编辑状态：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">isEditing</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> (<br>    detailForm.<span class="hljs-property">tableData</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> item.<span class="hljs-property">edit</span> === <span class="hljs-literal">true</span><br>    &#125;).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span><br>  )<br>&#125;<br><span class="hljs-comment">// 订单明细-添加一行</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">addDetailRow</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isEditing</span>()) &#123;<br>    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;只能新增一行&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    detailForm.<span class="hljs-property">tableData</span>.<span class="hljs-title function_">push</span>(&#123;<br>      <span class="hljs-attr">edit</span>: <span class="hljs-literal">true</span><br>    &#125;)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 订单明细-单行保存</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">saveDetail</span> = (<span class="hljs-params">index: any, row: any</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">unref</span>(detailFormRef)<br>  form.<span class="hljs-title function_">validate</span>(<span class="hljs-function">(<span class="hljs-params">valid: boolean</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (valid) &#123;<br>      row.<span class="hljs-property">edit</span> = <span class="hljs-literal">false</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>  &#125;)<br>&#125;<br><br><span class="hljs-comment">// 订单明细-单行编辑</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">editDetail</span> = (<span class="hljs-params">index: any, row: any</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;scope.$index=&#x27;</span>, index, row)<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isEditing</span>()) &#123;<br>    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;只能同时编辑一行&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    row.<span class="hljs-property">edit</span> = <span class="hljs-literal">true</span><br>    <span class="hljs-title function_">changeProductType</span>(index, row.<span class="hljs-property">product_classification</span>.<span class="hljs-property">id</span>, <span class="hljs-number">1</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 订单明细-单行删除</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteDetail</span> = (<span class="hljs-params">index: any, row: any</span>) =&gt; &#123;<br>  detailForm.<span class="hljs-property">tableData</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>提交表单时，需要对是否有行内编辑进行一次判断</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAddBusiness</span> = (<span class="hljs-params">formEl: <span class="hljs-keyword">typeof</span> FormInstance | <span class="hljs-literal">undefined</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">unref</span>(formEl)<br>  form.<span class="hljs-title function_">validate</span>(<span class="hljs-function">(<span class="hljs-params">valid: boolean</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (valid) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isEditing</span>()) &#123;<br>        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;订单明细尚有内容正在编辑，请先保存&#x27;</span>)<br>      &#125; <span class="hljs-keyword">else</span> &#123;&#125;<br>    &#125;<br>  &#125;)<br>&#125;<br><span class="hljs-comment">// 编辑状态判断</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">isEditing</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> (<br>    detailForm.<span class="hljs-property">tableData</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> item.<span class="hljs-property">edit</span> === <span class="hljs-literal">true</span><br>    &#125;).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span><br>  )<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微前端（1）</title>
    <link href="/2023/07/23/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%881%EF%BC%89/"/>
    <url>/2023/07/23/%E5%BE%AE%E5%89%8D%E7%AB%AF%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇是微前端的学习记录。</p></blockquote><span id="more"></span><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ol><li>微前端就是将一个大型前端应用拆分成多个模块（eg: 将项目根据业务模块拆分），每个模块可以由不同的团队进行管理，并可以自主选择框架、有自己的仓库，可以独立部署上线。</li><li>主应用（基座）：主要负责集成所有的子应用，提供一个入口能访问你所需要的子应用。<br>  （1）一个系统只有一个<br>  （2）系统整体 Layout 的设计<br>  （3）所有微应用的配置与注册、路由映射、消息下发<br>  （4）尽量不写复杂业务逻辑<br>微应用：根据不同业务划分的模块，每个子应用都打包成umd模块的形式供主应用来加载。<br>  （1）通常是一个单页面应用（SPA），负责具体的业务逻辑<br>  （2）可以独立交付（开发、部署、运行），但是一般会集成到主应用中运行<br>  （3）如有必要，甚至能集成到不同的主应用中</li></ol><h3 id="适用业务场景"><a href="#适用业务场景" class="headerlink" title="适用业务场景"></a>适用业务场景</h3><ol><li>需要将多个后台系统统一收口的一个系统内。</li><li>庞大的单页面应用，开发&#x2F;构建时间长。<br>微前端可以实现各个微应用的独立开发和发版，主应用管理微应用的注册和渲染，将整个系统彻底解耦。</li></ol><p>思考：公司的业务场景偏向于1，UMS作为所有系统、用户、权限的管理，子系统的统一入口，适合作为主应用。各个子系统分管不同的业务（订单管理、出入库管理、售后管理、质量管理、产品追溯管理等），有各自的代码仓库和不同的开发特性，迭代周期也不同，适合作为微应用。<br>各个子系统与不同后端进行交互，可能会共享数据。</p><h3 id="各实现方式对比"><a href="#各实现方式对比" class="headerlink" title="各实现方式对比"></a>各实现方式对比</h3><table><thead><tr><th>方案</th><th>具体实现</th><th>优点</th><th>不足</th></tr></thead><tbody><tr><td>Nginx路由转发（服务端集成）</td><td>通过nginx代理来区分，同一个端口不同路由指向不同的前端项目，通讯可使用 sharedWorker。</td><td>简单</td><td>跨服务的组件无法嵌套，简单通讯可以使用会话存储，但需要比较复杂的封装，使用也不方便，有一层逻辑处理。适合业务分割清晰、跨服务组件之间关联少的项目，并且路由规划要严格。</td></tr><tr><td>iframe嵌套（运行时集成）</td><td>父应用单独是一个页面，每个子应用嵌套一个iframe，父子通信可采用postMessage或者contentWindow方式</td><td>子应用之间自带沙箱，天然隔离，互不影响</td><td>iframe样式显示（弹窗只在局部）、兼容性问题、刷新页面无法保存状态</td></tr><tr><td>Web Components</td><td>子应用使用纯Web Components编写</td><td>子应用拥有独立的script和css，也可以单独部署</td><td>改造成本高；子应用通信复杂</td></tr><tr><td>组合式应用路由分发</td><td>子应用独立构建和部署，运行时由父应用进行路由管理、应用加载、启动、卸载、通信</td><td>无感知切换体验良好，子应用相互隔离</td><td>父子应用处于同一页面，变量污染、通信问题</td></tr></tbody></table><h3 id="主要实现方式"><a href="#主要实现方式" class="headerlink" title="主要实现方式"></a>主要实现方式</h3><h4 id="路由分发"><a href="#路由分发" class="headerlink" title="路由分发"></a>路由分发</h4><p>JavaScript的模块化来实现导入导出，可以使用importmap（eg: SystemJS），使变量名和其相应的地址一一映射，允许在非导入上下文中重用这个映射，避免重复书写地址。</p><h4 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h4><p>css隔离： css Module或者namespace，可以采用webpack的postcss插件，在打包时添加特定的前缀；<br>js隔离：采用沙箱机制（局部的js运行不影响外部对象），对于浏览器需要结合with关键字和window.Proxy对象来实现。</p><h4 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h4><p>子应用之间不直接通信，采用消息订阅（pub&#x2F;sub）模式，在基座应用中定义事件中心Event，子应用注册事件，当事件被触发时，事件中心统一分发。</p><h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><ol><li>registerApplication：注册微应用</li><li>bootstrap：第一次挂载应用执行，只会被执行一次</li><li>mount：创建DOM节点，监听DOM事件，激活路由</li><li>unmount：卸载事件</li><li>unloaded<br>其中bootstrap、mount、unmount必须由我们导出，否则会报错</li></ol><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><ol><li>主应用怎么加载微应用？ </li><li>主从通信？子应用之间通信？</li><li>部署问题？</li></ol><p><code>附录</code><br><a href="https://zeroing.jd.com/micro-app/docs.html#/">京东</a><br><a href="https://zh-hans.single-spa.js.org/docs/getting-started-overview">Single-Spa最早的微前端框架</a><br><a href="https://zhuanlan.zhihu.com/p/141530392">微前端-最容易看懂的微前端知识</a><br><a href="https://zhuanlan.zhihu.com/p/492152857">微前端究竟是什么？微前端核心技术揭秘！</a><br><a href="https://juejin.cn/post/7122031820006227981">微前端框架qiankun、ice比较</a><br><a href="https://juejin.cn/post/7201282972967944250">真的有必要用微前端框架么</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>微前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（26）页面过渡</title>
    <link href="/2023/07/07/vue3%E7%AC%94%E8%AE%B0%EF%BC%8826%EF%BC%89%E9%A1%B5%E9%9D%A2%E8%BF%87%E6%B8%A1/"/>
    <url>/2023/07/07/vue3%E7%AC%94%E8%AE%B0%EF%BC%8826%EF%BC%89%E9%A1%B5%E9%9D%A2%E8%BF%87%E6%B8%A1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇总结 transition 使用，记录页面过渡时出现的跳动问题。看似是个小问题，解决过程累计大概花费了一天，真是个惨痛教训。<br>另有一些跳转优化，也在本篇记录。</p></blockquote><span id="more"></span><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>在开发中出现一个神奇的问题，某些页面在进入时总是在最下方出现，等上面的页面完全离开后，才会突然从下往上跳上去，用户体验很不好。<br><img src="/../img/vue26-2.png" alt="过渡时页面跳动"></p><h3 id="代码逻辑"><a href="#代码逻辑" class="headerlink" title="代码逻辑"></a>代码逻辑</h3><p><code>app-main.vue</code> 中添加页面 transition，out-in 表示要离开的 dom 元素离开完毕后，要进入的 dom 元素才开始进入。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;app-main&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">transition</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;slide-fade&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;transition&quot;</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">&quot;out-in&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">transition</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.slide-fade-enter-from</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">24px</span>);<br>  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-selector-class">.slide-fade-enter-active</span> &#123;<br>  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span> ease-out;<br>&#125;<br><br><span class="hljs-selector-class">.slide-fade-leave-active</span> &#123;<br>  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease-out;<br>&#125;<br><br><span class="hljs-selector-class">.slide-fade-leave-to</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">24px</span>);<br>  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><ol><li>将动画时间拉长，便于判断动画是否生效，实验结果是部分页面生效，部分不生效。</li><li>猜测可能是路径切换时出现问题，检查后发现所有路径切换均使用<code>router.push(&#123; path: path &#125;)</code>，猜测有误。</li><li>猜测可能是文件引入问题，但是即使是放到同一文件目录，还是有问题，猜测有误。</li><li>猜测可能是页面结构问题，尝试如下：<br>原页面结构：<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container-simple&quot;</span>&gt;</span><br>    // 这里是页面内容<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure>修改后的页面结构<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container-simple&quot;</span>&gt;</span><br>    // 这里是页面内容<br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure>问题解决！！！</li></ol><h3 id="transition-使用"><a href="#transition-使用" class="headerlink" title="transition 使用"></a>transition 使用</h3><p><img src="/../img/vue26-1.png" alt="transition使用"></p><h3 id="页面跳转优化"><a href="#页面跳转优化" class="headerlink" title="页面跳转优化"></a>页面跳转优化</h3><p>问题描述：单页在页面切换时，会遇到滚动条的问题，列表页的table过长，导致跳转到编辑页时，出现右侧滚动条在中间，底部滚动条（屏幕较小时出现）在右边的情况，展示了一个不完整的页面，用户体验不好。<br>解决方式：在页面初始化时，加入一个控制滚动条的方法。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; scrollInit &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils&#x27;</span><br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">scrollInit</span>()<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>在<code>views/layout/components/basic.vue</code>中添加页面容器id，该容器撑开出现横向滚动条</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;main-container&quot;</span> id=<span class="hljs-string">&quot;mainContainer&quot;</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AppMain</span> /&gt;</span></span><br>&lt;/div&gt;<br></code></pre></div></td></tr></table></figure><p><code>utils/index.ts</code>中控制横向和纵向滚动条。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollInit</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;mainContainer&#x27;</span>).<span class="hljs-property">scrollLeft</span> = <span class="hljs-number">0</span><br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">scrollTop</span> = <span class="hljs-number">0</span><br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（25）统一系统入口-子系统处理</title>
    <link href="/2023/06/28/vue3%E7%AC%94%E8%AE%B0%EF%BC%8825%EF%BC%89%E7%BB%9F%E4%B8%80%E7%B3%BB%E7%BB%9F%E5%85%A5%E5%8F%A3-%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%A4%84%E7%90%86/"/>
    <url>/2023/06/28/vue3%E7%AC%94%E8%AE%B0%EF%BC%8825%EF%BC%89%E7%BB%9F%E4%B8%80%E7%B3%BB%E7%BB%9F%E5%85%A5%E5%8F%A3-%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原版各子系统相互独立，有单独的登录入口，对应不同的后端 token 鉴权；新版系统有统一的入口，各子系统共享 token，走统一的 apisix 鉴权；同时菜单及可访问路由的配置统一由 UMS 系统（用户信息管理）处理。<br>本篇是统一迁移记录。基于Vue3 + Vue-router4 + pinia + vite 技术栈已经调试成功，老旧系统基于Vue3 + Vuex + vue-cli 另需调整。</p></blockquote><span id="more"></span><h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><ol><li>本次设计了一个UMS（User Manage System）作为用户登录和修改个人信息的入口，登录成功的用户可以选择性访问子系统，用户的子系统访问权限设置也在 UMS 中。</li><li>为了使 UMS 和子系统可以共享 token ，这里在部署时将这些系统部署在一个域中，通过浏览器 cookie 共享实现；</li><li>UMS 中 token 失效（请求中后端返回401），清除 token ，跳转 login 登录页面；</li><li>子系统中 token 失效（请求中后端返回401），清除 token ，跳转 UMS 系统首页，由 UMS 系统跳转 login 登录页面；</li><li>进入子系统，路由守卫判断无 token，跳转 UMS 系统首页，由 UMS 系统跳转 login 登录页面；</li><li>子系统获取动态菜单，若访问路由不存在，跳转 404 页面；</li><li>若访问路由存在，<a href="https://guoningyan.com/2023/05/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8821-2%EF%BC%89%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1/">之前已经写过动态路由的渲染</a>，渲染页面；<br><img src="/../img/vue21-2.png" alt="系统设计"></li></ol><h3 id="设计思路子系统中实现注意事项"><a href="#设计思路子系统中实现注意事项" class="headerlink" title="设计思路子系统中实现注意事项"></a>设计思路子系统中实现注意事项</h3><p>在守卫路由中通过 token 判断能否继续访问，所有跳转都在其中设置地址，例如：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (token) &#123; <br>  <span class="hljs-comment">// 获取菜单，判断能否前往</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> + <span class="hljs-string">&quot;/ums/&quot;</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>其余地方只需要去除 token，刷新页面。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">removeToken</span>()<br><span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()<br></code></pre></div></td></tr></table></figure><p>这样的好处是，如果修改了跳转地址，只需要改一处即可，代码逻辑解耦。</p><h3 id="本地调试"><a href="#本地调试" class="headerlink" title="本地调试"></a>本地调试</h3><p>路由守卫中可暂时注释 if(token)，使用 mock 菜单数据进行调试；<br>若子系统后端尚且使用旧 token 鉴权，可以手动在浏览器种 cookie。</p><h4 id="菜单获取修改"><a href="#菜单获取修改" class="headerlink" title="菜单获取修改"></a>菜单获取修改</h4><ol><li><code>router/index.ts</code>中去除 404 等固定路由以外的路由；</li><li><code>views/layout/index.ts</code>中暴露 BasicLayout 等整体父级样式；</li><li><code>store/modules/permission.ts</code>中修改动态路由的获取（data&#x3D;[&#x2F;<em>菜单数组</em>&#x2F;]），另需添加一个接口<code>/subsystem/menu/XXX</code>获取子系统对应菜单；</li><li><code>permission.ts</code> 路由守卫修改（可暂时注释if(token)，避免调试时页面跳转）；</li><li><code>views/layout/components/Sidebar/index.vue</code>中修改菜单获取；</li><li><code>views/layout/components/Sidebar/sidebar-item.vue</code>中修改侧栏菜单渲染；</li><li><code>vite.config.ts</code> proxy 代理修改成 apisix 对应的后端路由；</li><li>各个接口中，serverHost 添加 XXX 对应子系统名称；</li></ol><h4 id="跳转修改"><a href="#跳转修改" class="headerlink" title="跳转修改"></a>跳转修改</h4><ol><li><code>config/axios/service.ts</code>中修改 401 跳转；</li><li><code>store/modules/user.ts</code>中修改 resetToken；</li></ol><h4 id="业务相关代码修改"><a href="#业务相关代码修改" class="headerlink" title="业务相关代码修改"></a>业务相关代码修改</h4><ol><li><code>components/BreadCrumb/index.vue</code> 中修改面包屑。一般导航可以直接使用该组件，特殊导航（例如：三级导航）需要传数据到组件中；具体用法见 readme.md</li><li>若有 created_by、updated_by 相关代码，需要去除；</li><li><code>views/layout/components/Navbar/avatar.vue</code>中修改个人信息 hover 下拉菜单，只留下 logout 功能，同时修改用户名展示；</li></ol><h4 id="上线修改"><a href="#上线修改" class="headerlink" title="上线修改"></a>上线修改</h4><ol><li>若调试无问题，修改 API 获取真实菜单，<code>permission.ts</code> 路由守卫中放开 token；</li><li>打包环境 <code>**.env</code> 中修改成 apisix 对应的后端路由；</li></ol><h3 id="基于Vuex-vue-cli"><a href="#基于Vuex-vue-cli" class="headerlink" title="基于Vuex + vue-cli"></a>基于Vuex + vue-cli</h3><ol><li>注意各处导入 store 语法区别；</li><li><code>store/modules/permission.ts</code>中不管是开发环境还是生产环境，都使用 <code>() =&gt;   import()</code>导入模块；getMenus 方法标记为 action</li><li><code>vue.config.ts</code> proxy 代理修改成 apisix 对应的后端路由；publicPath 修改生产环境路径；</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（24）动态规则绑定</title>
    <link href="/2023/05/31/vue3%E7%AC%94%E8%AE%B0%EF%BC%8824%EF%BC%89%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E7%BB%91%E5%AE%9A/"/>
    <url>/2023/05/31/vue3%E7%AC%94%E8%AE%B0%EF%BC%8824%EF%BC%89%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E7%BB%91%E5%AE%9A/</url>
    
    <content type="html"><![CDATA[<blockquote><p>又有让我眉头一紧的新 feature 了，表格中某几项需要根据选择来确定规则，包含字符校验和必填项的改变。<br>这篇记录动态规则绑定及检验遇到的坑。</p></blockquote><span id="more"></span><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>使用 v-if 多写几个 form-item，用 type 动态控制显示，但是这样的话会让已填项清空，舍弃。</p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>根据选择的 type 动态设置 prop，不同的 prop 在 rule 中定义不同的规则。这里定义 path 为必填，path1 为非必填，</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;menuFormRef&quot;</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">&quot;menuForm&quot;</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;menuRules&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;前端路由：&quot;</span> <span class="hljs-attr">:prop</span>=<span class="hljs-string">&quot;menuForm.type == 1 ? &#x27;path&#x27; : &#x27;path1&#x27;&quot;</span>&gt;</span><br>    el-input v-model=&quot;menuForm.path&quot; placeholder=&quot;请输入前端路由&quot;&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">el-form</span>/&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> menuRules = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">path</span>: [<br>    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入前端路由&#x27;</span>, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;,<br>    &#123; <span class="hljs-attr">validator</span>: validateText50Required, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>  ],<br>  <span class="hljs-attr">path1</span>: [<br>    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入前端路由&#x27;</span>, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;,<br>    &#123; <span class="hljs-attr">validator</span>: validateText50, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>  ]<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>问题来了，当切换类型时，出错提示依然显示；当手动点一下输入框（触发blur）或者点击提交按钮时，出错提示消失，可见校验规则是切换了。<br><img src="/../img/vue24-1.png" alt="type=1"><br><img src="/../img/vue24-2.png" alt="type=2"></p><h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><p>手动根据状态改变 rule </p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span></span><br><span class="hljs-tag">    <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;前端路由：&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;fold&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">      menuForm.type == 1</span></span><br><span class="hljs-string"><span class="hljs-tag">        ? menuRules.path</span></span><br><span class="hljs-string"><span class="hljs-tag">        : [&#123; validator: validateText50, trigger: [&#x27;blur&#x27;, &#x27;change&#x27;] &#125;]</span></span><br><span class="hljs-string"><span class="hljs-tag">    &quot;</span></span><br><span class="hljs-tag">  &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;menuForm.path&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入前端路由&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>问题是当切换类型时，必填红色*没有消失。经过检验，规则也没有切换成功。这个方法是网友写过技术总结的，详情见附录，我实在不理解为啥到我这儿就失败了。。。</p><h3 id="方法四"><a href="#方法四" class="headerlink" title="方法四"></a>方法四</h3><p>使用 watch 监听 type ，改变时直接将校验规则改变。<br>优势：完全实现了校验规则的切换。<br>劣势：切换时一定会触发一次全局规则校验（效果类似于点击了一次提交）</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">watch</span>(<br>  <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">menuForm</span>.<span class="hljs-property">type</span>,<br>  <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">menuForm</span>.<span class="hljs-property">type</span> == <span class="hljs-number">1</span>) &#123;<br>      menuRules.<span class="hljs-property">path</span> = [<br>        &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入前端路由&#x27;</span>, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;,<br>        &#123; <span class="hljs-attr">validator</span>: validateText50Required, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>      ]<br>    &#125;<br>    <span class="hljs-keyword">if</span> (menuFormRef?.<span class="hljs-property">value</span>) &#123;<br>      menuFormRef?.<span class="hljs-property">value</span>.<span class="hljs-title function_">clearValidate</span>()<br>    &#125;<br>  &#125;<br>)<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br>[elementUI el-form动态控制表单验]<a href="https://blog.csdn.net/zuoyiran520081/article/details/118051248">https://blog.csdn.net/zuoyiran520081/article/details/118051248</a>)</p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（23-2）el-tree在父子节点的联动</title>
    <link href="/2023/05/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%8823-2%EF%BC%89el-tree%E4%B9%8B%E7%88%B6%E5%AD%90%E8%8A%82%E7%82%B9%E8%81%94%E5%8A%A8/"/>
    <url>/2023/05/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%8823-2%EF%BC%89el-tree%E4%B9%8B%E7%88%B6%E5%AD%90%E8%8A%82%E7%82%B9%E8%81%94%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>el-tree 在父子节点的联动上有点小麻烦，在刚开始设计时我并没有仔细研究 API，导致出现了好多问题，本篇是踩坑记录。<br>另有全选&#x2F;全不选，全部展开&#x2F;收起操作，本篇也做一个记录。</p></blockquote><span id="more"></span><h3 id="菜单权限设计"><a href="#菜单权限设计" class="headerlink" title="菜单权限设计"></a>菜单权限设计</h3><p>业务需求：在菜单权限设计中，新增权限状态下，选择子级菜单，对应的父级菜单也应该被赋予权限。<br>编辑权限状态下，打开权限设置时，应将已有权限做一个勾选。</p><h3 id="父子节点默认非严格关联"><a href="#父子节点默认非严格关联" class="headerlink" title="父子节点默认非严格关联"></a>父子节点默认非严格关联</h3><p><code>check-strictly</code> 属性表示在“显示复选框”的情况下，是否“严格的遵循父子不互相关联”的做法，默认为 false。此时，选择父级菜单，子级菜单会全部选中；选择子级菜单，父级前会有“-”标记：<br><img src="/../img/vue23-4.png" alt="父子非严格不互相关联选择父级菜单"><br><img src="/../img/vue23-1.png" alt="父子非严格不互相关联选择子级菜单"><br>当值设置为 true 时，选择父级菜单，子级菜单不会被选中：<br><img src="/../img/vue23-3.png" alt="父子严格不互相关联"></p><h3 id="方案一：非严格关联"><a href="#方案一：非严格关联" class="headerlink" title="方案一：非严格关联"></a>方案一：非严格关联</h3><p>在提交选择时，应该将子级菜单对应的父级也加入</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">getAllNodes</span>(treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">getCheckedNodes</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>))<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getAllNodes</span> = (<span class="hljs-params">arr: <span class="hljs-built_in">Array</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> list = []<br>  <span class="hljs-keyword">let</span> pidList = []<br>  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    list.<span class="hljs-title function_">push</span>(item.<span class="hljs-property">id</span>)<br>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">pid</span> !== <span class="hljs-number">0</span> &amp;&amp; list.<span class="hljs-title function_">indexOf</span>(item.<span class="hljs-property">pid</span>) == -<span class="hljs-number">1</span>) &#123;<br>      list.<span class="hljs-title function_">push</span>(item.<span class="hljs-property">pid</span>)<br>      pidList.<span class="hljs-title function_">push</span>(item.<span class="hljs-property">pid</span>)<br>    &#125;<br>  &#125;)<br>  <span class="hljs-comment">// menuTree 是树状图的数据源</span><br>  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">menuTree</span> &amp;&amp; state.<span class="hljs-property">menuTree</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    state.<span class="hljs-property">menuTree</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">sys</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (sys.<span class="hljs-property">children</span> &amp;&amp; sys.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>        sys.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> &#123;<br>          pidList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pid</span>) =&gt;</span> &#123;<br>            <span class="hljs-keyword">if</span> (i.<span class="hljs-property">level</span> !== <span class="hljs-number">0</span> &amp;&amp; i.<span class="hljs-property">id</span> == pid) &#123;<br>              list.<span class="hljs-title function_">push</span>(i.<span class="hljs-property">pid</span>)<br>            &#125;<br>          &#125;)<br>        &#125;)<br>      &#125;<br>    &#125;)<br>  &#125;<br>  <span class="hljs-keyword">return</span> list<br>&#125;<br></code></pre></div></td></tr></table></figure><p>提交时完美实现。<br>但是出现了一个之前欠考虑的问题，就是在编辑状态下（即新增时已有勾选，初始化时后端返回已勾选数组，需要前端在打开时勾选），因为父子非严格关联，导致父节点勾选时，对应所有子节点都被勾选。</p><h3 id="方案二：严格关联"><a href="#方案二：严格关联" class="headerlink" title="方案二：严格关联"></a>方案二：严格关联</h3><p>使用 changeCheck 方法，在节点被勾选时，将其所有父节点勾选。level 为组件自带属性，可以基于此进行节点递归。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span></span><br><span class="hljs-tag">  <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;treeRef&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;menuTree&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">show-checkbox</span></span><br><span class="hljs-tag">  <span class="hljs-attr">node-key</span>=<span class="hljs-string">&quot;id&quot;</span> </span><br><span class="hljs-tag">  <span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;defaultProps&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">check</span>=<span class="hljs-string">&quot;changeCheck&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:check-strictly</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">changeCheck</span> = (<span class="hljs-params">node</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> thisNode = treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">getNode</span>(node.<span class="hljs-property">id</span>) <span class="hljs-comment">// 获取当前节点</span><br>  <span class="hljs-keyword">const</span> keys = treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">getCheckedKeys</span>() <span class="hljs-comment">// 获取已勾选节点的key值</span><br>  <span class="hljs-keyword">if</span> (thisNode.<span class="hljs-property">checked</span>) &#123; <span class="hljs-comment">// 当前节点若被选中</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = thisNode.<span class="hljs-property">level</span>; i &gt; <span class="hljs-number">1</span>; i--) &#123; <span class="hljs-comment">// 判断是否有父级节点</span><br>      <span class="hljs-keyword">if</span> (!thisNode.<span class="hljs-property">parent</span>.<span class="hljs-property">checked</span>) &#123;<br>        <span class="hljs-comment">// 父级节点未被选中，则将父节点替换成当前节点，往上继续查询，并将此节点key存入keys数组</span><br>        thisNode = thisNode.<span class="hljs-property">parent</span><br>        keys.<span class="hljs-title function_">push</span>(thisNode.<span class="hljs-property">data</span>.<span class="hljs-property">id</span>)<br>      &#125;<br>    &#125;<br>  &#125;<br>  treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">setCheckedKeys</span>(keys) <span class="hljs-comment">// 将所有keys数组的节点全选</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue23-2.png" alt="父子严格不互相关联"><br>这个有个新问题就是，用户在操作时，可能将父节点取消勾选，在提交时就只剩下子节点了，所以需要在提交时再进行一次校验，将未加入（用户手动取消）的父节点再次加入。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAddRoleMenu</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-title function_">getAllNodes</span>(treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">getCheckedNodes</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>))<br>  <span class="hljs-keyword">const</span> nodeList = treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">getCheckedKeys</span>(<span class="hljs-literal">false</span>)<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getAllNodes</span> = (<span class="hljs-params">arr: <span class="hljs-built_in">Array</span></span>) =&gt; &#123;<br>  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">changeCheck</span>(item)<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>提交时保证了所有被选择节点，及其父节点都被加入。</p><h3 id="全选-x2F-全不选"><a href="#全选-x2F-全不选" class="headerlink" title="全选&#x2F;全不选"></a>全选&#x2F;全不选</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-switch</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;changeSelectV&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:active-value</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:inactive-value</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">change</span>=<span class="hljs-string">&quot;changeSelect&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">changeSelect</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (changeSelectV.<span class="hljs-property">value</span> == <span class="hljs-literal">true</span>) &#123;<br>    treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">setCheckedNodes</span>(state.<span class="hljs-property">menuTree</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">setCheckedNodes</span>([])<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>当tree 设置了<code>check-strictly</code>，通过 setCheckedNodes 全选方法失效，父子不关联，只能选中一级父节点，只能用遍历的方式选中节点。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">changeSelect</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (changeSelectV.<span class="hljs-property">value</span> == <span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-title function_">travelNodes</span>(state.<span class="hljs-property">menuTree</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">setCheckedNodes</span>([])<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">travelNodes</span> = (<span class="hljs-params">tmpRoot</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(tmpRoot)) &#123;<br>    tmpRoot.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>      treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">setChecked</span>(item.<span class="hljs-property">id</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)<br>      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span> &amp;&amp; item.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-title function_">travelNodes</span>(item.<span class="hljs-property">children</span>)<br>      &#125;<br>    &#125;)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="全部展开-x2F-收起"><a href="#全部展开-x2F-收起" class="headerlink" title="全部展开&#x2F;收起"></a>全部展开&#x2F;收起</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-switch</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;changeCollapseV&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:active-value</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:inactive-value</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">change</span>=<span class="hljs-string">&quot;changeCollapse&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">changeCollapse</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-title function_">travelExpend</span>(state.<span class="hljs-property">menuTree</span>, changeCollapseV.<span class="hljs-property">value</span>)<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">travelExpend</span> = (<span class="hljs-params">branch: <span class="hljs-built_in">Array</span>, expend: boolean</span>) =&gt; &#123;<br>  branch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    treeRef.<span class="hljs-property">value</span>!.<span class="hljs-property">store</span>.<span class="hljs-property">nodesMap</span>[item.<span class="hljs-property">id</span>].<span class="hljs-property">expanded</span> = expend<br>    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span>) &#123;<br>      <span class="hljs-title function_">travelExpend</span>(item.<span class="hljs-property">children</span>, expend)<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（27-5）table树状展开</title>
    <link href="/2023/05/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-5%EF%BC%89el-table%E6%A0%91%E7%8A%B6%E5%B1%95%E5%BC%80/"/>
    <url>/2023/05/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%8827-5%EF%BC%89el-table%E6%A0%91%E7%8A%B6%E5%B1%95%E5%BC%80/</url>
    
    <content type="html"><![CDATA[<blockquote><p>table 是作为数据展示重要的一项，最近的需求是需要做一个系统的菜单配置，菜单可能有多级，设计稿要求是多级菜单可以以树状图展开。<br>本篇前后使用了两种方法，记录一下踩坑。<br>更新：加入懒加载。</p></blockquote><span id="more"></span><h3 id="方法一：expand"><a href="#方法一：expand" class="headerlink" title="方法一：expand"></a>方法一：expand</h3><p>给 el-table-column 设置属性 type&#x3D;”expand” 可以自定义展开，实现 table 内嵌 table 的效果。<br>我的设计思路是展开的 column 也设置同样的属性，那不就可以共享列了嘛～<br>还有一个问题就是 slot 中展开的 table 列可能会和父级 table 列对不齐，于是我给子集设计了一个空列，长度加起来和父级 table 列宽度相同，初看非常完美，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;sysList&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:row-key</span>=<span class="hljs-string">&quot;getRowKeys&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:expand-row-keys</span>=<span class="hljs-string">&quot;expands&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">expand-change</span>=<span class="hljs-string">&quot;toggleRowExpansion&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;expand&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;plcs&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">        <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;plcsTable&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;plcs.row.children&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:row-key</span>=<span class="hljs-string">&quot;getRowKeys&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:show-header</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:expand-row-keys</span>=<span class="hljs-string">&quot;childExpands&quot;</span></span><br><span class="hljs-tag">        @<span class="hljs-attr">expand-change</span>=<span class="hljs-string">&quot;childRowExpansion&quot;</span></span><br><span class="hljs-tag">      &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;40&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;expand&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;sys&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">              <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;sys.row.btn&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">:row-key</span>=<span class="hljs-string">&quot;getRowKeys&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">:show-header</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">:expand-row-keys</span>=<span class="hljs-string">&quot;childExpands&quot;</span></span><br><span class="hljs-tag">              @<span class="hljs-attr">expand-change</span>=<span class="hljs-string">&quot;childRowExpansion&quot;</span></span><br><span class="hljs-tag">            &gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span></span><br><span class="hljs-tag">                <span class="hljs-attr">fixed</span></span><br><span class="hljs-tag">                <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;菜单名称&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;name&quot;</span></span><br><span class="hljs-tag">                <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;148&quot;</span></span><br><span class="hljs-tag">              &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>              <span class="hljs-comment">&lt;!-- 这里是各个table-column --&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;菜单名称&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;180&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 这里是各个table-column --&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;菜单名称&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;220&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- 这里是各个table-column --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>还需要设置 row-key ，保证每列不同，这样展开收起时不会产生冲突。expand-change 是每次展开操作时调用的方法，这里主要是控制自身状态改变，以及父级展开自身时将子级收起，实现手风琴效果。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> expands = <span class="hljs-title function_">ref</span>([])<br><span class="hljs-keyword">const</span> childExpands = <span class="hljs-title function_">ref</span>([])<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleRowExpansion</span> = (<span class="hljs-params">row</span>) =&gt; &#123;<br>  childExpands.<span class="hljs-property">value</span> = []<br>  <span class="hljs-title function_">toggleExpansion</span>(<span class="hljs-string">&#x27;expands&#x27;</span>, row)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(expands.<span class="hljs-property">value</span>, childExpands.<span class="hljs-property">value</span>)<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">childRowExpansion</span> = (<span class="hljs-params">row</span>) =&gt; &#123;<br>  <span class="hljs-title function_">toggleExpansion</span>(<span class="hljs-string">&#x27;childExpands&#x27;</span>, row)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(expands.<span class="hljs-property">value</span>, childExpands.<span class="hljs-property">value</span>)<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleExpansion</span> = (<span class="hljs-params">Expands, row</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> [expandsNum] = [<span class="hljs-title class_">Expands</span>]<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;expandsNum=&#x27;</span>, expandsNum, <span class="hljs-string">&#x27;toggleExpansion&#x27;</span>, <span class="hljs-title class_">Expands</span>, <span class="hljs-string">&#x27;row.id=&#x27;</span>, row.<span class="hljs-property">id</span>)<br>  <span class="hljs-keyword">if</span> (expandsNum == row.<span class="hljs-property">id</span>) &#123;<br>    ;[<span class="hljs-title class_">Expands</span>] = []<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>  &#125;<br>  ;[<span class="hljs-title class_">Expands</span>] = []<br>  ;[<span class="hljs-title class_">Expands</span>].<span class="hljs-title function_">push</span>(row.<span class="hljs-property">id</span>)<br>&#125;<br><span class="hljs-comment">// 获取row的key值</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getRowKeys</span> = (<span class="hljs-params">row</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> row.<span class="hljs-property">id</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>由于本项目中列数较多，产品要求序号列、name列和操作列固定，对用户更友好。于是我给这些列设置了属性 fixed ，结果，新问题来了，子集展开table无法固定了！如下图所示：<br><img src="/../img/vue22-6.png" alt="tree-props实现效果"><br>我想了半天是不是还需要手动给 slot 中的 table 设置样式呢？这样也太麻烦了吧。。。</p><h3 id="方法二：tree-props"><a href="#方法二：tree-props" class="headerlink" title="方法二：tree-props"></a>方法二：tree-props</h3><p>再次查阅资料，发现了 tree-props 这个属性，设置 tree-props 为{children: ‘children’,hasChildren: ‘hasChildren’} ，data 绑定的数据需要保留 children 属性，当 row 中包含 children 字段时，被视为树形数据。渲染树形数据时，必须要指定 row-key（绑定数据的唯一值变量id）；<br><strong>支持子节点数据异步加载</strong>；<br><strong>注意：如果不是懒加载的话，不要设置 hasChildren 这个属性，要不然树形无法显示；如果是懒加载，则需要设置hasChildren字段。</strong><br>尝试代码如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;sysList&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:row-key</span>=<span class="hljs-string">&quot;getRowKeys&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table-expand&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:tree-props</span>=<span class="hljs-string">&quot;&#123; children: &#x27;children&#x27;, hasChildren: &#x27;hasChildren&#x27; &#125;&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;菜单名称&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;220&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- 这里是各个table-column --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span>=<span class="hljs-string">&quot;right&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;操作&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;350&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;openEdit(scope.$index, scope.row)&quot;</span>&gt;</span>编辑<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>哦豁，居然完美实现了固定列和下拉展开！只是展开会有状态的延续性，点击下一级无法实现手风琴效果。<br>网上说添加<code>:expand-row-keys=&quot;expands&quot; @expand-change=&quot;expandSelect&quot;</code>可以控制展开，但是我添加之后发现连原始的小箭头都无法点击了，遂放弃。<br>在 fixed 和手风琴效果里面 trade-off，还是 fixed 更重要吧～<br><img src="/../img/vue22-5.png" alt="tree-props实现效果"></p><h3 id="进一步优化-按照层级对齐"><a href="#进一步优化-按照层级对齐" class="headerlink" title="进一步优化-按照层级对齐"></a>进一步优化-按照层级对齐</h3><p>展开多级以后，发现各层级之间查看较为眼花，最好能用缩进来展示层级，这里我设计了动态 style ，按照层级加一个 padding ，轻松搞定～</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">fixed</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;菜单名称&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;220&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;&#123; &#x27;padding-left&#x27;: (scope.row.level - 1) * 8 + &#x27;px&#x27; &#125;&quot;</span>&gt;</span>&#123;&#123;<br>      scope.row.name<br>    &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue22-7.png" alt="tree-props按照层级对齐"><br>【注意】在table里进行不要使用 <code>el-dropdown</code> 来折叠按钮，实测会卡顿（肉眼能感觉到的明显卡顿）</p><h3 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h3><p>在已完成需求的情况下，用户感觉菜单加载太慢了，loading 要好几秒钟，经过排查，是因为后端做了很多数据处理，包括树状图数据结构拼接，商议之后决定还是做一次懒加载。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span></span><br><span class="hljs-tag">  <span class="hljs-attr">lazy</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:load</span>=<span class="hljs-string">&quot;loadNode&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:tree-props</span>=<span class="hljs-string">&quot;&#123; children: &#x27;children&#x27;, hasChildren: &#x27;hasChildren&#x27; &#125;&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;sysList&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:row-key</span>=<span class="hljs-string">&quot;getRowKeys&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>点击小三角执行懒加载</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadNode</span> = (<span class="hljs-params">row: &#123; [key: string]: any &#125;, treeNode: any, resolve: any</span>) =&gt; &#123;<br><span class="hljs-title function_">getData</span>(&#123;<span class="hljs-attr">params</span>: <span class="hljs-string">&#x27;当前选中行的name&#x27;</span>&#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://blog.csdn.net/momoomom/article/details/108016148">element-ui table expand 展开树形菜单手风琴效果</a><br><a href="https://blog.csdn.net/Dream104/article/details/127324011">使用 el-table 实现树形数据懒加载</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（23-1）el-tree组合el-tooltip</title>
    <link href="/2023/05/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%8823-1%EF%BC%89el-tree%E7%BB%84%E5%90%88el-tooltip/"/>
    <url>/2023/05/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%8823-1%EF%BC%89el-tree%E7%BB%84%E5%90%88el-tooltip/</url>
    
    <content type="html"><![CDATA[<blockquote><p>树状目录出现了文字太长的情况，这篇记录解决方案。</p></blockquote><span id="more"></span><h3 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h3><p>树状展示目录出现了文字太长的情况，文字被挤出，不仅无法知晓目录代表什么，更无法进行编辑操作。</p><h3 id="解决方案-增加滚动条"><a href="#解决方案-增加滚动条" class="headerlink" title="解决方案-增加滚动条"></a>解决方案-增加滚动条</h3><p>效果如下：<br><img src="/../img/vue17-1.png" alt="scroll"></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;down-tree&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;treeData&quot;</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;treeData&quot;</span> <span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;defaultProps&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;filter-tree&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-tree</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.down-tree</span> &#123;<br>  <span class="hljs-attribute">overflow</span>: auto;<br>  <span class="hljs-attribute">max-height</span>: <span class="hljs-number">790px</span>;<br>  <span class="hljs-comment">/*滚动条整体样式*/</span><br>  &amp;::-webkit-scrollbar &#123;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/*高宽分别对应横竖滚动条的尺寸*/</span><br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;<br>  &#125;<br>   <span class="hljs-comment">/*滚动条里面小方块*/</span><br>  &amp;::-webkit-scrollbar-thumb &#123;<br>    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<br>    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;<br>  &#125;<br>  &amp;::-webkit-scrollbar-track &#123;<br>    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<br>    <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-built_in">rgb</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<br>    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;<br>  &#125;<br>  &amp;::-webkit-scrollbar-button &#123;<br>    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<br>    <span class="hljs-attribute">display</span>: none;<br>  &#125;<br> <br>  &amp;<span class="hljs-selector-pseudo">:hover</span> &#123;<br>    <span class="hljs-comment">/*滚动条里面小方块*/</span><br>    &amp;::-webkit-scrollbar-thumb &#123;<br>      <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);<br>      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;<br>    &#125;<br>    &amp;::-webkit-scrollbar-track &#123;<br>      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;<br>      <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">253</span>, <span class="hljs-number">249</span>, <span class="hljs-number">249</span>, <span class="hljs-number">0.1</span>);<br>      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;<br>    &#125;<br>    &amp;::-webkit-scrollbar-button &#123;<br>      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eee</span>;<br>      <span class="hljs-attribute">display</span>: none;<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-selector-class">.el-tree</span> &#123;<br>  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">100%</span>;<br>  <span class="hljs-attribute">display</span>: inline-block;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="解决方案-增加Tootlip提示"><a href="#解决方案-增加Tootlip提示" class="headerlink" title="解决方案-增加Tootlip提示"></a>解决方案-增加Tootlip提示</h3><p>效果如下：<br><img src="/../img/vue17-2.png" alt="scroll"><br>首先需要限制字数，多余部分<code>...</code>表示，在hover时展示所有文字。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">arrToTree</span> = (<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;deptOne&gt;</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Treedata=&quot;</span>, data);<br>  <span class="hljs-keyword">const</span> tree = [];<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(data)) &#123;<br>    <span class="hljs-keyword">return</span> tree;<br>  &#125;<br>  <span class="hljs-keyword">const</span> map = &#123;&#125;;<br>  data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    map[item.<span class="hljs-property">id</span>] = item;<br>  &#125;);<br>  data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> parent = map[item.<span class="hljs-property">parent</span>];<br>    <span class="hljs-keyword">delete</span> item.<span class="hljs-property">parent</span>;<br>    item[<span class="hljs-string">&quot;label&quot;</span>] = item.<span class="hljs-property">name</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">6</span> ? item.<span class="hljs-property">name</span>.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>,<span class="hljs-number">6</span>) + <span class="hljs-string">&#x27;...&#x27;</span> : item.<span class="hljs-property">name</span>;<br>    item[<span class="hljs-string">&quot;value&quot;</span>] = item.<span class="hljs-property">id</span>;<br>    <span class="hljs-comment">// delete item.name; 保留name作为原始数据</span><br><br>    <span class="hljs-keyword">if</span> (parent) &#123;<br>      (parent.<span class="hljs-property">children</span> || (parent.<span class="hljs-property">children</span> = [])).<span class="hljs-title function_">push</span>(item);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      tree.<span class="hljs-title function_">push</span>(item);<br>    &#125;<br>  &#125;);<br>  <span class="hljs-keyword">return</span> tree[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span></span><br><span class="hljs-tag"><span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;attrTree&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;defaultProps&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">node-key</span>=<span class="hljs-string">&quot;id&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">default-expand-all</span></span><br><span class="hljs-tag"><span class="hljs-attr">:expand-on-click-node</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">:render-content</span>=<span class="hljs-string">&quot;renderContent&quot;</span></span><br><span class="hljs-tag"><span class="hljs-attr">:highlight-current</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">@<span class="hljs-attr">node-click</span>=<span class="hljs-string">&quot;handleNodeClick&quot;</span></span><br><span class="hljs-tag">&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;&#123; node, data &#125;&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;custom-tree-node&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span></span><br><span class="hljs-tag">      <span class="hljs-attr">effect</span>=<span class="hljs-string">&quot;dark&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:content</span>=<span class="hljs-string">&quot;data.name&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">placement</span>=<span class="hljs-string">&quot;top-start&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;font-size: 14px&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;&#123; node.label &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;data.label == &#x27;XX信息&#x27;&quot;</span></span><br><span class="hljs-tag">        @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;openAddDir(data.id, 1, data)&quot;</span>&gt;</span><br>      +<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!data.children &amp;&amp;!(data.label == &#x27;XX信息&#x27;)&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;margin-left: 8px&quot;</span></span><br><span class="hljs-tag">        @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;remove(data.id)&quot;</span>&gt;</span><br>        -<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!data.children &amp;&amp;!(data.label == &#x27;XX信息&#x27;)&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;margin-left: 8px&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span></span><br><span class="hljs-tag">          <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;search-dir&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;openAddDir(data.id, 2, data)&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">Edit</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-tree</span>&gt;</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（22）多环境发版脚本</title>
    <link href="/2023/05/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8822%EF%BC%89%E5%A4%9A%E7%8E%AF%E5%A2%83%E5%8F%91%E7%89%88%E8%84%9A%E6%9C%AC/"/>
    <url>/2023/05/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8822%EF%BC%89%E5%A4%9A%E7%8E%AF%E5%A2%83%E5%8F%91%E7%89%88%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<blockquote><p>分了开发环境、测试环境、demo演示环境、生产环境四个环境，对应API不一样，vite打包一次接近5分钟，如果改个bug就要重新发版，那老夫就不能准时下班了。<br>为了解决这个问题，写了个多环境一键发版脚本。</p></blockquote><span id="more"></span><h3 id="原方式"><a href="#原方式" class="headerlink" title="原方式"></a>原方式</h3><p><code>deploy.bash</code>脚本写了多个环境的发版，分别执行，虽然没啥问题，但是人力成本、时间成本略大。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># **环境</span><br>npm run build:<span class="hljs-built_in">test</span><br><span class="hljs-built_in">rm</span> -rf cardlc<br><span class="hljs-built_in">mv</span> dist cardlc<br>scp -r cardlc/  root@***:/data/<br></code></pre></div></td></tr></table></figure><h3 id="新方式"><a href="#新方式" class="headerlink" title="新方式"></a>新方式</h3><p>在<code>public/static/config.js</code>中写入全局变量，打包后通过脚本分别修改不同环境的请求API地址，然后发布到服务器。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">g</span> = &#123;<br>  <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">&quot;http://10.10.34.31:8087&quot;</span>,<br>  <span class="hljs-attr">tag</span>: <span class="hljs-string">&quot;1&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>buildMultiEnv.js</code>脚本进行文件读写</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fs&quot;</span>);<br><br><span class="hljs-keyword">const</span> filePath = <span class="hljs-string">&#x27;./dist/static/config.js&#x27;</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">changeBuildUrl</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  fs.<span class="hljs-title function_">readFile</span>(filePath, <span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) &#123;<br>    <span class="hljs-keyword">if</span>(err) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)<br>      <span class="hljs-keyword">return</span><br>    &#125; <br>    <span class="hljs-keyword">let</span> str = data.<span class="hljs-title function_">toString</span>()<br>    <span class="hljs-keyword">const</span> tag = str.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;tag: &quot;&#x27;</span>)[<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&quot;&#x27;</span>)[<span class="hljs-number">0</span>]<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tag)<br>    <span class="hljs-keyword">let</span> content = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span>(tag == <span class="hljs-string">&#x27;1&#x27;</span>) &#123; <span class="hljs-comment">// 开发环境</span><br>      content = <span class="hljs-string">&#x27;window.g=&#123;apiUrl:&quot;http://***.31:8080&quot;,tag: &quot;2&quot;&#125;&#x27;</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(tag == <span class="hljs-string">&#x27;2&#x27;</span>) &#123; <span class="hljs-comment">// 测试环境</span><br>      content = <span class="hljs-string">&#x27;window.g=&#123;apiUrl:&quot;http://***.32:8080&quot;,tag: &quot;3&quot;&#125;&#x27;</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(tag == <span class="hljs-string">&#x27;3&#x27;</span>) &#123; <span class="hljs-comment">// demo环境</span><br>      content = <span class="hljs-string">&#x27;window.g=&#123;apiUrl:&quot;http://***.31:8089&quot;,tag: &quot;1&quot;&#125;&#x27;</span><br>    &#125;<span class="hljs-keyword">else</span> &#123;&#125;<br>    fs.<span class="hljs-title function_">writeFile</span>(filePath, content, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;写入失败&quot;</span>, err);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;写入成功。&quot;</span>);<br>      &#125;<br>    &#125;)<br>  &#125;)<br>&#125;;<br><span class="hljs-title function_">changeBuildUrl</span>();<br></code></pre></div></td></tr></table></figure><p><code>deplay.bash</code> 最终脚本，生产环境涉及一些特殊处理，单独罗列。<br>一定要注意先把之前的文件清空，不然生成的新文件会被移动到旧文件里面。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 开发环境、测试环境、演示demo环境一键更新</span><br><span class="hljs-built_in">rm</span> -rf cardlc<br>npm run build:<span class="hljs-built_in">test</span><br>node ./buildMultiEnv.js <br><span class="hljs-built_in">cp</span> -r dist cardlc<br>scp -r cardlc/  root@***.31:/data/<br><span class="hljs-built_in">rm</span> -rf cardlc<br>node ./buildMultiEnv.js <br><span class="hljs-built_in">cp</span> -r dist cardlc<br>scp -r cardlc/  root@***.32:/data/<br><span class="hljs-built_in">rm</span> -rf cardlc<br>node ./buildMultiEnv.js <br><span class="hljs-built_in">cp</span> -r dist cardlc<br>scp -r cardlc/  root@***.31:/data/demo<br><br><span class="hljs-comment"># 生产环境</span><br>npm run build:prod<br><span class="hljs-built_in">rm</span> -rf cardlc<br><span class="hljs-built_in">mv</span> dist cardlc<br>scp -r cardlc/  root@***.33:/data/<br></code></pre></div></td></tr></table></figure><p>试了一下，打包完之后上传至服务器，输入密码，再次执行两次，非常丝滑，nice～</p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（21-2）动态路由</title>
    <link href="/2023/05/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8821-2%EF%BC%89%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1/"/>
    <url>/2023/05/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8821-2%EF%BC%89%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇是上一篇的延伸，详细记录下动态路由的使用。</p></blockquote><span id="more"></span><h3 id="项目中使用-子系统"><a href="#项目中使用-子系统" class="headerlink" title="项目中使用-子系统"></a>项目中使用-子系统</h3><p>动态菜单格式如下：</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;菜单获取成功&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;pid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 最上层pid代表系统</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;一级菜单&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;一级菜单&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/first&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;fold&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;component&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BasicLayout&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;icon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;first-icon&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hidden&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;meta&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;一级菜单&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;icon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;first-icon&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;hidden&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;multiple&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;children&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;pid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;二级菜单&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;二级菜单&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/second&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;fold&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;home&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;component&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;icon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;first-icon&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;hidden&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;children&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;pid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;删除&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hidden&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;api&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/api/partner/&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DELETE&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><p>其中 level&#x3D;3 数组，用于前端按钮展示，为了用户友好，系统定义若用户无权限访问（例如只能查看，不能修改），直接将操作按钮隐藏。</p><p><code>store/modules/permission.ts</code>中存储菜单信息，这里<code>MenuType</code>添加了类型 fold ，表示文件夹地址，因为前端在工程设计时将不同组件存放于不同文件夹下，如果直接在path中写几层地址，这里会导致导入组件失败。<br>routes表示静态路由，例如：首页（&#x2F;），404（&#x2F;404）等应用开放给所有用户的页面，dynamicRoutes 表示动态路由，是在应用初始化时从后端获取的。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; defineStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span><br><span class="hljs-keyword">import</span> &#123; store &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store/index&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">BasicLayout</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/layout/index&#x27;</span><br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../router&#x27;</span><br><span class="hljs-keyword">import</span> &#123; getUserRoutes &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/api/user&#x27;</span><br><br><span class="hljs-keyword">export</span> type <span class="hljs-title class_">MenuType</span> = &#123;<br>  <span class="hljs-attr">path</span>: string<br>  <span class="hljs-attr">title</span>: string<br>  fold?: string<br>  meta?: any<br>  <span class="hljs-attr">component</span>: string<br>  redirect?: string<br>  children?: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">MenuType</span>&gt;<br>&#125;<br><br>interface <span class="hljs-title class_">IPermissionState</span> &#123;<br>  <span class="hljs-attr">routes</span>: any[]<br>  <span class="hljs-attr">dynamicRoutes</span>: any[]<br>&#125;<br><br><span class="hljs-comment">// 生产环境导入组件</span><br><span class="hljs-keyword">const</span> modules = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-title function_">glob</span>(<span class="hljs-string">&#x27;../../views/**/*.vue&#x27;</span>)<br><span class="hljs-comment">// 本地开发环境导入组件</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">_import</span> = (<span class="hljs-params">path: string, fold: string</span>) =&gt; <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">`../../views/<span class="hljs-subst">$&#123;fold&#125;</span>/<span class="hljs-subst">$&#123;path&#125;</span>.vue`</span>)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">assembleRouter</span> = (<span class="hljs-params">routers: any</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> addRouter = routers.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">router: any</span>) =&gt;</span> &#123;<br>    router.<span class="hljs-property">title</span> &amp;&amp;<br>      router.<span class="hljs-property">icon</span> &amp;&amp;<br>      (router.<span class="hljs-property">meta</span> = &#123;<br>        <span class="hljs-attr">title</span>: router.<span class="hljs-property">title</span><br>        <span class="hljs-comment">// icon: router.icon, // 子菜单暂时不用icon</span><br>      &#125;)<br>    <span class="hljs-keyword">if</span> (router.<span class="hljs-property">component</span> === <span class="hljs-string">&#x27;BasicLayout&#x27;</span>) &#123;<br>      router.<span class="hljs-property">component</span> = <span class="hljs-title function_">shallowRef</span>(<span class="hljs-title class_">BasicLayout</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">MODE</span> === <span class="hljs-string">&#x27;dev&#x27;</span>) &#123;<br>        router.<span class="hljs-property">component</span> = <span class="hljs-title function_">_import</span>(router.<span class="hljs-property">component</span>, router.<span class="hljs-property">fold</span>)<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        router.<span class="hljs-property">component</span> = modules[<span class="hljs-string">`../../views/<span class="hljs-subst">$&#123;router.fold&#125;</span>/<span class="hljs-subst">$&#123;router.component&#125;</span>.vue`</span>]<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (router.<span class="hljs-property">children</span> &amp;&amp; router.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>) &#123;<br>      router.<span class="hljs-property">children</span> = <span class="hljs-title function_">assembleRouter</span>(router.<span class="hljs-property">children</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;)<br>  <span class="hljs-keyword">return</span> addRouter<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> usePermissionStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;permission&#x27;</span>, &#123;<br>  <span class="hljs-attr">state</span>: (): <span class="hljs-function"><span class="hljs-params">IPermissionState</span> =&gt;</span> (&#123;<br>    <span class="hljs-attr">routes</span>: [],<br>    <span class="hljs-attr">dynamicRoutes</span>: [],<br>  &#125;),<br>  <span class="hljs-attr">getters</span>: &#123;<br>    <span class="hljs-title function_">getRoutes</span>(): any[] &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span><br>    &#125;,<br>    <span class="hljs-title function_">getDynamicRoutes</span>(): any[] &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dynamicRoutes</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">actions</span>: &#123;<br>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getMenus</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserRoutes</span>(&#123;&#125;)<br>         <span class="hljs-variable language_">this</span>.<span class="hljs-property">dynamicRoutes</span> = data<br>        <span class="hljs-comment">// 组件路由</span><br>        <span class="hljs-keyword">const</span> addRouter = <span class="hljs-title function_">assembleRouter</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dynamicRoutes</span>)<br>        <span class="hljs-comment">// 动态添加菜单</span><br>        addRouter.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">ts: any</span>) =&gt;</span> &#123;<br>          router.<span class="hljs-title function_">addRoute</span>(ts)<br>        &#125;)<br>      &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err)<br>      &#125;<br>    &#125;,<br>    <span class="hljs-title function_">clearMenus</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dynamicRoutes</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span><br>    &#125;<br>  &#125;<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">usePermissionStoreWithOut</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">usePermissionStore</span>(store)<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>Sidebar/index.vue</code>中渲染菜单，这里可以使用<br>（1）router.getRoutes()<br>（2）router.options.routes 和d ynamicRoutes 的组合来展示侧栏菜单<br>但是 getRoutes 中携带的数据不够，这里需要自定义菜单的部分内容，所以还是采用获取的后端原始数据的 dynamicRoutes。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-scrollbar</span> <span class="hljs-attr">wrap-class</span>=<span class="hljs-string">&quot;scrollbar-wrapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-menu</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">sidebar-item</span></span><br><span class="hljs-tag">        <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;menu in menuList&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;menu.path&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:item</span>=<span class="hljs-string">&quot;menu&quot;</span></span><br><span class="hljs-tag">      /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-menu</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-scrollbar</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> menuList = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">    <span class="hljs-comment">// return router.getRoutes()</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> routes = router.<span class="hljs-property">options</span>.<span class="hljs-property">routes</span> || []</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> menus = permissionStore.<span class="hljs-property">dynamicRoutes</span> || []</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span> routes.<span class="hljs-title function_">concat</span>(menus)</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>子系统<code>permission.ts</code>路由守卫中中判断 token。<br>若有，执行获取动态菜单的操作，并且在获取成功之后进行过滤，如果当前去往的地址在白名单内，则放行；反之，跳转 404 页面。<br>若无 token，则跳转 UMS 首页。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useUserStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store/modules/user&#x27;</span><br><span class="hljs-keyword">import</span> &#123; usePermissionStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store/modules/permission&#x27;</span><br><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> (to, <span class="hljs-keyword">from</span>, next) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()<br>  <span class="hljs-keyword">const</span> token = userStore.<span class="hljs-property">getToken</span><br><br>  <span class="hljs-keyword">if</span> (token) &#123;<br>    <span class="hljs-keyword">const</span> permissionStore = <span class="hljs-title function_">usePermissionStore</span>()<br>    <span class="hljs-keyword">const</span> &#123; dynamicRoutes, getMenus &#125; = permissionStore<br>    <span class="hljs-keyword">if</span> (dynamicRoutes.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 调用接口获取动态路由菜单</span><br>        <span class="hljs-keyword">await</span> <span class="hljs-title function_">getMenus</span>()<br>        <span class="hljs-keyword">const</span> allowList = router.<span class="hljs-title function_">getRoutes</span>()<br>        <span class="hljs-keyword">const</span> userP = allowList.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">path</span> == to.<span class="hljs-property">path</span>)<br>        <span class="hljs-keyword">if</span> (userP.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">// 访问路径在白名单中</span><br>          <span class="hljs-title function_">next</span>(&#123; ...to, <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> &#125;)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-title function_">next</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/404&#x27;</span> &#125;)<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 动态路由已获取</span><br>      <span class="hljs-title function_">next</span>()<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 无token，跳转ums首页</span><br>    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>同时在<code>service.ts</code>中也需要设置若 token 失效（请求中后端返回 401），跳转系统首页。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<br>  <span class="hljs-function">(<span class="hljs-params">response: AxiosResponse&lt;any&gt;</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; config, status, data &#125; = response<br>    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">responseType</span> === <span class="hljs-string">&#x27;blob&#x27;</span>) &#123;<br>      <span class="hljs-keyword">return</span> response <span class="hljs-comment">// 如果是文件流，直接过</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status === result_code) &#123;<br>      <span class="hljs-keyword">return</span> data<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(data.<span class="hljs-property">message</span>)<br>    &#125;<br>  &#125;,<br>  <span class="hljs-function">(<span class="hljs-params">error: AxiosError</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;error=&#x27;</span>, error)<br>    <span class="hljs-keyword">if</span> (error &amp;&amp; <span class="hljs-title class_">String</span>(error).<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;401&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-comment">// Unauthorized</span><br>      <span class="hljs-title function_">removeToken</span>()<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>()<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error &amp;&amp; <span class="hljs-title class_">String</span>(error).<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;403&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;当前没有操作权限，请联系管理员。&#x27;</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>)<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)<br>    &#125;<br>  &#125;<br>)<br></code></pre></div></td></tr></table></figure><h3 id="UMS系统"><a href="#UMS系统" class="headerlink" title="UMS系统"></a>UMS系统</h3><p>这里设置白名单，无 token 状态下白名单路由放行。<br>casdoor 登录成功跳转页（&#x2F;cb）在白名单中，用作系统登录中转（使用 casdoor SDK 登录），成功后跳转首页。<br>同理，若在子系统已清除 token 情况下，跳转 UMS 首页（&#x2F;ums），则通过首页中转后间接跳转登录页（&#x2F;login）。<br><code>ums</code>中的路由守卫如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useUserStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store/modules/user&#x27;</span><br><br><span class="hljs-keyword">const</span> whiteList = [<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-string">&#x27;/cb&#x27;</span>]<br><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> (to, <span class="hljs-keyword">from</span>, next) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()<br>  <span class="hljs-keyword">const</span> token = userStore.<span class="hljs-property">getToken</span><br>  <span class="hljs-keyword">if</span> (token) &#123;<br>    <span class="hljs-keyword">if</span> (to.<span class="hljs-property">path</span> === <span class="hljs-string">&#x27;/login&#x27;</span>) &#123;<br>      <span class="hljs-title function_">next</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span> &#125;)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">next</span>()<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (whiteList.<span class="hljs-title function_">indexOf</span>(to.<span class="hljs-property">path</span>) !== -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-title function_">next</span>()<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">next</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/login&#x27;</span> &#125;)<br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（21-1）vue-router4</title>
    <link href="/2023/05/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8821-1%EF%BC%89vue-router4/"/>
    <url>/2023/05/08/vue3%E7%AC%94%E8%AE%B0%EF%BC%8821-1%EF%BC%89vue-router4/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇详细记录下用到过的路由方法，基于vue-router4</p></blockquote><span id="more"></span><h3 id="项目中使用"><a href="#项目中使用" class="headerlink" title="项目中使用"></a>项目中使用</h3><ol><li><p><code>main.ts</code>中引入<br>安装router插件的时候注册了router-link和router-view这两个全局组件，项目中能直接使用。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)<br>app.<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br></code></pre></div></td></tr></table></figure></li><li><p><code>router/index.ts</code>中写静态路由</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory, <span class="hljs-title class_">RouteRecordRaw</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">SimpleLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/layout/simple.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">NotFound</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/error/404.vue&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">constantRoutes</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">RouteRecordRaw</span>&gt; = [<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/login/auth.vue&#x27;</span>)),<br>    <span class="hljs-attr">meta</span>: &#123; <span class="hljs-attr">hidden</span>: <span class="hljs-literal">true</span> &#125;<br>  &#125;,<br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/:pathMatch(.*)*&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;NotFound&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">NotFound</span> &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;dash&#x27;</span>, <span class="hljs-comment">// 路由命名</span><br>    <span class="hljs-attr">component</span>: <span class="hljs-title class_">SimpleLayout</span>,<br>    <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;/dash&#x27;</span>, <span class="hljs-comment">// 重定向，还可以写成命名路由、方法</span><br>    <span class="hljs-attr">meta</span>: &#123; <span class="hljs-comment">// 路由元信息</span><br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;dash&#x27;</span>,<br>      <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;userm&#x27;</span>,<br>      <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">level</span>: <span class="hljs-number">1</span> <span class="hljs-comment">// 用于在sidebar中渲染子菜单，可设置成level=2</span><br>    &#125;,<br>    <span class="hljs-attr">children</span>: [ <span class="hljs-comment">// 可以有多个子菜单</span><br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dash&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/home/index.vue&#x27;</span>))<br>      &#125;<br>    ]<br>  &#125;<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>), <span class="hljs-comment">// 手动启用历史记录模式</span><br>  <span class="hljs-attr">routes</span>: constantRoutes<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router<br></code></pre></div></td></tr></table></figure></li></ol><p>（1）在写 redirect 的时候，可以省略 component 配置，因为它从来没有被直接访问过。唯一的例外是嵌套路由：如果一个路由记录有 children 和 redirect 属性，它也应该有 component 属性。</p><p>（2）<code>createWebHistory</code>创建 HTML5 模式，需要在<code>nginx</code> 中需要添加以下配置，作为一个简单的回退路由。如果 URL 不匹配任何静态资源，返回与 index.html 相同的页面。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">location / &#123;<br>  try_files $uri $uri/ /index.html;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>（3）meta属性接收任意路由附加信息，并且它可以在路由地址和导航守卫上都被访问到。   </p><ol start="3"><li><code>layout/app-main.vue</code>中引入<br>router-link的页面切换只是更新了页面的部分内容，不会进行整个页面的刷新<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;app-main&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">transition</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;fade&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;transition&quot;</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">&quot;out-in&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">transition</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li></ol><h3 id="跳转方式一：sibebar-item中使用"><a href="#跳转方式一：sibebar-item中使用" class="headerlink" title="跳转方式一：sibebar-item中使用"></a>跳转方式一：sibebar-item中使用</h3><p>属性 to 与 router.push 接受的对象种类相同，两者的规则完全相同。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">&quot;...&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">&quot;...&quot;</span> <span class="hljs-attr">replace</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="跳转方式二：组件中使用"><a href="#跳转方式二：组件中使用" class="headerlink" title="跳转方式二：组件中使用"></a>跳转方式二：组件中使用</h3><p> 编程式导航注意：</p><ol><li>params 不能与 path 一起使用</li><li>router.push 和所有其他导航方法都会返回一个 Promise</li><li>replace 在导航时不会向 history 添加新记录</li><li>直接 watch 期望改变的参数，避免监听整个 route 对象</li><li>若路由导航相同，相同的组件实例将被重复使用（组件的生命周期钩子不会被调用）<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useRouter, useRoute &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()<br><span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()<br><br>router.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;/users&#x27;</span>)<br>router.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/home&#x27;</span>, <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> &#125;) <br><span class="hljs-comment">// 相当于router.replace(&#123; path: &#x27;/home&#x27; &#125;)</span><br><br><span class="hljs-comment">// 带有路径的对象</span><br>router.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/users&#x27;</span> &#125;)<br><br><span class="hljs-comment">// 命名的路由，并加上参数，让路由建立 url</span><br>router.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;ginny&#x27;</span> &#125; &#125;)<br><br><span class="hljs-comment">// 带查询参数，结果是 /aaa?b=1&amp;c=1</span><br>router.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/aaa&#x27;</span>, <span class="hljs-attr">query</span>: &#123; ...route.<span class="hljs-property">query</span>, ...query &#125; &#125;)<br><br><span class="hljs-comment">// 带 hash，结果是 /about#team</span><br>router.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/about&#x27;</span>, <span class="hljs-attr">hash</span>: <span class="hljs-string">&#x27;#team&#x27;</span> &#125;)<br>router.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>)  <span class="hljs-comment">// 返回、后退一步</span><br><span class="hljs-title function_">watch</span>( <span class="hljs-comment">// 当参数更改时获取用户信息</span><br>  <span class="hljs-function">() =&gt;</span> route.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>,<br>  <span class="hljs-keyword">async</span> newId =&gt; &#123;<br>    userData.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(newId)<br>  &#125;<br>)<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="守卫导航"><a href="#守卫导航" class="headerlink" title="守卫导航"></a>守卫导航</h3><ol><li>触发时，全局前置守卫按照创建顺序调用。守卫是异步解析执行，此时导航在所有守卫 resolve 完之前一直处于等待中。</li><li>若返回 false ，取消当前的导航。如果浏览器的 URL 改变了(可能是用户手动或者浏览器后退按钮)，那么 URL 地址会重置到 from 路由对应的地址。</li><li>若返回一个路由地址，跳转。</li></ol><h3 id="获取参数的js原生方法"><a href="#获取参数的js原生方法" class="headerlink" title="获取参数的js原生方法"></a>获取参数的js原生方法</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>)<br><span class="hljs-keyword">const</span> aaa = params.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;aaa&#x27;</span>) <span class="hljs-comment">// http://***/?aaa=1</span><br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://router.vuejs.org/zh/">Vue Router | Vue.js 的官方路由</a><br><a href="https://blog.csdn.net/lcl130/article/details/122800643">Vue Router 4 的使用</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（20-2）textarea处理</title>
    <link href="/2023/05/06/vue3%E7%AC%94%E8%AE%B0%EF%BC%8820-2%EF%BC%89textarea%E5%B0%81%E8%A3%85/"/>
    <url>/2023/05/06/vue3%E7%AC%94%E8%AE%B0%EF%BC%8820-2%EF%BC%89textarea%E5%B0%81%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<blockquote><p>有一个备注框限制输入200个字符，要求是允许用户输入空格、换行，并且在详情中可以看到空格和换行组成的文字串儿。<br>后端在存储时可以保留空格，但是换行会转译，在textarea中换行是算作一个字符的，这就导致了新建时200个字符，编辑时变成了203个字符，OMG…<br>本篇是对textarea的处理。</p></blockquote><span id="more"></span><h3 id="textarea输入框"><a href="#textarea输入框" class="headerlink" title="textarea输入框"></a>textarea输入框</h3><ol><li>可以通过maxlength限制字数</li><li>可以通过rows控制显示行数，超过将出现滚动条<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span></span><br><span class="hljs-tag">  <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;textarea&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;testForm.remark&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入备注&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:rows</span>=<span class="hljs-string">&quot;4&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">maxlength</span>=<span class="hljs-string">&quot;200&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">show-word-limit</span></span><br><span class="hljs-tag">&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li></ol><p>同时也加入正则校验，保证字数及输入字符满足需求。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> testRules = <span class="hljs-title function_">reactive</span>(&#123;<br> <span class="hljs-attr">remark</span>: [&#123; <span class="hljs-attr">validator</span>: validateText200, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;]<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="换行操作"><a href="#换行操作" class="headerlink" title="换行操作"></a>换行操作</h3><p>在textarea中空格、换行是算作一个字符的，后端在存储时可以保留空格，但是换行会转译，这就导致了新建时200个字符，编辑时变成了203个字符。但是如果我删除了最后一个字符，又变回了199个，说明用户操作会引起组件内部对换行的转译。<br><img src="/../img/vue22-2.png" alt="输入200个字符"><br>这就需要前端在保存时将换行先转成<code>&lt;br/&gt;</code>,在编辑前将<code>&lt;br/&gt;</code>变回换行符。</p><p>这里使用<code>preText</code>作为保存时的转化，使用<code>afterText</code>作为编辑状态下的初始化。  </p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; preText, afterText &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/validate&#x27;</span><br><span class="hljs-comment">// 表格初始化</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">formInit</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> params = route.<span class="hljs-property">query</span><br>  <span class="hljs-keyword">if</span> (params &amp;&amp; params.<span class="hljs-property">detail</span>) &#123;<br>    state.<span class="hljs-property">pageOp</span> = <span class="hljs-number">2</span><br>    <span class="hljs-keyword">let</span> detail = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(params.<span class="hljs-property">detail</span> <span class="hljs-keyword">as</span> string)<br>    detail.<span class="hljs-property">remark</span> = <span class="hljs-title function_">afterText</span>(detail.<span class="hljs-property">remark</span>)<br>  &#125;<br>&#125;<br><span class="hljs-comment">// 提交API</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAdd</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  orderParams.<span class="hljs-property">remark</span> = <span class="hljs-title function_">preText</span>(orderParams.<span class="hljs-property">remark</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>/utils/validate</code>中写转换方法</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">preText</span> = (<span class="hljs-params">pretext: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> pretext.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\r\n/g</span>, <span class="hljs-string">&#x27;&lt;br/&gt;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">&#x27;&lt;br/&gt;&#x27;</span>)<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">afterText</span> = (<span class="hljs-params">pretext: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> pretext.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;br\/&gt;/g</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>详情页中需要使用<code>v-html</code>来保证直接识别<code>&lt;br/&gt;</code>，通过css控制换行。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;remark-break&quot;</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">&quot;item[&#x27;remark&#x27;]&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.remark-break</span> &#123;<br>  <span class="hljs-attribute">word-break</span>: break-all;<br>  <span class="hljs-attribute">white-space</span>: pre-line<br>&#125;<br></code></pre></div></td></tr></table></figure><p>新建、编辑、详情均显示正常<br><img src="/../img/vue22-3.png" alt="新建/编辑状态"><br><img src="/../img/vue22-4.png" alt="详情"></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（20-1）el-input踩坑</title>
    <link href="/2023/05/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%8820-1%EF%BC%89el-input%E8%B8%A9%E5%9D%91/"/>
    <url>/2023/05/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%8820-1%EF%BC%89el-input%E8%B8%A9%E5%9D%91/</url>
    
    <content type="html"><![CDATA[<blockquote><p>一个最基础的输入框居然藏着坑！记录数字输入没有报错bug，内容基于el-form校验 。<br>el-input事件记录。</p></blockquote><span id="more"></span><h3 id="输入框"><a href="#输入框" class="headerlink" title="输入框"></a>输入框</h3><h4 id="文字输入框"><a href="#文字输入框" class="headerlink" title="文字输入框"></a>文字输入框</h4><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;testFormRef&quot;</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">&quot;testForm&quot;</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;testFormRule&quot;</span> <span class="hljs-attr">label-width</span>=<span class="hljs-string">&quot;300px&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;aaa：&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;aaa&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;testForm.aaa&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入aaa&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h4 id="数字输入框"><a href="#数字输入框" class="headerlink" title="数字输入框"></a>数字输入框</h4><ol><li>数字输入框可以通过左右两边的+-实现基于步长的直接增减，方便操作；</li><li>数字输入框可以限制输入最大值和最小值，不在区间范围内的，会自动变成边界值；</li><li>数字输入框可以设置输入数值的精度，精度为0，只能输入整数；<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input-number</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;testForm.bbb&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:precision</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:min</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:max</span>=<span class="hljs-string">&quot;1000&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入bbb&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></div></td></tr></table></figure>数字输入框有一点其他文档里都没有说明，就是有种骚操作（来自测试同学），直接粘贴了小数点.，在设置了精度为0的条件下，这个输入框居然没有报错！<br>我原来以为再加一个正则判断就行，谁知还是绕过了验证…<br><img src="/../img/vue22-1.png" alt="输入小数点"><br>在打印之后，发现小数点在输入框中的值是null，难怪正则验证不出来…</li></ol><h4 id="文字输入框输入数字"><a href="#文字输入框输入数字" class="headerlink" title="文字输入框输入数字"></a>文字输入框输入数字</h4><p>通过v-model.number和正则结合可以控制只输入整数</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> </span><br><span class="hljs-tag">  <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">&quot;tetForm.ccc&quot;</span> </span><br><span class="hljs-tag">  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入ccc&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> testFormRule = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">aaa</span>: [<br>    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;,<br>    &#123; <span class="hljs-attr">validator</span>: validateText50, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>  ],<br>  <span class="hljs-attr">ccc</span>: [<br>    &#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;,<br>    &#123; <span class="hljs-attr">validator</span>: validateNumber, <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>, <span class="hljs-string">&#x27;change&#x27;</span>] &#125;<br>  ]<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">validateNumber</span> = (<span class="hljs-params">rule: any, value: number, callback: <span class="hljs-built_in">Function</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isValidNumber</span>(value)) &#123;<br>    <span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;请输入整数&#x27;</span>))<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_">callback</span>()<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">isValidNumber</span> = (<span class="hljs-params">n: number</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (n) &#123;<br>    <span class="hljs-keyword">const</span> reg1 = <span class="hljs-regexp">/^\d+$/</span><br>    <span class="hljs-keyword">const</span> v1 = reg1.<span class="hljs-title function_">test</span>(n)<br>    <span class="hljs-keyword">return</span> v1<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">validateText50</span> = (<span class="hljs-params">rule: any, value: string, callback: <span class="hljs-built_in">Function</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isValidName50</span>(value)) &#123;<br>    <span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;请输入0-50位中文、字母或数字，支持部分特殊符号&#x27;</span>))<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_">callback</span>()<br>  &#125;<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">isValidName50</span> = (<span class="hljs-params">checkStr: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> str = checkStr ? checkStr : <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-keyword">const</span> reg1 =<br>    <span class="hljs-regexp">/^[0-9\u4e00-\u9fa5a-zA-Z0-9“”&quot;‘’/&#x27;\-()\[\]!！@#$￥%^&amp;*&#123;&#125;&lt;&gt;《》·`。.,，；;：【】:（）]&#123;0,50&#125;$/</span><br>  <span class="hljs-keyword">const</span> v1 = reg1.<span class="hljs-title function_">test</span>(str)<br>  <span class="hljs-keyword">const</span> v2 = str.<span class="hljs-property">length</span> &lt; <span class="hljs-number">51</span><br>  <span class="hljs-keyword">return</span> v1 &amp;&amp; v2<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="输入框事件"><a href="#输入框事件" class="headerlink" title="输入框事件"></a>输入框事件</h3><p>场景描述：</p><ol><li>输入框聚焦时，展示下拉列表更多筛选选择</li><li>输入框 enter 或者点击右侧放大镜图标时，触发搜索事件</li><li>下拉列表高级搜索时，收起自身<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;docFilter.search&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;输入文档名称搜索&quot;</span> @<span class="hljs-attr">focus</span>=<span class="hljs-string">&quot;searchDocText&quot;</span> @<span class="hljs-attr">keyup.enter.native</span>=<span class="hljs-string">&quot;handleSearch&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;inputRef&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">suffix</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;icon-search&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Search</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleSearch&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;showSearch&quot;</span>&gt;</span>这里是下拉列表筛选<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure>这里需要注意，点击时input输入框仍然属于focus状态，不会收起下拉列表，所以需要手动触发一个blur，若没有效果，可使用setTimeout。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">searchDocText</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  showSearch.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-comment">// enter之后搜索</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (!docFilter.<span class="hljs-property">search</span>) &#123;<br>        showSearch.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125; <br>    data.<span class="hljs-property">page</span>.<span class="hljs-property">page</span> = <span class="hljs-number">1</span><br>    <span class="hljs-title function_">refreshDocList</span>()<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        inputRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">blur</span>()<br>        showSearch.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;<br>    &#125;, <span class="hljs-number">0</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（19-3）文件预览</title>
    <link href="/2023/04/21/vue3%E7%AC%94%E8%AE%B0%EF%BC%8819-3%EF%BC%89%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88/"/>
    <url>/2023/04/21/vue3%E7%AC%94%E8%AE%B0%EF%BC%8819-3%EF%BC%89%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88/</url>
    
    <content type="html"><![CDATA[<blockquote><p>经过调研发现，开源库中对docx预览支持较多，doc未找到合适可用的库，包括微软官方js预览插件也仅支持docx。<br>本篇是对预览组件的封装，可支持docx、jpg、png、txt文件预览</p></blockquote><span id="more"></span><h3 id="文件预览组件编写"><a href="#文件预览组件编写" class="headerlink" title="文件预览组件编写"></a>文件预览组件编写</h3><p>这里以弹窗形式展示预览文件，最终效果如下：<br><img src="/../img/vue21-1.png" alt="文件预览"></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;preview-list&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;txtUrl&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:src</span>=<span class="hljs-string">&quot;txtUrl&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">frameborder</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">    &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span></span><br><span class="hljs-tag">      <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;文件预览&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;dialogVisible&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;dialog-file&quot;</span></span><br><span class="hljs-tag">      @<span class="hljs-attr">close</span>=<span class="hljs-string">&quot;handleCancle&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;imgUrl&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;img-prew&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">&quot;imgUrl&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;docxFile&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;docx-wrap&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;docxContainer&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ElMessage</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-plus&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; getFileType, createUrl &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/file&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> docx <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;docx-preview&#x27;</span></span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> props = defineProps&lt;&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">fileObj</span>: <span class="hljs-title class_">Object</span></span><br><span class="language-javascript">&#125;&gt;()</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">imgUrl</span>: <span class="hljs-string">&#x27;&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">txtUrl</span>: <span class="hljs-string">&#x27;&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">docFile</span>: <span class="hljs-literal">false</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">docxFile</span>: <span class="hljs-literal">false</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">docValue</span>: <span class="hljs-literal">null</span></span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> &#123; imgUrl, txtUrl, docxFile &#125; = <span class="hljs-title function_">toRefs</span>(state)</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> dialogVisible = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> fileTypeMap = &#123;</span><br><span class="language-javascript">  <span class="hljs-attr">xls</span>: <span class="hljs-string">&#x27;application/vnd.ms-excel&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">xlsx</span>: <span class="hljs-string">&#x27;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">doc</span>: <span class="hljs-string">&#x27;application/msword&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">docx</span>: <span class="hljs-string">&#x27;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">pdf</span>: <span class="hljs-string">&#x27;application/pdf&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">png</span>: <span class="hljs-string">&#x27;image/png&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">jpeg</span>: <span class="hljs-string">&#x27;image/jpeg&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">jpg</span>: <span class="hljs-string">&#x27;image/jpeg&#x27;</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">txt</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span></span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> docxContainer = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// 查看</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleqaPreviewFileRaw</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> fileRaw = props.<span class="hljs-property">fileObj</span>.<span class="hljs-property">fileRaw</span></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> name = props.<span class="hljs-property">fileObj</span>.<span class="hljs-property">name</span></span><br><span class="language-javascript">  <span class="hljs-keyword">let</span> suffix = <span class="hljs-title function_">getFileType</span>(name)</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> type = fileTypeMap[suffix]</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">if</span> (suffix == <span class="hljs-string">&#x27;pdf&#x27;</span>) &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([fileRaw], &#123; type &#125;)</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">createUrl</span>(blob)</span><br><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(url)</span><br><span class="language-javascript">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (suffix == <span class="hljs-string">&#x27;txt&#x27;</span>) &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([fileRaw], &#123; type &#125;)</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">createUrl</span>(blob)</span><br><span class="language-javascript">    state.<span class="hljs-property">txtUrl</span> = url</span><br><span class="language-javascript">    dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span></span><br><span class="language-javascript">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (suffix == <span class="hljs-string">&#x27;docx&#x27;</span>) &#123;</span><br><span class="language-javascript">    state.<span class="hljs-property">docxFile</span> = <span class="hljs-literal">true</span></span><br><span class="language-javascript">    dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span></span><br><span class="language-javascript">    <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">      docx.<span class="hljs-title function_">renderAsync</span>(fileRaw, docxContainer.<span class="hljs-property">value</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;docx: finished&#x27;</span>, x))</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (suffix == <span class="hljs-string">&#x27;png&#x27;</span> || suffix == <span class="hljs-string">&#x27;jpg&#x27;</span> || suffix == <span class="hljs-string">&#x27;jpeg&#x27;</span>) &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">createUrl</span>(fileRaw)</span><br><span class="language-javascript">    state.<span class="hljs-property">imgUrl</span> = url</span><br><span class="language-javascript">    dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span></span><br><span class="language-javascript">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="language-javascript">    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;本文件暂不支持预览，请直接下载后查看，谢谢！&#x27;</span>)</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePreviewClear</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  state.<span class="hljs-property">docFile</span> = <span class="hljs-literal">false</span></span><br><span class="language-javascript">  state.<span class="hljs-property">docxFile</span> = <span class="hljs-literal">false</span></span><br><span class="language-javascript">  state.<span class="hljs-property">imgUrl</span> = <span class="hljs-string">&#x27;&#x27;</span></span><br><span class="language-javascript">  state.<span class="hljs-property">txtUrl</span> = <span class="hljs-string">&#x27;&#x27;</span></span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCancle</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span></span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">  dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span></span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"><span class="hljs-title function_">defineExpose</span>(&#123; handlePreviewClear, handleqaPreviewFileRaw &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;scss&quot;</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="language-css"></span><br><span class="language-css"><span class="hljs-selector-class">.preview-list</span> &#123;</span><br><span class="language-css">  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;</span><br><span class="language-css">  <span class="hljs-selector-class">.img-prew</span> &#123;</span><br><span class="language-css">    <span class="hljs-attribute">width</span>: <span class="hljs-number">600px</span>;</span><br><span class="language-css">    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;</span><br><span class="language-css">    <span class="hljs-selector-tag">img</span> &#123;</span><br><span class="language-css">      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;</span><br><span class="language-css">    &#125;</span><br><span class="language-css">  &#125;</span><br><span class="language-css">  <span class="hljs-selector-class">.docx-wrap</span> &#123;</span><br><span class="language-css">    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;</span><br><span class="language-css">  &#125;</span><br><span class="language-css">&#125;</span><br><span class="language-css"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="文件预览组件使用"><a href="#文件预览组件使用" class="headerlink" title="文件预览组件使用"></a>文件预览组件使用</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;filebox&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(file, index) in detail[&#x27;attachment_info&#x27;]&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-file-name&quot;</span>&gt;</span>&#123;&#123; file.name &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;one&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fileop&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handlePreview(file, &#x27;tracechip&#x27;)&quot;</span>&gt;</span>查看<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">file-preview</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;fileRef&quot;</span> <span class="hljs-attr">:fileObj</span>=<span class="hljs-string">&quot;fileObj&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">file-preview</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePreview</span> = (<span class="hljs-params">file, name: string</span>) =&gt; &#123;<br>  <span class="hljs-title function_">lookFile</span>(&#123;<br>    <span class="hljs-attr">attachment_uid</span>: file.<span class="hljs-property">uid</span>,<br>    <span class="hljs-attr">bucket_name</span>: name<br>  &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">handleqaPreviewFileRaw</span>(res.<span class="hljs-property">data</span>, file.<span class="hljs-property">name</span>)<br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)<br>    &#125;)<br>&#125;<br><br><span class="hljs-comment">// 查看</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleqaPreviewFileRaw</span> = (<span class="hljs-params">fileRaw, name</span>) =&gt; &#123;<br>  fileRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">handlePreviewClear</span>()<br>  state.<span class="hljs-property">fileObj</span>.<span class="hljs-property">fileRaw</span> = fileRaw<br>  state.<span class="hljs-property">fileObj</span>.<span class="hljs-property">name</span> = name<br>  fileRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">handleqaPreviewFileRaw</span>()<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（19-2）文件上传</title>
    <link href="/2023/04/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%8819-2%EF%BC%89%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    <url>/2023/04/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%8819-2%EF%BC%89%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原来的项目都是直接使用el-upload组件，结果遇到个新项目一个form里面可能需要使用多个el-upload，数据多了以后显得代码臃肿。<br>本篇做一个文件上传抽取处理。</p></blockquote><span id="more"></span><h3 id="文件上传公用方法"><a href="#文件上传公用方法" class="headerlink" title="文件上传公用方法"></a>文件上传公用方法</h3><p><code>file.ts</code>中写一些公用方法</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 获取文件后缀</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getFileType</span> = (<span class="hljs-params">name</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (name) &#123;<br>    <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">&#x27;.&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">return</span> name.<span class="hljs-title function_">slice</span>(name.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">&#x27;.&#x27;</span>) + <span class="hljs-number">1</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> acceptList = [<span class="hljs-string">&#x27;.pdf&#x27;</span>,<span class="hljs-string">&#x27;.doc&#x27;</span>,<span class="hljs-string">&#x27;.docx&#x27;</span>,<span class="hljs-string">&#x27;.jpg&#x27;</span>,<span class="hljs-string">&#x27;.png&#x27;</span>,<span class="hljs-string">&#x27;.xls&#x27;</span>,<span class="hljs-string">&#x27;.xlsx&#x27;</span>]<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> suffixList = [<span class="hljs-string">&#x27;pdf&#x27;</span>, <span class="hljs-string">&#x27;doc&#x27;</span>, <span class="hljs-string">&#x27;docx&#x27;</span>, <span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;xlsx&#x27;</span>, <span class="hljs-string">&#x27;xls&#x27;</span>]<br></code></pre></div></td></tr></table></figure><h3 id="文件上传组件编写"><a href="#文件上传组件编写" class="headerlink" title="文件上传组件编写"></a>文件上传组件编写</h3><p><code>uploadAttachment.vue</code>中将el-upload做一个封装，并把fileList暴露出去，这里获取的attachmentInfo是已经上传成功的文件列表（只有编辑状态下可能出现）。</p><ol><li>设置可上传文件格式，通过组件accept属性判断</li><li>设置单文件不能超过10M，通过组件绑定on-change函数判断；</li><li>设置最大可上传10个文件，通过动态控制组件limit属性和upload按钮判断；</li><li>通过设置<code>auto-upload=&quot;false&quot;</code>可实现手动上传；</li></ol><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-upload</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;upload&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">multiple</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:auto-upload</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-model:file-list</span>=<span class="hljs-string">&quot;fileList&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:on-remove</span>=<span class="hljs-string">&quot;handleFileRemove&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:on-change</span>=<span class="hljs-string">&quot;handleFileChange&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:accept</span>=<span class="hljs-string">&quot;acceptList&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:limit</span>=<span class="hljs-string">&quot;maxNum&quot;</span></span><br><span class="hljs-tag">  &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&quot;Upload&quot;</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">&quot;maxNum - chooseNum == 0&quot;</span>&gt;</span>上传文件<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">tip</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;el-upload__tip&quot;</span>&gt;</span> 支持扩展名：.doc .docx .pdf .jpg .png .xlsx .xls<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-upload</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;props.attachmentInfo &amp;&amp; props.attachmentInfo.length &gt; 0&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;attachmentList&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>已上传文件如下：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(file, idx) in props.attachmentInfo&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;idx&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">&quot;top&quot;</span> <span class="hljs-attr">:content</span>=<span class="hljs-string">&quot;file.name&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;format-file-name2&quot;</span>&gt;</span>&#123;&#123; file.name &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">text</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;danger&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;handleFileDelete(file.id)&quot;</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; acceptList &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/file&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> props = defineProps&lt;&#123;</span><br><span class="language-javascript">  attachmentInfo?: <span class="hljs-title class_">Array</span>&lt;any&gt;</span><br><span class="language-javascript">  refName?: string</span><br><span class="language-javascript">&#125;&gt;()</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> myEmit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">&#x27;handleEmitDel&#x27;</span>])</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> fileList = <span class="hljs-title function_">ref</span>([])</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> disUpload = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// 最多上传10个文件</span></span><br><span class="language-javascript"><span class="hljs-keyword">let</span> maxNum = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> num1 = (props.<span class="hljs-property">attachmentInfo</span> &amp;&amp; props.<span class="hljs-property">attachmentInfo</span>.<span class="hljs-property">length</span>) || <span class="hljs-number">0</span></span><br><span class="language-javascript">  <span class="hljs-keyword">return</span> <span class="hljs-number">10</span> - num1</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// 已选择文件数量</span></span><br><span class="language-javascript"><span class="hljs-keyword">let</span> chooseNum = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> num2 = (fileList.<span class="hljs-property">value</span> &amp;&amp; fileList.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>) || <span class="hljs-number">0</span></span><br><span class="language-javascript">  <span class="hljs-keyword">return</span> num2</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// 已选择文件删除</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileRemove</span> = (<span class="hljs-params">uploadFile, uploadFiles</span>) =&gt; &#123;</span><br><span class="language-javascript">  fileList.<span class="hljs-property">value</span> = <span class="hljs-title function_">toRaw</span>(uploadFiles)</span><br><span class="language-javascript">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;remove   &#x27;</span>, fileList.<span class="hljs-property">value</span>)</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// 已上传文件删除-可自定义组件refName</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileDelete</span> = (<span class="hljs-params">id</span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">refName</span>) &#123;</span><br><span class="language-javascript">    <span class="hljs-title function_">myEmit</span>(<span class="hljs-string">&#x27;handleEmitDel&#x27;</span>, &#123; <span class="hljs-attr">id</span>: id, <span class="hljs-attr">name</span>: props.<span class="hljs-property">refName</span> &#125;)</span><br><span class="language-javascript">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="language-javascript">    <span class="hljs-title function_">myEmit</span>(<span class="hljs-string">&#x27;handleEmitDel&#x27;</span>, id)</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// 文件改变时触发-判断文件大小、判断文件格式</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileChange</span> = (<span class="hljs-params">file, fileList</span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file, fileList)</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> fileType = <span class="hljs-title function_">getFileType</span>(file.<span class="hljs-property">name</span>)</span><br><span class="language-javascript">  <span class="hljs-keyword">if</span> (suffixList.<span class="hljs-title function_">indexOf</span>(fileType) &lt; <span class="hljs-number">0</span>) &#123;</span><br><span class="language-javascript">    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;文件格式不符合要求&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> currIdx = fileList.<span class="hljs-title function_">indexOf</span>(file)</span><br><span class="language-javascript">    fileList.<span class="hljs-title function_">splice</span>(currIdx, <span class="hljs-number">1</span>)</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span></span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> isLt10M = file.<span class="hljs-property">size</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> &lt;= <span class="hljs-number">10</span></span><br><span class="language-javascript">  <span class="hljs-keyword">if</span> (!isLt10M) &#123;</span><br><span class="language-javascript">    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">&#x27;文件大小不能超过10M&#x27;</span>)</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> currIdx = fileList.<span class="hljs-title function_">indexOf</span>(file)</span><br><span class="language-javascript">    fileList.<span class="hljs-title function_">splice</span>(currIdx, <span class="hljs-number">1</span>)</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span></span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;)</span><br><span class="language-javascript"><span class="hljs-title function_">defineExpose</span>(&#123; fileList &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="文件上传组件使用"><a href="#文件上传组件使用" class="headerlink" title="文件上传组件使用"></a>文件上传组件使用</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">upload-attachment</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:attachmentInfo</span>=<span class="hljs-string">&quot;testForm.attachment_info&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;uploadRef&quot;</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">handleEmitDel</span>=<span class="hljs-string">&quot;handleEmitDel&quot;</span></span><br><span class="hljs-tag">&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">upload-attachment</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; fdWithFiles &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/file&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> uploadAttachment <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/File/uploadAttachment.vue&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> emyptForm = &#123;</span><br><span class="language-javascript">  <span class="hljs-attr">attachment_info</span>: []</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">testForm</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(emyptForm)),</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAdd</span> = (<span class="hljs-params">formEl: <span class="hljs-keyword">typeof</span> FormInstance</span>) =&gt; &#123;</span><br><span class="language-javascript">  formEl.<span class="hljs-title function_">validate</span>(<span class="hljs-function">(<span class="hljs-params">valid: boolean</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">if</span> (valid) &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">const</span> params = &#123; ...state.<span class="hljs-property">testForm</span> &#125;</span><br><span class="language-javascript">      <span class="hljs-keyword">const</span> fd = <span class="hljs-title function_">fdWithFiles</span>(uploadRef.<span class="hljs-property">value</span>.<span class="hljs-property">fileList</span>, params)</span><br><span class="language-javascript">      <span class="hljs-comment">// add API，传入fd</span></span><br><span class="language-javascript">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEmitDel</span> = (<span class="hljs-params">params</span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> preFiles = state.<span class="hljs-property">testForm</span>[params.<span class="hljs-property">name</span>]</span><br><span class="language-javascript">  <span class="hljs-keyword">let</span> currentFiles = []</span><br><span class="language-javascript">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;preFiles=&#x27;</span>, preFiles)</span><br><span class="language-javascript">  preFiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">id</span> != params.<span class="hljs-property">id</span>) &#123;</span><br><span class="language-javascript">      currentFiles.<span class="hljs-title function_">push</span>(item)</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript">  state.<span class="hljs-property">testForm</span>[params.<span class="hljs-property">name</span>] = currentFiles</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="文件上传公用方法-交互数据处理"><a href="#文件上传公用方法-交互数据处理" class="headerlink" title="文件上传公用方法-交互数据处理"></a>文件上传公用方法-交互数据处理</h3><p>和后端约定和上传文件有关的接口以formdata形式交互，在<code>/utils/file</code>中抽取数据转换方法。因为formdata可能将空字符串转为null，这里添加一层空值过滤。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 文件files，其他参数params</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fdWithFiles</span> = (<span class="hljs-params">fileList: <span class="hljs-built_in">Array</span>&lt;any&gt;, params: <span class="hljs-built_in">Object</span>, fileName?: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> fd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()<br>  <span class="hljs-keyword">if</span> (fileList.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    fileList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;item.raw=&#x27;</span>, item.<span class="hljs-property">raw</span>)<br>      <span class="hljs-keyword">const</span> name = fileName ? fileName : <span class="hljs-string">&#x27;files&#x27;</span><br>      fd.<span class="hljs-title function_">append</span>(name, item.<span class="hljs-property">raw</span>)<br>    &#125;)<br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> params) &#123;<br>    <span class="hljs-comment">// 参数为数组，数组为空不传</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(params[key])) &#123;<br>      <span class="hljs-keyword">if</span> (params[key].<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) fd.<span class="hljs-title function_">append</span>(key, params[key])<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 参数为对象，对象为空不传</span><br>      <span class="hljs-keyword">if</span> (params[key]) fd.<span class="hljs-title function_">append</span>(key, params[key])<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> fd<br>&#125;<br><br><span class="hljs-comment">// 多组文件+参数 params=[&#123;fileList:[], fileName:&#x27;&#x27;&#125;]</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fdWithMultiFiles</span> = (<span class="hljs-params">filesAll: <span class="hljs-built_in">Array</span>&lt;any&gt;, params: <span class="hljs-built_in">Object</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> fd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()<br>  filesAll.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (i.<span class="hljs-property">fileList</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>      i.<span class="hljs-property">fileList</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> name = i.<span class="hljs-property">fileName</span> ? i.<span class="hljs-property">fileName</span> : <span class="hljs-string">&#x27;files&#x27;</span><br>        fd.<span class="hljs-title function_">append</span>(name, item.<span class="hljs-property">raw</span>)<br>      &#125;)<br>    &#125;<br>  &#125;)<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> params) &#123;<br>    <span class="hljs-comment">// 参数为数组</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(params[key])) &#123;<br>      <span class="hljs-keyword">if</span> (params[key].<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) fd.<span class="hljs-title function_">append</span>(key, params[key])<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (params[key]) fd.<span class="hljs-title function_">append</span>(key, params[key])<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> fd<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="解决上传文件按钮在选取文件按钮禁用后仍可点击问题"><a href="#解决上传文件按钮在选取文件按钮禁用后仍可点击问题" class="headerlink" title="解决上传文件按钮在选取文件按钮禁用后仍可点击问题"></a>解决上传文件按钮在选取文件按钮禁用后仍可点击问题</h3><p>这个问题测试同学提出之前，我是万万没想到…<br>按照要最多可以上传10个文件，我通过maxNum - chooseNum &#x3D;&#x3D; 0来实现判断，问题是按钮已经置灰，但是居然还可以点击，出现文件选择框，虽然选了不会上传，依然影响用户体验。<br>查阅资料后，发现有个slot的改变可以防止这个现象出现，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"> <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">trigger</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!(maxNum - chooseNum == 0)&quot;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&quot;Upload&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:disabled</span>=<span class="hljs-string">&quot;maxNum - chooseNum == 0&quot;</span></span><br><span class="hljs-tag">  &gt;</span>上传文件<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">tip</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">disabled</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;maxNum - chooseNum == 0&quot;</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">&quot;Upload&quot;</span>&gt;</span> 上传文件<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://blog.csdn.net/Oscrazy/article/details/125315916">让element-ui的el-upload组件文件列表中文件图标自定义显示</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（19-1）文件下载</title>
    <link href="/2023/04/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%8819-1%EF%BC%89%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD/"/>
    <url>/2023/04/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%8819-1%EF%BC%89%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[<blockquote><p>文件下载方法很多，开发过程也走了几个坑，特别是部署到测试环境后，出现了本地开发不曾出现过的问题，本篇记录一下各种写法和实际问题解决。</p></blockquote><h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><p>后端读取文件后以流的形式传给我，从前端的角度理解就是Blob形式。<br>打开浏览器调试工具，resonpse需要携带这样的头：<br><img src="/../img/vue13-1.png" alt="response"><br>注意在请求接口里面需要添加一个<code>responseType</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">downloadFile</span>(<span class="hljs-params">url: string, json: object</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">axios</span>(&#123;<br>    url,<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;post&quot;</span>,<br>    <span class="hljs-attr">data</span>: json,<br>    <span class="hljs-attr">responseType</span>: <span class="hljs-string">&quot;blob&quot;</span>,<br>  &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> error);<br>&#125;<br></code></pre></div></td></tr></table></figure><span id="more"></span><h3 id="使用前端直接下载"><a href="#使用前端直接下载" class="headerlink" title="使用前端直接下载"></a>使用前端直接下载</h3><p>在表格row上绑定导出方法，并将数据传入。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Export</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../../utils/export&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExport</span> = (<span class="hljs-params">index, row</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> data = [];<br>  data[<span class="hljs-number">0</span>] = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title function_">toRaw</span>(row)));<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;export&quot;</span>, data);<br>  <span class="hljs-title class_">Export</span>(data, fields, <span class="hljs-string">&quot;导出名字&quot;</span>);<br> &#125;<br></code></pre></div></td></tr></table></figure><p><code>export.ts</code>中提前配置好</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;file-saver&quot;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">XLSX</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;xlsx&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (json, fields, filename = <span class="hljs-string">&quot;测试数据.xlsx&quot;</span>) =&gt; &#123;<br>  json.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">in</span> item) &#123;<br>      <span class="hljs-keyword">if</span> (fields.<span class="hljs-title function_">hasOwnProperty</span>(i)) &#123;<br>        item[fields[i]] = item[i];<br>      &#125;<br>      <span class="hljs-keyword">delete</span> item[i]; <span class="hljs-comment">//删除原先的对象属性</span><br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">const</span> sheetName = filename; <span class="hljs-comment">//excel的文件名称</span><br>  <span class="hljs-keyword">const</span> wb = <span class="hljs-variable constant_">XLSX</span>.<span class="hljs-property">utils</span>.<span class="hljs-title function_">book_new</span>(); <span class="hljs-comment">//工作簿对象包含一SheetNames数组，以及一个表对象映射表名称到表对象。XLSX.utils.book_new实用函数创建一个新的工作簿对象。</span><br>  <span class="hljs-keyword">const</span> ws = <span class="hljs-variable constant_">XLSX</span>.<span class="hljs-property">utils</span>.<span class="hljs-title function_">json_to_sheet</span>(json, &#123; <span class="hljs-attr">header</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(fields) &#125;); <span class="hljs-comment">//将JS对象数组转换为工作表。</span><br>  wb.<span class="hljs-property">SheetNames</span>.<span class="hljs-title function_">push</span>(sheetName);<br>  wb.<span class="hljs-property">Sheets</span>[sheetName] = ws;<br>  <span class="hljs-keyword">const</span> defaultCellStyle = &#123;<br>    <span class="hljs-attr">font</span>: &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Verdana&quot;</span>, <span class="hljs-attr">sz</span>: <span class="hljs-number">13</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">&quot;FF00FF88&quot;</span> &#125;,<br>    <span class="hljs-attr">fill</span>: &#123; <span class="hljs-attr">fgColor</span>: &#123; <span class="hljs-attr">rgb</span>: <span class="hljs-string">&quot;FFFFAA00&quot;</span> &#125; &#125;,<br>  &#125;; <span class="hljs-comment">//设置表格的样式</span><br>  <span class="hljs-keyword">const</span> wopts = &#123;<br>    <span class="hljs-attr">bookType</span>: <span class="hljs-string">&quot;xlsx&quot;</span>,<br>    <span class="hljs-attr">bookSST</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;binary&quot;</span>,<br>    <span class="hljs-attr">cellStyles</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">defaultCellStyle</span>: defaultCellStyle,<br>    <span class="hljs-attr">showGridLines</span>: <span class="hljs-literal">false</span>,<br>  &#125;; <span class="hljs-comment">//写入的样式</span><br>  <span class="hljs-keyword">const</span> wbout = <span class="hljs-variable constant_">XLSX</span>.<span class="hljs-title function_">write</span>(wb, wopts);<br>  <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title function_">s2ab</span>(wbout)], &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;application/octet-stream&quot;</span> &#125;);<br>  fs.<span class="hljs-title function_">saveAs</span>(blob, filename + <span class="hljs-string">&quot;.xlsx&quot;</span>);<br>&#125;;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">s2ab</span> = (<span class="hljs-params">s</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">ArrayBuffer</span> !== <span class="hljs-string">&quot;undefined&quot;</span>) &#123;<br>    <span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(s.<span class="hljs-property">length</span>);<br>    <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buf);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i != s.<span class="hljs-property">length</span>; ++i) view[i] = s.<span class="hljs-title function_">charCodeAt</span>(i) &amp; <span class="hljs-number">0xff</span>;<br>    <span class="hljs-keyword">return</span> buf;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(s.<span class="hljs-property">length</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i != s.<span class="hljs-property">length</span>; ++i) buf[i] = s.<span class="hljs-title function_">charCodeAt</span>(i) &amp; <span class="hljs-number">0xff</span>;<br>    <span class="hljs-keyword">return</span> buf;<br>  &#125;<br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="使用后端接口获取Blob数据下载"><a href="#使用后端接口获取Blob数据下载" class="headerlink" title="使用后端接口获取Blob数据下载"></a>使用后端接口获取Blob数据下载</h3><p>文件使用Blob流表示。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExport</span> = (<span class="hljs-params">index, row</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> ids = [];<br>  ids.<span class="hljs-title function_">push</span>(row.<span class="hljs-property">id</span>);<br>  <span class="hljs-title function_">exportBatchStandard</span>(&#123; <span class="hljs-attr">ids</span>: ids &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">fileDownloadFun</span>(res);<br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;导出错误！&quot;</span>);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)<br>    &#125;);<br>&#125;;<br></code></pre></div></td></tr></table></figure><p><code>index.ts</code>中两种下载方式<br>方法一：使用<code>fileDownload</code>库</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 下载文件</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fileDownloadFun</span> = (<span class="hljs-params">res: any, name?: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (name) &#123;<br>    <span class="hljs-title function_">fileDownload</span>(res.<span class="hljs-property">data</span>, name)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">let</span> fileName = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">let</span> contentDisposition = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;content-disposition&#x27;</span>]) contentDisposition = res.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;content-disposition&#x27;</span>]<br>    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Content-Disposition&#x27;</span>]) contentDisposition = res.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Content-Disposition&#x27;</span>]<br>    <span class="hljs-keyword">const</span> result = contentDisposition.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;filename*=utf-8&#x27;&#x27;&quot;</span>)[<span class="hljs-number">1</span>]<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;result=&#x27;</span>, result)<br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">undefined</span>) &#123;<br>      <span class="hljs-comment">// fileName = &#x27;导出文件.xlsx&#x27;</span><br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;下载文件失败&#x27;</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      fileName = <span class="hljs-built_in">decodeURIComponent</span>(result)<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;download=&#x27;</span>, res.<span class="hljs-property">data</span>, <span class="hljs-string">&#x27;file=&#x27;</span>, fileName)<br>      <span class="hljs-title function_">fileDownload</span>(res.<span class="hljs-property">data</span>, fileName)<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>方法二：使用<a>标签</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">download</span> = (<span class="hljs-params">res: any, name?: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> data = res.<span class="hljs-property">data</span>;<br>  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">data</span>) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-comment">// 设置下载文件名称，使用正则取出名称</span><br>  <span class="hljs-keyword">const</span> pat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&quot;(?&lt;=filename=).*&quot;</span>);<br>  <span class="hljs-keyword">let</span> contentDisposition = <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-comment">//浏览器问题可能会出现 content-disposition 匹配不到</span><br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;content-disposition&quot;</span>])<br>    contentDisposition = res.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;content-disposition&quot;</span>];<br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;Content-Disposition&quot;</span>])<br>    contentDisposition = res.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;Content-Disposition&quot;</span>];<br>  <span class="hljs-keyword">const</span> result = pat.<span class="hljs-title function_">exec</span>(contentDisposition);<br>  <span class="hljs-keyword">let</span> fileName = result &amp;&amp; result[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">if</span> (fileName == <span class="hljs-literal">undefined</span>) &#123;<br>    fileName = name;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    fileName = <span class="hljs-built_in">decodeURIComponent</span>(fileName);<br>  &#125;<br>  <span class="hljs-keyword">const</span> url = <span class="hljs-variable language_">window</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">createObjectURL</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([data]));<br>  <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&quot;a&quot;</span>);<br>  link.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">&quot;none&quot;</span>;<br>  link.<span class="hljs-property">href</span> = url;<br>  link.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;download&quot;</span>, fileName);<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(link);<br>  link.<span class="hljs-title function_">click</span>();<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>注意：</p><ol><li>一定要让后端添加暴露header的字段，不然前端可能获取不到<code>content-disposition</code>（本地环境代理没问题，提交到线上环境出现了问题）</li><li>约定好formdata格式，前端可能需要添加hearder（根据框架封装程度而定）<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">response.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="hljs-string">&quot;Content-Disposition&quot;</span>)<br>response.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, ...)<br></code></pre></div></td></tr></table></figure></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（18-2）vite 首次打开界面加载慢问题</title>
    <link href="/2023/03/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8818-2%EF%BC%89vite%E9%A6%96%E6%AC%A1%E6%89%93%E5%BC%80%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD%E6%85%A2%E9%97%AE%E9%A2%98/"/>
    <url>/2023/03/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8818-2%EF%BC%89vite%E9%A6%96%E6%AC%A1%E6%89%93%E5%BC%80%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD%E6%85%A2%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<blockquote><p>项目改用 vite 之后，启动确实特别快，但是首次打开界面加载慢的我想去刷一会儿微博（开玩笑）…<br>本篇记录我在熟悉项目之后对项目构建做的一些优化尝试。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>vite 开发环境下，模块以原生 ESModule 的形式（es6原生的模块加载机制）被浏览器加载；</li><li>vite 没有对代码进行打包压缩处理，所以服务启动很快；下载的文件是没有被处理过的源码，所以要比 webpack 处理过的文件大很多；</li><li>项目启动后浏览器第一次加载才会慢；慢的主要原因是 vite 需要动态的解析依赖，并打包，引入；</li></ol><h3 id="浏览器调试工具-waterfall"><a href="#浏览器调试工具-waterfall" class="headerlink" title="浏览器调试工具 waterfall"></a>浏览器调试工具 waterfall</h3><p>waterfall 性能检测详解详解:<br>Queueing：排队<br>Stalled：阻塞。请求访问该URL的主机是有并发和连接数限制，必须要等之前的执行完成才能执行之后的，stalled 代表这段时间的耗时<br>DNS Lookup：域名解析所耗时间<br>Initial connection：初始化连接时间。这里一般是 TCP 3次连接握手时间<br>SSL：https 特有，是一种协议<br>Request sent：发送请求所消耗的时间<br>Waiting：等待响应时间（这里一般是最耗时的）<br>Content Download：下载内容所需要消耗的时间</p><h3 id="vite-首次加载慢的原因"><a href="#vite-首次加载慢的原因" class="headerlink" title="vite 首次加载慢的原因"></a>vite 首次加载慢的原因</h3><p>在查看 waterfall 之后，发现首次加载中 Waiting 阶段时间耗费较长，等待响应时间就是 vite 在编译的时间。</p><h3 id="解决方案一（未成功）"><a href="#解决方案一（未成功）" class="headerlink" title="解决方案一（未成功）"></a>解决方案一（未成功）</h3><p>这个方案是网上查阅资料后基本统一的解决方法，但是尝试后发现在 vite4 中并不适用，特别是推荐的安装的两个包，安装也没有成功，所以方案一仅仅是做一个记录。<br>在<code>vite.config.ts</code>中添加配置</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>   <span class="hljs-attr">optimizeDeps</span>: &#123;<br>      <span class="hljs-attr">include</span>: [<br>        <span class="hljs-string">&#x27;vue&#x27;</span>,<br>        <span class="hljs-string">&#x27;map-factory&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/form/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/radio-group/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/radio/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/checkbox/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/checkbox-group/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/switch/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/time-picker/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/date-picker/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/col/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/form-item/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/alert/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/breadcrumb/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/select/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/input/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/breadcrumb-item/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/tag/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/pagination/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/table/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/table-column/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/card/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/row/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/button/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/menu/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/sub-menu/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/menu-item/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/option/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;@element-plus/icons-vue&#x27;</span>,<br>        <span class="hljs-string">&#x27;pinia&#x27;</span>,<br>        <span class="hljs-string">&#x27;axios&#x27;</span>,<br>        <span class="hljs-string">&#x27;vue-request&#x27;</span>,<br>        <span class="hljs-string">&#x27;vue-router&#x27;</span>,<br>        <span class="hljs-string">&#x27;@vueuse/core&#x27;</span>,<br>      ],<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>使用插件来进行上面一段的插入</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm i -D vite-plugin-optimize-persist vite-plugin-package-config<br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue18-1.png" alt="包引入失败"><br>git主页有这句话 <code>You no longer need this plugin since Vite 2.9.1</code><br>按照提示加了 <code>--legacy</code> 强制装上了，然后手动删除了 node_modules&#x2F;.vite 文件夹，重新运行代码，速度略微提高。可能还有其他原因，或者是我自己的配置问题，在以后实验后继续更新。</p><h3 id="解决方案二（待调研…）"><a href="#解决方案二（待调研…）" class="headerlink" title="解决方案二（待调研…）"></a>解决方案二（待调研…）</h3><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><p>“no such file or directory, rename ‘&#x2F;node_modules&#x2F;.vite&#x2F;deps_temp’ -&gt; ‘&#x2F;node_modules&#x2F;.vite&#x2F;deps’”<br>升级vite</p><p><code>附录</code><br><a href="https://cn.vitejs.dev/guide/">Vite官方文档</a><br><a href="https://blog.csdn.net/pzy_666/article/details/123017630">vite首次打开界面加载慢问题&#x2F;解决</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（18-2）vite首次打开界面加载慢问题</title>
    <link href="/2023/03/18/vue3%E7%AC%94%E8%AE%B0%EF%BC%8818%EF%BC%89vite%E9%A6%96%E6%AC%A1%E6%89%93%E5%BC%80%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD%E6%85%A2%E9%97%AE%E9%A2%98/"/>
    <url>/2023/03/18/vue3%E7%AC%94%E8%AE%B0%EF%BC%8818%EF%BC%89vite%E9%A6%96%E6%AC%A1%E6%89%93%E5%BC%80%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD%E6%85%A2%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<blockquote><p>项目改用vite之后，启动确实特别快，但是首次打开界面加载慢的我想去刷一会儿微博（开玩笑）…<br>本篇记录我在熟悉项目之后对项目构建做的一些优化尝试。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>vite开发环境下，模块以原生 ESModule 的形式（es6原生的模块加载机制）被浏览器加载；</li><li>vite没有对代码进行打包压缩处理，所以服务启动很快；下载的文件是没有被处理过的源码，所以要比webpack处理过的文件大很多；</li><li>项目启动后浏览器第一次加载才会慢；慢的主要原因是vite需要动态的解析依赖，并打包，引入；</li></ol><h3 id="浏览器调试工具waterfall"><a href="#浏览器调试工具waterfall" class="headerlink" title="浏览器调试工具waterfall"></a>浏览器调试工具waterfall</h3><p>waterfall性能检测详解详解:<br>Queueing：排队<br>Stalled：阻塞。请求访问该URL的主机是有并发和连接数限制，必须要等之前的执行完成才能执行之后的，stalled代表这段时间的耗时<br>DNS Lookup:域名解析所耗时间<br>Initial connection:初始化连接时间。这里一般是TCP 3次连接握手时间<br>SSL：https特有，是一种协议<br>Request sent：发送请求所消耗的时间<br>Waiting：等待响应时间（这里一般是最耗时的）<br>Content Download：下载内容所需要消耗的时间</p><h3 id="vite首次加载慢的原因"><a href="#vite首次加载慢的原因" class="headerlink" title="vite首次加载慢的原因"></a>vite首次加载慢的原因</h3><p>在查看waterfall之后，发现首次加载中Waiting阶段时间耗费较长，等待响应时间就是vite在编译的时间。</p><h3 id="解决方案一（未成功）"><a href="#解决方案一（未成功）" class="headerlink" title="解决方案一（未成功）"></a>解决方案一（未成功）</h3><p>这个方案是网上查阅资料后基本统一的解决方法，但是尝试后发现在vite4中并不适用，特别是推荐的安装的两个包，安装也没有成功，所以方案一仅仅是做一个记录。<br>在<code>vite.config.ts</code>中添加配置</p><figure class="highlight javascript"><table><tr><td class="gutter hljs hljs hljs hljs hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&#123;<br>   <span class="hljs-attr">optimizeDeps</span>: &#123;<br>      <span class="hljs-attr">include</span>: [<br>        <span class="hljs-string">&#x27;vue&#x27;</span>,<br>        <span class="hljs-string">&#x27;map-factory&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/form/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/radio-group/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/radio/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/checkbox/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/checkbox-group/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/switch/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/time-picker/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/date-picker/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/col/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/form-item/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/alert/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/breadcrumb/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/select/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/input/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/breadcrumb-item/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/tag/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/pagination/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/table/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/table-column/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/card/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/row/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/button/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/menu/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/sub-menu/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/menu-item/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;element-plus/es/components/option/style/index&#x27;</span>,<br>        <span class="hljs-string">&#x27;@element-plus/icons-vue&#x27;</span>,<br>        <span class="hljs-string">&#x27;pinia&#x27;</span>,<br>        <span class="hljs-string">&#x27;axios&#x27;</span>,<br>        <span class="hljs-string">&#x27;vue-request&#x27;</span>,<br>        <span class="hljs-string">&#x27;vue-router&#x27;</span>,<br>        <span class="hljs-string">&#x27;@vueuse/core&#x27;</span>,<br>      ],<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>使用插件来进行上面一段的插入</p><figure class="highlight shell"><table><tr><td class="gutter hljs hljs hljs hljs hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm i -D vite-plugin-optimize-persist vite-plugin-package-config<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://cn.vitejs.dev/guide/">Vite官方文档</a><br><a href="https://blog.csdn.net/pzy_666/article/details/123017630">vite首次打开界面加载慢问题&#x2F;解决</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（18-1）使用vite进行前端构建</title>
    <link href="/2023/03/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%8818-1%EF%BC%89%E4%BD%BF%E7%94%A8vite%E8%BF%9B%E8%A1%8C%E5%89%8D%E7%AB%AF%E6%9E%84%E5%BB%BA/"/>
    <url>/2023/03/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%8818-1%EF%BC%89%E4%BD%BF%E7%94%A8vite%E8%BF%9B%E8%A1%8C%E5%89%8D%E7%AB%AF%E6%9E%84%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>之前的项目大多使用vue-cli搭建，感觉打包时间略长，随着项目体积增大，协作人数增加，尝试使用vite重新进行构建，并建立前端规范。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>开箱即用，API高度可扩展性</li><li>MHR速度快</li><li>一套构建指令，使用Rollup打包代码，预配置，输出高度优化的静态资源</li></ol><h3 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h3><p>使用vite创建项目，并根据需求选择相应配置：</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm create vite@latest<br></code></pre></div></td></tr></table></figure><h3 id="实践中已使用的配置"><a href="#实践中已使用的配置" class="headerlink" title="实践中已使用的配置"></a>实践中已使用的配置</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite&#x27;</span><br><span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@vitejs/plugin-vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">VueJsx</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@vitejs/plugin-vue-jsx&#x27;</span><br><span class="hljs-keyword">import</span> &#123; resolve &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">EslintPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite-plugin-eslint&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unplugin-auto-import/vite&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">DefineOptions</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unplugin-vue-define-options/vite&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unplugin-vue-components/vite&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ElementPlusResolver</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unplugin-vue-components/resolvers&#x27;</span><br><span class="hljs-keyword">import</span> &#123; createStyleImportPlugin, <span class="hljs-title class_">ElementPlusResolve</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite-plugin-style-import&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-title function_">vue</span>(),<br>    <span class="hljs-title class_">VueJsx</span>(),<br>    <span class="hljs-title class_">Components</span>(&#123;<br>      <span class="hljs-comment">// 要搜索组件的目录的相对路径</span><br>      <span class="hljs-attr">dirs</span>: [<span class="hljs-string">&#x27;src/components&#x27;</span>],<br>      <span class="hljs-attr">extensions</span>: [<span class="hljs-string">&#x27;vue&#x27;</span>],<br>      <span class="hljs-comment">// 搜索子目录</span><br>      <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-comment">// 生成自定义 `auto-components.d.ts` 全局声明</span><br>      <span class="hljs-attr">dts</span>: <span class="hljs-string">&#x27;src/types/auto-components.d.ts&#x27;</span>,<br>      <span class="hljs-attr">include</span>: [<span class="hljs-regexp">/\.[tj]sx?$/</span>,  <span class="hljs-regexp">/\.vue$/</span>, <span class="hljs-regexp">/\.vue\?vue/</span>],<br>      <span class="hljs-comment">// 自定义组件的解析器</span><br>      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()],<br>      <span class="hljs-attr">exclude</span>: [<span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>]<br>    &#125;),<br>    <span class="hljs-title class_">AutoImport</span>(&#123;<br>      <span class="hljs-comment">// 生成自定义 `auto-components.d.ts` 全局声明</span><br>      <span class="hljs-attr">dts</span>: <span class="hljs-string">&#x27;src/types/auto-imports.d.ts&#x27;</span>,<br>      <span class="hljs-attr">include</span>: [<span class="hljs-regexp">/\.[tj]sx?$/</span>, <span class="hljs-regexp">/\.vue$/</span>],<br>      <span class="hljs-comment">// 自动引入的api从这里找</span><br>      <span class="hljs-attr">imports</span>: [<span class="hljs-string">&#x27;vue&#x27;</span>, <span class="hljs-string">&#x27;vue-router&#x27;</span>],<br>      <span class="hljs-attr">resolvers</span>: [<br>        <span class="hljs-title class_">ElementPlusResolver</span>() <span class="hljs-comment">// 自动导入Element-Plus的Api</span><br>      ],<br>      <span class="hljs-attr">eslintrc</span>: &#123;<br>        <span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">filepath</span>: <span class="hljs-string">&#x27;./.eslintrc-auto-import.json&#x27;</span>,<br>        <span class="hljs-attr">globalsPropValue</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// Default `true`, (true | false | &#x27;readonly&#x27; | &#x27;readable&#x27; | &#x27;writable&#x27; | &#x27;writeable&#x27;)</span><br>      &#125;<br>    &#125;),<br>    <span class="hljs-title function_">createStyleImportPlugin</span>(&#123;<br>      <span class="hljs-attr">resolves</span>: [<span class="hljs-title class_">ElementPlusResolve</span>()],<br>      <span class="hljs-attr">libs</span>: [&#123;<br>        <span class="hljs-attr">libraryName</span>: <span class="hljs-string">&#x27;element-plus&#x27;</span>,<br>        <span class="hljs-attr">esModule</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">resolveStyle</span>: <span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-string">`element-plus/es/components/<span class="hljs-subst">$&#123;name.substring(<span class="hljs-number">3</span>)&#125;</span>/style/css`</span><br>        &#125;<br>      &#125;]<br>    &#125;),<br>    <span class="hljs-title class_">EslintPlugin</span>(&#123;<br>      <span class="hljs-attr">cache</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">include</span>: [<span class="hljs-string">&#x27;src/**/*.vue&#x27;</span>, <span class="hljs-string">&#x27;src/**/*.ts&#x27;</span>, <span class="hljs-string">&#x27;src/**/*.tsx&#x27;</span>] <span class="hljs-comment">// 检查的文件</span><br>    &#125;),<br>    <span class="hljs-title class_">DefineOptions</span>()<br>  ],<br>  <span class="hljs-attr">css</span>: &#123;<br>    <span class="hljs-attr">preprocessorOptions</span>: &#123;<br>        <span class="hljs-attr">scss</span>: &#123;<br>            <span class="hljs-attr">additionalData</span>: <span class="hljs-string">`@use &quot;@/assets/scss/index.scss&quot;;`</span><br>        &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">alias</span>: &#123;<br>      <span class="hljs-string">&#x27;@&#x27;</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;./src&#x27;</span>)<br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">build</span>: &#123;<br>    <span class="hljs-attr">minify</span>: <span class="hljs-string">&#x27;terser&#x27;</span>,<br>    <span class="hljs-attr">outDir</span>: <span class="hljs-string">&#x27;dist&#x27;</span>,<br>    <span class="hljs-attr">sourcemap</span>: <span class="hljs-string">&#x27;inline&#x27;</span>,<br>    <span class="hljs-attr">terserOptions</span>: &#123;<br>      <span class="hljs-attr">compress</span>: &#123;<br>        <span class="hljs-attr">drop_debugger</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">false</span><br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">server</span>: &#123;<br>    <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;localhost&#x27;</span>,<br>    <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>,<br>    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//配置浏览器自动访问</span><br>    <span class="hljs-attr">headers</span>: &#123;<br>      <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="hljs-string">&#x27;*&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">proxy</span>: &#123;<br>      <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>        <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://&#x27;</span>,<br>        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/api/</span>, <span class="hljs-string">&#x27;api&#x27;</span>)<br>      &#125;<br>    &#125;,<br>    <span class="hljs-attr">hmr</span>: <span class="hljs-literal">true</span>,<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://cn.vitejs.dev/guide/">Vite官方文档</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（17-2）el-select组件封装</title>
    <link href="/2023/03/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8817-2%EF%BC%89el-select%E7%BB%84%E4%BB%B6%E5%B0%81%E8%A3%85/"/>
    <url>/2023/03/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8817-2%EF%BC%89el-select%E7%BB%84%E4%BB%B6%E5%B0%81%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇接上一篇，将el-select封装成组件</p></blockquote><span id="more"></span><h3 id="子组件"><a href="#子组件" class="headerlink" title="子组件"></a>子组件</h3><p>使用 filter-method 进行前端本地搜索</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;selectedArr&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">multiple</span></span><br><span class="hljs-tag">    <span class="hljs-attr">filterable</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:filter-method</span>=<span class="hljs-string">&quot;dataFilter&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">default-first-option</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:placeholder</span>=<span class="hljs-string">&quot;text&quot;</span></span><br><span class="hljs-tag">  &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in optionList&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;item.id&quot;</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;item.name&quot;</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">&quot;item.name&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span><br><span class="hljs-tag">      <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;query.p * query.pageSize &lt; optionTotal &amp;&amp; showLoadMore&quot;</span></span><br><span class="hljs-tag">      @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;loadmore&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;load-more&quot;</span></span><br><span class="hljs-tag">    &gt;</span><br>      点击加载更多<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>text 表示输入框默认提示；optionAll 代表列表所有可选项，为了和业务解耦，从父组件中获取；optionTotal表示所有可选项的数量，如果父组件直接从接口获取到值，则直接传递给子组件。<br>这里要注意的是：</p><ol><li>vue3 setup 使用 defineEmits 语法糖，需要先注册再引用；</li><li>v-model是一个语法糖，等于:value+@input，所以这里使用 emit(‘input’) 来实现数据双向绑定；<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> props = defineProps&lt;&#123;<br>  <span class="hljs-attr">text</span>: string<br>  <span class="hljs-attr">optionAll</span>: <span class="hljs-title class_">Array</span>&lt;any&gt;<br>  optionTotal?: number<br>&#125;&gt;()<br><br><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;<br>  <span class="hljs-attr">optionList</span>: [],<br>  <span class="hljs-attr">showLoadMore</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">selectedArr</span>: [],<br>  <span class="hljs-attr">query</span>: &#123; <span class="hljs-attr">p</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> &#125;<br>&#125;)<br><span class="hljs-keyword">const</span> &#123; optionList, showLoadMore, selectedArr, query &#125; = <span class="hljs-title function_">toRefs</span>(state)<br><br><span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">&#x27;input&#x27;</span>])<br><span class="hljs-title function_">watch</span>(state.<span class="hljs-property">selectedArr</span>, <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;input&#x27;</span>, val)<br>&#125;)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadmore</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  state.<span class="hljs-property">query</span>.<span class="hljs-property">p</span>++<br>  <span class="hljs-title function_">getItems</span>() <span class="hljs-comment">//类似于分页查询</span><br>&#125;<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">getItems</span>(<span class="hljs-number">1</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">dataFilter</span> = (<span class="hljs-params">val</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (val) &#123;<br>    state.<span class="hljs-property">optionList</span> = props.<span class="hljs-property">optionAll</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (item &amp;&amp; !!~item.<span class="hljs-property">name</span>.<span class="hljs-title function_">indexOf</span>(val)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>      &#125;<br>    &#125;)<br>    showLoadMore.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_">getItems</span>(<span class="hljs-number">1</span>)<br>    showLoadMore.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getItems</span> = (<span class="hljs-params">flag?: number</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (flag) &#123;<br>    state.<span class="hljs-property">query</span>.<span class="hljs-property">p</span> = flag<br>  &#125;<br>  <span class="hljs-keyword">let</span> num = ~~state.<span class="hljs-property">query</span>.<span class="hljs-property">p</span> * ~~state.<span class="hljs-property">query</span>.<span class="hljs-property">pageSize</span><br>  state.<span class="hljs-property">optionList</span> = props.<span class="hljs-property">optionAll</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item, index, arr</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (item) &#123;<br>      <span class="hljs-keyword">return</span> index &lt; num<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="父组件调用"><a href="#父组件调用" class="headerlink" title="父组件调用"></a>父组件调用</h3></li></ol><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">tree-select</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;roleForm.users&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">text</span>=<span class="hljs-string">&quot;请选择包含的用户&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:optionAll</span>=<span class="hljs-string">&quot;userListAll&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:optionTotal</span>=<span class="hljs-string">&quot;userTotal&quot;</span></span><br><span class="hljs-tag">&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tree-select</span>&gt;</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（17-1）el-select搜索</title>
    <link href="/2023/03/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8817-1%EF%BC%89el-select%E6%90%9C%E7%B4%A2/"/>
    <url>/2023/03/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8817-1%EF%BC%89el-select%E6%90%9C%E7%B4%A2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录el-select一般搜索和远程搜索。</p></blockquote><span id="more"></span><h3 id="搜索基础用法"><a href="#搜索基础用法" class="headerlink" title="搜索基础用法"></a>搜索基础用法</h3><p>添加 <code>filterable</code> 关键字即可实现过滤（也可理解为组件自带的本地搜索），注意：只有添加了该关键词才能输入。<code>multiple</code> 用于实现多选，这里要注意的是加了<code>multiple</code> 之后，v-model 初始化必须是[]，若使用 ‘’ 空字符串，在有弹窗的情况下，则会出现弹窗打开就执行了检验，出现了红色错误提示。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-select</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;roleForm.users&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">multiple</span></span><br><span class="hljs-tag">    <span class="hljs-attr">filterable</span></span><br><span class="hljs-tag">  &gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in userList&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;item.id&quot;</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;item.name&quot;</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">&quot;item.id&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="远程搜索"><a href="#远程搜索" class="headerlink" title="远程搜索"></a>远程搜索</h3><p>远程搜索添加<code>remote</code>关键字，使用<code>remote-method</code>添加搜索方法，默认传参为输入值，通过输入值进行搜索。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-select</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;roleForm.users&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">multiple</span></span><br><span class="hljs-tag">  <span class="hljs-attr">filterable</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:loading</span>=<span class="hljs-string">&quot;loading&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">remote</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:remote-method</span>=<span class="hljs-string">&quot;remoteMethod&quot;</span></span><br><span class="hljs-tag">&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getDataUser</span> = (<span class="hljs-params">data?: any</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> params = data || &#123;&#125;<br>  <span class="hljs-title function_">getUsers</span>(params)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> &#123; data, data2, status, msg &#125; = res<br>      <span class="hljs-keyword">if</span> (status == <span class="hljs-string">&#x27;ok&#x27;</span>) &#123;<br>        state.<span class="hljs-property">userList</span> = data<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg)<br>      &#125;<br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)<br>    &#125;)<br>&#125;<br><br><span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">remoteMethod</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">query: string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (query) &#123;<br>    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDataUser</span>(&#123; <span class="hljs-attr">name</span>: query, <span class="hljs-attr">p</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> &#125;)<br>    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDataUser</span>(&#123; <span class="hljs-attr">p</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span> &#125;)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="远程获取所有数据，前端实现本地搜索"><a href="#远程获取所有数据，前端实现本地搜索" class="headerlink" title="远程获取所有数据，前端实现本地搜索"></a>远程获取所有数据，前端实现本地搜索</h3><p><code>default-first-option</code> 属性表示在输入框按下回车，选择第一个匹配项，配合 filterable 使用；<code>filter-method</code> 用户过滤方法。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-select</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;roleForm.users&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">multiple</span></span><br><span class="hljs-tag">    <span class="hljs-attr">filterable</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:filter-method</span>=<span class="hljs-string">&quot;dataFilter&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">default-first-option</span></span><br><span class="hljs-tag">  &gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in userList&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;item.id&quot;</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;item.name&quot;</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">&quot;item.id&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 初始化时state.userListAll存储所有用户信息</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">dataFilter</span> = (<span class="hljs-params">val</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (val) &#123; <span class="hljs-comment">// 搜索框有值，本地过滤所有name含有相同字符的选项</span><br>    state.<span class="hljs-property">userList</span> = state.<span class="hljs-property">userListAll</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (item &amp;&amp; !!~item.<span class="hljs-property">name</span>.<span class="hljs-title function_">indexOf</span>(val)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>      &#125;<br>    &#125;)<br>  &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 搜索框为空，默认获取列表前十个选项</span><br>    <span class="hljs-title function_">getItems</span>(<span class="hljs-number">1</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getItems</span> = (<span class="hljs-params">flag?: number</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (flag) &#123;<br>    dataList.<span class="hljs-property">user</span>.<span class="hljs-property">p</span> = flag<br>  &#125;<br>  <span class="hljs-keyword">let</span> num = ~~dataList.<span class="hljs-property">user</span>.<span class="hljs-property">p</span> * ~~dataList.<span class="hljs-property">user</span>.<span class="hljs-property">pageSize</span><br>  state.<span class="hljs-property">userList</span> = state.<span class="hljs-property">userListAll</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item, index, arr</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (item) &#123;<br>      <span class="hljs-keyword">return</span> index &lt; num<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h3><p>如果初始化数据过多，可能会造成页面卡顿，这里尝试懒加载</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-select</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;roleForm.users&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">multiple</span></span><br><span class="hljs-tag">  <span class="hljs-attr">filterable</span></span><br><span class="hljs-tag">  <span class="hljs-attr">v-loadmore</span>=<span class="hljs-string">&quot;loadmore&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in userList&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;item.id&quot;</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;item.name&quot;</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">&quot;item.id&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> vLoadmore = &#123;<br>  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SELECTWRAP_DOM</span> = el.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.el-select-dropdown .el-select-dropdown__wrap&#x27;</span>)<br>    <span class="hljs-variable constant_">SELECTWRAP_DOM</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">const</span> condition = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollHeight</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollTop</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientHeight</span><br>      <span class="hljs-keyword">if</span> (condition) &#123;<br>        binding.<span class="hljs-title function_">value</span>()<br>      &#125;<br>    &#125;)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadmore</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  dataList.<span class="hljs-property">user</span>.<span class="hljs-property">p</span>++<br>  <span class="hljs-title function_">getItems</span>() <span class="hljs-comment">//类似于分页查询</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>运行时控制台报错了！<br><img src="/../img/vue17-3.png" alt="loadmore error"><br>经过检查，发现是没有找到DOM，猜测方法执行时DOM渲染还没有完成。<br>因为这个组件是在 dialog 中初始化，猜测可能是 v-if 导致，先尝试将组件移除 dialog 来测试，结果还是报错。。。<br>再尝试在组件 <code>onMounted</code> 时给 <code>loadmore</code> 赋值，想法完全错误！指令不能这么写，必须写一个全局常量。自定义指令自身的 <code>mounted</code> 已经代表了在挂载的组件渲染完成之后执行。<br>接着打印 el 的值，发现 el-select 节点中没有 el-select-dropdown …查阅很多资料，大家好像都没遇到这个问题？？？</p><h3 id="点击加载更多"><a href="#点击加载更多" class="headerlink" title="点击加载更多"></a>点击加载更多</h3><p>没办法，手写一个点击加载更多！放在 el-option 下方：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in userList&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;item.id&quot;</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;item.name&quot;</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">&quot;item.id&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;user.p * user.pageSize &lt; userTotal&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;loadmore&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;load-more&quot;</span>&gt;</span><br>  点击加载更多<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><img src="/../img/vue17-4.png" alt="点击加载更多"></p><h3 id="防抖节流"><a href="#防抖节流" class="headerlink" title="防抖节流"></a>防抖节流</h3><p>防抖: n 秒后在执行该事件，若在 n 秒内被重复触发，则重新计时<br>节流: n 秒内只运行一次，若在 n 秒内重复触发，只有一次生效</p><p>防抖debounce在连续的事件，只需触发一次回调的场景有：</p><ol><li>搜索框搜索输入。只需用户最后一次输入完，再发送请求</li><li>手机号、邮箱验证输入检测</li><li>窗口大小resize。只需窗口调整完成后，计算窗口大小。防止重复渲染。</li></ol><p>节流throttle在间隔一段时间执行一次回调的场景有：</p><ol><li>滚动加载，加载更多或滚到底部监听</li><li>搜索框，搜索联想功能</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（16）axios定制化</title>
    <link href="/2023/03/09/vue3%E7%AC%94%E8%AE%B0%EF%BC%8816%EF%BC%89axios%E5%AE%9A%E5%88%B6%E5%8C%96/"/>
    <url>/2023/03/09/vue3%E7%AC%94%E8%AE%B0%EF%BC%8816%EF%BC%89axios%E5%AE%9A%E5%88%B6%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<blockquote><p>后端使用GO的JNS框架，关于请求参数的错误码code归结到400，在code同一层级使用reason标注错误原因。前端框架中使用了axios库，联调中发现后端定义的400错误reason前端捕捉不到。<br>这篇记录前后端交互出现的问题。</p></blockquote><span id="more"></span><h3 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h3><p>请求成功返回200，如下格式都没有异议。</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">&#123; <br>  code: 200,<br>  data: &#123;<br>    data: &#123;data: Array(7), page: 1, total: 7&#125;<br>    msg: &quot;success&quot;<br>    status: 200<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>问题在于请求失败，失败的原因在于何处，是否涉及到业务错误？</p><h3 id="状态码定义"><a href="#状态码定义" class="headerlink" title="状态码定义"></a>状态码定义</h3><figure class="highlight basic"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs basic"><span class="hljs-symbol">200 </span>OK - [<span class="hljs-keyword">GET</span>]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。<br><span class="hljs-symbol">201 </span>CREATED - [POST/<span class="hljs-keyword">PUT</span>/PATCH]：用户新建或修改数据成功。<br><span class="hljs-symbol">202 </span>Accepted - [*]：表示一个请求已经进入后台排队（异步任务）<br><span class="hljs-symbol">204 </span>NO CONTENT - [<span class="hljs-keyword">DELETE</span>]：用户删除数据成功。<br><span class="hljs-symbol">400 </span>INVALID REQUEST - [POST/<span class="hljs-keyword">PUT</span>/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。<br><span class="hljs-symbol">401 </span>Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。<br><span class="hljs-symbol">403 </span>Forbidden - [*] 表示用户得到授权（与<span class="hljs-number">401</span>错误相对），但是访问是被禁止的。<br><span class="hljs-symbol">404 </span><span class="hljs-keyword">NOT</span> FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。<br><span class="hljs-symbol">406 </span><span class="hljs-keyword">Not</span> Acceptable - [<span class="hljs-keyword">GET</span>]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。<br><span class="hljs-symbol">410 </span>Gone -[<span class="hljs-keyword">GET</span>]：用户请求的资源被永久删除，且不会再得到的。<br><span class="hljs-symbol">422 </span>Unprocesable entity - [POST/<span class="hljs-keyword">PUT</span>/PATCH] 当创建一个对象时，发生一个验证错误。<br><span class="hljs-symbol">500 </span>INTERNAL SERVER <span class="hljs-keyword">ERROR</span> - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。<br><span class="hljs-symbol">502 </span>网关错误<br><span class="hljs-symbol">503 </span>Service Unavailable<br><span class="hljs-symbol">504 </span>网关超时<br></code></pre></div></td></tr></table></figure><h3 id="规范确定"><a href="#规范确定" class="headerlink" title="规范确定"></a>规范确定</h3><p>涉及到业务错误，后端返回状态码任然为200，需要后端将具体的业务错误返回给前端，返回数据结构如下:</p><figure class="highlight dts"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dts"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-symbol">  code:</span> <span class="hljs-number">200</span>,<br><span class="hljs-symbol">  data:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-symbol">    result:</span> <span class="hljs-string">&quot;fail&quot;</span>,<br><span class="hljs-symbol">    errorcode:</span> <span class="hljs-number">10001</span>,  <span class="hljs-meta"># 业务相关的错误编码</span><br><span class="hljs-symbol">    message:</span> “计算资源不可用” <span class="hljs-meta"># 业务相关的错误描述</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><p>涉及到40x之类的错误，后端返回状态码为40x，同时需要在返回数据结构中注明具体错误。</p><figure class="highlight dts"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dts"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-symbol">  code:</span> <span class="hljs-number">40</span>x,<br><span class="hljs-symbol">  data:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-symbol">    result:</span> <span class="hljs-string">&quot;fail&quot;</span>,<br><span class="hljs-symbol">    message:</span> “计算资源不可用” <span class="hljs-meta"># 业务相关的错误描述</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><h3 id="axios拦截器捕捉"><a href="#axios拦截器捕捉" class="headerlink" title="axios拦截器捕捉"></a>axios拦截器捕捉</h3><p>可以在<code>request.ts</code>中通过axios拦截器获取捕捉的error，通过error描述对比直接进行处理，适用于code专一性表示错误的项目。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 请求拦截器</span><br>axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<br>  <span class="hljs-function">(<span class="hljs-params">config: AxiosRequestConfig</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">UserModule</span>.<span class="hljs-property">token</span>) &#123;<br>      config.<span class="hljs-property">headers</span>[<span class="hljs-string">&quot;Authorization&quot;</span>] = <span class="hljs-string">&quot;JWT &quot;</span> + <span class="hljs-title class_">UserModule</span>.<span class="hljs-property">token</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> config;<br>  &#125;,<br>  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>  &#125;<br>);<br><br>axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<br>  <span class="hljs-function">(<span class="hljs-params">res: AxiosResponse</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> res;<br>  &#125;,<br>  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;error=&quot;</span>, error);<br>    <span class="hljs-keyword">if</span> (error == <span class="hljs-string">&quot;Error: Request failed with status code 403&quot;</span>) &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;当前没有查看权限，请联系管理员。&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>    &#125;<br>  &#125;<br>);<br></code></pre></div></td></tr></table></figure><h3 id="validateStatus配置"><a href="#validateStatus配置" class="headerlink" title="validateStatus配置"></a>validateStatus配置</h3><p>通过在<code>request.ts</code>中增加<code>validateStatus</code>配置，获取错误code，可以直接返回到调用接口的位置。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteDataBatch</span>(<span class="hljs-params">url: string, json: object</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">axios</span>(&#123;<br>    <span class="hljs-attr">url</span>: url,<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;delete&quot;</span>,<br>    <span class="hljs-attr">data</span>: json,<br>    <span class="hljs-attr">validateStatus</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">status</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;status=&#x27;</span>, status) <span class="hljs-comment">// 403</span><br>      <span class="hljs-keyword">return</span> status &lt; <span class="hljs-number">500</span>;<br>    &#125;<br>  &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> error);<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">deleteBatchStandard</span>(&#123; ids &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span>(!res) &#123;<br>        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;这里需要前端处理错误信息展示&quot;</span>); <br>      &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">const</span> &#123; status, data, msg &#125; = res.<span class="hljs-property">data</span>;<br>        <span class="hljs-keyword">if</span> (status == <span class="hljs-number">200</span>) &#123;<br>          <span class="hljs-comment">//success</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(msg); <span class="hljs-comment">//业务信息错误</span><br>        &#125;<br>      &#125;<br>      <br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;服务器修复中，请稍后重试！&quot;</span>);<br>    &#125;);<br>&#125;)<br>.<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;error=&#x27;</span>,error) <span class="hljs-comment">//</span><br>&#125;);<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="https://axios-http.com/docs/req_config">axios API</a><br><a href="https://blog.csdn.net/weixin_69506221/article/details/128017432">axios 详细配置</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（15）css计算属性</title>
    <link href="/2023/02/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8815%EF%BC%89css%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7/"/>
    <url>/2023/02/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%8815%EF%BC%89css%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<blockquote><p>终于遇到需要css计算属性的需求啦～业务理解是“展示GPU在系统、业务、释放中、可用4中状态下的占比”，本项目基于vue3+element，数据展示使用了el-table，这篇记录一下使用过程中的坑。</p></blockquote><span id="more"></span><h3 id="css计算属性的直接写法"><a href="#css计算属性的直接写法" class="headerlink" title="css计算属性的直接写法"></a>css计算属性的直接写法</h3><p>大概实现效果如下：<br><img src="/img/vue14-1.png" alt="css计算属性"><br>占比条（percent bar）需要在column中定制化处理，使用一个宽度固定的块ul作为容器，里面排列4个小块li，4个小块的宽度是计算所得的。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"> <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;GPU&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; scope.row.gpu_card_text &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;percent&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;scope.row.w1Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;scope.row.w2Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;scope.row.w3Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;scope.row.w4Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>样式计算属性代码设置如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"> tempList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">let</span> w1 = (i.<span class="hljs-property">gpu_card</span>[<span class="hljs-number">0</span>] / sum) * <span class="hljs-number">100</span>;<br>  <span class="hljs-keyword">let</span> w2 = (i.<span class="hljs-property">gpu_card</span>[<span class="hljs-number">1</span>] / sum) * <span class="hljs-number">100</span>;<br>  <span class="hljs-keyword">let</span> w3 = (i.<span class="hljs-property">gpu_card</span>[<span class="hljs-number">2</span>] / sum) * <span class="hljs-number">100</span>;<br>  <span class="hljs-keyword">let</span> w4 = (i.<span class="hljs-property">gpu_card</span>[<span class="hljs-number">3</span>] / sum) * <span class="hljs-number">100</span>;<br>  <span class="hljs-keyword">let</span> w1Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w1 + <span class="hljs-string">&quot;%&quot;</span> &#125;;<br>  &#125;);<br>  <span class="hljs-keyword">let</span> w2Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w2 + <span class="hljs-string">&quot;%&quot;</span> &#125;;<br>  &#125;);<br>  <span class="hljs-keyword">let</span> w3Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w3 + <span class="hljs-string">&quot;%&quot;</span> &#125;;<br>  &#125;);<br>  <span class="hljs-keyword">let</span> w4Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w4 + <span class="hljs-string">&quot;%&quot;</span> &#125;;<br>  &#125;);<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(i, &#123; w1Style, w2Style, w3Style, w4Style &#125;);<br>&#125;);<br>dataList.<span class="hljs-property">tableData</span> = tempList;<br></code></pre></div></td></tr></table></figure><p>还需要在css中添加：</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.percent</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;<br>  <span class="hljs-attribute">overflow</span>: hidden;<br>  <span class="hljs-selector-tag">li</span> &#123;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;<br>  &#125;<br>  <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-attribute">background-color</span>: red;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--width);<br>  &#125;<br>  <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-attribute">background-color</span>: yellow;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--width);<br>  &#125;<br>  <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) &#123;<br>    <span class="hljs-attribute">background-color</span>: blue;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--width);<br>  &#125;<br>  <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">4</span>) &#123;<br>    <span class="hljs-attribute">background-color</span>: green;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--width);<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="做成一个组件"><a href="#做成一个组件" class="headerlink" title="做成一个组件"></a>做成一个组件</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;template&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;percent&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;w1Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;w2Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;w3Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;w4Style&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>&lt;/template&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">import</span> &#123; defineComponent, computed &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vue&quot;</span>;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;percent-bar&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-attr">props</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-attr">data</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;,</span></span><br><span class="language-javascript"><span class="language-xml">  &#125;,</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props</span>) &#123;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> tempList = props.<span class="hljs-property">data</span>;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">const</span> sum = tempList.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">prev, cur</span>) =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Number</span>(prev) + <span class="hljs-title class_">Number</span>(cur);</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;);</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w1 = (<span class="hljs-title class_">Number</span>(tempList[<span class="hljs-number">0</span>]) / <span class="hljs-title class_">Number</span>(sum)) * <span class="hljs-number">100</span>;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w2 = (<span class="hljs-title class_">Number</span>(tempList[<span class="hljs-number">1</span>]) / <span class="hljs-title class_">Number</span>(sum)) * <span class="hljs-number">100</span>;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w3 = (<span class="hljs-title class_">Number</span>(tempList[<span class="hljs-number">2</span>]) / <span class="hljs-title class_">Number</span>(sum)) * <span class="hljs-number">100</span>;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w4 = (<span class="hljs-title class_">Number</span>(tempList[<span class="hljs-number">3</span>]) / <span class="hljs-title class_">Number</span>(sum)) * <span class="hljs-number">100</span>;</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w1Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w1 + <span class="hljs-string">&quot;%&quot;</span> &#125;;</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;);</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w2Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w2 + <span class="hljs-string">&quot;%&quot;</span> &#125;;</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;);</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w3Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w3 + <span class="hljs-string">&quot;%&quot;</span> &#125;;</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;);</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">let</span> w4Style = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-keyword">return</span> &#123; <span class="hljs-string">&quot;--width&quot;</span>: w4 + <span class="hljs-string">&quot;%&quot;</span> &#125;;</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;);</span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">return</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      w1Style,</span></span><br><span class="language-javascript"><span class="language-xml">      w2Style,</span></span><br><span class="language-javascript"><span class="language-xml">      w3Style,</span></span><br><span class="language-javascript"><span class="language-xml">      w4Style,</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;;</span></span><br><span class="language-javascript"><span class="language-xml">  &#125;,</span></span><br><span class="language-javascript"><span class="language-xml">&#125;);</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;scss&quot;</span> <span class="hljs-attr">scoped</span>&gt;</span></span><br><span class="language-xml"> .percent &#123;...&#125;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></code></pre></div></td></tr></table></figure><p>在父组件中这样调用</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;GPU&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; scope.row.gpu_card_text &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">percent-bar</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;scope.row.gpu_card&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">percent-bar</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><p>在编写组件的时候，先使用了循环渲染，但是发现元素没有渲染出来，查看浏览器发现style上没有挂载成功。具体原因有待研究。<br><img src="/img/vue14-2.png" alt="error"></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（14）casdoor接入</title>
    <link href="/2023/01/18/vue3%E7%AC%94%E8%AE%B0%EF%BC%8814%EF%BC%89casdoor%E6%8E%A5%E5%85%A5/"/>
    <url>/2023/01/18/vue3%E7%AC%94%E8%AE%B0%EF%BC%8814%EF%BC%89casdoor%E6%8E%A5%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<blockquote><p>遇到一个新需求，使用casdoor的登录入口，需要在我的项目中修改登录逻辑，这篇记录试用过程。</p></blockquote><span id="more"></span><h3 id="调用逻辑"><a href="#调用逻辑" class="headerlink" title="调用逻辑"></a>调用逻辑</h3><p>我的设计思路是当前系统处于未登录状态（即获取不到token）时，跳转login页面；<br>当前系统处于已登录状态时，跳转redirect页面（默认为主页home）。<br>操作步骤如下：</p><ol><li>在login页面触发casdoor中的<code>getSigninUrl</code>方法，跳转casdoor登录；</li><li>输入用户名密码，跳转已配置好的&#x2F;callback，本项目中为&#x2F;home。跳转时URL中携带有code；</li><li>在home主页中请求后端验证接口，参数为URL中取到的code；</li><li>后端验证接口返回res中携带token（JWT），home中使用cookie储存token；</li><li><code>permission.ts</code>中使用路由守卫验证token</li></ol><h3 id="casdoor-vue用法"><a href="#casdoor-vue用法" class="headerlink" title="casdoor-vue用法"></a>casdoor-vue用法</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm i casdoor-vue-sdk<br></code></pre></div></td></tr></table></figure><p>在<code>main.ts</code>中引入：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Casdoor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;casdoor-vue-sdk&quot;</span>;<br><span class="hljs-keyword">const</span> config = &#123;<br>  <span class="hljs-attr">serverUrl</span>: <span class="hljs-string">&quot;http://***&quot;</span>,<br>  <span class="hljs-attr">clientId</span>: <span class="hljs-string">&quot;***&quot;</span>,<br>  <span class="hljs-attr">organizationName</span>: <span class="hljs-string">&quot;teco&quot;</span>,<br>  <span class="hljs-attr">appName</span>: <span class="hljs-string">&quot;tecoai&quot;</span>,<br>  <span class="hljs-attr">redirectPath</span>: <span class="hljs-string">&quot;/home&quot;</span>,<br>&#125;;<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Casdoor</span>, config);<br></code></pre></div></td></tr></table></figure><p>在<code>login.vue</code>中使用：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;script setup&gt;<br><span class="hljs-keyword">import</span> &#123; onMounted, getCurrentInstance &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vue&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; useCasdoor &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;casdoor-vue-sdk&quot;</span>;<br><br><span class="hljs-keyword">const</span> &#123; getSigninUrl, getSignupUrl &#125; = <span class="hljs-title function_">useCasdoor</span>();<br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-title function_">getSigninUrl</span>();<br>&#125;);<br>&lt;/script&gt;<br></code></pre></div></td></tr></table></figure><h2 id="自己实现一个应用管理系统"><a href="#自己实现一个应用管理系统" class="headerlink" title="自己实现一个应用管理系统"></a>自己实现一个应用管理系统</h2><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><ol><li>首页地址：<a href="http://10.10.30.2:8003/">http://10.10.30.2:8003/</a></li><li>登录首页：<a href="http://10.10.30.2:8003/login">http://10.10.30.2:8003/login</a><br>登录组织：<a href="http://10.10.30.2:8003/login/teco">http://10.10.30.2:8003/login/teco</a></li></ol><h3 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h3><p>UMS系统负责所有用户的登录，登录进系统后，可以选择应用进行访问，采用单点登录。用token进行用户认证。<br>假设有应用A、B、C，成功登录访问应用A之后，在浏览器中输入应用B的UR，原理上应该是可以直接访问的。<br>问题：应用B的token从哪里获取？<br>代码执行顺序：permisson-axios&#x2F;service，也就是先进行路由守卫，若无token，直接跳转应用的login。<br>现在需要实现：</p><ol><li>若无token，处于UMS未登录状态，跳转UMS的login</li><li>若无token，处于UMS已登录状态，赋予token<br>解决方案：</li><li>在permisson路由守卫中，判断无token，getAccount()请求新token，通过res判断处理上述实现</li><li>使用微前端架构，实现应用间通信，共享token信息</li></ol><h3 id="前端设计"><a href="#前端设计" class="headerlink" title="前端设计"></a>前端设计</h3><ol><li>UMS-登录页：请求login接口</li><li>UMS-首页：展示各个子系统入口，点击后登录子系统（使用静默登录方式-已登录app1，在同一浏览器输入app2的地址，这两个app属于同一组织，app2可以自动登录）</li><li>UMS-个人中心：可以修改用户密码、邮箱、手机号，和casdoor相关联</li><li>子系统：初始化时请求用户个人信息及系统菜单，动态渲染菜单；菜单中包含按钮权限，需要获取后在页面渲染中处理</li></ol><p><code>附录</code><br><a href="https://github.com/casdoor/casdoor-vue-sdk">casdoor-vue-sdk文档</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>typescript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（13）自定义Hooks</title>
    <link href="/2023/01/17/vue3%E7%AC%94%E8%AE%B0%EF%BC%8813%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89Hooks/"/>
    <url>/2023/01/17/vue3%E7%AC%94%E8%AE%B0%EF%BC%8813%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89Hooks/</url>
    
    <content type="html"><![CDATA[<blockquote><p>年前赶项目真累啊～<br>这篇记录Hooks相关的定义、用法。</p></blockquote><span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>Hooks 在JS里是 callback，事件驱动，集成定义一些可复用的方法；</li><li>可以随时被引入和调用以实现高内聚低耦合的目标；</li><li>自定义 Hooks，将代码通过功能分块写、响应变量和方法在一起定义和调用；每个Hooks显式暴露响应式变量和方法；</li><li>将可复用功能抽离为外部JS文件；</li><li>自定义 Hooks 可以灵活传递任何参数来改变它的逻辑，参数不限于其他hook的暴露出来的变量，这提高了Vue3在抽象逻辑方面的灵活性；</li><li>利用ES6对象解构很轻松给变量重命名；</li><li>自定义 Hooks 是属于组件下的函数作用域的；</li><li>utils 的工具函数脱离框架也能使用，hooks 和框架耦合配合业务定义；</li></ol><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; ref, watch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">useAdd</span> = (<span class="hljs-params">&#123; num1, num2 &#125;</span>)  =&gt;&#123;<br>    <span class="hljs-keyword">const</span> addNum = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)<br>    <span class="hljs-title function_">watch</span>([num1, num2], <span class="hljs-function">(<span class="hljs-params">[num1, num2]</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">addFn</span>(num1, num2)<br>    &#125;)<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">addFn</span> = (<span class="hljs-params">num1, num2</span>) =&gt; &#123;<br>      addNum.<span class="hljs-property">value</span> = num1 + num2<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123;<br>      addNum,<br>      addFn<br>    &#125;<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useAdd<br></code></pre></div></td></tr></table></figure><p>使用hook</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> useAdd <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./useAdd.js&#x27;</span>     <span class="hljs-comment">//引入hook</span><br><span class="hljs-keyword">const</span> num1 = <span class="hljs-title function_">ref</span>(<span class="hljs-number">2</span>)<br><span class="hljs-keyword">const</span> num2 = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">const</span> &#123; addNum, addFn &#125; = <span class="hljs-title function_">useAdd</span>(&#123; num1, num2 &#125;)<br><span class="hljs-title function_">addFn</span>(num1.<span class="hljs-property">value</span>, num2.<span class="hljs-property">value</span>)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>总结语言（1）</title>
    <link href="/2022/12/14/%E6%80%BB%E7%BB%93%E8%AF%AD%E8%A8%80%EF%BC%881%EF%BC%89/"/>
    <url>/2022/12/14/%E6%80%BB%E7%BB%93%E8%AF%AD%E8%A8%80%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录在工作中用到的KPI语言。</p></blockquote><span id="more"></span><h3 id="技术调研报告-前端"><a href="#技术调研报告-前端" class="headerlink" title="技术调研报告-前端"></a>技术调研报告-前端</h3><ol><li>调研目的</li><li>调研过程<br>下载后尝试运行，由于时间久远，nodejs各个包依赖变化较大，项目报错。后手动解决部分依赖问题，忽略部分错误后强制项目运行。***。后尝试直接阅读项目源码。</li><li>结论<br>首先，该项目使用**框架，代码组织形式较为复杂，拆分组件粒度细，阅读代码困难。<br>其次，由于前端package更新较快，该项目使用了大量外部package，部分package可能已经不维护了，依赖解决比较麻烦。<br>再者，该项目使用的UI组件库较为小众(可能来自网易的内部)，查阅后发现可用资料非常少。<br>综上，该项目不太适合直接二次开发。<br>由于此项目的 功能与我方需要开发的功能点有部分相似，也有一定的参考价值，在外部组件使用上可以作为代码编写的学习示例。</li></ol><h3 id="鬼话连篇"><a href="#鬼话连篇" class="headerlink" title="鬼话连篇"></a>鬼话连篇</h3><ol><li>解耦，拆分页面级封装，以 mixins 复用公共逻辑。</li><li>将工具类方法整合，以 wiki 输出文档。</li><li>在未耦合业务逻辑时，保留最佳实践分支，以供类似业务可以快速展开。 </li><li>业务代码冗余，UI 重复设计，且由于 QA 检查严格，沟通成本较大。主动推动前端和 UI 形成组件共识，如模态窗口，状态提示等业务，形成固定样式，输出固定组件，有效减少此类代码量超50%。</li><li>负责业务梳理、需求分析、技术选型、框架搭建，根据业务需求和后端架构，为项目选择最优前端解决方案。</li><li>负责项目更新迭代，版本升级，持续提升研发效率和研发质量。</li><li>对项目代码持续优化，并提供稳定流畅的页面体验。</li></ol><h3 id="发展学习"><a href="#发展学习" class="headerlink" title="发展学习"></a>发展学习</h3><ol><li>深刻理解业务，从技术角度实现为业务短期、中期、长期目标负责，平衡业务功能需求重要紧急程度、实现成本、未来可能业务变动方向，综合考虑系统的稳定性、性能、拓展性等非功能性需求的设计匹配业务发展阶段。</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>product</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>产品笔记（1）</title>
    <link href="/2022/12/14/%E4%BA%A7%E5%93%81%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/"/>
    <url>/2022/12/14/%E4%BA%A7%E5%93%81%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录在项目中学到的产品知识。</p></blockquote><span id="more"></span><h3 id="需求属性"><a href="#需求属性" class="headerlink" title="需求属性"></a>需求属性</h3><table><thead><tr><th>需求属性</th><th>属性说明</th></tr></thead><tbody><tr><td>编号</td><td>需求的顺序号，唯一性标识</td></tr><tr><td>提交人(*)</td><td>需求的录入PD，负责解释需求</td></tr><tr><td>提交时间</td><td>需求的录入时间，辅助信息</td></tr><tr><td>模块(*)</td><td>根据产品的模块划分</td></tr><tr><td>名称(*)</td><td>用简洁的短语描述需求</td></tr><tr><td>描述(*)</td><td>需求描述：无歧义、完整性、一致性、可测试等</td></tr><tr><td>提出者</td><td>即需求的原始提出者，有疑惑时便于追溯</td></tr><tr><td>提出时间</td><td>原始需求的获得时间，辅助信息</td></tr><tr><td>Bug编号</td><td>一些Bug视为需求，统一管理</td></tr><tr><td>分类</td><td>新增功能、功能改进、体验提升、Bug修复、内部需求等</td></tr><tr><td>层次</td><td>基础、扩展（期望需求）、增值（兴奋需求）</td></tr><tr><td>重要性</td><td>重要程度，辅助确定商业价值</td></tr><tr><td>紧迫度</td><td>紧急程度，辅助确定商业价值</td></tr><tr><td>持续时间</td><td>持续时间，辅助确定商业价值</td></tr><tr><td>商业价值(*)</td><td>商业优先级，不考虑实现难度，群体决策</td></tr><tr><td>开发量(*)</td><td>需求的开发工作量，表征实现难度</td></tr><tr><td>性价比(*)</td><td>“商业价值&#x2F;开发量”，用于决定先做哪个</td></tr><tr><td>状态(*)</td><td>需求生命周期：待讨论、暂缓、拒绝、需求中、开发中、已发布</td></tr><tr><td>负责PD(*)</td><td>状态进入“需求中”后确定</td></tr><tr><td>开发工程师</td><td>状态进入“开发中”后确定</td></tr><tr><td>项目名称</td><td>需求的发布项目</td></tr><tr><td>发布时间</td><td>需求的发布时间</td></tr><tr><td>备注</td><td>其它任何信息，如：1.被拒绝的理由 2.被暂缓的理由和重启条件 3.其它相关文档 ……</td></tr></tbody></table><h3 id="需求文档"><a href="#需求文档" class="headerlink" title="需求文档"></a>需求文档</h3><p>管理台—登录&#x2F;个人中心需求文档</p><table><thead><tr><th>文档名称</th><th>XX系统化 V1.0.0需求文档</th></tr></thead><tbody><tr><td>所属产品</td><td></td></tr><tr><td>迭代版本</td><td></td></tr><tr><td>文档状态</td><td>编写中</td></tr><tr><td>人员职责</td><td></td></tr><tr><td>原型地址</td><td></td></tr><tr><td>UI设计文档地址</td><td></td></tr><tr><td>备注</td><td></td></tr></tbody></table><table><thead><tr><th>需求概要</th><th></th></tr></thead><tbody><tr><td>部署方式</td><td>私有化部署</td></tr><tr><td>文档状态</td><td>IN REVIEW &#x2F; v0.1.0</td></tr><tr><td>产品负责人</td><td>ginny</td></tr><tr><td>产品版本</td><td>v0.1.0</td></tr><tr><td>产品名称</td><td>我的产品</td></tr><tr><td>原型 link</td><td></td></tr></tbody></table><p>变更记录</p><table><thead><tr><th>时间</th><th>版本</th><th>变更人</th><th>变更说明</th></tr></thead><tbody><tr><td>2023-1-1</td><td>v0.1.0</td><td>ginny</td><td>初版需求文档</td></tr></tbody></table><p>一、名词定义及方法论</p><table><thead><tr><th>名词</th><th>定义</th><th>备注</th></tr></thead><tbody><tr><td>集群管理员</td><td>拥有平台最高权限，能够登录集群管理平台。目前有且仅有一位，后续支持增加管理员</td><td>admin用户</td></tr></tbody></table><p>二、功能性需求</p><table><thead><tr><th>一级功能</th><th>功能说明</th><th>优先级</th><th>备注</th></tr></thead><tbody><tr><td>个人中心</td><td>支持查看个人信息</td><td>3</td><td></td></tr></tbody></table><p>三、功能性需求详细说明</p><table><thead><tr><th>功能</th><th>详细说明</th><th>备注</th></tr></thead><tbody><tr><td>XX管理列表</td><td>列表字段包括：XXX</td><td></td></tr></tbody></table><p>四、性能需求<br>支持最大管理X台机器。允许支持X个用户的创建。<br>支持100人同时登录&#x2F;注册平台。支持2000人同时处于登录状态。</p><p>五、产品边界与限制<br>六、附录</p><h3 id="产品里程碑规划"><a href="#产品里程碑规划" class="headerlink" title="产品里程碑规划"></a>产品里程碑规划</h3><table><thead><tr><th>时间</th><th>202X.3</th><th>202X.6</th><th>202X.12</th></tr></thead><tbody><tr><td>商业化目标</td><td></td><td></td><td></td></tr><tr><td>产品目标</td><td>产品功能：输出XXX</td><td>产品功能：完成mvp版本，配备XXX，功能包括：XXX</td><td>产品质量： 稳定性达到70%</td></tr><tr><td>研发目标</td><td>依赖环境搭建完成</td><td></td><td></td></tr></tbody></table><h3 id="竞品分析"><a href="#竞品分析" class="headerlink" title="竞品分析"></a>竞品分析</h3><p>一、调研背景<br>二、产品基本信息<br>  1.产品定位&#x2F;产品介绍&#x2F;产品价值<br>  2.面向用户&#x2F;适用行业<br>  3.产品优势<br>三、产品架构<br>四、功能分析</p><h3 id="版本管理"><a href="#版本管理" class="headerlink" title="版本管理"></a>版本管理</h3><p>版本管理是对软件开发过程中特定功能的集合或特定代码构建结果进行管理。版本管理是为满足不同需求，对同一产品或系统进行局部的改进和改型所产生的产品或系统系列的变更情况进行记录、跟踪、维护和控制的过程。</p><h4 id="版本号定义"><a href="#版本号定义" class="headerlink" title="版本号定义"></a>版本号定义</h4><p>A.B.C.D<br>A—主板本号：当发生大的版本迭代、如架构重构、页面重构或有颠覆性功能上线时，主版本号+1。<br>B—次版本号：相对于主版本号而言，次版本号的升级对应的只是局部的变动，但该局部的变动造成程序和以前版本不能兼容，或者对该程序以前的协作关系产生了破坏，或者是功能上有大的改进或增强。次版本号+1。<br>C—修订版本号：当每个次版本中规划出多个sprint时，每个sprint结束后，版本更为为修订版本更新，修订版本号+1.<br>D—日期版本号：当客户侧&#x2F;内测时出现bug需要紧急修改，并且临时发版时，使用日期版本号。</p><h4 id="版本迭代节奏"><a href="#版本迭代节奏" class="headerlink" title="版本迭代节奏"></a>版本迭代节奏</h4><p>每个Q发布一个大版本，其中一个Q内再以两周为一个sprint周期进行迭代，每完成一个sprint，修订版本号+1</p><h4 id="sprint内开发测试流程"><a href="#sprint内开发测试流程" class="headerlink" title="sprint内开发测试流程"></a>sprint内开发测试流程</h4><p><img src="/img/pm-1.jpg" alt="开发测试流程"><br>每个Q最后一个sprint预留用于对本Q要上线功能的整体回归以及内部用户试用的内测阶段，并根据回归测试或内测时发现的bug进行修复，一般情况不进行功能开发。</p><h3 id="git版本管理"><a href="#git版本管理" class="headerlink" title="git版本管理"></a>git版本管理</h3><p><img src="/img/pm-2.png" alt="git版本管理"><br>master： 用于生产部署的版本，永远不会commit，只能由hotfix、release分支合并，并打tag<br>develop： 开发用的主分支<br>feature： 开发特性的分支，由develop分支创建，最终合并到develop<br>release： 当大版本中所有特性都完成开发后，由develop分支创建release分支，进行qa测试<br>hotfix： 线上出现bug时，从master生产一个bugfix版本，修复完成后，合并到master和develop分支并打tag</p><h3 id="部署-amp-环境"><a href="#部署-amp-环境" class="headerlink" title="部署 &amp; 环境"></a>部署 &amp; 环境</h3><h4 id="环境资源需求"><a href="#环境资源需求" class="headerlink" title="环境资源需求"></a>环境资源需求</h4><table><thead><tr><th>环境</th><th>用途</th><th>配置</th><th>数量</th><th>开始时间</th><th>结束时间</th><th>拥有者</th><th>缺口</th><th>缺口成本</th></tr></thead><tbody><tr><td>开发环境</td><td></td><td>cpu:48核，内存512G，硬盘2T+8T</td><td>1</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>测试环境</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>运维开发</td><td>公共组件、存储服务</td><td>硬盘100T</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>网络设备及配件</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><h4 id="环境清单"><a href="#环境清单" class="headerlink" title="环境清单"></a>环境清单</h4><table><thead><tr><th>环境类型</th><th>环境用途</th><th>环境负责人</th><th>环境配置</th><th>环境数量</th></tr></thead><tbody><tr><td>开发环境</td><td>用于每个sprint功能开发</td><td>研发</td><td></td><td></td></tr><tr><td>测试环境</td><td>用于每个sprint功能测试</td><td>QA</td><td></td><td></td></tr><tr><td>内部稳定环境</td><td>作为内部正式使用的稳定环境</td><td>PM</td><td></td><td></td></tr><tr><td>外部PoC&#x2F;Demo试用环境</td><td>面向外部客户前期交流时，用户试用环境</td><td>PM</td><td></td><td></td></tr><tr><td>客户私有环境</td><td>客户签订合同后部署的正式使用环境</td><td>客户联系人</td><td></td><td></td></tr></tbody></table><h4 id="问题级别"><a href="#问题级别" class="headerlink" title="问题级别"></a>问题级别</h4><p>【阻塞级问题】：常规操作导致系统崩溃，数据丢失或异常、流程无法正常显示、继续和结束。一天内改完</p><p>【严重级别问题】：影响主要功能实现，出现非正常的结果或错误，主要或次要功能缺失不能满足需求设定。两天内改完</p><p>【一般问题】：影响次要功能实现和显示类bug，不影响系统使用，包括但不限于交互或显示与设计稿出现偏差，如文案提示、位置偏移等。尽量本周改完</p><p>【轻微问题】：即功能优化、实现逻辑的优化，交互和视觉层面优化的建议等。视紧急程度修改可作为优化项后续版本迭代。</p>]]></content>
    
    
    
    <tags>
      
      <tag>product</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>uniapp学习（1）</title>
    <link href="/2022/12/06/uniapp%E5%AD%A6%E4%B9%A0%EF%BC%881%EF%BC%89/"/>
    <url>/2022/12/06/uniapp%E5%AD%A6%E4%B9%A0%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>部门需要快速开发一个跨平台的app，前端担起重任。<br>简单调研后发现uni-app可以同时编译成小程序和客户端应用，本项目需求对客户端原生API调用较少，和后端交互较多，且部门内技术栈偏向于vue，对于uni-app学习成本不高，比较适合这个框架。<br>本篇记录框架的学习及使用过程。 </p></blockquote> <span id="more"></span><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ol><li>uni-app是一个使用 Vue.js 开发所有前端应用的框架，一套代码可发布到 H5、以及各种小程序，并且在 HBuilderX 中可直接打包生成 Android、iOS App。</li></ol><h3 id="开发规范"><a href="#开发规范" class="headerlink" title="开发规范"></a>开发规范</h3><p>1.页面文件遵循 Vue 单文件组件 (SFC) 规范<br>2.组件标签靠近小程序规范，详见uni-app组件规范<br>3.接口能力（JS API）靠近微信小程序规范，但需将前缀 wx 替换为 uni，详见uni-app接口规范<br>4.数据绑定及事件处理同 Vue.js 规范，同时补充了App及页面的生命周期<br>5.为兼容多端运行，建议使用flex布局进行开发</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AIGC试用</title>
    <link href="/2022/12/02/AIGC%E8%AF%95%E7%94%A8/"/>
    <url>/2022/12/02/AIGC%E8%AF%95%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>尝试跑一个AIGC开源项目，了解前后端交互、模型推理流程，重在学习。<br>本篇记录使用的命令，以及跑项目过程遇到的问题。</p></blockquote><span id="more"></span><h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><ol><li>下载安装anaconda<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">wget https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/Miniconda3-py39_4.12.0-Linux-x86_64.sh<br>sh ***<br><br></code></pre></div></td></tr></table></figure></li></ol><h3 id="conda命令"><a href="#conda命令" class="headerlink" title="conda命令"></a>conda命令</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment">#创建虚拟环境</span><br>conda create -n your_env_name python=X.X（3.6、3.7等）<br><span class="hljs-comment">#激活虚拟环境</span><br><span class="hljs-built_in">source</span> activate your_env_name(虚拟环境名称)<br><span class="hljs-comment">#退出虚拟环境</span><br><span class="hljs-built_in">source</span> deactivate your_env_name(虚拟环境名称)<br><span class="hljs-comment">#删除虚拟环境</span><br>conda remove -n your_env_name(虚拟环境名称) --all<br>conda remove --name your_env_name package_name  <span class="hljs-comment"># 删除环境中的某个包</span><br><br><span class="hljs-comment">#查看安装了哪些包</span><br>conda list<br><br><span class="hljs-comment">#安装包</span><br>conda install package_name(包名)<br>conda install scrapy==1.3 <span class="hljs-comment"># 安装指定版本的包</span><br>conda install -n 环境名 包名 <span class="hljs-comment"># 在conda指定的某个环境中安装包</span><br><br><span class="hljs-comment">#查看当前存在哪些虚拟环境</span><br>conda <span class="hljs-built_in">env</span> list <br><span class="hljs-comment">#或 </span><br>conda info -e<br><span class="hljs-comment">#或</span><br>conda info --envs<br></code></pre></div></td></tr></table></figure><h3 id="安装requirements-txt依赖"><a href="#安装requirements-txt依赖" class="headerlink" title="安装requirements.txt依赖"></a>安装requirements.txt依赖</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">pip install -r requirements.txt<br></code></pre></div></td></tr></table></figure><h3 id="环境查看"><a href="#环境查看" class="headerlink" title="环境查看"></a>环境查看</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 查看Linux系统版本</span><br><span class="hljs-built_in">cat</span> /proc/version<br><span class="hljs-comment"># 查看驱动信息</span><br>nvidia-smi<br><span class="hljs-comment">#  NVIDIA-SMI 465.19.01    Driver Version: 465.19.01    CUDA Version: 11.3</span><br></code></pre></div></td></tr></table></figure><p><code>bash</code></p><p><code>附录</code><br><a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/?C=M&O=A">清华大学开源软件镜像站</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>ml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MLOps实战（1）</title>
    <link href="/2022/11/15/MLOps%E5%AE%9E%E6%88%98%EF%BC%881%EF%BC%89/"/>
    <url>/2022/11/15/MLOps%E5%AE%9E%E6%88%98%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>2022年11月正式接触MLOps，本篇记录理论学习。</p></blockquote><span id="more"></span><h3 id="理论概念"><a href="#理论概念" class="headerlink" title="理论概念"></a>理论概念</h3><ol><li>传统系统模块化设计，松耦合；<br>ML系统牵一发动全身（数据、model、参数改变触发新版本）</li><li>ML技术可能适用的场景：<br>（1）无法通过经验给出规则；<br>（2）已有好数据，业务依赖数据作决策；<br>（3）目标问题不断发生变化；<br>（4）无法扩展；</li><li>业务需求是一个问题或者痛点，需要在冲突的需求之间找到合适的平衡点，并将其转化为模型的输入和输出、损失函数和性能指标的选择。</li><li>MLOps提供所有已部署模型以及所有经过A&#x2F;B测试的模型的性能的可见性。</li><li>ML实验跟踪<br>（1）简化从实验到生产的模型迁移<br>（2）模型投产后的版本控制<br>（3）在ML模型注册中心管理模型工件<br>（4）在生产中测试各种模型版本<br>（5）serving</li><li>A&#x2F;B test：统计技术，用于online模型评估<br>（1）确定商业目标的衡量指标（通常为代理指标）<br>（2）确定实验本身的参数（样本量、持续时间）</li><li>CI：持续集成，经常测试每个软件单元的代码库，以及通过单元测试、集成测试、系统测试来测试不同软件工件共同工作的完整性。在ML领域，需要：<br>（1）测试和验证模型代码及依赖组件的有效性<br>（2）测试和验证数据、数据模式、模型的性能<br>CD：持续部署，模型开发人员将更新后的模型、模型代码（含预测代码）上传至中央存储，然后部署到生产环境中。设计一个ML pipeline，将模型预测所涉及的流程和依赖自动部署或更新到一个ML服务。<br>建议：使用进程锁的单节点+基于Kubernetes的多节点部署方案。<br>交付：构建一个完全打包并经过验证的模型版本的过程，该版本可以部署到生产环境中。</li><li>模型衰退&#x2F;出错的原因：<br>（1）新训练集质量不高<br>（2）数据漂移P(X) or 概念漂移P(y|X)-持续、周期性出现<br>（3）特征修复<br>（4）依赖资源改变</li><li>版本控制：假设条件、随机性、数据、设定值、结果、执行、环境，将版本控制和再现性相关的基础文档任务自动化，通过集成平台进行设计和部署。</li><li>模型评估指标<br>   （1）统计：准确度、精准度、召回<br>   （2）计算：平均延迟、延迟的95百分位等</li><li>模型监控<br>   （1）资源层面：CPU、RAM、网络使用率和磁盘空间是否符合预期？请求是否以预期的速度得到处理？<br>   （2）性能层面：随着时间的推移，模型仍然是新输入数据模式的准确表示吗？性能和设计阶段一样好吗？</li></ol><h3 id="ML"><a href="#ML" class="headerlink" title="ML"></a>ML</h3><ol><li>监督学习：分类、回归；无监督学习：聚类</li><li>model choose –》algorithm + config + training;<br>error &amp; performance trade off</li><li>泛化：对新鲜样本进行准确预测的能力</li></ol><h3 id="Engineering"><a href="#Engineering" class="headerlink" title="Engineering"></a>Engineering</h3><ol><li>特征工程：对原始数据或中间特征进行一系列工程化处理，映射为一个更适合建模的新的表现形式，以降低原始数据的噪声和冗余。</li><li>基类（接口）：定义一个标准和基础功能，独立软件块之间的“边界”，定义不同组件的交流方式。</li><li>工件：可测试和可部署的项目包</li></ol><h3 id="MLOps"><a href="#MLOps" class="headerlink" title="MLOps"></a>MLOps</h3><ol><li>ML模型需要两个版本的管道：一个用于训练-history，一个用于服务-real time。<br>   将管道中的节点进行抽象，整个管道作为产品进行集中化开发和维护。<br>   可用于抽象的节点：<br>   （1）特征存储<br>   （2）训练过程各节点模块化<br>   （3）Maas，服务管道封装成通用的模型服务接口，一键生成模型服务</li><li>首先确定业务可以产生哪些数据，目标输出是什么，然后界定哪些模型适合加工这类输入和输出;<br>规划ML任务的步骤：<br>（1）将业务目标框定在一个ML范式中<br>（2）评估该任务的可行性，根据评估结果，重新调整ML框架和算法，直到获取满意的结果为止</li><li>数据准备-特征工程-模型开发-模型部署-模型监控    </li><li>评估指标<br>（1）模型表现（代理指标-模型侧指标）-模型目标-模型开发时期<br>（2）业务表现-业务目标-模型部署时期</li><li>ML项目生命周期<br>（1）定业务目标-行业专家和数据科学家合作<br>（2）数据准备：clean-feature engineering-sample<br>（3）模型实验：通过离线评估进行最佳模型的选择<br>（4）模型工程：对实验过程进行脚本封装并生成ML管道<br>（5）模型评估<br>（6）模型预测<br>（7）模型监控</li><li>模型部署<br>-生成代码&amp;模型的序列化：将代码、环境依赖、模型实例部署到中央存储，为后续模型的版本化及回溯使用。<br>-模型的服务化：通过数据库批量推理模式（offline）、推入式推理模式、单服务推理模式和微服务推理模式为应用提供服务。</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>ml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>egg笔记（2）Mac配置使用mysql</title>
    <link href="/2022/10/27/egg%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89Mac%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8mysql/"/>
    <url>/2022/10/27/egg%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89Mac%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8mysql/</url>
    
    <content type="html"><![CDATA[<blockquote><p>我的egg.js项目中使用mysql数据库，先在本机做一个配置测试环境。<br>这篇记录Mac上本地配置数据库，以及代码编写。</p></blockquote><span id="more"></span><h3 id="mysql安装配置"><a href="#mysql安装配置" class="headerlink" title="mysql安装配置"></a>mysql安装配置</h3><p>安装见附录。</p><ol><li><p>登录查看数据库，操作指令如下：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">mysql -uroot -p***<br></code></pre></div></td></tr></table></figure></li><li><p>数据库交互操作</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">// 创建一个名字为<span class="hljs-built_in">test</span>数据库<br>create database <span class="hljs-built_in">test</span>;<br>// 查看所有数据库<br>show databases;<br>// 进入数据库<br>use <span class="hljs-built_in">test</span>;<br>// 查看该数据库中的表<br>show tables;<br></code></pre></div></td></tr></table></figure></li><li><p>手动创建表</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">create table aaa(<br>  <span class="hljs-built_in">id</span> int not null auto_increment,<br>  name varchar(100) not null,<br>  PRIMARY KEY ( <span class="hljs-built_in">id</span> )<br>)DEFAULT CHARSET=utf8;<br></code></pre></div></td></tr></table></figure><p>此时<code>show tables;</code>，会显示<code>1 row in set</code>，接下来就可以使用代码在表中插入数据啦～</p></li></ol><h3 id="egg-js配置"><a href="#egg-js配置" class="headerlink" title="egg.js配置"></a>egg.js配置</h3><p>在<code>/config/plugin.ts</code>中加入插件配置，<code>/config/config.default.ts</code>中配置mysql登录账户，见附录。</p><ol><li>插入数据<br>在表名为aaa的表中插入一条数据，要和初始化表中设定的数据结构相同。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> item = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ginny&#x27;</span> &#125;;<br><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">mysql</span>.<span class="hljs-title function_">insert</span>(<span class="hljs-string">&#x27;aaa&#x27;</span>, item);<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><br></code></pre></div></td></tr></table></figure></li></ol><p><code>附录</code></p><ol><li><a href="https://blog.csdn.net/guorenhao/article/details/124508441">Mac安装MySQL详细教程</a></li><li><a href="https://www.eggjs.org/tutorials/mysql">egg官方操作文档</a></li><li><a href="https://github.com/search?q=topic:egg-plugin&type=Repositories">egg插件</a></li><li><a href="https://downloads.mysql.com/archives/workbench/">可视化工具workbench下载</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>egg</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（12）目录 &amp; 文件拆分 &amp; 代码位置记录</title>
    <link href="/2022/10/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8812%EF%BC%89%E7%9B%AE%E5%BD%95-%E6%96%87%E4%BB%B6%E6%8B%86%E5%88%86/"/>
    <url>/2022/10/19/vue3%E7%AC%94%E8%AE%B0%EF%BC%8812%EF%BC%89%E7%9B%AE%E5%BD%95-%E6%96%87%E4%BB%B6%E6%8B%86%E5%88%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>项目有时候有部分代码可以复用，有时候需要整体修改（eg: API暴露），这篇记录一下实践中的感受。<br>也有一些实践中发现代码书写位置的问题，都记录在这篇里面。</p></blockquote><span id="more"></span><h3 id="请求axios统一"><a href="#请求axios统一" class="headerlink" title="请求axios统一"></a>请求axios统一</h3><p><code>utils/request.ts</code>中封装axios，在<code>api/***.ts</code>中调用。</p><ol><li><p>若所有接口来自同一台服务器<br>在<code>.env.***</code>中设置<code>VUE_APP_BASE_API</code></p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">NODE_ENV = <span class="hljs-string">&#x27;server&#x27;</span><br>VUE_APP_BASE_API = <span class="hljs-string">&quot;http://***&quot;</span><br>VUE_APP_INTERFACE_URL = <span class="hljs-string">&quot;http://***&quot;</span><br></code></pre></div></td></tr></table></figure><p><code>utils/request.ts</code>中配置<code>VUE_APP_BASE_API</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> axios, &#123; <span class="hljs-title class_">AxiosRequestConfig</span>, <span class="hljs-title class_">AxiosResponse</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;axios&quot;</span>;<br><br>axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">timeout</span> = <span class="hljs-number">50000</span>;<br>axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">headers</span> = &#123;<br>  <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json;charset=utf8&quot;</span>,<br>&#125;;<br>axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">baseURL</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">VUE_APP_BASE_API</span><br>  ? process.<span class="hljs-property">env</span>.<span class="hljs-property">VUE_APP_BASE_API</span><br>  : <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-comment">// getData, postData, putData, delData 封装</span><br></code></pre></div></td></tr></table></figure></li><li><p>若接口来自不同服务器，或者不同环境使用不同服务器，不使用base url。<br>根据不同服务器接口分别在<code>api/***.ts</code>中编写host。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> host = process.<span class="hljs-property">env</span>.<span class="hljs-property">VUE_APP_MOCK</span><br>  ? <span class="hljs-string">&quot;http://0.0.0.0:8080&quot;</span><br>  : process.<span class="hljs-property">env</span>.<span class="hljs-property">VUE_APP_INTERFACE_URL</span>;<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="接口暴露"><a href="#接口暴露" class="headerlink" title="接口暴露"></a>接口暴露</h3><p>本项目生产环境中，由于接口地址是变化的，前端硬逻辑修改麻烦，所以暴露一个<code>static/config.js</code>文件，后端可以通过修改这个文件来给定当前接口地址。</p><ol><li><p><code>static/config.js</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">g</span> = &#123;<br>  <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">&quot;http://***&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure></li><li><p>在<code>index.html</code>中引入，<code>&lt;script src=&quot;./static/config.js&quot;&gt;&lt;/script&gt;</code></p></li><li><p><code>api/***.ts</code>中根据环境获取</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> host =<br>  process.<span class="hljs-property">env</span>.<span class="hljs-property">VUE_APP_PRO</span> == <span class="hljs-string">&quot;true&quot;</span><br>    ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">g</span>.<span class="hljs-property">apiUrl</span><br>    : process.<span class="hljs-property">env</span>.<span class="hljs-property">VUE_APP_INTERFACE_URL</span>;<br></code></pre></div></td></tr></table></figure></li><li><p><code>package.json</code>中配置生产环境命令</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;prod&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vue-cli-service build --mode prod&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><p>编写<code>.env.prod</code></p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">NODE_ENV = <span class="hljs-string">&#x27;prod&#x27;</span><br>VUE_APP_PRO = <span class="hljs-string">&#x27;true&#x27;</span><br></code></pre></div></td></tr></table></figure><p>运行<code>npm run prod</code>时，打包所有文件到dist，<code>./static/*</code>下文件将直接移动到dist目录下，后期修改<code>apiUrl</code>，也将直接改变请求地址。</p></li><li><p><code>App.vue</code> 是所有页面的入口，若项目中有和 token 有关的请求，不能放在 <code>App.vue</code> 中，可以放在 <code>layout/app-main.vue</code> 中。</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>wx小程序（1）</title>
    <link href="/2022/09/26/wx%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%881%EF%BC%89/"/>
    <url>/2022/09/26/wx%E5%B0%8F%E7%A8%8B%E5%BA%8F%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>简单记录一下微信小程序的学习。</p></blockquote><span id="more"></span><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight 1c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs 1c"><span class="hljs-comment">// 整个小程序只有一个App实例</span><br><span class="hljs-string">|-- app.json (整体配置：窗口样式、网络延迟...)</span><br><span class="hljs-string">|-- app.js (总体逻辑：onLaunch、onShow、onHide、onError)</span><br><span class="hljs-string">|-- app.wxss (公共样式)</span><br><span class="hljs-string">|-- pages</span><br>    <span class="hljs-string">|-- index</span><br>        <span class="hljs-string">|-- index.js (页面注册)</span><br>        <span class="hljs-string">|-- index.json</span><br>        <span class="hljs-string">|-- index.wxml</span><br>        <span class="hljs-string">|-- index.wxss</span><br><span class="hljs-string">|-- img 图片资源</span><br><span class="hljs-string">|-- utils</span><br>    <span class="hljs-string">|-- common.js (公用方法)</span><br></code></pre></div></td></tr></table></figure><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ol><li>小程序有appid</li><li>可以使用<open-data>标签获取用户信息</li></ol><h3 id="关键思想-amp-设计写法"><a href="#关键思想-amp-设计写法" class="headerlink" title="关键思想 &amp; 设计写法"></a>关键思想 &amp; 设计写法</h3><ol><li><p>响应式数据绑定，逻辑层（js）数据处理，视图层（view）自动更新，需要将页面的数据、方法、生命周期函数注册到框架中。</p></li><li><p>window、document等DOM和BOM的API不可用，可以调用微信环境提供的各种API，例如：地理定位，扫码，支付。</p></li><li><p>页面引用<code>behaviors</code>共享数据字段和方法。</p></li><li><p><code>Page</code>适用于简单的页面，<code>Component</code>用于复杂页面。</p></li><li><p>页面生命周期<br> <img src="/img/wx1-pagelc.png" alt="页面生命周期"></p></li><li><p>不支持直接引入<code>node_modules</code>，可copy相关代码。</p></li><li><p><code>common.js</code>中抽取公共代码，使用<code>module.exports</code>导出，需要使用时通过<code>require</code>导入</p></li><li><p>监听事件触发，数据以参数形式传入回调函数.<br> <code>wx.onCompassChange(function (res) &#123;...&#125;)</code></p></li><li><p>同步API的执行结果可以通过函数返回值直接获取，如果执行出错会抛出异常；<br> 异步API接口接受一个Object类型的参数，Object对象中不包含<code>success/fail/complete</code>时将默认返回 promise，否则仍按回调方式执行，无返回值。</p></li><li><p>尺寸单位rpx（responsive pixel）:可以根据屏幕宽度进行自适应。</p> <figure class="highlight nim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nim"> // 同步<br> <span class="hljs-keyword">try</span> &#123;<br>  wx.setStorageSync(&#x27;key&#x27;, &#x27;value&#x27;)<br> &#125; catch(e) <span class="hljs-meta">&#123;...&#125;</span><br><br>// 异步<br> wx.login(&#123;<br>  success(res) &#123;<br>    ...<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure></li><li><figure class="highlight handlebars"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs handlebars"><span class="language-xml">// 单向数据绑定</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;</span></span></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span>&#125;&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span> /&gt;</span></span><br><span class="language-xml">// 双向数据绑定</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">model:value</span>=<span class="hljs-string">&quot;值为 </span></span></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">value</span>&#125;&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span> /&gt;</span></span><br></code></pre></div></td></tr></table></figure></li><li><p>节点信息查询API可以用于获取节点属性、样式、在界面上的位置等信息</p><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">const query = wx<span class="hljs-selector-class">.createSelectorQuery</span>()<br>query<span class="hljs-selector-class">.select</span>(<span class="hljs-string">&#x27;#the-id&#x27;</span>)<span class="hljs-selector-class">.boundingClientRect</span>(<span class="hljs-built_in">function</span>(res)&#123;<br>  res<span class="hljs-selector-class">.top</span> <span class="hljs-comment">// #the-id 节点的上边界坐标（相对于显示区域）</span><br>&#125;)<br>query<span class="hljs-selector-class">.selectViewport</span>()<span class="hljs-selector-class">.scrollOffset</span>(<span class="hljs-built_in">function</span>(res)&#123;<br>  res<span class="hljs-selector-class">.scrollTop</span> <span class="hljs-comment">// 显示区域的竖直滚动位置</span><br>&#125;)<br>query<span class="hljs-selector-class">.exec</span>()<br></code></pre></div></td></tr></table></figure></li></ol><h4 id="路阻且长，还得走"><a href="#路阻且长，还得走" class="headerlink" title="路阻且长，还得走"></a>路阻且长，还得走</h4><ol><li>引入TDDesign，编译之后，出现<code>WAServiceMainContext.js:2 Error: module &quot;miniprogram_npm/tdesign-miniprogram/toast/props.js&quot; is not defined</code>，关闭重启dev tools即可。</li></ol><p><code>附录</code>学习资料<br><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/">wx官网</a><br><a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/project.html#%E6%9C%AC%E5%9C%B0%E8%AE%BE%E7%BD%AE">wx开发者工具</a><br><a href="https://tdesign.tencent.com/miniprogram/components/icon">tddesign</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>wx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MAC终端配置</title>
    <link href="/2022/09/15/MAC%E7%BB%88%E7%AB%AF%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/09/15/MAC%E7%BB%88%E7%AB%AF%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<blockquote><p>用了7年MBP终于要准备退休了，新电脑到手重新配置一下开发环境，稍微做个记录。</p></blockquote><span id="more"></span><h3 id="git显示分支-amp-大小写补全"><a href="#git显示分支-amp-大小写补全" class="headerlink" title="git显示分支 &amp; 大小写补全"></a>git显示分支 &amp; 大小写补全</h3><p>zsh 终端设置</p><figure class="highlight shell"><table><tr><td class="gutter hljs hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi ~/.zshrc<br></code></pre></div></td></tr></table></figure><p>写入以下语句</p><figure class="highlight bash"><table><tr><td class="gutter hljs hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># git显示分支</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">parse_git_branch</span></span>() &#123;<br>    git branch 2&gt; /dev/null | sed -n -e <span class="hljs-string">&#x27;s/^\* \(.*\)/[\1]/p&#x27;</span><br>&#125;<br><br><span class="hljs-built_in">setopt</span> PROMPT_SUBST<br><span class="hljs-built_in">export</span> PROMPT=<span class="hljs-string">&#x27;%F&#123;grey&#125;%n%f %F&#123;cyan&#125;%~%f %F&#123;green&#125;$(parse_git_branch)%f %F&#123;normal&#125;$%f &#x27;</span><br><br><span class="hljs-comment"># 大小写补全</span><br><span class="hljs-built_in">autoload</span> -Uz compinit &amp;&amp; compinit<br><span class="hljs-built_in">zstyle</span> <span class="hljs-string">&#x27;:completion:*&#x27;</span> matcher-list <span class="hljs-string">&#x27;m:&#123;a-z&#125;=&#123;A-Z&#125;&#x27;</span><br></code></pre></div></td></tr></table></figure><p>重启终端或通过 source 命令生效</p><figure class="highlight shell"><table><tr><td class="gutter hljs hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">source ~/.zshrc<br></code></pre></div></td></tr></table></figure><p><code>附录</code>资料<br><a href="https://blog.csdn.net/weixin_39802884/article/details/121723889">MacOS 上 oh-my-zsh 安装与卸载</a><br><a href="https://copyfuture.com/blogs-details/20210413165715428a">终端显示出git分支</a><br><a href="https://blog.csdn.net/sl285720967/article/details/122510493">大小写补全</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>问题解决备忘</title>
    <link href="/2022/09/07/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E5%A4%87%E5%BF%98/"/>
    <url>/2022/09/07/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E5%A4%87%E5%BF%98/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录一下问题解决</p></blockquote><span id="more"></span><h3 id="css"><a href="#css" class="headerlink" title="css"></a>css</h3><ol><li><p>下拉列表显示模糊问题<br>项目里用了一个select组件，如下图所示，下拉时发现字体模糊了：<br><img src="/img/q-css1.png" alt="blur1"><br>查看元素，发现去掉transform后字体模糊消失了：<br><img src="/img/q-css2.png" alt="blur2"><br>查阅资料后发现，通过 <code>transform:translate(X,Y)</code> 偏移元素可以达到定位的效果，但是如果元素内部有字体的话，会出现模糊的问题。<br>解决方案：给translate的Y值偏移设为绝对单位。</p></li><li></li></ol><h3 id="js"><a href="#js" class="headerlink" title="js"></a>js</h3><ol><li>0 &#x3D;&#x3D; ‘’ 返回true，在detail为空显示‘–’一定要注意要使用&#x3D;&#x3D;&#x3D;</li></ol><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><ol><li>UMS 中同步了新配置，结果本地运行没问题，打包时候报错了如下：<code>FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory</code> 居然还有爆栈这种操作。<br><img src="/img/q-deploy1.jpg" alt="out of memory"><br>解决方案：去掉 legacy 插件。</li></ol><h3 id="vue3-写法"><a href="#vue3-写法" class="headerlink" title="vue3 写法"></a>vue3 写法</h3><ol><li>页面跳转需要刷新才能显示<br>解决方案：只有一个根标签，不能有并排的el-dialog</li><li>首次进入 el-tree 指定节点没有高亮<br>解决方案：数据加载完成之后使用 setCurrentKey ，若还有问题，加上 nextTick()</li></ol><h3 id="AI平台代码学习"><a href="#AI平台代码学习" class="headerlink" title="AI平台代码学习"></a>AI平台代码学习</h3><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><p>|– console-frontend<br>    |– .env.dev                # 开发环境配置<br>    |– .env.prod               # 生产环境配置<br>    |– .env.test               # 测试环境配置<br>    |– .eslintrc.js            # eslint配置<br>    |– .prettierignore<br>    |– .stylelintignore<br>    |– .gitignore<br>    |– README.md<br>    |– buildVersion.js         # 打包更新package.json版本、时间<br>    |– commitlint.config.js    # git提交规则<br>    |– index.html<br>    |– package.json            # package.json 依赖<br>    |– postcss.config.js       # postcss配置<br>    |– prettier.config.js      # prettier配置<br>    |– stylelint.config.js     # stylelint配置<br>    |– vite.config.ts          # vite配置<br>    |– tsconfig.json           # typescript配置<br>    |– public                  # 静态资源 (会被直接复制)<br>    |   |– favicon.ico         # favicon图标<br>    |   |– config.js           # casdoor全局配置（根据环境）<br>    |– src<br>    |   |– App.vue             # 入口页面（设置背景色、主题色）<br>    |   |– main.ts             # 入口文件（加载组件、casdoor配置、初始化等）<br>    |   |– permission.ts       # 路由守卫（权限跳转）<br>    |   |– api                 # 所有请求（分模块-部分请求数据处理也在这部分）<br>    |   |– assets              # 静态资源<br>    |   |– config              # 全局配置<br>    |       |– axios           # axios封装（请求头部、请求参数编码、返回值错误）<br>    |   |– components          # 全局组件<br>    |       |– breadcrumb      # 导航面包屑<br>    |       |– echart          # 封装图表<br>    |       |– form            # 封装表单（对checkbox、radio、select做了二次封装）<br>    |           |– src<br>    |               |– components  # 表单中使用到的组件二开<br>    |               |– component-map.ts  # 引入自定义组件（types&#x2F;components.d.ts添加组件名称）<br>    |           |– index.ts    # 方法导出<br>    |       |– table           # 表格组件（文件结构同form）<br>    |       |– search          # 搜索组件<br>    |   |– hooks<br>    |       |– events          # 事件钩子（scroll）<br>    |       |– web             # 页面钩子<br>    |            |– use-form.ts  # form组件的使用<br>    |            |– use-table.ts # table组件的使用<br>    |            |– use-draw.ts  # 绘图（窗口改变重绘）<br>    |   |– router              # 路由<br>    |   |– store               # 全局 vuex store<br>    |   |– utils<br>    |       |– date-format.ts  # 日期规范<br>    |       |– cookies.ts      # token使用封装<br>    |   |– views               # 所有页面<br>    |       |– layout          # 主要样式<br>    |            |– components # 包含main、footer、sidebar<br>    |            |– basic.vue  # 基本样式<br>    |            |– simple.vue # 简单样式<br>    |            |– preview.vue# fullscreen全屏模式<br>    |            |– index.ts   # 样式导出<br>    |       |– manage          # 根据模块分文件夹编写页面，页面中切组件加入文件夹下的components中<br>    |       |– login           # 登录页面</p><h3 id="接口压测"><a href="#接口压测" class="headerlink" title="接口压测"></a>接口压测</h3><p>i.   安装python 版本3.9 或3.8<br>ii.  安装pip插件 (有些自带)<br>iii. 使用pip安装locust 命令：pip install locust。 <br>iv.  执行脚本：locust -f xxx.py <br>    （每个脚本对应一个服务，一个脚本中有多个接口，每个task是一个接口的，每次只解开一个接口的注释，压测一个接口）<br>v.   注意环境变量（mac,和win的处理方式不同）</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">vi ~/.bash_profile<br>source ~/.bash_profile<br></code></pre></div></td></tr></table></figure><h3 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h3><ol><li>项目整体启动较慢，暂时无法解决。<h4 id="vscode-插件问题"><a href="#vscode-插件问题" class="headerlink" title="vscode 插件问题"></a>vscode 插件问题</h4>背景：一年前配置环境时，出现了插件冲突，导致无法正常使用，由于加入了现在的团队，要继续开发，所以现在想重新配置环境。<br>项目采用动态导入的方式，可以按需加载组件，运行至当前模块时，vite-plugin-eslint 报错格式错误，但是重启时又相当浪费时间。<code>npm run lint:format</code>比较适合于全局格式化代码，简单修改就启动成本较高。最好能在保存时自动格式化。<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm run lint:format<br>npm run dev --fix<br></code></pre></div></td></tr></table></figure>解决方案：启用“eslint”“prettier”，右键“使用…格式化文档”，选择“prettier:format”，启用后右键“格式化文档”即可保证当前文件格式化。<br>Q：已经配置了formatOnSave，但是没有生效。</li></ol><h4 id="代码记录"><a href="#代码记录" class="headerlink" title="代码记录"></a>代码记录</h4><ol><li>select单选选中选项为黑色：计费中心-商品列表-编辑商品-规格选择</li><li>表单中有正常项（使用schema）和表格选择：计费中心-产品列表-创建产品，其中表格选择写成单独的组件，expose validate 和 resetFields 方法，在整个表单 validator 之后调用。注意 defineEmits ，组件表格变化时，触发父组件的事件。</li><li>下拉列表可输入：数据集管理-标签</li><li>下拉列表+输入：计费中心-产品列表</li><li>批量操作：告警规则</li><li>点击复制：模型开发调试-环境详情，SSH登录命令</li><li>联级选择：模型开发调试-最上方右侧</li><li>数字选择：集群概览-存储配置</li><li>折线图：集群概览；饼图：集群概览、租户管理；</li><li>xterm：train&#x2F;log&#x2F;index.vue；</li><li>websock：train&#x2F;log&#x2F;index.vue；</li><li>导出：操作审计</li><li>下载中弹窗硬控几秒：推理详情</li><li>表格的另一种写法：数据集管理-数据集详情-文件列表</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（11）加载更多</title>
    <link href="/2022/08/23/vue3%E7%AC%94%E8%AE%B0%EF%BC%8811%EF%BC%89%E5%8A%A0%E8%BD%BD%E6%9B%B4%E5%A4%9A/"/>
    <url>/2022/08/23/vue3%E7%AC%94%E8%AE%B0%EF%BC%8811%EF%BC%89%E5%8A%A0%E8%BD%BD%E6%9B%B4%E5%A4%9A/</url>
    
    <content type="html"><![CDATA[<blockquote><p>业务需求，下拉列表点击“加载更多”请求下一页数据。<br>加载返回数据太多时，会造成卡顿，因此需要一个滚动加载的方法。</p></blockquote><span id="more"></span><h3 id="自定义指令"><a href="#自定义指令" class="headerlink" title="自定义指令"></a>自定义指令</h3><p>在Vue中，代码复用和抽象的主要形式是组件。然而，有的情况下仍然需要对普通DOM元素进行底层操作，这时候就会用到自定义指令。<br>自定义指令是Vue提供给我们用原生DOM封装一系列DOM相关功能、视图变化的一个接口(API)。</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>在<code>main.ts</code>中定义一个指令，用于内容的插入。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 滚动加载更多</span><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">&#x27;loadMore&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">el,binding,vNode,prevNode</span>)=&gt;</span> &#123;<br>  <span class="hljs-comment">// bind(el, binding) &#123;</span><br>    <span class="hljs-comment">// 获取element，定义scroll</span><br>    <span class="hljs-keyword">let</span> select_dom = el.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.el-select-dropdown .el-select-dropdown__wrap&#x27;</span>);<br>    select_dom.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">let</span> height = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollHeight</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollTop</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientHeight</span>;<br>      <span class="hljs-keyword">if</span> (height) &#123;<br>        binding.<span class="hljs-title function_">value</span>()<br>      &#125;<br>    &#125;)<br>  <span class="hljs-comment">// &#125;</span><br>&#125;);<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;template&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">v-loadMore</span>=<span class="hljs-string">&quot;loadMore&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in list&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;item.id&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">:label</span>=<span class="hljs-string">&quot;item.name&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">:value</span>=<span class="hljs-string">&quot;item.value&quot;</span>&gt;</span></span><br><span class="language-xml">         <span class="hljs-tag">&lt;/<span class="hljs-name">el-option</span>&gt;</span></span><br><span class="language-xml">     <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span></span><br>&lt;/template&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Setting&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-attr">directives</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml">    loadMore,</span></span><br><span class="language-javascript"><span class="language-xml">  &#125;,</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) &#123;  </span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-comment">// API </span></span></span><br><span class="language-javascript"><span class="language-xml">    &#125;</span></span><br><span class="language-javascript"><span class="language-xml">    </span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadMore</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      <span class="hljs-title function_">getData</span>();</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml">    <span class="hljs-keyword">return</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml">      loadMore,</span></span><br><span class="language-javascript"><span class="language-xml">    &#125;</span></span><br><span class="language-javascript"><span class="language-xml">  &#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;);</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><br></code></pre></div></td></tr></table></figure><h4 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h4><ol><li><p>el.querySelector找不到元素，只有el-select，没有找到el-option。<br>原因：el-option不在el-select元素的范围内。<br>解决方案：换成document.querySelector</p></li><li><p>监听器没有执行，是没有绑定上？？？，或者是有多个，，多个怎么操作</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>egg笔记（1）</title>
    <link href="/2022/08/10/egg%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/"/>
    <url>/2022/08/10/egg%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>有个业务需求必须写个后端做逻辑处理，大佬告知周围用egg框架的较多，就选这个了！<br>作为一个前后端分离项目，仅做一个登录逻辑的处理，使用restful API，不涉及前端模版渲染，这篇简单记录下使用。</p></blockquote><span id="more"></span><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>使用简单模式初始化框架，中间选择ts，</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> demo &amp;&amp; <span class="hljs-built_in">cd</span> demo<br>npm init egg --<span class="hljs-built_in">type</span>=simple<br>npm install<br></code></pre></div></td></tr></table></figure><h3 id="跨域设置"><a href="#跨域设置" class="headerlink" title="跨域设置"></a>跨域设置</h3><p>安装egg-cors</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">npm install  egg-cors --save<br></code></pre></div></td></tr></table></figure><p>配置plugin.ts</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">EggPlugin</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;egg&#x27;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-attr">plugin</span>: <span class="hljs-title class_">EggPlugin</span> = &#123;<br>  <span class="hljs-attr">cors</span>: &#123;<br>    <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">package</span>: <span class="hljs-string">&#x27;egg-cors&#x27;</span>,<br>  &#125;<br>&#125;;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> plugin;<br></code></pre></div></td></tr></table></figure><p>配置config.default.ts</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">config.<span class="hljs-property">security</span> = &#123;<br>  <span class="hljs-attr">csrf</span>: &#123;<br>    <span class="hljs-attr">enable</span>: <span class="hljs-literal">false</span>,<br>  &#125;,<br>  <span class="hljs-attr">domainWhiteList</span>: [<span class="hljs-string">&#x27;*&#x27;</span>],<span class="hljs-comment">//允许访问接口的白名单，例如：http://localhost:8080 *表示均可访问</span><br>&#125;;<br>config.<span class="hljs-property">cors</span> = &#123;<br>  <span class="hljs-attr">origin</span>: <span class="hljs-string">&#x27;*&#x27;</span>,<br>  <span class="hljs-attr">allowMethods</span>: <span class="hljs-string">&#x27;GET,HEAD,PUT,POST,DELETE,PATCH,OPTIONS&#x27;</span>,<br>  <span class="hljs-attr">credentials</span>:<span class="hljs-literal">true</span><span class="hljs-comment">//允许前端带cookie</span><br>&#125;;<br></code></pre></div></td></tr></table></figure><p><code>附录</code>学习资料<br><a href="https://eggjs.github.io/zh">egg官网</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>egg</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（10-2）mock数据-vite</title>
    <link href="/2022/07/14/vue3%E7%AC%94%E8%AE%B0%EF%BC%8810-2%EF%BC%89mock%E6%95%B0%E6%8D%AE-vite/"/>
    <url>/2022/07/14/vue3%E7%AC%94%E8%AE%B0%EF%BC%8810-2%EF%BC%89mock%E6%95%B0%E6%8D%AE-vite/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇是上一篇的另一种实现，框架更新后，使用vite+pinia，自然mock数据也要跟上。基于vite-plugin-mock实现开发。</p></blockquote><span id="more"></span><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><h4 id="1-安装vite-plugin-mock包"><a href="#1-安装vite-plugin-mock包" class="headerlink" title="1. 安装vite-plugin-mock包"></a>1. 安装vite-plugin-mock包</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">npm i vite-plugin-mock<br></code></pre></div></td></tr></table></figure><h4 id="2-在vite-config-ts中添加插件"><a href="#2-在vite-config-ts中添加插件" class="headerlink" title="2. 在vite.config.ts中添加插件"></a>2. 在vite.config.ts中添加插件</h4><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; viteMockServe &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite-plugin-mock&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">&#123; mode &#125;: ConfigEnv</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">plugins</span>: [<br>      <span class="hljs-comment">// 配置mock</span><br>      <span class="hljs-title function_">viteMockServe</span>(&#123;<br>        <span class="hljs-attr">mockPath</span>: <span class="hljs-string">&#x27;src/mock&#x27;</span>,<br>        <span class="hljs-attr">localEnabled</span>: <span class="hljs-literal">true</span>,<br>      &#125;),<br>    ],<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><h4 id="3-新建mock文件夹"><a href="#3-新建mock文件夹" class="headerlink" title="3. 新建mock文件夹"></a>3. 新建mock文件夹</h4><p><code>mock/index.ts</code>中存放mock的API列表</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MockMethod</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite-plugin-mock&#x27;</span><br><br><span class="hljs-comment">// 数组中存放多个请求</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">mockList</span>: <span class="hljs-title class_">MockMethod</span>[] = [<br>  &#123;<br>    <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/mock/menu&#x27;</span>,<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;get&#x27;</span>, <span class="hljs-comment">// 请求方式</span><br>    <span class="hljs-attr">statusCode</span>: <span class="hljs-number">200</span>, <span class="hljs-comment">// 返回的http状态码</span><br>    <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">opt</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// opt 对象中包含 url  body  query  headers</span><br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-comment">// 返回的结果集</span><br>        <span class="hljs-attr">status</span>: <span class="hljs-number">200</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;登录成功&#x27;</span>,<br>        <span class="hljs-attr">data</span>: [<br>          &#123;<br>            <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dash3&#x27;</span>,<br>            <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;dash3&#x27;</span>,<br>            <span class="hljs-attr">component</span>: <span class="hljs-string">&#x27;BasicLayout&#x27;</span>,<br>            <span class="hljs-attr">meta</span>: &#123;<br>              <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;动态管理3&#x27;</span>,<br>              <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;userm&#x27;</span>,<br>              <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,<br>              <span class="hljs-attr">level</span>: <span class="hljs-number">1</span><br>            &#125;,<br>            <span class="hljs-attr">children</span>: [<br>              &#123;<br>                <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;dash3&#x27;</span>,<br>                <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dash3&#x27;</span>,<br>                <span class="hljs-attr">component</span>: <span class="hljs-string">&#x27;test&#x27;</span>,<br>                <span class="hljs-attr">fold</span>: <span class="hljs-string">&#x27;home&#x27;</span><br>              &#125;<br>            ]<br>          &#125;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>]<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> mockList<br></code></pre></div></td></tr></table></figure><h4 id="4-写请求"><a href="#4-写请求" class="headerlink" title="4. 写请求"></a>4. 写请求</h4><p><code>api/user.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserRoutes</span> = (<span class="hljs-params">params: any</span>) =&gt; request.<span class="hljs-title function_">get</span>(&#123; <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/mock/menu&#x27;</span>, params &#125;)<br></code></pre></div></td></tr></table></figure><h4 id="5-开启"><a href="#5-开启" class="headerlink" title="5. 开启"></a>5. 开启</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">npm run dev<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（10-1）mock数据-mockjs</title>
    <link href="/2022/07/14/vue3%E7%AC%94%E8%AE%B0%EF%BC%8810-1%EF%BC%89mock%E6%95%B0%E6%8D%AE-mockjs/"/>
    <url>/2022/07/14/vue3%E7%AC%94%E8%AE%B0%EF%BC%8810-1%EF%BC%89mock%E6%95%B0%E6%8D%AE-mockjs/</url>
    
    <content type="html"><![CDATA[<blockquote><p>mock数据的好处，万一遇到居家办公，本地就能完成开发。<br>本篇基于mockjs开发。</p></blockquote><span id="more"></span><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><h4 id="1-安装mockjs包"><a href="#1-安装mockjs包" class="headerlink" title="1. 安装mockjs包"></a>1. 安装mockjs包</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">npm install mockjs --save<br></code></pre></div></td></tr></table></figure><h4 id="2-修改-env-dev"><a href="#2-修改-env-dev" class="headerlink" title="2. 修改.env.dev"></a>2. 修改<code>.env.dev</code></h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">NODE_ENV = <span class="hljs-string">&#x27;development&#x27;</span><br>VUE_APP_TITLE = <span class="hljs-string">&#x27;development&#x27;</span><br>VUE_APP_INTERFACE_URL=<span class="hljs-string">&quot;/&quot;</span><br>VUE_APP_PROXYURL=<span class="hljs-string">&#x27;/&#x27;</span><br>VUE_APP_MOCK = <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure><h4 id="3-新建mock文件夹"><a href="#3-新建mock文件夹" class="headerlink" title="3. 新建mock文件夹"></a>3. 新建mock文件夹</h4><p>3.1 <code>@/mock/api/</code>存放<code>***.json</code>文件，为API文件。<br>3.2 <code>@/mock/utils/</code>存放mock相关代码。<br><code>formatOptions.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> qs <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;qs&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatOptions</span>(<span class="hljs-params">options</span>) &#123;<br>  <span class="hljs-keyword">let</span> &#123; url, type, body &#125; = options;<br>  <span class="hljs-keyword">let</span> params = <span class="hljs-literal">null</span>;<br>  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&quot;GET&quot;</span> || type === <span class="hljs-string">&quot;DELETE&quot;</span>) &#123;<br>    <span class="hljs-keyword">let</span> index = url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;?&quot;</span>);<br>    <span class="hljs-keyword">let</span> paramsString = index &gt; -<span class="hljs-number">1</span> ? url.<span class="hljs-title function_">slice</span>(index + <span class="hljs-number">1</span>) : <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span> (paramsString !== <span class="hljs-string">&quot;&quot;</span>) &#123;<br>      params = qs.<span class="hljs-title function_">parse</span>(paramsString);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    params = &#123;&#125;;<br>    <span class="hljs-keyword">if</span> (body <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">FormData</span>) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [key, value] <span class="hljs-keyword">of</span> body.<span class="hljs-title function_">entries</span>()) &#123;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        params = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(body);<br>      &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>        params = qs.<span class="hljs-title function_">parse</span>(body);<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (params !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(params).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) &#123;<br>    params = <span class="hljs-literal">null</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> &#123; url, type, params &#125;;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>mock.ts</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Mock</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;mockjs&quot;</span>;<br><span class="hljs-keyword">import</span> formatOptions <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./formatOptions&quot;</span>;<br><br><span class="hljs-title class_">Mock</span>.<span class="hljs-property">_mock</span> = <span class="hljs-title class_">Mock</span>.<span class="hljs-property">mock</span>;<br><span class="hljs-title class_">Mock</span>.<span class="hljs-property">mock</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">url, method, resFunc</span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_mock</span>(url);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<br>      <span class="hljs-string">&quot;Function Mock.mock require three params: url, method, resFunc!!!&quot;</span><br>    );<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">3</span>) &#123;<br>    <span class="hljs-keyword">let</span> methods = [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;post&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>];<br>    <span class="hljs-keyword">if</span> (!methods.<span class="hljs-title function_">includes</span>(method.<span class="hljs-title function_">toLowerCase</span>())) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<br>        <span class="hljs-string">&quot;Function Mock.mock&#x27;s second param should be get, post, put, delete!!!&quot;</span><br>      );<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resFunc !== <span class="hljs-string">&quot;function&quot;</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Function Mock.mock&#x27;s third param should be a function!!!&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 将注册的 url 转成能匹配查询字符串的正则</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> url === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>    url = url.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">&quot;\\/&quot;</span>);<br>    url += <span class="hljs-string">&quot;(|\\?.*)$&quot;</span>;<br>    url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(url);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(url <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>)) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<br>      <span class="hljs-string">&quot;Function Mock.mock&#x27;s first param should be a string or regexp!!!&quot;</span><br>    );<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_mock</span>(url, method, <span class="hljs-keyword">function</span> (<span class="hljs-params">options</span>) &#123;<br>    <span class="hljs-comment">// 格式化 options 对象</span><br>    options = <span class="hljs-title function_">formatOptions</span>(options);<br>    <span class="hljs-keyword">let</span> res = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      res = <span class="hljs-title function_">resFunc</span>(options);<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      res = err;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>  &#125;);<br>&#125;;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Mock</span>;<br></code></pre></div></td></tr></table></figure><p>3.3 <code>@/mock/index.ts</code>为开启mock的主要文件。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Mock</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./utils/mock&quot;</span>;<br><br><span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">setup</span>(&#123; <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span> &#125;);<br><span class="hljs-keyword">import</span> getgenInfoJSON <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/mock/api/getgenInfo.json&quot;</span>;<br><br><span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>(<span class="hljs-string">&quot;http://0.0.0.0:8080/api/v1/getgenInfo&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> getgenInfoJSON;<br>&#125;);<br></code></pre></div></td></tr></table></figure><h4 id="4-在AppMain-vue中按环境引入"><a href="#4-在AppMain-vue中按环境引入" class="headerlink" title="4. 在AppMain.vue中按环境引入"></a>4. 在AppMain.vue中按环境引入</h4><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">VUE_APP_MOCK</span>) &#123;<br>  <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;@/mock/index&quot;</span>) <br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="5-开启"><a href="#5-开启" class="headerlink" title="5. 开启"></a>5. 开启</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">npm run dev<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>flex备忘</title>
    <link href="/2022/07/11/flex%E5%A4%87%E5%BF%98/"/>
    <url>/2022/07/11/flex%E5%A4%87%E5%BF%98/</url>
    
    <content type="html"><![CDATA[<blockquote><p>维护老代码很麻烦的一点就是布局，改来改去还是决定全部改成flex，这篇记录下flex的一般用法，以备以后使用。<br>记住设为Flex布局以后，子元素的float、clear和vertical-align属性将失效。</p></blockquote> <span id="more"></span><h4 id="弹性盒子"><a href="#弹性盒子" class="headerlink" title="弹性盒子"></a>弹性盒子</h4><p> display:flex 是一种布局方式。它即可以应用于容器中，也可以应用于行内元素。</p><p>容器默认存在两根轴：水平的主轴（main axis）和垂直的交叉轴（cross axis）。<br>采用Flex布局的元素，称为Flex容器（flex container），简称”容器”。它的所有子元素自动成为容器成员，称为Flex项目（flex item）</p><h4 id="container属性"><a href="#container属性" class="headerlink" title="container属性"></a>container属性</h4><ol><li><p>flex-direction<br>定义主轴的方向（即项目的排列方向）<br>column-reverse：主轴为垂直方向，起点在下沿<br>column：主轴为垂直方向，起点在上沿<br>row（默认值）：主轴为水平方向，起点在左端<br>row-reverse：主轴为水平方向，起点在右端</p></li><li><p>flex-wrap<br>定义项目是否换行以及如何换行<br>nowrap：不换行<br>wrap：换行，第一行在上方<br>wrap-reverse：换行，第一行在下方</p></li><li><p>justify-content<br>定义项目在主轴上的对齐方式<br>flex-start（默认值）：左对齐<br>flex-end：右对齐<br>center：居中<br>space-between：两端对齐，项目之间的间隔都相等。<br>space-around：每个项目两侧的间隔相等。所以，项目之间的间隔比项目与边框的间隔大一倍</p></li><li><p>align-items<br>定义项目在竖直方向上对齐方式<br>flex-start：交叉轴的起点对齐。<br>flex-end：交叉轴的终点对齐。<br>center：交叉轴的中点对齐。<br>baseline: 项目的第一行文字的基线对齐。<br>stretch（默认值）：如果项目未设置高度或设为auto，将占满整个容器的高度</p></li><li><p>align-content<br>定义多根轴线的对齐方式，如果项目只有一根轴线，该属性不起作用<br>flex-start：与交叉轴的起点对齐。<br>flex-end：与交叉轴的终点对齐。<br>center：与交叉轴的中点对齐。<br>space-between：与交叉轴两端对齐，轴线之间的间隔平均分布。<br>space-around：每根轴线两侧的间隔都相等。所以，轴线之间的间隔比轴线与边框的间隔大一倍。<br>stretch（默认值）：轴线占满整个交叉轴。</p></li></ol><h4 id="item属性"><a href="#item属性" class="headerlink" title="item属性"></a>item属性</h4><ol><li><p>order<br>定义项目的排列顺序。数值越小，排列越靠前，默认为0</p></li><li><p>flex-grow<br>定义项目的放大比例，默认为0，即如果存在剩余空间，也不放大<br>如果所有项目的flex-grow属性都为1，则它们将等分剩余空间（如果有的话）。如果一个项目的flex-grow属性为2，其他项目都为1，则前者占据的剩余空间将比其他项多一倍。</p></li><li><p>flex-shrink<br>定义项目的缩小比例，默认为1，即如果空间不足，该项目将缩小<br>如果所有项目的flex-shrink属性都为1，当空间不足时，都将等比例缩小。如果一个项目的flex-shrink属性为0，其他项目都为1，则空间不足时，前者不缩小。<br>负值对该属性无效。</p></li><li><p>flex-basis<br>定义了在分配多余空间之前，项目占据的主轴空间（main size）<br>浏览器根据这个属性，计算主轴是否有多余空间。它的默认值为auto，即项目的本来大小。<br>它可以设为跟width或height属性一样的值（比如350px），则项目将占据固定空间。</p></li><li><p>align-self<br>允许单个项目有与其他项目不一样的对齐方式，可覆盖align-items属性。默认值为auto，表示继承父元素的align-items属性，如果没有父元素，则等同于stretch。</p></li></ol><h4 id="实战问题"><a href="#实战问题" class="headerlink" title="实战问题"></a>实战问题</h4><p>需要实现两个固定大小的盒子摆放，当页面宽度变小时，盒子自动垂直摆放。大概效果如下所示：<br><img src="/../img/flex-1.png" alt="两个盒子排放"></p><p>方案一：容器按照中间对齐，盒子分别与中轴线隔开一段距离。</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">justify-content</span>: center;<br>  <span class="hljs-attribute">flex-wrap</span>: wrap;<br>&#125;<br><span class="hljs-selector-class">.box</span> &#123;<br>  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">0</span> <span class="hljs-number">1rem</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>方案二：容器按照左中右分隔。<br>如果直接使用space-between，则会出现中间是左右两边的2倍距，和设计稿差距较大，舍弃；<br>实验时发现一个神奇的space-evenly，可以实现左中右距离相等，但是查阅资料以后发现兼容性比较差（etc:iphone的SE上不支持），舍弃；<br>最后决定使用特殊方法模拟space-evenly。<br>出现问题：当垂直排列时，奇数盒子紧贴右侧，偶数盒子紧贴左侧。</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">flex-wrap</span>: wrap;<br>  <span class="hljs-attribute">align-items</span>: center;<br>  <span class="hljs-attribute">justify-content</span>: space-between;<br>    &amp;<span class="hljs-selector-pseudo">:before</span>,<br>    &amp;<span class="hljs-selector-pseudo">:after</span> &#123;<br>        <span class="hljs-attribute">content</span>: <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-attribute">display</span>: block;<br>  &#125;<br>&#125;<br><span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">:nth-child</span>(even) &#123;<br>  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">1rem</span>;<br>&#125;<br><span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">:nth-child</span>(odd) &#123;<br>  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">1rem</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（9）scss配置</title>
    <link href="/2022/07/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%889%EF%BC%89scss%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/07/04/vue3%E7%AC%94%E8%AE%B0%EF%BC%889%EF%BC%89scss%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<blockquote><p>有个需求是网页的整体配色需要和公司官网一致，在这里我使用scss写样式代码，需要全局引入颜色样式，以便在各个组件中使用。<br>这篇记录scss样式引入及使用。</p></blockquote><span id="more"></span><h4 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h4><p>使用<code>vue-cli</code>创建项目时，可以选择使用scss，相关的配置会自动加入<code>package.json</code>，检查是否含有以下两项：</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-attr">&quot;devDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;sass&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^1.32.7&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;sass-loader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^12.0.0&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></div></td></tr></table></figure><h4 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h4><p>在本项目中，<code>assets/scss/_variables.scss</code>文件中编写颜色样式。</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">$text-yellow: yellow;<br></code></pre></div></td></tr></table></figure><p>方法一：单组件引入<br>可用的写法：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">&lt;style lang=<span class="hljs-string">&quot;scss&quot;</span> scoped&gt;<br>@<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;../../assets/scss/_variables.scss&quot;</span>;<br>span &#123;<br>  <span class="hljs-attr">color</span>: $text-yellow;<br>&#125;<br>&lt;/style&gt;<br></code></pre></div></td></tr></table></figure><p>如果报错”Undefined variable. root stylesheet”，说明文件没有引入成功；<br>如果报错”Can’t find stylesheet to import. root stylesheet”，说明引入的文件路径有问题；<br>不知道为什么下面这个写法会报错，显示无法找到文件。</p><p>方法二：整体引入<br>如果在每个组件中引入一次，稍微有点麻烦。按照我这里的设计，最好是整体引入，每个组件中都能使用。查阅一些资料后，发现可以在<code>vue.config.js</code>中这样写：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> &#123; defineConfig &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;@vue/cli-service&quot;</span>);<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">css</span>: &#123;<br>    <span class="hljs-attr">loaderOptions</span>: &#123;<br>      <span class="hljs-attr">sass</span>: &#123;<br>        <span class="hljs-attr">additionalData</span>: <span class="hljs-string">`@import &quot;@/assets/scss/_variables.scss&quot;;`</span>,<br>      &#125;,<br>    &#125;,<br>  &#125;,<br>&#125;);<br></code></pre></div></td></tr></table></figure><p>重启项目，更改成功！</p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（8）组件复用</title>
    <link href="/2022/05/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%888%EF%BC%89%E7%BB%84%E4%BB%B6%E5%A4%8D%E7%94%A8/"/>
    <url>/2022/05/16/vue3%E7%AC%94%E8%AE%B0%EF%BC%888%EF%BC%89%E7%BB%84%E4%BB%B6%E5%A4%8D%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>一般来说，新增和编辑基本校验规则相同，我进行了组件复用。<br>这篇记录组件复用过程中遇到的问题</p></blockquote><span id="more"></span><h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>在更新任务时，我复用了新建任务的组件，通过url携带参数，填充表单。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">router.<span class="hljs-title function_">push</span>(&#123;<br>  <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/taskcreate&#x27;</span>,<br>  <span class="hljs-attr">query</span>: &#123; <span class="hljs-attr">params</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(row) &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>新建任务拥有单独的侧栏，当处于更新任务状态时，若点击“新建任务”，url发生改变，但是组件状态没有变化。具体表现如下图所示：<br><img src="/../img/vue3-8-1.png" alt="更新任务"><br><img src="/../img/vue3-8-2.png" alt="新建任务"></p><p>方法一：使用watch观察参数变化</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  state.<span class="hljs-property">TaskForm</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(emyptForm));<br>  <span class="hljs-title function_">getDataServer</span>();<br>  <span class="hljs-title function_">watch</span>(route.<span class="hljs-property">query</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">getDataServer</span>();<br>  &#125;, &#123; <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> &#125;)<br>&#125;);<br></code></pre></div></td></tr></table></figure><p>此时点击“新建任务”，url发生改变，但是watch并没有监测到参数变化，此方法不管用。</p><p>方法二：使用<code>onBeforeRouteUpdate</code>路由API</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">onBeforeRouteUpdate</span>(<span class="hljs-function">(<span class="hljs-params">to</span>) =&gt;</span> &#123;<br>  state.<span class="hljs-property">TaskForm</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(emyptForm));<br>  <span class="hljs-title function_">getDataServer</span>();<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>此时点击“新建任务”，url发生改变，<code>onBeforeRouteUpdate</code>执行，页面初始化成功。</p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（7）监听</title>
    <link href="/2022/05/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%887%EF%BC%89%E7%9B%91%E5%90%AC/"/>
    <url>/2022/05/10/vue3%E7%AC%94%E8%AE%B0%EF%BC%887%EF%BC%89%E7%9B%91%E5%90%AC/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇记录vue组件的属性，以及computed, watch, watchEffect的使用区分。</p></blockquote><span id="more"></span><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><h5 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h5><p>computed是计算属性，依赖其它属性值。<br>computed 的值有缓存，只有它依赖的属性值发生改变，下一次获取 computed 的值时才会重新计算。<br>接受一个 <code>getter</code> 函数，并根据 <code>getter</code> 的返回值返回一个不可变的响应式 ref 对象</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">const</span> plusOne = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> + <span class="hljs-number">1</span>)<br></code></pre></div></td></tr></table></figure><p>接受一个具有 <code>get</code> 和 <code>set</code> 函数的对象，用来创建可写的 ref 对象。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">const</span> plusOne = <span class="hljs-title function_">computed</span>(&#123;<br>  <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> + <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> &#123;<br>    count.<span class="hljs-property">value</span> = val - <span class="hljs-number">1</span><br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><h5 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h5><p>watch更多的是「观察」的作用，类似于某些数据的监听回调 ，每当监听的数据变化时都会执行回调进行后续操作。<br>需要侦听特定的数据源，并在单独的回调函数中执行副作用。<br>默认情况下，它是惰性的——即回调仅在侦听源发生变化时被调用。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> num = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>);<br><span class="hljs-title function_">watch</span>(num, <span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;num.value&#125;</span>`</span>&#125;);<br><span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> num.<span class="hljs-property">value</span>, <span class="hljs-function">() =&gt;</span> &#123;&#125;); <span class="hljs-comment">//有返回值的getter函数</span><br><span class="hljs-title function_">watch</span>([a, b], <span class="hljs-function">(<span class="hljs-params">[a, b], [prevA, prevB]</span>) =&gt;</span> &#123;&#125;); <span class="hljs-comment">//多个源</span><br></code></pre></div></td></tr></table></figure><h5 id="watchEffect"><a href="#watchEffect" class="headerlink" title="watchEffect"></a>watchEffect</h5><p>立即执行传入的一个函数，同时响应式追踪其依赖，并在其依赖变更时重新运行该函数。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">(<span class="hljs-params">onInvalidate</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">onInvalidate</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure><h5 id="watch-VS-watchEffect"><a href="#watch-VS-watchEffect" class="headerlink" title="watch VS watchEffect"></a>watch VS watchEffect</h5><p><code>watch</code> 与 <code>watchEffect</code> 在以下方面相同：</p><ol><li>手动停止侦听</li><li>清除副作用 (将 <code>onInvalidate</code> 作为第三个参数传递给回调)</li><li>刷新时机和调试。</li></ol><p>与 <code>watchEffect</code> 相比，<code>watch</code> 允许我们：</p><ol><li>惰性地执行副作用</li><li>更具体地说明应触发侦听器重新运行的状态</li><li>访问被侦听状态的先前值和当前值</li></ol><h3 id="运用场景"><a href="#运用场景" class="headerlink" title="运用场景"></a>运用场景</h3><p>当我们需要进行数值计算，并且依赖于其它数据时，应该使用 computed，因为可以利用 computed 的缓存特性，避免每次获取值时，都要重新计算；</p><p>当我们需要在数据变化时执行异步或开销较大的操作时，应该使用 watch，使用 watch 选项允许我们执行异步操作 (访问一个API)，限制我们执行该操作的频率，并在我们得到最终结果前，设置中间状态。这些都是计算属性无法做到的。</p><h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p><a href="https://v3.cn.vuejs.org/api/computed-watch-api.html#computed">官方文档 Computed 与 watch</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（6-1）echarts图表使用</title>
    <link href="/2022/05/09/vue3%E7%AC%94%E8%AE%B0%EF%BC%886-1%EF%BC%89echarts%E5%9B%BE%E8%A1%A8%E4%BD%BF%E7%94%A8/"/>
    <url>/2022/05/09/vue3%E7%AC%94%E8%AE%B0%EF%BC%886-1%EF%BC%89echarts%E5%9B%BE%E8%A1%A8%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>业务需求中需要实时（最近1分钟）展示数据变化。通过echarts图表注入，定时拉取数据，渲染图表，展示给用户。<br>这篇记录图表使用。</p></blockquote><span id="more"></span><h3 id="插件使用"><a href="#插件使用" class="headerlink" title="插件使用"></a>插件使用</h3><p>vue 中插件使用遵循以下原则：</p><ol><li>插件是一个对象，必须暴露一个 install 方法</li><li>插件本身是一个函数，则它将被视为 install 方法。</li></ol><p> install 方法将以应用实例作为第一个参数被调用。传给 use 的其他 options 参数将作为后续参数传入该安装方法。<br>当在同一个插件上多次调用此方法时，该插件将仅安装一次。</p><h3 id="echart-使用逻辑"><a href="#echart-使用逻辑" class="headerlink" title="echart 使用逻辑"></a>echart 使用逻辑</h3><ol><li>获取 dom 节点</li><li>初始化实例</li><li>在 dom 渲染后进行 <code>setOption</code> 设置<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> chartDom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;main&#x27;</span>)!;<br><span class="hljs-keyword">var</span> myChart = echarts.<span class="hljs-title function_">init</span>(chartDom);<br><span class="hljs-keyword">var</span> <span class="hljs-attr">option</span>: <span class="hljs-title class_">EChartsOption</span>;<br>option = &#123;...&#125;<br>option &amp;&amp; myChart.<span class="hljs-title function_">setOption</span>(option);<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="echarts-插件"><a href="#echarts-插件" class="headerlink" title="echarts 插件"></a>echarts 插件</h3><p>要将 echarts 作为插件在 vue 项目中使用，首先在 <code>index.tsx</code> 中进行 echart 插件的封装，使其符合 vue 组件的使用方式，在生命周期中创建、渲染、更新以及销毁。<br>后续所有传入参数必须遵循 <code>PropsType</code> 中的配置。<br> <code>chartRef</code> 用来指向渲染图表的 DOM 节点。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> theme <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/common/echart/style/theme.js&#x27;</span> <span class="hljs-comment">// 引入默认主题</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;echarts&#x27;</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">PropsType</span> = &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-title class_">String</span>, <span class="hljs-comment">// 图表唯一 id</span><br>  <span class="hljs-attr">className</span>: &#123; <span class="hljs-comment">// 图表类名</span><br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">default</span>: <span class="hljs-string">&#x27;chart&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">width</span>: &#123; <span class="hljs-comment">// 图表宽度</span><br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">require</span>: <span class="hljs-literal">true</span><br>  &#125;,<br>  <span class="hljs-attr">height</span>: &#123; <span class="hljs-comment">// 图表高度</span><br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">require</span>: <span class="hljs-literal">true</span><br>  &#125;,<br>  <span class="hljs-attr">options</span>: &#123; <span class="hljs-comment">// 图表数据项</span><br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,<br>    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> (&#123;&#125;),<br>  &#125;<br>&#125; <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Echarts&#x27;</span>,<br>  <span class="hljs-attr">props</span>: <span class="hljs-title class_">PropsType</span>,<br>  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, &#123; expose &#125;</span>) &#123;<br>    <span class="hljs-keyword">const</span> chartRef = ref&lt;<span class="hljs-title class_">HTMLElement</span>&gt;()<br>    <span class="hljs-keyword">const</span> charts = &#123;<br>      <span class="hljs-attr">chart</span>: <span class="hljs-literal">null</span><br>    &#125;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">initChart</span> = (<span class="hljs-params">data?: any, clearCaching = <span class="hljs-literal">false</span></span>) =&gt; &#123;<br>      <span class="hljs-keyword">if</span> (data || props.<span class="hljs-property">options</span>) &#123;<br>        charts.<span class="hljs-property">chart</span>.<span class="hljs-title function_">setOption</span>(data || props.<span class="hljs-property">options</span>, clearCaching)<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      echarts.<span class="hljs-title function_">registerTheme</span>(<span class="hljs-string">&#x27;myTheme&#x27;</span>, theme) <span class="hljs-comment">// 覆盖默认主题</span><br>      charts.<span class="hljs-property">chart</span> = echarts.<span class="hljs-title function_">init</span>(chartRef.<span class="hljs-property">value</span>, <span class="hljs-string">&#x27;myTheme&#x27;</span>)<br>      <span class="hljs-title function_">initChart</span>()<br>    &#125;)<br><br>    <span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      charts.<span class="hljs-property">chart</span>.<span class="hljs-title function_">dispose</span>()<br>      charts.<span class="hljs-property">chart</span> = <span class="hljs-literal">null</span><br>    &#125;)<br><br>    <span class="hljs-title function_">watch</span>(<br>      <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">options</span>,<br>      <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> &#123;<br>        val &amp;&amp; <span class="hljs-title function_">initChart</span>(val)<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span><br>      &#125;<br>    )<br><br>    <span class="hljs-title function_">expose</span>(&#123; <span class="hljs-comment">// 对外暴露接口</span><br>      chartRef,<br>      initChart<br>    &#125;);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> &#123; id, className, height, width &#125; = props<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;chartRef&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">id</span>=<span class="hljs-string">&#123;id</span> <span class="hljs-attr">as</span> <span class="hljs-attr">string</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">class</span>=<span class="hljs-string">&#123;className</span> <span class="hljs-attr">as</span> <span class="hljs-attr">string</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          &#x27;<span class="hljs-attr">height</span>&#x27;<span class="hljs-attr">:</span> <span class="hljs-attr">height</span> <span class="hljs-attr">as</span> <span class="hljs-attr">string</span>,</span></span><br><span class="hljs-tag"><span class="language-xml">          &#x27;<span class="hljs-attr">width</span>&#x27;<span class="hljs-attr">:</span> <span class="hljs-attr">width</span> <span class="hljs-attr">as</span> <span class="hljs-attr">string</span></span></span><br><span class="hljs-tag"><span class="language-xml">        &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>在 <code>componentInstall.ts</code> 中定义一个有 install 方法的 component 组件对象</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> type &#123; <span class="hljs-title class_">DefineComponent</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Echart</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./echartCanvas/index&#x27;</span><br><br><span class="hljs-keyword">const</span> component = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>)<br><br>component.<span class="hljs-property">install</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">vue: DefineComponent</span>) &#123;<br>  vue.<span class="hljs-title function_">component</span>(<span class="hljs-string">&#x27;echart&#x27;</span>, <span class="hljs-title class_">Echart</span>)<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> component<br></code></pre></div></td></tr></table></figure><p>在 <code>main.ts</code> 中添加可全局使用的 ComponentEchart ，后续 <code>import Echart</code> 时，使用的是封装好的组件。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ComponentEchart</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/componentInstall&quot;</span>;<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ComponentEchart</span>);<br></code></pre></div></td></tr></table></figure><h3 id="图表组件使用"><a href="#图表组件使用" class="headerlink" title="图表组件使用"></a>图表组件使用</h3><p>这里的例子是用仪表盘来表示温度，展示 GPU 运行的实际温度。 temperature 设置中 shutdown(95)、slowdown(92)、max operation(85)，实时获取当前温度 current。 </p><p>最终效果如下：<br><img src="/../img/vue6-1.png" alt="仪表盘图"></p><p>首先进行仪表盘的绘制配置，通过<code>draw.tsx</code>实现。<br>使用<code>watch</code>监听数据改变，手动触发更新（图表初始化）。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;echarts&#x27;</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">PropsType</span> = &#123;<br>  <span class="hljs-attr">cdata</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,<br>    <span class="hljs-attr">require</span>: <span class="hljs-literal">true</span><br>  &#125;<br>&#125; <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>(&#123;<br>  <span class="hljs-attr">props</span>: <span class="hljs-title class_">PropsType</span>,<br>  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props</span>) &#123;<br>    <span class="hljs-keyword">const</span> chartRef = <span class="hljs-title function_">ref</span>()<br>    <span class="hljs-keyword">let</span> options = &#123;&#125;<br><br>    <span class="hljs-title function_">watch</span>(<br>      <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">cdata</span>,<br>      <span class="hljs-function">(<span class="hljs-params">val: any</span>) =&gt;</span> &#123;<br>        options = &#123;<br>          <span class="hljs-attr">series</span>: [<br>            &#123;<br>              <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;gauge&#x27;</span>,<br>              ...<br>              <span class="hljs-attr">data</span>: val.<span class="hljs-property">current</span><br>            &#125;,<br>            &#123;<br>              <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;gauge&#x27;</span>,<br>              ...<br>              <span class="hljs-attr">data</span>: val.<span class="hljs-property">maxoperation</span><br>            &#125;,<br>            &#123;<br>              <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;gauge&#x27;</span>,<br>              ...<br>              <span class="hljs-attr">data</span>: val.<span class="hljs-property">slowdown</span><br>            &#125;<br>          ]<br>        &#125;<br>        <span class="hljs-comment">// 手动触发更新,通过初始化参数打入数据</span><br>        <span class="hljs-keyword">if</span> (chartRef.<span class="hljs-property">value</span>) &#123;<br>          chartRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">initChart</span>(options)<br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span><br>      &#125;<br>    )<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> height = <span class="hljs-string">&quot;450px&quot;</span><br>      <span class="hljs-keyword">const</span> width = <span class="hljs-string">&quot;200px&quot;</span><br><br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">echart</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;chartRef&#125;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&#123;height&#125;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&#123;width&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>在 <code>index.jsx</code> 中向仪表盘注入数据，初次使用时我直接这样写：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>(&#123;<br>  <span class="hljs-attr">components</span>: &#123; <span class="hljs-title class_">Draw</span> &#125;,<br>  <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> cdata = <span class="hljs-title function_">reactive</span>(&#123;<br>      <span class="hljs-attr">current</span>: [&#123; <span class="hljs-attr">value</span>: <span class="hljs-number">24</span> &#125;],<br>      <span class="hljs-attr">maxoperation</span>: [&#123; <span class="hljs-attr">value</span>: <span class="hljs-number">85</span> &#125;],<br>      <span class="hljs-attr">slowdown</span>: [&#123; <span class="hljs-attr">value</span>: <span class="hljs-number">92</span> &#125;],<br>    &#125;)<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Draw</span> <span class="hljs-attr">cdata</span>=<span class="hljs-string">&#123;cdata&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>出现了图表没有渲染的问题，仔细检查后，发现 echarts 没有实例化（可能是没有数据）。<br>修改 <code>index.jsx</code> ，设置一个 <code>setData</code> 方法，在 DOM 挂载时修改 cdata 中的数据，图表绘制成功。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> cdata = <span class="hljs-title function_">reactive</span>(&#123;<br>    <span class="hljs-attr">current</span>: [],<br>    <span class="hljs-attr">maxoperation</span>: [&#123; <span class="hljs-attr">value</span>: <span class="hljs-number">85</span> &#125;],<br>    <span class="hljs-attr">slowdown</span>: [&#123; <span class="hljs-attr">value</span>: <span class="hljs-number">92</span> &#125;],<br>  &#125;)<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setData</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    cdata.<span class="hljs-property">current</span>.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">value</span>: <span class="hljs-number">24</span> &#125;)<br>  &#125;<br><br>  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setData</span>()<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>需要注意的是代码更新会触发重新编译，但是浏览器没有主动刷新，需要手动刷新浏览器。</p><h3 id="定时拉取数据"><a href="#定时拉取数据" class="headerlink" title="定时拉取数据"></a>定时拉取数据</h3><p>在本项目中，需要实时（最近1分钟）展示数据变化，采取的方式是通过定时器<code>setInterval</code>实现，每隔60s发送一次请求。<br>组件挂载时开启定时器，组件卸载时及时清除定时器。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> drawTiming = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">setData</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">//请求数据改变</span><br>&#125;<br><span class="hljs-comment">// 定时函数，60秒刷新一次</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">drawTimingFn</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-title function_">setData</span>();<br>  drawTiming.<span class="hljs-property">value</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setData</span>();<br>  &#125;, <span class="hljs-number">60000</span>);<br>&#125;<br><br><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">drawTimingFn</span>()<br>&#125;)<br><br><span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-built_in">clearInterval</span>(drawTiming.<span class="hljs-property">value</span>)<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="UI-渲染"><a href="#UI-渲染" class="headerlink" title="UI 渲染"></a>UI 渲染</h3><ol><li>echarts 由数据驱动，数据的改变驱动图表展现的改变。<br>动态数据的实现：获取数据，填入数据，echarts 会找到两组数据之间的差异然后通过合适的动画去表现数据的变化。</li><li>vue 由数据驱动，数据改变驱动视图变化。<br>vue 在更新 DOM 时是异步执行的。当数据发生变化，vue 将开启一个异步更新队列，视图需要等队列中所有数据变化完成之后，再统一进行更新。</li></ol><p><img src="/../img/vue6-2.png" alt="event loop"></p><ol start="3"><li>vue 有一种渲染优化策略 <code>nextTick</code> ，也是性能优化手段，基于 JS 执行机制实现。等待同一事件循环中的所有数据变化完成之后（一直修改相同数据，异步操作队列还会去重），再将队列中的事件拿来进行处理，进 DOM 的更新，此时 DOM 只需要更新一次。<br>vue 中我们改变数据时不会立即触发视图，如果需要实时获取到最新的 DOM ，可以手动调用 <code>nextTick</code>。</li><li>在以下情况下，会用到 <code>nextTick</code>：<br>(1) 在数据变化后执行的某个操作，而这个操作需要使用随数据变化而变化的DOM结构的时候，这个操作就需要方法在 <code>nextTick()</code> 的回调函数中。<br>(2) 在 vue 生命周期中，如果在 <code>created()</code> 钩子进行 DOM 操作，也一定要放在 <code>nextTick()</code> 的回调函数中。因为在 <code>created()</code> 钩子函数中，页面的 DOM 还未渲染。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">nextTick</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// DOM 更新了</span><br>&#125;)<br><br><span class="hljs-comment">// 作为一个 Promise 使用</span><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">nextTick</span>()<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// DOM 更新了</span><br>&#125;)<br></code></pre></div></td></tr></table></figure></li></ol><h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p><a href="https://v3.cn.vuejs.org/guide/plugins.html#%E7%BC%96%E5%86%99%E6%8F%92%E4%BB%B6">官方文档 插件</a><br><a href="https://echarts.apache.org/examples/zh/index.html">echarts官网示例</a><br><a href="https://github.com/vuejs/awesome-vue#components--libraries">各种插件</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（5）异步请求</title>
    <link href="/2022/05/07/vue3%E7%AC%94%E8%AE%B0%EF%BC%885%EF%BC%89%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/"/>
    <url>/2022/05/07/vue3%E7%AC%94%E8%AE%B0%EF%BC%885%EF%BC%89%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82/</url>
    
    <content type="html"><![CDATA[<blockquote><p>业务需求一中，用户选择多项，每项都需要发一个请求给后端执行相应任务，并且请求返回需要反馈给用户。<br>方案一是发送多个请求，弹出多个返回值；方案二是发送多个请求，等待所有答复后给用户一个反馈。这篇记录项目中用到的异步请求。<br>业务需求二中，用户点击item，需要通过请求一、请求二…的连续请求后，获取返回值中数据的值。涉及到多次异步的公共逻辑方法抽取。这篇也进行一些写法记录。</p></blockquote><span id="more"></span><h2 id="业务需求一"><a href="#业务需求一" class="headerlink" title="业务需求一"></a>业务需求一</h2><h3 id="multi-req-multi-res"><a href="#multi-req-multi-res" class="headerlink" title="multi req, multi res"></a>multi req, multi res</h3><p>方案一：发送多个请求，弹出多个返回值。<br>优点：可即时看到任务反馈。<br>缺点：很多弹窗用户体验不佳。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">params.<span class="hljs-property">host</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>  params[<span class="hljs-string">&quot;servername&quot;</span>] = item;<br>  <span class="hljs-title function_">createServerUser</span>(params).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;create &#x27;</span>,res)<br>  <span class="hljs-keyword">const</span> &#123; code, msg &#125; = res.<span class="hljs-property">data</span><br>    <span class="hljs-keyword">if</span> (code == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-title class_">ElNotification</span>(&#123;<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;操作成功&#x27;</span>,<br>        <span class="hljs-attr">message</span>: <span class="hljs-title function_">h</span>(<span class="hljs-string">&#x27;i&#x27;</span>, &#123; <span class="hljs-attr">style</span>: <span class="hljs-string">&#x27;color: teal&#x27;</span> &#125;, <span class="hljs-string">&#x27;创建服务器用户成功！&#x27;</span>),<br>      &#125;);<br>      <span class="hljs-title function_">getDataSU</span>();<br>      <span class="hljs-title function_">clearAll</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(msg);<br>    &#125;<br>    isCreating.<span class="hljs-property">value</span>  = <span class="hljs-literal">false</span>;<br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;创建服务器用户失败...&#x27;</span>);<br>    isCreating.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;<br>  &#125;);<br>&#125;)<br></code></pre></div></td></tr></table></figure><h3 id="multi-req-one-res"><a href="#multi-req-one-res" class="headerlink" title="multi req, one res"></a>multi req, one res</h3><p>方案二是发送多个请求，等待所有答复后给用户一个答复。<br>优点：不会出现多次连续弹窗。<br>缺点：如果任务失败或者执行时间较长，用户等待过程比较煎熬。<br>这里使用<code>Promise.all</code>这个API。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> reqArr = [];<br>params.<span class="hljs-property">host</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>  params[<span class="hljs-string">&quot;servername&quot;</span>] = item;<br>  reqArr.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createServerUser</span>(params));<br>&#125;)<br><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(reqArr).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; code, msg &#125; = res[<span class="hljs-number">0</span>].<span class="hljs-property">data</span><br>    <span class="hljs-keyword">if</span> (code == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-title class_">ElNotification</span>(&#123;<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;操作成功&#x27;</span>,<br>        <span class="hljs-attr">message</span>: <span class="hljs-title function_">h</span>(<span class="hljs-string">&#x27;i&#x27;</span>, &#123; <span class="hljs-attr">style</span>: <span class="hljs-string">&#x27;color: teal&#x27;</span> &#125;, <span class="hljs-string">&#x27;创建服务器用户成功！&#x27;</span>),<br>      &#125;);<br>      <span class="hljs-title function_">getDataSU</span>();<br>      <span class="hljs-title function_">clearAll</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(msg);<br>    &#125;<br>    isCreating.<span class="hljs-property">value</span>  = <span class="hljs-literal">false</span>;<br>  &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;创建服务器用户失败...&#x27;</span>);<br>    isCreating.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;<br>  &#125;);<br></code></pre></div></td></tr></table></figure><h3 id="问题思考"><a href="#问题思考" class="headerlink" title="问题思考"></a>问题思考</h3><ol><li><code>async/await</code>和<code>promise</code>关系？</li><li>如何避免回调地狱？</li><li>更直观的回调写法？</li></ol><h2 id="业务需求二"><a href="#业务需求二" class="headerlink" title="业务需求二"></a>业务需求二</h2><h3 id="Promise作为方法的返回"><a href="#Promise作为方法的返回" class="headerlink" title="Promise作为方法的返回"></a>Promise作为方法的返回</h3><p>A方法执行两个异步请求，data1作为第二个请求的输入，获取data2。当两个请求执行完毕后，通过获取返回数据data2的值，进行下一步操作。<br>A可以作为公共请求抽取出来，多处可用。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">A</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id</span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> data1  = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getData1</span>(&#123;<span class="hljs-attr">id</span>: id&#125;)<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">getData2</span>(&#123;<br>        <span class="hljs-attr">id</span>: data1.<span class="hljs-property">d1_id</span><br>      &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">data2</span>)<br>      &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">reject</span>()<br>      &#125;)<br>    &#125;)<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">B</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">row</span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">A</span>(row.<span class="hljs-property">id</span>)<br>    <span class="hljs-keyword">const</span> status = data &amp;&amp; data[<span class="hljs-string">&quot;status&quot;</span>]<br>     <span class="hljs-keyword">if</span>(status == <span class="hljs-string">&quot;SUCCESS&quot;</span>) &#123;<br>        <span class="hljs-comment">//doSth</span><br>     &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//doSth </span><br>     &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（4）vuex</title>
    <link href="/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%884%EF%BC%89vuex/"/>
    <url>/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%884%EF%BC%89vuex/</url>
    
    <content type="html"><![CDATA[<blockquote><p>更复杂的通信可以使用vuex实现，以增加代码维护性。<br>这篇记录vuex的使用。</p></blockquote><span id="more"></span><h3 id="vuex简介"><a href="#vuex简介" class="headerlink" title="vuex简介"></a>vuex简介</h3><p><code>vuex</code>是一个专为Vue.js应用程序开发的状态管理模式。每一个vuex应用的核心就是store（仓库）。store 基本上就是一个容器，它包含着你的应用中大部分的状态 ( state )。<br>（1）vsuex 的状态存储是响应式的。当 Vue 组件从 store 中读取状态的时候，若 store 中的状态发生变化，那么相应的组件也会相应地得到高效更新；<br>（2）改变 store 中的状态的唯一途径就是显式地提交 (commit) mutation。这样使得我们可以方便地跟踪每一个状态的变化；</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p><code>store</code>文件夹下<code>index.ts</code>中。</p><figure class="highlight typescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; createStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vuex&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">createStore</span>(&#123;<br>  <span class="hljs-attr">state</span>: &#123;&#125;,<br>  <span class="hljs-attr">getters</span>: &#123;&#125;,<br>  <span class="hljs-attr">mutations</span>: &#123;&#125;,<br>  <span class="hljs-attr">actions</span>: &#123;&#125;,<br>  <span class="hljs-attr">modules</span>: &#123;&#125;,<br>&#125;);<br></code></pre></div></td></tr></table></figure><p>State &#x3D;&gt; 基本数据，定义了应用状态的数据结构，可以在这里设置默认的初始状态。<br>Getter &#x3D;&gt; 从基本数据派生的数据，允许组件从 Store 中获取数据，mapGetters 辅助函数仅仅是将 store 中的 getter 映射到局部计算属性。<br>Mutation &#x3D;&gt; 是唯一更改 store 中状态的方法，且必须是同步函数。<br>Action &#x3D;&gt; 像一个装饰器，包裹mutations，使之可以异步。用于提交 mutation，而不是直接变更状态，可以包含任意异步操作。<br>Module &#x3D;&gt; 模块化Vuex，允许将单一的 Store 拆分为多个 store 且同时保存在单一的状态树中。</p><p><code>store/modules/</code>文件夹下<code>user.ts</code></p><figure class="highlight typescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserState</span> &#123;<br>  <span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">user_info</span>: <span class="hljs-title class_">IUserInfo</span>;<br>&#125;<br><span class="hljs-meta">@Module</span>(&#123; <span class="hljs-attr">dynamic</span>: <span class="hljs-literal">true</span>, store, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;user&quot;</span> &#125;)<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">VuexModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserState</span> &#123;<br>  <span class="hljs-keyword">public</span> token = <span class="hljs-title function_">getToken</span>() || <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-keyword">public</span> user_info = <span class="hljs-title function_">getUserBag</span>() || &#123;&#125;;<br><br>  <span class="hljs-comment">// @Mutation 标注为mutation</span><br>  <span class="hljs-meta">@Mutation</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">SET_TOKEN</span>(<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = token;<br>  &#125;<br>  <span class="hljs-meta">@Mutation</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">SET_USERINFO</span>(<span class="hljs-params">username: <span class="hljs-built_in">string</span>, id: <span class="hljs-built_in">number</span></span>) &#123;<br>    <span class="hljs-comment">// 设置用户名</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user_info</span>[<span class="hljs-string">&quot;username&quot;</span>] = username;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user_info</span>[<span class="hljs-string">&quot;id&quot;</span>] = id;<br>  &#125;<br><br>    <span class="hljs-comment">// @Action 标注为action</span><br>  <span class="hljs-meta">@Action</span>(&#123; <span class="hljs-attr">rawError</span>: <span class="hljs-literal">true</span> &#125;)<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title class_">Login</span>(<br>    <span class="hljs-attr">userInfo</span>: &#123; <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span> &#125;,<br>  ) &#123;<br>    <span class="hljs-comment">// 登录接口，拿到token</span><br>    <span class="hljs-keyword">let</span> &#123; username, password &#125; = userInfo;<br>    username = username.<span class="hljs-title function_">trim</span>();<br>    password = password.<span class="hljs-title function_">trim</span>();<br>      <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">login</span>(&#123; username, password &#125;);<br>      <span class="hljs-keyword">if</span> (data &amp;&amp; data.<span class="hljs-property">code</span> == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">const</span> &#123; token, user_id, username&#125; = data.<span class="hljs-property">data</span>;<br>        <span class="hljs-keyword">const</span> newUser = &#123;<br>          <span class="hljs-attr">username</span>: username,<br>          <span class="hljs-attr">id</span>: user_id,<br>        &#125;;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">SET_TOKEN</span>(token);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">SET_USERINFO</span>(username, user_id);<br>        <span class="hljs-title function_">setToken</span>(token, newUser);<br>        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">const</span> errMsg = (data &amp;&amp; data.<span class="hljs-property">msg</span>) || <span class="hljs-string">&quot;服务器升级中...&quot;</span><br>        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(errMsg);<br>      &#125;<br>  &#125;<br><span class="hljs-comment">// getModule 得到一个类型安全的store，module必须提供name属性</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserModule</span> = <span class="hljs-title function_">getModule</span>(<span class="hljs-title class_">User</span>);<br></code></pre></div></td></tr></table></figure><h3 id="问题debug"><a href="#问题debug" class="headerlink" title="问题debug"></a>问题debug</h3><p>登录过程某一方法错误，被框架捕获。<br>解决方案：只需在注释中添加<code>rawError</code>选项即可，<code>@Action(&#123;rawError: true&#125;)</code>，这样console就会显示正常问题报错了。<br><img src="/img/vue3-4-1.png" alt="vue3登录过程错误"></p><h3 id="ajax请求数据"><a href="#ajax请求数据" class="headerlink" title="ajax请求数据"></a>ajax请求数据</h3><p>如果请求来的数据不是要被其他组件公用，仅仅在请求的组件内使用，就不需要放入 vuex 的 state 里；如果被其他地方复用，最好将请求放入 action 里，方便复用，并包装成 promise 返回。</p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（3-2）通信 父子组件通信</title>
    <link href="/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%883-2%EF%BC%89%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/"/>
    <url>/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%883-2%EF%BC%89%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇是对3-1的补充，使用setup语法糖，以及eslint之后的bug修复。</p></blockquote><span id="more"></span><h3 id="单向数据流"><a href="#单向数据流" class="headerlink" title="单向数据流"></a>单向数据流</h3><p>可以使用eslint来主动识别是否编码过程违背了单向数据流的思想，若有问题，编译时可能出现<code>Unexpected mutation of &quot;props&quot; prop</code>的报错。</p><h3 id="业务描述"><a href="#业务描述" class="headerlink" title="业务描述"></a>业务描述</h3><p>Navbar中有一个avatar，鼠标悬浮出现下拉框，点击个人中心后使用抽屉形式的表单来做个人信息的修改。<br>具体设计如下：<br><img src="/img/vue3-3.png" alt="vue3"><br><img src="/img/vue3-4.png" alt="vue3"></p><h3 id="父子组件通信实现"><a href="#父子组件通信实现" class="headerlink" title="父子组件通信实现"></a>父子组件通信实现</h3><p>我的想法是Navbar作为一个父组件（总控制器），有Avatar和Drawer两个子组件，子组件管理自己的状态，当有对其他组件有影响的状态的改变要通知父组件。<br>Navbar.vue</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;navbar-wrapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> @<span class="hljs-attr">handleDrawer</span>=<span class="hljs-string">&quot;handleDrawer&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Drawer</span> <span class="hljs-attr">:show</span>=<span class="hljs-string">&quot;showDrawer&quot;</span> @<span class="hljs-attr">handleDrawer</span>=<span class="hljs-string">&quot;handleDrawer&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Avatar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./avatar.vue&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Drawer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./drawer.vue&#x27;</span> </span><br><span class="language-javascript"><span class="hljs-keyword">const</span> showDrawer = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// drawer总控制器</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDrawer</span> = (<span class="hljs-params">flag: boolean</span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;flag=&#x27;</span>, flag)</span><br><span class="language-javascript">  showDrawer.<span class="hljs-property">value</span> = flag</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>Avatar.vue中图标的hover状态只与自身有关，点击“个人中心”-openMyInfo方法会触发Drawer状态改变，使用emit告知父组件状态改变。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;avatar-container right-menu-item hover-effect&quot;</span> <span class="hljs-attr">trigger</span>=<span class="hljs-string">&quot;hover&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;avatar-wrapper&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;user-avatar&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">dropdown</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-menu</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-item</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;openMyInfo&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">mouseenter</span>=<span class="hljs-string">&quot;handleHover(1, true)&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">mouseleave</span>=<span class="hljs-string">&quot;handleHover(1, false)&quot;</span></span><br><span class="hljs-tag">        &gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;left-img&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;!state.hoverInfo&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;@/assets/img/my-info.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;@/assets/img/my-info-active.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>个人中心<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-item</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-menu</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">FormInstance</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-plus&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">ElMessageBox</span>, <span class="hljs-title class_">ElNotification</span>, <span class="hljs-title class_">ElDrawer</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-plus&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">hoverInfo</span>: <span class="hljs-literal">false</span>,</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleHover</span> = (<span class="hljs-params">flag: <span class="hljs-built_in">Number</span>, action: any</span>) =&gt; &#123;</span><br><span class="language-javascript">    state.<span class="hljs-property">hoverInfo</span> = action</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> myEmit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">&#x27;handleDrawer&#x27;</span>])</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">openMyInfo</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-title function_">myEmit</span>(<span class="hljs-string">&#x27;handleDrawer&#x27;</span>, <span class="hljs-literal">true</span>)</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>Drawer.vue<br>这里需要注意的是，我一开始直接将 props.show 赋予 v-model，结果出现了<code>vue/no-mutating-props</code>问题，查阅资料后发现， 是直接对 prop 的内容进行了修改，违反了单向数据流原则。<br>原因：实质上，在子组件内，我们并不可以直接将 prop 的变量应用于子组件深层次组件的 v-model 上（因为 v-model 会隐含的对 prop 值更新。<br>解决方式：将 props.show 通过中间变量进行 v-model 化，再把中间变量传入子组件深层次组件的 v-model 。下面的计算属性showDrawer就是这里的中介。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-drawer</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;drawerRef&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;showDrawer&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:before-close</span>=<span class="hljs-string">&quot;handleClose&quot;</span></span><br><span class="hljs-tag">  &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-tabs</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;drawActive&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;card&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-tab-pane</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;修改密码&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;first&quot;</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">&quot;pwdForm&quot;</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;pwdRules&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;pwdFormRef&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;新密码&quot;</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;pwdForm.password&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;drawer__footer&quot;</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;cancelForm&quot;</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;Sumbit(pwdFormRef)&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-tab-pane</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">el-tabs</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-drawer</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">FormInstance</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-plus&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">ElNotification</span>, <span class="hljs-title class_">ElDrawer</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-plus&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; updateUserPwd &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/api/users&#x27;</span></span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">show</span>: &#123;</span><br><span class="language-javascript">    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,</span><br><span class="language-javascript">    <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span></span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> myEmit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">&#x27;handleDrawer&#x27;</span>])</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> showDrawer = <span class="hljs-title function_">computed</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">show</span>, </span><br><span class="language-javascript">  <span class="hljs-attr">set</span>: <span class="hljs-function">() =&gt;</span> &#123;&#125;</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClose</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-title function_">myEmit</span>(<span class="hljs-string">&#x27;handleDrawer&#x27;</span>, <span class="hljs-literal">false</span>)</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">cancelForm</span> = (<span class="hljs-params"></span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-title function_">myEmit</span>(<span class="hljs-string">&#x27;handleDrawer&#x27;</span>, <span class="hljs-literal">false</span>)</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（3-1）通信 父子组件通信</title>
    <link href="/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%883-1%EF%BC%89%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/"/>
    <url>/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%883-1%EF%BC%89%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>一个功能在多个页面中被使用到，可以抽成了组件，以实现复用。<br>vue使用单项数据流保持数据的统一，业务中难免遇到父子组件通信问题，这篇做一个使用记录。</p></blockquote><span id="more"></span><h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><p>执行顺序：父组件先创建，然后子组件创建；子组件先挂载，然后父组件挂载，即“父beforeCreate-&gt; 父create -&gt; 子beforeCreate-&gt; 子created -&gt; 子mounted -&gt; 父mounted”。</p><h3 id="单向数据流"><a href="#单向数据流" class="headerlink" title="单向数据流"></a>单向数据流</h3><p>所有的<code>prop</code>都使得其父子之间形成了一个单向下行绑定：父级<code>prop</code>的更新会向下流动到子组件中，但是反过来则不行。这样会防止从子组件意外改变父级组件的状态，从而导致应用的数据流向难以理解。额外的，每次父级组件发生更新时，子组件中所有的<code>prop</code>都将会刷新为最新的值。</p><h3 id="父子组件通信实现—父组件修改子组件数据"><a href="#父子组件通信实现—父组件修改子组件数据" class="headerlink" title="父子组件通信实现—父组件修改子组件数据"></a>父子组件通信实现—父组件修改子组件数据</h3><p>应用场景：父组件改变子组件的值。<br>应用方法：子组件通过defineExpose暴露自己的属性，父组件通过ref获取子组件的属性并进行修改。<br>子组件 child.vue</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我是demo组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">import</span> &#123; ref, reactive &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">reactive</span>(&#123;</span><br><span class="language-javascript">    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ginny&#x27;</span>,</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-title function_">defineExpose</span>(&#123;</span><br><span class="language-javascript">    data,</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;refChild&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> &#123; ref ,reactive,onMounted&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./view/child.vue&#x27;</span></span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">let</span> refChild = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> &#123; data &#125; = refChild.<span class="hljs-property">value</span> <span class="hljs-comment">//子组件属性</span></span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>注意：子组件只能是vue形式写的组件，之前复用了一个tsx组件，defineExpose方法失效。</p><h3 id="父子组件通信—自定义事件"><a href="#父子组件通信—自定义事件" class="headerlink" title="父子组件通信—自定义事件"></a>父子组件通信—自定义事件</h3><p>应用场景：子组件的状态改变时，父组件对应状态也发生改变。<br>应用方法：子组件通过<code>$emit</code>派发一个自定义事件，父组件接收到后，由父组件修改自身状态。</p><p>业务描述：公司的项目需要实现针对组织架构选择部门—即树状展示部门，同时多选。部门展示被抽成子组件，调用时，需要获取子组件已经勾选的内容。<br>实现方案：父级向子级dept-tree通过props传入状态sum（这里为父级sumbit事件中的触发的状态改变）。子组件观察状态的变化，通过 $emit 事件告诉父组件。父组件使用自定义的<code>getDeptNodes</code>方法获取payload（即子组件已选内容）。</p><p>父组件调用代码如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">dept-tree</span></span><br><span class="hljs-tag">  @<span class="hljs-attr">getDeptNodes</span>=<span class="hljs-string">&quot;getDeptNodes&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">:sum</span>=<span class="hljs-string">&quot;deptChosen&quot;</span></span><br><span class="hljs-tag">&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dept-tree</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">DeptTree</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/Tree/dept.vue&quot;</span>;<br><span class="hljs-attr">components</span>: &#123;<br>  <span class="hljs-title class_">DeptTree</span><br>&#125;,<br><span class="hljs-attr">setup</span>: &#123;<br>  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;<br>    <span class="hljs-attr">deptChosen</span>: [], <span class="hljs-comment">//dept checkbox选中状态数组</span><br>  &#125;);  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDeptNodes</span> = (<span class="hljs-params">params</span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;deptNodes=&#x27;</span>,params);<br>  &#125;<br>  <span class="hljs-keyword">return</span> &#123;<br>    getDeptNodes<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>子组件模板渲染部门数据。<br>通过观察状态sum的变化，通过<code>emit</code>触发自定义的<code>getDeptNodes</code>方法，传入已选内容。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;treeRef&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;deptTree&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">show-checkbox</span></span><br><span class="hljs-tag">    <span class="hljs-attr">default-expand-all</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">check-strictly</span>=<span class="hljs-string">true</span></span><br><span class="hljs-tag">    <span class="hljs-attr">node-key</span>=<span class="hljs-string">&quot;id&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">:props</span>=<span class="hljs-string">&quot;defaultProps&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>Vue对定义了<code>type</code>的<code>prop</code>执行运行时验证。</p><figure class="highlight typescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs typescript">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;<br>  <span class="hljs-keyword">import</span> &#123; defineComponent, reactive, toRefs, onMounted, watch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span>;<br>  <span class="hljs-keyword">import</span> &#123; getDept&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/api/users&quot;</span>;<br>  <span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">ElTree</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;element-plus&quot;</span>;<br>  <span class="hljs-keyword">import</span> &#123; arrToTree &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/utils&quot;</span>;<br><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;deptTree&quot;</span>,<br>    <span class="hljs-attr">props</span>: &#123;<br>      <span class="hljs-attr">sum</span>: &#123; <span class="hljs-comment">// 作为ref对象传入，可能有其他问题</span><br>        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,<br>        <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span><br>      &#125;<br>    &#125;,<br>    <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, &#123; emit &#125;</span>) &#123;<br>      <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;<br>        <span class="hljs-attr">deptTree</span>:[]<br>      &#125;);<br><br>      <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">getDataDept</span>();<br>      &#125;);<br><br>      <span class="hljs-comment">// 部门数据</span><br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDataDept</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>        <span class="hljs-title function_">getDept</span>(&#123;&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>          <span class="hljs-keyword">const</span> &#123; data &#125; = res.<span class="hljs-property">data</span>;<br>          <span class="hljs-keyword">let</span> deptTreeArr = [];<br>          deptTreeArr.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">arrToTree</span>(data));<br>          state.<span class="hljs-property">deptTree</span> = deptTreeArr<br>        &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>          <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;获取部门数据错误！&#x27;</span>);<br>        &#125;)<br>      &#125;;<br>      <span class="hljs-keyword">const</span> treeRef = ref&lt;<span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">ElTree</span>&gt;&gt;();<br>      <span class="hljs-keyword">const</span> defaultProps = &#123;<br>        <span class="hljs-attr">children</span>: <span class="hljs-string">&#x27;children&#x27;</span>,<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;label&#x27;</span>,<br>      &#125;<br><br>      <span class="hljs-keyword">const</span> sum = props.<span class="hljs-property">sum</span>;<br>      <span class="hljs-title function_">watch</span>(sum,<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;props.sum=&#x27;</span>,sum)<br>        <span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;getDeptNodes&#x27;</span>,&#123;<span class="hljs-string">&quot;deptNodes&quot;</span>:<span class="hljs-title function_">getCheckedNodes</span>()&#125;)<br>      &#125;);<br><br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">getCheckedNodes</span> = (<span class="hljs-params"></span>) =&gt; &#123; <span class="hljs-comment">// 选中的部门</span><br>        <span class="hljs-keyword">return</span> treeRef.<span class="hljs-property">value</span>!.<span class="hljs-title function_">getCheckedNodes</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> &#123;<br>        treeRef,<br>        defaultProps,<br>        ...<span class="hljs-title function_">toRefs</span>(state),<br>      &#125;<br>    &#125;<br>  &#125;);<br>  &lt;/script&gt;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（2-2）打包 &amp; 部署</title>
    <link href="/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%882-2%EF%BC%89%E6%89%93%E5%8C%85%20&amp;%20%E9%83%A8%E7%BD%B2/"/>
    <url>/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%882-2%EF%BC%89%E6%89%93%E5%8C%85%20&amp;%20%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇基于技术栈 vue3 + vite。<br>vite 是 vue 官方推荐的项目构建工具，基于 rollup，构建速度更快，本篇记录使用过程，并且有一些疑惑在以后会一点点解决后再次记录。 </p></blockquote><span id="more"></span><h4 id="环境变量-以-dev-环境为例"><a href="#环境变量-以-dev-环境为例" class="headerlink" title="环境变量-以 dev 环境为例"></a>环境变量-以 dev 环境为例</h4><p>只有 VITE 开头的文件会被读取，其余文件会被拦截。<br>根目录下新建<code>.env.dev</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">NODE_ENV = <span class="hljs-string">&#x27;development&#x27;</span><br>VITE_APP_TITLE = <span class="hljs-string">&#x27;development&#x27;</span><br>VITE_APP_INTERFACE_URL=<span class="hljs-string">&quot;&quot;</span> /* 请求接口地址 */<br>VITE_APP_MOCK = <span class="hljs-literal">true</span><br><span class="hljs-comment"># 是否删除debugger</span><br>VITE_DROP_DEBUGGER=<span class="hljs-literal">false</span><br><span class="hljs-comment"># 是否删除console.log</span><br>VITE_DROP_CONSOLE=<span class="hljs-literal">false</span><br><span class="hljs-comment"># 是否sourcemap</span><br>VITE_SOURCEMAP=<span class="hljs-literal">false</span><br></code></pre></div></td></tr></table></figure><h3 id="按照环境模式区分"><a href="#按照环境模式区分" class="headerlink" title="按照环境模式区分"></a>按照环境模式区分</h3><p><code>package.json</code> 中配置命令，其中 <code>--host</code> 可以在 dev 模式下，使用本机 IP访问系统，<code>--mode</code> 为启用对应的 .env 文件，vite中使用 dotenv 这个库，在开发代码里中可以使用 import.meta.env 获取对应模式配置文件下的全局变量， <code>src/api/**</code> 中使用 <code>import.meta.env.VITE_APP_INTERFACE_URL</code> 来获取当前环境下的 API 地址。</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http-server ./dist -p 8083 --cors&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite --mode dev  --host 0.0.0.0&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;build&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vue-tsc &amp;&amp; vite build&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;preview&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite preview&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;build:dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite build --mode dev&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;build:server&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite build --mode server&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;lint:eslint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eslint --fix --ext .js,.ts,.vue ./src&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;lint:format&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;prettier --write --loglevel warn \&quot;src/**/*.&#123;js,ts,json,tsx,css,less,vue,html,md&#125;\&quot;&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;lint:style&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stylelint --fix \&quot;**/*.&#123;vue,less,postcss,css,scss&#125;\&quot; --cache --cache-location node_modules/.cache/stylelint/&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;lint-staged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lint-staged&quot;</span><br> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></div></td></tr></table></figure><p>详细配置见 vue3笔记（18-1）使用vite进行前端构建</p>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
      <tag>typescript</tag>
      
      <tag>vue2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（2-1）打包 &amp; 部署</title>
    <link href="/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%882-1%EF%BC%89%E6%89%93%E5%8C%85%20&amp;%20%E9%83%A8%E7%BD%B2/"/>
    <url>/2022/04/29/vue3%E7%AC%94%E8%AE%B0%EF%BC%882-1%EF%BC%89%E6%89%93%E5%8C%85%20&amp;%20%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇基于技术栈 vue2 + vue-cli + webpack。<br>业务中分为测试环境和生产环境，对应 API 地址不同，我分别做了打包配置。<br>当前 vue 项目配置和之前的略有不同，记录一下打包上线配置。代码上传到服务器中，使用 nginx 代理。</p></blockquote><span id="more"></span><h3 id="按照环境模式区分"><a href="#按照环境模式区分" class="headerlink" title="按照环境模式区分"></a>按照环境模式区分</h3><p><code>package.json</code>中配置命令，其中<code>--host</code>可以在dev模式下，使用本机IP访问系统。</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vue-cli-service serve --mode dev --host 0.0.0.0&quot;</span><span class="hljs-punctuation">,</span><br>   <span class="hljs-attr">&quot;serve&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vue-cli-service serve --mode serve&quot;</span><span class="hljs-punctuation">,</span><br>   <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vue-cli-service build --mode serve&quot;</span><span class="hljs-punctuation">,</span><br>   <span class="hljs-attr">&quot;prod&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;vue-cli-service build --mode prod&quot;</span><br> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></div></td></tr></table></figure><p>针对3个不同的环境，创建3个文件，这里定义在<code>src/api/**</code>中使用<code>process.env.VUE_APP_INTERFACE_URL</code>来获取当前环境下的API地址。</p><h4 id="dev环境"><a href="#dev环境" class="headerlink" title="dev环境"></a>dev环境</h4><p>根目录下新建<code>.env.dev</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">NODE_ENV = <span class="hljs-string">&#x27;development&#x27;</span><br>VUE_APP_TITLE = <span class="hljs-string">&#x27;development&#x27;</span><br>VUE_APP_INTERFACE_URL=<span class="hljs-string">&quot;&quot;</span> /* 请求接口地址 */<br>VUE_APP_MOCK = <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure><p>dev环境若需要设置代理，<code>vue.config.js</code>中添加以下内容：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> &#123; defineConfig &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;@vue/cli-service&quot;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;path&quot;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">publicPath</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&quot;production&quot;</span> ? <span class="hljs-string">&quot;/&quot;</span> : <span class="hljs-string">&quot;/&quot;</span>,<br>  <span class="hljs-attr">transpileDependencies</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">lintOnSave</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">devServer</span>: &#123;<br>    <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span>,<br>    <span class="hljs-attr">host</span>: <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//配置浏览器自动访问</span><br>    <span class="hljs-attr">headers</span>: &#123;<br>      <span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>: <span class="hljs-string">&quot;*&quot;</span>,<br>      <span class="hljs-string">&quot;Access-Control-Allow-Methods&quot;</span>: <span class="hljs-string">&quot;GET, POST, PUT, DELETE, PATCH, OPTIONS&quot;</span>,<br>      <span class="hljs-string">&quot;Access-Control-Allow-Headers&quot;</span>:<br>        <span class="hljs-string">&quot;X-Requested-With, content-type, Authorization&quot;</span>,<br>    &#125;,<br>    <span class="hljs-attr">proxy</span>: &#123;<br>      <span class="hljs-string">&quot;/api&quot;</span>: &#123;<br>        <span class="hljs-attr">target</span>: <span class="hljs-string">&quot;http://***&quot;</span>,<br>        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">pathRewrite</span>: &#123; <span class="hljs-string">&quot;^/api&quot;</span>: <span class="hljs-string">&quot;/api&quot;</span> &#125;,<br>      &#125;,<br>    &#125;,<br>  &#125;,<br>&#125;);<br></code></pre></div></td></tr></table></figure><h4 id="test环境"><a href="#test环境" class="headerlink" title="test环境"></a>test环境</h4><p>根目录下新建<code>.env.serve</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">NODE_ENV = <span class="hljs-string">&#x27;server&#x27;</span><br>VUE_APP_TITLE = <span class="hljs-string">&#x27;server&#x27;</span><br>VUE_APP_INTERFACE_URL=<span class="hljs-string">&quot;http://***:19991&quot;</span><br></code></pre></div></td></tr></table></figure><h4 id="production环境"><a href="#production环境" class="headerlink" title="production环境"></a>production环境</h4><p>根目录下新建<code>.env.prod</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">NODE_ENV=<span class="hljs-string">&#x27;production&#x27;</span><br>VUE_APP_TITLE=<span class="hljs-string">&#x27;prod&#x27;</span><br>VUE_APP_INTERFACE_URL=<span class="hljs-string">&quot;http://***:19999&quot;</span><br></code></pre></div></td></tr></table></figure><h3 id="打包去除console"><a href="#打包去除console" class="headerlink" title="打包去除console"></a>打包去除console</h3><p>因为开发环境写了一些log，打包上线时为了更加干净需要去除。<br>安装插件</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">npm install babel-plugin-transform-remove-console --save-dev<br></code></pre></div></td></tr></table></figure><p>在项目的<code>babel.config.js</code>的plugin中添加如下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">presets</span>: [<span class="hljs-string">&quot;@vue/cli-plugin-babel/preset&quot;</span>],<br>  <span class="hljs-attr">plugins</span>:[<br>    ...proPlugins<br>  ]<br>&#125;;<br></code></pre></div></td></tr></table></figure><h3 id="打包到服务器指定目录下"><a href="#打包到服务器指定目录下" class="headerlink" title="打包到服务器指定目录下"></a>打包到服务器指定目录下</h3><p>如最终需要浏览器访问地址为http:&#x2F;&#x2F;***:port&#x2F;demo&#x2F;，就需要修改路径，已解决无法访问静态资源的问题。<br>修改<code>vue.config.js</code>中的地址：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">publicPath</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span> ? <span class="hljs-string">&#x27;/demo/&#x27;</span> : <span class="hljs-string">&#x27;/&#x27;</span>,<br>&#125;<br></code></pre></div></td></tr></table></figure><p>nginx中添加如下配置：</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">location /demo/ &#123;<br>  root /data/; //root<br>  index index.html index.htm;<br>  try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /demo/;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><p><img src="/img/vue3-2.png" alt="env报错"></p>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
      <tag>typescript</tag>
      
      <tag>vue2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（1-3）基础写法</title>
    <link href="/2022/04/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%881-3%EF%BC%89%E5%9F%BA%E7%A1%80%E5%86%99%E6%B3%95/"/>
    <url>/2022/04/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%881-3%EF%BC%89%E5%9F%BA%E7%A1%80%E5%86%99%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇记录使用过的功能，包括：表格数据为空、表格序号自增、表格内部点击实现路由跳转、表格排序；自定义提示信息；通过 deep 改变组件样式；t s忽略类型检查</p></blockquote><h3 id="数据为空"><a href="#数据为空" class="headerlink" title="数据为空"></a>数据为空</h3><ol><li><p>table-column 中没有数据时，可以通过 css 控制显示–<br>当项目中只有部分表格需要此功能时，建议给需要的表格添加类名。注意：如果表格数据使用slot，也需要添加 <code>prop=&quot;XXX&quot;</code>，否则类似于开关（el-switch）按钮上会有–</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">// 所有表格<br><span class="hljs-selector-class">.cell</span><span class="hljs-selector-pseudo">:empty</span><span class="hljs-selector-pseudo">::before</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;--&quot;</span>;<br>  <span class="hljs-attribute">color</span>: gray;<br>&#125;<br><br>// 自定义class的表格<br><span class="hljs-selector-class">.table-special</span> <span class="hljs-selector-pseudo">:empty</span><span class="hljs-selector-pseudo">::before</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&#x27;--&#x27;</span> <span class="hljs-meta">!important</span>;<br>  <span class="hljs-attribute">color</span>: gray <span class="hljs-meta">!important</span>;<br>&#125;<br><br></code></pre></div></td></tr></table></figure></li><li><p>table没有数据时，通过slot插槽控制UI</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">slot</span>=<span class="hljs-string">&quot;empty&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;text-align: left;&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-empty</span> <span class="hljs-attr">description</span>=<span class="hljs-string">&quot;div里面可以自定义空内容&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li></ol><h3 id="el-table-使用过的功能记录"><a href="#el-table-使用过的功能记录" class="headerlink" title="el-table 使用过的功能记录"></a>el-table 使用过的功能记录</h3><ol><li>表格序号自增</li><li>路由跳转（外链+内部）<br><code>#default=&quot;scope&quot;</code>可以任意自定义表格内内容展示<figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;index&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;80&quot;</span> <span class="hljs-attr">:index</span>=<span class="hljs-string">&quot;startIndex&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;序号&quot;</span> /&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;客户&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">&quot;&#123; path: &#x27;/orderDetail&#x27;, query: &#123; detail: scope.row.id &#125; &#125;&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;&#123; scope.row.name &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;地址&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">&quot;scope.row.url&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span>&#123;&#123; scope.row.url &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> startIndex = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">return</span> (query.<span class="hljs-property">value</span>.<span class="hljs-property">page</span> - <span class="hljs-number">1</span>) * query.<span class="hljs-property">value</span>.<span class="hljs-property">pagesize</span> + <span class="hljs-number">1</span></span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li></ol><h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><h4 id="前端排序"><a href="#前端排序" class="headerlink" title="前端排序"></a>前端排序</h4><p><code>el-table-column</code>中添加 <code>sortable</code>即可。<br>要注意的是，这只是当前页面的排序，如果翻到下一页，排序还是默认的第二页的排序。如果需要全局排序，则由后端排序处理。</p><h4 id="后端排序"><a href="#后端排序" class="headerlink" title="后端排序"></a>后端排序</h4><ol><li><p>方法一</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;table&quot;</span> @<span class="hljs-attr">sort-change</span>=<span class="hljs-string">&quot;onSortChange&quot;</span> <span class="hljs-attr">:default-sort</span> =<span class="hljs-string">&quot;&#123;&#x27;prop&#x27;: prop,&#x27;order&#x27;:type&#125;&quot;</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;tableData&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;100&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;parent_name&quot;</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;组织&quot;</span> <span class="hljs-attr">sortable</span>=<span class="hljs-string">&#x27;custom&#x27;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot-scope</span>=<span class="hljs-string">&quot;scope&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;&#123;scope.row.name ? scope.row.id: &#x27;&#x27;&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-title function_">onSortChange</span>(<span class="hljs-params">&#123; prop, order &#125;</span>) &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">let</span> orderF;</span><br><span class="language-javascript">  <span class="hljs-keyword">if</span>(order==<span class="hljs-string">&#x27;descending&#x27;</span>) &#123;</span><br><span class="language-javascript">    orderF = <span class="hljs-string">&#x27;desc&#x27;</span></span><br><span class="language-javascript">  &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( order==<span class="hljs-string">&#x27;ascending&#x27;</span>) &#123;</span><br><span class="language-javascript">    orderF = <span class="hljs-string">&#x27;asc&#x27;</span></span><br><span class="language-javascript">  &#125;<span class="hljs-keyword">else</span> &#123;&#125;</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> ordering = <span class="hljs-title function_">getSortOrdering</span>(prop, orderF);</span><br><span class="language-javascript">    <span class="hljs-title function_">getApi</span>(&#123;</span><br><span class="language-javascript">      <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,</span><br><span class="language-javascript">      <span class="hljs-attr">pagesize</span>: <span class="hljs-number">10</span>,</span><br><span class="language-javascript">      <span class="hljs-attr">ordering</span>: ordering</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">      dataList.<span class="hljs-property">tableData</span> = res.<span class="hljs-property">data</span>;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">// 根据交互数据格式修改</span></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> getSortOrdering = (<span class="hljs-attr">prop</span>: string, <span class="hljs-attr">order</span>: string): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> prefix = order === <span class="hljs-string">&quot;asc&quot;</span> ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;-&quot;</span>;</span><br><span class="language-javascript">  <span class="hljs-keyword">return</span> prefix + <span class="hljs-string">&quot;time&quot;</span>;</span><br><span class="language-javascript">&#125;;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li><li><p>方法二</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"> <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;&#123; item.label &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;item.prop === &#x27;time&#x27;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;icons&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sort-caret ascending&quot;</span></span><br><span class="hljs-tag">        @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;sortColumn(item.prop, &#x27;asc&#x27;)&quot;</span></span><br><span class="hljs-tag">      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sort-caret descending&quot;</span></span><br><span class="hljs-tag">        @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;sortColumn(item.prop, &#x27;desc&#x27;)&quot;</span></span><br><span class="hljs-tag">      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">sortColumn</span> = (<span class="hljs-params">prop: string, order: string</span>) =&gt; &#123;</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> ordering = <span class="hljs-title function_">getSortOrdering</span>(prop, order);</span><br><span class="language-javascript">  <span class="hljs-title function_">getApi</span>(&#123;</span><br><span class="language-javascript">    <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,</span><br><span class="language-javascript">    <span class="hljs-attr">pagesize</span>: <span class="hljs-number">10</span>,</span><br><span class="language-javascript">    <span class="hljs-attr">ordering</span>: ordering</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript">    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">      dataList.<span class="hljs-property">tableData</span> = res.<span class="hljs-property">data</span>;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">&#125;;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li></ol><h3 id="自定义提示信息"><a href="#自定义提示信息" class="headerlink" title="自定义提示信息"></a>自定义提示信息</h3><p>tip采用拼接string字符串形式，换行使用<code>&lt;/br&gt;</code>，通过raw-content注入到组件中</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span> <span class="hljs-attr">:content</span>=<span class="hljs-string">&quot;tip&quot;</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">&quot;top&quot;</span> <span class="hljs-attr">raw-content</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Warning</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="通过deep改变组件样式"><a href="#通过deep改变组件样式" class="headerlink" title="通过deep改变组件样式"></a>通过deep改变组件样式</h3><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;scss&quot;</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="language-css"></span><br><span class="language-css">:<span class="hljs-built_in">deep</span>(.el-tabs__header) &#123;</span><br><span class="language-css">  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;</span><br><span class="language-css">&#125;</span><br><span class="language-css"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h3 id="typescript忽略类型检查"><a href="#typescript忽略类型检查" class="headerlink" title="typescript忽略类型检查"></a>typescript忽略类型检查</h3><p>单行忽略(添加到特定行的行前来忽略这一行的错误)<br>&#x2F;&#x2F; @ts-ignore</p><p>跳过对某些文件的检查 (添加到该文件的首行才起作用)<br>&#x2F;&#x2F; @ts-nocheck</p><p>对某些文件的检查<br>&#x2F;&#x2F; @ts-check</p>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（1-2）基础写法</title>
    <link href="/2022/04/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%881-2%EF%BC%89%E5%9F%BA%E7%A1%80%E5%86%99%E6%B3%95/"/>
    <url>/2022/04/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%881-2%EF%BC%89%E5%9F%BA%E7%A1%80%E5%86%99%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇是上一篇的延伸，使用 pinia 作为状态管理，对项目进行了一次升级。<br>使用 setup 语法糖进行组合式API的编写。</p></blockquote><h3 id="setup-语法糖"><a href="#setup-语法糖" class="headerlink" title="setup 语法糖"></a>setup 语法糖</h3><p>执行顺序：</p><ol><li>创建组件实例</li><li>props 解析</li><li>setup 调用执行（一次）</li><li>组件创建 beforeCreate</li></ol><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;ts&quot;</span> <span class="hljs-attr">setup</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> dataList = <span class="hljs-title function_">reactive</span>(&#123;</span><br><span class="language-javascript">  <span class="hljs-attr">tableData</span>: [],</span><br><span class="language-javascript">  <span class="hljs-attr">pageTotal</span>: <span class="hljs-number">0</span>,</span><br><span class="language-javascript">  <span class="hljs-attr">query</span>: &#123; <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">pagesize</span>: <span class="hljs-number">10</span> &#125;</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"><span class="hljs-keyword">const</span> &#123; tableData, pageTotal, query &#125; = <span class="hljs-title function_">toRefs</span>(dataList)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><ol><li>toRefs(dataList)，为对象属性添加响应式</li><li>不需要 return 对象、方法等</li><li>通过 <code>defineProps</code> 指定当前 props 类型，获得上下文 props 对象</li></ol><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>(&#123;<br>  <span class="hljs-attr">show</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,<br>    <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span><br>  &#125;<br>&#125;)<br><br><span class="hljs-comment">// 增加类型-不能使用default</span><br><span class="hljs-keyword">const</span> props = defineProps&lt;&#123;<br>  <span class="hljs-attr">show</span>: <span class="hljs-title class_">String</span><br>&#125;&gt;<br></code></pre></div></td></tr></table></figure><h3 id="自定义指令"><a href="#自定义指令" class="headerlink" title="自定义指令"></a>自定义指令</h3><p>需要对普通 DOM 元素进行底层操作，会用到自定义指令。</p><ol><li><p>全局自定义指令</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">app.<span class="hljs-title function_">directive</span>(<span class="hljs-string">&#x27;focus&#x27;</span>,&#123;<br> <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el</span>)&#123;<br>  el.<span class="hljs-title function_">focus</span>()<br> &#125;<br>&#125;)<br><br><span class="hljs-comment">//组件使用</span><br>&lt;input type=<span class="hljs-string">&quot;text&quot;</span> v-focus /&gt;<br></code></pre></div></td></tr></table></figure></li><li><p>局部自定义指令<br>binding 是一个对象，包含该指令的所有信息。（arg 自定义指令的参数名；value 自定义指令绑定的值；oldValue 指令绑定的前一个值；dir 被执行的钩子函数；modifiers：一个包含修饰符的对象）</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> defineDir = &#123;<br> <span class="hljs-attr">focus</span>: &#123;<br>  <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>)&#123;<br>    el.<span class="hljs-title function_">focus</span>()<br>    el.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = binding.<span class="hljs-property">value</span>.<span class="hljs-property">left</span>+<span class="hljs-string">&#x27;px&#x27;</span><br>  &#125;<br> &#125;<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br> <span class="hljs-attr">directives</span>: defineDir,<br> <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-keyword">const</span> posData = &#123;<br>   <span class="hljs-attr">left</span>:<span class="hljs-number">20</span><br>  &#125;<br> &#125;<br>&#125;<br><br><span class="hljs-comment">//组件使用</span><br>&lt;input type=<span class="hljs-string">&quot;text&quot;</span> v-focus /&gt;<br></code></pre></div></td></tr></table></figure></li><li><p>自定义指令中的生命周期钩子函数<br>一个指令定义对象可以提供如下几个钩子函数（可选）:<br>created ：绑定元素属性或事件监听器被应用之前调用。(eg: 附加在 v-on 事件监听器前调用的事件监听器时)。<br>beforeMounted ：当指令第一次绑定到元素并且在挂载父组件之前执行。<br>mounted ：绑定元素的父组件被挂载之后调用。<br>beforeUpdate ：在更新包含组件的 VNode 之前调用。<br>updated ：在包含组件的 VNode 及其子组件的 VNode 更新后调用。<br>beforeUnmounted ：在卸载绑定元素的父组件之前调用<br>unmounted ：当指令与元素解除绑定且父组件已卸载时，只调用一次。</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue3笔记（1-1）基础写法</title>
    <link href="/2022/04/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%881-1%EF%BC%89%E5%9F%BA%E7%A1%80%E5%86%99%E6%B3%95/"/>
    <url>/2022/04/26/vue3%E7%AC%94%E8%AE%B0%EF%BC%881-1%EF%BC%89%E5%9F%BA%E7%A1%80%E5%86%99%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>人生兜兜转转几年没更新，转眼从产品变到项目管理又变成了前端。<br>最近使用 Vue3+TS 搭建了公司的服务平台，使用 vue-cli5 构建项目，UI 使用了 element-plus，记录一下代码写法和使用过程中的坑。</p></blockquote><span id="more"></span><h3 id="版本号对应"><a href="#版本号对应" class="headerlink" title="版本号对应"></a>版本号对应</h3><p>Vue CLI 4.5以下，对应的是Vue2。<br>Vue CLI 4.5及以上，对应的是Vue3，当然，创建项目的时候可以选择Vue2。</p><h3 id="配置使用IP访问"><a href="#配置使用IP访问" class="headerlink" title="配置使用IP访问"></a>配置使用IP访问</h3><p><code>package.json</code>中添加启动配置</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-string">&quot;serve&quot;</span>: <span class="hljs-string">&quot;vue-cli-service serve  --host 0.0.0.0&quot;</span><br></code></pre></div></td></tr></table></figure><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><ol><li>ref 定义一个基本类型（包含一个数据）的响应式，创建一个包含响应式数据的引用对象。通过给 value 属性添加 getter&#x2F;setter 实现对数据的劫持。</li><li>reactive 定义对象（可以包含多个数据）的响应式，返回响应式代理对象（基于 Proxy 实现），会影响对象内部所有的嵌套属性–递归深度响应式。通过 Proxy 实现对对象内部所有数据的劫持，并通过 Reflect 操作对象内部的数据。</li></ol><h3 id="组合式API"><a href="#组合式API" class="headerlink" title="组合式API"></a>组合式API</h3><ol><li>Composition API 可以减少强耦合，避免方法之间互相 this 调用，方法之间互相共享变量，后期维护很麻烦。</li></ol><h3 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h3><p><img src="/img/vue2-1.png" alt="vue3搜索"></p><h3 id="基础写法"><a href="#基础写法" class="headerlink" title="基础写法"></a>基础写法</h3><p>功能：通过表单内容搜索，列表展示搜索结果。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">el-main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;server-main&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span></span><br><span class="hljs-tag">      <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;serverUserFormRef&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:model</span>=<span class="hljs-string">&quot;serverUserForm&quot;</span></span><br><span class="hljs-tag">      <span class="hljs-attr">:rules</span>=<span class="hljs-string">&quot;rules&quot;</span></span><br><span class="hljs-tag">      &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;姓名&quot;</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">&quot;alias_name&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span></span><br><span class="hljs-tag">        <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;serverUserForm.alias_name&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;alias_name&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;请输入用户名&quot;</span></span><br><span class="hljs-tag">      &gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span><br><span class="hljs-tag">          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;primary&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">icon</span>=<span class="hljs-string">&quot;Edit&quot;</span></span><br><span class="hljs-tag">          @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">&quot;handleAdd(serverUserFormRef)&quot;</span></span><br><span class="hljs-tag">        &gt;</span>创建<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">&quot;tableData&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item, index) in columns&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span></span><br><span class="hljs-tag">          <span class="hljs-attr">v-bind</span>=<span class="hljs-string">&quot;item&quot;</span></span><br><span class="hljs-tag">          <span class="hljs-attr">show-overflow-tooltip</span>&gt;</span> <br>        <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">el-main</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs JavaScript">&lt;script lang=<span class="hljs-string">&quot;ts&quot;</span>&gt;<br><span class="hljs-keyword">import</span> &#123; defineComponent, ref, reactive, toRefs, onMounted &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; getUsers, createUser&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/api/users&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">ElMessageBox</span>, <span class="hljs-title class_">ElNotification</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;element-plus&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Search</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@element-plus/icons-vue&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">FormInstance</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;element-plus&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;XX&quot;</span>,<br>  <span class="hljs-attr">components</span>: &#123;&#125;,<br>  <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> emyptForm = &#123;<br>      <span class="hljs-attr">alias_name</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    &#125;<br>    <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>(&#123;<br>      <span class="hljs-attr">serverUserForm</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(emyptForm)),<br>      <span class="hljs-attr">tableData</span>:[]<br>    &#125;);<br>    <span class="hljs-keyword">const</span> columns = [<br>      &#123; <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;用户&quot;</span>, <span class="hljs-attr">prop</span>: <span class="hljs-string">&quot;alias_name&quot;</span>, <span class="hljs-attr">width</span>: <span class="hljs-string">&quot;200&quot;</span> &#125;,<br>    ];<br><br>    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">getData</span>();<br>    &#125;);<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-title function_">getUsers</span>(&#123;&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> &#123; data &#125; = res.<span class="hljs-property">data</span><br>        state.<span class="hljs-property">tableData</span> = data.<span class="hljs-property">results</span>;<br>      &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;获取数据错误！&#x27;</span>);<br>      &#125;)<br>    &#125;<br>    <span class="hljs-keyword">const</span> serverUserFormRef = ref&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">FormInstance</span>&gt;();<br>    <span class="hljs-keyword">const</span> rules = &#123;<br>      <span class="hljs-attr">alias_name</span>: [&#123; <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;请输入用户名&quot;</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">&quot;blur&quot;</span> &#125;]<br>    &#125;;<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearAll</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>      state.<span class="hljs-property">serverUserForm</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(emyptForm));<br>    &#125;<br>    <span class="hljs-comment">// 新增</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAdd</span> = (<span class="hljs-params">formEl</span>) =&gt; &#123;<br>        formEl.<span class="hljs-title function_">validate</span>(<span class="hljs-function">(<span class="hljs-params">valid: boolean</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (valid) &#123;<br>          <span class="hljs-keyword">const</span> params = state.<span class="hljs-property">serverUserForm</span>;<br>          <span class="hljs-title function_">createUser</span>(params).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>              <span class="hljs-keyword">const</span> &#123; code, data &#125; = res.<span class="hljs-property">data</span><br>              <span class="hljs-keyword">if</span>(code == <span class="hljs-number">0</span>) &#123;<br>                  <span class="hljs-title class_">ElNotification</span>(&#123;<br>                      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;操作成功&#x27;</span>,<br>                      <span class="hljs-attr">message</span>: <span class="hljs-title function_">h</span>(<span class="hljs-string">&#x27;i&#x27;</span>, &#123; <span class="hljs-attr">style</span>: <span class="hljs-string">&#x27;color: teal&#x27;</span> &#125;, <span class="hljs-string">&#x27;用户已新增！&#x27;</span>),<br>                  &#125;);<br>                  <span class="hljs-title function_">getData</span>();<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                  <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;新增用户错误，请重试！&#x27;</span>);<br>              &#125; <br>          &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>              <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;服务器修复中，请稍后重试！&#x27;</span>);<br>          &#125;);<br>          <span class="hljs-title function_">clearAll</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125;)<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123;<br>      serverUserFormRef,<br>      ...<span class="hljs-title function_">toRefs</span>(state),<br>      rules,     <br>      handleAdd,<br>      columns,<br>    &#125;;<br>  &#125;<br>&#125;);<br>&lt;/script&gt;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>vue3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>工作（4）短暂的PM随想</title>
    <link href="/2022/02/28/%E5%B7%A5%E4%BD%9C%EF%BC%884%EF%BC%89%E7%9F%AD%E6%9A%82%E7%9A%84PM%E9%9A%8F%E6%83%B3/"/>
    <url>/2022/02/28/%E5%B7%A5%E4%BD%9C%EF%BC%884%EF%BC%89%E7%9F%AD%E6%9A%82%E7%9A%84PM%E9%9A%8F%E6%83%B3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这起起落落曲曲折折像极了人生。— ginny</p></blockquote><span id="more"></span><p>记录我项目管理+产品经理的神奇一年。<br>悟出的都是人生。</p><p>需求就像渣男的出轨，只有零次和无数次。</p><p>不管有没有意义，真正做的事才让你不焦虑。</p><p>概念恒久远，ROI永流传。</p>]]></content>
    
    
    
    <tags>
      
      <tag>工作实习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>工作（3）title是算法工程师</title>
    <link href="/2021/03/30/%E5%B7%A5%E4%BD%9C%EF%BC%883%EF%BC%89title%E6%98%AF%E7%AE%97%E6%B3%95%E5%B7%A5%E7%A8%8B%E5%B8%88/"/>
    <url>/2021/03/30/%E5%B7%A5%E4%BD%9C%EF%BC%883%EF%BC%89title%E6%98%AF%E7%AE%97%E6%B3%95%E5%B7%A5%E7%A8%8B%E5%B8%88/</url>
    
    <content type="html"><![CDATA[<blockquote><p>研究生毕业以后，我在超算工作了两年多，顶着“算法工程师”的 title，成了一个什么都做的工程师。</p></blockquote><span id="more"></span><h3 id="工作内容"><a href="#工作内容" class="headerlink" title="工作内容"></a>工作内容</h3><p>工程部分：</p><ol><li>我负责了 AI 部门网站(VueJs + Python)的整体设计开发及搭建，其中有一部分是部门已有项目展示，我使用TensorFlow Serving with Docker 做模型运行的承载，整合已经训练好的模型，完成前端服务端模型运行的三端分离。 </li><li>我负责了超云环境平台开发(VueJs)。</li><li>我负责了深度学习神经网络可视化开发(D3Js)。</li></ol><p>调研部分：<br>我参与了芯片生态、AI benchmark、数据平台设计、机器学习模型场景实际使用的调研。</p><h3 id="工作感悟"><a href="#工作感悟" class="headerlink" title="工作感悟"></a>工作感悟</h3><p>这里的工作还是比较偏向科研系列的，产业化要求没有那么高。但是科研本身是很深奥的，当时的领导学术出身，布置任务有点偏个人思维，我为了理解他的意思，和他更好的沟通，在他的指导下看了很多顶会论文，几乎每天都在不断学习。<br>正是这一阶段的学习，让我在深度学习方面打下了基础，后续工作遇到相关的，我能很快 get 到具体是什么。<br>也正是这些深不可测的东西，让我看到了自己的天花板，我确实不是学术的料子，还是只能做工业界织女，明确了以后的从业方向。<br>我真的深深感谢这一段经历，和蔼儒雅的领导就像夜空中的明星，我觉得自己像是从未离开过校园，在导师的指导下去追寻真理。以后的以后，我都要不断学习！</p>]]></content>
    
    
    
    <tags>
      
      <tag>工作实习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react笔记（3）react-redux数据管理</title>
    <link href="/2020/05/28/react%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89react-redux%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/"/>
    <url>/2020/05/28/react%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89react-redux%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>前期考虑不周的坑，后期总要来填的。— ginny Guo<br>在这个项目的时候技术选型的时候，因为“时间周期较短”和“产品交流不充分”，没能完全get到prd中的一些细节问题，当时感觉传统的状态管理已经完全hold住这个项目了，结果在后期出现了一个state对应多个view改变，多个action触发一个state改变等问题。多个组件保留状态需要多个copy，简直是灾难啊啊！！！更加难过的是，后期出现了渲染太慢的问题，严重影响用户体验，所以不得不重构引入Redux状态管理了。<br>本篇记录了react-redux的使用，以及项目前后设计的对比，为以后技术选型做一个铺垫。<br>本篇真的写了好几天啊，好难讲清楚Orz，以后还要填坑几次才行。</p></blockquote><span id="more"></span><h4 id="Redux"><a href="#Redux" class="headerlink" title="Redux"></a>Redux</h4><p><code>Redux</code> 是 <code>JavaScript</code> 状态容器，提供可预测化的状态管理。<br>其数据流大致如下：<br><img src="/img/redux-1.jpg" alt="redux"></p><h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><p>Redux 中只有一个单一的 <code>Store</code> ，存储了所有共享状态（以一个对象树的形式储存）。<br>合并后的reducer（之后讨论）作为参数传入store。</p><p>根目录下入口文件index.js中添加store：</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123;<span class="hljs-title class_">Provider</span>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123;createStore&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./App&#x27;</span><br><span class="hljs-keyword">import</span> myreducer <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./reducers&#x27;</span>;<br><br><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(myreducers);<br><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">&#123;store&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>,<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>)<br>);<br></code></pre></div></td></tr></table></figure><h4 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h4><p>Redux中把动作和状态独立，通过动作来改变状态。<code>Action</code> 是改变 <code>Store</code> 数据的唯一来源，包含 <code>View</code> 中数据变化、用户操作、服务器响应等等。</p><p>Redux中通过Action创建函数的结果（返回值是一个action对象），传给 <code>dispatch</code> 方法即可发起一次dispatch过程。<br>Store里能直接通过 <code>store.dispatch()</code> 调用dispatch方法。</p><p>Action本质上是一个对象，type是一个字符串常量，表示要执行的动作。<br>Action只有指定动作，不包含更新状态的方法，方法在下面的reducer中会提到。</p><p>触发AReducer的actions，存放于actions&#x2F;index.js：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// some actions</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">AddSth</span> = (<span class="hljs-params">data</span>) =&gt; (&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;sthAdd&#x27;</span>,<br>    data<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">DelSth</span> = (<span class="hljs-params">data</span>) =&gt; (&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;sthDel&#x27;</span>,<br>    data<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">UpdateSth</span> = (<span class="hljs-params">data</span>) =&gt; (&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;sthUpdate&#x27;</span>,<br>    data<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">ClearList</span> = (<span class="hljs-params">data</span>) =&gt; (&#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;listClear&#x27;</span>,<br>    data<br>&#125;);<br></code></pre></div></td></tr></table></figure><h4 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h4><p><code>Reducer</code> 是一个用于处理事件的纯函数，决定每个action如何改变应用的state。<br>在本项目中为了方便区分各个业务逻辑（互相独立），为每个业务逻辑编写一个reducer，存放于reducers文件夹中间，reduce文件夹中的index.js合并所有reduce，作为一个根级的reducer。</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123;combineReducers&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AReducer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;reducers&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">BReducer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;reducers&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">CReducer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;reducers&#x27;</span>;<br><br><span class="hljs-keyword">const</span> myreducer = <span class="hljs-title function_">combineReducers</span>(&#123;<br>    <span class="hljs-title class_">AReducer</span>,<br>    <span class="hljs-title class_">BReducer</span>,<br>    <span class="hljs-title class_">CReducer</span>,<br>&#125;);<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> myreducers;<br></code></pre></div></td></tr></table></figure><p>单个reduce是形式为 <code>(state, action) =&gt; state</code> 的纯函数，state的形式可以是基本类型、数组、对象等等。在本项目中状态是存储的数据，数据用数组list来表示。</p><p>举例AReducer，代码如下：</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-comment">// reducer </span><br><span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AReducer</span>(<span class="hljs-params">list:[], action</span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123;data = &#123;&#125;&#125; = action;<br>    <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;sthAdd&#x27;</span>: &#123;<br>           <span class="hljs-keyword">const</span> arrIndex = _.<span class="hljs-title function_">findIndex</span>(<br>                list,<br>                <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-built_in">parseInt</span>(item.<span class="hljs-property">id</span>, <span class="hljs-number">10</span>) === <span class="hljs-built_in">parseInt</span>(data.<span class="hljs-property">id</span>, <span class="hljs-number">10</span>)<br>            );<br>            <span class="hljs-keyword">if</span> (arrIndex &gt; -<span class="hljs-number">1</span>) &#123;<br>                list.<span class="hljs-title function_">splice</span>(arrIndex, <span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                list.<span class="hljs-title function_">push</span>(data);<br>            &#125;<br>            <span class="hljs-keyword">return</span> list;<br>        &#125;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;sthDel&#x27;</span>: &#123;<br>            <span class="hljs-keyword">const</span> arrIndex = _.<span class="hljs-title function_">findIndex</span>(<br>                list,<br>                <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-built_in">parseInt</span>(item.<span class="hljs-property">id</span>, <span class="hljs-number">10</span>) === <span class="hljs-built_in">parseInt</span>(data.<span class="hljs-property">id</span>, <span class="hljs-number">10</span>)<br>            );<br>            <span class="hljs-keyword">if</span> (arrIndex &gt; -<span class="hljs-number">1</span>) &#123;<br>                list.<span class="hljs-title function_">splice</span>(arrIndex, <span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> list;<br>        &#125;<br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;sthUpdate&#x27;</span>: &#123;<br>          list.<span class="hljs-property">data</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>              <span class="hljs-keyword">if</span> (<span class="hljs-built_in">parseInt</span>(item.<span class="hljs-property">id</span>, <span class="hljs-number">10</span>) === <span class="hljs-built_in">parseInt</span>(data.<span class="hljs-property">id</span>, <span class="hljs-number">10</span>)) &#123;<br>                item.<span class="hljs-property">xxx</span> = data.<span class="hljs-property">xxx</span>;<br>              &#125;<br>              <span class="hljs-keyword">return</span> item;<br>          &#125;);<br>          <span class="hljs-keyword">return</span> list;<br>        &#125; <br><br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;listClear&#x27;</span>: &#123;<br>            <span class="hljs-keyword">return</span> [];<br>        &#125;<br><br>        <span class="hljs-attr">default</span>:<br>            <span class="hljs-keyword">return</span> list;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="react-redux容器组件"><a href="#react-redux容器组件" class="headerlink" title="react-redux容器组件"></a>react-redux容器组件</h4><p><code>react-redux</code> 使用容器组件来把展示组件连接到Redux ，容器组件向Redux派发actions，同时监听state改变。<br>对于容器组件和展示组件的划分附录中有一篇官网推荐的阅读。目前来说，我在本项目中把需要处理共享数据的页面作为了容器组件，后期可能还要修改下。</p><p>可以使用 <code>mapStateToProps</code> 来订阅 <code>Store</code>，其原理相当于在Store上安装了一个监听器，当Store中state改变了，子组件重新渲染。<br>可以定义 <code>mapDispatchToProps</code> 方法接收dispatch()方法并返回期望注入到展示组件的props中的回调方法。<br>在本项目中把action作为props整合数据，相当于包了一层dispatch的执行。</p><p>假设AList为容器组件，AList中代码如下：</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123;connect&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../components/AItem&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123;<span class="hljs-title class_">AddSth</span>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./actions&#x27;</span>;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = &#123;<br>      <span class="hljs-attr">aList</span>: []<br>    &#125;;<br><br>    getBetList = <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> &#123;list&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>        <span class="hljs-keyword">return</span> list || [];<br>    &#125;<br><br>    listAddHandle = <span class="hljs-function">(<span class="hljs-params">obj</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> &#123;<span class="hljs-title class_">AddSth</span>&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br>        <span class="hljs-title class_">AddSth</span>(obj);<br>    &#125;<br><br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">const</span> aList = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getBetList</span>();<br>        <span class="hljs-keyword">return</span> (<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;</span>&#x27;<span class="hljs-attr">components-alist</span>&#x27;&#125;&gt;</span></span><br><span class="language-xml">          &#123;aList.map((item) =&gt; </span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.id&#125;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">AItem</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;item&#125;</span> <span class="hljs-attr">onAdd</span> = <span class="hljs-string">&#123;this.listAddHandle.bind(this)&#125;/</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>)&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">mapStateToProps</span> = state =&gt; (&#123;<br>    <span class="hljs-attr">aList</span>: state.<span class="hljs-property">list</span><br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">connect</span>(mapItemToProps, &#123;<span class="hljs-title class_">AddSth</span>&#125;)(<span class="hljs-title class_">AList</span>);<br></code></pre></div></td></tr></table></figure><p><code>附录</code>：<br><a href="https://www.redux.org.cn/">Redux</a><br><a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0">Presentational and Container Components</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react笔记（2）websocket实时改变数据</title>
    <link href="/2020/05/14/react%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89websocket%E5%AE%9E%E6%97%B6%E6%94%B9%E5%8F%98%E6%95%B0%E6%8D%AE/"/>
    <url>/2020/05/14/react%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89websocket%E5%AE%9E%E6%97%B6%E6%94%B9%E5%8F%98%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<blockquote><p>项目中有个需求，需要实时改变数据。实时改变数据有两种方式。<br>第一种方式是通过Ajax轮询，浏览器需要不断的向服务器发出请求，在本项目中需要改变数据的地方有多处，连续的Ajax请求对服务器的压力很大，所以不适合这种方式。<br>第二种方式是通过HTML5 定义的 WebSocket 协议，使浏览器和服务器保持持久性的连接，服务端向客户端主动推送信息。<br>本项目中采用了第二种方式，这里对react中使用WebSocket实时改变数据做了一点笔记。</p></blockquote><span id="more"></span><h4 id="WebSocket简介"><a href="#WebSocket简介" class="headerlink" title="WebSocket简介"></a>WebSocket简介</h4><p><code>WebSocket</code> 是 HTML5 开始提供的一种在单个 <code>TCP</code> 连接上进行全双工通讯的协议，本质上是一个基于 <code>TCP</code> 的协议。<br>在 <code>WebSocket API</code> 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行<code>双向数据传输</code>。  </p><h4 id="WebSocket创建、使用API"><a href="#WebSocket创建、使用API" class="headerlink" title="WebSocket创建、使用API"></a>WebSocket创建、使用API</h4><p>创建 WebSocket 对象</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">var</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url, [protocol] );<br></code></pre></div></td></tr></table></figure><p>在获取 WebSocket 连接后，可以通过 <code>send</code> 方法来向服务器发送数据，并通过 <code>onmessage</code> 事件来接收服务器返回的数据。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">ws.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// Web Socket 已连接上，使用 send() 方法发送数据</span><br>  ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;发送数据&quot;</span>);<br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;数据发送中...&quot;</span>);<br>&#125;;<br>                <br>ws.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) &#123; <br>  <span class="hljs-keyword">var</span> received_msg = evt.<span class="hljs-property">data</span>;<br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;数据已接收...&quot;</span>);<br>&#125;;<br>ws.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <br>  <span class="hljs-comment">// 关闭 websocket</span><br>  <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;连接已关闭...&quot;</span>); <br>&#125;;               <br></code></pre></div></td></tr></table></figure><h4 id="react中使用WebSocket"><a href="#react中使用WebSocket" class="headerlink" title="react中使用WebSocket"></a>react中使用WebSocket</h4><p> 首先抽取一个通用方法开启WebSocket</p><figure class="highlight js"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">startWs</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-comment">// wss://域名/api/wsname</span><br><br>    <span class="hljs-keyword">const</span> host = <span class="hljs-string">&#x27;aaa.com&#x27;</span>;<br>    <span class="hljs-keyword">let</span> protocol = <span class="hljs-string">&#x27;wss&#x27;</span>;<br>    <span class="hljs-keyword">const</span> &#123;<span class="hljs-attr">host</span>: host2&#125; = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">protocol</span> === <span class="hljs-string">&#x27;http:&#x27;</span> &amp;&amp; host2 !== <span class="hljs-string">&#x27;localhost:3000&#x27;</span>) &#123;<br>        protocol = <span class="hljs-string">&#x27;ws&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;protocol&#125;</span>://<span class="hljs-subst">$&#123;host&#125;</span>/api/wsname`</span>);<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>在page中使用WebSocket，并将数据传递给组件</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Index</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) &#123;<br>        <span class="hljs-variable language_">super</span>(props);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-title function_">startWs</span>();<br>    &#125;<br><br>    <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">watchWs</span>();<br>    &#125;<br><br>    componentWillUnmount = <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-title function_">close</span>();<br>    &#125;<br><br>    watchWs = <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">evt</span>) =&gt;</span> &#123;<br>            <span class="hljs-keyword">let</span> data = &#123;&#125;;<br>            <span class="hljs-keyword">try</span> &#123;<br>                data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(evt.<span class="hljs-property">data</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (e) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e); &#125;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123;<br>                <span class="hljs-attr">currentData</span>: data,<br>            &#125;);<br>        &#125;;<br>    &#125;<br><br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">const</span> &#123; item, currentData &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>        <span class="hljs-keyword">return</span> (<br>            <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;pages-index&quot;</span> &gt;</span></span><br><span class="language-xml">                 <span class="hljs-tag">&lt;<span class="hljs-name">Item</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;item&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">                    <span class="hljs-attr">currentData</span>=<span class="hljs-string">&#123;currentData&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">                /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>)<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>组件接受数据后实时改变自身。<br>这里使用<code>getDerivedStateFromProps</code>这个生命周期，意思就是从props中获取state，即将传入的props映射到state上面，意味着即使你的props没有任何变化，而是父state发生了变化，导致子组件发生了re-render，这个生命周期函数依然会被调用。<br><code>getDerivedStateFromProps</code>是一个<code>静态函数</code>，也就是这个函数不能通过this访问到class的属性，也并不推荐直接访问属性。而是应该通过参数提供的<code>nextProps</code>以及<code>prevState</code>来进行判断，根据新传入的props来映射到state。</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) &#123;<br>        <span class="hljs-variable language_">super</span>(props);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromProps</span>(<span class="hljs-params">nextProps, prevState</span>) &#123;<br>        <span class="hljs-keyword">const</span> &#123;currentData = &#123;&#125;&#125; = nextProps;<br>        <span class="hljs-keyword">if</span> (currentData !== prevState.<span class="hljs-property">currentData</span>) &#123;<br>          <span class="hljs-keyword">return</span> newObj &#123;<br>            <span class="hljs-attr">attr</span>: attr1<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">const</span> &#123;newObj&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>        <span class="hljs-keyword">return</span> (<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;components-item&quot;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;newObj.attr&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>)<br>        &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>这里Item组件通过接受父组件的props来改变自身状态。</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react笔记（1）父子组件通信</title>
    <link href="/2020/05/07/react%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/"/>
    <url>/2020/05/07/react%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<blockquote><p> 最近做了一个pc项目，技术选型为react，中间涉及到了各种状态管理、消息传递，做个小小的笔记记录下，方便以后做同类项目可以快速起步。</p></blockquote><span id="more"></span><h4 id="项目使用框架版本"><a href="#项目使用框架版本" class="headerlink" title="项目使用框架版本"></a>项目使用框架版本</h4><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@babel/preset-react&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^7.9.4&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;react&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^16.12.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;webpack&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;4.41.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><h4 id="父组件传递消息给子组件"><a href="#父组件传递消息给子组件" class="headerlink" title="父组件传递消息给子组件"></a>父组件传递消息给子组件</h4><p>父组件可以向子组件通过传 <code>props</code> 的方式进行通信。<br>子组件Child.jsx</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>)&#123;<br>        <span class="hljs-variable language_">super</span>(props);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = &#123;<br>            <span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;ginny is a child&#x27;</span>,<br>            <span class="hljs-attr">message</span>:<span class="hljs-string">&#x27;&#x27;</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-keyword">const</span> &#123;name&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>      <span class="hljs-keyword">const</span> &#123;message&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br>        <span class="hljs-keyword">return</span>(<br>            <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;component-child&quot;</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;message&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>        )<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>父组件Father.jsx</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Child&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Father</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>)&#123;<br>        <span class="hljs-variable language_">super</span>(props);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = &#123;<br>            <span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;I am father&#x27;</span>,<br>            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Here is a message&#x27;</span><br>        &#125;<br>    &#125;<br><br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123;message&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;component-father&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&#123;message&#125;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    );<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="子组件传递消息给父组件"><a href="#子组件传递消息给父组件" class="headerlink" title="子组件传递消息给父组件"></a>子组件传递消息给父组件</h4><p>子组件向父组件通讯，也是通过父组件向子组件传递 <code>props</code> 进行通讯，只是父组件传递的，是作用域为父组件自身的函数。子组件调用该函数，把想要传递的信息以参数的方式传递给父组件。<br>在子组件Child中绑定 onClick 事件。 调用 change 方法，在change方法中调用父组件的 childClick 方法。<br>子组件Child.jsx</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>)&#123;<br>        <span class="hljs-variable language_">super</span>(props);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>=&#123;<br>            <span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;ginny is a child&#x27;</span>,<br>            <span class="hljs-attr">messageFromChild</span>:<span class="hljs-string">&#x27;Here is a message from ginny!&#x27;</span><br>        &#125;<br>    &#125;<br><br>    change = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">childClick</span>(msg);<br>    &#125;<br><br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-keyword">const</span> &#123;name, messageFromChild&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>      <span class="hljs-keyword">const</span> &#123;message&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br>        <span class="hljs-keyword">return</span>(<br>            <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;component-child&quot;</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;message&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;this.change.bind(this,</span> <span class="hljs-attr">messageFromChild</span>)&#125;&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>        )<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>父组件Father.jsx</p><figure class="highlight jsx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Child&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Father</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>)&#123;<br>        <span class="hljs-variable language_">super</span>(props);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = &#123;<br>            <span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;I am father&#x27;</span>,<br>            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Here is a message&#x27;</span><br>        &#125;<br>    &#125;<br>  childClickHandle = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Message form child is:&#x27;</span> + msg);<br>  &#125;<br><br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123;message&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;component-father&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&#123;message&#125;</span> <span class="hljs-attr">childClick</span>=<span class="hljs-string">&#123;this.childClickHandle&#125;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    );<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="函数this指向"><a href="#函数this指向" class="headerlink" title="函数this指向"></a>函数this指向</h4><p>本项目中涉及到各种函数调用，所以最后对 <code>this</code> 的指向问题稍微加一个小小的总结。<br>非箭头函数：<br>(1) <code>this</code> 指向调用其所在函数的对象（离其最近的对象）；<br>(2) 构造函数下，<code>this</code>与被创建的新对象绑定；<br>(3) DOM事件，<code>this</code>指向触发事件的元素；<br>(3) 当函数通过Function对象的原型中继承的方法 <code>call</code> 和 <code>apply</code> 方法调用时， 其函数内部的<code>this</code>值可绑定到 <code>call</code>和<code>apply</code> 方法指定的第一个对象上， 如果第一个参数不是对象，JavaScript内部会尝试将其转换成对象然后指向它；<br>(4) 通过<code>bind</code>方法绑定后， 函数将被永远绑定在其第一个参数对象上， 而无论其在什么情况下被调用；<br>(5) 当代码被内联处理函数调用时，它的<code>this</code>指向监听器所在的DOM元素；<br>(6) 当代码被包括在函数内部执行时，其<code>this</code>指向等同于 函数直接调用的情况，即在非严格模式指向全局对象<code>window</code>， 在严格模式指向<code>undefined</code>；<br>(7) 对于延时函数内部<code>setTimeout</code>和<code>setInterval</code>的回调函数的<code>this</code>指向全局对象<code>window</code>。<br>箭头函数：<br>(8) 箭头函数不绑定this， 它会捕获其所在（即定义的位置）上下文的<code>this</code>值， 作为自己的this值，<code>call,apply,bind</code>方法对于箭头函数来说只是传入参数，对它的<code>this</code> 无影响；</p><p>在本项目中，如果组件触发自身的方法，需要将方法写成箭头函数的形式，这样调用的时候就会指向自身，可以获取自身的state等等属性。如果不写成箭头函数，只是普通函数，则在绑定函数的地方需要使用this.change.bind(this)，把组件当前的this绑定在函数上。</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ngixn笔记（1） 前后端跨域设置</title>
    <link href="/2019/08/12/ngixn%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E5%89%8D%E5%90%8E%E7%AB%AF%E8%B7%A8%E5%9F%9F%E8%AE%BE%E7%BD%AE/"/>
    <url>/2019/08/12/ngixn%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89%E5%89%8D%E5%90%8E%E7%AB%AF%E8%B7%A8%E5%9F%9F%E8%AE%BE%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<blockquote><p>最近公司项目需要我调用别的部门开发的接口，由于部门之间服务器独立，必然涉及到了跨域问题。这篇文章记录了我配置的nginx，前后端允许跨域。</p></blockquote><span id="more"></span><h3 id="跨域的产生"><a href="#跨域的产生" class="headerlink" title="跨域的产生"></a>跨域的产生</h3><p>首先明确跨域的产生是由于浏览器通源策略，限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。</p><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>发了请求之后迟迟没有收到回复，打开控制台一看，请求404了，再仔细找原因之后发现，我原来发送的<code>post</code>请求变成了<code>option</code>请求。<br><img src="/img/nginx1-error2.png" alt="chrome跨域"></p><p>chrome认为前端没有添加头部信息，所以不允许前端页面发出请求。<br><img src="/img/nginx1-error1.png" alt="chrome跨域"></p><h3 id="后端允许跨域（开发环境）"><a href="#后端允许跨域（开发环境）" class="headerlink" title="后端允许跨域（开发环境）"></a>后端允许跨域（开发环境）</h3><p>服务器默认是不被允许跨域的。给Nginx服务器配置<code>Access-Control-Allow-Origin *</code>后，表示服务器可以接受所有的请求源（Origin）,即接受所有跨域的请求。 <code>Access-Control-Allow-Methods</code> 是为了防止出现Content-Type is not allowed by Access-Control-Allow-Headers in preflight response. <code>Access-Control-Allow-Headers</code>是为了防止出现当前请求<code>Content-Type</code>的值不被支持，当发起了<code>application/json</code>的类型请求时添加这个头可以解决。<br>服务器nginx添加以下配置：</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">location /myurl/ &#123;  <br>    add_header Access-Control-Allow-Origin *;<br>    add_header Access-Control-Allow-Methods <span class="hljs-string">&#x27;GET, POST, OPTIONS&#x27;</span>;<br>    add_header Access-Control-Allow-Headers <span class="hljs-string">&#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#x27;</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_method</span> = <span class="hljs-string">&#x27;OPTIONS&#x27;</span>) &#123;<br>        <span class="hljs-built_in">return</span> 204;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h3><p>对那些可能对服务器数据产生副作用的HTTP请求方法（特别是<code>GET</code>以外的HTTP请求，或者搭配某些MIME类型的<code>POST</code>请求），浏览器必须首先使用 <code>OPTIONS</code>方法发起一个预检请求（preflight request），从而获知服务端是否允许该跨域请求。服务器确认允许之后，才发起实际的HTTP请求。在预检请求的返回中，服务器端也可以通知客户端，是否需要携带身份凭证（包括 Cookies 和 HTTP 认证相关数据）。</p><p>Content-Type不属于以下MIME类型的，都属于预检请求：</p><figure class="highlight txt"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs txt">application/x-www-form-urlencoded<br>multipart/form-data<br>text/plain<br></code></pre></div></td></tr></table></figure><p><code>OPTIONS</code>先行验证是否允许跨域，若不允许，就不会进行下一个<code>POST</code>请求，所以之前会出现请求404的情况。</p><h3 id="后端允许跨域（生产环境）"><a href="#后端允许跨域（生产环境）" class="headerlink" title="后端允许跨域（生产环境）"></a>后端允许跨域（生产环境）</h3><p>此时处于生产环境，允许所有请求不太安全，所以可以由后端自定义请求的格式，当格式符合条件时，才添加跨域头。<br>后端接口一般带有统一前缀，这里设置所有带有<code>api</code>的请求都可以绕过跨域限制。<br><code>nginx.conf</code>中修改结果如下：</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">location /api &#123;<br>    add_header <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="hljs-string">&#x27;*&#x27;</span>;<br>    add_header <span class="hljs-string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="hljs-string">&#x27;true&#x27;</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="前端允许跨域（生产环境）"><a href="#前端允许跨域（生产环境）" class="headerlink" title="前端允许跨域（生产环境）"></a>前端允许跨域（生产环境）</h3><p>由于这个项目涉及到了不同部门的接口，某个前辈的接口并没有按照规定来写，所以这里前端需要自己修改一下地址格式。<br>例如：原来的请求地址为<code>http://abc.com/origin</code>，现在设计一个新的请求地址<code>http://abc.com/myapi/origin</code><br>修改nginx配置如下：</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">location @router &#123;<br>    rewrite ^.*$ /index.html last;<br>&#125;   <br>location /myurl/ &#123;<br>    root /home/guoningyan/myproject/;<br>    index index.html;<br>    try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ @router;<br>&#125;<br><br>location /myapi/origin &#123;<br>    proxy_pass http://abc.com/origin;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>意思为当发送的请求以<code>/myapi/origin</code>为后缀时，自动代理到原请求地址<code>http://abc.com/origin</code>。<br>有一点要注意的是，在<code>nginx</code>中配置<code>proxy_pass</code>代理转发时，如果在<code>proxy_pass</code>后面的url加&#x2F;，表示绝对根路径；如果没有&#x2F;，表示相对路径。</p><h3 id="常用配置简单写法"><a href="#常用配置简单写法" class="headerlink" title="常用配置简单写法"></a>常用配置简单写法</h3><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">location /consolefe/ &#123;<br>  root /data/gny; <br>  index index.html index.htm;<br>  try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /consolefe/;<br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>nginx</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue2笔记（1）</title>
    <link href="/2019/07/12/vue2%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/"/>
    <url>/2019/07/12/vue2%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>最近的项目用了vue2.0，备忘一些关键用法。这是第一篇，需求为展示一堆带有各自内容的卡牌，鼠标在卡牌上悬停时展示文字细节，点击时切换vue-router，所有数据在初始化时通过数组获取。本篇主要内容为v-for实现卡牌渲染，包括图片、文字绑定，针对特定卡片进行css特效选择等等。</p></blockquote><span id="more"></span><h3 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h3><p><img src="/img/vue_cards.png" alt="cards"></p><h3 id="需求切分"><a href="#需求切分" class="headerlink" title="需求切分"></a>需求切分</h3><ol><li><p>数据格式为json，在data中输出</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">caseList<span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;link&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/taxi&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Taxi tickets recognization --- quickly find out date, distance, price and so on. &quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;CV&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;img&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;../assets/taxi-icon.png&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br></code></pre></div></td></tr></table></figure></li><li><p>使用v-for实现数组元素的循环渲染卡牌</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item,index) in caseList&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span>       <br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">item.img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span>&#123;&#123;item.text&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;des&quot;</span>&gt;</span>&#123;&#123;item.title&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>     <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p> 这个时候遇到一个问题，浏览器中图片并没有加载出来。<br> 我首先检查了一下相对路径没有问题，然后想到当把图片硬编码在html中时，<code>webpack</code>打包会用<code>loader</code>打包图片，这样图片的位置就改变了，所以需要在加载图片数据时加入<code>require</code>，这样图片就能展示出来了。<br> 修改如下:</p> <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-string">&quot;img&quot;</span>:<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../assets/taxi-icon.png&quot;</span>)<br></code></pre></div></td></tr></table></figure></li><li><p>点击卡牌跳转页面<br>使用<code>router</code>来实现，<code>router</code>中也可以直接修改tag属性</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">item.link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><br></code></pre></div></td></tr></table></figure></li><li><p>鼠标悬停在卡牌上方时出现特效<br>这里将<code>mouseenter</code>和<code>mouseleave</code>配合使用，通过改变DOM元素class的方式实现效果。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"> <span class="hljs-tag">&lt;<span class="hljs-name">li</span> @<span class="hljs-attr">mouseenter</span>=<span class="hljs-string">&quot;enterCase&quot;</span> </span><br><span class="hljs-tag">    @<span class="hljs-attr">mouseleave</span>=<span class="hljs-string">&quot;leaveCase&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item,index) in caseList&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-bind:class</span>=<span class="hljs-string">&quot;[isHoverCase ? &#x27;img-change&#x27; : &#x27;img-wrap&#x27; ]&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br></code></pre></div></td></tr></table></figure> <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">data () &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">isHoverCase</span>:<span class="hljs-literal">false</span><br>  &#125;<br>&#125;,<br>methods () &#123;<br>    <span class="hljs-title function_">enterCase</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isHoverCase</span> = <span class="hljs-literal">true</span>;<br>    &#125;,<br>    <span class="hljs-title function_">leaveCase</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isHoverCase</span> = <span class="hljs-literal">false</span>;<br>    &#125; <br> &#125; <br></code></pre></div></td></tr></table></figure><p> 这时候出现了新的问题，当鼠标悬停在一张卡牌上时，所有的卡牌出现了相同的特效。<br> 思考了一下，这里我把isHoverCase设置成了所有卡牌都能访问的变量，当其中一个改变时，自然所有卡牌的class都改变了。<br> 查询资料后了解到设置index可以解决这个问题，于是给每一张卡牌添加了<code>isHoverCase:false</code>，在元素方法中添加<code>@mouseleave=&quot;leaveCase(index)&quot;</code>，元素class修改为<code>v-bind:class=&quot;[item.isHoverCase ? &#39;img-change&#39; : &#39;img-wrap&#39; ]&quot;</code>，完美解决。</p></li></ol><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><p>template写法如下：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> @<span class="hljs-attr">mouseenter</span>=<span class="hljs-string">&quot;enterCase(index)&quot;</span> @<span class="hljs-attr">mouseleave</span>=<span class="hljs-string">&quot;leaveCase(index)&quot;</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item,index) in caseList&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">item.link</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-bind:class</span>=<span class="hljs-string">&quot;[item.isHoverCase ? &#x27;img-change&#x27; : &#x27;img-wrap&#x27; ]&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">item.img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span>&#123;&#123;item.text&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;des&quot;</span>&gt;</span>&#123;&#123;item.title&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>javascrip写法t如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>     data () &#123;<br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">caseList</span>:[&#123;<br>          <span class="hljs-attr">link</span>:<span class="hljs-string">&#x27;/taxi&#x27;</span>,<br>          <span class="hljs-attr">text</span>:<span class="hljs-string">&#x27;Taxi tickets recognization --- quickly find out date, distance, price and so on. &#x27;</span>,<br>          <span class="hljs-attr">title</span>:<span class="hljs-string">&#x27;CV&#x27;</span>,<br>          <span class="hljs-attr">img</span>:<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../assets/taxi-icon.png&#x27;</span>),<br>          <span class="hljs-attr">isHoverCase</span>:<span class="hljs-literal">false</span><br>        &#125;,&#123;<br>          <span class="hljs-attr">link</span>:<span class="hljs-string">&#x27;/translate&#x27;</span>,<br>          <span class="hljs-attr">text</span>:<span class="hljs-string">&#x27;Chinese-English translation --- use our dictionary to translate your sentences.&#x27;</span>,<br>          <span class="hljs-attr">title</span>:<span class="hljs-string">&#x27;NLP&#x27;</span>,<br>          <span class="hljs-attr">img</span>:<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../assets/translate-icon.png&#x27;</span>),<br>          <span class="hljs-attr">isHoverCase</span>:<span class="hljs-literal">false</span><br>        &#125;],<br>      &#125;<br>     &#125;,<br>     <span class="hljs-attr">methods</span>: &#123;<br>       <span class="hljs-title function_">enterCase</span>(<span class="hljs-params">index</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">caseList</span>[index].<span class="hljs-property">isHoverCase</span> = <span class="hljs-literal">true</span>;<br>      &#125;,<br>      <span class="hljs-title function_">leaveCase</span>(<span class="hljs-params">index</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">caseList</span>[index].<span class="hljs-property">isHoverCase</span> = <span class="hljs-literal">false</span>;<br>      &#125;  <br>     &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h3 id="debug遇到问题"><a href="#debug遇到问题" class="headerlink" title="debug遇到问题"></a>debug遇到问题</h3><p>在适配手机样式时出现了一个小问题，我需要将手机链接电脑后用ip进行访问，但是当我将<code>vue-cli</code>起的服务<code>127.0.0.1:8080</code>改成本机<code>ip:8080</code>时，出现网页无法访问的情况。<br><img src="/img/openfail.png" alt="网页无法访问"><br>查询资料后发现，需要在<code>build/webpack.dev.conf.js</code>中间修改host，将<code>host:127.0.0.1</code>修改为<code>host:0.0.0.0</code>，重启服务，通过ip可以正常访问。</p><h3 id="Mixin"><a href="#Mixin" class="headerlink" title="Mixin"></a>Mixin</h3><p>mixin用于组件共用逻辑抽取<br>vue组件初始化时，会将引入的mixin对象与当前组件进行合并（组件本身优先级更高，会覆盖冲突）<br>生命周期钩子函数，会先触发mixin中的钩子，然后触发组件的钩子</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-attr">mixin</span>: [<span class="hljs-title class_">MixinTest</span>] <span class="hljs-comment">// 数组，可以同时注册多个mixin</span><br>&#125;<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue+flask前后端分离项目（3）</title>
    <link href="/2019/06/20/vue-flask%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%EF%BC%883%EF%BC%89/"/>
    <url>/2019/06/20/vue-flask%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%EF%BC%883%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这是总结第三篇，包括linux服务器中nginx安装配置，使用nginx部署服务，以及允许跨域资源访问。</p></blockquote><span id="more"></span><p><code>Linux</code>中安装<code>nginx</code>网上很多文章都有写，附录链接中有我推荐的一篇。<br>简单的可以使用<code>apt-get</code>安装，但因为我没有root权限，所以只能通过源码安装，幸好服务器中大佬已经安装好gcc环境了，我只需要下载好直接编译就行。</p><h4 id="nginx安装"><a href="#nginx安装" class="headerlink" title="nginx安装"></a>nginx安装</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">wget http://nginx.org/download/nginx-1.17.0.tar.gz<br>tar -zxvf nginx-1.17.0.tar.gz<br><span class="hljs-built_in">cd</span> nginx-1.17.0/<br>./configure --prefix=nginx<br>make &amp;&amp; make install<br></code></pre></div></td></tr></table></figure><p>启动nginx</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> nginx/<br>./sbin/nginx<br></code></pre></div></td></tr></table></figure><p>若遇到端口占用，可以先杀死进程再启动。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">ps -A | grep nginx<br><span class="hljs-built_in">kill</span> -9 pid<br></code></pre></div></td></tr></table></figure><p>在浏览器输入 <a href="http://ip:port">http://ip:port</a> 地址，出现<code>Welcome to nginx!</code>即为安装成功。</p><h4 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h4><p>接下来是修改端口，因为在服务器中我没有root权限，所以需要在<code>nginx.conf</code>中修改<code>listen</code>端口，并且端口号需要是大于1024的任何一个数字。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">vi ~/nginx-1.17.0/nginx/conf/nginx.conf<br></code></pre></div></td></tr></table></figure><p><code>nginx.conf</code>中修改结果如下：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">server &#123;<br>    listen       1025;<br>    server_name  localhost;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>dist</code>文件夹是我的前端项目打包后生成的文件，存放于<code>/home/myname</code>之中，作为静态文件的根目录，我希望在浏览器中输入 <a href="http://ip:port">http://ip:port</a> 可以直接访问到dist中首页，所以还要修改下配置。<br><code>nginx.conf</code>中修改结果如下：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"> server &#123;<br>     listen       1025;<br>     server_name  localhost;<br><br>     location / &#123;<br>         root   root /home/myname/dist;<br>         index  index.html index.htm;<br>     &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h4 id="nginx跨域访问配置"><a href="#nginx跨域访问配置" class="headerlink" title="nginx跨域访问配置"></a>nginx跨域访问配置</h4><p>接下来在<code>nginx</code>中添加允许跨域访问，设置所有带有<code>api</code>的请求都可以绕过跨域限制。<br><code>nginx.conf</code>中修改结果如下：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">location /api &#123;<br>    add_header <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="hljs-string">&#x27;*&#x27;</span>;<br>    add_header <span class="hljs-string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="hljs-string">&#x27;true&#x27;</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>一般还需要在第一行添加：（没有root权限的用户这一行是不起作用的）</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">user root owner;<br></code></pre></div></td></tr></table></figure><p>保存修改后重启<code>nginx</code>，用浏览器打开 <a href="http://ip:1025/">http://ip:1025</a> ，就能直接访问到前端首页啦～也能顺利和服务端进行数据请求～愉快！</p><p><code>附录</code>：<br><a href="https://www.jianshu.com/p/7cb1a824333e">Linux环境nginx配置</a><br><a href="https://blog.csdn.net/shixiufang/article/details/44309971">如何在没有root权限下安装Nginx</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>nginx</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue+flask前后端分离项目（2）</title>
    <link href="/2019/06/20/vue-flask%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%EF%BC%882%EF%BC%89/"/>
    <url>/2019/06/20/vue-flask%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%EF%BC%882%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这是总结第二篇，总结flask项目搭建，restful接口设计，以及返回结果中添加允许跨域头。</p></blockquote><span id="more"></span><h4 id="flask搭建server端"><a href="#flask搭建server端" class="headerlink" title="flask搭建server端"></a>flask搭建server端</h4><p>本项目采用<code>python3</code>环境，使用<code>pip3</code>安装依赖包。<br>如果直接用命令行生成<code>flask</code>项目，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> myProject<br><span class="hljs-built_in">cd</span> myProject<br>pip3 install flask<br></code></pre></div></td></tr></table></figure><h4 id="定义restful接口返回"><a href="#定义restful接口返回" class="headerlink" title="定义restful接口返回"></a>定义restful接口返回</h4><p>将<code>response</code>定义为如下格式的返回结果，其中<code>code=0</code>代表成功，<code>msg</code>由server端自定义返回结果的文字描述，<code>data</code>中为需要回传给客户端的内容，定义为<code>json</code>格式。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> jsonify<br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/upload&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():<br>    res = jsonify(&#123;<br>        <span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&#x27;msg&#x27;</span>: <span class="hljs-string">&#x27;ok&#x27;</span>,<br>        <span class="hljs-string">&#x27;data&#x27;</span>: &#123; <br>            <span class="hljs-string">&#x27;text&#x27;</span>: <span class="hljs-string">&#x27;这里是返回结果&#x27;</span><br>        &#125;<br>    &#125;)<br>    <span class="hljs-keyword">return</span> res<br></code></pre></div></td></tr></table></figure><p>我的前端请求使用的是<code>formData</code>格式，需要将请求变为字典格式后用<code>key-value</code>进行取值，遇到<code>file</code>形式的数据则直接使用<code>request.files[&#39;file&#39;]</code>进行取值。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request<br><br>data = request.form.to_dict()<br>username = data.get(<span class="hljs-string">&#x27;username&#x27;</span>)<br>file = request.files[<span class="hljs-string">&#x27;file&#x27;</span>]<br></code></pre></div></td></tr></table></figure><h4 id="flask中允许跨域"><a href="#flask中允许跨域" class="headerlink" title="flask中允许跨域"></a>flask中允许跨域</h4><p>在返回结果中允许跨域需要使用<code>flask_cors</code>：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">pip3 install flask-cors<br></code></pre></div></td></tr></table></figure><p>server端添加如下代码：</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask_cors <span class="hljs-keyword">import</span> *<br>app = Flask(__name__)<br>CORS(app, resources=<span class="hljs-string">r&#x27;/*&#x27;</span>)<br><br>res.headers[<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>] = <span class="hljs-string">&#x27;*&#x27;</span><br>res.headers[<span class="hljs-string">&#x27;Access-Control-Allow-Methods&#x27;</span>] = <span class="hljs-string">&#x27;POST,GET,OPTIONS&#x27;</span><br>res.headers[<span class="hljs-string">&#x27;Access-Control-Allow-Headers&#x27;</span>] = <span class="hljs-string">&#x27;x-requested-with,content-type&#x27;</span><br></code></pre></div></td></tr></table></figure><h4 id="跨域小结"><a href="#跨域小结" class="headerlink" title="跨域小结"></a>跨域小结</h4><p>在（1）中已经总结了在开发环境中绕过跨域限制，现在对跨域作一个小结。<br>跨域是指从一个域名的网页去请求另一个域名的资，更加严格一点的定义是：只要协议，域名，端口有任何一个的不同，就被当作是跨域。<br>CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing）。它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。<br>实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。<br>经过测试，确实是只要server添加头信息，不管我是本地起的服务还是其他http服务，都能和接口顺利通信。</p><p><code>附录</code>：<br><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html">跨域资源共享 CORS 详解</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue+flask前后端分离项目（1）</title>
    <link href="/2019/06/20/vue-flask%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%EF%BC%881%EF%BC%89/"/>
    <url>/2019/06/20/vue-flask%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>最近公司项目需要我进行包装一下，厉害的大佬们训练好模型，全周期工程师我负责在用户和大佬代码之间搭桥，用vue+flask完成整个项目的搭建和部署。<br>写完前端写后端，写完后端改nginx，改完nginx配服务器环境，全周期超爽有木有～<br>这是总结第一篇，总结vue搭建纯前端项目以及在开发环境配置nodejs反向代理绕过浏览器跨域限制。</p></blockquote><span id="more"></span><h4 id="新建vue项目"><a href="#新建vue项目" class="headerlink" title="新建vue项目"></a>新建vue项目</h4><p>本项目的node和npm为全局安装版本，<code>node&gt;=6.0.0</code>，<code>npm&gt;=3.0.0</code>，使用<code>vue-cli</code>进行一键配置。<br>新建项目命令：</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> projectName<br>vue init webpack client<br><span class="hljs-built_in">cd</span> client<br>npm run dev<br></code></pre></div></td></tr></table></figure><p>用浏览器打开<code>http://127.0.0.1:8080</code>看到有<code>vue</code>图片出现即启动成功。</p><p>文件目录格式如下图所示，需要在<code>component</code>中编写<code>vue</code>组件，在<code>router</code>中的<code>index.js</code>中配置路由。<br><img src="/img/vue_pro.png" alt="vue目录结构"></p><p>这时可能会出现一个问题，例如需要访问页面<code>http://://127.0.0.1:8080/a/</code>，浏览器却始终显示首页内容，url显示为<code>http://://127.0.0.1:8080/a#/</code>，解决方式是在<code>index.js</code>中添加一个<code>mode</code>参数，充分利用 <code>history.pushState</code> API来完成URL跳转。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>(&#123;<br>  <span class="hljs-attr">mode</span>:<span class="hljs-string">&#x27;history&#x27;</span>,<br>  <span class="hljs-attr">routes</span>: [&#123;&#125;]<br>&#125;);<br></code></pre></div></td></tr></table></figure><p>生成打包命令：</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">npm run build<br></code></pre></div></td></tr></table></figure><p>打包将在原目录下生成<code>dist</code>文件夹，<code>static</code>下面是打包后的静态文件<br><img src="/img/vue_dist.png" alt="dist目录"> </p><h4 id="vue中使用less"><a href="#vue中使用less" class="headerlink" title="vue中使用less"></a>vue中使用less</h4><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">cnpm install less less-loader --save--dev<br></code></pre></div></td></tr></table></figure><p><code>style</code>中添加如下代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vue">&lt;style lang=&quot;less&quot; scoped&gt;<br>@import &#x27;../assets/reset.less&#x27;; <br>&lt;/style&gt;<br></code></pre></div></td></tr></table></figure><h4 id="使用axios发送请求"><a href="#使用axios发送请求" class="headerlink" title="使用axios发送请求"></a>使用axios发送请求</h4><p><code>vue</code>中推荐使用<code>axios</code>进行<code>http</code>请求处理。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">cnpm install axios --save--dev<br></code></pre></div></td></tr></table></figure><p><code>script</code>中这样使用：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;axios&#x27;</span>;<br>axios.<span class="hljs-title function_">post</span>(reqPath+<span class="hljs-string">&#x27;upload&#x27;</span>,form,config).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> data = res.<span class="hljs-property">data</span>;<br>    <span class="hljs-keyword">if</span>(data.<span class="hljs-property">code</span> == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">//do something </span><br>    &#125;<br>    &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);<br> &#125;);<br></code></pre></div></td></tr></table></figure><h4 id="开发环境允许跨域"><a href="#开发环境允许跨域" class="headerlink" title="开发环境允许跨域"></a>开发环境允许跨域</h4><p>当我的客户端发起一个<code>post</code>请求后，迟迟没有收到server端的返回结果，打开控制台，发现了以下提示：<br><img src="/img/error2.png" alt="浏览器跨域"><br>在求助一个朋友之后得知，chrome内核已经把http头为json的返回强制做了cros ，即使加了跨域头也不行。所以需要在开发环境中使用nodejs做反向代理。<br>在<code>build/webpack.dev.conf.js</code>中修改代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-attr">devServer</span>: &#123;<br>    <span class="hljs-attr">proxy</span>: &#123;<br>      <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>        <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;serverip:port&#x27;</span>,<br>        <span class="hljs-attr">headers</span>: &#123;<br>          <span class="hljs-string">&#x27;host&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>这样配置之后，请求接口时不要写完整地址，写成例如<code>./api/upload</code>的形式，即可绕过跨域限制。</p><h4 id="记录一个问题"><a href="#记录一个问题" class="headerlink" title="记录一个问题"></a>记录一个问题</h4><p>我在向后端发请求时还遇到过这样一个问题：<br><img src="/img/error1.png" alt="error1"><br>查阅资料后发现时找不到资源，我重启服务端之后问题解决。</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MathQuiz-an Android Project</title>
    <link href="/2017/11/17/MathQuiz-an-Android-Project/"/>
    <url>/2017/11/17/MathQuiz-an-Android-Project/</url>
    
    <content type="html"><![CDATA[<blockquote><p>MathQuiz是我在香港大学学习Smart Phone这门课程的个人作业，一个用来进行数学测验的android app。<br>使用API Level 24 with minimum API Level 21，使用AVD (Nexus S with resolution 800X480).<br>这篇文章将归纳我做这个小项目过程中遇到的难点和收获。</p></blockquote><span id="more"></span><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><p>这个项目我使用了android studio，app是root目录，manifests是配置文件，java是编写的业务代码文件，res是资源文件。<br><img src="/img/android-content.png" alt="android studio 文件目录结构"></p><h4 id="重要代码demo"><a href="#重要代码demo" class="headerlink" title="重要代码demo"></a>重要代码demo</h4><p><code>页面跳转</code></p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(getBaseContext(), GradeActivity.class);<br>intent.putExtra(<span class="hljs-string">&quot;ansCorrect&quot;</span>,ansCorrect);<br>startActivity(intent);<br></code></pre></div></td></tr></table></figure><p><code>用户输入答案保留两位小数</code><br>这里我用了监听用户输入，当用户输入小数位数超过两位时，调用处理函数</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">checkDecimal</span><span class="hljs-params">(String text)</span>&#123;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">ifFormat</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (text.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> text.indexOf(<span class="hljs-string">&quot;.&quot;</span>);<br>            <span class="hljs-keyword">if</span> (index + <span class="hljs-number">3</span> &lt; text.length()) &#123;<br>                initPrompt(<span class="hljs-string">&quot;Warning&quot;</span>,<span class="hljs-string">&quot;If your answers are not integers, please round them to 2 decimal places.&quot;</span>);<br>                ifFormat = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ifFormat;<br>    &#125;<br></code></pre></div></td></tr></table></figure><p><code>自定义图标提示框</code></p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">initPrompt</span><span class="hljs-params">(String txt, String msg)</span> &#123;<br>        <span class="hljs-type">LayoutInflater</span> <span class="hljs-variable">inflater</span> <span class="hljs-operator">=</span> getLayoutInflater();<br>        <span class="hljs-type">View</span>  <span class="hljs-variable">dialog</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.prompt,(ViewGroup)findViewById(R.id.dialog;<br>        AlertDialog.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-type">TextView</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> (TextView)dialog.findViewById(R.id.tv);<br>        message.setText(msg);<br>        builder.setTitle(txt);<br>        builder.setPositiveButton(<span class="hljs-string">&quot;OK&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DialogInterface</span>.OnClickListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(DialogInterface dialog, <span class="hljs-type">int</span> which)</span> &#123;<br>            &#125;<br>        &#125;);<br>        builder.setView(dialog);<br>        builder.setIcon(R.drawable.logo);<br>        builder.show();<br>    &#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/dialog&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;horizontal&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_margin</span>=<span class="hljs-string">&quot;8dp&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/tv&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;textview show&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h4 id="神奇的错误"><a href="#神奇的错误" class="headerlink" title="神奇的错误"></a>神奇的错误</h4><p>在我调试代码的过程中控制台出现了这样的错误提示：</p><figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"> <span class="hljs-attribute">10</span>-<span class="hljs-number">22</span> <span class="hljs-number">14</span>:<span class="hljs-number">00</span>:<span class="hljs-number">11</span>.<span class="hljs-number">310</span> <span class="hljs-number">1689</span>-<span class="hljs-number">1689</span>/com.android.inputmethod.latin E/RichInputConnection: Unable to connect to the editor to retrieve text.<br><span class="hljs-attribute">10</span>-<span class="hljs-number">22</span> <span class="hljs-number">14</span>:<span class="hljs-number">00</span>:<span class="hljs-number">11</span>.<span class="hljs-number">310</span> <span class="hljs-number">1689</span>-<span class="hljs-number">1689</span>/com.android.inputmethod.latin D/RichInputConnection: Will try to retrieve text later.<br></code></pre></div></td></tr></table></figure><p>这个错误会导致控制台无法打印信息，给我的调试带来很大的麻烦。我google了很久也没有找到合适的解决方案，最后我重建了一个项目，将相关代码复制才强硬解决了这个问题，如果还有好的方式，希望看到的人能联系我，谢谢了。</p><p><code>附录</code><br><a href="https://github.com/ginny315/MathQuizAssignment">项目成果 &amp; github链接</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>工作（2）上海工作</title>
    <link href="/2017/07/01/%E5%B7%A5%E4%BD%9C%EF%BC%882%EF%BC%89%E4%B8%8A%E6%B5%B7%E5%B7%A5%E4%BD%9C/"/>
    <url>/2017/07/01/%E5%B7%A5%E4%BD%9C%EF%BC%882%EF%BC%89%E4%B8%8A%E6%B5%B7%E5%B7%A5%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<p>2015年11月到2016年4月我随着原来的团队从一号店到了壹药网，2016年6月我大学毕业了，之后的一年一直在壹药网html5团队工作。</p><p>跟着这个团队两年的时间，从fresh man到一个可以自己做中等项目，为大型项目贡献代码的工程师，一路以来我经历了很多，也成长了很多。</p><span id="more"></span><p>团队有个创新项目“健康助手”（又名小依赖）app，主要用来帮助用户养成良好的生活习惯，顺便和公司的产品相结合，打卡竞赛排名靠前的用户将获得公司的奖励，也是公司产品的营销类app。这个项目采用hybrid架构，我们组承担了h5的功能编写，native端的解决方案则由其他同事承担。很荣幸，我深度参与了这个项目。</p><p>项目初期我承担了angular后台代码编写，由于竞赛规则设计的非常复杂，逻辑非常多，那段时间我每天都用大量时间在代码调试上，同时我还在写毕业设计，承受了很大的压力，但是最终我还是在规定时间完成了任务。</p><p>刚工作那段时间也是这个项目的迭代期，我负责了微信营销部分的代码编写，即邀请用户参与挑战。我阅读了很多微信的接口文档，也对hybrid底层交互进行了研究。同时我也参与了部分组件的编写。印象最深的是我编写的打卡成果统计的组件，这个app是基于系统时间的，测试只能在更改系统时间后进行。真正release（热更新上线）之后，晚上十点我拿着手机等待我的“按钮”（打卡成果统计的入口）出现，结果等了10秒钟都没出来，当时我特别惊慌，似乎懂了“程序员背锅”这个情景，这是我第一次参与的多用户线上项目的更新，难道出现了测试时没有出现的bug？还好又过了5秒之后，按钮出现了，虚惊一场。也让我懂得了程序员背负的压力之大。</p><p>几个月后我又接手了公司的大型项目CRM，一个医生用来看病的系统，并且完全编写了后期的更新迭代，这个项目的坑在于使用的IM插件需要时常更新，每次更新牵扯到之前的很多业务代码，所以测试需要很长时间。</p><p>接下来几个月公司的h5用户端也更新了，我参与了h5端的用户聊天代码的编写，和医生端终于能一起聊天了，也是很棒的！同时编写h5也是和两个很有经验的同事合作的，同事写代码用了很多trick，我也学到了很多。</p><p>在不断维护项目，迭代项目的过程中，我还有幸接到了一个新的项目。公司的BI客户端原来是用java编写的，现在希望能做成前后端分离的形式，并且使用更丰富的图表展示，方便用户研究和运营的同事进行新活动策划。这个项目中我深入学习了echarts，进行了各种代码的封装和重用。</p><p>2017年6月，由于我要去香港大学深造了，向这个团队提出了离职，这是陪伴我长大的一个团队，不管是从技术上还是与人相处上，感谢我迈上社会的第一步遇上了你们，我的同事也是我终身的朋友。</p>]]></content>
    
    
    
    <tags>
      
      <tag>工作实习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PWA -- Progress Web App</title>
    <link href="/2016/12/20/pwa/"/>
    <url>/2016/12/20/pwa/</url>
    
    <content type="html"><![CDATA[<blockquote><p>Progress Web App目的在于利用现代浏览器的能力来达到类似APP的用户体验，让浏览器打开的网址像APP一样运行在手机上（无框架限制）。但是可能会使浏览器的负荷增加导致崩溃，所以提倡使用渐进式开发。<br>参加了Google Developer Day之后，对PWA这个概念有了自己的理解，个人觉得在可期的未来PWA会有很好的发展，值得深入学习。</p></blockquote><span id="more"></span> <h5 id="PWA简介"><a href="#PWA简介" class="headerlink" title="PWA简介"></a>PWA简介</h5><p><img src="/img/pwa.jpg" alt="PWA"><br><code>特性：</code></p><blockquote><p>支持将图标添加到屏幕，从屏幕点击启动<br>支持全屏体验<br>支持离线应用（利用Service Worker来实现离线存储）<br>支持Push Notification </p></blockquote><p><code>优势</code></p><blockquote><p>跨平台，任何安装符合标准的浏览器的设备上均可运行<br>渐进式，无论用户使用什么浏览器，始终以渐近增强为原则<br>低网速离线情况下依然有较好的用户体验<br>实时持续更新<br>使用TLS来保证传输安全<br>对搜索引擎友好<br>推送通知可以让用户再次访问变的容易</p></blockquote><p>除了Chrome支持以外，Firefox和Opera也支持了PWA</p><h5 id="service-worker"><a href="#service-worker" class="headerlink" title="service worker"></a>service worker</h5><p>相当于一个用户端的代理，拦截url，优先从缓存中获取资源，若缓存中没有，则向服务端请求。<br><code>优势及作用</code><br>预缓存加载，也可以作为file cache（static）。<br><img src="/img/service-worker.jpg" alt="service-worker"></p><blockquote><p>现在Service Worker在chrome、firefox和opera中是被支持的。Safari和Edge也正在努力中。<br>devtool - application - service worker</p></blockquote><h5 id="PWA设计概念-–-peanut-M-amp-M"><a href="#PWA设计概念-–-peanut-M-amp-M" class="headerlink" title="PWA设计概念 – peanut M&amp;M"></a>PWA设计概念 – peanut M&amp;M</h5><p>Aaron把PWA比作peanut M&amp;M，这是一种称为<code>应用外壳架构</code>的设计概念，javascript是一种外壳，是需要存储在浏览器中，保证始终可用，当无互联网连接（ offline）时，也能保证用户能看到应用的基本框架，而不是一片空白或者错误提示。<br>css相当于中间的巧克力层，可以缓存，也可以从服务端获取。<br>content（即需要）相当于里面的花生，可以缓存，也可以直接从服务端获取。但是一般来说内容是动态的，可能频繁发生改变，所以大部分都是从服务端获取（项目设计中应该尽量减少把不必要的内容都存储下来）。</p><h5 id="Manifest-json"><a href="#Manifest-json" class="headerlink" title="Manifest.json"></a>Manifest.json</h5><p>PWA主要一个 <code>Manifest.json</code>来配置一些功能，可以设置浏览器的样式，添加到屏幕的图标等等。</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PWA DEMO FM.202&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;short_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;FM.202&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Simple Progressive Web App for ginny&#x27;s friends.&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;icons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;src&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;assets/icons/ic-face.png&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/png&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;sizes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;72x72&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;src&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;assets/icons/ic-face-large.png&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;image/png&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;sizes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;144x144 256x256&quot;</span> <br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;start_url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;index.html&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;display&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;standalone&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;background_color&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#fff&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;theme_color&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#fff&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;orientation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;portrait&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p>可以通过Chrome的“添加到主屏幕”按钮，保存到主屏幕上。<br>只有满足如下条件时窗口才会显示。</p><blockquote><p>1、有一个有效的 Web Manifest。<br>2、安装有有效的 Service Worker。<br>3、通过 HTTPS 访问应用程序。</p></blockquote><h5 id="测试工具Lighthome"><a href="#测试工具Lighthome" class="headerlink" title="测试工具Lighthome"></a>测试工具Lighthome</h5><p>对PWA的评分工具，包括检测在各种网络状态下应用的加载情况。仅测试静态网页，对用户交互等动态行为并不作评分。可以在chrome插件中找到。<br>swPrecache进行预抓取，有service worker一整套体系。</p><p><code>参考链接</code><br><a href="https://www.w3.org/TR/service-workers/">Service Worker W3C官方草案</a><br><a href="https://www.chromestatus.com/features">chrome-feature</a><br><a href="https://developers.google.com/web/updates/2015/12/getting-started-pwa">Getting Started with Progressive Web Apps</a><br><a href="https://pwa.rocks/">有趣的PWA游戏和工具</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>关于requestAnimationFrame</title>
    <link href="/2016/12/04/%E5%85%B3%E4%BA%8ErequestAnimationFrame/"/>
    <url>/2016/12/04/%E5%85%B3%E4%BA%8ErequestAnimationFrame/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这两个礼拜做图文h5的时候看到同组大神一个关于渲染的神奇写法，用了requestAnimationFrame这个之前我从来没有使用过的属性。<br>看了hax的知乎live，其中也提到了浏览器的渲染问题，特意查了paper做个总结。</p></blockquote><span id="more"></span> <h5 id="一个简单的需求"><a href="#一个简单的需求" class="headerlink" title="一个简单的需求"></a>一个简单的需求</h5><p><code>setBtnStatus</code>这个函数用来设置按钮状态，这个按钮主要做submit作用，也包含对表单提交的检验，当用户输入没有经过校验时，按钮置灰，用户输入满足时，按钮可以点击（即用户点击之后可以提交表单）。<br>macsen110大神指导我写的一段代码。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-attr">setBtnStatus</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> that = <span class="hljs-variable language_">this</span>;<br>    <span class="hljs-keyword">var</span> addressSave = $(<span class="hljs-string">&#x27;#addressSave&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (that.<span class="hljs-title function_">isReady</span>()) &#123;<br>        addressSave.<span class="hljs-title function_">removeAttr</span>(<span class="hljs-string">&#x27;disabled&#x27;</span>)<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        addressSave.<span class="hljs-title function_">attr</span>(<span class="hljs-string">&#x27;disabled&#x27;</span>,<span class="hljs-literal">true</span>)<br>    &#125;<br>    that.<span class="hljs-property">reqId</span>=<span class="hljs-title function_">requestAnimationFrame</span>(that.<span class="hljs-property">setBtnStatus</span>.<span class="hljs-title function_">bind</span>(that));<br>&#125;,<br><br><span class="hljs-keyword">var</span> requestAnimationFrame = <span class="hljs-variable language_">window</span>.<span class="hljs-property">requestAnimationFrame</span> || <br>        <span class="hljs-variable language_">window</span>.<span class="hljs-property">mozRequestAnimationFrame</span> || <br>        <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkitRequestAnimationFrame</span> || <br>        <span class="hljs-variable language_">window</span>.<span class="hljs-property">msRequestAnimationFrame</span> || <br>        <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<span class="hljs-keyword">var</span> id = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(callback, <span class="hljs-number">1000</span> / <span class="hljs-number">60</span>);<span class="hljs-keyword">return</span> id;&#125;;<span class="hljs-comment">//IE9- 兼容</span><br><br><span class="hljs-keyword">var</span> cancelAnimationFrame = <span class="hljs-variable language_">window</span>.<span class="hljs-property">cancelAnimationFrame</span> || <br>        <span class="hljs-variable language_">window</span>.<span class="hljs-property">mozCancelAnimationFrame</span> || <br>        <span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>)&#123;<span class="hljs-built_in">clearTimeout</span>(id);&#125;;<br></code></pre></div></td></tr></table></figure><p>调用<code>requestAnimationFrame</code>API可以让开发者写出更流畅的动画，以时间戳为单位（帧间隔），代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> handle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">requestAnimationFrame</span>(callback); <br></code></pre></div></td></tr></table></figure><p>调用<code>requestAnimationFrame</code>这个函数需要一个回调函数作为参数，当下一个画面（frame）到来之前执行。这样实现在帧间隔给按钮平滑变色。</p><h5 id="浏览器的反馈—用户已访问"><a href="#浏览器的反馈—用户已访问" class="headerlink" title="浏览器的反馈—用户已访问"></a>浏览器的反馈—用户已访问</h5><p>浏览器有一个数据库专门用来存储用户已经访问过的URLs，有些浏览器可以决定如何展现用户已经点击过的链接，比如加深颜色等等，这些都是浏览器的默认行为。<br>IE和firefox的数据库操作行为是异步的，当操作结果还没返回时，表现为unvisited，返回时将触发页面的重绘操作，给这个链接添加访问过的标记。Chrome的数据库操作是同步的，只有全部操作完成才会渲染整个页面。<br>当链接中的地址被js改变时，IE中不会发生visited-&gt;unvisited的改变，这个改变会在firefox中发生。而在Chrome中只有改变链接并手动点击才会触发渲染，所以需要用js控制强制重绘。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://www.guoningyan.com&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;link&quot;</span>&gt;</span>过宁妍<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">var</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;link&#x27;</span>); </span><br><span class="language-javascript">el.<span class="hljs-property">href</span> = <span class="hljs-string">&#x27;http://www.google.com&#x27;</span>; </span><br><span class="language-javascript">el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">&#x27;red&#x27;</span>;</span><br><span class="language-javascript">el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">&#x27;&#x27;</span>; </span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> <br></code></pre></div></td></tr></table></figure><h5 id="浏览器的重绘（redraw）事件是可以被嗅探的"><a href="#浏览器的重绘（redraw）事件是可以被嗅探的" class="headerlink" title="浏览器的重绘（redraw）事件是可以被嗅探的"></a>浏览器的重绘（redraw）事件是可以被嗅探的</h5><p>众所周知，帧渲染时间最佳为每秒60次（60fps，渲染一帧的时间为1000ms&#x2F;60&#x3D;16.7ms，这样人眼不会察觉到卡顿），<code>requestAnimationFrame</code>时间间隔为帧间隔，渲染时间可能会比16.7ms更短，而<code>阴影shadow</code>和<code>透明度transparency</code>或者是大量复杂的样式改变会影响浏览器的渲染时间（painting step），导致渲染时间变长，这段时间可能经历了很多帧，所以通过<code>requestAnimationFrame</code>可以计算出画面切换之间的时间。<br>恶意的网站可以通过浏览器对网页的渲染时间差窃取用户的敏感数据，即用户访问的历史记录。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> lastTime = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">loop</span>(<span class="hljs-params">time</span>) &#123;<br>  <span class="hljs-keyword">var</span> delay = time – lastTime;<br>  <span class="hljs-keyword">var</span> fps = <span class="hljs-number">1000</span>/delay;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(delay + <span class="hljs-string">&#x27;ms&#x27;</span> fps);<br>  <span class="hljs-title function_">updateAnimation</span>();<br>  <span class="hljs-title function_">requestAnimationFrame</span>(loop);<br>  lastTime = time;<br>&#125;<br><span class="hljs-title function_">requestAnimationFrame</span>(loop);<br></code></pre></div></td></tr></table></figure><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p><code>requestAnimationFrame</code>可以进行帧变化操作，可以使动画更流畅。阴影颜色等重绘耗时长的操作在对用户已访问的标记上是应该禁止使用的，浏览器的不同操作会导致用户浏览信息泄露。</p><p><code>参考资料</code><br><a href="https://www.contextis.com/documents/2/Browser_Timing_Attacks.pdf">Browser_Timing_Attacks.pdf</a><br><a href="http://www.zhangxinxu.com/wordpress/2013/09/css3-animation-requestanimationframe-tween-%E5%8A%A8%E7%94%BB%E7%AE%97%E6%B3%95/">张鑫旭的博客</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>调试技巧之暴露全局方法</title>
    <link href="/2016/10/19/%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E4%B9%8B%E6%9A%B4%E9%9C%B2%E5%85%A8%E5%B1%80%E6%96%B9%E6%B3%95/"/>
    <url>/2016/10/19/%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E4%B9%8B%E6%9A%B4%E9%9C%B2%E5%85%A8%E5%B1%80%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>最近的项目中使用了setInterval轮询，由于浏览器执行轮询时会阻塞其他，造成了一些麻烦。<br>本文记录一下测试时候在代码中放置的两个全局方法，用于在浏览器console中进行调用，开启和关闭轮询。</p></blockquote><span id="more"></span><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> myIntervel = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-comment">//doing sth;</span><br>&#125;,spollingTime);<br><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">cancleIntervel</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;    <br>    <span class="hljs-built_in">clearInterval</span>(myIntervel);<br>&#125;<br><span class="hljs-variable language_">window</span>.<span class="hljs-property">refreshWindow</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>(<span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>浏览器console中输入<code>window.cancleIntervel()</code>则轮询暂停；<br>浏览器console中输入<code>window.refreshWindow()</code>则重新刷新页面，就和手动刷新一个效果；</p><p><code>注意</code><br>暴露给window的方法必须是原生js自带的方法，项目用了angularjs框架，一开始我直接使用了框架中的暂停语法糖，自然是控制台报错了，这点要注意哦～</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>debug</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>canvas实践笔记</title>
    <link href="/2016/08/21/canvas%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/"/>
    <url>/2016/08/21/canvas%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>对canvas使用有过好几次了，曾经用基于canvas的createjs写过一个俄罗斯方块的游戏，毕业设计做的是多人在线绘图网站，自然也是canvas实现的。<br>最近工作需要，需要在h5端调用canvas API实现生成一张带有数据图的图片，“传送给native端”，所以对canvas的使用做一个总结。[2016-08-27更正：生成图片需要走http传输协议，app内与native通信走file传输协议，协议不同，不能直接通信，所以不能完成直接传送给native，只能传送给server端。]<br>由简到难，本文首先简单介绍canvas几个常用API，然后给出图片预加载的代码，最后会列举绘制过程中的多个坑。</p></blockquote><span id="more"></span><p>SVG绘制图形是通过构建一棵XML树来实现，canvas来绘制图形是通过调用它提供的方法。所以在canvas中移除相应的元素需要先将当前的相应元素擦除，然后重新绘制。</p><p>业务实现效果图，制作过程3.5天，踩了不少坑，下面进行详细讲解。<br><img src="/img/canvas-jk.png" alt="jk-img"></p><h5 id="图形绘制一些简单的API"><a href="#图形绘制一些简单的API" class="headerlink" title="图形绘制一些简单的API"></a>图形绘制一些简单的API</h5><p>canvas标签在html文档流中存放，标签内的区域都是画布，所以可以在标签上直接设置画布的长宽。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mycanvas&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">100</span> <span class="hljs-attr">height</span>=<span class="hljs-string">100</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>前面已经说过，canvas需要调用API来绘制图形，大部分API需要调用一个上下文对象来实现，所以需要<code>getContext(&#39;2d&#39;)</code>方法（传参2d）来获取这个CanvasRenderingContext2D对象，使用这个对象来实现在画布上绘制二维图形。<br><code>注意</code>每个canvas元素只有一个上下文对象</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;mycanvas&#x27;</span>);<br><span class="hljs-keyword">var</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>);<br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 绘制路径；</span><br><span class="hljs-comment"> * beginPath开始，closePath结束，绘制比较粗糙；</span><br><span class="hljs-comment"> * 手动lineTo结束位置到起点位置，绘制比较精细；</span><br><span class="hljs-comment"> * 完成一条路径后重新开始另一条路径，必须有beginPath</span><br><span class="hljs-comment"> */</span><br>context.<span class="hljs-title function_">beginPath</span>();<br>context.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);<br>context.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">200</span>,<span class="hljs-number">200</span>);<br>context.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">200</span>);<br>context.<span class="hljs-title function_">closePath</span>();<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  画圆－（0,360）的弧线</span><br><span class="hljs-comment"> *  context.arc(left, right, radius, 0, Math.PI*2);</span><br><span class="hljs-comment"> */</span><br>context.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">&#x27;#999&#x27;</span>;<br>context.<span class="hljs-title function_">beginPath</span>();<br>context.<span class="hljs-title function_">arc</span>(<span class="hljs-number">30</span>, <span class="hljs-number">60</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>*<span class="hljs-number">2</span>);<br>context.<span class="hljs-title function_">closePath</span>();<br>context.<span class="hljs-title function_">stroke</span>();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  画矩形</span><br><span class="hljs-comment"> *  rect(x, y, width, height)</span><br><span class="hljs-comment"> */</span><br>context.<span class="hljs-title function_">rect</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br>context.<span class="hljs-title function_">fill</span>();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 填充路径区域；</span><br><span class="hljs-comment">* 如果路径没有闭合，则默认起点与终点连接；</span><br><span class="hljs-comment">* 可以通过先设置类属性来控制外观；</span><br><span class="hljs-comment">*/</span><br>context.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&#x27;#ccc&#x27;</span>;<br>context.<span class="hljs-title function_">fill</span>();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 描边；</span><br><span class="hljs-comment"> * 可以通过先设置类属性来控制外观；</span><br><span class="hljs-comment"> */</span><br>context.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">&#x27;#008&#x27;</span>;<br>context.<span class="hljs-title function_">stroke</span>();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 设置字体和大小</span><br><span class="hljs-comment"> */</span><br> context.<span class="hljs-property">font</span> = <span class="hljs-string">&quot;40pt Calibri&quot;</span>;<br> context.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">&quot;Hello World!&quot;</span>, x, y);<br></code></pre></div></td></tr></table></figure><p><a href="http://jsbin.com/xapiqe/3/edit?html,css,js,output">在线demo</a></p><blockquote><p>实践过程中发现context.fill()有个坑，特别是在给矩形填充颜色的时候，context的指向会出现问题，可能会将之前已经填充的内容重新填充。<br>简易使用context.fillRect()这个属性来填充矩形。<br>如果不可避免需要使用context.fill()这个属性，尽量提前使用，不要影响到后面的内容。</p></blockquote><h5 id="插入图片"><a href="#插入图片" class="headerlink" title="插入图片"></a>插入图片</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">DrawPic</span>(<span class="hljs-params">imgParam,left,top</span>)&#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">left</span> = left || <span class="hljs-number">0</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">top</span> = top || <span class="hljs-number">0</span>;<br>  context.<span class="hljs-title function_">drawImage</span>(imgParam,<span class="hljs-variable language_">this</span>.<span class="hljs-property">left</span>,<span class="hljs-variable language_">this</span>.<span class="hljs-property">top</span>);<br>&#125;<br></code></pre></div></td></tr></table></figure><p>[业务需求]：将切图展示在画布的指定位置，设置图片大小<br>canvas绘图阻塞浏览器，按顺序执行，画图之前需要图片全部加载成功，作者编写了图片预加载功能，在完全加载完成后进行绘制。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">batchProcessingImgs</span>(<span class="hljs-params">imgList,newImgList</span>)&#123;<br>  imgList.<span class="hljs-title function_">reduce</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">pre,cur</span>)&#123;<br>    <span class="hljs-keyword">var</span> img = <span class="hljs-title function_">createNewImg</span>(cur)<br>    img.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>    newImgList.<span class="hljs-title function_">push</span>(img);<br>  &#125;<br>&#125;,&#123;&#125;)<br><span class="hljs-keyword">return</span> newImgList;<br>&#125;<br><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-keyword">if</span>(imgList.<span class="hljs-property">length</span> == newImgList.<span class="hljs-property">length</span>)&#123;<br>    <span class="hljs-comment">//do something</span><br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>imgList存储图片源文件，newImgList存储加载完成的图片，只有当两个list长度相等时，图片完全加载完成，可以进行画布绘制，另外加载图片的过程是浏览器的异步行为，newImgList中的图片顺序和imgList不一定相同，所以需要根据名字查询图片信息。（在附录的链接中作者给出了完整的实现）</p><h5 id="缩小图片并剪裁成圆形"><a href="#缩小图片并剪裁成圆形" class="headerlink" title="缩小图片并剪裁成圆形"></a>缩小图片并剪裁成圆形</h5><p>[业务需求]：展示用户的圆形小头像，后端返回的是一定尺寸的大头像，所以我需要先等比例缩放，然后进行圆形裁剪。<br>需要注意的是，arc+clip的方法只对绘制的图形产生效果，对图片不起作用。<br>所以只能用填充的方法，设置一个填充pattern(ctx.createPattern(image, repetition))，但是填充的效果是图片的原像素尺寸，如果原图是一张超大图，很有可能填充的只是黑色的一个小角，所以在填充之前需要对原图进行等比例缩小。<br>有个CanvasPattern.setTransform(matrix)的方法，matrix是SVG的缩放方式，OMG！难道写canvas还要和SVG合用吗？好吧，尝试之后遇到了更难过的结果，连亲爱的chrome都不支持！那就别说其他浏览器了。<br>换种思路，能不能用别的方式缩小图片呢？还是老大厉害，鼓励我尝试了先将图片绘制在另一个canvas上下文中，然后将新的canvas调整到我所需要的尺寸，然后将新的canvas作为填充pattern填充到老canvas的fill中，尝试结果，完美实现填充！</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 按比例缩小图像并裁剪</span><br><span class="hljs-comment"> * left，top:左上角</span><br><span class="hljs-comment"> * radius:裁剪后的圆半径，注意是半径</span><br><span class="hljs-comment"> * 比较宽和高，小的设置为圆的直径长，大的裁剪为scaleBorder</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">scaleAndClipImageToRound</span>(<span class="hljs-params">context,img,left,top,radius</span>)&#123;<br>  <span class="hljs-keyword">var</span> scaleBord,<br>  width = img.<span class="hljs-property">width</span>,<br>  height = img.<span class="hljs-property">height</span>;<br>  context.<span class="hljs-title function_">save</span>();<br>  <span class="hljs-keyword">var</span> newCanvans = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;canvas&#x27;</span>);<br>  newCanvans.<span class="hljs-property">width</span> = img.<span class="hljs-property">width</span>;<br>  newCanvans.<span class="hljs-property">height</span> = img.<span class="hljs-property">height</span>;<br>  <span class="hljs-keyword">var</span> newCtx = newCanvans.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>);<br><br>  scaleBord = (width &gt;= height ? <span class="hljs-number">2</span>*radius/height : <span class="hljs-number">2</span>*radius/width);<br>  newCtx.<span class="hljs-title function_">scale</span>(scaleBord,scaleBord);<br>  newCtx.<span class="hljs-title function_">drawImage</span>(img,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">var</span> p = ctx.<span class="hljs-title function_">createPattern</span>(newCanvans,<span class="hljs-string">&quot;no-repeat&quot;</span>);<br>  context.<span class="hljs-property">fillStyle</span> = p;<br>  context.<span class="hljs-title function_">translate</span>(left, top);<br>  context.<span class="hljs-title function_">beginPath</span>();<br>  context.<span class="hljs-title function_">arc</span>(radius, radius, radius, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>*<span class="hljs-number">2</span>);<br>  context.<span class="hljs-title function_">fill</span>();<br>  context.<span class="hljs-title function_">closePath</span>();<br>  context.<span class="hljs-title function_">restore</span>();<br>&#125;<br></code></pre></div></td></tr></table></figure><h5 id="状态堆栈"><a href="#状态堆栈" class="headerlink" title="状态堆栈"></a>状态堆栈</h5><p>画布API允许保存当前画布的状态，采用的是堆栈的方式，采用save和restore方法，相当于push和pop，恢复堆栈中的状态。也可以理解为PS的一个图层，作者实践过程中在使用context.scale()这个属性的时候一定需要调用pop和restore。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">context.<span class="hljs-title function_">save</span>();<br>context.<span class="hljs-title function_">restore</span>();<br></code></pre></div></td></tr></table></figure><h5 id="toDataURL时间上的坑"><a href="#toDataURL时间上的坑" class="headerlink" title="toDataURL时间上的坑"></a>toDataURL时间上的坑</h5><p>业务需求需要先向后端请求数据，然后进行绘制，我在做这个需求的时候遇到两个坑。<br>第一个坑：toDataURL后发现ajax请求的数据还没有返回，所以canvas没有画完。因为ajax请求是异步的，无法判断精确data的返回时间，所以只能在请求成功的回调中进行绘制方法的调用。（附录代码段中作者封装了多个请求执行完毕后处理绘图）<br>第二个坑：需要在图片预加载结束后画图，然后toDataURL，本地运行时图片加载时间可以忽略不计，而生产环境时加载图片是需要一定时间的，所以判断加载完成的js语句根本没有执行。解决方法是每加载一次图片时进行图片加载判断，即有100张图片就需要执行100次判断，直到第100次判断图片加载完全执行完毕，调用绘图方法进行绘制。</p><p><code>附录</code><br><a href="https://github.com/ginny315/canvas-h5tonative/tree/master/canvas-drawProgressBar-function">我的纯函数式实现canvas绘制设计稿代码</a><br><a href="https://github.com/ginny315/canvas-h5tonative/tree/master/canvas-draw-objForm">我的对象方法整理版（包括处理多个请求）代码</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>canvas</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>angular笔记（3）我所理解的MV*</title>
    <link href="/2016/08/01/angular%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89%E6%88%91%E6%89%80%E7%90%86%E8%A7%A3%E7%9A%84MV/"/>
    <url>/2016/08/01/angular%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89%E6%88%91%E6%89%80%E7%90%86%E8%A7%A3%E7%9A%84MV/</url>
    
    <content type="html"><![CDATA[<blockquote><p>大学里写java web，用过struct2和Hibernate框架，接触了后端MVC；<br>大四实习的时候自学了nodejs的express框架，并且在此基础上做了我的毕业设计，这也是一个基于MVC的后端框架；<br>近期工作的这段时间，也在做基于angular的后台的开发和维护。angualr是基于MVVM的前端框架，MVVM是MVC的衍生，把C用VM来替代，但是MVC的原理依旧是可以解释地通的（作者研究过前端设计模式，也有自己的观点，有疑惑请在评论里讨论）。</p></blockquote><span id="more"></span><p><code>java开篇</code><br>这里的java的设计模式和目前在做java开发的<a href="http://blog.csdn.net/yiluxiangqian7715">@组长ZJP同学</a>讨论过，用一张图简单地描述下。</p><p><img src="/img/angular3-mvc.png" alt="java中的MVC"></p><p>相信了解过MVC的朋友都知道，Model代表数据存储，用来处理数据库相关操作，一般会使用<a href="http://baike.baidu.com/link?url=jdLF0XztJUiIqHYzJONBdJYeHO7ZS_dWsRuTP1hVdvZWz_wAZsgHUaWtMWLeHeDgwV_j5VmbYLYvq0BCy2NCnK">ORM</a>进行封装，降低藕合度。<br>View代表视图层，在后端渲染的情况下一般是jsp页面，而在前端渲染的情况下，可能是web端或者是客户端的某些页面，用户操作致使View发送request请求。<br>Control代表控制器，顾名思义，整个流程依赖Control进行控制，所以View中的请求会经过Control处理，然后返回response给View，而view处理的业务逻辑对客户端是不透明的，用户也不用去理会数据库是怎样的操作，所以这些“黑盒”操作都是由后端程序员完成。Control返回的response也有两种方式，像structs2采用的是action跳转，这是一种可以直接返回jsp页面的方式，还有一种是我们熟悉的后端返回json数据的方式。<br>图中关于Model，引申出了service，在一些不算复杂的框架中，可能就模糊了Model的概念，直接由service处理业务逻辑，框架的选型还是结合业务相关，这里不再赘述。</p><p><code>Nodejs express框架深入</code><br>这里选用了我毕设用的目录结构做说明。</p><figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">- db<br>  - admin.js<br>  - user.js<br>- routers<br>  - loginServer.js（require(<span class="hljs-string">&#x27;../db/user.js&#x27;</span>)）<br>  - adminServer.js（require(<span class="hljs-string">&#x27;../db/admin.js&#x27;</span>)）<br>- app.js<br></code></pre></div></td></tr></table></figure><p>我选用了mongoose包作为中间层，所以很明显可以看出db文件夹下就是ORM，每个单独的js文件代表数据库中的一张表，将数据类型相关以及CRUD操作进行封装，和Model类似，每个单独的js文件类似一个service实现类。<br>而router是一种路由的概念，每个**Server.js文件代表一个操作，需要调用db中的方法（类似于control调用service完成某个功能）。再划分细一点，router可以把不同请求对应到不同的方法中进行处理，此时router相当于一个过滤器和领路的作用，扩大了control的功能。而这些js文件会返回处理后的response。<br>app.js是项目启动文件，数据库连接，调用router方法等等，前端所有的请求request都需要经过app.js后，调用模块中的方法进行处理。</p><p><code>终于回到了重点angular</code><br>首先也先进行项目目录结构划分</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">－ js<br>  - app.js(root作用，调用service中的数据)<br>  - common.js(factory、service、provider)<br>  - main.js<br>  - router.js(可以直接写路由，也可以通过ui-router这种插件根据状态来改变页面渲染)<br>－ moudules<br>  - moduleName<br>    - ***.html<br>    - ***.js(controller)<br></code></pre></div></td></tr></table></figure><p>这里将页面划分为组件，每个contrller控制一个视图模型。<br>app.js起到root作用，包含了所有的controller。即这是一个总控制器。<br>common.js起Modul作用，在angular中有factory、service、contrller三个分类，service通过“构造器”（构造函数）创建，这个构造器即factory，而这些service又可以称为factory的实例化对象（实现类），以对象的形式存在。provider是一种更高级（可以通过config进行配置）的factory，作用也类似。<br>解释了这么多，再说一下angular的范式要求。在写angular的时候，尽量要将业务逻辑处理放在controller中，尽量不要在controller直接获取数据后处理，应该让service获取接口数据，此时的service相当于Model，这样angular的设计模式就完全和java对应了。</p><p><code>总结</code><br>都说angular适合后端程序员，确实总结时候发现了其中的相似之处非常多，当然，学好设计模式，框架什么的都是套路！</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>angular</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>移动端开发总结（1）</title>
    <link href="/2016/07/31/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93%EF%BC%881%EF%BC%89/"/>
    <url>/2016/07/31/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>移动端布局一直是困扰我的一个大问题，特别是去年在某电商实习期间曾经做一个活动页做了好久好久好久，现在工作期间遇到活动页或者微信传播页也是必须要按时快速高质量任务的。<br>近期在做一个hybird项目的UAT，代码里出现了前辈们的各种不同的css写法，我必须要全部看懂然后再做修改，也是很蛋疼，所以周末在图书馆对遇到的坑做个总结吧。</p></blockquote><span id="more"></span><h5 id="常用单位"><a href="#常用单位" class="headerlink" title="常用单位"></a>常用单位</h5><p><code>rem</code></p><blockquote><p>[MDN]This unit represents the font-size of the root element.<br>这个单位代表了根元素的字体大小。<br>如果在document里面有html元素，即为根元素，通过在html上设置font-size，则可以使用rem来表示字体大小或者用来定义元素的高度、宽度等等。</p></blockquote><p>下面是一段我写的简易媒体查询的代码，即通过css来实现自适应，font-size的取值最好为偶数，避免发生字体渲染问题。这里选用<code>10px</code>作为基础值是因为设计师以iphone6作为设计图标准，设计稿上宽度<code>750px</code>，iphone6实际宽度<code>375px</code>，这样手动rem换算只要<code>设计稿px/10/2</code>，很容易进行布局计算，其余的自适应完全交给浏览器去实现。</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>:<span class="hljs-number">361px</span>) &#123;<br>  <span class="hljs-selector-tag">html</span> &#123;<br>    <span class="hljs-attribute">font-size</span>:<span class="hljs-number">10px</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>:<span class="hljs-number">400px</span>) &#123;<br>  <span class="hljs-selector-tag">html</span> &#123;<br>    <span class="hljs-attribute">font-size</span>:<span class="hljs-number">12px</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>:<span class="hljs-number">500px</span>) &#123;<br>  <span class="hljs-selector-tag">html</span> &#123;<br>    <span class="hljs-attribute">font-size</span>:<span class="hljs-number">14px</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">-webkit-min-device-pixel-ratio</span>:X)&#123;<br>    <br>&#125;<br></code></pre></div></td></tr></table></figure><p>上面的写法比较适合普遍性的适应，不能保证所有机器得到最精准的适配，而且当遇到对像素要求很高的设计师抠细节的时候，总不能给每个手机都做<code>media quary</code>吧，于是下面给出一段js实现的，通过获取屏幕实际可用区域控制<code>root</code>元素<code>font-size</code>大小的代码。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><span class="hljs-keyword">var</span> width = <span class="hljs-variable language_">window</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">width</span>;<br>  <span class="hljs-keyword">var</span> rate = width/<span class="hljs-number">375</span>;<br>  <span class="hljs-keyword">var</span> newFontSize = <span class="hljs-string">&#x27;font-size:&#x27;</span> + rate*<span class="hljs-number">10</span> + <span class="hljs-string">&#x27;px&#x27;</span>;<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&#x27;html&#x27;</span>).<span class="hljs-property">style</span> = newFontSize;<br>&#125;());<br><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;text&#x27;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&#x27;html&#x27;</span>).<span class="hljs-property">style</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>你也可以<a href="http://guoningyan.com/demo/testrem.html">点击这里</a>，查看我的在线demo。</p><p><code>em</code></p><blockquote><p>[MDN]This unit represents the calculated font-size of the element. If used on the font-size property itself, it represents the inherited font-size of the element.<br>从元素进行font-size属性的继承，即获取父元素的字体大小进行设置。<br>通过在父元素上设置font-size，则可以使用em来表示字体大小或者用来定义子元素的高度、宽度等等。</p></blockquote><p><code>vw、vh</code></p><blockquote><p>[MDN]vw:1&#x2F;100th of the height of the viewport.<br>[MDN]vh:1&#x2F;100th of the width of the viewport.<br>[MDN]vmin:1&#x2F;100th of the minimum value between the height and the width of the viewport.<br>[MDN]vmax:1&#x2F;100th of the maximum value between the height and the width of the viewport.<br>vw、vh相对于屏幕的百分比，1vw是屏幕宽度的1%，1vh是屏幕高度的1%，由于屏幕是固定的，所以设置的百分比也是固定的。<br>要注意的是，如果带有弹出式键盘，则vh会自动改变，所以在需要调用设备原生键盘的时候，尽量不要使用vh</p></blockquote><h5 id="改变viewport"><a href="#改变viewport" class="headerlink" title="改变viewport"></a>改变viewport</h5><p>和用js改变html的font-size类似，也可以通过js来改变meta标签。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> width = <span class="hljs-variable language_">window</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">width</span>/<span class="hljs-number">320</span>;<br><span class="hljs-keyword">var</span> rate = width/<span class="hljs-number">375</span>,<br>    viewport = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;meta[name=viewport]&#x27;</span>);<br><br>viewport.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;content&#x27;</span>,<br>viewport.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;content&#x27;</span>)<br>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(initial-scale)=[d.]?d/</span>,<span class="hljs-string">&#x27;$1=&#x27;</span>+rate))<br></code></pre></div></td></tr></table></figure><p><code>附录一</code>js常用获取屏幕信息</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">网页可见区域宽：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientWidth</span><br>网页可见区域高：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientHeight</span><br>网页可见区域高：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">offsetWidth</span>（包括边线的宽）<br>网页可见区域宽：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">offsetHeight</span>（包括边线的高）<br>网页正文全文宽：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">scrollWidth</span><br>网页正文全文高：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">srcollHeight</span><br>网页被卷去的高：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">scrollTop</span><br>网页被卷去的左：<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">scrollLeft</span><br>网页正文部分上：<span class="hljs-variable language_">window</span>.<span class="hljs-property">screenTop</span><br>网页正文部分左：<span class="hljs-variable language_">window</span>.<span class="hljs-property">screenLeft</span><br>屏幕分辨率的高：<span class="hljs-variable language_">window</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">height</span><br>屏幕分辨率的宽：<span class="hljs-variable language_">window</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">width</span><br>屏幕可用工作区高度：<span class="hljs-variable language_">window</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">availHeight</span><br>屏幕可用工作区宽度：<span class="hljs-variable language_">window</span>.<span class="hljs-property">srceen</span>.<span class="hljs-property">availWidth</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>开发了一个chrome外卖插件（1）</title>
    <link href="/2016/07/27/%E5%BC%80%E5%8F%91%E4%BA%86%E4%B8%80%E4%B8%AAchrome%E5%A4%96%E5%8D%96%E6%8F%92%E4%BB%B6%EF%BC%881%EF%BC%89/"/>
    <url>/2016/07/27/%E5%BC%80%E5%8F%91%E4%BA%86%E4%B8%80%E4%B8%AAchrome%E5%A4%96%E5%8D%96%E6%8F%92%E4%BB%B6%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>今天真是无聊啊，弄点神奇的东西玩玩儿，想了想，还没做过chrome插件呢，Google了一下，chrome插件基本就是使用html,css,js来实现一些浏览器的扩展功能，前端完全能胜任呐！<br>团队平时（特别是周五）经常会一起点奶茶水果之类，那就把这些做个整理，顺便了解一下如何做插件，一举两得！</p></blockquote><span id="more"></span><p><img src="/img/chrome1-1.png" alt="这里是配图"><br><code>这是插件root文件夹</code><br>需要包含manifest.json、icon.png(大小一般为19px * 19px)、index.html（设置的弹出页面）<br><code>manifest.json</code><br>manifest在英语里是清单的意思，顾名思义，这个文件是整个插件的描述文件，开发插件就得说明这个插件叫什么，可以用来干什么，以及自己设计的功能etc…<br><code>brower_action</code>是当鼠标悬浮或点击图标是的下拉列表，<code>page_action</code>是点击图标之后的弹出的页面，官方文档表示两者只能选其中一个或者都不选。</p><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;manifest_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;takewayfood&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0.1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;takeway food for my friends&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;page_action&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;default_icon&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;eat.png&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;default_popup&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;index.html&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;default_title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Yummy!&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;manifest_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;takewayfood&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0.1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;takeway food for my friends&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;browser_action&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;default_icon&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;eat.png&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;default_title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Yummy!&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><p><code>安装</code><br>点击chrome浏览器右上角的“三”图标，进入设置，点击“扩展程序”，勾选“开发者模式”，点击“打包扩展程序”，选择插件所在目录，第一次上传时不需要选择“私有密钥文件”。<br>然后打开目录，发现多了两个文件，后缀名分别为crx和pem，pem即上面说到的“私有密钥文件”，当插件做了修改需要再次上传时，就需要选择这个pem文件作为“私有密钥文件”了。将crx文件拖入chrome浏览器中，即可完成插件安装。</p><p><code>顺便当个开发者吧</code><br>昨晚写的代码，居然今天就被chrome禁用了，所以决定申请一个chrome开发者账号。成为开发者需要一次性支付5美元，而在地区选择中是没有中国这个选项的（很墙大），所以我选择了香港这个选项，支付也需要符合地区的账户，查找之后发现可以在全球付（附录中有链接）开一个账户，但是需要支付100RMB，支付后剩余的钱可以提取到银行卡账户，还是很方便的。</p><p> <code>附录</code><br> <a href="https://developer.chrome.com/extensions/getstarted">chrome插件官方文档</a><br> <a href="https://www.globalcash.hk/">全球付</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>chrome</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>angular笔记（2）</title>
    <link href="/2016/07/25/angular%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89/"/>
    <url>/2016/07/25/angular%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇是对angular笔记（2）的补充篇，由于项目需要，增加了一些新功能，这篇主要有对表格排序的业务解决，同时也对如何在数据双向绑定的框架中添加插件有了一定实践。</p></blockquote><span id="more"></span><p><code>表格排序</code><br>用表格展示数据的时候经常会遇到一个需求就是“按照升降序排列”。<br><img src="/img/angular2-1.png" alt="效果图"></p><p>ng-table本身带有sortable属性，在new NgTableParams实例化过程中添加参数sorting，sorting中包含表格中需要排序的列名可以在前端实现排序功能使用。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">sortable</span>=<span class="hljs-string">&quot;sortableId&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">$scope.<span class="hljs-property">tableParams</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NgTableParams</span>(&#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-variable constant_">PAGESIZE</span>,<br>  <span class="hljs-attr">sorting</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;sortableId&#x27;</span>, &#125;<br>&#125;, &#123;<br>     <span class="hljs-attr">getData</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>) &#123;<br>     <span class="hljs-comment">//doSth...</span><br>&#125;);<br></code></pre></div></td></tr></table></figure><p>但是很多时候这个已经封装好的排序功能不能满足自己的需求，比如已经数据已经实现了分页展示，每次请求都是带上当前页码的，所以不方便进行前端分页。此时需要后端完成排序，前端请求需要携带当前页码和排序参数，后端直接返回排序完成的数据给前端展示。</p><p>此时就需要自定义sort事件，在结合ng-table时也遇上了一些坑，下面通过代码来解释一下。<br>首先想到的是添加ng-click事件：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">sortable</span>=<span class="hljs-string">&quot;sortableId&quot;</span> <span class="hljs-attr">ng-click</span>=<span class="hljs-string">&quot;sort(&#x27;sortParam&#x27;)&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>这样做有一个误区，ng-table插件自定义的click事件会覆盖自定义事件，完全起不到作用。</p><p>修改为下面这样：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">data-title</span>=<span class="hljs-string">&quot;colNmae&quot;</span> <span class="hljs-attr">bo-bind</span>=<span class="hljs-string">&quot;item.userIntegral&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sortable&quot;</span> <span class="hljs-attr">ng-click</span>=<span class="hljs-string">&quot;sort(&#x27;sortParam&#x27;)&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>此时放弃了使用插件自带的sortable，使用自定义的class&#x3D;’sortable’来显示出排序的上下箭头，结果是还是没有起作用。分析以后发现，此时的<td>标签实例化为表格的每一列，需求是在列名中添加点击事件实现排列，而普通的ng-click无法绑定进去。<br>chrome中DOM渲染出来的效果可以看到如下：<br><img src="/img/angular2-2.png" alt="效果图"></p><p>通过我们通过强制template注入的方式，将事件绑定在模板中的节点上，然后插入进表格。<br>修改为下面这样：</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">data-header</span>=<span class="hljs-string">&quot;&#x27;insert.html&#x27;&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-center&quot;</span> <span class="hljs-attr">bo-bind</span>=<span class="hljs-string">&quot;item.userDan&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/ng-template&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insert.html&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;sortable&quot;</span> ng-click=<span class="hljs-string">&quot;sort(&#x27;sortParam&#x27;)&quot;</span> ng-<span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;&#123;&#x27;sort-asc&#x27;: status == 1, &#x27;sort-desc&#x27;: status == -1 &#125;&quot;</span>&gt;</span><br><span class="language-javascript">        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sort-indicator&quot;</span>&gt;</span>此列可以进行升降序排列<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></span><br><span class="language-javascript">    &lt;/div&gt;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getTableParams</span>(<span class="hljs-params"></span>) &#123;<br>  $scope.<span class="hljs-property">tableParams</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NgTableParams</span>(&#123;<br>      <span class="hljs-attr">count</span>: <span class="hljs-variable constant_">PAGESIZE</span><br>  &#125;, &#123;<br>      <span class="hljs-attr">getData</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>) &#123;<br>          <span class="hljs-keyword">var</span> pageIndex = params.<span class="hljs-title function_">page</span>();<br>          <span class="hljs-keyword">return</span> httpData.<span class="hljs-title function_">loadUserHealthScoreRank</span>(&#123;<br>              <span class="hljs-attr">pageIndex</span>: pageIndex,<br>              <span class="hljs-attr">pageSize</span>: <span class="hljs-variable constant_">PAGESIZE</span>,<br>              <span class="hljs-attr">sortFieldName</span>:$scope.<span class="hljs-property">sortFieldName</span>,<br>              <span class="hljs-attr">sortDesc</span>:$scope.<span class="hljs-property">sortDesc</span><br>          &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) &#123;<br>              params.<span class="hljs-title function_">total</span>(response.<span class="hljs-property">totalNum</span>);<br>              $scope.<span class="hljs-property">tableCount</span> = response.<span class="hljs-property">totalNum</span>;<br>              <span class="hljs-keyword">return</span> response.<span class="hljs-property">list</span>;<br>          &#125;)<br>      &#125;<br>  &#125;);<br>&#125;<br><br><span class="hljs-comment">//排序</span><br>$scope.<span class="hljs-property">sort</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">type</span>) &#123;<br>  <span class="hljs-keyword">if</span>(type == <span class="hljs-string">&#x27;sortParam&#x27;</span>)&#123;<br>      $scope.<span class="hljs-property">sortFieldName</span> = <span class="hljs-string">&#x27;name&#x27;</span>;<br>      <span class="hljs-keyword">if</span>($scope.<span class="hljs-property">status</span> == <span class="hljs-string">&#x27;1&#x27;</span>)&#123;<br>          $scope.<span class="hljs-property">status</span> = <span class="hljs-string">&#x27;-1&#x27;</span>;<br>          $scope.<span class="hljs-property">sortDesc</span> = <span class="hljs-string">&#x27;asc&#x27;</span>;<br>      &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>($scope.<span class="hljs-property">moneystatus</span> == <span class="hljs-string">&#x27;-1&#x27;</span>)&#123;<br>          $scope.<span class="hljs-property">status</span> = <span class="hljs-string">&#x27;1&#x27;</span>;<br>          $scope.<span class="hljs-property">sortDesc</span> = <span class="hljs-string">&#x27;desc&#x27;</span>;<br>      &#125;<span class="hljs-keyword">else</span>&#123;<br>          $scope.<span class="hljs-property">status</span> = <span class="hljs-string">&#x27;1&#x27;</span>;<br>          $scope.<span class="hljs-property">sortDesc</span> = <span class="hljs-string">&#x27;desc&#x27;</span>;<br>      &#125;<br>   &#125;<br></code></pre></div></td></tr></table></figure><p>chrome中DOM渲染出来的效果可以看到如下：<br><img src="/img/angular2-3.png" alt="效果图"></p><p><code>表格爆栈</code><br>从后端获取json数据后匹配ng对象，进行模板填充，是使用ng的一般方法，有时候会出现如下错误：<br><img src="/img/angular2-4.png" alt="效果图"><br>翻译成中文就是：爆栈了…<br>查阅资料后发现，出现这个问题一般是进行了循环调用，即a调用b进行数据处理，同时b也调用了a，ng本身无法进行处理，只能报错。<br>而我出现这个问题的情况就比较诡异了，我在controller中初始化了一个对象，如下</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">$scope.<span class="hljs-property">search</span> = &#123;&#125;;<br>$scope.<span class="hljs-property">search</span>.<span class="hljs-property">rankType</span> = <span class="hljs-string">&#x27;1&#x27;</span>;<br></code></pre></div></td></tr></table></figure><p>当在表格参数中使用<code>$scope.search.rankType</code>时无法获取数据，报错就是爆栈了，后来经过<code>console.dir()</code>后发现<code>$scope.search</code>是拥有了众多方法的对象，自然循环起来就爆栈了，所以以后取名还得注意千万要避免ng自带的对象名。</p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>angular</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>搭一个little project脚手架（2）整合测试</title>
    <link href="/2016/06/28/%E6%90%AD%E4%B8%80%E4%B8%AAlittle-project%E8%84%9A%E6%89%8B%E6%9E%B6%EF%BC%882%EF%BC%89%E6%95%B4%E5%90%88%E6%B5%8B%E8%AF%95/"/>
    <url>/2016/06/28/%E6%90%AD%E4%B8%80%E4%B8%AAlittle-project%E8%84%9A%E6%89%8B%E6%9E%B6%EF%BC%882%EF%BC%89%E6%95%B4%E5%90%88%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>前文叙述了这个项目的搭建过程和理由，本文在这个工程中添加Jasmine+Karma测试，由于更新换代很快，在搭建这个脚手架的过程中走了好多坑，网上的很多解决方式在package更新后都不起作用，本文罗列了我在玩的过程中遇到的4个坑。</p></blockquote><span id="more"></span><p><code>Jasmine+Karma</code><br>Jasmine是BDD(行为驱动开发)框架，Karma是基于其的一个测试库。<br>Karma安装</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install karma -g<br></code></pre></div></td></tr></table></figure><p>Karma+Jasmine配置，根据提示完成配置项</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">karma init<br></code></pre></div></td></tr></table></figure><p>创建测试文件（符合jasmineAPI的测试脚本）</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">decsribe(&quot;A suite of basic function&quot;,function() &#123;<br>  it(&quot;finish some function&quot;,function()&#123;<br>    except(&quot;result&quot;).toEqual(FuncName(&quot;params&quot;))<br>  &#125;);<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>修改配置文件karma.conf.js</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-attr">browsers</span>: [<span class="hljs-string">&#x27;Chrome&#x27;</span>, <span class="hljs-string">&#x27;Firefox&#x27;</span>],<br><span class="hljs-attr">plugins</span>: [<br>      <span class="hljs-string">&#x27;karma-jasmine&#x27;</span>,<br>      <span class="hljs-string">&#x27;karma-chrome-launcher&#x27;</span>,<br>      <span class="hljs-string">&#x27;karma-firefox-launcher&#x27;</span><br>      ]<br></code></pre></div></td></tr></table></figure><h4 id="shell很大可能报错（1）"><a href="#shell很大可能报错（1）" class="headerlink" title="shell很大可能报错（1）"></a>shell很大可能报错（1）</h4><p><img src="/img/karma-error1.png" alt="karma start报错"><br>我已经在项目目录下运行了<code>npm install karma-chrome-launcher --save-dev</code> ，检查node_modules中也有了，还是显示上图错误。查阅了各种资源后，得出结论是因为我同时在全局和文件目录中安装了karma，默认启动了全局环境的karma，必须先卸载全局环境的karma，然后才能在文件目录中找到启动浏览器的插件。</p><h4 id="shell很大可能报错（2）"><a href="#shell很大可能报错（2）" class="headerlink" title="shell很大可能报错（2）"></a>shell很大可能报错（2）</h4><p>运行<code>karma start karma.conf.js</code>没有找到文件，原因是根目录下没有找到启动文件。解决方法是在<code>package.json</code>中的script中添加<code>&quot;test&quot;: &quot;node_modules/karma/bin/karma start karma.conf.js&quot;</code>，运行<code>npm run test</code>就可以进行测试了。</p><h4 id="shell很大可能报错（3）"><a href="#shell很大可能报错（3）" class="headerlink" title="shell很大可能报错（3）"></a>shell很大可能报错（3）</h4><p><img src="/img/karma-error2.png" alt="karma start报错"><br>这是因为karma直接打开了浏览器进行测试，目前浏览器对es6语法不是特别支持，特别是import关键字不支持，在文章（1） 中介绍了本项目使用了es6＋webpack构建，webpack完成了babel和解决了依赖问题，但是我们需要测试的是自己写的代码而不是打包后的代码，所以需要寻找新的办法。<br>我第一个项目是用babel，但是出现了上图的问题，原因是babel解决了es6编译的问题，但是处理不了依赖关系，所以需要新的方式进行操作。</p><h4 id="shell很大可能报错（4）"><a href="#shell很大可能报错（4）" class="headerlink" title="shell很大可能报错（4）"></a>shell很大可能报错（4）</h4><p><img src="/img/karma-error3.png" alt="karma start报错"><br> 出现上图错误基本是因为文件目录没有找到，需要在根目录下启动karma命令。</p><p>最后的配置文件karma.conf.js</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-attr">preprocessors</span>: &#123;<br> <span class="hljs-string">&#x27;../../*.js&#x27;</span>: [<span class="hljs-string">&#x27;webpack&#x27;</span>, <span class="hljs-string">&#x27;babel&#x27;</span>]<br>&#125;,<br><span class="hljs-attr">webpack</span>: &#123;<br>&#125;,<br><span class="hljs-attr">webpackMiddleware</span>: &#123;<br>   <span class="hljs-attr">noInfo</span>: <span class="hljs-literal">true</span><br>&#125;,<br><span class="hljs-attr">babelPreprocessor</span>: &#123;<br> <span class="hljs-attr">options</span>: &#123;<br>   <span class="hljs-attr">presets</span>: [<span class="hljs-string">&#x27;es2015&#x27;</span>],<br>   <span class="hljs-attr">sourceMap</span>: <span class="hljs-string">&#x27;inline&#x27;</span><br> &#125;,<br> <span class="hljs-attr">filename</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">file</span>) &#123;<br>   <span class="hljs-keyword">return</span> file.<span class="hljs-property">originalPath</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.js$/</span>, <span class="hljs-string">&#x27;.es5.js&#x27;</span>);<br> &#125;,<br> <span class="hljs-attr">sourceFileName</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">file</span>) &#123;<br>   <span class="hljs-keyword">return</span> file.<span class="hljs-property">originalPath</span>;<br> &#125;<br>&#125;,<br><span class="hljs-attr">browsers</span>: [<span class="hljs-string">&#x27;Chrome&#x27;</span>, <span class="hljs-string">&#x27;Firefox&#x27;</span>],<br><span class="hljs-attr">plugins</span>: [<br>      <span class="hljs-string">&#x27;karma-jasmine&#x27;</span>,<br>      <span class="hljs-string">&#x27;karma-webpack&#x27;</span>,<br>      <span class="hljs-string">&#x27;karma-chrome-launcher&#x27;</span>,<br>      <span class="hljs-string">&#x27;karma-firefox-launcher&#x27;</span>,<br>      <span class="hljs-string">&#x27;karma-babel-preprocessor&#x27;</span><br>      ]<br></code></pre></div></td></tr></table></figure><p><code>附录</code><br><a href="http://blog.fens.me/nodejs-karma-jasmine/">Karma和Jasmine自动化单元测试</a><br><a href="https://karma-runner.github.io/latest/intro/configuration.html">karma文档</a><br><a href="https://github.com/babel/karma-babel-preprocessor">karma-babel-preprocessor</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>搭一个little-project脚手架（1）webpack+es6</title>
    <link href="/2016/06/22/%E6%90%AD%E4%B8%80%E4%B8%AAlittle-project%E8%84%9A%E6%89%8B%E6%9E%B6%EF%BC%881%EF%BC%89webpack+es6/"/>
    <url>/2016/06/22/%E6%90%AD%E4%B8%80%E4%B8%AAlittle-project%E8%84%9A%E6%89%8B%E6%9E%B6%EF%BC%881%EF%BC%89webpack+es6/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇文章用于叙述这个项目的搭建过程和理由，用法比较简单，用es6进行代码书写（eslint代码检查），用babel编译，webpack打包，加入常用css库文件(eg:normalize.css)、js库文件(eg:fetch.js)，可选择BDD。若比较成功，后期将做成npm包使用。</p></blockquote><span id="more"></span><p><code>目录结构设置</code></p><figure class="highlight mipsasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mipsasm">- node_modules<br>- client - asserts(<span class="hljs-keyword">just </span>for images <span class="hljs-keyword">or </span>other resource like sounds <span class="hljs-keyword">or </span>movs)<br>         - components <br>            - page1.<span class="hljs-keyword">js(small </span>pros are <span class="hljs-keyword">just </span><span class="hljs-keyword">divided </span>into pages,<span class="hljs-keyword">or </span>exact <span class="hljs-keyword">divided </span>into slider,title)<br>            - page1.<span class="hljs-keyword">scss</span><br><span class="hljs-keyword"></span>         - public <br>            - <span class="hljs-keyword">scss </span><br>            - css<br>              - <span class="hljs-keyword">normalize.css</span><br><span class="hljs-keyword"></span>            - <span class="hljs-keyword">js</span><br><span class="hljs-keyword"></span>              - fetch.<span class="hljs-keyword">js</span><br><span class="hljs-keyword"></span>         - <span class="hljs-keyword">dist(release </span><span class="hljs-keyword">dictionary)</span><br><span class="hljs-keyword"></span>            - index.html<br>- package.<span class="hljs-keyword">json</span><br><span class="hljs-keyword"></span>- webpack.config.<span class="hljs-keyword">js</span><br><span class="hljs-keyword"></span>- .gitignore<br>- .eslintrc<br></code></pre></div></td></tr></table></figure><p><code>webpack</code><br>具体优势可以参考：<a href="http://zhaoda.net/webpack-handbook/what-is-webpack.html">webpack优势</a>，在本项目中主要是作为模块打包工具使用，通过自定义的方式将依赖树拆分成按需加载的块。<br>在项目根目录中使用<code>webpack.config.js</code>设置打包的文件目录，<code>dist</code>是最后需要提交的文件夹，所以将打包好的js文件命名为bundle.js保存到dist目录下，在index.html中引入。<br>index.html</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;bundle.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">webpack -w //启用监听模式，没有变化的模块编译后返回到内存中<br>webpack-dev-server  //默认启动在localhost:8080的服务<br></code></pre></div></td></tr></table></figure><p><code>fetch.js</code><br>目前引用了fetch.js来实现ajax请求，FetchAPI也可以使用，以后确定浏览器支持性可以完全替换。</p><p><code>附录</code><br><a href="https://github.com/ginny315/es6-proConstructor">本项目git地址</a><br><a href="http://www.cnblogs.com/qianlegeqian/p/4728170.html">配置eslint中文备注</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue1.0+es6+webpack脚手架搭建</title>
    <link href="/2016/05/02/vue1-es6-webpack%E8%84%9A%E6%89%8B%E6%9E%B6%E6%90%AD%E5%BB%BA/"/>
    <url>/2016/05/02/vue1-es6-webpack%E8%84%9A%E6%89%8B%E6%9E%B6%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>终于es6学完了，过胖开始写demo，欧耶！学vue的时候恰好发布了2.0版本，着渐进增强的原则，本文先用1.0版本写demo，玩过之后再来一发2.0。<br>本篇属于webpack、vue语法基础篇，只要肯走坑，框架搭起来不是问题。</p></blockquote><span id="more"></span><h4 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h4><blockquote><p>vue语法不是浏览器原生支持的，所以需要做依赖管理和打包<br>loader机制支持载入各种静态资源（把所有非js资源转换成js，url-loader、css&#x2F;style-loader）<br>plugin机制对整个流程进行一定的控制</p></blockquote><p><code>安装</code></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install -g webpack<br>//项目文件夹下<br>npm init<br>npm install webpack --save-dev //只需要在生产环境使用<br></code></pre></div></td></tr></table></figure><p><code>配置</code><br>webpack使用起来本质就是做一个配置(webpack.config.js)<br>这里给出了安装相应加载器的配置：<br>加载器需要先安装，然后才能运行webpack指令</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">npm install --save xxx-loader <br></code></pre></div></td></tr></table></figure><p>webpack.config.js文件</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>:<span class="hljs-string">&#x27;./main.js&#x27;</span>, <span class="hljs-comment">//入口文件</span><br>  <span class="hljs-attr">output</span>: &#123; <span class="hljs-comment">//输出</span><br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;dist&#x27;</span>,<br>    <span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;bundle.js&#x27;</span><br>  &#125;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">loaders</span>: [&#123;<br>      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,<br>      <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;vue&#x27;</span>,<br>      <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>, <br>      <span class="hljs-attr">loader</span>:<span class="hljs-string">&quot;style-loader!css-loader&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpg|gif)$/</span>, <br>      <span class="hljs-attr">loader</span>:<span class="hljs-string">&quot;url-loader&quot;</span><br>      <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,<br>      <span class="hljs-attr">query</span>: &#123;<br>        <span class="hljs-attr">limit</span>: <span class="hljs-number">1000</span><br>      &#125;<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js[x]?$/</span>, <br>      <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>, <br>      <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;babel-loader&#x27;</span>,<br>      <span class="hljs-attr">query</span>: &#123;<br>        <span class="hljs-attr">presets</span>: [<span class="hljs-string">&#x27;es2015&#x27;</span>],<br>        <span class="hljs-attr">plugins</span>: [<span class="hljs-string">&#x27;transform-runtime&#x27;</span>]<br>      &#125;<br>    &#125;]<br>  &#125;<br>  <span class="hljs-attr">resolve</span>: &#123; <span class="hljs-comment">//搜索默认路径</span><br>    <span class="hljs-attr">alias</span>: &#123;<br>      <span class="hljs-attr">js</span>: path.<span class="hljs-title function_">join</span>(__dirname,<span class="hljs-string">&quot;&quot;</span>),<br>      <span class="hljs-attr">src</span>: path.<span class="hljs-title function_">join</span>(__dirname,<span class="hljs-string">&quot;&quot;</span>)<br>    &#125;,<br>    <span class="hljs-attr">root</span>: [<br>      path.<span class="hljs-title function_">join</span>(__dirname,<span class="hljs-string">&quot;&quot;</span>)<br>    ],<br>    <span class="hljs-attr">modulesDirectories</span>: [<span class="hljs-string">&#x27;node_modules&#x27;</span>]<br>  &#125;,<br>&#125;<br></code></pre></div></td></tr></table></figure><blockquote><p>entry表示输入，output表示输出<br>&#x2F;.css$&#x2F;匹配xx.css文件，&#x2F;.css&#x2F;匹配xx.css以及xx.css.zip文件<br>?aa&#x3D;bb，表示将aa设置为bb<br>webpack优先搜索root目录，再搜索modulesDirectories</p></blockquote><p><code>启动</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">webpack<br></code></pre></div></td></tr></table></figure><p>此时文件被打包到dist目录下，新建index.html默认入口文件，index.html中引入bundle.js文件，此时的dist文件夹就是打包后的目录文件夹。</p><p><code>文件分离按需加载</code><br>require.ensure会产生额外的boundle，按具体情况进行配置。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">require</span>.<span class="hljs-title function_">ensure</span>([<span class="hljs-string">&quot;jquery&quot;</span>,<span class="hljs-string">&quot;imgScrll&quot;</span>],<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span></span>)&#123;<br>  <span class="hljs-keyword">var</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;jquery&quot;</span>);<br>  <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;imgScroll&quot;</span>);<br>  $(<span class="hljs-string">&quot;#container&quot;</span>).<span class="hljs-title function_">scroll</span>(&#123; <br>    <span class="hljs-comment">//do sth</span><br>  &#125;)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><code>其他命令</code></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">webpack -p //uglify<br>webpack -w //watch <br></code></pre></div></td></tr></table></figure><h4 id="vue-loader"><a href="#vue-loader" class="headerlink" title="vue-loader"></a>vue-loader</h4><p>vue-loader是vue作者提供的加载器。<br>teplate-name有多种，这里使用webpack相关标准来定制。<br>init时需要按照要求输入文件相关，官方提供了几个模板，支持ESLint以及Mocha（依赖包略多，有点担心升级麻烦）</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install -g vue-cli<br>vue init &lt;template-name&gt; &lt;project-name&gt;<br></code></pre></div></td></tr></table></figure><h4 id="vue"><a href="#vue" class="headerlink" title="vue"></a>vue</h4><p><code>demo01</code>简单形式</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;demo&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;&#123;&#123;name&#125;&#125;&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;&#123;&#123;name&#125;&#125;&quot;</span> <span class="hljs-attr">v-attr</span>=<span class="hljs-string">&quot;src:url&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">    <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#demo&#x27;</span>,</span><br><span class="language-javascript">    <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ginny&#x27;</span>,</span><br><span class="language-javascript">      <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;http://guoningyan.com/test.png&#x27;</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><code>思考</code></p><blockquote><p>“如果想绑定的特性是像 img[src] 这样的不能在 html 中随意初始化的 (可能默认会产生预期外的网络请求)，没关系，有 v-attr&#x3D;”src: url” 这样的写法，把被绑定的数据里的 url 同步过来。”（引用自勾三股四的blog）<br>之前写过同样是 MVVM 框架的 angular ，数据绑定写法类似，用的是ng-src&#x3D;””，使用过程中没有发现上面的问题，这点以后研究一下再补上。</p></blockquote><p><code>demo02</code>xx.vue格式<br>这种格式将模板（jade etc..）、样式（css、sass etc..）、脚本（es6 etc..）集合成一整个文件，每个文件是一个组件，预编译文件使用lang说明文件格式。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">other-component</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">other-component</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css"><span class="hljs-selector-tag">html</span>&#123;</span><br><span class="language-css">  <span class="hljs-attribute">background-color</span>:red;</span><br><span class="language-css">&#125;</span><br><span class="language-css"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">OtherComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/other-component.vue&#x27;</span></span><br><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">let</span> testDemo = &#123;</span><br><span class="language-javascript">  <span class="hljs-attr">components</span>: &#123; <span class="hljs-title class_">OtherComponent</span> &#125;,</span><br><span class="language-javascript">  <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;test&#x27;</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> testDemo;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>使用vue-loader进行预编译打包</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm run dev<br></code></pre></div></td></tr></table></figure><p><code>目录结构</code><br>以下的写法皆是使用webpack模板后的目录结构</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">- build<br>- node_moudles<br>- src<br>- assets<br>- components (每个组件对应.vue文件 )<br>- App.vue (主vue)<br>- main.js<br>- static<br>- test<br>- .babelrc //babel配置<br>- eslintrc //eslint配置，建议使用airborb<br>- config.js //生产建构路径<br>- gulpfile.js //gulp监听<br>- index.html //启动后的首页<br>- package.json <br></code></pre></div></td></tr></table></figure><p>先将组件写在components中，每个.vue文件对应一个组件，然后通过打包工具集成。gulpfile文件配件见附录勾三股四的博客。</p><p><code>附录</code>参考资料<br><a href="https://github.com/ruanyf/webpack-demos#demo01-entry-file-source">阮老师的webpack很好上手</a><br><a href="https://github.com/yesvods/Blog/issues/2">git上某个webpack简明教程</a><br><a href="http://jiongks.name/blog/just-vue/">vue+webpack 勾三股四的blog</a><br><a href="https://www.npmjs.com/package/vue-loader">vue-loader</a><br><a href="http://eslint.org/">eslint</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
      <tag>javascript</tag>
      
      <tag>vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ES6备忘</title>
    <link href="/2016/05/01/ES6%E5%A4%87%E5%BF%98/"/>
    <url>/2016/05/01/ES6%E5%A4%87%E5%BF%98/</url>
    
    <content type="html"><![CDATA[<p>花了一个礼拜时间学习了ES6，本文记录了一些常用关键语法备忘。这篇内容比较简单，对于Promise及异步操作之类的本文暂且略过，将在后续实践中展开。</p><h4 id="let"><a href="#let" class="headerlink" title="let"></a>let</h4><ul><li>块级作用域（构成块级的大括号不能少）有效，声明后不管全局中有没有，都会形成一个封闭作用域</li><li>不存在变量提升，使用前需要先声明（注意函数声明，在块级作用域中声明的函数只有在此块级中可以使用）</li><li>不允许在相同作用域内，重复声明同一个变量</li></ul><span id="more"></span><h4 id="const"><a href="#const" class="headerlink" title="const"></a>const</h4><ul><li>声明的是常量（声明时必须初始化）</li><li>块级作用域有效</li><li>复合类型时指向数据所在地址（注意将对象设置为const时不能改变其属性的值；将数组设置为const时不能将另一个数组赋值给它，可以在当前数组中对数组元素作操作）</li><li>跨模块常量  <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//moduleA.js</span><br><span class="hljs-built_in">exports</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">AA</span> = <span class="hljs-number">123</span>;<br><span class="hljs-built_in">exports</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BB</span> = <span class="hljs-number">456</span>;<br><br><span class="hljs-comment">//main.js</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> moduleA form <span class="hljs-string">&#x27;./moduleA&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(moduleA.<span class="hljs-property">AA</span>);<span class="hljs-comment">//123</span><br><span class="hljs-comment">//another way</span><br><span class="hljs-keyword">import</span> &#123;<span class="hljs-variable constant_">AA</span>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./moduleA&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable constant_">AA</span>);<span class="hljs-comment">//123</span><br></code></pre></div></td></tr></table></figure><blockquote><p>ES6中，有6种声明变量的方法;<br>var、function声明的全局变量是全局对象的属性;<br>let、const、class声明的全局变量不属于全局对象的属性</p></blockquote></li></ul><h4 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h4><ul><li>新的（Boolean,String,Number,Object,null,undefined之外的第七种）原始数据类型，表示独一无二的值</li><li>不是对象，不能添加属性，不能new，可以加参数，可以显示转为字符串，布尔值，但是不能转为数值   <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> s = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;foo&#x27;</span>);<br>s <span class="hljs-comment">//Symbol(foo)</span><br>s.<span class="hljs-property">toString</span> <span class="hljs-comment">//&quot;Symbol(foo)&quot;</span><br></code></pre></div></td></tr></table></figure></li><li>每一个Symbol值都是不相等的，可以作为标志符，用于对象的属性名（不能用点运算符），能保证不会出现同名的属性   <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> test = &#123;<br>  [<span class="hljs-title class_">Symbol</span>()]:<span class="hljs-string">&#x27;test&#x27;</span><br>&#125;<br>test[<span class="hljs-title class_">Symbol</span>()] <span class="hljs-comment">//test</span><br></code></pre></div></td></tr></table></figure></li><li>通过Object.getOwnPropertySymbols()获取，返回一个数组</li><li>Symbol.for()为Symbol值登记的名字。使用同一个Symbol值</li></ul><h4 id="解构赋值"><a href="#解构赋值" class="headerlink" title="解构赋值"></a>解构赋值</h4><p>从数组或对象中提取值（解构），然后按照层级对应位置进行赋值。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//Array</span><br><span class="hljs-keyword">let</span> [a,[b],c = <span class="hljs-number">0</span>,d = <span class="hljs-number">33</span>,e,f,g] = [<span class="hljs-number">1</span>,[<span class="hljs-number">2</span>],<span class="hljs-number">3</span>,<span class="hljs-literal">undefined</span>,<span class="hljs-literal">null</span>];<span class="hljs-comment">//a=1,b=2,c=3,d=33,e=null,g=undefined</span><br><span class="hljs-keyword">let</span> [d,e] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]);<span class="hljs-comment">//d=4,e=5</span><br><span class="hljs-keyword">let</span> [x = <span class="hljs-number">1</span>,y = <span class="hljs-number">2</span>] = [<span class="hljs-number">2</span>];<span class="hljs-comment">//x=2,y=2</span><br>[x,y] = [y,x];<span class="hljs-comment">//交换变量的值</span><br><br><span class="hljs-comment">//Object</span><br><span class="hljs-keyword">let</span> &#123;a,b&#125; = &#123;<span class="hljs-attr">b</span>:<span class="hljs-number">11</span>,<span class="hljs-attr">a</span>:<span class="hljs-number">22</span>&#125;;<span class="hljs-comment">//a=22,b=11</span><br><span class="hljs-keyword">let</span> &#123;<span class="hljs-attr">y</span>:x&#125; = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">111</span>&#125;;<span class="hljs-comment">//y=111,x=undefined</span><br>(&#123;x&#125; = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">1</span>&#125;);<span class="hljs-comment">//()避免js引擎将&#123;&#125;理解为一个代码块，可能导致歧义，尽量不用;</span><br><span class="hljs-keyword">let</span> &#123; log, sin, cos &#125; = <span class="hljs-title class_">Math</span>;<br><br><span class="hljs-comment">//String(转化为类数组对象)</span><br><span class="hljs-keyword">const</span> [a,b] = <span class="hljs-string">&#x27;hi&#x27;</span>;<span class="hljs-comment">//a=&#x27;h&#x27;,b=&#x27;i&#x27;</span><br><span class="hljs-keyword">const</span> &#123;<span class="hljs-attr">length</span>:a&#125; = <span class="hljs-string">&#x27;hi&#x27;</span><span class="hljs-comment">//a=2</span><br><br><span class="hljs-comment">//function</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">[x=<span class="hljs-number">0</span>,y=<span class="hljs-number">9</span>]</span>)&#123;<br>  <span class="hljs-keyword">return</span> x+y;<br>&#125;<br><span class="hljs-title function_">add</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]);<span class="hljs-comment">//3</span><br><span class="hljs-title function_">add</span>([]);<span class="hljs-comment">//9</span><br></code></pre></div></td></tr></table></figure><blockquote><p>等号右边必须是可遍历的结构;<br>undefined !&#x3D;&#x3D; null，只有&#x3D;&#x3D;&#x3D;undefined的变量为undefined，其余情况均为其值;<br>对象结构的内部机制，先找到同名属性，再复制给对应的变量，对应的变量获得赋值的结果，同名属性（理解为模式，非变量）并没有获得赋值;<br>可以将现有对象的方法赋值到某个变量;<br>若等号右边为Number和Boolean，则先转为对象;</p></blockquote><h4 id="字符串的扩展"><a href="#字符串的扩展" class="headerlink" title="字符串的扩展"></a>字符串的扩展</h4><p>模板字符串（运行效率较慢）</p><blockquote><p>模板字符串表示多行字符串，空格和tab保留<br>静态字符串一律使用单引号或反引号，不使用双引号<br>动态字符串使用反引号。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;a&#x27;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`link<span class="hljs-subst">$&#123;A.linkText&#125;</span><span class="hljs-subst">$&#123;A.otherProp&#125;</span>`</span>;<br><span class="hljs-string">`<span class="hljs-subst">$&#123;a&#125;</span> + <span class="hljs-subst">$&#123;b&#125;</span> = <span class="hljs-subst">$&#123;a+b&#125;</span>`</span>;<br></code></pre></div></td></tr></table></figure><h4 id="正则的扩展"><a href="#正则的扩展" class="headerlink" title="正则的扩展"></a>正则的扩展</h4><ul><li>RegExp构造函数参数改变 <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> reg = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-regexp">/abc/ig</span>,<span class="hljs-string">&#x27;i&#x27;</span>);<span class="hljs-comment">//等同于new RegExp(&#x27;abc&#x27;,&#x27;i&#x27;)</span><br></code></pre></div></td></tr></table></figure></li><li>字符串对象的正则方法（match、replace、search、split）全部调用RegExp的实力方法</li><li>u修饰符代表Unicode模式</li><li>&#x2F;\u{BBB30}&#x2F;u，{}表示Unicode字符</li><li>y修饰符表示全局模式（区别于g修饰符，y只能从剩余的第一个位置开始）</li></ul><h4 id="数值的扩展"><a href="#数值的扩展" class="headerlink" title="数值的扩展"></a>数值的扩展</h4><ul><li>减少全局性方法，使语言逐步模块化<ul><li>Number.isFinite()，是否非正无穷</li><li>Number.isNaN()</li><li>Number.parseInt(),Number.parseFloat()</li></ul></li><li>Number.isInteger()，是否为整数（整数浮点数存储方法相同）</li></ul><h4 id="数组的扩展"><a href="#数组的扩展" class="headerlink" title="数组的扩展"></a>数组的扩展</h4><ul><li>Array.from(arr,item &#x3D;&gt; item*item)将类数组对象（有length属性）和可遍历的对象转为真正的数组，第二个参数用法类似于map</li><li>[…arguments]将一些数据结构转为数组</li><li>Array.of(arg0,arg1)将一组值转换为数组</li><li>空位转为undefined</li></ul><h4 id="函数的扩展"><a href="#函数的扩展" class="headerlink" title="函数的扩展"></a>函数的扩展</h4><ul><li>参数声明变量默认值之后，不能用let,const再次声明</li><li>解构赋值时，传参数据类型相对应</li><li>参数先对应默认值（运行时执行，默认值设置为undefined表明可以省略），然后解构赋值生效</li><li>rest参数将多余参数放入数组中，之后不能有其他参数。</li><li>有iterator接口的类数组对象可以使用扩展运算符，没有此接口使用Array.from转为真正的数组</li><li>箭头函数，this指向定义时的对象（外层代码块this），不可以作为构造函数（本身没有this），不可以使用arguments（用rest），不能作为Generator函数。  <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> <span class="hljs-title function_">f</span> = param =&gt; returnParam<br><span class="hljs-keyword">var</span> <span class="hljs-title function_">sum</span> = (<span class="hljs-params">num1,num2</span>) =&gt; &#123;<span class="hljs-keyword">return</span> num1+num2;&#125;<br></code></pre></div></td></tr></table></figure></li><li>使用尾递归（严格模式），防止栈溢出</li></ul><h4 id="对象的扩展"><a href="#对象的扩展" class="headerlink" title="对象的扩展"></a>对象的扩展</h4><ul><li>属性、方法简写（Generator函数加＊）</li><li>name作为对象名、方法名（get、set、bound、anonymous、Symbol的描述）</li><li>Object.is()，同值相等（针对＋1-1，NaN）</li><li>Object.assign(target,source1,source2)浅拷贝，只拷贝源对象的自身属性（不拷贝继承属性和不可枚举属性），遇到同名属性替换<br><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//浅克隆</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">origin</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;,origin);<br>&#125;<br><span class="hljs-comment">//深克隆</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">origin</span>) &#123;<br><span class="hljs-keyword">let</span> originProto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(origin);<br><span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(originProto),origin);<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li>Object.setPrototypeOf(target,origin)设置原型对象</li></ul><h4 id="Iterator"><a href="#Iterator" class="headerlink" title="Iterator"></a>Iterator</h4><ul><li>为不同的数据结构提供统一的访问机制，有Iterator接口（数组、类数组对象String etc..、Set、Map原生具有）就能完成遍历操作。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NewIterator</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>)&#123;&#125;<br>  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() &#123; <br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; <br>  &#125;<br> &#125;<br> <span class="hljs-comment">//类数组对象调用数组的Iterator方法</span><br> <span class="hljs-title class_">ArrLike</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>];<br></code></pre></div></td></tr></table></figure></li><li>具有Iterator接口的数据结构，通过[…arg]或者Array.from(arrayLike)转为数组</li></ul><h4 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h4><ul><li>Generator函数封装了多个内部的状态</li><li>函数返回一个迭代器对象，可以依次遍历Generator函数内部的每一个状态。也是一个iterator对象生成函数</li><li>只有调用next方法才会执行<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span>* <span class="hljs-title class_">GenDemo</span>() &#123;<br>  <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;firstState&quot;</span>;<br>  <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;secondState&quot;</span>;<br>  <span class="hljs-keyword">yield</span>* <span class="hljs-string">&quot;divideStr&quot;</span>; <span class="hljs-comment">//相当于for(var value of &quot;divideStr&quot;)</span><br>&#125;<br></code></pre></div></td></tr></table></figure></li><li>遇到yield暂停执行后面的操作，返回紧跟语句后表达式的值</li><li>next()继续执行，return()返回给定的值并终结函数执行，若有finally,return推迟到finally代码块执行完再执行</li></ul><h4 id="class"><a href="#class" class="headerlink" title="class"></a>class</h4><ul><li>等同于构造函数，类内部定义的方法不可枚举 <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> &#123;<br><span class="hljs-title function_">constructor</span>(<span class="hljs-params">x,y</span>) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = x;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> = y;<br>&#125;<br><span class="hljs-title function_">toString</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-title function_">toValue</span>(<span class="hljs-params"></span>) &#123;&#125;<br>[methodName]()&#123;&#125;<br>state = &#123;<span class="hljs-comment">//实例属性</span><br>  <span class="hljs-attr">count</span>:<span class="hljs-number">0</span><br>&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li>可以立刻执行<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> a = <span class="hljs-keyword">new</span> <span class="hljs-keyword">class</span> &#123;<br><span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><span class="hljs-title function_">sayName</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);<br>&#125;<br>&#125;(<span class="hljs-string">&#x27;立刻执行参数&#x27;</span>);<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">a.sayName();//立刻执行参数<br></code></pre></div></td></tr></table></figure></li><li>不存在变量提升</li><li>类和模块的内部，默认就是严格模式</li><li>类的继承（先创造父类的实例对象this，然后再通过调用super方法，用子类的构造函数修改this）  <figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">x,y,color</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(x,y);<span class="hljs-comment">//父类的构造函数，用来新建父类的this对象，子类继承父类的this对象</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;<br>  &#125;<br>  <span class="hljs-title function_">toString</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span>+<span class="hljs-string">&#x27;&#x27;</span>+<span class="hljs-variable language_">super</span>.<span class="hljs-title function_">toString</span>();<span class="hljs-comment">//通过super可以引用父类实例的属性和方法，也可以引用父类的静态方法</span><br>  &#125;<br>&#125;<br><span class="hljs-title class_">Child</span>.<span class="hljs-property">_proto</span> === parent;<span class="hljs-comment">//true</span><br><span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_proto_</span> === <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;<span class="hljs-comment">//true</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-title class_">Child</span>) === <span class="hljs-title class_">Parent</span>;<span class="hljs-comment">//true</span><br></code></pre></div></td></tr></table></figure></li><li>class内部只有静态方法，没有静态属性（babel已经支持，可用）</li><li>new.target查看构造函数（子类继承父类时返回子类）</li></ul><p>在继承这块ES6与ES5区别</p><blockquote><p>ES6通过引入class，让javascript引擎去实现原来需要我们自己编写的代码<br>ES5中需要通过中间对象继承，ES6中直接通过extents实现<br>ES5通过在原型链上添加方法，代码比较分散。ES6直接将方法写在类中<br>ES5原生构造函数无法继承（子类无法获得构造函数的内部属性），ES6允许继承构造函数定义子类-<br>ES5先创造子类的实例对象this，再将父类的方法添加到this上面，ES6先创建父类的实例对象this（必须先调用super方法），然后再用子类的构造函数修改this</p></blockquote><h4 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h4><ul><li>解决模块化问题，import加载，{}中的变量名必须与被导入模块对外接口的名称相同，import命令具有提升效果。</li><li>exports输出（必须是对外的接口，可以通过该接口取到模块内部实时的值），as重命名输出，可以用不同的名字输出多次。<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123;stat,exists,readFile&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span>;<span class="hljs-comment">//编译时加载</span><br><span class="hljs-keyword">import</span> &#123;originName <span class="hljs-keyword">as</span> newName&#125; form <span class="hljs-string">&#x27;./test&#x27;</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">v1</span>(<span class="hljs-params"></span>)&#123;&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">v2</span>(<span class="hljs-params"></span>)&#123;&#125;<br><span class="hljs-keyword">export</span> &#123;<br>  v1 <span class="hljs-keyword">as</span> mod1,<br>  v2 <span class="hljs-keyword">as</span> mod2,<br>  v2 <span class="hljs-keyword">as</span> mod22<br>&#125;<br></code></pre></div></td></tr></table></figure></li><li>通过指定默认输出，黑盒模块名（一个模块只能有一个默认输出）<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//A.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-comment">//main.js</span><br><span class="hljs-keyword">import</span> aaa <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./A.js&#x27;</span><br><span class="hljs-title function_">aaa</span>();<br></code></pre></div></td></tr></table></figure></li><li>模块输出实质是输出值的引用（commonjs输出值的拷贝），运用时访问模块取值，不会缓存。export接口输出对象实例时，任意import都是针对同一个对象实例操作。</li><li>es6 module transpiler（转成CommonJS或者AMD）<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">npm install -g es6-<span class="hljs-variable language_">module</span>-transpiler<br>compile-modules convert file1.<span class="hljs-property">js</span> file2.<span class="hljs-property">js</span><br>compile-modules convert -o newName.<span class="hljs-property">js</span> originName.<span class="hljs-property">js</span><br></code></pre></div></td></tr></table></figure></li></ul><h4 id="ESLint与Airbnb语法规则"><a href="#ESLint与Airbnb语法规则" class="headerlink" title="ESLint与Airbnb语法规则"></a>ESLint与Airbnb语法规则</h4><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install -g eslint<br>npm install -g eslint-config-airbnb<br></code></pre></div></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-comment">//.eslintrc</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;extends&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;eslint-config-airbnb&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">eslint index.js<br></code></pre></div></td></tr></table></figure><p><code>附录一</code>学习资料<br><a href="http://es6.ruanyifeng.com/#docs">阮老师的ECMAScript入门</a><br><a href="https://github.com/airbnb/javascript">airbnb编码规范</a><br><a href="http://v.youku.com/v_show/id_XMTU0NTk3NjY0MA==.html">ECMAScript6 开发体系实践</a><br><a href="http://www.liaoxuefeng.com/">廖雪峰的官方网站－原型继承、class继承</a><br><a href="https://babeljs.io/">babel</a></p><p><code>附录二</code> 现有选型</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">gulp+webpack+gulp-babel+es6<br>fis3+fis3-paser-babel+es6<br>react+webpack+es6<br>typescript+vscode+es6+ts transform<br></code></pre></div></td></tr></table></figure><p><code>附录三</code>环境配置</p><ul><li><p>npm安装</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm install --save-dev babel-cli<br>npm install --save-dev babel-polyfill<br></code></pre></div></td></tr></table></figure></li><li><p>创建一个.babelrc</p><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">&#123;<br>  presets:[<br>    <span class="hljs-string">&quot;es2015&quot;</span>,<br>  ]<br>&#125;<br></code></pre></div></td></tr></table></figure><p>​  ​</p><p>​</p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>一小段js代码的思考（1）</title>
    <link href="/2016/04/14/%E4%B8%80%E5%B0%8F%E6%AE%B5js%E4%BB%A3%E7%A0%81%E7%9A%84%E6%80%9D%E8%80%83%EF%BC%881%EF%BC%89/"/>
    <url>/2016/04/14/%E4%B8%80%E5%B0%8F%E6%AE%B5js%E4%BB%A3%E7%A0%81%E7%9A%84%E6%80%9D%E8%80%83%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>今天随手写了一段代码，被<a href="http://www.w3ctech.com/user/4434">@流浪大法师</a>吐槽了，于是整理出了关于一个比较友善的写法以及在这段代码中的思考。<br>本篇有一点js trick在里面，也有模块化、函数科里化的一些写法。</p></blockquote><span id="more"></span><p>先看下面的糟糕的<code>第一段代码</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> test  = (<span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;inner-arg0=&quot;</span>+arg0);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;return-arg0=&quot;</span>+arg0)<br>  &#125;<br>&#125;)();<br></code></pre></div></td></tr></table></figure><p>这里我犯了一个错误，我习惯性地将函数最外层用括号包起来使其立即执行，这是声明式的用法，在这里运用错误。函数有两种形式，表达式和声明式，函数表达式本身可以立即执行。</p><p><code>第二段代码</code>修改了一下</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"> <span class="hljs-keyword">var</span> test2 = <span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;inner-arg0=&quot;</span>+arg0);<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;return-arg0=&quot;</span>+arg0)<br>    &#125;<br>&#125;();<br></code></pre></div></td></tr></table></figure><p>去掉最外层括号之后本段代码也立即执行了。<br>若要让声明式立即执行，需要加一些小技巧。</p><p><code>最常见的写法</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<span class="hljs-comment">//这里的代码立即执行</span><br>&#125;)()<br></code></pre></div></td></tr></table></figure><p><code>奇特的写法</code>：<br>赋值，逻辑，甚至是逗号，各种操作符都可以告诉解析器，这个不是函数声明，它是个函数表达式。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">!<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;aaa&quot;</span>)&#125;<span class="hljs-comment">//可以使用+-~void new delete</span><br></code></pre></div></td></tr></table></figure><p>在chrome中的执行结果如下：<br><img src="/img/js1-code1.png" alt="exection code result show one"><br>截图中可以看出，inner部分直接执行了，调用test()的时候return的匿名函数执行了。<br>因为之前写别的语言的缘故，习惯在函数的起始位置就传参，由于本段代码是立即执行的，所以第一次传参并没有起作用，后续的函数调用根本就没有调用到，这种写法真是太糟糕了。</p><p>以下是<code>第三段代码</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> test3 = <span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;inner-arg0=&quot;</span>+arg0);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">arg1</span>)&#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;return-arg1=&quot;</span>+arg1)<br>    &#125;<br>&#125;;<br></code></pre></div></td></tr></table></figure><p>在chrome中的执行结果如下：<br><img src="/img/js1-code2.png" alt="exection code result show two"><br>这里放弃了立即执行，采用需要时调用的方式。<br>第一次调用函数表达式，第二次调用返回的匿名函数，根据调用次序的不同，可以满足不同的业务需求。<br>第一次调用时，传参进行初始化，参数在函数作用域中声明，当函数执行完毕之后，被gc掉（属于标记清除）。<br>第二次调用使用的是返回的函数，这里是一个闭包，注意执行的时候要谨慎，不要轻易赋值给全局变量，内存泄漏你们都懂。</p><p><code>第四段代码</code>是高阶函数的写法</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//code4-1</span><br><span class="hljs-keyword">var</span> funcA = <span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>  <span class="hljs-comment">//funcA do sth</span><br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">f,<span class="hljs-variable language_">arguments</span></span>)&#123;<br>  <span class="hljs-comment">//if need funcA</span><br>  f.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>,<span class="hljs-variable language_">arguments</span>);<br>&#125;<br><span class="hljs-title function_">main</span>(funcA,<span class="hljs-number">123</span>);<br><br><span class="hljs-comment">//code4-2</span><br><span class="hljs-keyword">var</span> funcB = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-comment">//funB do sth</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">arguments</span>-retB</span>)&#123;<br>    <span class="hljs-comment">//funB return sth</span><br>  &#125;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">f,<span class="hljs-variable language_">arguments</span></span>)&#123;<br>  <span class="hljs-comment">//main return</span><br>  &#125;<br>&#125;<br><span class="hljs-title function_">main</span>()(funcB,<span class="hljs-number">123</span>);<br></code></pre></div></td></tr></table></figure><p>code4-1是标准的高阶函数调用，在需要的时候将函数作为参数传入，code4-2通过返回匿名函数的方式传参。在这里优势不明显，研究完继续填坑。</p><p>接下来看<code>第五段代码</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//moduleC</span><br><span class="hljs-title function_">define</span>([],<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-keyword">var</span> <span class="hljs-built_in">exports</span> = &#123;&#125;;<br>  <span class="hljs-built_in">exports</span>.<span class="hljs-property">func</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;moduleC-arg0=&quot;</span>+arg0)<br>  &#125;;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;<br>&#125;);<br><br><span class="hljs-comment">//module-main</span><br><span class="hljs-built_in">require</span>([moduleC],<span class="hljs-keyword">function</span>(<span class="hljs-params">moduleC</span>)&#123;<br>  <span class="hljs-keyword">var</span> <span class="hljs-built_in">exports</span> = &#123;&#125;;<br>  <span class="hljs-built_in">exports</span>.<span class="hljs-property">init</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;transToC-arg0=&quot;</span>+arg0)<br>  &#125;;<br>  <span class="hljs-built_in">exports</span>.<span class="hljs-title function_">otherFunc</span>(<span class="hljs-params"></span>)&#123;<br>    moduleC.<span class="hljs-title function_">func</span>(<span class="hljs-string">&#x27;module-main-arg1&#x27;</span>);<br>  &#125;<br>  expots.<span class="hljs-title function_">init</span>(<span class="hljs-number">555</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>这是commonjs的写法，这样写也为了函数解耦，个人觉得将函数绑定到对象的属性属于面向对象编程，和前面的说明式编程思想是不一样的。</p><figure class="highlight node-repl"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs node-repl"><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">批注：［<span class="hljs-number">2016</span>-<span class="hljs-number">4</span>-<span class="hljs-number">17</span>修正］</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">今天吃饭的时候和<span class="hljs-variable constant_">WD</span>大神讨论了这个问题，我这里的理解有误，更正一下。</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">javascript本身没有类的概念，<span class="hljs-keyword">function</span> <span class="hljs-title function_">A</span>(<span class="hljs-params"></span>)&#123;&#125;作为“类”来使用的时候可以在原型链上添加方法，</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">但是只有当其<span class="hljs-keyword">new</span>一个对象实例时，才算是这个<span class="hljs-keyword">function</span>达到了“类”的作用；</span><br><span class="hljs-meta prompt_">&gt;</span> <span class="language-javascript">只是将方法绑定在<span class="hljs-keyword">function</span> A属性上，通过<span class="hljs-keyword">function</span> A调用不能算是面相对象编程。</span><br></code></pre></div></td></tr></table></figure><p>还有<code>第六段代码</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"> <span class="hljs-comment">//moduleA.js</span><br> <span class="hljs-keyword">var</span> <span class="hljs-built_in">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>   <span class="hljs-keyword">return</span> &#123;<br>     <span class="hljs-attr">funcA1</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">arg0</span>)&#123;<br>       <span class="hljs-comment">//do funcA1</span><br>     &#125;<br>     <span class="hljs-attr">funcA2</span>:<span class="hljs-title function_">functioin</span>(<span class="hljs-params"></span>)&#123;<br>       <span class="hljs-comment">//do funcA2</span><br>     &#125;<br>  &#125;<br>&#125;<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span>;<br><br><span class="hljs-comment">//moduleB.js</span><br><span class="hljs-keyword">var</span> A = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./muduleA&quot;</span>)();<span class="hljs-comment">//pay attention</span><br>A.<span class="hljs-title function_">funcA1</span>(<span class="hljs-number">123</span>);<br>A.<span class="hljs-title function_">funcA2</span>();<br></code></pre></div></td></tr></table></figure><p><code>pay attention</code>这种写法在nodejs中非常常见，这样写更符合事件触发机制，适用于将函数的执行作为参数传入，表示事件的传入，而事件发生时传参执行。<br>moduleA返回了函数对象，函数对象的属性的值是匿名函数，在moduleB中require了moduleA的返回函数，当需要使用moduleA的方法时，可以通过对象的键值调用。</p><p><code>思考</code>：<br>本文通过执行调用的顺序，结合以前写代码的习惯，讨论了javascript书写方式，若实践中得到更好的方式本文将持续修改。</p><p><code>附录</code>：<br><a href="https://www.zhihu.com/question/28292740">知乎上关于函数式编程的讨论</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>js神奇的写法</title>
    <link href="/2016/04/12/js%E7%A5%9E%E5%A5%87%E7%9A%84%E5%86%99%E6%B3%95/"/>
    <url>/2016/04/12/js%E7%A5%9E%E5%A5%87%E7%9A%84%E5%86%99%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本篇总结了实践中用到的一些js trick，有些并非作者原创，但是作者都亲身坐过实验，效果奇佳。</p></blockquote><span id="more"></span><h5 id="数组浅复制"><a href="#数组浅复制" class="headerlink" title="数组浅复制"></a>数组浅复制</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">newArr = oldArr.<span class="hljs-title function_">concat</span>([]);<br>newArr = oldArr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);<br></code></pre></div></td></tr></table></figure><h5 id="Function直接执行"><a href="#Function直接执行" class="headerlink" title="Function直接执行"></a>Function直接执行</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-string">&#x27;alert(&quot;hello&quot;)&#x27;</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/.+/</span>,<span class="hljs-built_in">eval</span>); <br><span class="hljs-string">&#x27;alert(&quot;hello&quot;)&#x27;</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/.+/</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">m</span>)&#123;<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(m)(); <br> &#125;);<br></code></pre></div></td></tr></table></figure><p>new Function(arg1,arg2,…argN,’body’)();<br>参数都是字符串类型，字符串里面的内容是js表达式。只有一个参数时，将该字符串里面的内容作为函数体的原生js代码执行，相当于eval;<br>&#x2F;.+&#x2F;匹配的是除回车之外的字符;<br>string.replace(regexp,replacement),replacement可以是function，作用于每个匹配到的字符</p><h5 id="拼接字符串"><a href="#拼接字符串" class="headerlink" title="拼接字符串"></a>拼接字符串</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; <span class="hljs-built_in">eval</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">101</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;alert(++i);&#x27;</span>));<br><span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">101</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;alert(++i);&#x27;</span>))();<br></code></pre></div></td></tr></table></figure><p>通过new Array(n)我们可以创建n个空元素，n个空元素之间存在n-1个空白，通过arr.join()可以在空白中放一些东西组成我们需要的字符串</p><h5 id="浏览器变成编辑器"><a href="#浏览器变成编辑器" class="headerlink" title="浏览器变成编辑器"></a>浏览器变成编辑器</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//浏览器地址栏输入</span><br><span class="hljs-attr">data</span>:text/html,<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">contenteditable</span>&gt;</span></span><br></code></pre></div></td></tr></table></figure><h5 id="文档可编辑"><a href="#文档可编辑" class="headerlink" title="文档可编辑"></a>文档可编辑</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//console输入</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">contentEditable</span> = <span class="hljs-string">&#x27;true&#x27;</span><br></code></pre></div></td></tr></table></figure><h5 id="整数的操作"><a href="#整数的操作" class="headerlink" title="整数的操作"></a>整数的操作</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> foo = (<span class="hljs-number">12.4</span> / <span class="hljs-number">4.13</span>) | <span class="hljs-number">0</span><br><span class="hljs-keyword">var</span> foo2 = ~~(<span class="hljs-number">12.4</span> / <span class="hljs-number">4.13</span>)<br></code></pre></div></td></tr></table></figure><h5 id="将值很快转为bool"><a href="#将值很快转为bool" class="headerlink" title="将值很快转为bool"></a>将值很快转为bool</h5><figure class="highlight erlang-repl"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs erlang-repl">!!windoww === true;<br></code></pre></div></td></tr></table></figure><h5 id="函数的返回"><a href="#函数的返回" class="headerlink" title="函数的返回"></a>函数的返回</h5><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//无返回值，默认为undefined，!undefined ＝ true</span><br>!(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;aaa&quot;</span>)&#125;)() <span class="hljs-comment">//true</span><br>!(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;aaa&quot;</span>)&#125;())<span class="hljs-comment">//true</span><br><span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>&#125;()<span class="hljs-comment">//true</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微信SDK开发</title>
    <link href="/2016/04/10/%E5%BE%AE%E4%BF%A1SDK%E5%BC%80%E5%8F%91/"/>
    <url>/2016/04/10/%E5%BE%AE%E4%BF%A1SDK%E5%BC%80%E5%8F%91/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这篇是3月做的基于微信公众号开发的总结。<br>有微信SDK的讲解以及我所走过的坑。还有调试实践和比较好的书写方法。</p></blockquote><span id="more"></span><p><code>步骤一</code>：绑定域名<br>通过微信公众平台登录后，可以设置公众号的“js接口安全域名”</p><p><code>步骤二</code>：引入js文件<br>在引用接口的页面引入</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-attr">http</span>:<span class="hljs-comment">//res.wx.qq.com/open/js/jweixin-1.0.0.js</span></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>require方式引入</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">require</span>.<span class="hljs-title function_">config</span>(&#123;<br>  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">&#x27;scripts/&#x27;</span>,<br>  <span class="hljs-attr">paths</span>:&#123;<br>    <span class="hljs-string">&#x27;wx&#x27;</span>:<span class="hljs-string">&#x27;http://res.wx.qq.com/open/js/jweixin-1.0.0&#x27;</span><br>  &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><code>步骤三</code>：通过config接口注入权限验证配置</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">wx.<span class="hljs-title function_">config</span>(&#123;<br>    <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span><br>    <span class="hljs-attr">appId</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// 必填，公众号的唯一标识</span><br>    <span class="hljs-attr">timestamp</span>: , <span class="hljs-comment">// 必填，生成签名的时间戳</span><br>    <span class="hljs-attr">nonceStr</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// 必填，生成签名的随机串</span><br>    <span class="hljs-attr">signature</span>: <span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-comment">// 必填，签名，见附录1</span><br>    <span class="hljs-attr">jsApiList</span>: [] <span class="hljs-comment">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2</span><br>&#125;);<br></code></pre></div></td></tr></table></figure><p><code>注意</code>发布的时候一定记住把debug模式去掉</p><p> <code>步骤四</code>：通过ready接口处理成功的验证</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">wx.<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-comment">//获取“分享到朋友圈”按钮点击状态及自定义分享内容接口</span><br>  wx.<span class="hljs-title function_">onMenuShareTimeline</span>(&#123;<br>    <span class="hljs-attr">title</span>: that.<span class="hljs-property">title</span>, <span class="hljs-comment">// 分享标题</span><br>    <span class="hljs-attr">link</span>: that.<span class="hljs-property">link</span>, <span class="hljs-comment">// 分享链接</span><br>    <span class="hljs-attr">imgUrl</span>: that.<span class="hljs-property">icon</span>, <span class="hljs-comment">// 分享图标</span><br>    <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <br>    <span class="hljs-comment">// 用户确认分享后执行的回调函数 </span><br>    <span class="hljs-comment">//alert(&#x27;success&#x27;)</span><br>    &#125;,<br>    <span class="hljs-attr">cancel</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <br>    <span class="hljs-comment">// 用户取消分享后执行的回调函数</span><br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-comment">//获取“分享给朋友”按钮点击状态及自定义分享内容接口</span><br>  wx.<span class="hljs-title function_">onMenuShareAppMessage</span>(&#123;<br>    <span class="hljs-attr">title</span>: that.<span class="hljs-property">title</span>, <span class="hljs-comment">// 分享标题</span><br>    <span class="hljs-attr">desc</span>: that.<span class="hljs-property">desc</span>, <span class="hljs-comment">// 分享描述</span><br>    <span class="hljs-attr">link</span>: that.<span class="hljs-property">link</span>, <span class="hljs-comment">// 分享链接</span><br>    <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <br>    <span class="hljs-comment">// 用户确认分享后执行的回调函数</span><br>    <span class="hljs-comment">//alert(&#x27;share to friend success&#x27;)</span><br>    &#125;,<br>    <span class="hljs-attr">cancel</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <br>    <span class="hljs-comment">// 用户取消分享后执行的回调函数</span><br>    &#125;<br>  &#125;);<br>&#125;);<br><br>wx.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>    common.<span class="hljs-title function_">showPrompt</span>(<span class="hljs-string">&#x27;网络提醒&lt;br&gt;网络连接异常，请稍后重试&#x27;</span>);<br>&#125;);<br></code></pre></div></td></tr></table></figure><p>以上为分享给朋友及分享到朋友所适用的SDK，其余功能参见附录链接。</p><p><code>可能遇到的需求</code><br>点击按钮后触发弹框，然后进行页面跳转.<br>对用户来说，阅读弹框中的文字需要时间（即设置弹框出现到消失的定时器），跳转之前需要时间（即设置弹框消失之后执行跳转这一时间间隔的定时器），所以需要设置两个定时器让它们自己排队解决。注意setTimeout的用法，有关eventloop的内容详见《深入浅出nodejs》60页。</p><p><code>一些逻辑实现</code><br>实现原理来说，获取微信授权需要先跳转再回到当前页面，对于用户来说，跳转越少越好，所以采用缓存的方式，将用户的unionId（代表该用户微信帐号的唯一值）缓存到微信浏览器中。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">//设置</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;unionId&#x27;</span>,<span class="hljs-variable language_">this</span>.<span class="hljs-property">unionId</span>);<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>=<span class="hljs-string">&quot;unionId=&quot;</span>+<span class="hljs-built_in">escape</span>(unionId);<br><span class="hljs-comment">//获取</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;unionId&#x27;</span>);<br><span class="hljs-title function_">getCookie</span>(<span class="hljs-string">&#x27;unionId&#x27;</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCookie</span>(<span class="hljs-params">name</span>)&#123;<br>  <span class="hljs-keyword">var</span> arr,reg=<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&quot;(^| )&quot;</span>+name+<span class="hljs-string">&quot;=([^;]*)(;|$)&quot;</span>);<br>  <span class="hljs-keyword">if</span>(arr=<span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>.<span class="hljs-title function_">match</span>(reg))<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">unescape</span>(arr[<span class="hljs-number">2</span>]);<br>  <span class="hljs-keyword">else</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>根据微信官方说法是4月底微信浏览器升级，之前的bug将修复。当设置缓存的时候可能遇到localstorage无法使用的情况，最好是同时设置localstorage和cookie，但是我实际操作中没有遇到此类问题，localstorage基本通用，所以仅做参考。</p><p><code>关于调试</code><br> 附录中有关于微信调试工具的链接，实测并没有特别好用（主要是没找到代理的设置），建议还是charles走代理调试，ios版微信有页面刷新功能，android版没有，建议用iphone调试。</p><p><code>需要注意的书写方式</code><br>后期会有URL地址变动或者实参的改变，地址或参数相关尽量写成可配置的形式，如在代码段的开头将参数设置为对象的属性。</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> config = &#123;<br>  <span class="hljs-attr">url</span>:<span class="hljs-string">&#x27;api/app/userinfo&#x27;</span>,<span class="hljs-comment">//获取用户信息</span><br>  <span class="hljs-attr">android</span>:<span class="hljs-string">&#x27;https://www.aaa.com/android&#x27;</span>,<span class="hljs-comment">//android下载地址</span><br>  <span class="hljs-attr">iphone</span>:<span class="hljs-string">&#x27;https://www.aaa.com/iphone&#x27;</span>,<span class="hljs-comment">//iphone下载地址</span><br>  <span class="hljs-attr">imgDefault</span>:<span class="hljs-string">&#x27;http://aaa.com/c.jpg&#x27;</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>附录</code></p><p><a href="http://mp.weixin.qq.com/wiki/home/">微信开发者文档</a><br><a href="%E5%BE%AE%E4%BF%A1JS-SDK%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3">微信JSSDK说明文档</a><br><a href="http://mp.weixin.qq.com/wiki/10/e5f772f4521da17fa0d7304f68b97d7e.html">微信web开发者工具</a><br><a href="http://www.charlesproxy.com/">charles下载地址</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>微信SDK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>angular笔记（1）</title>
    <link href="/2016/04/01/angular%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/"/>
    <url>/2016/04/01/angular%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这两周我参与了一个angular项目的迭代，说一下我的使用心得。<br>架构是大师姐搭建的，比较符合范式要求，讲一下我作为一个angular初学者、公司内部平台维护者的一些学习以及实践经验。</p></blockquote> <span id="more"></span><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">-app<br><br>-css //预处理器编译后的css文件<br><br>-data //模拟数据<br><br>-js<br><br>-app.js(项目主入口)<br><br>-common.js(路由、过滤)<br><br>-main.js(依赖关系，js入口文件)<br><br>-routes.js(状态切换)<br><br>-less<br><br>-lib(reset之类)<br><br>-index.less<br><br>-lib(js库文件包，在main.js中引入)<br><br>-modules<br><br>-子模块中html、js文件写在一起<br><br>-host.js(开发测试生产环境对应路由，当有新的URL时，需要对应三个环境)<br><br>-index.html(默认首页)<br></code></pre></div></td></tr></table></figure><p><code>下拉列表选项</code></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;必填，用于表单校验&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ng-model</span>=<span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ng-options</span>=<span class="hljs-string">&quot;item.id as item.name for item in List&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ng-init</span>=<span class="hljs-string">&quot;设置初始值，慎用，尽量在js中设置&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ng-change</span>=<span class="hljs-string">&quot;func()&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ng-disabled</span>=<span class="hljs-string">&quot;满足条件时不可用&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">required</span>&gt;</span>        <br></code></pre></div></td></tr></table></figure><p><code>注意</code></p><p>ng-options :key as value，这样在<code>&lt;option value=&quot;value&quot;&gt;</code>中保存的是value，显示的是key .         </p><p>ng-change挂载在$scope.func ＝ function()上      </p><p><code>输入框选项</code></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;inputName&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ng-model</span>=<span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ng-pattern</span>=<span class="hljs-string">&quot;/此处需要正则表达式，用于检验表单的填写/&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ng-show</span>=<span class="hljs-string">&quot;formName.inputName.$dirty &amp;&amp; formName.inputName.$invalid&quot;</span>&gt;</span><br>  当表单检验不通过时显示提示语，dirty表示表单获得焦点，即表单初始化时提示语不现实，invalid表示满足表单非法状态下显示提示语<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><code>表格</code></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">ng-table</span>=<span class="hljs-string">&quot;tableParams&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">ng-repeat</span>=<span class="hljs-string">&quot;item in $data&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>  <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;&quot;</span>  <span class="hljs-attr">data-header</span>=<span class="hljs-string">&quot;&#x27;checkBoxHeader.html&#x27;&quot;</span> &gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span> <span class="hljs-attr">ng-model</span>=<span class="hljs-string">&quot;checkBoxes.items[item.id]&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">data-title</span>=<span class="hljs-string">&quot;&#x27;任务一级分类&#x27;&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>  <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-center&quot;</span> <span class="hljs-attr">bo-bind</span>=<span class="hljs-string">&quot;item.firstCategoryName  | demoLimit:15&quot;</span> <span class="hljs-attr">uib-tooltip</span>=<span class="hljs-string">&quot;&#123;&#123;item.firstCategoryName&#125;&#125;&quot;</span>&gt;</span>  <br>       <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <br>     <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span>  <span class="hljs-title function_">checkBox</span>(<span class="hljs-params"></span>)&#123;<br>$scope.<span class="hljs-property">checkBoxes</span> = &#123; <span class="hljs-string">&#x27;checked&#x27;</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">items</span>: &#123;&#125; &#125;;<br>$scope.$watch(<span class="hljs-string">&#x27;checkBoxes.checked&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) &#123;<br> angular.<span class="hljs-title function_">forEach</span>(list, <span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) &#123;<br> <span class="hljs-keyword">if</span> (angular.<span class="hljs-title function_">isDefined</span>(item.<span class="hljs-property">id</span>)) &#123;<br> $scope.<span class="hljs-property">checkBoxes</span>.<span class="hljs-property">items</span>[item.<span class="hljs-property">id</span>] = value;<br> &#125;<br> &#125;);<br>&#125;);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getTableParams</span>(<span class="hljs-params"></span>) &#123;<br>     $scope.<span class="hljs-property">tableParams</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NgTableParams</span>(&#123;<br>           <span class="hljs-attr">count</span>: <span class="hljs-variable constant_">PAGESIZE</span><br>     &#125;, &#123;<br>       <span class="hljs-attr">getData</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>) &#123;<br>         <span class="hljs-keyword">var</span> pageIndex = params.<span class="hljs-title function_">page</span>();<br>         <span class="hljs-keyword">return</span> httpData.<span class="hljs-title function_">getThemeList</span>(&#123;<br>           <span class="hljs-attr">pageIndex</span>: pageIndex,<br>           <span class="hljs-attr">pageSize</span>: <span class="hljs-variable constant_">PAGESIZE</span>,<br>         &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) &#123;<br>           params.<span class="hljs-title function_">total</span>(response.<span class="hljs-property">totalNum</span>);<br>           $scope.<span class="hljs-property">tableCount</span> = response.<span class="hljs-property">totalNum</span>;<br>           list = response.<span class="hljs-property">list</span>;<br>           <span class="hljs-title function_">checkBox</span>();<br>           <span class="hljs-keyword">return</span> response.<span class="hljs-property">list</span>;<br>         &#125;);<br>       &#125;<br>     &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>字符长度过滤</code></p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">.<span class="hljs-title function_">filter</span>(<span class="hljs-string">&quot;demoLimit&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">string,num</span>)&#123;<br>        <span class="hljs-keyword">if</span>(string &amp;&amp; string.<span class="hljs-property">length</span> &gt; num)&#123;<br>           <span class="hljs-keyword">return</span> string.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>,num) + <span class="hljs-string">&quot;...&quot;</span> ;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>           <span class="hljs-keyword">return</span> string;<br>        &#125;<br>    &#125;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><code>注意</code></p><p>NgTableParams插件获取表单新数据，存入$data中在页面中使用，bindonce插件表示数据同步一次，bo前缀有自己的html语法，区别ng前缀，在加载图片是bo可能会有问题。</p><p><code>数据实时校验</code></p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>数据one<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;entryFee&quot;</span> <span class="hljs-attr">ng-model</span>=<span class="hljs-string">&quot;Item.dataone&quot;</span>/&gt;</span><br>    &lt;divng-show=&quot;dataoneError==0&quot; &gt;数据1不能超过数据2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>数据two<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;challengeReward&quot;</span> <span class="hljs-attr">ng-model</span>=<span class="hljs-string">&quot;Item.datatwo&quot;</span>/&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span> <span class="hljs-attr">ng-show</span>=<span class="hljs-string">&quot;dataoneError==0&quot;</span>&gt;</span>数据1不能超过数据2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">$scope.$watch(<span class="hljs-string">&#x27;Item.dataone&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span>(+$scope.<span class="hljs-property">dataone</span> &lt; +$scope.<span class="hljs-property">datatwo</span>)<br>        $scope.<span class="hljs-property">dataoneError</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">else</span><br>        $scope.<span class="hljs-property">dataoneError</span> = <span class="hljs-number">1</span>;<br> &#125;)<br><br>$scope.$watch(<span class="hljs-string">&#x27;Item.datatwo&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>     <span class="hljs-keyword">if</span>(+$scope.<span class="hljs-property">dataone</span> &lt; +$scope.<span class="hljs-property">datatwo</span>)<br>        $scope.<span class="hljs-property">dataoneError</span> = <span class="hljs-number">0</span>;<br>     <span class="hljs-keyword">else</span><br>        $scope.<span class="hljs-property">dataoneError</span> = <span class="hljs-number">1</span>;<br>&#125;)<br></code></pre></div></td></tr></table></figure><p><code>注意</code></p><p>我写了两个<code>watch</code>来同步监视数据变化，若只有一个<code>watch</code>，则可能导致两个数据之一改变另一数据不能检测到，页面中<code>watch</code>过多可能有性能问题，建议有更好的解决方案。</p><p><code>项目启动</code></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">//app目录下<br>fone s<br></code></pre></div></td></tr></table></figure><p><code>项目打包</code></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">//index.html打tag<br>//app目录下<br>fis3 release -d ../dist<br>//root目录下<br>git add/commit/push<br></code></pre></div></td></tr></table></figure><p><code>附录一</code></p><p>当页面中出现除了提交表单以外的按钮时，当在input输入框填写文字时键盘触发回车，会导致距离输入框最近的按钮触发，解决方式如下：添加不可用的按钮，则回车触发不可用按钮，完美解决。</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">ng-disabled</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display:none&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">ng-click</span>=<span class="hljs-string">&quot;doChooseAdvice()&quot;</span>&gt;</span>选择<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">ng-disabled</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display:none&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p><code>附录二</code><br>需要掌握的资料<br><a href="http://showcase.ngnice.com/#/home/home">angular&amp;bootstrap插件合集</a><br><a href="http://angular-ui.github.io/bootstrap/#/datepicker">angular&amp;bootstrap插件</a><br><a href="http://chensd.com/2015-06/AngularJS-popular-Plugins-and-Directive.html">angular常用插件与指令收集</a><br><a href="https://github.com/angular-ui">angularui</a><br><a href="http://www.cnblogs.com/yjf512/p/3796229.html">javascript时间戳和日期字符串相互转换</a>  </p><p><code>附录三</code></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">Error: [$compile:tplrt] Template for directive &#x27;AAA&#x27; must have exactly one root element. <br></code></pre></div></td></tr></table></figure><p>指令error:这个错误表示指令编译成标签的时候出现问题，可能的解决方式：</p><ul><li>外层包裹一个div</li><li>指令内有标签未闭合，检查代码</li></ul><p><code>附录四</code></p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">cannot set property &#x27;visiblecolumncount&#x27; of undefined<br></code></pre></div></td></tr></table></figure><p><img src="/img/ng1-error1.png" alt="angular-error"><br> 当时看到这个问题觉得很奇怪，后来发现是接口没有取到数据的问题，检查接口返回。</p><p><code>友情链接</code><br><a href="http://www.zhouxianbao.cn/">@XB</a>同学改造的<a href="https://www.npmjs.com/package/fone-angular">angular项目目录生成</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>angular</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ife task1.9</title>
    <link href="/2016/03/26/ife-task1-9-1/"/>
    <url>/2016/03/26/ife-task1-9-1/</url>
    
    <content type="html"><![CDATA[<p><code>任务目的: </code>     </p><blockquote><p>通过实现一个较为复杂的页面，加深对于HTML，CSS的实战能力。       </p></blockquote><blockquote><p>实践代码的复用、优化    </p></blockquote><span id="more"></span> <p><code>任务链接</code><a href="http://http//ife.baidu.com/task/detail?taskId=9">ife_task1_9</a></p><p><img src="/img/task_1_9_2.jpg" alt="task1-9插图"></p><ul><li><p>双栏布局       </p><p>采用了侧栏固定宽度左浮动的方式，整体偏离左侧固定宽度，这样正文宽度100%正好撑满容器。</p></li></ul><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>这是侧栏<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;maincontent&quot;</span>&gt;</span><br>     这里是主体<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.container</span>&#123;<br>   <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">260px</span>;<br>&#125;<br><span class="hljs-selector-tag">nav</span>&#123;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">260px</span>;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">1200px</span>;<br><span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2a2e3d</span>;<br><span class="hljs-attribute">display</span>: inline-block;<br><span class="hljs-attribute">margin-left</span>: -<span class="hljs-number">260px</span>;<br><span class="hljs-attribute">float</span>: left;<br>&#125;<br><span class="hljs-selector-class">.maincontent</span>&#123;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">1200px</span>;<br><span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eeeeed</span>;<br><span class="hljs-attribute">display</span>: inline-block;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li><p>csssprite</p><p>figure是html5图片的标签，固定占位后设置其背景图片，通过将小图切到一张大图中，然后设置背景图片的位置，完成图片的展示。</p></li></ul><figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-class">.backUrl</span>(<span class="hljs-variable">@url</span>:<span class="hljs-string">&quot;/images/csssprite_1_9.png&quot;</span>)&#123;<br><span class="hljs-attribute">background</span>: url(<span class="hljs-string">@url</span>) no-repeat;<br>&#125;<br><span class="hljs-selector-tag">figure</span><span class="hljs-selector-pseudo">:first</span><span class="hljs-selector-tag">-child</span>&#123;<br><span class="hljs-attribute">display</span>: inline-block;<br><span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>;<br><span class="hljs-selector-class">.backUrl</span>();<br><span class="hljs-attribute">background-position</span>: -<span class="hljs-number">87px</span> -<span class="hljs-number">3px</span>;<br><span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;<br><span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>css实现列表的选中下拉状态</li></ul><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav_first&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">figure</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav_post&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">figure</span>&gt;</span><br><span class="hljs-comment">&lt;!-- &lt;span&gt;个人报表&lt;/span&gt; --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gerenbaobiao&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;fold1&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;fold1&quot;</span>&gt;</span>个人报表<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;foldlist1&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-class">.task_nav_foldlist</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[id^=<span class="hljs-string">&#x27;fold&#x27;</span>]</span>&#123;<br><span class="hljs-attribute">display</span>: none;<br>&#125;<br><span class="hljs-selector-class">.task_nav_foldlist</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[id^=<span class="hljs-string">&#x27;fold&#x27;</span>]</span><span class="hljs-selector-pseudo">:checked</span> ~ <span class="hljs-selector-attr">[id^=<span class="hljs-string">&#x27;foldlist&#x27;</span>]</span>&#123;<br><span class="hljs-attribute">display</span>: none;<br>&#125;<br></code></pre></div></td></tr></table></figure><p><code>总结</code></p><p>这次切图我基本精准到像素级，整个页面风格很像bootstrap。整体布局我首先注意到了双栏布局，但是没考虑滚动的时候侧栏和header是否应该固定这个体验，又因为中间多处使用position相对和绝对定位，所以后期修改比较麻烦，这点在以后页面总体布局的时候应该注意。</p><p>由于小图较多，所以我第一次尝试切雪碧图，是个不错的体验。</p><p><a href="https://github.com/ginny315/ife_spring2016_ginny/tree/master/task1-9">github链接</a><br><a href="http://guoningyan.com/ife/task09/index.html">demo链接</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>不是所有应用都适合ajax处理</title>
    <link href="/2016/01/17/%E4%B8%8D%E6%98%AF%E6%89%80%E6%9C%89%E5%BA%94%E7%94%A8%E9%83%BD%E9%80%82%E5%90%88ajax%E5%A4%84%E7%90%86/"/>
    <url>/2016/01/17/%E4%B8%8D%E6%98%AF%E6%89%80%E6%9C%89%E5%BA%94%E7%94%A8%E9%83%BD%E9%80%82%E5%90%88ajax%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>这几日在学校生产实训，写基于<code>struts2</code>的web站点。<code>struct2</code>属于<code>拦截型</code>框架，会将http请求拦截下来，进行自己对应的过滤处理（包括上传等一些基本请求），若框架本身不能处理的，则回调所写的action处理，因为请求中涉及http协议相关，若对协议不是很明了，可能会处理起来较为麻烦，struts2封装了这些请求，只需要在action中实现相关业务逻辑，同时action给出set和get接口作为数据的请求处理。让使用者只关心核心业务的开发，屏蔽原有技术跟业务无关的技术问题。</p></blockquote><span id="more"></span><p><code>BS基本模型</code><br><img src="/img/cs1.png" alt="BS基本模型">  </p><p>java web中Servlet作用是接受浏览器传给服务端的请求，并将服务端处理完的响应返回给用户的浏览器。   </p><p><code>java web基本处理模型</code>（红色部分为使用ajax的请求处理流向）<br><img src="/img/cs2.png" alt="java web基本处理模型">      </p><p>struts2这是一个非常不错的框架，作为前端，自然是希望后端提供接口（即RESTFulAPI这种），我通过ajax访问接口就可以实现请求。</p><p><code>struts2处理模型</code>（红色部分为使用ajax的请求处理流向)<br><img src="/img/cs3.png" alt="struts2处理模型">          </p><p>但是我在使用过程中发现这种拦截并不适合处理ajax请求，所有的ajax请求都是action处理的，相当于原生java web中servlet处理一样，就失去的框架本身的意义（简化req,res除外）。     </p><p>总结：不能因为学了前端就妄想所有的接口都是RESTFulAPI，有些时候后端渲染会更好，特别是当有了EL标签和JSTL标签之后，不需要用js访问大量DOM节点，这种时候当个小美工就可以啦～</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>工作（1）上海实习</title>
    <link href="/2015/12/26/%E5%B7%A5%E4%BD%9C%EF%BC%881%EF%BC%89%E4%B8%8A%E6%B5%B7%E5%AE%9E%E4%B9%A0/"/>
    <url>/2015/12/26/%E5%B7%A5%E4%BD%9C%EF%BC%881%EF%BC%89%E4%B8%8A%E6%B5%B7%E5%AE%9E%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>2015年6月到11月，我在 1号店 实习了5个月，实习的主要任务是练习移动端布局，使用 css3 属性，促销页面的动画，各种机型的兼容等等。</p><p>印象比较深刻的是新兵训练营，我和另外实习生一起，学习了内部框架FFF的使用，这是一个<code>OO模型</code>的框架，结合了zeptojs，是一个轻量级框架，适合移动端使用，主要是理解面向对象编程的概念，学会将页面拆分成组件，做了demo《疯狂的盒子》，当时XB同学帮了我很多。</p><p>这段学习让我比较深的理解了未来前端编程的发展方向，<code>组件化</code>易于拆分任务，结合时做好拼装就行。同时能可以提高组件的重用性，相同功能的应用可以用已经造好的轮子，避免了重复造轮子的累活儿。所以写代码不能只是能执行就完事儿了，要让代码易于拓展，复用性高。</p><span id="more"></span><p>还有就是命名规范，这在之前写小型项目时基本不考虑这个问题，但是当你的代码要和大家的结合在一起时，很可能就会命名冲突，甚至可能当时看起来没问题，后期出现问题排查时任务量巨大。</p><p>实习时还学到的一点是任务拆分，部门有一面任务墙，大家把要做的事情写在便利贴上，写上任务需要完成的时间，完成后移动位置，直至全部完成。可以看到同事的任务划分的很细，任务执行的每一步都划分成了几个小步，时间会有0.2天这种粒度，深以为这是非常好的完成任务方式，做完每一步都有成就感，同时也不会因为任务大而不知所措。我在这方面比较弱，需要同事的指导才知道怎么划分任务，我也没有养成切任务的习惯，在后期做自己的项目时依然是想到一个功能就添加，前端改不了就自己给后端加接口，这在大项目中是非常不好的，接下去的半年，我都要努力改进。</p><p>实习时做了一个内部创新项目《动效库》，是我和LL同学一起做的，我负责详情页，他负责主页，他选择了使用bootstrap进行布局，并且使用了基于其的一个瀑布流插件，而我是直接切图写逻辑的，后期整合时遇到了不小的麻烦，bootstrap的样式影响了我的原有样式，我不得不继续写样式去覆盖，这点告诉我们前期的技术选型一定要商量好，不然后期会很麻烦。</p><p>后来LL离职了，我完全接手了这个项目，主管提出了中间的一个问题，要我来修复。之前没有看过LL的代码，同时没有使用过这个插件，我花了挺长时间，其中还包括远程音频联系了LL，才理解了代码，修复了这个问题。LL当时的代码有些凌乱，但他确实是个技术不错的人，到现在我们还会常联系讨论技术问题，以后的文章我会继续写。</p><p>后来我又重构了这个项目，进行组件化了，写成了SPA，当然之后又有了新的问题，我之前一直不怎么重视的打开效率问题。下拉采用了懒加载，但是由于加载了大量DOM结构，导致在下拉多次以后页面里有太多的DOM，虽然渲染出来了，点击获取DOM信息再次渲染时会卡很久，这在当时我特意研究了chrome浏览器调试，写了挺多使用感悟，也了解了一些其他瀑布流布局在解决此类问题的方式，由于时间问题，我没有继续深入重构，也是一个小遗憾，有时间肯定会补回来。</p><p>技术篇到此结束了，5个月说长不长，说短也不短，我也学会了很多，有空继续聊。</p><p><a href="http://10.crazyboxginny.sinaapp.com/">动效库</a><br><a href="https://github.com/ginny315/dynamic_new/blob/master/readme.md">关于动效库实现细节及用户体验的思考</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>工作实习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo搭建Github博客</title>
    <link href="/2015/12/24/Hexo%E6%90%AD%E5%BB%BAGithub%E5%8D%9A%E5%AE%A2/"/>
    <url>/2015/12/24/Hexo%E6%90%AD%E5%BB%BAGithub%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<p>最近迷上了nodejs,hexo是基于nodejs搭建的博客，自然要玩一下～</p><p>整个安装配置过程大概花了一小时，写下来仅供参考。</p><span id="more"></span><ul><li><p>nodejs环境搭建</p><ul><li><p>官网<a href="http://nodejs.org/download/%EF%BC%8C%E6%A0%B9%E6%8D%AE%E8%87%AA%E5%B7%B1%E7%9A%84%E7%B3%BB%E7%BB%9F%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%8C%E7%82%B9%E5%87%BB%E5%AE%89%E8%A3%85%E5%90%8E%E7%82%B9next%E6%89%A7%E8%A1%8C%E5%88%B0finish%E3%80%82">http://nodejs.org/download/，根据自己的系统选择合适的版本，点击安装后点next执行到finish。</a></p></li><li><p>windows系统默认安装到C:\Program Files\nodejs\，需要添加环境变量Path里面增加nodejs的安装路径</p></li><li><p>控制台：which node 查找node的安装路径</p></li><li><p>Mac默认安装到&#x2F;usr&#x2F;local&#x2F;bin&#x2F;node</p><ul><li><p>Mac推荐通过brew安装</p><ul><li><p>terminal中执行</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">ruby -e &quot;$(curl -fsSkL https://raw.github.com/Homebrew/homebrew/go/install)&quot;<br></code></pre></div></td></tr></table></figure></li><li><p>若安装过程中提示安装xcode某个工具，按照提示走就行</p></li><li><p>执行brew doctor查看个模块是否正常</p></li></ul></li><li><p>brew install node,自动安装好node和npm</p></li></ul></li><li><p>node -v 查看node安装版本</p></li><li><p>npm -v  查看npm安装版本</p></li><li><p>淘宝镜像安装</p></li></ul><p>​ 低网速下很难通过 npm install fone -g等等来安装npm,解决方法是安装淘宝镜像</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></code></pre></div></td></tr></table></figure><p>从 registry.npm.taobao.org 安装所有模块. 当安装的时候发现安装的模块还没有同步过来, 淘宝 NPM 会自动在后台进行同步, 并且会让你从官方 NPMregistry.npmjs.org 进行安装. 下次你再安装这个模块的时候, 就会直接从 淘宝 NPM 安装了.</p><p>$ cnpm install [name]</p></li><li><p>git环境搭建</p><ul><li><a href="http://git-scm.com/download/">下载地址</a>，点next直到安装完成</li><li>windows下配置系统变量Path,加入安装目录</li><li>Mac下若已经安装了xcode,则不用另外下载</li><li>git —version  查看git版本</li></ul></li><li><p>安装Hexo</p><ul><li>官网<a href="https://hexo.io/">https://hexo.io</a></li><li>npm install -g hexo(已经安装淘宝镜像的用cnpm),Mac装全局需要用sudo</li><li>mkdir blog 新建文件夹blog</li><li>cd blog</li><li>hexo init</li><li>npm install 安装依赖</li><li>hexo server</li></ul></li></ul><p>​               [info] Hexo is running at <a href="http://localhost:4000/">http://localhost:4000/</a>. Press Ctrl+C to stop.</p><p>​               这时候在浏览器中访问上面的网址，就能看到一个默认主题的博客啦</p><ul><li><p>主题选择</p><ul><li>自己选择喜欢的，按照文档配置就可以了,<a href="https://www.zhihu.com/question/24422335">知乎推荐的hexo主题</a></li></ul></li><li><p>部署到git</p><ul><li><p>在项目配置文件_config.yml中</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">Deployment</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Docs: http://hexo.io/docs/deployment.html</span></span><br>deploy:<br>  type:<br></code></pre></div></td></tr></table></figure></li></ul><p>修改为</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">Deployment</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Docs: http://hexo.io/docs/deployment.html</span></span><br>deploy:<br>  type: git<br>  repository: git@github.com:yourname/yourname.github.io.git<br>  branch: master<br></code></pre></div></td></tr></table></figure><p>yourname是你的git账号名字，需要在github网站新建一个yourname.github.io的仓库，则默认为git托管的静态资源站点<br>若提示Deployer not found: git，执行npm install hexo-deployer-git –save</p></li><li><p>发布</p><ul><li><p>hexo  new “New Post” 创建新post，在source&#x2F;_posts目录下可以看到新建的markdown文件,或者直接将编辑好的文件放上面的目录下</p></li><li><p>hexo generate将markdown文件生成静态网页</p></li><li><p>hexo deploy发布</p></li><li><p>稍等片刻，访问yourname.github.io就可以看到hexo搭建在github的博客啦～～</p></li></ul><p>​</p><p>​</p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>环境配置</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nodejs</title>
    <link href="/2015/12/24/nodejs/"/>
    <url>/2015/12/24/nodejs/</url>
    
    <content type="html"><![CDATA[<h3 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h3><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">npm ls -g --depth=0 #查看已经安装在全局的模块<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>nodejs</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
